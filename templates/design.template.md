---
title: Thiáº¿t káº¿ chi tiáº¿t [TÃŠN_SERVICE_Cá»¦A_Báº N]
version: "1.0" # TODO: Báº¯t Ä‘áº§u vá»›i 1.0 cho báº£n nhÃ¡p Ä‘áº§u tiÃªn, tÄƒng dáº§n khi cÃ³ thay Ä‘á»•i lá»›n.
last_updated: "YYYY-MM-DD" # TODO: NgÃ y cáº­p nháº­t cuá»‘i cÃ¹ng.
author: "DX VAS Team"
reviewed_by: "Stephen Le"
---
# ğŸ“˜ Thiáº¿t káº¿ chi tiáº¿t [TÃŠN_SERVICE_Cá»¦A_Báº N]

> **[HÆ¯á»šNG DáºªN Sá»¬ Dá»¤NG TEMPLATE NÃ€Y:]**
> 1. Sao chÃ©p toÃ n bá»™ ná»™i dung file nÃ y vÃ o má»™t file `design.md` má»›i trong thÆ° má»¥c service cá»§a báº¡n.
> 2. TÃ¬m vÃ  thay tháº¿ táº¥t cáº£ cÃ¡c placeholder cÃ³ dáº¡ng `[PLACEHOLDER]` hoáº·c cÃ¡c comment `TODO:` báº±ng thÃ´ng tin cá»¥ thá»ƒ cá»§a service báº¡n.
> 3. XÃ³a cÃ¡c khá»‘i hÆ°á»›ng dáº«n (nhÆ° khá»‘i nÃ y) hoáº·c cÃ¡c comment khÃ´ng cáº§n thiáº¿t sau khi Ä‘Ã£ Ä‘iá»n thÃ´ng tin.
> 4. Äáº£m báº£o tÃ i liá»‡u cá»§a báº¡n rÃµ rÃ ng, chi tiáº¿t vÃ  tuÃ¢n thá»§ "Checklist TiÃªu Chuáº©n 5â˜… cho TÃ i Liá»‡u Thiáº¿t Káº¿ Service".

## 1. ğŸ§­ Pháº¡m vi vÃ  TrÃ¡ch nhiá»‡m (Scope & Responsibilities)

### ğŸ¯ Má»¥c tiÃªu

> **[HÆ¯á»šNG DáºªN:]**
> NÃªu rÃµ rÃ ng vÃ  sÃºc tÃ­ch (2-3 gáº¡ch Ä‘áº§u dÃ²ng) má»¥c Ä‘Ã­ch chÃ­nh cá»§a service nÃ y.
> - Service nÃ y giáº£i quyáº¿t váº¥n Ä‘á» gÃ¬?
> - GiÃ¡ trá»‹ cá»‘t lÃµi mÃ  nÃ³ mang láº¡i lÃ  gÃ¬?
> - Äá»‘i tÆ°á»£ng ngÆ°á»i dÃ¹ng/client chÃ­nh cá»§a service lÃ  ai?

-   [TODO: Má»¥c tiÃªu 1 cá»§a service, vÃ­ dá»¥: Cung cáº¥p dá»¯ liá»‡u [loáº¡i_dá»¯_liá»‡u] cho [client_chÃ­nh] trong tá»«ng [pháº¡m_vi, vÃ­ dá»¥: tenant].]
-   [TODO: Má»¥c tiÃªu 2 cá»§a service, vÃ­ dá»¥: Äáº£m báº£o tÃ­nh [tÃ­nh_cháº¥t, vÃ­ dá»¥: Ä‘á»c-only, nháº¥t quÃ¡n] cho dá»¯ liá»‡u Ä‘Æ°á»£c quáº£n lÃ½.]
-   [TODO: Má»¥c tiÃªu 3 cá»§a service, vÃ­ dá»¥: Äá»“ng bá»™ dá»¯ liá»‡u tá»« [service_nguá»“n] thÃ´ng qua cÆ¡ cháº¿ [cÆ¡_cháº¿, vÃ­ dá»¥: event-driven].]

### ğŸ“¦ CÃ¡c thá»±c thá»ƒ dá»¯ liá»‡u quáº£n lÃ½

> **[HÆ¯á»šNG DáºªN:]**
> Liá»‡t kÃª cÃ¡c thá»±c thá»ƒ dá»¯ liá»‡u chÃ­nh mÃ  service nÃ y chá»‹u trÃ¡ch nhiá»‡m quáº£n lÃ½ hoáº·c tÆ°Æ¡ng tÃ¡c trá»±c tiáº¿p.
> ÄÃ¢y lÃ  cÃ¡i nhÃ¬n tá»•ng quan, chi tiáº¿t sáº½ cÃ³ trong Má»¥c 3 (MÃ´ hÃ¬nh dá»¯ liá»‡u).

| Thá»±c thá»ƒ                 | MÃ´ táº£                                                                    |
| :----------------------- | :----------------------------------------------------------------------- |
| `[TÃŠN_THá»°C_THá»‚_1]`      | [TODO: MÃ´ táº£ ngáº¯n gá»n vai trÃ² cá»§a thá»±c thá»ƒ 1, vÃ­ dá»¥: Báº£n sao cá»§a [Thá»±cThá»ƒGá»‘c], lÆ°u tráº¡ng thÃ¡i trong [pháº¡m_vi].] |
| `[TÃŠN_THá»°C_THá»‚_2]`      | [TODO: MÃ´ táº£ ngáº¯n gá»n vai trÃ² cá»§a thá»±c thá»ƒ 2.]                             |
| `[TÃŠN_THá»°C_THá»‚_3_Lite]` | [TODO: MÃ´ táº£ ngáº¯n gá»n, vÃ­ dá»¥: Danh sÃ¡ch [loáº¡i_template] Ä‘Æ°á»£c Ä‘á»“ng bá»™ tá»« [service_nguá»“n].] |

> âš ï¸ [TODO: (TÃ¹y chá»n) ThÃªm cÃ¡c ghi chÃº quan trá»ng vá» pháº¡m vi dá»¯ liá»‡u, vÃ­ dá»¥: Service nÃ y khÃ´ng chá»©a dá»¯ liá»‡u nháº¡y cáº£m X, Y...]

### ğŸ”’ NgoÃ i Pháº¡m Vi (Out of Scope)

> **[HÆ¯á»šNG DáºªN:]**
> ÄÃ¢y lÃ  má»¥c ráº¥t quan trá»ng Ä‘á»ƒ trÃ¡nh hiá»ƒu láº§m vÃ  chá»“ng chÃ©o trÃ¡ch nhiá»‡m. Liá»‡t kÃª rÃµ rÃ ng nhá»¯ng gÃ¬ service nÃ y **KHÃ”NG** lÃ m.

Service nÃ y **khÃ´ng** thá»±c hiá»‡n cÃ¡c tÃ¡c vá»¥ sau:

-   âŒ [TODO: Chá»©c nÄƒng/TrÃ¡ch nhiá»‡m 1 khÃ´ng thuá»™c pháº¡m vi, vÃ­ dá»¥: XÃ¡c thá»±c ngÆ°á»i dÃ¹ng (do Service ABC Ä‘áº£m nhiá»‡m).]
-   âŒ [TODO: Chá»©c nÄƒng/TrÃ¡ch nhiá»‡m 2 khÃ´ng thuá»™c pháº¡m vi, vÃ­ dá»¥: Quáº£n lÃ½ vÃ²ng Ä‘á»i [Loáº¡iTemplate] gá»‘c (Sub chá»‰ consume báº£n sao).]
-   âŒ [TODO: Chá»©c nÄƒng/TrÃ¡ch nhiá»‡m 3 khÃ´ng thuá»™c pháº¡m vi, vÃ­ dá»¥: Ghi dá»¯ liá»‡u [Loáº¡iDá»¯Liá»‡u] (chá»‰ nháº­n qua event).]
-   âŒ [TODO: Chá»©c nÄƒng/TrÃ¡ch nhiá»‡m 4 khÃ´ng thuá»™c pháº¡m vi, vÃ­ dá»¥: Truy cáº­p hoáº·c xá»­ lÃ½ dá»¯ liá»‡u ngoÃ i pháº¡m vi [pháº¡m_vi_quy_Ä‘á»‹nh].]
-   âŒ [TODO: Chá»©c nÄƒng/TrÃ¡ch nhiá»‡m 5 khÃ´ng thuá»™c pháº¡m vi, vÃ­ dá»¥: Gá»i trá»±c tiáº¿p sang service X, Y (chá»‰ tÆ°Æ¡ng tÃ¡c qua API Gateway hoáº·c consume event).]

---

## 2. ğŸŒ Thiáº¿t káº¿ API chi tiáº¿t (Interface Contract)

> **[HÆ¯á»šNG DáºªN:]**
> - Cung cáº¥p báº£ng tÃ³m táº¯t cÃ¡c API chÃ­nh. Chi tiáº¿t tá»«ng API sáº½ náº±m trong file `interface-contract.md` vÃ  `openapi.yaml`.
> - Kháº³ng Ä‘á»‹nh viá»‡c tuÃ¢n thá»§ cÃ¡c ADRs liÃªn quan Ä‘áº¿n API.
> - Cung cáº¥p má»™t vÃ­ dá»¥ response Ä‘iá»ƒn hÃ¬nh cho má»™t API phá»©c táº¡p hoáº·c quan trá»ng Ä‘á»ƒ minh há»a.

| Method | Path                              | TÃ¡c vá»¥                                 | YÃªu cáº§u permission                   |
| :----- | :-------------------------------- | :------------------------------------- | :------------------------------------- |
| GET    | `/[resource_collection]`          | [TODO: MÃ´ táº£, vÃ­ dá»¥: Danh sÃ¡ch [resource] trong [pháº¡m_vi]]   | âœ… `[scope].read_[resource]`        |
| GET    | `/[resource_collection]/me`       | [TODO: MÃ´ táº£, vÃ­ dá»¥: ThÃ´ng tin [resource] cá»§a ngÆ°á»i dÃ¹ng hiá»‡n táº¡i] | âŒ (Chá»‰ cáº§n token há»£p lá»‡)             |
| GET    | `/[resource_collection]/me/subresource` | [TODO: MÃ´ táº£]                         | âŒ (Chá»‰ cáº§n token há»£p lá»‡)             |
| GET    | `/[config_resource_collection]`   | [TODO: MÃ´ táº£, vÃ­ dá»¥: [Loáº¡iConfig] hiá»‡n cÃ³]      | âœ… `[scope].view_[config_resource]` |

> ğŸ”§ API dÃ¹ng chuáº©n OpenAPI, tuÃ¢n thá»§ cáº¥u trÃºc response [ADR-012 Response Structure](../../../ADR/adr-012-response-structure.md), Ä‘á»‹nh nghÄ©a schema riÃªng cho táº¥t cáº£ response vÃ  error theo [ADR-011 Error Format](../../../ADR/adr-011-api-error-format.md).

### ğŸ“¦ VÃ­ dá»¥ response `GET /[resource_collection]/me/subresource`

```json
// TODO: Cung cáº¥p má»™t vÃ­ dá»¥ JSON response Ä‘iá»ƒn hÃ¬nh.
// VÃ­ dá»¥ tá»« user-service/sub cho GET /users/me/permissions:
{
  "data": [
    "student.view",
    "attendance.mark"
  ],
  "meta": {
    "request_id": "req-abc-123",
    "timestamp": "2025-05-31T14:20:00Z"
  }
}
```

-----

## 3\. ğŸ—ƒï¸ MÃ´ hÃ¬nh dá»¯ liá»‡u chi tiáº¿t (Data Model)

> **[HÆ¯á»šNG DáºªN:]**
>
>   - Cung cáº¥p sÆ¡ Ä‘á»“ ERD trá»±c quan.
>   - MÃ´ táº£ chi tiáº¿t tá»«ng báº£ng/thá»±c thá»ƒ dá»¯ liá»‡u mÃ  service nÃ y quáº£n lÃ½.
>   - Tham kháº£o file `data-model.md` Ä‘á»ƒ cÃ³ cáº¥u trÃºc chi tiáº¿t hÆ¡n náº¿u cáº§n.

### ğŸ—ºï¸ SÆ¡ Ä‘á»“ ERD (Entity Relationship Diagram)

```mermaid
// TODO: Váº½ sÆ¡ Ä‘á»“ ERD cho cÃ¡c báº£ng chÃ­nh cá»§a service nÃ y.
// Sá»­ dá»¥ng Mermaid hoáº·c chÃ¨n hÃ¬nh áº£nh.
// VÃ­ dá»¥ tá»« user-service/sub:
erDiagram
  UserLocal ||--o{ UserTenantRole : has
  UserTenantRole }o--|| RoleTemplateLite : references
  RoleTemplateLite ||--o{ PermissionTemplateLite : includes // Quan há»‡ logic

  UserLocal {
    UUID user_id PK
    STRING email
    STRING full_name
    // ... cÃ¡c trÆ°á»ng khÃ¡c
  }

  UserTenantRole {
    UUID user_id FK
    STRING role_code FK
    STRING[] permissions
  }

  RoleTemplateLite {
    STRING role_code PK
    // ... cÃ¡c trÆ°á»ng khÃ¡c
  }

  PermissionTemplateLite {
    STRING code PK
    // ... cÃ¡c trÆ°á»ng khÃ¡c
  }
```

> ğŸ’¡ **Ghi chÃº:** [TODO: ThÃªm cÃ¡c ghi chÃº giáº£i thÃ­ch cho ERD náº¿u cáº§n, vÃ­ dá»¥: giáº£i thÃ­ch cÃ¡c má»‘i quan há»‡ logic, quy Æ°á»›c kiá»ƒu dá»¯ liá»‡u trong Mermaid so vá»›i CSDL thá»±c táº¿.]

### Báº£ng: `[TÃŠN_Báº¢NG_1]`

> **[HÆ¯á»šNG DáºªN:]** Láº·p láº¡i cáº¥u trÃºc nÃ y cho má»—i báº£ng.

| Cá»™t                 | Kiá»ƒu     | Ghi chÃº                                |
| :------------------ | :------- | :------------------------------------- |
| `[tÃªn_cá»™t_1]`       | [Kiá»ƒuDL] | [TODO: Primary key, Foreign key, Not Null, Default, MÃ´ táº£ Ã½ nghÄ©a] |
| `[tÃªn_cá»™t_2]`       | [Kiá»ƒuDL] | [TODO: MÃ´ táº£]                          |
| `created_at`        | datetime | [TODO: Thá»i gian táº¡o báº£n ghi]            |
| `updated_at`        | datetime | [TODO: Thá»i gian cáº­p nháº­t cuá»‘i]         |

-----

## 4\. ğŸ”„ Luá»“ng xá»­ lÃ½ nghiá»‡p vá»¥ chÃ­nh (Business Logic Flows)

> **[HÆ¯á»šNG DáºªN:]**
>
>   - Chá»n 1-2 luá»“ng nghiá»‡p vá»¥ quan trá»ng nháº¥t hoáº·c phá»©c táº¡p nháº¥t cá»§a service Ä‘á»ƒ minh há»a.
>   - Sá»­ dá»¥ng sequence diagram (Mermaid) Ä‘á»ƒ trá»±c quan hÃ³a.
>   - MÃ´ táº£ ngáº¯n gá»n cÃ¡c bÆ°á»›c trong luá»“ng.

### Luá»“ng: `[TÃŠN_LUá»’NG_NGHIá»†P_Vá»¤_1]`

```mermaid
sequenceDiagram
  participant Client as [Client/Service Gá»i Äáº¿n]
  participant API as [API Endpoint Cá»§a Báº¡n]
  participant Logic as [ThÃ nh Pháº§n Logic ChÃ­nh]
  participant DB as [CÆ¡ Sá»Ÿ Dá»¯ Liá»‡u]
  // participant OtherService as [Service KhÃ¡c (náº¿u cÃ³)]

  Client->>API: [TODO: Request Ä‘áº¿n API]
  API->>Logic: [TODO: Gá»i hÃ m xá»­ lÃ½ logic]
  Logic->>DB: [TODO: TÆ°Æ¡ng tÃ¡c vá»›i DB]
  // Logic->>OtherService: [TODO: Gá»i service khÃ¡c (náº¿u cÃ³)]
  // OtherService-->>Logic: [TODO: Response tá»« service khÃ¡c]
  DB-->>Logic: [TODO: Káº¿t quáº£ tá»« DB]
  Logic-->>API: [TODO: Tráº£ káº¿t quáº£ xá»­ lÃ½]
  API-->>Client: [TODO: Response cho client]
```

> **MÃ´ táº£ luá»“ng:**
>
> 1.  [TODO: BÆ°á»›c 1]
> 2.  [TODO: BÆ°á»›c 2]
> 3.  ...

-----

## 5\. ğŸ“£ CÃ¡c sá»± kiá»‡n Pub/Sub (Events)

> **[HÆ¯á»šNG DáºªN:]**
>
>   - Náº¿u service cá»§a báº¡n consume hoáº·c publish sá»± kiá»‡n, hÃ£y liá»‡t kÃª chÃºng á»Ÿ Ä‘Ã¢y.
>   - Vá»›i má»—i sá»± kiá»‡n, nÃªu rÃµ tÃªn, nguá»“n phÃ¡t/Ä‘Ã­ch nháº­n, hÃ nh Ä‘á»™ng tÆ°Æ¡ng á»©ng, vÃ  vÃ­ dá»¥ payload.

| Sá»± kiá»‡n nháº­n/phÃ¡t                 | Nguá»“n phÃ¡t / ÄÃ­ch nháº­n        | HÃ nh Ä‘á»™ng táº¡i Service nÃ y                                       |
| :-------------------------------- | :--------------------------- | :-------------------------------------------------------------- |
| `[TÃŠN_Sá»°_KIá»†N_NHáº¬N_1]`           | `[service_nguá»“n]`            | [TODO: MÃ´ táº£ hÃ nh Ä‘á»™ng khi nháº­n sá»± kiá»‡n nÃ y, vÃ­ dá»¥: Insert/Update [Báº£ng Dá»¯ Liá»‡u].] |
| `[TÃŠN_Sá»°_KIá»†N_PHÃT_RA_1]` (náº¿u cÃ³) | (Service nÃ y phÃ¡t ra)      | [TODO: MÃ´ táº£ dá»¯ liá»‡u Ä‘Æ°á»£c phÃ¡t ra vÃ  má»¥c Ä‘Ã­ch.]                 |

### ğŸ“¦ VÃ­ dá»¥ Payload Sá»± Kiá»‡n TiÃªu Biá»ƒu (Event Payloads)

```json
// TODO: Cung cáº¥p vÃ­ dá»¥ payload cho cÃ¡c sá»± kiá»‡n quan trá»ng.
// VÃ­ dá»¥ cho sá»± kiá»‡n [TÃŠN_Sá»°_KIá»†N_NHáº¬N_1]:
{
  "event_type": "[TÃŠN_Sá»°_KIá»†N_NHáº¬N_1]",
  "data": {
    "key1": "value1",
    "key2": "value2"
  },
  "metadata": {
    "event_id": "uuid-event-123",
    "timestamp": "2025-06-01T10:00:00Z",
    "source_service": "[service_nguá»“n]"
  }
}
```

-----

## 6\. ğŸ” Báº£o máº­t & PhÃ¢n quyá»n (Security & Authorization)

> **[HÆ¯á»šNG DáºªN:]**
>
>   - MÃ´ táº£ cÆ¡ cháº¿ xÃ¡c thá»±c (thÆ°á»ng lÃ  JWT Ä‘Ã£ Ä‘Æ°á»£c Gateway validate).
>   - CÃ¡ch service xá»­ lÃ½ thÃ´ng tin user/tenant tá»« token.
>   - Vai trÃ² cá»§a Gateway vÃ  Service nÃ y trong viá»‡c enforce permission.

  * **XÃ¡c thá»±c (Authentication):** Service nÃ y giáº£ Ä‘á»‹nh ráº±ng request Ä‘áº¿n Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c thá»±c bá»Ÿi API Gateway. ThÃ´ng tin ngÆ°á»i dÃ¹ng (`user_id`, `tenant_id`) vÃ  danh sÃ¡ch permissions (`X-Permissions`) Ä‘Æ°á»£c truyá»n xuá»‘ng qua HTTP headers Ä‘Ã£ Ä‘Æ°á»£c tin cáº­y.
  * **PhÃ¢n quyá»n (Authorization):**
      * CÃ¡c API cÃ³ yÃªu cáº§u quyá»n cá»¥ thá»ƒ (vÃ­ dá»¥: `GET /users` cáº§n `tenant.read_users`) sáº½ **khai bÃ¡o `x-required-permission`** trong Ä‘áº·c táº£ OpenAPI.
      * Viá»‡c thá»±c thi (`enforce`) cÃ¡c permission nÃ y sáº½ do **API Gateway Ä‘áº£m nhiá»‡m** dá»±a trÃªn danh sÃ¡ch `X-Permissions` trong header.
      * Service nÃ y **khÃ´ng cáº§n láº·p láº¡i logic kiá»ƒm tra permission phá»©c táº¡p** náº¿u Gateway Ä‘Ã£ xá»­ lÃ½.
      * CÃ¡c API cÃ¡ nhÃ¢n (vÃ­ dá»¥: `GET /users/me`) chá»‰ cáº§n token há»£p lá»‡, khÃ´ng yÃªu cáº§u permission cá»¥ thá»ƒ.

-----

## 7\. âš™ï¸ Cáº¥u hÃ¬nh & Phá»¥ thuá»™c (Configuration & Dependencies)

> **[HÆ¯á»šNG DáºªN:]**
>
>   - Liá»‡t kÃª cÃ¡c biáº¿n mÃ´i trÆ°á»ng quan trá»ng.
>   - Liá»‡t kÃª cÃ¡c secrets cáº§n thiáº¿t.
>   - NÃªu rÃµ cÃ¡c phá»¥ thuá»™c vÃ o service khÃ¡c (náº¿u cÃ³, vÃ  cÃ¡ch tÆ°Æ¡ng tÃ¡c).

| ThÃ nh pháº§n               | Má»¥c Ä‘Ã­ch                                     | VÃ­ dá»¥ GiÃ¡ trá»‹ / CÃ¡ch Quáº£n LÃ½        |
| :----------------------- | :------------------------------------------- | :-------------------------------- |
| `ENV`                    | MÃ´i trÆ°á»ng hoáº¡t Ä‘á»™ng (dev, staging, prod) | `production`                      |
| `PORT`                   | Cá»•ng láº¯ng nghe cá»§a service                  | `8080`                            |
| `DATABASE_URL`           | Chuá»—i káº¿t ná»‘i CSDL                          | (Secret) `postgresql://user:pass@host:port/db` |
| `KAFKA_BROKERS` (Náº¿u dÃ¹ng Kafka) | Danh sÃ¡ch Kafka brokers                   | `kafka1:9092,kafka2:9092`         |
| `PUBSUB_PROJECT_ID` (Náº¿u dÃ¹ng GCP Pub/Sub) | Project ID cá»§a Pub/Sub                     | `my-gcp-project`                  |
| `[TÃŠN_TOPIC_EVENT_1]`    | TÃªn topic cho sá»± kiá»‡n [TÃŠN\_Sá»°\_KIá»†N\_NHáº¬N\_1]  | `topic-event-1`                   |
| `JWT_PUBLIC_KEY` (Náº¿u cáº§n verify token) | Public key Ä‘á»ƒ xÃ¡c thá»±c JWT (náº¿u Gateway khÃ´ng gá»­i xuá»‘ng X-User-ID) | (Secret) Path hoáº·c ná»™i dung key |
| `TENANT_ID` (Cho Sub Service) | ID cá»§a tenant mÃ  instance nÃ y phá»¥c vá»¥      | GÃ¡n cá»©ng trong mÃ´i trÆ°á»ng deploy   |

> â„¹ï¸ Service nÃ y [TODO: vÃ­ dá»¥: **khÃ´ng gá»i trá»±c tiáº¿p service khÃ¡c**, chá»‰ consume event tá»« [Service Nguá»“n] qua [Kafka/PubSub]].

-----

## 8\. ğŸ§ª Testing

> **[HÆ¯á»šNG DáºªN:]**
> Äá» xuáº¥t chiáº¿n lÆ°á»£c testing cho service nÃ y, bao gá»“m cÃ¡c loáº¡i test vÃ  cÃ¡c ká»‹ch báº£n quan trá»ng.

### ğŸ”¹ Unit Test

  - [TODO: ThÃ nh pháº§n/Logic 1 cáº§n unit test, vÃ­ dá»¥: `RBACResolver.expandPermissions()`]
  - [TODO: ThÃ nh pháº§n/Logic 2 cáº§n unit test, vÃ­ dá»¥: Mappers dá»¯ liá»‡u tá»« DB sang DTOs API]
  - [TODO: ThÃ nh pháº§n/Logic 3 cáº§n unit test, vÃ­ dá»¥: Xá»­ lÃ½ logic cá»§a tá»«ng event consumer]

### ğŸ”¹ Integration Test

  - [TODO: Ká»‹ch báº£n 1, vÃ­ dá»¥: Giáº£ láº­p sá»± kiá»‡n tá»« Master vÃ  kiá»ƒm tra dá»¯ liá»‡u Ä‘Æ°á»£c cáº­p nháº­t Ä‘Ãºng trong DB cá»§a Sub Service.]
  - [TODO: Ká»‹ch báº£n 2, vÃ­ dá»¥: Gá»i API (mocking Gateway headers) vÃ  kiá»ƒm tra response tráº£ vá» tá»« DB local.]

> ğŸ§ª **CÃ´ng cá»¥ gá»£i Ã½:** [TODO: Liá»‡t kÃª cÃ¡c cÃ´ng cá»¥/framework, vÃ­ dá»¥: `pytest` cho Python, `JUnit/Mockito` cho Java, `testcontainers` cho DB, `EmbeddedKafka/MockPubSub` cho event.]

-----

## 9\. ğŸ“ˆ Kháº£ nÄƒng GiÃ¡m sÃ¡t (Observability)

> **[HÆ¯á»šNG DáºªN:]**
> XÃ¡c Ä‘á»‹nh cÃ¡c metrics quan trá»ng cáº§n theo dÃµi Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ sá»©c khá»e vÃ  hiá»‡u nÄƒng cá»§a service.
> Tham kháº£o ADR vá» Observability chung cá»§a há»‡ thá»‘ng.

| Metric                                     | MÃ´ táº£                                                              | Loáº¡i Metric | ÄÆ¡n vá»‹  | Ghi chÃº                                      |
| :----------------------------------------- | :----------------------------------------------------------------- | :---------- | :------ | :------------------------------------------- |
| `[prefix]_event_consumed_total`            | Tá»•ng sá»‘ sá»± kiá»‡n Ä‘Ã£ consume (cÃ³ thá»ƒ chia theo `event_type`)         | Counter     | events  | Theo dÃµi lÆ°u lÆ°á»£ng event                      |
| `[prefix]_event_consume_duration_seconds`  | Thá»i gian xá»­ lÃ½ má»™t sá»± kiá»‡n (cÃ³ thá»ƒ chia theo `event_type`)         | Histogram   | seconds | ÄÃ¡nh giÃ¡ Ä‘á»™ trá»… xá»­ lÃ½ event                  |
| `[prefix]_event_consume_errors_total`      | Tá»•ng sá»‘ lá»—i khi xá»­ lÃ½ sá»± kiá»‡n (cÃ³ thá»ƒ chia theo `event_type`)       | Counter     | errors  | Theo dÃµi lá»—i Ä‘á»“ng bá»™                         |
| `[prefix]_api_request_duration_seconds`    | Thá»i gian xá»­ lÃ½ request API (chia theo `endpoint`, `method`)       | Histogram   | seconds | SLO latency cho API                          |
| `[prefix]_api_requests_total`              | Tá»•ng sá»‘ request API (chia theo `endpoint`, `method`, `status_code`) | Counter     | requests| LÆ°u lÆ°á»£ng API, tá»· lá»‡ lá»—i                     |
| `[prefix]_db_connection_pool_active`       | Sá»‘ lÆ°á»£ng active connection Ä‘áº¿n DB                                  | Gauge       | connections | Theo dÃµi tÃ i nguyÃªn DB                      |
| `[prefix]_permission_cache_hit_rate` (náº¿u cÃ³) | Tá»· lá»‡ cache hit cho viá»‡c tra cá»©u permission                        | Gauge       | ratio   | Hiá»‡u quáº£ cá»§a caching                       |

> ğŸ—£ï¸ NÃªn expose cÃ¡c metric nÃ y qua má»™t endpoint (vÃ­ dá»¥: `/metrics`) Ä‘á»ƒ Prometheus hoáº·c há»‡ thá»‘ng giÃ¡m sÃ¡t khÃ¡c cÃ³ thá»ƒ scrape.
> ğŸªµ **Logging:** Äáº£m báº£o log Ä‘áº§y Ä‘á»§ thÃ´ng tin context (trace\_id, user\_id, tenant\_id náº¿u cÃ³, event\_id) vÃ  tuÃ¢n thá»§ chuáº©n logging cá»§a há»‡ thá»‘ng.

-----

## 10\. ğŸ” Äá»™ tin cáº­y & Phá»¥c há»“i (Reliability & Resilience)

> **[HÆ¯á»šNG DáºªN:]**
> MÃ´ táº£ cÃ¡c cÆ¡ cháº¿ giÃºp service hoáº¡t Ä‘á»™ng tin cáº­y vÃ  cÃ³ kháº£ nÄƒng phá»¥c há»“i khi cÃ³ lá»—i.

  * **Xá»­ lÃ½ lá»—i sá»± kiá»‡n (Event Consumer Error Handling):**
      * **CÆ¡ cháº¿ retry:** [TODO: MÃ´ táº£ cÆ¡ cháº¿ retry, vÃ­ dá»¥: Retry tá»‘i thiá»ƒu 3 láº§n vá»›i backoff policy náº¿u xá»­ lÃ½ event tháº¥t báº¡i.]
      * **Dead Letter Queue (DLQ):** [TODO: MÃ´ táº£, vÃ­ dá»¥: Sau khi retry tháº¥t báº¡i, event sáº½ Ä‘Æ°á»£c gá»­i vÃ o má»™t DLQ Ä‘á»ƒ phÃ¢n tÃ­ch vÃ  xá»­ lÃ½ thá»§ cÃ´ng sau.]
  * **TÃ­nh Idempotency:**
      * [TODO: MÃ´ táº£ cÃ¡ch Ä‘áº£m báº£o idempotency cho viá»‡c xá»­ lÃ½ event, vÃ­ dá»¥: Dá»±a trÃªn `event_id` hoáº·c má»™t key nghiá»‡p vá»¥ duy nháº¥t Ä‘á»ƒ trÃ¡nh xá»­ lÃ½ trÃ¹ng láº·p sá»± kiá»‡n.]
  * **Theo dÃµi Offset (Kafka/PubSub):**
      * [TODO: MÃ´ táº£ cÃ¡ch service quáº£n lÃ½ vÃ  theo dÃµi offset cá»§a message queue Ä‘á»ƒ Ä‘áº£m báº£o khÃ´ng bá» sÃ³t hoáº·c xá»­ lÃ½ láº¡i event khÃ´ng cáº§n thiáº¿t.]
  * **Health Check Endpoint:**
      * Service nÃªn cung cáº¥p má»™t endpoint `/healthz` hoáº·c `/readyz` Ä‘á»ƒ Kubernetes hoáº·c há»‡ thá»‘ng Ä‘iá»u phá»‘i cÃ³ thá»ƒ kiá»ƒm tra tráº¡ng thÃ¡i.

-----

## 11\. âš¡ï¸ Hiá»‡u nÄƒng & Kháº£ nÄƒng má»Ÿ rá»™ng (Performance & Scalability)

> **[HÆ¯á»šN DáºªN:]**
>
>   - NÃªu cÃ¡c má»¥c tiÃªu vá» hiá»‡u nÄƒng (SLO).
>   - MÃ´ táº£ cÃ¡ch service cÃ³ thá»ƒ Ä‘Æ°á»£c má»Ÿ rá»™ng.
>   - Äá» cáº­p Ä‘áº¿n cÃ¡c chiáº¿n lÆ°á»£c caching (náº¿u cÃ³).

  * **SLO Ä‘á» xuáº¥t (Service Level Objectives):**
      * [TODO: API Endpoint 1, vÃ­ dá»¥: `GET /users`]: \< [XXX]ms P95 vá»›i [sá»‘\_lÆ°á»£ng\_dá»¯\_liá»‡u] trong tenant.
      * [TODO: API Endpoint 2, vÃ­ dá»¥: `GET /users/me/permissions`]: \< [YYY]ms P99 (cÃ³ thá»ƒ cache).
      * [TODO: Xá»­ lÃ½ sá»± kiá»‡n]: \< [ZZZ]ms P95 tá»« lÃºc nháº­n Ä‘áº¿n lÃºc hoÃ n táº¥t xá»­ lÃ½.
  * **Kháº£ nÄƒng má»Ÿ rá»™ng (Scalability):**
      * [TODO: MÃ´ táº£, vÃ­ dá»¥: Service nÃ y lÃ  stateless vÃ  cÃ³ thá»ƒ scale horizontally báº±ng cÃ¡ch tÄƒng sá»‘ lÆ°á»£ng instance. Má»—i instance phá»¥c vá»¥ má»™t tenant cá»¥ thá»ƒ, giÃºp phÃ¢n tÃ¡n táº£i.]
  * **Caching:**
      * [TODO: MÃ´ táº£ chiáº¿n lÆ°á»£c caching, vÃ­ dá»¥: Dá»¯ liá»‡u permission cá»§a user cÃ³ thá»ƒ Ä‘Æ°á»£c cache táº¡i API Gateway hoáº·c trong má»™t lá»›p cache (Redis) vá»›i TTL há»£p lÃ½ (vÃ­ dá»¥: 5-15 phÃºt) Ä‘á»ƒ giáº£m táº£i cho DB vÃ  tÄƒng tá»‘c Ä‘á»™ pháº£n há»“i cho API `GET /users/me/permissions`.]

-----

## 12\. ğŸ“š TÃ i liá»‡u liÃªn káº¿t (Related Documents)

> **[HÆ¯á»šNG DáºªN:]**
> Liá»‡t kÃª vÃ  verlink Ä‘áº¿n cÃ¡c tÃ i liá»‡u quan trá»ng khÃ¡c liÃªn quan Ä‘áº¿n service nÃ y.

  * [Interface Contract](https://www.google.com/search?q=./interface-contract.md): Äáº·c táº£ chi tiáº¿t cÃ¡c API Ä‘Æ°á»£c service cung cáº¥p.
  * [Data Model](https://www.google.com/search?q=./data-model.md): Thiáº¿t káº¿ schema CSDL chi tiáº¿t cho service.
  * [OpenAPI Spec](https://www.google.com/search?q=./openapi.yaml): MÃ´ táº£ chuáº©n OpenAPI cho cÃ¡c endpoint.
  * [ADR-xxx - TÃªn adr]: [TODO: MÃ´ táº£ ngáº¯n gá»n ADR nÃ y liÃªn quan nhÆ° tháº¿ nÃ o.]


-----
