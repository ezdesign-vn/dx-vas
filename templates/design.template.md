---
title: Thi·∫øt k·∫ø chi ti·∫øt [T√äN_SERVICE_C·ª¶A_B·∫†N]
version: "1.0" # TODO: B·∫Øt ƒë·∫ßu v·ªõi 1.0 cho b·∫£n nh√°p ƒë·∫ßu ti√™n, tƒÉng d·∫ßn khi c√≥ thay ƒë·ªïi l·ªõn.
last_updated: "YYYY-MM-DD" # TODO: Ng√†y c·∫≠p nh·∫≠t cu·ªëi c√πng.
author: "DX VAS Team"
reviewed_by: "Stephen Le"
---
# üìò Thi·∫øt k·∫ø chi ti·∫øt [T√äN_SERVICE_C·ª¶A_B·∫†N]

> **[H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG TEMPLATE N√ÄY:]**
> 1. Sao ch√©p to√†n b·ªô n·ªôi dung file n√†y v√†o m·ªôt file `design.md` m·ªõi trong th∆∞ m·ª•c service c·ªßa b·∫°n.
> 2. T√¨m v√† thay th·∫ø t·∫•t c·∫£ c√°c placeholder c√≥ d·∫°ng `[PLACEHOLDER]` ho·∫∑c c√°c comment `TODO:` b·∫±ng th√¥ng tin c·ª• th·ªÉ c·ªßa service b·∫°n.
> 3. X√≥a c√°c kh·ªëi h∆∞·ªõng d·∫´n (nh∆∞ kh·ªëi n√†y) ho·∫∑c c√°c comment kh√¥ng c·∫ßn thi·∫øt sau khi ƒë√£ ƒëi·ªÅn th√¥ng tin.
> 4. ƒê·∫£m b·∫£o t√†i li·ªáu c·ªßa b·∫°n r√µ r√†ng, chi ti·∫øt v√† tu√¢n th·ªß "Checklist Ti√™u Chu·∫©n 5‚òÖ cho T√†i Li·ªáu Thi·∫øt K·∫ø Service".

## 1. üß≠ Ph·∫°m vi v√† Tr√°ch nhi·ªám (Scope & Responsibilities)

### üéØ M·ª•c ti√™u

> **[H∆Ø·ªöNG D·∫™N:]**
> N√™u r√µ r√†ng v√† s√∫c t√≠ch (2-3 g·∫°ch ƒë·∫ßu d√≤ng) m·ª•c ƒë√≠ch ch√≠nh c·ªßa service n√†y.
> - Service n√†y gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ g√¨?
> - Gi√° tr·ªã c·ªët l√µi m√† n√≥ mang l·∫°i l√† g√¨?
> - ƒê·ªëi t∆∞·ª£ng ng∆∞·ªùi d√πng/client ch√≠nh c·ªßa service l√† ai?

-   [TODO: M·ª•c ti√™u 1 c·ªßa service, v√≠ d·ª•: Cung c·∫•p d·ªØ li·ªáu [lo·∫°i_d·ªØ_li·ªáu] cho [client_ch√≠nh] trong t·ª´ng [ph·∫°m_vi, v√≠ d·ª•: tenant].]
-   [TODO: M·ª•c ti√™u 2 c·ªßa service, v√≠ d·ª•: ƒê·∫£m b·∫£o t√≠nh [t√≠nh_ch·∫•t, v√≠ d·ª•: ƒë·ªçc-only, nh·∫•t qu√°n] cho d·ªØ li·ªáu ƒë∆∞·ª£c qu·∫£n l√Ω.]
-   [TODO: M·ª•c ti√™u 3 c·ªßa service, v√≠ d·ª•: ƒê·ªìng b·ªô d·ªØ li·ªáu t·ª´ [service_ngu·ªìn] th√¥ng qua c∆° ch·∫ø [c∆°_ch·∫ø, v√≠ d·ª•: event-driven].]

### üì¶ C√°c th·ª±c th·ªÉ d·ªØ li·ªáu qu·∫£n l√Ω

> **[H∆Ø·ªöNG D·∫™N:]**
> Li·ªát k√™ c√°c th·ª±c th·ªÉ d·ªØ li·ªáu ch√≠nh m√† service n√†y ch·ªãu tr√°ch nhi·ªám qu·∫£n l√Ω ho·∫∑c t∆∞∆°ng t√°c tr·ª±c ti·∫øp.
> ƒê√¢y l√† c√°i nh√¨n t·ªïng quan, chi ti·∫øt s·∫Ω c√≥ trong M·ª•c 3 (M√¥ h√¨nh d·ªØ li·ªáu).

| Th·ª±c th·ªÉ                 | M√¥ t·∫£                                                                    |
| :----------------------- | :----------------------------------------------------------------------- |
| `[T√äN_TH·ª∞C_TH·ªÇ_1]`      | [TODO: M√¥ t·∫£ ng·∫Øn g·ªçn vai tr√≤ c·ªßa th·ª±c th·ªÉ 1, v√≠ d·ª•: B·∫£n sao c·ªßa [Th·ª±cTh·ªÉG·ªëc], l∆∞u tr·∫°ng th√°i trong [ph·∫°m_vi].] |
| `[T√äN_TH·ª∞C_TH·ªÇ_2]`      | [TODO: M√¥ t·∫£ ng·∫Øn g·ªçn vai tr√≤ c·ªßa th·ª±c th·ªÉ 2.]                             |
| `[T√äN_TH·ª∞C_TH·ªÇ_3_Lite]` | [TODO: M√¥ t·∫£ ng·∫Øn g·ªçn, v√≠ d·ª•: Danh s√°ch [lo·∫°i_template] ƒë∆∞·ª£c ƒë·ªìng b·ªô t·ª´ [service_ngu·ªìn].] |

> ‚ö†Ô∏è [TODO: (T√πy ch·ªçn) Th√™m c√°c ghi ch√∫ quan tr·ªçng v·ªÅ ph·∫°m vi d·ªØ li·ªáu, v√≠ d·ª•: Service n√†y kh√¥ng ch·ª©a d·ªØ li·ªáu nh·∫°y c·∫£m X, Y...]

### üîí Ngo√†i Ph·∫°m Vi (Out of Scope)

> **[H∆Ø·ªöNG D·∫™N:]**
> ƒê√¢y l√† m·ª•c r·∫•t quan tr·ªçng ƒë·ªÉ tr√°nh hi·ªÉu l·∫ßm v√† ch·ªìng ch√©o tr√°ch nhi·ªám. Li·ªát k√™ r√µ r√†ng nh·ªØng g√¨ service n√†y **KH√îNG** l√†m.

Service n√†y **kh√¥ng** th·ª±c hi·ªán c√°c t√°c v·ª• sau:

-   ‚ùå [TODO: Ch·ª©c nƒÉng/Tr√°ch nhi·ªám 1 kh√¥ng thu·ªôc ph·∫°m vi, v√≠ d·ª•: X√°c th·ª±c ng∆∞·ªùi d√πng (do Service ABC ƒë·∫£m nhi·ªám).]
-   ‚ùå [TODO: Ch·ª©c nƒÉng/Tr√°ch nhi·ªám 2 kh√¥ng thu·ªôc ph·∫°m vi, v√≠ d·ª•: Qu·∫£n l√Ω v√≤ng ƒë·ªùi [Lo·∫°iTemplate] g·ªëc (Sub ch·ªâ consume b·∫£n sao).]
-   ‚ùå [TODO: Ch·ª©c nƒÉng/Tr√°ch nhi·ªám 3 kh√¥ng thu·ªôc ph·∫°m vi, v√≠ d·ª•: Ghi d·ªØ li·ªáu [Lo·∫°iD·ªØLi·ªáu] (ch·ªâ nh·∫≠n qua event).]
-   ‚ùå [TODO: Ch·ª©c nƒÉng/Tr√°ch nhi·ªám 4 kh√¥ng thu·ªôc ph·∫°m vi, v√≠ d·ª•: Truy c·∫≠p ho·∫∑c x·ª≠ l√Ω d·ªØ li·ªáu ngo√†i ph·∫°m vi [ph·∫°m_vi_quy_ƒë·ªãnh].]
-   ‚ùå [TODO: Ch·ª©c nƒÉng/Tr√°ch nhi·ªám 5 kh√¥ng thu·ªôc ph·∫°m vi, v√≠ d·ª•: G·ªçi tr·ª±c ti·∫øp sang service X, Y (ch·ªâ t∆∞∆°ng t√°c qua API Gateway ho·∫∑c consume event).]

---

## 2. üåê Thi·∫øt k·∫ø API chi ti·∫øt (Interface Contract)

> **[H∆Ø·ªöNG D·∫™N:]**
> - Cung c·∫•p b·∫£ng t√≥m t·∫Øt c√°c API ch√≠nh. Chi ti·∫øt t·ª´ng API s·∫Ω n·∫±m trong file `interface-contract.md` v√† `openapi.yaml`.
> - Kh·∫≥ng ƒë·ªãnh vi·ªác tu√¢n th·ªß c√°c ADRs li√™n quan ƒë·∫øn API.
> - Cung c·∫•p m·ªôt v√≠ d·ª• response ƒëi·ªÉn h√¨nh cho m·ªôt API ph·ª©c t·∫°p ho·∫∑c quan tr·ªçng ƒë·ªÉ minh h·ªça.

| Method | Path                              | T√°c v·ª•                                 | Y√™u c·∫ßu permission                   |
| :----- | :-------------------------------- | :------------------------------------- | :------------------------------------- |
| GET    | `/[resource_collection]`          | [TODO: M√¥ t·∫£, v√≠ d·ª•: Danh s√°ch [resource] trong [ph·∫°m_vi]]   | ‚úÖ `[scope].read_[resource]`        |
| GET    | `/[resource_collection]/me`       | [TODO: M√¥ t·∫£, v√≠ d·ª•: Th√¥ng tin [resource] c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i] | ‚ùå (Ch·ªâ c·∫ßn token h·ª£p l·ªá)             |
| GET    | `/[resource_collection]/me/subresource` | [TODO: M√¥ t·∫£]                         | ‚ùå (Ch·ªâ c·∫ßn token h·ª£p l·ªá)             |
| GET    | `/[config_resource_collection]`   | [TODO: M√¥ t·∫£, v√≠ d·ª•: [Lo·∫°iConfig] hi·ªán c√≥]      | ‚úÖ `[scope].view_[config_resource]` |

> üîß API d√πng chu·∫©n OpenAPI, tu√¢n th·ªß c·∫•u tr√∫c response [ADR-012 Response Structure](../../../ADR/adr-012-response-structure.md), ƒë·ªãnh nghƒ©a schema ri√™ng cho t·∫•t c·∫£ response v√† error theo [ADR-011 Error Format](../../../ADR/adr-011-api-error-format.md).

### üì¶ V√≠ d·ª• response `GET /[resource_collection]/me/subresource`

```json
// TODO: Cung c·∫•p m·ªôt v√≠ d·ª• JSON response ƒëi·ªÉn h√¨nh.
// V√≠ d·ª• t·ª´ user-service/sub cho GET /users/me/permissions:
{
  "data": [
    "student.view",
    "attendance.mark"
  ],
  "meta": {
    "request_id": "req-abc-123",
    "timestamp": "2025-05-31T14:20:00Z"
  }
}
```

-----

## 3\. üóÉÔ∏è M√¥ h√¨nh d·ªØ li·ªáu chi ti·∫øt (Data Model)

> **[H∆Ø·ªöNG D·∫™N:]**
>
>   - Cung c·∫•p s∆° ƒë·ªì ERD tr·ª±c quan.
>   - M√¥ t·∫£ chi ti·∫øt t·ª´ng b·∫£ng/th·ª±c th·ªÉ d·ªØ li·ªáu m√† service n√†y qu·∫£n l√Ω.
>   - Tham kh·∫£o file `data-model.md` ƒë·ªÉ c√≥ c·∫•u tr√∫c chi ti·∫øt h∆°n n·∫øu c·∫ßn.

### üó∫Ô∏è S∆° ƒë·ªì ERD (Entity Relationship Diagram)

```mermaid
// TODO: V·∫Ω s∆° ƒë·ªì ERD cho c√°c b·∫£ng ch√≠nh c·ªßa service n√†y.
// S·ª≠ d·ª•ng Mermaid ho·∫∑c ch√®n h√¨nh ·∫£nh.
// V√≠ d·ª• t·ª´ user-service/sub:
erDiagram
  UserLocal ||--o{ UserTenantRole : has
  UserTenantRole }o--|| RoleTemplateLite : references
  RoleTemplateLite ||--o{ PermissionTemplateLite : includes // Quan h·ªá logic

  UserLocal {
    UUID user_id PK
    STRING email
    STRING full_name
    // ... c√°c tr∆∞·ªùng kh√°c
  }

  UserTenantRole {
    UUID user_id FK
    STRING role_code FK
    STRING[] permissions
  }

  RoleTemplateLite {
    STRING role_code PK
    // ... c√°c tr∆∞·ªùng kh√°c
  }

  PermissionTemplateLite {
    STRING code PK
    // ... c√°c tr∆∞·ªùng kh√°c
  }
```

> üí° **Ghi ch√∫:** [TODO: Th√™m c√°c ghi ch√∫ gi·∫£i th√≠ch cho ERD n·∫øu c·∫ßn, v√≠ d·ª•: gi·∫£i th√≠ch c√°c m·ªëi quan h·ªá logic, quy ∆∞·ªõc ki·ªÉu d·ªØ li·ªáu trong Mermaid so v·ªõi CSDL th·ª±c t·∫ø.]

### B·∫£ng: `[T√äN_B·∫¢NG_1]`

> **[H∆Ø·ªöNG D·∫™N:]** L·∫∑p l·∫°i c·∫•u tr√∫c n√†y cho m·ªói b·∫£ng.

| C·ªôt                 | Ki·ªÉu     | Ghi ch√∫                                |
| :------------------ | :------- | :------------------------------------- |
| `[t√™n_c·ªôt_1]`       | [Ki·ªÉuDL] | [TODO: Primary key, Foreign key, Not Null, Default, M√¥ t·∫£ √Ω nghƒ©a] |
| `[t√™n_c·ªôt_2]`       | [Ki·ªÉuDL] | [TODO: M√¥ t·∫£]                          |
| `created_at`        | datetime | [TODO: Th·ªùi gian t·∫°o b·∫£n ghi]            |
| `updated_at`        | datetime | [TODO: Th·ªùi gian c·∫≠p nh·∫≠t cu·ªëi]         |

-----

## 4\. üîÑ Lu·ªìng x·ª≠ l√Ω nghi·ªáp v·ª• ch√≠nh (Business Logic Flows)

> **[H∆Ø·ªöNG D·∫™N:]**
>
>   - Ch·ªçn 1-2 lu·ªìng nghi·ªáp v·ª• quan tr·ªçng nh·∫•t ho·∫∑c ph·ª©c t·∫°p nh·∫•t c·ªßa service ƒë·ªÉ minh h·ªça.
>   - S·ª≠ d·ª•ng sequence diagram (Mermaid) ƒë·ªÉ tr·ª±c quan h√≥a.
>   - M√¥ t·∫£ ng·∫Øn g·ªçn c√°c b∆∞·ªõc trong lu·ªìng.

### Lu·ªìng: `[T√äN_LU·ªíNG_NGHI·ªÜP_V·ª§_1]`

```mermaid
sequenceDiagram
  participant Client as [Client/Service G·ªçi ƒê·∫øn]
  participant API as [API Endpoint C·ªßa B·∫°n]
  participant Logic as [Th√†nh Ph·∫ßn Logic Ch√≠nh]
  participant DB as [C∆° S·ªü D·ªØ Li·ªáu]
  // participant OtherService as [Service Kh√°c (n·∫øu c√≥)]

  Client->>API: [TODO: Request ƒë·∫øn API]
  API->>Logic: [TODO: G·ªçi h√†m x·ª≠ l√Ω logic]
  Logic->>DB: [TODO: T∆∞∆°ng t√°c v·ªõi DB]
  // Logic->>OtherService: [TODO: G·ªçi service kh√°c (n·∫øu c√≥)]
  // OtherService-->>Logic: [TODO: Response t·ª´ service kh√°c]
  DB-->>Logic: [TODO: K·∫øt qu·∫£ t·ª´ DB]
  Logic-->>API: [TODO: Tr·∫£ k·∫øt qu·∫£ x·ª≠ l√Ω]
  API-->>Client: [TODO: Response cho client]
```

> **M√¥ t·∫£ lu·ªìng:**
>
> 1.  [TODO: B∆∞·ªõc 1]
> 2.  [TODO: B∆∞·ªõc 2]
> 3.  ...

-----

## 5\. üì£ C√°c s·ª± ki·ªán Pub/Sub (Events)

> **[H∆Ø·ªöNG D·∫™N:]**
>
>   - N·∫øu service c·ªßa b·∫°n consume ho·∫∑c publish s·ª± ki·ªán, h√£y li·ªát k√™ ch√∫ng ·ªü ƒë√¢y.
>   - V·ªõi m·ªói s·ª± ki·ªán, n√™u r√µ t√™n, ngu·ªìn ph√°t/ƒë√≠ch nh·∫≠n, h√†nh ƒë·ªông t∆∞∆°ng ·ª©ng, v√† v√≠ d·ª• payload.

| S·ª± ki·ªán nh·∫≠n/ph√°t                 | Ngu·ªìn ph√°t / ƒê√≠ch nh·∫≠n        | H√†nh ƒë·ªông t·∫°i Service n√†y                                       |
| :-------------------------------- | :--------------------------- | :-------------------------------------------------------------- |
| `[T√äN_S·ª∞_KI·ªÜN_NH·∫¨N_1]`           | `[service_ngu·ªìn]`            | [TODO: M√¥ t·∫£ h√†nh ƒë·ªông khi nh·∫≠n s·ª± ki·ªán n√†y, v√≠ d·ª•: Insert/Update [B·∫£ng D·ªØ Li·ªáu].] |
| `[T√äN_S·ª∞_KI·ªÜN_PH√ÅT_RA_1]` (n·∫øu c√≥) | (Service n√†y ph√°t ra)      | [TODO: M√¥ t·∫£ d·ªØ li·ªáu ƒë∆∞·ª£c ph√°t ra v√† m·ª•c ƒë√≠ch.]                 |

### üì¶ V√≠ d·ª• Payload S·ª± Ki·ªán Ti√™u Bi·ªÉu (Event Payloads)

```json
// TODO: Cung c·∫•p v√≠ d·ª• payload cho c√°c s·ª± ki·ªán quan tr·ªçng.
// V√≠ d·ª• cho s·ª± ki·ªán [T√äN_S·ª∞_KI·ªÜN_NH·∫¨N_1]:
{
  "event_type": "[T√äN_S·ª∞_KI·ªÜN_NH·∫¨N_1]",
  "data": {
    "key1": "value1",
    "key2": "value2"
  },
  "metadata": {
    "event_id": "uuid-event-123",
    "timestamp": "2025-06-01T10:00:00Z",
    "source_service": "[service_ngu·ªìn]"
  }
}
```

-----

## 6\. üîê B·∫£o m·∫≠t & Ph√¢n quy·ªÅn (Security & Authorization)

> **[H∆Ø·ªöNG D·∫™N:]**
>
>   - M√¥ t·∫£ c∆° ch·∫ø x√°c th·ª±c (th∆∞·ªùng l√† JWT ƒë√£ ƒë∆∞·ª£c Gateway validate).
>   - C√°ch service x·ª≠ l√Ω th√¥ng tin user/tenant t·ª´ token.
>   - Vai tr√≤ c·ªßa Gateway v√† Service n√†y trong vi·ªác enforce permission.

  * **X√°c th·ª±c (Authentication):** Service n√†y gi·∫£ ƒë·ªãnh r·∫±ng request ƒë·∫øn ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c b·ªüi API Gateway. Th√¥ng tin ng∆∞·ªùi d√πng (`user_id`, `tenant_id`) v√† danh s√°ch permissions (`X-Permissions`) ƒë∆∞·ª£c truy·ªÅn xu·ªëng qua HTTP headers ƒë√£ ƒë∆∞·ª£c tin c·∫≠y.
  * **Ph√¢n quy·ªÅn (Authorization):**
      * C√°c API c√≥ y√™u c·∫ßu quy·ªÅn c·ª• th·ªÉ (v√≠ d·ª•: `GET /users` c·∫ßn `tenant.read_users`) s·∫Ω **khai b√°o `x-required-permission`** trong ƒë·∫∑c t·∫£ OpenAPI.
      * Vi·ªác th·ª±c thi (`enforce`) c√°c permission n√†y s·∫Ω do **API Gateway ƒë·∫£m nhi·ªám** d·ª±a tr√™n danh s√°ch `X-Permissions` trong header.
      * Service n√†y **kh√¥ng c·∫ßn l·∫∑p l·∫°i logic ki·ªÉm tra permission ph·ª©c t·∫°p** n·∫øu Gateway ƒë√£ x·ª≠ l√Ω.
      * C√°c API c√° nh√¢n (v√≠ d·ª•: `GET /users/me`) ch·ªâ c·∫ßn token h·ª£p l·ªá, kh√¥ng y√™u c·∫ßu permission c·ª• th·ªÉ.

-----

## 7\. ‚öôÔ∏è C·∫•u h√¨nh & Ph·ª• thu·ªôc (Configuration & Dependencies)

> **[H∆Ø·ªöNG D·∫™N:]**
>
>   - Li·ªát k√™ c√°c bi·∫øn m√¥i tr∆∞·ªùng quan tr·ªçng.
>   - Li·ªát k√™ c√°c secrets c·∫ßn thi·∫øt.
>   - N√™u r√µ c√°c ph·ª• thu·ªôc v√†o service kh√°c (n·∫øu c√≥, v√† c√°ch t∆∞∆°ng t√°c).

| Th√†nh ph·∫ßn               | M·ª•c ƒë√≠ch                                     | V√≠ d·ª• Gi√° tr·ªã / C√°ch Qu·∫£n L√Ω        |
| :----------------------- | :------------------------------------------- | :-------------------------------- |
| `ENV`                    | M√¥i tr∆∞·ªùng ho·∫°t ƒë·ªông (dev, staging, prod) | `production`                      |
| `PORT`                   | C·ªïng l·∫Øng nghe c·ªßa service                  | `8080`                            |
| `DATABASE_URL`           | Chu·ªói k·∫øt n·ªëi CSDL                          | (Secret) `postgresql://user:pass@host:port/db` |
| `KAFKA_BROKERS` (N·∫øu d√πng Kafka) | Danh s√°ch Kafka brokers                   | `kafka1:9092,kafka2:9092`         |
| `PUBSUB_PROJECT_ID` (N·∫øu d√πng GCP Pub/Sub) | Project ID c·ªßa Pub/Sub                     | `my-gcp-project`                  |
| `[T√äN_TOPIC_EVENT_1]`    | T√™n topic cho s·ª± ki·ªán [T√äN\_S·ª∞\_KI·ªÜN\_NH·∫¨N\_1]  | `topic-event-1`                   |
| `JWT_PUBLIC_KEY` (N·∫øu c·∫ßn verify token) | Public key ƒë·ªÉ x√°c th·ª±c JWT (n·∫øu Gateway kh√¥ng g·ª≠i xu·ªëng X-User-ID) | (Secret) Path ho·∫∑c n·ªôi dung key |
| `TENANT_ID` (Cho Sub Service) | ID c·ªßa tenant m√† instance n√†y ph·ª•c v·ª•      | G√°n c·ª©ng trong m√¥i tr∆∞·ªùng deploy   |

> ‚ÑπÔ∏è Service n√†y [TODO: v√≠ d·ª•: **kh√¥ng g·ªçi tr·ª±c ti·∫øp service kh√°c**, ch·ªâ consume event t·ª´ [Service Ngu·ªìn] qua [Kafka/PubSub]].

-----

## 8\. üß™ Testing

> **[H∆Ø·ªöNG D·∫™N:]**
> ƒê·ªÅ xu·∫•t chi·∫øn l∆∞·ª£c testing cho service n√†y, bao g·ªìm c√°c lo·∫°i test v√† c√°c k·ªãch b·∫£n quan tr·ªçng.

### üîπ Unit Test

  - [TODO: Th√†nh ph·∫ßn/Logic 1 c·∫ßn unit test, v√≠ d·ª•: `RBACResolver.expandPermissions()`]
  - [TODO: Th√†nh ph·∫ßn/Logic 2 c·∫ßn unit test, v√≠ d·ª•: Mappers d·ªØ li·ªáu t·ª´ DB sang DTOs API]
  - [TODO: Th√†nh ph·∫ßn/Logic 3 c·∫ßn unit test, v√≠ d·ª•: X·ª≠ l√Ω logic c·ªßa t·ª´ng event consumer]

### üîπ Integration Test

  - [TODO: K·ªãch b·∫£n 1, v√≠ d·ª•: Gi·∫£ l·∫≠p s·ª± ki·ªán t·ª´ Master v√† ki·ªÉm tra d·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng trong DB c·ªßa Sub Service.]
  - [TODO: K·ªãch b·∫£n 2, v√≠ d·ª•: G·ªçi API (mocking Gateway headers) v√† ki·ªÉm tra response tr·∫£ v·ªÅ t·ª´ DB local.]

> üß™ **C√¥ng c·ª• g·ª£i √Ω:** [TODO: Li·ªát k√™ c√°c c√¥ng c·ª•/framework, v√≠ d·ª•: `pytest` cho Python, `JUnit/Mockito` cho Java, `testcontainers` cho DB, `EmbeddedKafka/MockPubSub` cho event.]

-----

## 9\. üìà Kh·∫£ nƒÉng Gi√°m s√°t (Observability)

> **[H∆Ø·ªöNG D·∫™N:]**
> X√°c ƒë·ªãnh c√°c metrics quan tr·ªçng c·∫ßn theo d√µi ƒë·ªÉ ƒë√°nh gi√° s·ª©c kh·ªèe v√† hi·ªáu nƒÉng c·ªßa service.
> Tham kh·∫£o ADR v·ªÅ Observability chung c·ªßa h·ªá th·ªëng.

| Metric                                     | M√¥ t·∫£                                                              | Lo·∫°i Metric | ƒê∆°n v·ªã  | Ghi ch√∫                                      |
| :----------------------------------------- | :----------------------------------------------------------------- | :---------- | :------ | :------------------------------------------- |
| `[prefix]_event_consumed_total`            | T·ªïng s·ªë s·ª± ki·ªán ƒë√£ consume (c√≥ th·ªÉ chia theo `event_type`)         | Counter     | events  | Theo d√µi l∆∞u l∆∞·ª£ng event                      |
| `[prefix]_event_consume_duration_seconds`  | Th·ªùi gian x·ª≠ l√Ω m·ªôt s·ª± ki·ªán (c√≥ th·ªÉ chia theo `event_type`)         | Histogram   | seconds | ƒê√°nh gi√° ƒë·ªô tr·ªÖ x·ª≠ l√Ω event                  |
| `[prefix]_event_consume_errors_total`      | T·ªïng s·ªë l·ªói khi x·ª≠ l√Ω s·ª± ki·ªán (c√≥ th·ªÉ chia theo `event_type`)       | Counter     | errors  | Theo d√µi l·ªói ƒë·ªìng b·ªô                         |
| `[prefix]_api_request_duration_seconds`    | Th·ªùi gian x·ª≠ l√Ω request API (chia theo `endpoint`, `method`)       | Histogram   | seconds | SLO latency cho API                          |
| `[prefix]_api_requests_total`              | T·ªïng s·ªë request API (chia theo `endpoint`, `method`, `status_code`) | Counter     | requests| L∆∞u l∆∞·ª£ng API, t·ª∑ l·ªá l·ªói                     |
| `[prefix]_db_connection_pool_active`       | S·ªë l∆∞·ª£ng active connection ƒë·∫øn DB                                  | Gauge       | connections | Theo d√µi t√†i nguy√™n DB                      |
| `[prefix]_permission_cache_hit_rate` (n·∫øu c√≥) | T·ª∑ l·ªá cache hit cho vi·ªác tra c·ª©u permission                        | Gauge       | ratio   | Hi·ªáu qu·∫£ c·ªßa caching                       |

> üó£Ô∏è N√™n expose c√°c metric n√†y qua m·ªôt endpoint (v√≠ d·ª•: `/metrics`) ƒë·ªÉ Prometheus ho·∫∑c h·ªá th·ªëng gi√°m s√°t kh√°c c√≥ th·ªÉ scrape.
> ü™µ **Logging:** ƒê·∫£m b·∫£o log ƒë·∫ßy ƒë·ªß th√¥ng tin context (trace\_id, user\_id, tenant\_id n·∫øu c√≥, event\_id) v√† tu√¢n th·ªß chu·∫©n logging c·ªßa h·ªá th·ªëng.

-----

## 10\. üîÅ ƒê·ªô tin c·∫≠y & Ph·ª•c h·ªìi (Reliability & Resilience)

> **[H∆Ø·ªöNG D·∫™N:]**
> M√¥ t·∫£ c√°c c∆° ch·∫ø gi√∫p service ho·∫°t ƒë·ªông tin c·∫≠y v√† c√≥ kh·∫£ nƒÉng ph·ª•c h·ªìi khi c√≥ l·ªói.

  * **X·ª≠ l√Ω l·ªói s·ª± ki·ªán (Event Consumer Error Handling):**
      * **C∆° ch·∫ø retry:** [TODO: M√¥ t·∫£ c∆° ch·∫ø retry, v√≠ d·ª•: Retry t·ªëi thi·ªÉu 3 l·∫ßn v·ªõi backoff policy n·∫øu x·ª≠ l√Ω event th·∫•t b·∫°i.]
      * **Dead Letter Queue (DLQ):** [TODO: M√¥ t·∫£, v√≠ d·ª•: Sau khi retry th·∫•t b·∫°i, event s·∫Ω ƒë∆∞·ª£c g·ª≠i v√†o m·ªôt DLQ ƒë·ªÉ ph√¢n t√≠ch v√† x·ª≠ l√Ω th·ªß c√¥ng sau.]
  * **T√≠nh Idempotency:**
      * [TODO: M√¥ t·∫£ c√°ch ƒë·∫£m b·∫£o idempotency cho vi·ªác x·ª≠ l√Ω event, v√≠ d·ª•: D·ª±a tr√™n `event_id` ho·∫∑c m·ªôt key nghi·ªáp v·ª• duy nh·∫•t ƒë·ªÉ tr√°nh x·ª≠ l√Ω tr√πng l·∫∑p s·ª± ki·ªán.]
  * **Theo d√µi Offset (Kafka/PubSub):**
      * [TODO: M√¥ t·∫£ c√°ch service qu·∫£n l√Ω v√† theo d√µi offset c·ªßa message queue ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng b·ªè s√≥t ho·∫∑c x·ª≠ l√Ω l·∫°i event kh√¥ng c·∫ßn thi·∫øt.]
  * **Health Check Endpoint:**
      * Service n√™n cung c·∫•p m·ªôt endpoint `/healthz` ho·∫∑c `/readyz` ƒë·ªÉ Kubernetes ho·∫∑c h·ªá th·ªëng ƒëi·ªÅu ph·ªëi c√≥ th·ªÉ ki·ªÉm tra tr·∫°ng th√°i.

-----

## 11\. ‚ö°Ô∏è Hi·ªáu nƒÉng & Kh·∫£ nƒÉng m·ªü r·ªông (Performance & Scalability)

> **[H∆Ø·ªöN D·∫™N:]**
>
>   - N√™u c√°c m·ª•c ti√™u v·ªÅ hi·ªáu nƒÉng (SLO).
>   - M√¥ t·∫£ c√°ch service c√≥ th·ªÉ ƒë∆∞·ª£c m·ªü r·ªông.
>   - ƒê·ªÅ c·∫≠p ƒë·∫øn c√°c chi·∫øn l∆∞·ª£c caching (n·∫øu c√≥).

  * **SLO ƒë·ªÅ xu·∫•t (Service Level Objectives):**
      * [TODO: API Endpoint 1, v√≠ d·ª•: `GET /users`]: \< [XXX]ms P95 v·ªõi [s·ªë\_l∆∞·ª£ng\_d·ªØ\_li·ªáu] trong tenant.
      * [TODO: API Endpoint 2, v√≠ d·ª•: `GET /users/me/permissions`]: \< [YYY]ms P99 (c√≥ th·ªÉ cache).
      * [TODO: X·ª≠ l√Ω s·ª± ki·ªán]: \< [ZZZ]ms P95 t·ª´ l√∫c nh·∫≠n ƒë·∫øn l√∫c ho√†n t·∫•t x·ª≠ l√Ω.
  * **Kh·∫£ nƒÉng m·ªü r·ªông (Scalability):**
      * [TODO: M√¥ t·∫£, v√≠ d·ª•: Service n√†y l√† stateless v√† c√≥ th·ªÉ scale horizontally b·∫±ng c√°ch tƒÉng s·ªë l∆∞·ª£ng instance. M·ªói instance ph·ª•c v·ª• m·ªôt tenant c·ª• th·ªÉ, gi√∫p ph√¢n t√°n t·∫£i.]
  * **Caching:**
      * [TODO: M√¥ t·∫£ chi·∫øn l∆∞·ª£c caching, v√≠ d·ª•: D·ªØ li·ªáu permission c·ªßa user c√≥ th·ªÉ ƒë∆∞·ª£c cache t·∫°i API Gateway ho·∫∑c trong m·ªôt l·ªõp cache (Redis) v·ªõi TTL h·ª£p l√Ω (v√≠ d·ª•: 5-15 ph√∫t) ƒë·ªÉ gi·∫£m t·∫£i cho DB v√† tƒÉng t·ªëc ƒë·ªô ph·∫£n h·ªìi cho API `GET /users/me/permissions`.]

-----

## 12\. üìö T√†i li·ªáu li√™n k·∫øt (Related Documents)

> **[H∆Ø·ªöNG D·∫™N:]**
> Li·ªát k√™ v√† verlink ƒë·∫øn c√°c t√†i li·ªáu quan tr·ªçng kh√°c li√™n quan ƒë·∫øn service n√†y.

  * [Interface Contract](https://www.google.com/search?q=./interface-contract.md): ƒê·∫∑c t·∫£ chi ti·∫øt c√°c API ƒë∆∞·ª£c service cung c·∫•p.
  * [Data Model](https://www.google.com/search?q=./data-model.md): Thi·∫øt k·∫ø schema CSDL chi ti·∫øt cho service.
  * [OpenAPI Spec](https://www.google.com/search?q=./openapi.yaml): M√¥ t·∫£ chu·∫©n OpenAPI cho c√°c endpoint.
  * [ADR-xxx - T√™n adr]: [TODO: M√¥ t·∫£ ng·∫Øn g·ªçn ADR n√†y li√™n quan nh∆∞ th·∫ø n√†o.]


-----
