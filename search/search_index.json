{"config":{"lang":["vi"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Home","text":""},{"location":"#dx-vas-platform-documentation-v2","title":"DX-VAS Platform \u2013 Documentation (v2)","text":""},{"location":"#1-vision-scope","title":"1. Vision &amp; Scope","text":""},{"location":"#tam-nhin","title":"\ud83c\udfaf T\u1ea7m nh\u00ecn","text":"<p>X\u00e2y d\u1ef1ng DX-VAS Platform th\u00e0nh m\u1ed9t n\u1ec1n t\u1ea3ng chuy\u1ec3n \u0111\u1ed5i s\u1ed1 \u201ct\u1ea5t-c\u1ea3-trong-m\u1ed9t\u201d cho h\u1ec7 sinh th\u00e1i Tr\u01b0\u1eddng Vi\u1ec7t Anh, \u0111\u00e1p \u1ee9ng ba m\u1ee5c ti\u00eau c\u1ed1t l\u00f5i:</p> <ol> <li>K\u1ebft n\u1ed1i li\u1ec1n m\u1ea1ch \u2013 H\u1ee3p nh\u1ea5t quy tr\u00ecnh gi\u00e1o d\u1ee5c, v\u1eadn h\u00e0nh tr\u01b0\u1eddng h\u1ecdc v\u00e0 t\u01b0\u01a1ng t\u00e1c ph\u1ee5 huynh-h\u1ecdc sinh tr\u00ean m\u1ed9t n\u1ec1n t\u1ea3ng duy nh\u1ea5t.  </li> <li>M\u1edf r\u1ed9ng linh ho\u1ea1t \u2013 Ki\u1ebfn tr\u00fac multi-tenant cho ph\u00e9p tri\u1ec3n khai nhanh nhi\u1ec1u c\u01a1 s\u1edf/tr\u01b0\u1eddng, m\u1ed7i tenant t\u1ef1 ch\u1ee7 nh\u01b0ng k\u1ebf th\u1eeba d\u1ecbch v\u1ee5 chung.  </li> <li>B\u1ec1n v\u1eefng &amp; b\u1ea3o m\u1eadt \u2013 \u00c1p d\u1ee5ng chu\u1ea9n 5\u2605 (Service, Data, Interface, OpenAPI, Security) v\u00e0 tu\u00e2n th\u1ee7 c\u00e1c ADR \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o b\u1ea3o m\u1eadt, kh\u1ea3 n\u0103ng quan s\u00e1t, v\u00e0 ti\u1ebft ki\u1ec7m chi ph\u00ed d\u00e0i h\u1ea1n.</li> <li>H\u1ec7 th\u1ed1ng h\u1ed7 tr\u1ee3 \u0111a d\u1ea1ng ph\u01b0\u01a1ng th\u1ee9c \u0111\u0103ng nh\u1eadp:</li> <li>OAuth2 (Google): D\u00e0nh cho gi\u00e1o vi\u00ean, h\u1ecdc sinh, nh\u00e2n vi\u00ean \u2013 x\u00e1c th\u1ef1c qua <code>auth-service/master</code>.</li> <li>Local/OTP: D\u00e0nh cho ph\u1ee5 huynh v\u00e0 tr\u01b0\u1eddng kh\u00f4ng d\u00f9ng Google Workspace \u2013 x\u1eed l\u00fd qua <code>auth-service/sub</code> v\u00e0 reCAPTCHA.</li> </ol>"},{"location":"#pham-vi-tai-lieu","title":"\ud83d\udce6 Ph\u1ea1m vi t\u00e0i li\u1ec7u","text":"<p>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 to\u00e0n b\u1ed9 ki\u1ebfn tr\u00fac v\u00e0 ti\u00eau chu\u1ea9n k\u1ef9 thu\u1eadt c\u1ee7a DX-VAS:</p> M\u1ea3ng N\u1ed9i dung ch\u00ednh Ki\u1ebfn tr\u00fac t\u1ed5ng quan S\u01a1 \u0111\u1ed3 h\u1ec7 th\u1ed1ng, th\u00e0nh ph\u1ea7n, lu\u1ed3ng d\u1eef li\u1ec7u Authentication &amp; Token Auth Master/Sub, Token Service, JWT lifecycle Tenant Stack &amp; SMS M\u00f4 h\u00ecnh School Management System cho t\u1eebng tenant Core/Business Services API Gateway, User, Notification, SMS,\u2026 Observability &amp; Security Log-tracing, JWKS, key rotation, error codes CI/CD &amp; Deployment Pipeline, auto-scaling, zero-downtime, on-boarding tenant Data &amp; Reporting ELT, event schema governance, b\u00e1o c\u00e1o ph\u00e2n t\u00edch Standards &amp; ADR/CR 5\u2605 standards, 30 ADR, c\u00e1c Change Request hi\u1ec7n h\u00e0nh"},{"location":"#oi-tuong-oc-gia","title":"\ud83d\udc65 \u0110\u1ed1i t\u01b0\u1ee3ng \u0111\u1ed9c gi\u1ea3","text":"<ul> <li>K\u1ef9 s\u01b0 ph\u00e1t tri\u1ec3n (backend/frontend, ML, mobile)  </li> <li>DevOps &amp; SRE \u2013 tri\u1ec3n khai, v\u1eadn h\u00e0nh, gi\u00e1m s\u00e1t  </li> <li>Ki\u1ebfn tr\u00fac s\u01b0 h\u1ec7 th\u1ed1ng \u2013 th\u1ea9m \u0111\u1ecbnh, m\u1edf r\u1ed9ng ki\u1ebfn tr\u00fac  </li> <li>Qu\u1ea3n l\u00fd s\u1ea3n ph\u1ea9m &amp; ban l\u00e3nh \u0111\u1ea1o \u2013 n\u1eafm b\u1ee9c tranh t\u1ed5ng quan v\u00e0 roadmap k\u1ef9 thu\u1eadt</li> </ul>"},{"location":"#ngoai-pham-vi","title":"\ud83d\udeab Ngo\u00e0i ph\u1ea1m vi","text":"<ul> <li>Chi\u1ebfn l\u01b0\u1ee3c s\u01b0 ph\u1ea1m, n\u1ed9i dung gi\u1ea3ng d\u1ea1y.  </li> <li>H\u01b0\u1edbng d\u1eabn chi ti\u1ebft UI/UX cho t\u1eebng portal (\u0111\u01b0\u1ee3c t\u00e0i li\u1ec7u ri\u00eang).  </li> <li>B\u00e1o c\u00e1o t\u00e0i ch\u00ednh v\u00e0 d\u1eef li\u1ec7u PII c\u1ee5 th\u1ec3 (ch\u1ec9 n\u00eau nguy\u00ean t\u1eafc x\u1eed l\u00fd).</li> </ul> <p>K\u1ebft qu\u1ea3 mong \u0111\u1ee3i: Sau khi \u0111\u1ecdc xong ph\u1ea7n Vision &amp; Scope, \u0111\u1ed9c gi\u1ea3 hi\u1ec3u \u201ct\u1ea1i sao\u201d v\u00e0 \u201ct\u00e0i li\u1ec7u n\u00e0y bao tr\u00f9m nh\u1eefng g\u00ec\u201d tr\u01b0\u1edbc khi \u0111i s\u00e2u v\u00e0o chi ti\u1ebft k\u1ef9 thu\u1eadt.</p>"},{"location":"#2-high-level-architecture","title":"2. High-Level Architecture","text":""},{"location":"#21-so-o-tong-quan-mermaid-khoi-mau-nhat-dich-vu-per-tenant","title":"2.1 S\u01a1 \u0111\u1ed3 t\u1ed5ng quan (Mermaid) <sup><sub>Kh\u1ed1i m\u00e0u nh\u1ea1t = d\u1ecbch\u00a0v\u1ee5 \u201cper tenant\u201d.</sub></sup>","text":"<pre><code>flowchart TD\n  %% ======= EXTERNAL =======\n  subgraph ext [\"\ud83c\udf10 External IdP &amp; Channels\"]\n    GoogleOAuth(Google OAuth2)\n    OTPProv(OTP Provider)\n    EmailSvc(Email Gateway)\n    SMSSvc(SMS Gateway)\n  end\n\n  %% ======= FRONTEND =======\n  subgraph fe [\"\ud83d\udcbb Frontend Apps\"]\n    AdminPortal(Admin Portal)\n    TeacherPortal(Teacher Portal)\n    StudentPortal(Student Portal)\n    ParentPortal(Parent Portal)\n  end\n\n  %% ======= CORE SERVICES =======\n  subgraph core [\"\ud83d\udd27 Core Services (Shared)\"]\n    APIGW(API Gateway)\n    TokenSvc(Token Service)\n    AuthM(Auth Master)\n    UserM(User Master)\n    NotifM(Notification Master)\n    RedisRev[Redisrevoked_tokens cache]\n    ReportSvc(Reporting Service)\n    AuditLog(Audit Logging Service)\n    PubSub((Pub / Sub))\n  end\n\n  %% ======= DATA PLATFORM =======\n  subgraph db [\"\ud83d\udd27 Data Platform\"]\n    BQ(Data Warehouse)\n  end\n\n  %% ======= MONITORING STACK =======\n  subgraph mon [\"\ud83d\udcc8 Monitoring Stack\"]\n    CloudLog(Cloud Logging)\n    CloudMon(Cloud Monitoring)\n    AlertSys(Alerting Rules)\n  end\n\n  %% ======= CI / CONTRACT TESTING =======\n  subgraph test [\"\ud83e\uddea CI / Contract Testing\"]\n    CIPipeline(CI/CD Pipeline)\n    ContractEngine(Contract Test Engine)\n    MockUser(Mock: User Service)\n    MockNotif(Mock: Notif Service)\n    MockAuth(Mock: Auth Service)\n  end\n\n  %% ======= TENANT STACK EXAMPLE =======\n  subgraph tenantA [\"\ud83c\udfeb Tenant Stack \u00b7 ABC School\"]\n    subgraph smsgrp [\"School Management System (SMS)\"]\n      SMS(SMS Backend+ MariaDB)\n    end\n    AuthSub(Auth Sub)\n    UserSub(User Sub)\n    NotifSub(Notif Sub)\n  end\n\n  %% ======= FLOWS =======\n  %% Front-door\n  AdminPortal -. https .-&gt; APIGW\n  TeacherPortal -. https .-&gt; APIGW\n  StudentPortal -. https .-&gt; APIGW\n  ParentPortal  -. https .-&gt; APIGW\n\n  %% Auth &amp; Token\n  APIGW --&gt;|/login| AuthM\n  AuthM --&gt;|/token/issue| TokenSvc\n  AuthSub --&gt;|/token/issue| TokenSvc\n  TokenSvc -- JWKS --&gt; APIGW\n\n  %% Revoked-token check\n  APIGW --&gt;|check revoked| RedisRev\n  TokenSvc --&gt;|sync revoked| RedisRev\n\n  %% Core routing\n  APIGW ==&gt; UserM\n  APIGW ==&gt; NotifM\n  APIGW ==&gt; ReportSvc\n  APIGW ==&gt; AuditLog\n\n  %% Tenant routing\n  APIGW ==&gt; AuthSub\n  APIGW ==&gt; UserSub\n  APIGW ==&gt; NotifSub\n  APIGW ==&gt; SMS\n\n  %% Event fan-out\n  UserM -- \"user.*\" --&gt; PubSub\n  NotifM -- \"notif.*\" --&gt; PubSub\n  PubSub -- \"user.*\" --&gt; UserSub\n  PubSub -- \"notif.*\" --&gt; NotifSub\n\n  %% ELT (simplified)\n  SMS -- \"ELT\" --&gt; BQ\n\n  %% Audit Logging\n  AuthM --&gt;|log login| AuditLog\n  TokenSvc --&gt;|log issue/revoke| AuditLog\n  UserM --&gt;|log user change| AuditLog\n  NotifM --&gt;|log notif trigger| AuditLog\n  ReportSvc --&gt;|log report access| AuditLog\n  AuthSub --&gt;|log local login| AuditLog\n  UserSub --&gt;|log role update| AuditLog\n  NotifSub --&gt;|log delivery| AuditLog\n\n  %% Monitoring Stack\n  APIGW --&gt; CloudLog\n  AuthM --&gt; CloudLog\n  TokenSvc --&gt; CloudLog\n  UserM --&gt; CloudLog\n  ReportSvc --&gt; CloudLog\n  AuditLog --&gt; CloudLog\n  AuthSub --&gt; CloudLog\n  UserSub --&gt; CloudLog\n  SMS --&gt; CloudLog\n  NotifSub --&gt; CloudLog\n  CloudLog --&gt; CloudMon\n  CloudMon --&gt; AlertSys\n\n  %% CI/CD &amp; Contract Testing\n  CIPipeline --&gt; ContractEngine\n  ContractEngine --&gt; MockUser\n  ContractEngine --&gt; MockNotif\n  ContractEngine --&gt; MockAuth\n  MockUser --&gt;|simulate calls| APIGW\n  MockNotif --&gt;|simulate notif| APIGW\n  MockAuth --&gt;|simulate login| APIGW\n</code></pre>"},{"location":"#chu-thich-quan-trong","title":"\ud83d\udcdd Ch\u00fa th\u00edch quan tr\u1ecdng","text":"<ol> <li>API Gateway x\u00e1c th\u1ef1c JWT offline qua JWKS (RS256); ch\u1ec9 g\u1ecdi Token Service khi c\u1ea7n ki\u1ec3m tra revoked token (tra Redis) ho\u1eb7c c\u00e1c tr\u01b0\u1eddng h\u1ee3p \u0111\u1eb7c bi\u1ec7t. </li> <li>Redis l\u01b0u cache <code>revoked_tokens</code> (TTL 15 ph\u00fat). Token Service \u0111\u1ed3ng b\u1ed9 cache m\u1ed7i khi thu h\u1ed3i token.</li> <li>User Sub &amp; Notif Sub l\u00e0 read-replica; d\u1eef li\u1ec7u \u0111\u1ed3ng b\u1ed9 b\u1ea5t \u0111\u1ed3ng b\u1ed9 t\u1eeb c\u00e1c service Master qua Pub/Sub.</li> <li>SMS l\u00e0 ngu\u1ed3n d\u1eef li\u1ec7u ch\u00ednh cho b\u00e1o c\u00e1o; d\u1eef li\u1ec7u \u0111\u01b0\u1ee3c tr\u00edch xu\u1ea5t v\u00e0o Data Warehouse qua \u0111\u01b0\u1eddng ELT r\u1ed3i ti\u00eau th\u1ee5 b\u1edfi Reporting Service. </li> <li> <p>\u0110\u1ecbnh ngh\u0129a \u0111\u01b0\u1eddng n\u1ed1i</p> </li> <li> <p><code>-. https .-&gt;</code>  : G\u1ecdi HTTPS t\u1eeb frontend b\u00ean ngo\u00e0i</p> </li> <li><code>--&gt;</code>  : G\u1ecdi API \u0111\u1ed3ng b\u1ed9 n\u1ed9i b\u1ed9</li> <li><code>==&gt;</code>  : G\u1ecdi API \u0111\u1ed3ng b\u1ed9 \u01b0u ti\u00ean cao (core routing)</li> <li><code>..&gt;</code>  : Lu\u1ed3ng b\u1ea5t \u0111\u1ed3ng b\u1ed9 (Pub/Sub, ELT)</li> </ol> <p>S\u01a1 \u0111\u1ed3 n\u00e0y ph\u1ea3n \u00e1nh \u0111\u1ea7y \u0111\u1ee7 hai Change Request: Token Service centralization v\u00e0 Tenant Stack/SMS simplification.</p>"},{"location":"#22-component-groups","title":"2.2 Component Groups","text":"Nh\u00f3m th\u00e0nh ph\u1ea7n M\u00f4 t\u1ea3 ng\u1eafn Ghi ch\u00fa 1. External IdP &amp; Channels Google OAuth2, OTP Provider, Email/SMS Gateway. N\u1eb1m ngo\u00e0i h\u1ea1 t\u1ea7ng dx-vas; \u0111\u01b0\u1ee3c t\u00edch h\u1ee3p qua HTTPS (OAuth2, REST). 2. Frontend Apps / Portals 4 c\u1ed5ng web/mobile: Admin, Teacher, Student, Parent. G\u1ecdi API Gateway duy nh\u1ea5t b\u1eb1ng HTTPS. 3. Core Services (Shared) API Gateway, Token Service, Auth Master, User Master, Notification Master, Reporting Service. Ch\u1ea1y m\u1ed9t c\u1ee5m cho to\u00e0n h\u1ec7 th\u1ed1ng; ch\u1ecbu t\u1ea3i &amp; t\u00e1ch bi\u1ec7t tenant b\u1eb1ng JWT (<code>tid</code>). 4. Tenant Stack (per tenant) School Management System (SMS), Auth Sub, User Sub, Notification Sub. M\u1ed7i tenant c\u00f3 m\u1ed9t stack; Sub services l\u00e0 read-replica \u0111\u1ed3ng b\u1ed9 qua Pub/Sub. 5. Infrastructure &amp; Data Plane Redis (revoked token cache), Pub/Sub bus, Data Warehouse, Monitoring &amp; Logging stack. H\u1ed7 tr\u1ee3 b\u1ea3o m\u1eadt (JWKS cache, key rotation), observability, ELT b\u00e1o c\u00e1o. <p>Ph\u00e2n t\u1ea7ng r\u00f5 r\u00e0ng gi\u00fap: \u2022 Isolate tenant-level logic (stack 4) kh\u1ecfi v\u00f9ng shared (stack 3). \u2022 Gi\u1ea3m coupling \u2013 Token Service &amp; Gateway x\u1eed l\u00fd x\u00e1c th\u1ef1c t\u1eadp trung. \u2022 M\u1edf r\u1ed9ng \u2013 th\u00eam tenant = tri\u1ec3n khai m\u1ed9t SMS + ba Sub services, kh\u00f4ng \u1ea3nh h\u01b0\u1edfng Core.</p>"},{"location":"#3-authentication-flow","title":"3. Authentication Flow","text":""},{"location":"#31-cac-thanh-phan-tham-gia","title":"3.1 C\u00e1c th\u00e0nh ph\u1ea7n tham gia","text":"Actor Vai tr\u00f2 ch\u00ednh Frontend / Mobile G\u1eedi y\u00eau c\u1ea7u \u0111\u0103ng nh\u1eadp, l\u01b0u JWT, g\u1ecdi API Gateway. API Gateway C\u1eeda tr\u01b0\u1edbc duy nh\u1ea5t; x\u00e1c th\u1ef1c JWT offline b\u1eb1ng JWKS, ki\u1ec3m tra <code>revoked_tokens</code> trong Redis, u\u1ef7 quy\u1ec1n RBAC. Auth Master X\u00e1c th\u1ef1c Google OAuth2, \u00e1nh x\u1ea1 tenant, g\u1ecdi Token Service. Auth Sub (per tenant) X\u00e1c th\u1ef1c Local/OTP, \u0111\u1ed3ng b\u1ed9 user v\u1edbi Master, g\u1ecdi Token Service. Token Service Ph\u00e1t h\u00e0nh / l\u00e0m m\u1edbi / thu h\u1ed3i JWT, \u0111\u1ed3ng b\u1ed9 cache thu h\u1ed3i sang Redis, xu\u1ea5t JWKS. Redis cache Cache <code>revoked_tokens</code> (TTL 15\u2032) cho Gateway."},{"location":"#32-trinh-tu-ang-nhap-goi-api","title":"3.2 Tr\u00ecnh t\u1ef1 \u0111\u0103ng nh\u1eadp &amp; g\u1ecdi API","text":"<pre><code>sequenceDiagram\n    participant FE as Frontend\n    participant APIGW as API Gateway\n    participant AuthM as Auth Master\n    participant AuthSub as Auth Sub\n    participant TokenSvc as Token Service\n    participant Redis as Redis Cache\n\n    FE-&gt;&gt;APIGW: POST /login (Google ho\u1eb7c Local/OTP)\n\n    alt Google OAuth2\n        APIGW-&gt;&gt;AuthM: /login/google\n        AuthM-&gt;&gt;Google OAuth2: OAuth dance\n        Google OAuth2--&gt;&gt;AuthM: id_token\n    else Local / OTP\n        APIGW-&gt;&gt;AuthSub: /login/local|otp\n        AuthSub-&gt;&gt;AuthSub: verify pwd / OTP\n    end\n\n    par L\u1ea5y RBAC\n        AuthM-&gt;&gt;UserSub: GET /rbac (roles, perms)\n        AuthSub-&gt;&gt;UserSub: GET /rbac\n    end\n\n    AuthM-&gt;&gt;TokenSvc: POST /token/issue\n    AuthSub-&gt;&gt;TokenSvc: POST /token/issue\n    TokenSvc--&gt;&gt;AuthM: access + refresh JWT\n    TokenSvc--&gt;&gt;AuthSub: access + refresh JWT\n    AuthM--&gt;&gt;APIGW: 200 JWT\n    AuthSub--&gt;&gt;APIGW: 200 JWT\n    APIGW--&gt;&gt;FE: 200 JWT\n\n    opt Subsequent request\n        FE-&gt;&gt;APIGW: GET /api/*\n        APIGW-&gt;&gt;APIGW: verify RS256 via JWKS\n        APIGW-&gt;&gt;Redis: jti revoked?\n        alt OK\n            APIGW-&gt;&gt;Backend: forward\n        else Revoked / edge\n            APIGW-&gt;&gt;TokenSvc: POST /token/introspect\n            TokenSvc--&gt;&gt;APIGW: status\n        end\n    end\n</code></pre> <p>Ch\u00fa th\u00edch s\u01a1 \u0111\u1ed3</p> <ul> <li>JWKS l\u00e0 c\u01a1 ch\u1ebf x\u00e1c th\u1ef1c m\u1eb7c \u0111\u1ecbnh; <code>introspect</code> ch\u1ec9 \u0111\u01b0\u1ee3c g\u1ecdi khi Gateway c\u1ea7n kh\u1eb3ng \u0111\u1ecbnh token ch\u01b0a b\u1ecb thu h\u1ed3i ho\u1eb7c g\u1ea7n h\u1ebft h\u1ea1n.</li> <li>Redis \u0111\u00f3ng vai tr\u00f2 cache danh s\u00e1ch token b\u1ecb thu h\u1ed3i; Token Service \u0111\u1ea9y c\u1eadp nh\u1eadt ngay khi thu h\u1ed3i (<code>POST /token/revoke</code>).</li> <li>D\u1eef li\u1ec7u RBAC l\u1ea5y t\u1eeb User Sub \u0111\u1ec3 nh\u00fang v\u00e0o JWT; gi\u00fap Gateway authorize m\u00e0 kh\u00f4ng ph\u1ea3i g\u1ecdi l\u1ea1i database.</li> </ul>"},{"location":"#33-vong-oi-jwt","title":"3.3 V\u00f2ng \u0111\u1eddi JWT","text":"Giai \u0111o\u1ea1n M\u00f4 t\u1ea3 TTL / L\u01b0u tr\u1eef Issue Auth Master/Sub g\u1ecdi <code>POST /token/issue</code> \u2192 nh\u1eadn <code>access</code> (15 \u2032) &amp; <code>refresh</code> (14 ng\u00e0y). DB (<code>auth_sessions</code>) Refresh Client g\u1eedi <code>refresh</code> token t\u1edbi <code>POST /token/refresh</code> \u2192 c\u1ea5p <code>access</code> m\u1edbi, gia h\u1ea1n phi\u00ean. \u2014 Revoke Logout / admin g\u1ecdi <code>POST /token/revoke</code> v\u1edbi <code>jti</code> ho\u1eb7c <code>sid</code>. DB + Redis Introspect Gateway/Service g\u1ecdi <code>POST /token/introspect</code> n\u1ebfu c\u1ea7n x\u00e1c minh s\u00e2u. Tr\u1ea3 <code>active: true/false</code>"},{"location":"#34-cau-truc-jwt-rs256","title":"3.4 C\u1ea5u tr\u00fac JWT (RS256)","text":"<pre><code>sub   : user_id_global\ntid   : tenant_id\nroles : [\"teacher\"]\nperms : [\"grade.read\", \"grade.write\"]\nauth_provider : \"google\" | \"local\" | \"otp\"\njti   : e4c7...  (UUID v4)\nsid   : 9ab0...  (session id)\nexp   : 1717833000\n</code></pre>"},{"location":"#35-bien-phap-bao-mat-bo-sung","title":"3.5 Bi\u1ec7n ph\u00e1p b\u1ea3o m\u1eadt b\u1ed5 sung","text":"<ul> <li>Rate-limit &amp; CAPTCHA cho Local/OTP; gi\u1edbi h\u1ea1n OTP theo IP &amp; user.</li> <li>Key rotation \u2264 90 ng\u00e0y; JWKS cache 10 ph\u00fat t\u1ea1i Gateway/CDN.</li> <li>Error code tu\u00e2n th\u1ee7 <code>namespace.snake_case</code> (xem ADR-011).</li> <li>mTLS cho traffic n\u1ed9i b\u1ed9 gi\u1eefa Gateway \u2194 Core/Tenant services.</li> </ul> <p>Ph\u1ea7n lu\u1ed3ng x\u00e1c th\u1ef1c n\u00e0y \u0111\u1eb7t n\u1ec1n t\u1ea3ng cho m\u1ecdi d\u1ecbch v\u1ee5: JWT cung c\u1ea5p danh t\u00ednh &amp; RBAC, c\u00f2n Gateway b\u1ea3o v\u1ec7 bi\u00ean, gi\u1eef latency th\u1ea5p nh\u1edd x\u00e1c th\u1ef1c offline.</p>"},{"location":"#4-token-service-jwt-lifecycle","title":"4. Token Service &amp; JWT Lifecycle","text":"<p>Ngu\u1ed3n thi\u1ebft k\u1ebf \u2013 Change Request 03-cr-token-service:contentReference[oaicite:0]{index=0} &amp; ADR-006 \u2013 Auth Strategy :contentReference[oaicite:1]{index=1}  </p>"},{"location":"#41-vai-tro-ranh-gioi-tin-cay","title":"4.1 Vai tr\u00f2 &amp; Ranh gi\u1edbi tin c\u1eady","text":"<ul> <li>Token Service l\u00e0 micro-service duy nh\u1ea5t ph\u00e1t h\u00e0nh, l\u00e0m m\u1edbi (refresh), thu h\u1ed3i (revoke) v\u00e0 introspect JWT cho to\u00e0n b\u1ed9 platform.  </li> <li>Gi\u1eef private RSA key (RS256); c\u00f4ng khai JWKS cho API Gateway x\u00e1c th\u1ef1c offline.  </li> <li>\u0110\u1ed3ng b\u1ed9 danh s\u00e1ch token b\u1ecb thu h\u1ed3i t\u1edbi Redis cache \u2192 Gateway truy v\u1ea5n c\u1ee5c b\u1ed9, ch\u1ec9 g\u1ecdi <code>/token/introspect</code> khi cache miss ho\u1eb7c token s\u1eafp h\u1ebft h\u1ea1n.</li> </ul>"},{"location":"#42-api-endpoints","title":"4.2 API Endpoints","text":"Method Path M\u00f4 t\u1ea3 \u0110\u1ed1i t\u01b0\u1ee3ng g\u1ecdi <code>POST</code> <code>/token/issue</code> Ph\u00e1t h\u00e0nh access + refresh token Auth Master / Sub <code>POST</code> <code>/token/refresh</code> L\u00e0m m\u1edbi access token khi refresh h\u1ee3p l\u1ec7 Client <code>POST</code> <code>/token/revoke</code> Thu h\u1ed3i token theo <code>jti</code>/<code>sid</code> Logout / Admin <code>POST</code> <code>/token/introspect</code> Tr\u1ea3 <code>active: true/false</code> + metadata Gateway / Internal <code>GET</code> <code>/.well-known/jwks.json</code> JWKS (public keys) Gateway / Services / Clients"},{"location":"#43-key-management","title":"4.3 Key Management \ud83d\udd11","text":"<ul> <li>Thu\u1eadt to\u00e1n RS256; gi\u1eef 2 key ho\u1ea1t \u0111\u1ed9ng song song (<code>kid=current|next</code>).  </li> <li>Lu\u00e2n phi\u00ean kh\u00f3a t\u1ed1i \u0111a 90 ng\u00e0y/l\u1ea7n; tri\u1ec3n khai b\u1eb1ng Cloud KMS + GitOps pipeline :contentReference[oaicite:2]{index=2}.  </li> <li>JWKS c\u00f3 <code>Cache-Control: public, max-age=600</code> \u2013 Gateway t\u1ea3i l\u1ea1i t\u1ef1 \u0111\u1ed9ng m\u1ed7i 10 ph\u00fat.</li> </ul>"},{"location":"#44-cau-truc-jwt-ttl","title":"4.4 C\u1ea5u tr\u00fac JWT &amp; TTL","text":"Claim \u00dd ngh\u0129a V\u00ed d\u1ee5 <code>sub</code> <code>user_id_global</code> <code>\"u-123\"</code> <code>tid</code> <code>tenant_id</code> <code>\"tenant-abc\"</code> <code>roles</code>, <code>permissions</code> RBAC <code>[\"teacher\"]</code>, <code>[\"grade.read\"]</code> <code>auth_provider</code> <code>\"google\"</code> / <code>\"local\"</code> / <code>\"otp\"</code> \u2014 <code>jti</code> Token ID (UUID v4) <code>\"e4c7...\"</code> <code>sid</code> Session ID <code>\"9ab0...\"</code> <code>exp</code> H\u1ebft h\u1ea1n \u2264 15\u2032 (access) <code>1717833000</code> <p>Refresh token: TTL 14 ng\u00e0y, l\u01b0u b\u1ea3ng <code>auth_sessions</code>.</p>"},{"location":"#45-thu-hoi-token-redis-cache","title":"4.5 Thu h\u1ed3i token &amp; Redis Cache","text":"<pre><code>flowchart LR\n  TokenSvc -- \"sync revoked (jti)\" --&gt; Redis[(Redisrevoked_tokens)]\n  APIGW -- \"check jti\" --&gt; Redis\n  APIGW -- \"introspect (rare)\" --&gt; TokenSvc\n</code></pre> <ul> <li>Redis TTL 15 ph\u00fat \u2013 \u0111\u1ee7 nhanh \u0111\u1ec3 propagation nh\u01b0ng kh\u00f4ng qu\u00e1 t\u1ea3i network.</li> <li>Gateway ch\u1ec9 \u201cr\u01a1i v\u1ec1\u201d <code>/introspect</code> khi cache miss ho\u1eb7c c\u1ea7n ki\u1ec3m tra chi ti\u1ebft phi\u00ean (<code>sid</code>).</li> </ul>"},{"location":"#46-event-publishing","title":"4.6 Event Publishing \ud83d\udce1","text":"<ul> <li>Ph\u00e1t s\u1ef1 ki\u1ec7n <code>token.issued</code> &amp; <code>token.revoked</code> l\u00ean Pub/Sub \u2192 Audit-Logging &amp; dashboard \u201ctoken-per-minute\u201d, \u201crevoked-rate\u201d.</li> <li>S\u1ef1 ki\u1ec7n tu\u00e2n th\u1ee7 schema <code>token.{issued|revoked}.v1</code> (tham kh\u1ea3o ADR-030 \u2013 Event Schema Governance).</li> </ul>"},{"location":"#47-error-codes","title":"4.7 Error Codes","text":"<ul> <li>T\u1ea5t c\u1ea3 response l\u1ed7i bao b\u1ecdc theo <code>ErrorEnvelope</code> (ADR-011).</li> <li>Quy \u01b0\u1edbc <code>namespace.snake_case</code>, v\u00ed d\u1ee5 <code>token.expired</code>, <code>session.not_found</code> \u2013 qu\u1ea3n l\u00fd trong <code>docs/standards/error-codes.md</code>.</li> </ul>"},{"location":"#48-kpi-monitoring","title":"4.8 KPI &amp; Monitoring","text":"KPI M\u1ee5c ti\u00eau Alert Token issue latency (p95) &lt; 100 ms &gt; 200 ms 5\u2032 li\u00ean t\u1ee5c Revoked-check hit-ratio &gt; 95 % (Redis) &lt; 90 % 10\u2032 li\u00ean t\u1ee5c Key rotation drift \u2264 90 ng\u00e0y 80 ng\u00e0y \u2192 c\u1ea3nh b\u00e1o <p>T\u00f3m t\u1eaft \u2013 \u0110\u1eb7t Token Service l\u00e0m \u201cnh\u00e0 m\u00e1y\u201d JWT gi\u00fap \u0111\u1ea3m b\u1ea3o b\u1ea3o m\u1eadt, gi\u1ea3m \u0111\u1ed9 tr\u1ec5 v\u00e0 \u0111\u01a1n gi\u1ea3n ho\u00e1 qu\u1ea3n l\u00fd v\u00f2ng \u0111\u1eddi token cho to\u00e0n h\u1ec7 th\u1ed1ng.</p>"},{"location":"#5-tenant-stack-school-management-system-sms","title":"5. Tenant Stack &amp; School Management System (SMS)","text":""},{"location":"#51-khai-niem-tenant-stack","title":"5.1 Kh\u00e1i ni\u1ec7m Tenant Stack","text":"<p>M\u1ed7i tenant (tr\u01b0\u1eddng) c\u00f3 m\u1ed9t stack d\u1ecbch v\u1ee5 bi\u1ec7t l\u1eadp, tri\u1ec3n khai tr\u00ean GCP project ri\u00eang theo chi\u1ebfn l\u01b0\u1ee3c <code>dx-vas-tenant-&lt;name&gt;</code> (xem ADR-015, ADR-019) . Stack bao g\u1ed3m:</p> L\u1edbp Th\u00e0nh ph\u1ea7n Ghi ch\u00fa Frontend Admin / Teacher / Student / Parent Portal 4 portal chu\u1ea9n ho\u00e1, d\u00f9ng chung m\u00e3 ngu\u1ed3n; tu\u1ef3 bi\u1ebfn theme per tenant :contentReference[oaicite:0]{index=0} Backend School Management System (SMS) \u1ee8ng d\u1ee5ng Docker t\u00edch h\u1ee3p CRM + SIS + LMS; thay th\u1ebf ho\u00e0n to\u00e0n 3 adapter c\u0169 Sub Services <code>auth-sub</code>, <code>user-sub</code>, <code>notif-sub</code> Read-replica \u0111\u1ed3ng b\u1ed9 d\u1eef li\u1ec7u t\u1eeb c\u00e1c Master qua Pub/Sub; ch\u1ec9 \u0111\u1ecdc/ghi t\u1ed1i thi\u1ec3u cho tenant :contentReference[oaicite:1]{index=1} Data &amp; Cache MariaDB (SMS DB), Redis (local), Pub/Sub topic-per-tenant DB b\u1ea3n \u0111\u1ecba c\u1ee7a SMS (MariaDB Galera cluster) + cache phi\u00ean b\u1ea3n ho\u00e1 (<code>stack_version</code>, ADR-025)"},{"location":"#52-luong-chinh","title":"5.2 Lu\u1ed3ng ch\u00ednh","text":"<ol> <li>Portal g\u1ecdi API Gateway k\u00e8m header <code>X-Tenant-ID</code>.  </li> <li>Gateway \u0111\u1ecbnh tuy\u1ebfn <code>/sms/**</code> t\u1edbi SMS c\u1ee7a tenant; ch\u00e8n th\u00eam header <code>X-User-ID</code>, <code>X-Permissions</code> \u0111\u1ec3 RBAC ho\u1ea1t \u0111\u1ed9ng.  </li> <li>SMS ph\u1ee5c v\u1ee5 nghi\u1ec7p v\u1ee5 tr\u01b0\u1eddng (\u0111i\u1ec3m danh, h\u1ecdc ph\u00ed, LMS, v.v.).  </li> <li>User-sub &amp; Notif-sub nh\u1eadn s\u1ef1 ki\u1ec7n t\u1eeb User-master / Notif-master qua Pub/Sub \u2192 c\u1eadp nh\u1eadt DB c\u1ee5c b\u1ed9.  </li> <li>ELT pipeline tr\u00edch xu\u1ea5t d\u1eef li\u1ec7u SMS \u2192 Data Warehouse; Reporting Service truy v\u1ea5n DW t\u1ea1o dashboard \u0111a-tenant .</li> </ol>"},{"location":"#53-loi-ich-kien-truc","title":"5.3 L\u1ee3i \u00edch ki\u1ebfn tr\u00fac","text":"<ul> <li>\u0110\u01a1n gi\u1ea3n ho\u00e1 v\u1eadn h\u00e0nh \u2013 Lo\u1ea1i b\u1ecf ba adapter, gi\u1ea3m s\u1ed1 container per tenant ~ 60 %.  </li> <li>On-boarding nhanh \u2013 Th\u00eam tenant = deploy m\u1ed9t container SMS + 3 sub services (Terraform module \u201ctenant-stack\u201d).  </li> <li>Tr\u1ea3i nghi\u1ec7m nh\u1ea5t qu\u00e1n \u2013 4 portal chia s\u1ebb UI/UX v\u00e0 SSO, gi\u1ea3m chi ph\u00ed h\u1ed7 tr\u1ee3 ng\u01b0\u1eddi d\u00f9ng :contentReference[oaicite:3]{index=3}.  </li> <li>T\u00e1ch billing &amp; b\u1ea3o m\u1eadt \u2013 Project ri\u00eang, log/alert d\u00e1n nh\u00e3n <code>tenant_id</code> (ADR-022) :contentReference[oaicite:4]{index=4}.</li> </ul>"},{"location":"#54-chuan-trien-khai-versioning","title":"5.4 Chu\u1ea9n tri\u1ec3n khai &amp; versioning","text":"<ul> <li>Docker image SMS g\u1eafn th\u1ebb <code>vX.Y.Z</code>; th\u00f4ng tin <code>stack_version</code> l\u01b0u trong secret m\u1ed7i tenant (ADR-025).  </li> <li>CI/CD h\u1ed7 tr\u1ee3 rollout so le; Superadmin Webapp qu\u1ea3n l\u00fd mapping tenant \u2194 version.  </li> <li>Pipeline terraform + github actions t\u1ef1 \u0111\u1ed9ng t\u1ea1o project, DNS, secrets, certs theo template (ADR-015).  </li> </ul> <p>TL;DR \u2013 Tenant Stack m\u1edbi g\u00f3i g\u1ecdn nghi\u1ec7p v\u1ee5 tr\u01b0\u1eddng trong m\u1ed9t SMS, li\u00ean k\u1ebft an to\u00e0n v\u00e0o khung x\u00e1c th\u1ef1c &amp; quan s\u00e1t chung, gi\u00fap dx-vas \u201con-board m\u1ed9t tr\u01b0\u1eddng m\u1edbi trong v\u00e0i gi\u1edd thay v\u00ec v\u00e0i ng\u00e0y\u201d.</p>"},{"location":"#6-core-business-services","title":"6. Core &amp; Business Services","text":"<p>M\u1ee5c ti\u00eau \u2013 Li\u1ec7t k\u00ea c\u00e1c d\u1ecbch v\u1ee5 ch\u1ea1y d\u00f9ng chung (Core) v\u00e0 d\u1ecbch v\u1ee5 nghi\u1ec7p v\u1ee5 (Business), k\u00e8m \u0111\u01b0\u1eddng d\u1eabn t\u00e0i li\u1ec7u k\u1ef9 thu\u1eadt (ADR / SDD) \u0111\u1ec3 tra c\u1ee9u chi ti\u1ebft.</p>"},{"location":"#61-core-services-shared","title":"6.1 Core Services (Shared)","text":"# Service M\u1ee5c \u0111\u00edch ch\u00ednh ADR / SDD Ghi ch\u00fa 1 API Gateway C\u1ed5ng v\u00e0o duy nh\u1ea5t, route &amp; rate-limit, x\u00e1c th\u1ef1c JWT, g\u1eafn RBAC. ADR-009 \u2013 API Governance Envoy + Lua filter, mTLS n\u1ed9i b\u1ed9 2 Token Service Ph\u00e1t h\u00e0nh / refresh / revoke JWT, JWKS. ADR-006 \u2013 Auth Strategy; CR-03 RS256, Redis revoked cache 3 Auth Master \u0110\u0103ng nh\u1eadp Google OAuth2, \u00e1nh x\u1ea1 tenant. ADR-006 Stateless; l\u01b0u session b\u00ean TokenSvc 4 User Master Qu\u1ea3n l\u00fd profile to\u00e0n c\u1ee5c, RBAC master. SDD-User-Master (WIP) Pub/Sub ph\u00e1t s\u1ef1 ki\u1ec7n user.* 5 Notification Master Orchestrate g\u1eedi email/SMS, qu\u1ea3n l\u00fd template. ADR-008 \u2013 Audit Logging; ADR-028 \u2013 Reporting Fan-out t\u1edbi Notif-Sub 6 Reporting Service Truy v\u1ea5n Data Warehouse, sinh dashboard &amp; export. ADR-028 \u2013 Reporting Architecture Multi-tenant; BigQuery 7 Audit-Logging Service Thu th\u1eadp &amp; k\u00fd log truy v\u1ebft. ADR-008 B\u1eaft s\u1ef1 ki\u1ec7n token., user. 8 Cost Observability Theo d\u00f5i chi ph\u00ed cloud / tenant. ADR-020 \u2013 Cost Observability Grafana + Cloud Billing API 9 External Observability Gi\u00e1m s\u00e1t uptime API b\u00ean ngo\u00e0i. ADR-021 \u2013 External Observability Synthetic probe, SLA report 10 Pub/Sub Bus K\u00eanh s\u1ef1 ki\u1ec7n b\u1ea5t \u0111\u1ed3ng b\u1ed9. ADR-030 \u2013 Event Schema Gov. topic=\u201ctenant.*\u201d, schema registry 11 Redis Cluster Revoked-token cache + transient data. ADR-022 \u2013 SLO &amp; Monitoring 3-node, cross-zone"},{"location":"#62-business-services-per-tenant","title":"6.2 Business Services (per tenant)","text":"# Service M\u1ee5c \u0111\u00edch ADR / SDD Ghi ch\u00fa 1 School Management System (SMS) CRM + SIS + LMS t\u00edch h\u1ee3p. SDD-SMS (WIP) MariaDB; expose <code>/sms/**</code> 2 Auth Sub \u0110\u0103ng nh\u1eadp Local/OTP, sync user. ADR-006 B\u1eaft bu\u1ed9c n\u1ebfu d\u00f9ng Local/OTP 3 User Sub Read-replica profile + RBAC theo tenant. SDD-User-Sub (WIP) \u0110\u1ed3ng b\u1ed9 qua Pub/Sub 4 Notification Sub \u0110\u1ea9y th\u00f4ng b\u00e1o realtime n\u1ed9i b\u1ed9 tenant. ADR-008 Nh\u1eadn event t\u1eeb Notif Master 5 Local Redis Cache session / OTP temp. (inherit core pattern) Ch\u1ec9 trong tenant VPC <p>C\u00e1c adapter c\u0169 <code>crm-adapter</code>, <code>sis-adapter</code>, <code>lms-adapter</code> \u0111\u00e3 ng\u01b0ng \u2013 thay th\u1ebf ho\u00e0n to\u00e0n b\u1edfi SMS.</p>"},{"location":"#63-cross-cutting-infrastructure","title":"6.3 Cross-cutting &amp; Infrastructure","text":"Th\u00e0nh ph\u1ea7n Vai tr\u00f2 Li\u00ean quan GitOps / ArgoCD Deploy Core + Tenant Stack, m\u00f4i tr\u01b0\u1eddng Stage/Prod. ADR-001 \u2013 CI/CD Terraform Modules Provision VPC, CloudSQL (MariaDB), Secrets, DNS. ADR-015 \u2013 Deployment Strategy Data Warehouse (BigQuery) L\u01b0u tr\u1eef ELT t\u1eeb SMS, log ph\u00e2n t\u00e1ch theo <code>tenant_id</code>. ADR-028 Grafana + Prometheus Monitor CPU, latency, SLO dashboard. ADR-022 OpenTelemetry Collector Trace &amp; log routing \u2192 GCP Cloud Logging. ADR-021"},{"location":"#64-uu-tien-phat-trien-roadmap","title":"6.4 \u01afu ti\u00ean ph\u00e1t tri\u1ec3n (Roadmap)","text":"<ol> <li>User Service Master \u2013 SDD \u201cLegendary++\u201d (\u0111ang vi\u1ebft) \u2192 unlock RBAC advance.  </li> <li>SMS OpenAPI \u2192 chu\u1ea9n ho\u00e1 contract, b\u1eadt code-gen client cho portal.  </li> <li>Audit-Logging v2 \u2192 blockchain timestamp &amp; zero-trust export.  </li> <li>Cost Observability automation \u2192 chargeback d\u00f2ng ti\u1ec1n per tenant.  </li> <li>External Observability SLA dashboard \u2192 public status.truongvietanh.edu.vn.</li> </ol> <p>Ghi nh\u1edb: M\u1ecdi d\u1ecbch v\u1ee5 m\u1edbi ph\u1ea3i tu\u00e2n th\u1ee7 b\u1ed9 5\u2605 standards v\u00e0 \u0111\u01b0\u1ee3c ghi l\u1ea1i d\u01b0\u1edbi d\u1ea1ng ADR + SDD tr\u01b0\u1edbc khi tri\u1ec3n khai.</p>"},{"location":"#7-observability-security","title":"7. Observability &amp; Security","text":"<p>M\u1ee5c ti\u00eau \u2013 \u0110\u1ea3m b\u1ea3o t\u00ednh minh b\u1ea1ch (observability) cho v\u1eadn h\u00e0nh v\u00e0 t\u00ednh an to\u00e0n (security) cho d\u1eef li\u1ec7u/ngu\u1ed3n l\u1ef1c c\u1ee7a to\u00e0n h\u1ec7 th\u1ed1ng DX-VAS. C\u00e1c nguy\u00ean t\u1eafc b\u00ean d\u01b0\u1edbi l\u1ea5y c\u0103n c\u1ee9 t\u1eeb: \u2022 <code>ADR-004 \u2013 Security</code> \u00b7 <code>ADR-022 \u2013 SLO &amp; Monitoring</code> \u00b7 <code>ADR-020 \u2013 Cost Observability</code> \u00b7 <code>ADR-021 \u2013 External Observability</code> \u00b7 <code>ADR-011 \u2013 API Error Format</code> \u00b7 <code>ADR-003 \u2013 Secrets</code> </p>"},{"location":"#71-observability","title":"7.1 Observability \ud83d\udd0d","text":"Kh\u00eda c\u1ea1nh Th\u1ef1c hi\u1ec7n C\u00f4ng c\u1ee5 / ADR C\u1ea3nh b\u00e1o &amp; Dashboard Logging To\u00e0n b\u1ed9 service log theo chu\u1ea9n JSON (<code>trace_id</code>, <code>tenant_id</code>, <code>level</code>, <code>error.code</code>). ADR-011 Cloud Logging + Log-based Metrics; alert <code>error.rate &gt; 5 %</code>/5\u2032 Metrics Prometheus scrape Gateway, Core &amp; Tenant; export qua OTLP. ADR-022 Grafana dashboard CPU, latency, p95 Tracing OpenTelemetry inject v\u00e0o Gateway \u2192 trace xuy\u00ean su\u1ed1t tenant. ADR-022 Jaeger UI; c\u1ea3nh b\u00e1o span &gt; 3 s SLO / SLA Each core API khai b\u00e1o target (e.g., <code>availability 99.9 %</code>). ADR-022 Alert khi <code>error_budget</code> c\u00f2n &lt; 5 % Cost Collect GCP Billing + resource tag <code>tenant_id</code>. ADR-020 \u201cCost per tenant\u201d / ng\u00e0y, c\u1ea3nh b\u00e1o t\u0103ng &gt; 20 % External Uptime Synthetic probe HTTPS 1\u2032/tenant. ADR-021 Public status page; SMS alert downtime &gt; 1\u2032"},{"location":"#711-revoked-token-hit-ratio","title":"7.1.1 Revoked-Token Hit Ratio","text":"<ul> <li>Metric: <code>revoked_token_cache_hit_ratio</code> (Gateway).  </li> <li>M\u1ee5c ti\u00eau: &gt; 95 %. Alert n\u1ebfu &lt; 90 % li\u00ean t\u1ee5c 10 ph\u00fat \u2192 \u0111i\u1ec1u tra Redis / sync Token Service.</li> </ul>"},{"location":"#72-security","title":"7.2 Security \ud83d\udee1\ufe0f","text":"Th\u00e0nh ph\u1ea7n Bi\u1ec7n ph\u00e1p ADR / T\u00e0i li\u1ec7u JWT RS256, <code>kid</code> double keys, rotation \u2264 90 ng\u00e0y; JWKS cache 10\u2032. ADR-006 API Gateway mTLS n\u1ed9i b\u1ed9, WAF rule OWASP top-10, strict CORS. ADR-004 Secrets GCP Secret Manager, versioning &amp; rotation CI. ADR-003 RBAC Claims <code>roles</code>, <code>permissions</code> trong JWT; Gateway Enforcer plugin. ADR-007 Data-at-Rest Cloud KMS key-encrypted (MariaDB, Redis, BigQuery). ADR-004 Network VPC-SC, egress whitelisting, Cloud Armor rate-limit. ADR-004 Audit Log Token, user, admin action \u2192 Audit-Logging Service (immutable). ADR-008 Error Handling <code>ErrorEnvelope</code> + <code>namespace.snake_case</code>; kh\u00f4ng l\u1ed9 PII. ADR-011"},{"location":"#721-key-rotation-jwks","title":"7.2.1 Key Rotation &amp; JWKS","text":"<ul> <li>Rotation job: Cloud Build pipeline t\u1ea1o key m\u1edbi, g\u1eafn <code>kid=next</code>, deploy Token Service \u2192 sau 24 h xo\u00e1 key c\u0169.  </li> <li>Fallback: N\u1ebfu JWKS fetch l\u1ed7i &gt; 3 l\u1ea7n, Gateway c\u1ee9ng ch\u1eb7n traffic (fail-closed).</li> </ul>"},{"location":"#722-pen-test-compliance","title":"7.2.2 Pen-test &amp; Compliance","text":"<ul> <li>Quarterly penetration test + SAST/DAST; k\u1ebft qu\u1ea3 l\u01b0u requests/04-cr-tenant-system.md ph\u1ee5 l\u1ee5c b\u1ea3o m\u1eadt.  </li> <li>Tu\u00e2n th\u1ee7 GDPR cho d\u1eef li\u1ec7u h\u1ecdc sinh &amp; ph\u1ee5 huynh; d\u1eef li\u1ec7u PII \u0111\u01b0\u1ee3c \u1ea9n danh theo <code>ADR-024</code>.</li> </ul>"},{"location":"#73-alert-routing-escalation","title":"7.3 Alert Routing &amp; Escalation","text":"Severity Trigger v\u00ed d\u1ee5 Th\u1eddi gian ph\u1ea3n h\u1ed3i K\u00eanh P1 API Gateway 5xx surge &gt; 10 % 2\u2032 5\u2032 PagerDuty \u2192 Phone P2 SLO breach d\u1ef1 b\u00e1o 4 h 30\u2032 Slack #sre-alerts P3 Cost \u2191 20 % ng\u00e0y 8 h Email FinOps P4 Log anomaly non-critical 24 h Jira ticket <p>Nguy\u00ean t\u1eafc v\u00e0ng: \u201cB\u1ea1n kh\u00f4ng th\u1ec3 b\u1ea3o v\u1ec7 \u0111i\u1ec1u b\u1ea1n kh\u00f4ng quan s\u00e1t \u0111\u01b0\u1ee3c.\u201d \u2013 Observability &amp; Security ph\u1ea3i song h\u00e0nh \u0111\u1ec3 DX-VAS v\u1eadn h\u00e0nh tin c\u1eady, tu\u00e2n th\u1ee7, v\u00e0 t\u1ed1i \u01b0u chi ph\u00ed.</p>"},{"location":"#8-cicd-deployment","title":"8. CI/CD &amp; Deployment","text":"<p>C\u01a1 ch\u1ebf CI/CD c\u1ee7a DX-VAS \u00e1p d\u1ee5ng tri\u1ec7t \u0111\u1ec3 tri\u1ebft l\u00fd \u201cEverything-as-Code\u201d v\u00e0 GitOps, b\u1ea3o \u0111\u1ea3m tri\u1ec3n khai Zero-Downtime theo <code>ADR-014</code>, \u1ee7y quy\u1ec1n ph\u00e1t h\u00e0nh r\u00f5 r\u00e0ng theo <code>ADR-018</code>, v\u00e0 h\u1ea1 t\u1ea7ng b\u1ea5t bi\u1ebfn theo <code>ADR-002</code> &amp; <code>ADR-015</code>.</p>"},{"location":"#81-nhanh-ma-chinh-sach-pr","title":"8.1 Nh\u00e1nh m\u00e3 &amp; Ch\u00ednh s\u00e1ch PR","text":"Nh\u00e1nh M\u1ee5c \u0111\u00edch B\u1ea3o v\u1ec7 <code>main</code> M\u00e3 \u0111\u00e3 QA, s\u1eb5n s\u00e0ng production PR b\u1eaft bu\u1ed9c 2 reviewer + pass check <code>develop</code> H\u1ed9i t\u1ee5 feature; deploy Staging t\u1ef1 \u0111\u1ed9ng PR 1 reviewer <code>feature/*</code> T\u00ednh n\u0103ng / bugfix Run CI unit-test"},{"location":"#82-pipeline-ci-github-actions","title":"8.2 Pipeline CI (GitHub Actions)","text":"<ol> <li>Checkout + Cache <code>actions/checkout@v4</code> \u2192 thi\u1ebft l\u1eadp cache pnpm / poetry.</li> <li>Static Analysis &amp; SCA </li> <li>SAST (SonarQube) \u2013 fail n\u1ebfu critical.  </li> <li>Dependency CVE (Dependabot).  </li> <li>Unit &amp; Contract Test </li> <li>Python/PyTest + Coverage \u2265 85 %.  </li> <li>Contract-Testing theo <code>ADR-010</code> (PactFlow).  </li> <li>Build &amp; SBOM </li> <li>Docker multi-arch (<code>linux/amd64, arm64</code>).  </li> <li>T\u1ea1o SBOM CycloneDX; push Artifact Registry.  </li> <li>Image Scan (GCP Container Analysis) \u2013 block CVE \u201cHigh\u201d.</li> <li>Publish </li> <li>Tag <code>main</code> \u21d2 <code>vX.Y.Z</code> (semantic-release).  </li> <li>Upload Helm chart \u2192 Helm Repo.</li> </ol>"},{"location":"#83-pipeline-cd-argo-cd-terraform-cloud","title":"8.3 Pipeline CD (Argo CD + Terraform Cloud)","text":"Pha C\u00f4ng c\u1ee5 \u0110i\u1ec1u ki\u1ec7n / Ph\u00ea duy\u1ec7t Infra-Provision Terraform Cloud PR tr\u00ean infra repo \u2192 auto-plan, Manual Approve Staging Deploy Argo CD (sync-wave 0) Auto n\u1ebfu container tag <code>v*</code> push l\u00ean <code>develop</code> Integration Test GitHub Action + Postman Pass 95 % \u2192 ghi ch\u00fa v\u00e0o PR Release Approval Argo CD wave \u201cprod-canary\u201d Y\u00eau c\u1ea7u Product Owner + SRE (theo <code>ADR-018</code>) Canary 10 % Argo Rollouts 15 min metric check (latency / error rate) Full Ramp-Up Argo Rollouts Auto n\u1ebfu canary stable Rollback Argo Rollouts <code>rollback</code> &lt; 2 min; traffic switch 100 \u2192 previous"},{"location":"#84-zero-downtime-chien-luoc-trien-khai","title":"8.4 Zero-Downtime &amp; Chi\u1ebfn l\u01b0\u1ee3c Tri\u1ec3n khai","text":"<ul> <li>Canary Rollout (default) \u2013 10 \u2192 25 \u2192 50 \u2192 100 %.  </li> <li>Blue-Green \u2013 d\u00f9ng cho migration DB l\u1edbn (flag <code>strategy=bluegreen</code>).  </li> <li>Schema Migration \u2013 GitOps-DB ch\u1ea1y <code>flyway</code> job \u2192 version-controlled (ADR-023).  </li> <li>Auto-Scaling \u2013 HPA theo p95 latency &amp; CPU (ADR-016).  </li> <li>Env Deploy Boundary \u2013 Staging v\u00e0 Prod t\u00e1ch VPC, project (GCP) (ADR-017).</li> </ul>"},{"location":"#85-tenant-on-boarding-pipeline","title":"8.5 Tenant On-Boarding Pipeline","text":"<pre><code>flowchart LR\n  A[Create Tenant PR] --&gt; B[Terraform Cloudplan/applyproject, VPC, MariaDB]\n  B --&gt; C[DNS &amp; Cert bot]\n  C --&gt; D[Argo CDsync tenant stackSMS + Sub services]\n  D --&gt; E[\"API Gateway auto-route/sms/{tenant}\"]\n  E --&gt; F[Smoke Test suite]\n</code></pre> <ul> <li>Th\u1eddi gian: \\~ 25 ph\u00fat/tenant (99-percentile).</li> <li>Output: Slack th\u00f4ng b\u00e1o \u201cTenant abc ready \ud83c\udf89\u201d.</li> </ul>"},{"location":"#86-quan-ly-cau-hinh-secrets","title":"8.6 Qu\u1ea3n l\u00fd C\u1ea5u h\u00ecnh &amp; Secrets","text":"<ul> <li>ADR-005 \u2013 c\u1ea5u h\u00ecnh qua ConfigMap/Secret ph\u00e2n t\u00e1ch <code>env</code> v\u00e0 <code>tenant</code>.</li> <li>ADR-003 \u2013 Secrets (RSA key, OTP provider) l\u01b0u GCP Secret Manager v\u1edbi rotation cron.</li> </ul>"},{"location":"#87-kiem-soat-chi-phi-carbon","title":"8.7 Ki\u1ec3m so\u00e1t Chi ph\u00ed &amp; Carbon","text":"<ul> <li>FinOps Job ch\u1ea1y m\u1ed7i \u0111\u00eam: truy v\u1ea5n Cloud Billing API \u2192 BigQuery \u2192 Grafana \u201cCost/Tenant/Service\u201d.</li> <li>C\u1ea3nh b\u00e1o Slack khi chi ph\u00ed ch\u1ec7ch &gt; 20 % so v\u1edbi trung b\u00ecnh 7 ng\u00e0y.</li> </ul>"},{"location":"#88-so-o-luong-cicd-tong-quan","title":"8.8 S\u01a1 \u0111\u1ed3 lu\u1ed3ng CI/CD t\u1ed5ng quan","text":"<pre><code>graph TB\n  Dev --&gt;|PR| GitHub\n  GitHub --&gt;|CI pass| ArtifactRegistry\n  ArtifactRegistry --&gt;|tag main| ArgoCD\n  ArgoCD --&gt;|sync| Staging\n  Staging --&gt;|integration ok| ArgoGate[Release Approval]\n  ArgoGate --&gt;|canary| ProdCanary\n  ProdCanary --&gt;|auto promote| Prod\n  Prod --&gt;|metrics| Grafana\n</code></pre> <p>Ngu\u1ed3n tham chi\u1ebfu: \u2022 <code>ADR-001 \u2013 CI/CD</code> \u00b7 <code>ADR-014 \u2013 Zero-Downtime</code> \u00b7 <code>ADR-015 \u2013 Deployment Strategy</code> \u00b7 <code>ADR-018 \u2013 Release Approval Policy</code> \u2022 Terraform module <code>tenant-stack</code> \u00b7 Helm chart <code>dx-vas-core</code>.</p>"},{"location":"#9-data-reporting","title":"9. Data &amp; Reporting","text":"<p>Ph\u1ea7n n\u00e0y tr\u00ecnh b\u00e0y c\u00e1ch DX-VAS thu th\u1eadp, l\u01b0u tr\u1eef, qu\u1ea3n tr\u1ecb v\u00e0 khai th\u00e1c d\u1eef li\u1ec7u \u2014 t\u1eeb SMS c\u1ee7a t\u1eebng tenant, qua ELT pipeline, v\u00e0o Data Warehouse, v\u00e0 cu\u1ed1i c\u00f9ng hi\u1ec3n th\u1ecb b\u00e1o c\u00e1o. C\u00e1c quy\u1ebft \u0111\u1ecbnh thi\u1ebft k\u1ebf d\u1ef1a tr\u00ean: \u2022 <code>ADR-023 Schema Migration</code> :contentReference[oaicite:0]{index=0} \u00b7 <code>ADR-024 Data Anonymization &amp; Retention</code> :contentReference[oaicite:1]{index=1} \u00b7 <code>ADR-026 Hard Delete Policy</code> :contentReference[oaicite:2]{index=2} \u00b7 <code>ADR-027 Data Management Strategy</code> :contentReference[oaicite:3]{index=3} \u00b7 <code>ADR-028 Reporting Architecture</code> :contentReference[oaicite:4]{index=4} \u00b7 <code>ADR-029 Report Template Schema</code> :contentReference[oaicite:5]{index=5} \u00b7 <code>ADR-030 Event Schema Governance</code> :contentReference[oaicite:6]{index=6}</p>"},{"location":"#91-nguon-du-lieu-goc-source-of-truth","title":"9.1 Ngu\u1ed3n d\u1eef li\u1ec7u g\u1ed1c (Source-of-Truth)","text":"Ngu\u1ed3n C\u00f4ng ngh\u1ec7 Ph\u00e2n v\u00f9ng SMS DB (per tenant) MariaDB Galera cluster 1 schema/tenant Event Bus Pub/Sub topic <code>tenant.*</code> Schema version =<code>v1</code> Audit Log Cloud Logging \u2192 BigQuery B\u1ea3ng <code>audit_log_*</code> (partition date)"},{"location":"#92-elt-pipeline-near-real-time","title":"9.2 ELT Pipeline (near-real-time)","text":"<pre><code>flowchart LR\n  SMS_MariaDB((MariaDB)) --&gt;|DebeziumCDC| DataLake[(Cloud StorageParquet Staging)]\n  DataLake --&gt;|Dataflowtransform| BQ[BigQueryData Warehouse]\n  PubSub((Pub/Sub)) --&gt;|StreamDataflow| BQ\n</code></pre> <ul> <li>Extract: Debezium CDC dump insert/update/delete m\u1ed7i tenant v\u00e0o Cloud Storage (Parquet).</li> <li>Load: Scheduled Dataflow job n\u1ea1p incremental v\u00e0o BigQuery staging.</li> <li>Transform: dbt ch\u1ea1y nightly t\u1ea1o Data Mart (<code>fct_enrolment</code>, <code>dim_student</code>, v.v.).</li> <li>Latency m\u1ee5c ti\u00eau: &lt; 5 ph\u00fat cho s\u1ef1 ki\u1ec7n, &lt; 30 ph\u00fat cho batch.</li> </ul>"},{"location":"#93-thiet-ke-data-warehouse","title":"9.3 Thi\u1ebft k\u1ebf Data Warehouse","text":"Layer Chi ti\u1ebft Partition / Cluster Raw 1 b\u1ea3ng th\u00f4 / table_source / tenant <code>tenant_id</code>, <code>_PARTITIONDATE</code> Staging Chu\u1ea9n ho\u00e1 ki\u1ec3u d\u1eef li\u1ec7u, th\u00eam <code>load_ts</code> nh\u01b0 Raw Mart Fact / Dim theo Kimball (star schema) cluster <code>tenant_id</code> &amp; business_key Sandbox Export dataset cho ML / BI ACL theo RBAC (teacher, admin) <p>Retention: Raw = 30 ng\u00e0y (xem <code>ADR-024</code>); Mart gi\u1eef 5 n\u0103m, b\u1ea3n ghi PII \u0111\u01b0\u1ee3c \u1ea9n danh (hash + salt).</p>"},{"location":"#94-bao-cao-bi","title":"9.4 B\u00e1o c\u00e1o &amp; BI","text":"<ul> <li>Reporting Service \u0111\u1ecdc Mart, sinh dashboard multi-tenant (Grafana, Superset).</li> <li>M\u1ed7i b\u00e1o c\u00e1o tu\u00e2n th\u1ee7 template JSON Schema v1.0 (\u0111\u1ecbnh ngh\u0129a t\u1ea1i <code>ADR-029</code>).</li> <li>Public API <code>/reports/:id/export</code> tr\u1ea3 v\u1ec1 CSV / Parquet; Gateway g\u1eafn header <code>X-Tenant-ID</code>.</li> </ul>"},{"location":"#95-data-governance-compliance","title":"9.5 Data Governance &amp; Compliance","text":"Ch\u00ednh s\u00e1ch N\u1ed9i dung then ch\u1ed1t ADR Schema Versioning M\u1ecdi event/b\u1ea3ng c\u00f3 <code>schema_version</code> theo <code>adr-030</code>; backward-compatible \u2265 6 th\u00e1ng. 030 Migration Flyway <code>V__</code> script, PR review b\u1eaft bu\u1ed9c (<code>adr-023</code>). 023 Anonymization Hash + salt cho PII; d\u1ea1y d\u1eef li\u1ec7u demo qua <code>synthetic_*</code> view. 024 Hard Delete TTL API <code>/delete</code> \u2192 soft flag, job purge sau 30 ng\u00e0y. 026 Data Lifecycle Tier S3\u2192Nearline\u2192Coldline \u2265 3 n\u0103m; policy BQ partition expire. 027"},{"location":"#96-quan-sat-sla-du-lieu","title":"9.6 Quan s\u00e1t &amp; SLA d\u1eef li\u1ec7u","text":"Metric M\u1ee5c ti\u00eau Alert ELT lag (p95) &lt; 10 ph\u00fat &gt; 20 ph\u00fat 15\u2032 Data Quality test pass = 100 % b\u1ea5t k\u1ef3 l\u1ed7i Great Expectations Warehouse cost/tenant +\u2264 15 % so v\u1edbi 30 ng\u00e0y Slack FinOps daily"},{"location":"#97-tich-hop-event-schema-governance","title":"9.7 T\u00edch h\u1ee3p Event Schema Governance","text":"<ul> <li>M\u1ecdi s\u1ef1 ki\u1ec7n <code>*.*.v1</code> ph\u1ea3i \u0111\u0103ng k\u00fd schema Avro trong Schema Registry (<code>ADR-030</code>).</li> <li>Pipeline Dataflow validate schema ID tr\u01b0\u1edbc khi n\u1ea1p v\u00e0o BigQuery; sai l\u1ec7ch \u2192 g\u1eedi <code>error.code=data.schema_mismatch</code>.</li> </ul> <p>N\u1ec1n t\u1ea3ng d\u1eef li\u1ec7u DX-VAS \u0111\u01b0\u1ee3c d\u1ef1ng \u0111\u1ec3 d\u1ec5 m\u1edf r\u1ed9ng, tu\u00e2n th\u1ee7 (GDPR) v\u00e0 t\u1ed1i \u01b0u chi ph\u00ed \u2014 b\u1ea3o \u0111\u1ea3m m\u1ed7i tenant truy c\u1eadp b\u00e1o c\u00e1o k\u1ecbp th\u1eddi m\u00e0 kh\u00f4ng \u1ea3nh h\u01b0\u1edfng d\u1eef li\u1ec7u tenant kh\u00e1c.</p>"},{"location":"#10-adr-cr-index","title":"10. ADR &amp; CR Index","text":""},{"location":"#101-architecture-decision-records-adr","title":"10.1 Architecture Decision Records (ADR)","text":"ID T\u00ean / Ch\u1ee7 \u0111\u1ec1 \u0110\u01b0\u1eddng d\u1eabn 001 CI/CD &amp; GitOps Pipeline adr-001-ci-cd.md 002 Infrastructure-as-Code (Terraform) adr-002-iac.md 003 Secrets Management &amp; Key Rotation adr-003-secrets.md 004 Security Principles &amp; Trust Boundary adr-004-security.md 005 Environment Configuration Strategy adr-005-env-config.md 006 Auth Strategy &amp; Token Service adr-006-auth-strategy.md 007 Role-Based Access Control (RBAC) adr-007-rbac.md 008 Audit Logging adr-008-audit-logging.md 009 API Governance &amp; Style adr-009-api-governance.md 010 Contract Testing adr-010-contract-testing.md 011 API Error Format (ErrorEnvelope) adr-011-api-error-format.md 012 Standard Response Structure adr-012-response-structure.md 013 Path Naming Convention adr-013-path-naming-convention.md 014 Zero-Downtime Deployment adr-014-zero-downtime.md 015 Deployment Strategy &amp; Boundary adr-015-deployment-strategy.md 016 Auto-Scaling Policy adr-016-auto-scaling.md 017 Environment Deploy Boundary adr-017-env-deploy-boundary.md 018 Release Approval Policy adr-018-release-approval-policy.md 019 Project Layout Standard adr-019-project-layout.md 020 Cost Observability adr-020-cost-observability.md 021 External Observability &amp; SLA adr-021-external-observability.md 022 SLA / SLO Monitoring adr-022-sla-slo-monitoring.md 023 Schema Migration Strategy adr-023-schema-migration-strategy.md 024 Data Anonymization &amp; Retention adr-024-data-anonymization-retention.md 025 Multi-Tenant Versioning adr-025-multi-tenant-versioning.md 026 Hard-Delete Policy adr-026-hard-delete-policy.md 027 Data Management Strategy adr-027-data-management-strategy.md 028 Reporting Architecture adr-028-reporting-architecture.md 029 Report Template Schema adr-029-report-template-schema.md 030 Event Schema Governance adr-030-event-schema-governance.md"},{"location":"#102-change-requests-cr","title":"10.2 Change Requests (CR)","text":"M\u00e3 CR M\u00f4 t\u1ea3 ng\u1eafn \u0110\u01b0\u1eddng d\u1eabn 03-CR Gi\u1edbi thi\u1ec7u Token Service, chu\u1ea9n h\u00f3a JWT lifecycle 03-cr-token-service.md 04-CR Tenant Stack simplification &amp; School Management System 04-cr-tenant-system.md <p>Ghi ch\u00fa: ADR = quy\u1ebft \u0111\u1ecbnh ki\u1ebfn tr\u00fac l\u00e2u d\u00e0i; CR = thay \u0111\u1ed5i l\u1edbn \u0111\u01b0\u1ee3c ph\u00ea duy\u1ec7t sau giai \u0111o\u1ea1n thi\u1ebft k\u1ebf chi ti\u1ebft.  M\u1ecdi PR m\u1edbi thay \u0111\u1ed5i ki\u1ebfn tr\u00fac ph\u1ea3i k\u00e8m ADR / CR t\u01b0\u01a1ng \u1ee9ng tr\u01b0\u1edbc khi merge v\u00e0o <code>main</code>.</p>"},{"location":"#11-standards-conventions","title":"11. Standards &amp; Conventions","text":"<p>M\u1ee5c \u0111\u00edch \u2013 B\u1ea3o \u0111\u1ea3m m\u1ecdi th\u00e0nh ph\u1ea7n c\u1ee7a DX-VAS tu\u00e2n th\u1ee7 m\u1ed9t b\u1ed9 quy \u01b0\u1edbc th\u1ed1ng nh\u1ea5t v\u1ec1 thi\u1ebft k\u1ebf d\u1ecbch v\u1ee5, d\u1eef li\u1ec7u, API, m\u00e3 l\u1ed7i, versioning v\u00e0 style code, gi\u00fap gi\u1ea3m sai s\u00f3t, d\u1ec5 b\u1ea3o tr\u00ec v\u00e0 \u0111\u1ed3ng nh\u1ea5t tr\u1ea3i nghi\u1ec7m.</p>"},{"location":"#111-bo-tieu-chuan-5-5-star-standards","title":"11.1 B\u1ed9 ti\u00eau chu\u1ea9n \u201c5\u2605\u201d (5-Star Standards)","text":"\u2b50 T\u00e0i li\u1ec7u Ph\u1ea1m vi B\u1eaft bu\u1ed9c \u2b501 5s.service.design.standard.md Chi\u1ebfn l\u01b0\u1ee3c service, boundary, SLA, deploy \u2714 \u2b502 5s.data.model.standard.md Quy t\u1eafc \u0111\u1eb7t t\u00ean b\u1ea3ng/field, kho\u00e1 ngo\u1ea1i, index \u2714 \u2b503 5s.interface.contract.doc.standard.md C\u00e1ch vi\u1ebft t\u00e0i li\u1ec7u Interface Contract (IC) \u2714 \u2b504 5s.openapi.standard.md Quy \u0111\u1ecbnh OpenAPI (tags, schemas, examples) \u2714 \u2b505 Security Appendix (trong \u2b501) OWASP, mTLS, key rotation \u2714 <p>Check-list CI: PR n\u00e0o ch\u1ee9a file IC/OpenAPI s\u1ebd ch\u1ea1y linter 5\u2605 \u2013 fail n\u1ebfu vi ph\u1ea1m.</p>"},{"location":"#112-error-codes-envelope","title":"11.2 Error Codes &amp; Envelope","text":"Quy chu\u1ea9n \u0110\u01b0\u1eddng d\u1eabn Ghi ch\u00fa ErrorEnvelope ADR-011 Field <code>error</code>, <code>meta</code> b\u1eaft bu\u1ed9c Danh m\u1ee5c m\u00e3 l\u1ed7i error-codes.md \u0110\u1eb7t t\u00ean <code>namespace.snake_case</code> (vd: <code>token.expired</code>) Th\u00eam m\u00e3 l\u1ed7i m\u1edbi Update PR v\u00e0o file tr\u00ean + reviewer \u201cTech Lead API\u201d Kh\u00f4ng tr\u00f9ng namespace"},{"location":"#113-naming-versioning","title":"11.3 Naming &amp; Versioning","text":"Th\u1ef1c th\u1ec3 Quy t\u1eafc ch\u00ednh ADR / Standard API Path <code>/resource/{id}</code>, verb = HTTP; kh\u00f4ng \u201c/getFoo\u201d ADR-013 Event <code>domain.action.v{major}</code> \u2013 vd: <code>token.issued.v1</code> ADR-030 Docker Image <code>service:MAJOR.MINOR.PATCH</code> (SemVer) ADR-015 Tenant Stack <code>dx-vas-tenant-&lt;slug&gt;</code> (lower-kebab) ADR-019 Branch Git <code>feature/&lt;ticket&gt;</code>, <code>fix/&lt;ticket&gt;</code> ADR-001 DB Migration <code>V&lt;yyyyMMddHHmm&gt;__&lt;desc&gt;.sql</code> (Flyway) ADR-023"},{"location":"#114-style-guide-code-docs","title":"11.4 Style Guide (Code &amp; Docs)","text":"Ng\u00f4n ng\u1eef Linter / Formatter Rule n\u1ed5i b\u1eadt Python ruff + black max-line 120, type-hint b\u1eaft bu\u1ed9c TypeScript eslint + prettier strictNullChecks, import alias <code>@/</code> Terraform <code>terraform fmt</code> + tflint module version lock SQL (MariaDB) sqlfluff (<code>ansi</code>) snake_case table/column Markdown markdownlint ATX heading, table alignment Mermaid kroki validate ph\u1ea3i k\u00e8m ch\u00fa th\u00edch key \u0111\u01b0\u1eddng n\u1ed1i <p>Docs-as-Code: M\u1ecdi t\u00e0i li\u1ec7u (ADR, SDD, IC) l\u01b0u trong Git, PR review = code.</p>"},{"location":"#115-kiem-tra-tuan-thu-ci-checks","title":"11.5 Ki\u1ec3m tra tu\u00e2n th\u1ee7 (CI Checks)","text":"<ol> <li>5\u2605 Linter \u2013 validate OpenAPI &amp; IC.  </li> <li>Schema Registry \u2013 event Avro ID ph\u1ea3i kh\u1edbp ADR-030.  </li> <li>SBOM &amp; CVE Scan \u2013 block CVE High/critical.  </li> <li>Error code validator \u2013 compare <code>error.code</code> xu\u1ea5t hi\u1ec7n trong OpenAPI v\u1edbi danh s\u00e1ch chu\u1ea9n.  </li> </ol>"},{"location":"#116-ngoai-le-quy-trinh-phe-duyet","title":"11.6 Ngo\u1ea1i l\u1ec7 &amp; Quy tr\u00ecnh ph\u00ea duy\u1ec7t","text":"<ul> <li>Ngo\u1ea1i l\u1ec7 hi\u1ebfm (P0 deadline, legacy) \u21d2 t\u1ea1o RFC k\u00e8m justification, g\u1eafn label <code>standards-waiver</code>, review b\u1edfi Architecture Board.  </li> <li>Sau 60 ng\u00e0y, waiver h\u1ebft h\u1ea1n; service ph\u1ea3i retrofit v\u1ec1 \u0111\u00fang chu\u1ea9n.</li> </ul> <p>Nh\u1eafc l\u1ea1i \u2013 \u201cConsistency is speed.\u201d Tu\u00e2n th\u1ee7 b\u1ed9 chu\u1ea9n tr\u00ean gi\u00fap \u0111\u1ed9i ng\u0169 DX-VAS ship nhanh h\u01a1n m\u00e0 kh\u00f4ng \u0111\u00e1nh \u0111\u1ed5i ch\u1ea5t l\u01b0\u1ee3ng ho\u1eb7c an to\u00e0n.</p>"},{"location":"#12-appendix","title":"12. Appendix","text":""},{"location":"#121-thuat-ngu-glossary","title":"12.1 Thu\u1eadt ng\u1eef (Glossary)","text":"Thu\u1eadt ng\u1eef \u0110\u1ecbnh ngh\u0129a ng\u1eafn Tenant M\u1ed9t c\u01a1 s\u1edf/tr\u01b0\u1eddng s\u1eed d\u1ee5ng DX-VAS; t\u00e1ch bi\u1ec7t b\u1eb1ng <code>tenant_id</code>. Tenant Stack Nh\u00f3m d\u1ecbch v\u1ee5 c\u1ee5c b\u1ed9 c\u1ee7a tenant: SMS + Auth/User/Notif Sub + DB/Cache. SMS (School Management System) Backend t\u00edch h\u1ee3p CRM + SIS + LMS cho t\u1eebng tenant. JWT (JSON Web Token) Chu\u1ed7i k\u00fd RS256 mang claim <code>sub</code>, <code>tid</code>, <code>roles</code>, v.v. JWKS T\u1eadp public key (JSON) \u0111\u1ec3 Gateway x\u00e1c th\u1ef1c ch\u1eef k\u00fd JWT. Token Service Micro-service ph\u00e1t h\u00e0nh, l\u00e0m m\u1edbi, thu h\u1ed3i JWT. RBAC Role-Based Access Control \u2013 u\u1ef7 quy\u1ec1n d\u1ef1a tr\u00ean <code>roles</code> / <code>permissions</code>. ADR Architecture Decision Record \u2013 quy\u1ebft \u0111\u1ecbnh ki\u1ebfn tr\u00fac d\u00e0i h\u1ea1n. CR Change Request \u2013 thay \u0111\u1ed5i l\u1edbn sau giai \u0111o\u1ea1n ph\u00e2n t\u00edch. ELT Extract-Load-Transform pipeline tr\u00edch xu\u1ea5t d\u1eef li\u1ec7u v\u00e0o DW. DW (Data Warehouse) BigQuery ch\u1ee9a d\u1eef li\u1ec7u ph\u00e2n t\u00edch nhi\u1ec1u tenant. Pub/Sub H\u00e0ng \u0111\u1ee3i s\u1ef1 ki\u1ec7n b\u1ea5t \u0111\u1ed3ng b\u1ed9 c\u1ee7a Google Cloud. SLO / SLA Service Level Objective / Agreement \u2013 cam k\u1ebft ch\u1ea5t l\u01b0\u1ee3ng d\u1ecbch v\u1ee5. ErrorEnvelope C\u1ea5u tr\u00fac JSON chu\u1ea9n \u0111\u1ec3 tr\u1ea3 l\u1ed7i (<code>error</code>, <code>meta</code>)."},{"location":"#122-danh-ba-contacts","title":"12.2 Danh b\u1ea1 (Contacts)","text":"Vai tr\u00f2 T\u00ean / Nh\u00f3m Li\u00ean h\u1ec7 Chief Architect John Ng. <code>john.ng@dx-vas.io</code> SRE Lead Linh P. <code>sre@dx-vas.io</code> Product Owner Ms. Thu H. <code>po@dx-vas.io</code> Architecture Board <code>#arch-board</code> Slack channel H\u1ecdp th\u1ee9 5 h\u00e0ng tu\u1ea7n Incident Hotline PagerDuty (P1) <code>+84 28 7100 xxxx</code> <p>(\u0110\u1ecba ch\u1ec9 email/\u0111i\u1ec7n tho\u1ea1i ch\u1ec9 l\u00e0 v\u00ed d\u1ee5; c\u1eadp nh\u1eadt khi \u00e1p d\u1ee5ng th\u1ef1c t\u1ebf.)</p>"},{"location":"#123-changelog-tom-tat","title":"12.3 Changelog (T\u00f3m t\u1eaft)","text":"Phi\u00ean b\u1ea3n Ng\u00e0y Thay \u0111\u1ed5i ch\u00ednh v2-draft 2025-06-09 T\u1ea1o skeleton README.v2.md \u2013 c\u1ea5u tr\u00fac 12 m\u1ee5c. v2-beta 2025-06-10 T\u00edch h\u1ee3p Token Service CR-03 &amp; Tenant Stack CR-04.Vi\u1ebft l\u1ea1i Vision, Architecture, Auth Flow, Token, SMS. v2-rc1 2025-06-11 Ho\u00e0n t\u1ea5t Observability, CI/CD, Data, Standards, Glossary. <p>L\u01b0u \u00fd: Changelog ch\u1ec9 ghi thay \u0111\u1ed5i \u1edf c\u1ea5p ki\u1ebfn tr\u00fac/t\u00e0i li\u1ec7u. Thay \u0111\u1ed5i code chi ti\u1ebft xem Git commit history.</p>"},{"location":"#124-tai-lieu-bo-sung","title":"12.4 T\u00e0i li\u1ec7u b\u1ed5 sung","text":"Ch\u1ee7 \u0111\u1ec1 Li\u00ean k\u1ebft Diagrams (SVG/PNG) <code>docs/diagrams/</code> Service Design Docs (SDD) <code>docs/services/index.md</code> API Reference (OpenAPI) <code>docs/openapi/</code> (auto-generated) Runbooks &amp; Playbooks <code>ops/runbook/</code> Governance RFCs <code>docs/rfc/</code> <p>DX-VAS Platform Documentation v2. Ph\u00e1t h\u00e0nh theo gi\u1ea5y ph\u00e9p n\u1ed9i b\u1ed9; kh\u00f4ng sao ch\u00e9p khi ch\u01b0a c\u00f3 s\u1ef1 \u0111\u1ed3ng \u00fd b\u1eb1ng v\u0103n b\u1ea3n.</p>"},{"location":"ADR/","title":"\ud83d\udcd8 ADR Index \u2013 dx-vas","text":"<p>Danh s\u00e1ch v\u00e0 ph\u1ea1m vi \u00e1p d\u1ee5ng c\u1ee7a c\u00e1c Architecture Decision Records (ADR) cho h\u1ec7 th\u1ed1ng dx-vas. B\u1ea3ng d\u01b0\u1edbi \u0111\u00e2y li\u1ec7t k\u00ea t\u1eebng ADR, c\u00e1c service b\u1ecb \u1ea3nh h\u01b0\u1edfng v\u00e0 vai tr\u00f2/\u0111i\u1ec3m nh\u1ea5n tri\u1ec3n khai \u0111\u1eb7c bi\u1ec7t n\u1ebfu c\u00f3.</p> ADR \u00c1p d\u1ee5ng cho Service Vai tr\u00f2/\u0110i\u1ec3m nh\u1ea5n tri\u1ec3n khai ADR-001: CI/CD T\u1ea5t c\u1ea3 services (core + tenant stack) \u2705 T\u00e1ch pipeline theo stack; \u2705 S\u1eed d\u1ee5ng GitHub Actions v\u00e0 Environments ADR-002: IaC H\u1ea1 t\u1ea7ng GCP to\u00e0n h\u1ec7 th\u1ed1ng \u2705 T\u00e1ch Terraform module cho core/tenant; h\u1ed7 tr\u1ee3 provisioning t\u1ef1 \u0111\u1ed9ng ADR-003: Secrets T\u1ea5t c\u1ea3 services \u2705 Secret per tenant (Zalo, Gmail); qu\u1ea3n l\u00fd b\u1eb1ng Secret Manager &amp; rotate ri\u00eang ADR-004: Security T\u1ea5t c\u1ea3 services \u2705 Gateway enforce JWT trust boundary; \u2705 M\u1ed7i tenant c\u00f3 project/DB/network ri\u00eang ADR-005: Env Config T\u1ea5t c\u1ea3 services \u2705 M\u1ed7i stack c\u00f3 env ri\u00eang (<code>dev</code>, <code>staging</code>, <code>prod</code>) ADR-006: Auth Strategy Auth Service, API Gateway \u2705 Sub Auth login OTP; \u2705 Master Auth Google; JWT c\u00f3 <code>tenant_id</code> ADR-007: RBAC User Service, API Gateway \u2705 RBAC ph\u00e2n t\u1ea7ng; Gateway \u0111\u1ecdc Redis theo <code>user_id</code> + <code>tenant_id</code> ADR-008: Audit Logging T\u1ea5t c\u1ea3 services \u2705 Log h\u00e0nh vi c\u00f3 side-effect; \u2705 Audit log c\u00f3 <code>tenant_id</code>, traceId ADR-009: API Governance T\u1ea5t c\u1ea3 services ph\u01a1i API \u2705 Ki\u1ec3m tra OpenAPI + tagging module trong CI ADR-010: Contract Testing T\u1ea5t c\u1ea3 services ph\u01a1i API \u2705 H\u1ee3p \u0111\u1ed3ng test c\u00f3 <code>tenant_id</code>, JWT context ADR-011: API Error Format T\u1ea5t c\u1ea3 services ph\u01a1i API \u2705 D\u00f9ng chung ErrorEnvelope (code/message/details) ADR-012: Response Structure T\u1ea5t c\u1ea3 services ph\u01a1i API \u2705 Chu\u1ea9n <code>meta</code>, <code>data</code>, <code>errors</code>; d\u1ec5 monitoring ADR-013: Path Naming Convention T\u1ea5t c\u1ea3 services ph\u01a1i API \u2705 Tu\u00e2n th\u1ee7 RESTful, ph\u00e2n lo\u1ea1i r\u00f5 t\u00e0i nguy\u00ean ADR-014: Zero Downtime Deployment T\u1ea5t c\u1ea3 services \u2705 T\u00e1ch migration &amp; deploy; rollback d\u1ec5 d\u00e0ng ADR-015: Deployment Strategy Core &amp; tenant stack \u2705 Stack per tenant; Gateway chia theo domain/host ADR-016: Auto Scaling T\u1ea5t c\u1ea3 services (Cloud Run) \u2705 Core v\u00e0 tenant scale \u0111\u1ed9c l\u1eadp; c\u1ea5u h\u00ecnh min/max instance ADR-017: Env Deploy Boundary T\u1ea5t c\u1ea3 services \u2705 M\u1ed7i tenant c\u00f3 m\u00f4i tr\u01b0\u1eddng ri\u00eang bi\u1ec7t ADR-018: Release Approval Policy Core &amp; tenant stack \u2705 Core ph\u1ea3i duy\u1ec7t th\u1ee7 c\u00f4ng; tenant c\u00f3 th\u1ec3 t\u1ef1 \u0111\u1ed9ng n\u1ebfu an to\u00e0n ADR-019: Project Layout GCP project to\u00e0n h\u1ec7 th\u1ed1ng \u2705 Chia project: core, tenant, monitoring, data ADR-020: Cost Observability T\u1ea5t c\u1ea3 services \u2705 T\u00e1ch chi ph\u00ed per tenant; billing label theo service/group ADR-021: External Observability T\u00f9y ch\u1ecdn cho tenant stack \u2705 Cho ph\u00e9p t\u00edch h\u1ee3p Prometheus, Grafana, Datadog n\u1ebfu c\u1ea7n ADR-022: SLA, SLO, Monitoring T\u1ea5t c\u1ea3 services \u2705 Alert/log theo <code>tenant_id</code>; dashboard ri\u00eang m\u1ed7i tenant ADR-023: Schema Migration Strategy C\u00e1c service c\u00f3 DB schema \u2705 Tu\u00e2n th\u1ee7 3 b\u01b0\u1edbc: prepare, transition, cleanup ADR-024: Data Anonymization &amp; Retention D\u1ecbch v\u1ee5 x\u1eed l\u00fd PII \u2705 TTL per table; masking log; anonymize sandbox data ADR-025: Multi-Tenant Versioning Core &amp; tenant stack \u2705 Cho ph\u00e9p m\u1ed7i tenant ch\u1ecdn version ri\u00eang; h\u1ed7 tr\u1ee3 rollout l\u1ec7ch phi\u00ean b\u1ea3n ADR-026: Hard Delete Policy T\u1ea5t c\u1ea3 service c\u00f3 d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m \u2705 X\u00e1c \u0111\u1ecbnh ti\u00eau ch\u00ed kh\u00f4ng \u0111\u01b0\u1ee3c xo\u00e1 v\u1eadt l\u00fd; s\u1eed d\u1ee5ng soft delete v\u00e0 audit ADR-027: Data Management Strategy To\u00e0n h\u1ec7 th\u1ed1ng \u2705 Chu\u1ea9n ho\u00e1 ph\u00e2n lo\u1ea1i d\u1eef li\u1ec7u, retention, purge, schema, access, b\u1ea3o m\u1eadt ADR-028: Reporting Service Design Reporting Service \u2705 T\u00e1ch backend chuy\u00ean bi\u1ec7t cho b\u00e1o c\u00e1o; s\u1eed d\u1ee5ng Data Warehouse v\u00e0 RBAC theo template ADR-029: Report Template Schema Reporting Service + Superadmin Webapp \u2705 Chu\u1ea9n h\u00f3a c\u1ea5u tr\u00fac report_template; h\u1ed7 tr\u1ee3 input validation, versioning, metadata RBAC ADR-030: Event Schema Governance T\u1ea5t c\u1ea3 services ph\u00e1t s\u1ef1 ki\u1ec7n (User, Auth, Notification, Adapters) \u2705 Chu\u1ea9n h\u00f3a schema s\u1ef1 ki\u1ec7n, versioned, l\u01b0u t\u1ea1i event registry; h\u1ed7 tr\u1ee3 backward compatibility <p>\ud83d\udd0e G\u1ee3i \u00fd s\u1eed d\u1ee5ng: N\u1ebfu b\u1ea1n tri\u1ec3n khai service m\u1edbi, h\u00e3y r\u00e0 so\u00e1t b\u1ea3ng n\u00e0y \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o service tu\u00e2n th\u1ee7 \u0111\u1ea7y \u0111\u1ee7 c\u00e1c ADR t\u01b0\u01a1ng \u1ee9ng v\u00e0 ghi r\u00f5 m\u1ecdi \u0111i\u1ec3m tri\u1ec3n khai \u0111\u1eb7c bi\u1ec7t (n\u1ebfu c\u00f3) trong Interface Contract.</p>"},{"location":"ADR/adr-001-ci-cd/","title":"ADR-001 - Chi\u1ebfn l\u01b0\u1ee3c CI/CD chung cho to\u00e0n h\u1ec7 th\u1ed1ng dx-vas","text":"","tags":["ci","cd","github-actions","cloud-run","dx-vas"]},{"location":"ADR/adr-001-ci-cd/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>D\u1ef1 \u00e1n Chuy\u1ec3n \u0111\u1ed5i s\u1ed1 VAS (dx-vas) bao g\u1ed3m nhi\u1ec1u th\u00e0nh ph\u1ea7n: - API Gateway - C\u00e1c backend service t\u00edch h\u1ee3p (CRM Adapter, SIS Adapter, Notification Service, LMS Proxy...) - Frontend (Admin Webapp, Customer Portal)</p> <p>C\u00e1c th\u00e0nh ph\u1ea7n n\u00e0y \u0111\u1ec1u \u0111\u01b0\u1ee3c tri\u1ec3n khai tr\u00ean n\u1ec1n t\u1ea3ng Google Cloud Run, y\u00eau c\u1ea7u CI/CD: - T\u1ef1 \u0111\u1ed9ng build, test, scan b\u1ea3o m\u1eadt tr\u01b0\u1edbc khi deploy - Ph\u00e2n bi\u1ec7t r\u00f5 m\u00f4i tr\u01b0\u1eddng <code>dev</code>, <code>staging</code>, <code>production</code> - H\u1ea1n ch\u1ebf l\u1ed7i th\u1ee7 c\u00f4ng khi deploy th\u1ee7 c\u00f4ng ho\u1eb7c thi\u1ebfu test</p>","tags":["ci","cd","github-actions","cloud-run","dx-vas"]},{"location":"ADR/adr-001-ci-cd/#quyet-inh","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh","text":"<p>\u00c1p d\u1ee5ng chi\u1ebfn l\u01b0\u1ee3c CI/CD t\u1eadp trung s\u1eed d\u1ee5ng GitHub Actions, deploy c\u00e1c service dx-vas l\u00ean Cloud Run, ph\u00e2n t\u00e1ch branch theo m\u00f4i tr\u01b0\u1eddng v\u00e0 enforce ki\u1ec3m tra b\u1ea3o m\u1eadt/t\u00e0i li\u1ec7u tr\u01b0\u1edbc khi release.</p>","tags":["ci","cd","github-actions","cloud-run","dx-vas"]},{"location":"ADR/adr-001-ci-cd/#chi-tiet-thiet-ke","title":"\ud83d\udee0 Chi ti\u1ebft thi\u1ebft k\u1ebf","text":"","tags":["ci","cd","github-actions","cloud-run","dx-vas"]},{"location":"ADR/adr-001-ci-cd/#1-branching-strategy","title":"1. Branching Strategy","text":"Branch M\u00f4i tr\u01b0\u1eddng Deploy t\u1ef1 \u0111\u1ed9ng <code>dev</code> Staging \u2705 C\u00f3 <code>main</code> Production \u2705 C\u00f3 (sau approval) <code>feature/*</code> Dev local/test \u274c Kh\u00f4ng","tags":["ci","cd","github-actions","cloud-run","dx-vas"]},{"location":"ADR/adr-001-ci-cd/#2-workflow-cicd-chuan","title":"2. Workflow CI/CD chu\u1ea9n","text":"<pre><code>on:\n  push:\n    branches: [dev, main]\n\njobs:\n  ci:\n    steps:\n      - Checkout, setup Python/NodeJS\n      - C\u00e0i \u0111\u1eb7t ph\u1ee5 thu\u1ed9c:\n        - N\u1ebfu d\u00f9ng `requirements.txt`: `pip install -r requirements.txt`\n        - N\u1ebfu d\u00f9ng Poetry: `poetry install`\n        - N\u1ebfu d\u00f9ng Pipenv: `pipenv install --dev`\n      - Ch\u1ea1y lint: `black`, `flake8`, `eslint`, `prettier`\n      - Ch\u1ea1y test + coverage: `pytest`, `jest`\n      - Ch\u1ea1y scan b\u1ea3o m\u1eadt: `bandit`, `safety`, `trivy`\n\n  cd:\n    needs: ci\n    steps:\n      - Build Docker image, tag theo `env`, `git_sha`\n      - Deploy Cloud Run b\u1eb1ng `gcloud deploy` ho\u1eb7c `google-github-actions`\n      - \u0110\u1eb7t `min-instances`, `concurrency`, `env var`, secret (qua Secret Manager)\n</code></pre>","tags":["ci","cd","github-actions","cloud-run","dx-vas"]},{"location":"ADR/adr-001-ci-cd/#3-secrets","title":"3. Secrets","text":"Lo\u1ea1i L\u01b0u \u1edf \u0111\u00e2u CI/CD secrets GitHub Secrets Runtime secrets Google Secret Manager","tags":["ci","cd","github-actions","cloud-run","dx-vas"]},{"location":"ADR/adr-001-ci-cd/#4-rule-bat-buoc","title":"4. Rule b\u1eaft bu\u1ed9c","text":"<ul> <li>\u2705 Pull Request ph\u1ea3i \u0111\u01b0\u1ee3c review</li> <li>\u2705 Ch\u1ea1y CI t\u1ef1 \u0111\u1ed9ng tr\u01b0\u1edbc merge</li> <li>\u2705 L\u1ed7i lint/test/security \u0111\u1ec1u ch\u1eb7n merge</li> <li>\u2705 Production deploy c\u1ea7n manual approval ho\u1eb7c protected branch</li> <li>\u2705 M\u1ecdi thay \u0111\u1ed5i h\u1ea1 t\u1ea7ng (Terraform) ph\u1ea3i ch\u1ea1y <code>terraform plan</code> qua CI v\u00e0 \u0111\u01b0\u1ee3c review tr\u01b0\u1edbc khi <code>apply</code></li> </ul>","tags":["ci","cd","github-actions","cloud-run","dx-vas"]},{"location":"ADR/adr-001-ci-cd/#5-template-thu-muc-ci-trong-moi-repo","title":"5. Template th\u01b0 m\u1ee5c CI trong m\u1ed7i repo","text":"<pre><code>.github/workflows/\n  ci.yml\n  deploy.yml\n  lint.yml (optional)\n</code></pre>","tags":["ci","cd","github-actions","cloud-run","dx-vas"]},{"location":"ADR/adr-001-ci-cd/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>T\u1ef1 \u0111\u1ed9ng ho\u00e1 quy tr\u00ecnh build/deploy to\u00e0n h\u1ec7 th\u1ed1ng</li> <li>Ph\u00e1t hi\u1ec7n l\u1ed7i s\u1edbm ngay khi commit</li> <li>Th\u1ed1ng nh\u1ea5t convention gi\u1eefa c\u00e1c team backend/frontend</li> <li>Gi\u1ea3m r\u1ee7i ro b\u1ea3o m\u1eadt v\u00e0 l\u1ed7i tri\u1ec3n khai production</li> </ul>","tags":["ci","cd","github-actions","cloud-run","dx-vas"]},{"location":"ADR/adr-001-ci-cd/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p Qu\u00ean ch\u1ea1y test tr\u01b0\u1edbc khi merge CI t\u1ef1 \u0111\u1ed9ng enforce L\u1ed9 secrets qua log B\u1eadt masking, kh\u00f4ng echo gi\u00e1 tr\u1ecb nh\u1ea1y c\u1ea3m Deploy nh\u1ea7m m\u00f4i tr\u01b0\u1eddng T\u00e1ch r\u00f5 <code>dev</code>, <code>main</code>, y\u00eau c\u1ea7u approval cho <code>main</code>","tags":["ci","cd","github-actions","cloud-run","dx-vas"]},{"location":"ADR/adr-001-ci-cd/#cac-lua-chon-a-loai-bo","title":"\ud83d\udd04 C\u00e1c l\u1ef1a ch\u1ecdn \u0111\u00e3 lo\u1ea1i b\u1ecf","text":"<ul> <li>Deploy th\u1ee7 c\u00f4ng: d\u1ec5 sai, kh\u00f4ng rollback</li> <li>Jenkins/GitLab CI: kh\u00f4ng \u0111\u1ed3ng b\u1ed9 v\u1edbi GitHub codebase</li> </ul>","tags":["ci","cd","github-actions","cloud-run","dx-vas"]},{"location":"ADR/adr-001-ci-cd/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Terraform module: <code>infra/modules/cloud_run_service</code></li> <li>IaC Terraform Strategy: ADR-002</li> </ul> <p>\"M\u1ed7i l\u1ea7n commit l\u00e0 m\u1ed9t l\u1eddi h\u1ee9a \u2013 CI/CD gi\u00fap \u0111\u1ea3m b\u1ea3o l\u1eddi h\u1ee9a \u0111\u00f3 \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n.\"</p>","tags":["ci","cd","github-actions","cloud-run","dx-vas"]},{"location":"ADR/adr-002-iac/","title":"ADR-002 - Chi\u1ebfn l\u01b0\u1ee3c H\u1ea1 t\u1ea7ng d\u01b0\u1edbi d\u1ea1ng M\u00e3 ngu\u1ed3n (Infrastructure as Code) cho h\u1ec7 th\u1ed1ng dx-vas","text":"","tags":["iac","terraform","infrastructure","dx-vas"]},{"location":"ADR/adr-002-iac/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas bao g\u1ed3m nhi\u1ec1u th\u00e0nh ph\u1ea7n tri\u1ec3n khai tr\u00ean Google Cloud Platform (GCP):</p> <ul> <li>API Gateway</li> <li>Backend service (LMS Adapter, CRM Adapter, Notification Service)</li> <li>Frontend (Admin Webapp, Customer Portal)</li> <li>Database, Redis, Secret Manager, IAM, Monitoring</li> </ul> <p>Vi\u1ec7c tri\u1ec3n khai v\u00e0 c\u1ea5u h\u00ecnh c\u00e1c t\u00e0i nguy\u00ean h\u1ea1 t\u1ea7ng c\u1ea7n \u0111\u01b0\u1ee3c:</p> <ul> <li>T\u00e1i s\u1eed d\u1ee5ng v\u00e0 l\u1eb7p l\u1ea1i \u0111\u01b0\u1ee3c (reproducible)</li> <li>Theo d\u00f5i thay \u0111\u1ed5i qua Git (version control)</li> <li>T\u1ef1 \u0111\u1ed9ng h\u00f3a, ki\u1ec3m th\u1eed \u0111\u01b0\u1ee3c trong CI/CD</li> <li>Chia t\u00e1ch theo m\u00f4i tr\u01b0\u1eddng (<code>dev</code>, <code>staging</code>, <code>production</code>, <code>sandbox</code>)</li> </ul>","tags":["iac","terraform","infrastructure","dx-vas"]},{"location":"ADR/adr-002-iac/#quyet-inh","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh","text":"<p>\u00c1p d\u1ee5ng Terraform l\u00e0m c\u00f4ng c\u1ee5 ch\u00ednh qu\u1ea3n l\u00fd h\u1ea1 t\u1ea7ng dx-vas, v\u1edbi m\u00f4 h\u00ecnh t\u00e1ch module + m\u00f4i tr\u01b0\u1eddng, s\u1eed d\u1ee5ng th\u01b0 m\u1ee5c <code>envs/</code> \u0111\u1ec3 ch\u1ee9a c\u1ea5u h\u00ecnh theo m\u00f4i tr\u01b0\u1eddng, v\u00e0 CI pipeline ki\u1ec3m so\u00e1t apply, state v\u00e0 secrets an to\u00e0n.</p>","tags":["iac","terraform","infrastructure","dx-vas"]},{"location":"ADR/adr-002-iac/#cau-truc-e-xuat","title":"\ud83e\uddf1 C\u1ea5u tr\u00fac \u0111\u1ec1 xu\u1ea5t","text":"<pre><code>dx-vas/infrastructure/\n\u251c\u2500\u2500 modules/\n\u2502   \u251c\u2500\u2500 cloud_run_service/\n\u2502   \u251c\u2500\u2500 cloud_sql_instance/\n\u2502   \u251c\u2500\u2500 redis_instance/\n\u2502   \u251c\u2500\u2500 iam_roles/\n\u2502   \u251c\u2500\u2500 monitoring/\n\u2502   \u2514\u2500\u2500 storage/\n\u2502\n\u251c\u2500\u2500 envs/\n\u2502   \u251c\u2500\u2500 dev/\n\u2502   \u251c\u2500\u2500 staging/\n\u2502   \u251c\u2500\u2500 production/\n\u2502   \u2514\u2500\u2500 sandbox/\n\u2502\n\u251c\u2500\u2500 shared/\n\u2502   \u251c\u2500\u2500 dx-vas-network/\n\u2502   \u2502   \u251c\u2500\u2500 main.tf           # Shared VPC, subnet, firewall, NAT\n\u2502   \u2502   \u251c\u2500\u2500 variables.tf\n\u2502   \u2502   \u2514\u2500\u2500 outputs.tf\n\u2502   \u251c\u2500\u2500 dx-vas-logging/\n\u2502   \u2502   \u251c\u2500\u2500 main.tf           # Logging sinks, audit config, BigQuery export\n\u2502   \u2502   \u251c\u2500\u2500 variables.tf\n\u2502   \u2502   \u2514\u2500\u2500 outputs.tf\n\u2502   \u251c\u2500\u2500 dx-vas-data/\n\u2502   \u2502   \u251c\u2500\u2500 main.tf           # Redis, Cloud SQL, BigQuery dataset\n\u2502   \u2502   \u251c\u2500\u2500 variables.tf\n\u2502   \u2502   \u2514\u2500\u2500 outputs.tf\n\u2502   \u251c\u2500\u2500 dns.tf                # DNS zones chung\n\u2502   \u2514\u2500\u2500 README.md\n\u2502\n\u251c\u2500\u2500 backend.tf     # c\u1ea5u h\u00ecnh state backend\n\u2514\u2500\u2500 README.md\n</code></pre> <p>\ud83d\udd01 M\u1ed7i th\u01b0 m\u1ee5c trong <code>envs/</code> g\u1ed3m <code>main.tf</code>, <code>variables.tf</code>, <code>outputs.tf</code>, v\u00e0 <code>*.tfvars</code>. Th\u01b0 m\u1ee5c <code>shared/</code> qu\u1ea3n l\u00fd h\u1ea1 t\u1ea7ng chia s\u1ebb \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng b\u1edfi nhi\u1ec1u m\u00f4i tr\u01b0\u1eddng ho\u1eb7c service, nh\u1ea5t qu\u00e1n v\u1edbi ADR-019.</p>","tags":["iac","terraform","infrastructure","dx-vas"]},{"location":"ADR/adr-002-iac/#nguyen-tac-su-dung","title":"\u2699\ufe0f Nguy\u00ean t\u1eafc s\u1eed d\u1ee5ng","text":"<ul> <li>T\u00e1ch module d\u00f9ng chung: c\u00e1c service ch\u1ec9 c\u1ea7n g\u1ecdi l\u1ea1i module v\u1edbi bi\u1ebfn ri\u00eang</li> <li>State file l\u01b0u GCS bucket (per env), c\u00f3 versioning v\u00e0 encryption</li> <li>Secrets kh\u00f4ng hard-code, \u0111\u01b0\u1ee3c inject qua CI/CD ho\u1eb7c GCP Secret Manager</li> <li>Terraform workspace \u0111\u01b0\u1ee3c d\u00f9ng th\u00eam n\u1ebfu m\u00f4i tr\u01b0\u1eddng c\u00f3 nhi\u1ec1u bi\u1ebfn t\u1ea1m</li> </ul>","tags":["iac","terraform","infrastructure","dx-vas"]},{"location":"ADR/adr-002-iac/#quan-ly-secrets","title":"\ud83d\udd10 Qu\u1ea3n l\u00fd secrets","text":"Lo\u1ea1i secret L\u01b0u \u1edf \u0111\u00e2u Truy c\u1eadp t\u1eeb Runtime token, DB URL GCP Secret Manager Cloud Run Service CI/CD secret GitHub Secrets Terraform apply CI","tags":["iac","terraform","infrastructure","dx-vas"]},{"location":"ADR/adr-002-iac/#quy-trinh-cicd","title":"\ud83d\udd04 Quy tr\u00ecnh CI/CD","text":"<ul> <li>Ch\u1ea1y <code>terraform validate</code>, <code>plan</code> \u2192 t\u1ea1o PR</li> <li>Artifact <code>.tfplan</code> \u0111\u01b0\u1ee3c l\u01b0u \u0111\u1ec3 review</li> <li><code>apply</code> t\u1ef1 \u0111\u1ed9ng cho <code>dev</code>, c\u1ea7n approval v\u1edbi <code>production</code></li> <li>Lint Terraform v\u1edbi <code>tflint</code>, ki\u1ec3m tra drift v\u1edbi <code>infracost</code>, <code>terraform-docs</code></li> </ul>","tags":["iac","terraform","infrastructure","dx-vas"]},{"location":"ADR/adr-002-iac/#chinh-sach-an-toan","title":"\ud83d\udccc Ch\u00ednh s\u00e1ch an to\u00e0n","text":"<ul> <li>\u2705 M\u1ecdi thay \u0111\u1ed5i h\u1ea1 t\u1ea7ng ph\u1ea3i \u0111\u01b0\u1ee3c review qua Pull Request</li> <li>\u2705 Kh\u00f4ng deploy th\u1eb3ng t\u1eeb m\u00e1y local l\u00ean production</li> <li>\u2705 C\u00f3 policy check v\u00e0 scan drift tr\u01b0\u1edbc apply (s\u1eed d\u1ee5ng <code>OPA</code> ho\u1eb7c <code>checkov</code> n\u1ebfu c\u1ea7n)</li> <li>\u2705 CI s\u1ebd b\u00e1o l\u1ed7i n\u1ebfu thi\u1ebfu tag/label quan tr\u1ecdng (<code>env</code>, <code>owner</code>, <code>component</code>...)</li> </ul>","tags":["iac","terraform","infrastructure","dx-vas"]},{"location":"ADR/adr-002-iac/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>T\u00e1i s\u1eed d\u1ee5ng \u0111\u01b0\u1ee3c h\u1ea1 t\u1ea7ng cho nhi\u1ec1u service</li> <li>Qu\u1ea3n l\u00fd r\u00f5 r\u00e0ng theo m\u00f4i tr\u01b0\u1eddng (c\u1ea5u h\u00ecnh, chi ph\u00ed, bi\u1ebfn runtime)</li> <li>Ki\u1ec3m so\u00e1t, rollback, v\u00e0 ki\u1ec3m to\u00e1n h\u1ea1 t\u1ea7ng nh\u01b0 code</li> <li>K\u1ebft n\u1ed1i CI/CD an to\u00e0n, tr\u00e1nh deploy sai c\u1ea5u h\u00ecnh</li> </ul>","tags":["iac","terraform","infrastructure","dx-vas"]},{"location":"ADR/adr-002-iac/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p Qu\u00ean c\u1eadp nh\u1eadt <code>tfvars</code> cho m\u00f4i tr\u01b0\u1eddng m\u1edbi C\u00f3 template <code>.example.tfvars</code> v\u00e0 validate trong CI State b\u1ecb kho\u00e1 ho\u1eb7c m\u1ea5t \u0111\u1ed3ng b\u1ed9 Enable state lock, versioning trong GCS Drift do ch\u1ec9nh tay trong Console <code>terraform plan</code> + check drift + policy check CI","tags":["iac","terraform","infrastructure","dx-vas"]},{"location":"ADR/adr-002-iac/#phuong-an-khac-a-loai-bo","title":"\ud83d\udd04 Ph\u01b0\u01a1ng \u00e1n kh\u00e1c \u0111\u00e3 lo\u1ea1i b\u1ecf","text":"Ph\u01b0\u01a1ng \u00e1n L\u00fd do kh\u00f4ng ch\u1ecdn GCP Console th\u1ee7 c\u00f4ng Kh\u00f4ng version control, d\u1ec5 sai l\u1ec7ch gi\u1eefa env Deployment Manager \u00cdt ph\u1ed5 bi\u1ebfn, h\u1ea1n ch\u1ebf c\u1ed9ng \u0111\u1ed3ng v\u00e0 t\u00e0i li\u1ec7u Pulumi M\u1ea1nh nh\u01b0ng y\u00eau c\u1ea7u h\u1ecdc SDK + kh\u00f4ng \u0111\u1ed3ng nh\u1ea5t trong team","tags":["iac","terraform","infrastructure","dx-vas"]},{"location":"ADR/adr-002-iac/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>CI/CD Strategy: ADR-001</li> <li>Secret Management: ADR-003</li> <li>Project Layout: ADR-019</li> </ul> <p>\u201cIaC kh\u00f4ng ch\u1ec9 l\u00e0 c\u00e1ch vi\u1ebft h\u1ea1 t\u1ea7ng \u2013 n\u00f3 l\u00e0 c\u00e1ch l\u00e0m ch\u1ee7 s\u1ef1 ph\u00e1t tri\u1ec3n c\u1ee7a to\u00e0n b\u1ed9 h\u1ec7 th\u1ed1ng.\u201d</p>","tags":["iac","terraform","infrastructure","dx-vas"]},{"location":"ADR/adr-003-secrets/","title":"ADR-003: Ch\u00ednh s\u00e1ch qu\u1ea3n l\u00fd Secrets","text":"","tags":["secrets","security","secret-rotation","dx-vas"]},{"location":"ADR/adr-003-secrets/#boi-canh","title":"B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas bao g\u1ed3m nhi\u1ec1u service (Auth, User, Notification\u2026) v\u00e0 nhi\u1ec1u tenant (tr\u01b0\u1eddng th\u00e0nh vi\u00ean), m\u1ed7i tenant c\u00f3 th\u1ec3 s\u1eed d\u1ee5ng c\u00e1c k\u00eanh g\u1eedi th\u00f4ng b\u00e1o ri\u00eang bi\u1ec7t nh\u01b0 Zalo OA, Gmail API, SMS Provider, v.v.</p> <p>T\u1ea5t c\u1ea3 c\u00e1c secret nh\u1ea1y c\u1ea3m nh\u01b0 token, API key, m\u1eadt kh\u1ea9u CSDL... c\u1ea7n \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd t\u1eadp trung, c\u00f3 kh\u1ea3 n\u0103ng rotate, audit truy c\u1eadp, v\u00e0 ph\u00e2n quy\u1ec1n theo nguy\u00ean t\u1eafc t\u1ed1i thi\u1ec3u.</p>","tags":["secrets","security","secret-rotation","dx-vas"]},{"location":"ADR/adr-003-secrets/#quyet-inh","title":"Quy\u1ebft \u0111\u1ecbnh","text":"","tags":["secrets","security","secret-rotation","dx-vas"]},{"location":"ADR/adr-003-secrets/#1-su-dung-google-cloud-secret-manager","title":"1. S\u1eed d\u1ee5ng Google Cloud Secret Manager","text":"<ul> <li>T\u1ea5t c\u1ea3 secrets \u0111\u1ec1u \u0111\u01b0\u1ee3c l\u01b0u tr\u1eef t\u1ea1i Google Cloud Secret Manager (GCSM)</li> <li>M\u1ed7i secret c\u00f3 th\u1ec3 c\u00f3 nhi\u1ec1u phi\u00ean b\u1ea3n (<code>versions</code>)</li> <li>Vi\u1ec7c truy xu\u1ea5t ph\u1ea3i th\u00f4ng qua identity c\u1ee7a Cloud Run / Cloud Function ho\u1eb7c workload identity</li> </ul>","tags":["secrets","security","secret-rotation","dx-vas"]},{"location":"ADR/adr-003-secrets/#2-moi-tenant-co-secrets-rieng-biet-neu-dung","title":"2. M\u1ed7i tenant c\u00f3 secrets ri\u00eang bi\u1ec7t (n\u1ebfu d\u00f9ng)","text":"<ul> <li>Tenant c\u00f3 th\u1ec3 c\u1ea5u h\u00ecnh Zalo OA ri\u00eang, Gmail API key ri\u00eang ho\u1eb7c c\u00e1c webhook/token t\u00f9y theo nhu c\u1ea7u</li> <li>Nh\u1eefng secret n\u00e0y s\u1ebd \u0111\u01b0\u1ee3c l\u01b0u theo \u0111\u1ecbnh danh:</li> </ul> <pre><code>projects/dx-vas-tenant-abc/secrets/zalo-oa-token\nprojects/dx-vas-tenant-xyz/secrets/gmail-api-key\n</code></pre> <ul> <li>Sub Notification Service s\u1ebd truy xu\u1ea5t secrets t\u01b0\u01a1ng \u1ee9ng theo tenant_id</li> <li>Vi\u1ec7c rotate, ph\u00e2n quy\u1ec1n v\u00e0 revoke secret \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n theo t\u1eebng tenant</li> </ul>","tags":["secrets","security","secret-rotation","dx-vas"]},{"location":"ADR/adr-003-secrets/#3-phan-quyen-truy-cap-secrets","title":"3. Ph\u00e2n quy\u1ec1n truy c\u1eadp secrets","text":"<ul> <li>M\u1ed7i service ch\u1ec9 c\u00f3 quy\u1ec1n truy xu\u1ea5t secrets c\u1ea7n thi\u1ebft theo nguy\u00ean t\u1eafc least privilege</li> <li> <p>V\u00ed d\u1ee5:</p> </li> <li> <p><code>auth-service-master</code> c\u00f3 quy\u1ec1n \u0111\u1ecdc secret <code>jwt-signing-key</code></p> </li> <li><code>notification-service-xyz</code> c\u00f3 quy\u1ec1n \u0111\u1ecdc <code>zalo-oa-token</code> trong project <code>dx-vas-tenant-xyz</code></li> <li>Superadmin Webapp c\u00f3 c\u00f4ng c\u1ee5 xem v\u00e0 c\u1eadp nh\u1eadt secret c\u1ea5u h\u00ecnh theo tenant (ghi log audit)</li> </ul>","tags":["secrets","security","secret-rotation","dx-vas"]},{"location":"ADR/adr-003-secrets/#4-rotate-va-revoke-secret","title":"4. Rotate v\u00e0 revoke secret","text":"<ul> <li>M\u1ed7i secret n\u00ean c\u00f3 TTL \u0111\u1ecbnh k\u1ef3 (VD: 90 ng\u00e0y)</li> <li>C\u00f4ng c\u1ee5 qu\u1ea3n tr\u1ecb c\u00f3 th\u1ec3 trigger rotate \u2192 t\u1ea1o version m\u1edbi, update config v\u00e0 revoke version c\u0169</li> <li>Notification Service c\u1ea7n h\u1ed7 tr\u1ee3 reload token t\u1eeb Secret Manager m\u00e0 kh\u00f4ng c\u1ea7n restart service</li> </ul>","tags":["secrets","security","secret-rotation","dx-vas"]},{"location":"ADR/adr-003-secrets/#he-qua","title":"H\u1ec7 qu\u1ea3","text":"<p>\u2705 \u01afu \u0111i\u1ec3m:</p> <ul> <li>Secrets \u0111\u01b0\u1ee3c t\u00e1ch bi\u1ec7t r\u00f5 r\u00e0ng theo m\u00f4i tr\u01b0\u1eddng, theo tenant</li> <li>H\u1ed7 tr\u1ee3 nhi\u1ec1u c\u1ea5u h\u00ecnh linh ho\u1ea1t: m\u1ed7i tr\u01b0\u1eddng c\u00f3 th\u1ec3 d\u00f9ng k\u00eanh g\u1eedi ri\u00eang</li> <li>C\u00f3 th\u1ec3 rotate m\u00e0 kh\u00f4ng gi\u00e1n \u0111o\u1ea1n d\u1ecbch v\u1ee5</li> <li>D\u1ec5 audit truy c\u1eadp theo t\u1eebng tenant</li> </ul> <p>\u26a0\ufe0f L\u01b0u \u00fd:</p> <ul> <li>C\u1ea7n c\u00f4ng c\u1ee5 ho\u1eb7c script h\u1ed7 tr\u1ee3 c\u1eadp nh\u1eadt secret cho t\u1eebng tenant</li> <li>Tenant ph\u1ea3i ch\u1ecbu tr\u00e1ch nhi\u1ec7m cung c\u1ea5p v\u00e0 qu\u1ea3n l\u00fd token ri\u00eang n\u1ebfu kh\u00f4ng d\u00f9ng m\u1eb7c \u0111\u1ecbnh h\u1ec7 th\u1ed1ng</li> </ul>","tags":["secrets","security","secret-rotation","dx-vas"]},{"location":"ADR/adr-003-secrets/#lien-ket-lien-quan","title":"Li\u00ean k\u1ebft li\u00ean quan","text":"<ul> <li><code>adr-008-audit-logging.md</code></li> <li><code>adr-015-deployment-strategy.md</code></li> <li><code>README.md#9-qu\u1ea3n-l\u00fd-b\u1ea3o-m\u1eadt--secrets</code></li> </ul> <p>\u201cKh\u00f4ng c\u00f3 secret n\u00e0o n\u00ean t\u1ed3n t\u1ea1i m\u00e3i m\u00e3i \u2013 rotate l\u00e0 c\u00e1ch b\u1ea1n b\u1ea3o v\u1ec7 h\u1ec7 th\u1ed1ng khi b\u1ea1n qu\u00ean r\u1eb1ng \u0111\u00e3 t\u1eebng \u0111\u1ec3 l\u1ed9 n\u00f3.\u201d</p>","tags":["secrets","security","secret-rotation","dx-vas"]},{"location":"ADR/adr-004-security/","title":"ADR-004: Ch\u00ednh s\u00e1ch B\u1ea3o m\u1eadt H\u1ec7 th\u1ed1ng (Security Policy)","text":"","tags":["security","hardening","dx-vas","cloud-run","jwt","rate-limiting"]},{"location":"ADR/adr-004-security/#boi-canh","title":"B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas cung c\u1ea5p d\u1ecbch v\u1ee5 cho nhi\u1ec1u tr\u01b0\u1eddng th\u00e0nh vi\u00ean kh\u00e1c nhau (multi-tenant), bao g\u1ed3m nhi\u1ec1u lo\u1ea1i ng\u01b0\u1eddi d\u00f9ng: h\u1ecdc sinh, gi\u00e1o vi\u00ean, nh\u00e2n vi\u00ean, ph\u1ee5 huynh, qu\u1ea3n tr\u1ecb vi\u00ean...</p> <p>B\u1ea3o m\u1eadt h\u1ec7 th\u1ed1ng kh\u00f4ng ch\u1ec9 bao g\u1ed3m x\u00e1c th\u1ef1c v\u00e0 ph\u00e2n quy\u1ec1n, m\u00e0 c\u00f2n \u0111\u1ea3m b\u1ea3o:</p> <ul> <li>M\u1ed7i tenant \u0111\u01b0\u1ee3c c\u00e1ch ly \u0111\u1ed9c l\u1eadp</li> <li>Kh\u00f4ng c\u00f3 r\u00f2 r\u1ec9 d\u1eef li\u1ec7u gi\u1eefa c\u00e1c tenant</li> <li>D\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m \u0111\u01b0\u1ee3c m\u00e3 h\u00f3a v\u00e0 gi\u00e1m s\u00e1t truy c\u1eadp</li> <li>JWT v\u00e0 Redis cache \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng an to\u00e0n</li> </ul>","tags":["security","hardening","dx-vas","cloud-run","jwt","rate-limiting"]},{"location":"ADR/adr-004-security/#quyet-inh","title":"Quy\u1ebft \u0111\u1ecbnh","text":"","tags":["security","hardening","dx-vas","cloud-run","jwt","rate-limiting"]},{"location":"ADR/adr-004-security/#1-xac-thuc","title":"1. X\u00e1c th\u1ef1c","text":"<ul> <li>S\u1eed d\u1ee5ng Google OAuth2 cho nh\u00e2n vi\u00ean &amp; gi\u00e1o vi\u00ean</li> <li>S\u1eed d\u1ee5ng OTP login (SMS/email) cho ph\u1ee5 huynh v\u00e0 h\u1ecdc sinh</li> <li>T\u1ea5t c\u1ea3 x\u00e1c th\u1ef1c \u0111\u1ec1u \u0111i qua Auth Master ho\u1eb7c Sub Auth Service (theo t\u1eebng tenant)</li> </ul>","tags":["security","hardening","dx-vas","cloud-run","jwt","rate-limiting"]},{"location":"ADR/adr-004-security/#2-phan-quyen-ong-rbac","title":"2. Ph\u00e2n quy\u1ec1n \u0111\u1ed9ng (RBAC)","text":"<ul> <li>JWT ch\u1ee9a <code>user_id</code>, <code>tenant_id</code>, <code>roles</code></li> <li>API Gateway s\u1ebd l\u1ea5y <code>permissions</code> t\u1eeb Redis cache (<code>rbac:{user_id}:{tenant_id}</code>)</li> <li>H\u1ec7 th\u1ed1ng \u0111\u00e1nh gi\u00e1 <code>condition</code> \u0111\u1ed9ng d\u1ef1a tr\u00ean context c\u1ee7a user/request</li> </ul>","tags":["security","hardening","dx-vas","cloud-run","jwt","rate-limiting"]},{"location":"ADR/adr-004-security/#3-cach-ly-tenant-tenant-isolation","title":"3. C\u00e1ch ly Tenant (Tenant Isolation)","text":"<p>H\u1ec7 th\u1ed1ng \u0111\u1ea3m b\u1ea3o c\u00e1ch ly tenant \u1edf nhi\u1ec1u c\u1ea5p \u0111\u1ed9:</p> L\u1edbp Chi ti\u1ebft H\u1ea1 t\u1ea7ng (GCP) M\u1ed7i tenant c\u00f3 GCP project ri\u00eang (<code>dx-vas-tenant-*</code>), kh\u00f4ng chia s\u1ebb Cloud Run, Cloud SQL, Secret M\u1ea1ng C\u00e1c service tenant ch\u1ec9 nh\u1eadn request t\u1eeb Gateway ho\u1eb7c IP danh s\u00e1ch cho ph\u00e9p D\u1eef li\u1ec7u M\u1ed7i tenant c\u00f3 th\u1ec3 c\u00f3 Cloud SQL instance ri\u00eang (trong project <code>dx-vas-tenant-*</code> ho\u1eb7c <code>dx-vas-data</code>). Tr\u01b0\u1eddng h\u1ee3p d\u00f9ng chung instance \u2192 ph\u1ea3i \u0111\u1ea3m b\u1ea3o c\u00e1ch ly b\u1eb1ng schema ri\u00eang, ho\u1eb7c \u00edt nh\u1ea5t c\u00e1c b\u1ea3ng c\u00f3 <code>tenant_id</code> r\u00f5 r\u00e0ng. JWT M\u1ed7i tenant s\u1eed d\u1ee5ng JWT ch\u1ee9a <code>tenant_id</code>, gi\u00fap Gateway x\u00e1c \u0111\u1ecbnh context ch\u00ednh x\u00e1c CI/CD Pipeline t\u00e1ch bi\u1ec7t, kh\u00f4ng c\u00f3 kh\u1ea3 n\u0103ng cross-deploy gi\u1eefa tenants","tags":["security","hardening","dx-vas","cloud-run","jwt","rate-limiting"]},{"location":"ADR/adr-004-security/#4-ranh-gioi-tin-cay-jwt-jwt-trust-boundary","title":"4. Ranh gi\u1edbi Tin c\u1eady JWT (JWT Trust Boundary)","text":"<p>\u0110\u1ec3 \u0111\u1ea3m b\u1ea3o an to\u00e0n trong x\u00e1c th\u1ef1c v\u00e0 ph\u00e2n quy\u1ec1n:</p> <ul> <li>T\u1ea5t c\u1ea3 JWT \u0111\u1ec1u ph\u1ea3i:</li> <li>C\u00f3 ch\u1eef k\u00fd v\u1edbi secret/key \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd b\u1edfi Gateway</li> <li>C\u00f3 <code>tenant_id</code> \u0111\u1ec3 x\u00e1c \u0111\u1ecbnh context ph\u00e2n quy\u1ec1n</li> <li>Gateway l\u00e0 n\u01a1i duy nh\u1ea5t tin c\u1eady \u0111\u1ec3 \u0111\u1ecdc &amp; ph\u00e2n t\u00edch JWT</li> <li>C\u00e1c service backend (Sub Service, Core Service) kh\u00f4ng \u0111\u01b0\u1ee3c x\u1eed l\u00fd tr\u1ef1c ti\u1ebfp RBAC n\u1ebfu kh\u00f4ng x\u00e1c minh JWT qua Gateway</li> <li>T\u1ea5t c\u1ea3 JWT \u0111\u1ec1u c\u00f3 TTL ng\u1eafn (d\u01b0\u1edbi 1 gi\u1edd), v\u00e0 c\u00f3 th\u1ec3 revoke n\u1ebfu c\u1ea7n</li> </ul> <p>N\u1ebfu c\u1ea7n x\u00e1c th\u1ef1c gi\u1eefa c\u00e1c service, ph\u1ea3i s\u1eed d\u1ee5ng <code>X-Internal-Call</code> ho\u1eb7c service token n\u1ed9i b\u1ed9 c\u00f3 ki\u1ec3m so\u00e1t</p>","tags":["security","hardening","dx-vas","cloud-run","jwt","rate-limiting"]},{"location":"ADR/adr-004-security/#he-qua","title":"H\u1ec7 qu\u1ea3","text":"<p>\u2705 \u01afu \u0111i\u1ec3m:</p> <ul> <li>\u0110\u1ea3m b\u1ea3o m\u1ed7i tenant \u0111\u01b0\u1ee3c c\u00e1ch ly tuy\u1ec7t \u0111\u1ed1i v\u1ec1 d\u1eef li\u1ec7u, m\u1ea1ng, quy\u1ec1n</li> <li>Ng\u0103n ch\u1eb7n t\u1ea5n c\u00f4ng ngang gi\u1eefa tenant</li> <li>Gi\u1ea3m thi\u1ec3u r\u1ee7i ro li\u00ean quan \u0111\u1ebfn token gi\u1ea3, cache sai context</li> <li>D\u1ec5 m\u1edf r\u1ed9ng m\u00f4 h\u00ecnh b\u1ea3o m\u1eadt theo t\u1eebng l\u1edbp (network, \u1ee9ng d\u1ee5ng, logic)</li> </ul> <p>\u26a0\ufe0f L\u01b0u \u00fd:</p> <ul> <li>Vi\u1ec7c revoke JWT t\u1ee9c th\u1eddi c\u1ea7n tri\u1ec3n khai th\u00eam token blacklist ho\u1eb7c short TTL</li> <li>Redis cache c\u1ea7n c\u00f3 namespace r\u00f5 r\u00e0ng theo <code>tenant_id</code>, v\u00ed d\u1ee5: <code>rbac:{user_id}:{tenant_id}</code> (xem chi ti\u1ebft trong <code>adr-007-rbac.md</code>)</li> </ul>","tags":["security","hardening","dx-vas","cloud-run","jwt","rate-limiting"]},{"location":"ADR/adr-004-security/#lien-ket-lien-quan","title":"Li\u00ean k\u1ebft li\u00ean quan","text":"<ul> <li><code>adr-006-auth-strategy.md</code></li> <li><code>adr-007-rbac.md</code></li> <li><code>adr-008-audit-logging.md</code></li> <li><code>rbac-deep-dive.md</code></li> </ul> <p>\u201cSecurity kh\u00f4ng ph\u1ea3i l\u00e0 m\u1ed9t module \u2013 m\u00e0 l\u00e0 mindset to\u00e0n h\u1ec7 th\u1ed1ng.\u201d</p>","tags":["security","hardening","dx-vas","cloud-run","jwt","rate-limiting"]},{"location":"ADR/adr-005-env-config/","title":"ADR-005 - Chi\u1ebfn l\u01b0\u1ee3c C\u1ea5u h\u00ecnh \u0111a m\u00f4i tr\u01b0\u1eddng (Environment Configuration) cho h\u1ec7 th\u1ed1ng dx-vas","text":"","tags":["configuration","environment","dotenv","ci-cd","secrets","dx-vas"]},{"location":"ADR/adr-005-env-config/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas v\u1eadn h\u00e0nh tr\u00ean nhi\u1ec1u m\u00f4i tr\u01b0\u1eddng:</p> <ul> <li><code>dev</code>: ph\u00e1t tri\u1ec3n t\u00ednh n\u0103ng, ki\u1ec3m th\u1eed local</li> <li><code>staging</code>: ki\u1ec3m th\u1eed t\u00edch h\u1ee3p, demo n\u1ed9i b\u1ed9</li> <li><code>production</code>: m\u00f4i tr\u01b0\u1eddng ch\u00ednh th\u1ee9c v\u1edbi ng\u01b0\u1eddi d\u00f9ng th\u1ef1c</li> <li><code>sandbox</code>: th\u1eed nghi\u1ec7m \u0111\u1ed9c l\u1eadp, testing API c\u00f4ng khai</li> </ul> <p>M\u1ed7i m\u00f4i tr\u01b0\u1eddng y\u00eau c\u1ea7u c\u1ea5u h\u00ecnh ri\u00eang bi\u1ec7t cho:</p> <ul> <li>Bi\u1ebfn m\u00f4i tr\u01b0\u1eddng: URL backend, CORS, log level, feature flag</li> <li>Secrets: DB password, API token, JWT key</li> <li>Qu\u1ea3n l\u00fd trong CI/CD v\u00e0 Terraform r\u00f5 r\u00e0ng</li> </ul>","tags":["configuration","environment","dotenv","ci-cd","secrets","dx-vas"]},{"location":"ADR/adr-005-env-config/#quyet-inh","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh","text":"<p>\u00c1p d\u1ee5ng chi\u1ebfn l\u01b0\u1ee3c c\u1ea5u h\u00ecnh theo m\u00f4i tr\u01b0\u1eddng s\u1eed d\u1ee5ng file <code>.env</code>, bi\u1ebfn h\u1ec7 th\u1ed1ng, v\u00e0 secrets t\u1eeb Secret Manager/GitHub Secrets, \u0111\u1ea3m b\u1ea3o t\u00e1ch bi\u1ec7t, d\u1ec5 ki\u1ec3m so\u00e1t v\u00e0 t\u1ef1 \u0111\u1ed9ng ho\u00e1.</p>","tags":["configuration","environment","dotenv","ci-cd","secrets","dx-vas"]},{"location":"ADR/adr-005-env-config/#cau-truc-e-xuat","title":"\ud83d\udcc1 C\u1ea5u tr\u00fac \u0111\u1ec1 xu\u1ea5t","text":"<p>Chi\u1ebfn l\u01b0\u1ee3c qu\u1ea3n l\u00fd file c\u1ea5u h\u00ecnh \u0111\u01b0\u1ee3c \u00e1p d\u1ee5ng cho t\u1eebng repository c\u1ee7a m\u1ed7i service/\u1ee9ng d\u1ee5ng con:</p> <p>Ph\u01b0\u01a1ng \u00e1n: S\u1eed d\u1ee5ng th\u01b0 m\u1ee5c con <code>config/</code> b\u00ean trong m\u1ed7i service (\u0111\u01b0\u1ee3c \u01b0u ti\u00ean \u0111\u1ec3 gi\u1eef th\u01b0 m\u1ee5c g\u1ed1c s\u1ea1ch s\u1ebd v\u00e0 d\u1ec5 m\u1edf r\u1ed9ng khi s\u1ed1 l\u01b0\u1ee3ng file c\u1ea5u h\u00ecnh t\u0103ng):</p> <pre><code># V\u00ed d\u1ee5, trong repo c\u1ee7a API Gateway (api_gateway/):\nconfig/\n  \u251c\u2500\u2500 base.env       # Bi\u1ebfn chung cho service (kh\u00f4ng nh\u1ea1y c\u1ea3m)\n  \u251c\u2500\u2500 dev.env        # Override cho dev (kh\u00f4ng commit n\u1ebfu ch\u1ee9a secret)\n  \u251c\u2500\u2500 staging.env    # Override cho staging (kh\u00f4ng commit n\u1ebfu ch\u1ee9a secret)\n  \u2514\u2500\u2500 production.env # Override cho production (kh\u00f4ng commit n\u1ebfu ch\u1ee9a secret)\n.env.example          # Template \u1edf g\u1ed1c\n</code></pre> <ul> <li><code>base.env</code>: ch\u1ee9a c\u00e1c bi\u1ebfn c\u1ea5u h\u00ecnh chung cho service \u0111\u00f3, kh\u00f4ng ph\u1ea3i to\u00e0n h\u1ec7 th\u1ed1ng dx-vas</li> <li>C\u00e1c file <code>.env.{ENVIRONMENT}</code> ho\u1eb7c <code>{environment}.env</code>: ch\u1ee9a c\u00e1c gi\u00e1 tr\u1ecb override c\u1ee5 th\u1ec3 cho t\u1eebng m\u00f4i tr\u01b0\u1eddng</li> <li>D\u00f9ng v\u1edbi <code>python-dotenv</code>, <code>pydantic-settings</code>, ho\u1eb7c <code>dotenv</code> c\u1ee7a NodeJS</li> <li>Kh\u00f4ng commit <code>.env</code> ch\u1ee9a secrets \u2013 s\u1eed d\u1ee5ng placeholder ho\u1eb7c <code>.example.env</code></li> </ul>","tags":["configuration","environment","dotenv","ci-cd","secrets","dx-vas"]},{"location":"ADR/adr-005-env-config/#bien-moi-truong-quan-trong","title":"\ud83d\udce6 Bi\u1ebfn m\u00f4i tr\u01b0\u1eddng quan tr\u1ecdng","text":"Bi\u1ebfn \u00dd ngh\u0129a <code>ENV</code> <code>dev</code>, <code>staging</code>, <code>production</code>, <code>sandbox</code> <code>BACKEND_URL_CRM</code> endpoint t\u00edch h\u1ee3p CRM <code>JWT_SECRET</code> key k\u00fd access token (inject t\u1eeb Secret Manager) <code>LOG_LEVEL</code> <code>debug</code> / <code>info</code> / <code>warning</code> <code>FEATURE_X_ENABLED</code> <code>true/false</code> \u2013 b\u1eadt feature theo env","tags":["configuration","environment","dotenv","ci-cd","secrets","dx-vas"]},{"location":"ADR/adr-005-env-config/#cach-nap-cau-hinh","title":"\ud83d\udd27 C\u00e1ch n\u1ea1p c\u1ea5u h\u00ecnh","text":"<p>Th\u1ee9 t\u1ef1 \u01b0u ti\u00ean khi load config:</p> <ol> <li>Bi\u1ebfn m\u00f4i tr\u01b0\u1eddng t\u1eeb h\u1ec7 th\u1ed1ng (<code>os.environ</code>) ho\u1eb7c CI/CD inject</li> <li>File <code>config/{ENV}.env</code> n\u1ebfu ch\u1ea1y local</li> <li>M\u1eb7c \u0111\u1ecbnh trong m\u00e3 ngu\u1ed3n (n\u1ebfu kh\u00f4ng ph\u1ea3i secret)</li> </ol> <p>Khi l\u1eadp tr\u00ecnh vi\u00ean ch\u1ea1y local t\u1eeb nh\u00e1nh <code>feature/*</code> ho\u1eb7c <code>dev</code>, c\u00f3 th\u1ec3 \u0111\u1eb7t <code>ENV=dev</code> \u0111\u1ec3 s\u1eed d\u1ee5ng c\u1ea5u h\u00ecnh trong <code>config/dev.env</code>. N\u1ebfu mu\u1ed1n m\u00f4 ph\u1ecfng g\u1ea7n v\u1edbi m\u00f4i tr\u01b0\u1eddng staging, c\u00f3 th\u1ec3 \u0111\u1eb7t <code>ENV=staging</code> \u0111\u1ec3 ki\u1ec3m th\u1eed v\u1edbi c\u1ea5u h\u00ecnh staging.</p> <p>Framework \u0111\u1ec1 xu\u1ea5t:</p> <ul> <li>Python: <code>pydantic.BaseSettings</code></li> <li>NodeJS: <code>dotenv</code> + <code>envsafe</code></li> <li>Frontend: Next.js d\u00f9ng <code>.env.local</code>, <code>.env.production</code></li> </ul>","tags":["configuration","environment","dotenv","ci-cd","secrets","dx-vas"]},{"location":"ADR/adr-005-env-config/#secrets-tach-biet-khoi-env","title":"\ud83d\udd10 Secrets t\u00e1ch bi\u1ec7t kh\u1ecfi <code>.env</code>","text":"<ul> <li> <p>Secrets nh\u1ea1y c\u1ea3m kh\u00f4ng l\u01b0u trong <code>.env</code> m\u00e0 \u0111\u01b0\u1ee3c mount t\u1eeb:</p> </li> <li> <p>GCP Secret Manager (runtime)</p> </li> <li>GitHub Secrets (CI/CD)</li> <li>Terraform <code>TF_VAR_</code> inject</li> </ul>","tags":["configuration","environment","dotenv","ci-cd","secrets","dx-vas"]},{"location":"ADR/adr-005-env-config/#trong-cicd","title":"\ud83d\udee0 Trong CI/CD","text":"<ul> <li> <p>CI x\u00e1c \u0111\u1ecbnh gi\u00e1 tr\u1ecb cho bi\u1ebfn <code>ENV</code> (\u0111\u1ec3 load \u0111\u00fang file c\u1ea5u h\u00ecnh) v\u00e0 m\u00f4i tr\u01b0\u1eddng tri\u1ec3n khai d\u1ef1a tr\u00ean nh\u00e1nh:</p> </li> <li> <p>Khi CI ch\u1ea1y tr\u00ean nh\u00e1nh <code>dev</code>:</p> <ul> <li>S\u1ebd deploy l\u00ean m\u00f4i tr\u01b0\u1eddng Staging.</li> <li>Bi\u1ebfn <code>ENV</code> \u0111\u01b0\u1ee3c thi\u1ebft l\u1eadp l\u00e0 <code>staging</code> \u0111\u1ec3 load <code>config/staging.env</code>.</li> <li> <p>Khi CI ch\u1ea1y tr\u00ean nh\u00e1nh <code>main</code>:</p> </li> <li> <p>S\u1ebd deploy l\u00ean m\u00f4i tr\u01b0\u1eddng Production (sau khi c\u00f3 ph\u00ea duy\u1ec7t).</p> </li> <li>Bi\u1ebfn <code>ENV</code> \u0111\u01b0\u1ee3c thi\u1ebft l\u1eadp l\u00e0 <code>production</code> \u0111\u1ec3 load <code>config/production.env</code>.</li> <li> <p>Khi ch\u1ea1y local tr\u00ean m\u00e1y l\u1eadp tr\u00ecnh vi\u00ean (v\u00ed d\u1ee5 t\u1eeb nh\u00e1nh <code>feature/*</code> ho\u1eb7c <code>dev</code>):</p> </li> <li> <p>Bi\u1ebfn <code>ENV</code> c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c \u0111\u1eb7t l\u00e0 <code>dev</code> \u0111\u1ec3 load <code>config/dev.env</code> ph\u1ee5c v\u1ee5 ph\u00e1t tri\u1ec3n v\u00e0 ki\u1ec3m th\u1eed c\u1ee5c b\u1ed9.</p> </li> </ul> </li> <li> <p>CI s\u1ebd inject c\u00e1c bi\u1ebfn c\u1ea5u h\u00ecnh v\u00e0o m\u00f4i tr\u01b0\u1eddng Cloud Run d\u1ef1a tr\u00ean gi\u00e1 tr\u1ecb <code>ENV</code>, \u01b0u ti\u00ean secrets t\u1eeb Secret Manager v\u00e0 c\u00e1c bi\u1ebfn m\u00f4i tr\u01b0\u1eddng t\u1eeb pipeline.</p> </li> </ul>","tags":["configuration","environment","dotenv","ci-cd","secrets","dx-vas"]},{"location":"ADR/adr-005-env-config/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>C\u1ea5u h\u00ecnh r\u00f5 r\u00e0ng theo m\u00f4i tr\u01b0\u1eddng</li> <li>D\u1ec5 debug v\u00e0 ch\u1ea1y local gi\u1ed1ng production</li> <li>Kh\u00f4ng r\u00f2 r\u1ec9 secrets nh\u1ea1y c\u1ea3m</li> <li>D\u1ec5 t\u00edch h\u1ee3p v\u00e0o Terraform v\u00e0 Cloud Run deployment</li> </ul>","tags":["configuration","environment","dotenv","ci-cd","secrets","dx-vas"]},{"location":"ADR/adr-005-env-config/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p Commit nh\u1ea7m file <code>.env</code> D\u00f9ng <code>.gitignore</code>, CI scan block file Thi\u1ebfu key c\u1ea5u h\u00ecnh g\u00e2y l\u1ed7i runtime Script validate schema + fallback m\u1eb7c \u0111\u1ecbnh an to\u00e0n Config b\u1ecb leak qua log CI Mask bi\u1ebfn m\u00f4i tr\u01b0\u1eddng ch\u1ee9a <code>SECRET</code>, <code>TOKEN</code>, <code>KEY</code>","tags":["configuration","environment","dotenv","ci-cd","secrets","dx-vas"]},{"location":"ADR/adr-005-env-config/#cac-phuong-an-a-loai-bo","title":"\ud83d\udd04 C\u00e1c ph\u01b0\u01a1ng \u00e1n \u0111\u00e3 lo\u1ea1i b\u1ecf","text":"Ph\u01b0\u01a1ng \u00e1n L\u00fd do kh\u00f4ng ch\u1ecdn Hardcode config trong code Kh\u00f3 thay \u0111\u1ed5i, kh\u00f4ng ph\u00f9 h\u1ee3p CI/CD D\u00f9ng chung <code>.env</code> m\u1ecdi m\u00f4i tr\u01b0\u1eddng D\u1ec5 ghi \u0111\u00e8 sai env, thi\u1ebfu t\u00e1ch bi\u1ec7t Config to\u00e0n b\u1ed9 qua Terraform Kh\u00f4ng ph\u00f9 h\u1ee3p frontend, kh\u00f3 debug local","tags":["configuration","environment","dotenv","ci-cd","secrets","dx-vas"]},{"location":"ADR/adr-005-env-config/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Secrets: ADR-003</li> <li>IaC Terraform Strategy: ADR-002</li> <li>CI/CD Strategy: ADR-001</li> </ul> <p>\u201cM\u1ed9t h\u1ec7 th\u1ed1ng ch\u1ea1y t\u1ed1t tr\u00ean production \u2013 l\u00e0 h\u1ec7 th\u1ed1ng c\u00f3 c\u1ea5u h\u00ecnh r\u00f5 r\u00e0ng t\u1eeb \u0111\u1ea7u.\u201d</p>","tags":["configuration","environment","dotenv","ci-cd","secrets","dx-vas"]},{"location":"ADR/adr-006-auth-strategy/","title":"ADR-006: Chi\u1ebfn l\u01b0\u1ee3c X\u00e1c th\u1ef1c (Auth Strategy)","text":"","tags":["auth","token","security","dx-vas","oauth2","otp","jwt"]},{"location":"ADR/adr-006-auth-strategy/#boi-canh-context","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh (Context)","text":"<p>H\u1ec7 th\u1ed1ng dx-vas ph\u1ee5c v\u1ee5 nhi\u1ec1u nh\u00f3m ng\u01b0\u1eddi d\u00f9ng:</p> <ul> <li>Nh\u00e2n vi\u00ean, gi\u00e1o vi\u00ean, h\u1ecdc sinh (m\u1ed9t s\u1ed1 tenant): \u0111\u0103ng nh\u1eadp Google Workspace (OAuth2).  </li> <li>Ph\u1ee5 huynh &amp; h\u1ecdc sinh (\u1edf c\u00e1c tr\u01b0\u1eddng ch\u01b0a d\u00f9ng Google): \u0111\u0103ng nh\u1eadp Local/OTP.  </li> <li>M\u1ed9t ng\u01b0\u1eddi d\u00f9ng c\u00f3 th\u1ec3 thu\u1ed9c nhi\u1ec1u tenant v\u1edbi vai tr\u00f2 kh\u00e1c nhau.</li> </ul> <p>Ban \u0111\u1ea7u, m\u1ed7i Auth Service (Master &amp; Sub) t\u1ef1 ph\u00e1t h\u00e0nh JWT. Change Request 03-cr-token-service \u0111\u00e3 ch\u1ec9 ra r\u1ee7i ro b\u1ea3o m\u1eadt, SPOF v\u00e0 kh\u00f3 audit khi logic t\u1ea1o token b\u1ecb ph\u00e2n t\u00e1n :contentReference[oaicite:0]{index=0}. Quy\u1ebft \u0111\u1ecbnh: T\u1eadp trung to\u00e0n b\u1ed9 v\u00f2ng \u0111\u1eddi token v\u00e0o TokenService \u2013 micro-service n\u1ec1n t\u1ea3ng k\u00fd JWT b\u1ea5t \u0111\u1ed1i x\u1ee9ng (RS256), h\u1ed7 tr\u1ee3 thu h\u1ed3i t\u1ee9c th\u1eddi v\u00e0 cung c\u1ea5p JWKS c\u00f4ng khai.</p>","tags":["auth","token","security","dx-vas","oauth2","otp","jwt"]},{"location":"ADR/adr-006-auth-strategy/#quyet-inh-decision","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh (Decision)","text":"","tags":["auth","token","security","dx-vas","oauth2","otp","jwt"]},{"location":"ADR/adr-006-auth-strategy/#1-kien-truc-xac-thuc-vong-oi-token","title":"1. Ki\u1ebfn tr\u00fac x\u00e1c th\u1ef1c &amp; v\u00f2ng \u0111\u1eddi token","text":"Th\u00e0nh ph\u1ea7n Vai tr\u00f2 ch\u00ednh Auth Service Master X\u00e1c th\u1ef1c Google OAuth2, ch\u1ecdn tenant, g\u1ecdi TokenService \u0111\u1ec3 issue / refresh token Sub Auth Service (per tenant) X\u00e1c th\u1ef1c Local/OTP, g\u1ecdi TokenService t\u01b0\u01a1ng t\u1ef1 TokenService \u201cNh\u00e0 m\u00e1y\u201d duy nh\u1ea5t ph\u00e1t h\u00e0nh, l\u00e0m m\u1edbi, thu h\u1ed3i, introspect JWT API Gateway X\u00e1c th\u1ef1c ch\u1eef k\u00fd RS256 offline b\u1eb1ng JWKS; ch\u1ec9 g\u1ecdi <code>POST /token/introspect</code> khi c\u1ea7n ki\u1ec3m tra revoked_tokens","tags":["auth","token","security","dx-vas","oauth2","otp","jwt"]},{"location":"ADR/adr-006-auth-strategy/#2-tang-xac-thuc-authentication-layers","title":"2. T\u1ea7ng x\u00e1c th\u1ef1c (Authentication Layers)","text":"Layer Lu\u1ed3ng x\u1eed l\u00fd Google OAuth2 User \u2192 Auth Master \u2192 Google \u2192 Auth Master \u2192 (User Service Master + Sub User) \u2192 TokenService Local/OTP User \u2192 Sub Auth Service \u2192 (User Service Master + Sub User) \u2192 TokenService <p>C\u00e1c b\u01b0\u1edbc g\u1ecdi User Service v\u00e0 API Gateway kh\u00f4ng \u0111\u1ed5i so v\u1edbi b\u1ea3n tr\u01b0\u1edbc :contentReference[oaicite:1]{index=1}; \u0111i\u1ec3m m\u1edbi l\u00e0 TokenService \u1edf cu\u1ed1i lu\u1ed3ng.</p>","tags":["auth","token","security","dx-vas","oauth2","otp","jwt"]},{"location":"ADR/adr-006-auth-strategy/#3-tokenservice-chi-tiet","title":"3. TokenService \u2013 chi ti\u1ebft","text":"<ul> <li>Endpoint chu\u1ea9n </li> <li><code>POST /token/issue</code> \u2013 ph\u00e1t access &amp; refresh token  </li> <li><code>POST /token/refresh</code> \u2013 l\u00e0m m\u1edbi access token  </li> <li><code>POST /token/revoke</code> \u2013 thu h\u1ed3i theo <code>jti</code> / <code>sid</code> </li> <li><code>POST /token/introspect</code> \u2013 ki\u1ec3m tra token (ch\u1ec9 d\u00f9ng khi c\u1ea7n)  </li> <li><code>GET /.well-known/jwks.json</code> \u2013 JWKS c\u00f4ng khai (c\u00f3 header <code>Cache-Control: public, max-age=600</code>)  </li> <li>K\u00fd b\u1ea5t \u0111\u1ed1i x\u1ee9ng RS256 \u2014 private key l\u01b0u Secret Manager; rotate t\u1ed1i \u0111a 90 ng\u00e0y/l\u1ea7n theo <code>ADR-003</code> :contentReference[oaicite:2]{index=2}.  </li> <li>Xu\u1ea5t s\u1ef1 ki\u1ec7n <code>token.issued</code> / <code>token.revoked</code> l\u00ean Pub/Sub cho Audit-Logging.</li> </ul>","tags":["auth","token","security","dx-vas","oauth2","otp","jwt"]},{"location":"ADR/adr-006-auth-strategy/#4-jwt-key-management","title":"4. JWT &amp; Key Management","text":"Claim M\u00f4 t\u1ea3 <code>sub</code> <code>user_id_global</code> <code>tid</code> <code>tenant_id</code> <code>roles</code> M\u1ea3ng <code>role_code</code> <code>perms</code> (tu\u1ef3 ch\u1ecdn) <code>permission_code[]</code> <code>jti</code> ID duy nh\u1ea5t, d\u00f9ng cho thu h\u1ed3i <code>sid</code> Session ID \u2013 li\u00ean k\u1ebft b\u1ea3ng <code>auth_sessions</code> <code>exp</code> TTL ng\u1eafn (\u2264 15 ph\u00fat) <p>Key rotation: TokenService gi\u1eef 2 key ho\u1ea1t \u0111\u1ed9ng song song (<code>kid=current|next</code>); API Gateway ch\u1ea5p nh\u1eadn c\u1ea3 hai.</p>","tags":["auth","token","security","dx-vas","oauth2","otp","jwt"]},{"location":"ADR/adr-006-auth-strategy/#5-vong-oi-phien-thu-hoi-token","title":"5. V\u00f2ng \u0111\u1eddi Phi\u00ean &amp; Thu h\u1ed3i token","text":"B\u1ea3ng Tr\u01b0\u1eddng ch\u00ednh TTL / Storage <code>auth_sessions</code> <code>sid</code>, <code>user_id</code>, <code>tenant_id</code>, <code>ip_address</code>, <code>user_agent</code>, <code>device_type</code>, <code>location</code> Cloud SQL <code>revoked_tokens</code> <code>jti</code>, <code>revoked_at</code>, <code>reason</code> Cloud SQL + Redis (cache 15\u2032) <p>Thu h\u1ed3i token: Auth Master/Sub g\u1ecdi <code>POST /token/revoke</code>, TokenService th\u00eam <code>jti</code> v\u00e0o DB, sync Redis (pub/sub cache-invalidation).</p>","tags":["auth","token","security","dx-vas","oauth2","otp","jwt"]},{"location":"ADR/adr-006-auth-strategy/#6-quy-uoc-ma-loi-namespaceerror_code","title":"6. Quy \u01b0\u1edbc M\u00e3 l\u1ed7i namespace.error_code","text":"<p>V\u00ed d\u1ee5:</p> Namespace Code HTTP \u00dd ngh\u0129a <code>token</code> <code>invalid_signature</code> 401 Ch\u1eef k\u00fd sai <code>session</code> <code>not_found</code> 404 Kh\u00f4ng t\u00ecm th\u1ea5y phi\u00ean <code>common</code> <code>validation_failed</code> 400 Payload sai \u0111\u1ecbnh d\u1ea1ng <p>Danh s\u00e1ch chi ti\u1ebft \u0111\u01b0\u1ee3c chu\u1ea9n ho\u00e1 t\u1ea1i <code>ADR-011 \u2013 API Error Format</code>.</p>","tags":["auth","token","security","dx-vas","oauth2","otp","jwt"]},{"location":"ADR/adr-006-auth-strategy/#7-he-qua","title":"7. H\u1ec7 qu\u1ea3","text":"Kh\u00eda c\u1ea1nh L\u1ee3i \u00edch R\u1ee7i ro / Gi\u1ea3i ph\u00e1p B\u1ea3o m\u1eadt Thu h\u1eb9p b\u1ec1 m\u1eb7t t\u1ea5n c\u00f4ng, audit t\u1eadp trung B\u1ea3o v\u1ec7 private key; CI check rotate Hi\u1ec7u n\u0103ng Gateway verify local, lo\u1ea1i b\u1ecf introspection per request Redis cache <code>revoked_tokens</code> c\u1ea7n TTL h\u1ee3p l\u00fd V\u1eadn h\u00e0nh Logic token t\u1eadp trung, d\u1ec5 quan s\u00e1t &amp; rollback Auth Service ph\u1ea3i refactor th\u00e0nh client","tags":["auth","token","security","dx-vas","oauth2","otp","jwt"]},{"location":"ADR/adr-006-auth-strategy/#lien-ket-lien-quan","title":"\ud83d\udd17 Li\u00ean k\u1ebft li\u00ean quan","text":"<ul> <li>Change Request <code>03-cr-token-service.md</code> :contentReference[oaicite:3]{index=3}  </li> <li><code>ADR-003 \u2013 Secrets</code> :contentReference[oaicite:4]{index=4}  </li> <li><code>ADR-004 \u2013 Security</code> :contentReference[oaicite:5]{index=5}  </li> <li><code>ADR-007 \u2013 RBAC</code> :contentReference[oaicite:6]{index=6}  </li> <li><code>ADR-011 \u2013 API Error Format</code> :contentReference[oaicite:7]{index=7}  </li> <li><code>RBAC Deep Dive \u2013 section 3</code> :contentReference[oaicite:8]{index=8}</li> </ul> <p>\u201c\u0110\u1eb7t TokenService l\u00e0m trung t\u00e2m \u2013 b\u1ea3o m\u1eadt, hi\u1ec7u n\u0103ng v\u00e0 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng c\u00f9ng th\u0103ng h\u1ea1ng.\u201d</p>","tags":["auth","token","security","dx-vas","oauth2","otp","jwt"]},{"location":"ADR/adr-007-rbac/","title":"ADR-007: Chi\u1ebfn l\u01b0\u1ee3c RBAC ph\u00e2n t\u1ea7ng","text":"","tags":["rbac","security","auth","dx-vas"]},{"location":"ADR/adr-007-rbac/#boi-canh","title":"B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas ph\u1ee5c v\u1ee5 nhi\u1ec1u tr\u01b0\u1eddng th\u00e0nh vi\u00ean (multi-tenant), m\u1ed7i tr\u01b0\u1eddng c\u00f3 ng\u01b0\u1eddi d\u00f9ng, vai tr\u00f2 v\u00e0 quy\u1ec1n ri\u00eang bi\u1ec7t. M\u1ed9t ng\u01b0\u1eddi d\u00f9ng c\u00f3 th\u1ec3 ho\u1ea1t \u0111\u1ed9ng \u1edf nhi\u1ec1u tenant kh\u00e1c nhau v\u1edbi vai tr\u00f2 kh\u00e1c nhau.</p> <p>H\u1ec7 th\u1ed1ng c\u1ea7n m\u1ed9t chi\u1ebfn l\u01b0\u1ee3c RBAC \u0111\u1ed9ng, linh ho\u1ea1t, m\u1edf r\u1ed9ng \u0111\u01b0\u1ee3c v\u00e0: - Ph\u00e2n quy\u1ec1n \u0111\u00fang trong t\u1eebng tenant - Cho ph\u00e9p k\u1ebf th\u1eeba ho\u1eb7c tu\u1ef3 bi\u1ebfn quy\u1ec1n theo t\u1eebng tr\u01b0\u1eddng - H\u1ed7 tr\u1ee3 caching \u0111\u1ec3 t\u0103ng hi\u1ec7u n\u0103ng - D\u1ec5 audit, rollback, v\u00e0 qu\u1ea3n tr\u1ecb</p>","tags":["rbac","security","auth","dx-vas"]},{"location":"ADR/adr-007-rbac/#quyet-inh","title":"Quy\u1ebft \u0111\u1ecbnh","text":"","tags":["rbac","security","auth","dx-vas"]},{"location":"ADR/adr-007-rbac/#1-phan-tang-rbac-master-vs-sub","title":"1. Ph\u00e2n t\u1ea7ng RBAC: Master vs Sub","text":"Th\u00e0nh ph\u1ea7n Vai tr\u00f2 User Service Master Qu\u1ea3n l\u00fd \u0111\u1ecbnh danh to\u00e0n c\u1ee5c (<code>users_global</code>), danh s\u00e1ch tenant, v\u00e0 template role/permission d\u00f9ng chung Sub User Service (per tenant) Qu\u1ea3n l\u00fd ng\u01b0\u1eddi d\u00f9ng trong tenant, role/permission n\u1ed9i b\u1ed9, mapping user \u2194 role \u2194 permission <p>M\u1ed7i tenant c\u00f3 stack ri\u00eang. RBAC \u0111\u01b0\u1ee3c \u0111\u00e1nh gi\u00e1 t\u1ea1i API Gateway trong ng\u1eef c\u1ea3nh <code>tenant_id</code>.</p>","tags":["rbac","security","auth","dx-vas"]},{"location":"ADR/adr-007-rbac/#2-jwt-va-phan-quyen","title":"2. JWT v\u00e0 Ph\u00e2n quy\u1ec1n","text":"<ul> <li>JWT lu\u00f4n ch\u1ee9a:</li> <li><code>user_id</code> (global)</li> <li><code>tenant_id</code></li> <li><code>roles</code>: danh s\u00e1ch m\u00e3 vai tr\u00f2 (<code>role_code</code>)</li> <li>JWT kh\u00f4ng ch\u1ee9a <code>permissions</code></li> <li>Vi\u1ec7c \u0111\u00e1nh gi\u00e1 quy\u1ec1n chi ti\u1ebft (bao g\u1ed3m c\u1ea3 <code>condition</code>) s\u1ebd \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n t\u1ea1i API Gateway</li> <li> <p>Gateway tra c\u1ee9u t\u1eeb Redis cache theo key:</p> <pre><code>rbac:{user_id}:{tenant_id}\n</code></pre> </li> <li> <p>N\u1ebfu cache miss \u2192 Gateway g\u1ecdi Sub User Service th\u00f4ng qua API Gateway \u0111\u1ec3 l\u1ea5y <code>permissions</code> theo role</p> </li> </ul>","tags":["rbac","security","auth","dx-vas"]},{"location":"ADR/adr-007-rbac/#3-cau-truc-du-lieu-rbac","title":"3. C\u1ea5u tr\u00fac d\u1eef li\u1ec7u RBAC","text":"<p>T\u1ea1i Master:</p> <pre><code>CREATE TABLE global_permissions_templates (\n  template_id UUID PRIMARY KEY,\n  permission_code TEXT UNIQUE NOT NULL,\n  action TEXT NOT NULL,\n  resource TEXT NOT NULL,\n  default_condition JSONB,\n  description TEXT\n);\n</code></pre> <ul> <li><code>permission_code</code> gi\u00fap mapping v\u00e0 clone xu\u1ed1ng Sub User Service d\u1ec5 d\u00e0ng</li> <li>C\u1ea5u tr\u00fac t\u01b0\u01a1ng t\u1ef1 <code>permissions_in_tenant</code>, gi\u00fap tenant k\u1ebf th\u1eeba ho\u1eb7c override khi c\u1ea7n</li> </ul> <p>T\u1ea1i Sub User Service (per tenant):</p> <pre><code>CREATE TABLE permissions_in_tenant (\n  permission_id UUID PRIMARY KEY,\n  permission_code TEXT UNIQUE NOT NULL,\n  action TEXT NOT NULL,\n  resource TEXT NOT NULL,\n  condition JSONB\n);\n</code></pre> <ul> <li>Tr\u01b0\u1eddng <code>action</code>, <code>resource</code> \u0111\u1ec1u c\u00f3 <code>NOT NULL</code> \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o permission lu\u00f4n \u0111\u1ee7 th\u00f4ng tin \u0111\u1ec3 \u0111\u00e1nh gi\u00e1</li> </ul>","tags":["rbac","security","auth","dx-vas"]},{"location":"ADR/adr-007-rbac/#4-ieu-kien-phan-quyen-condition-jsonb","title":"4. \u0110i\u1ec1u ki\u1ec7n ph\u00e2n quy\u1ec1n (<code>condition</code> JSONB)","text":"<p>Permissions c\u00f3 th\u1ec3 ch\u1ee9a \u0111i\u1ec1u ki\u1ec7n \u0111\u1ed9ng:</p> <pre><code>{\n  \"class_id\": \"$user.class_id\"\n}\n</code></pre> <p>Gateway s\u1ebd \u0111\u00e1nh gi\u00e1 \u0111i\u1ec1u ki\u1ec7n n\u00e0y d\u1ef1a tr\u00ean context user v\u00e0 request. \u0110i\u1ec1u ki\u1ec7n \u0111\u01b0\u1ee3c l\u01b0u v\u00e0 tra c\u1ee9u t\u1eeb Redis ho\u1eb7c g\u1ecdi API n\u1ebfu c\u1ea7n.</p>","tags":["rbac","security","auth","dx-vas"]},{"location":"ADR/adr-007-rbac/#5-cache-tai-gateway","title":"5. Cache t\u1ea1i Gateway","text":"<ul> <li>Key: <code>rbac:{user_id}:{tenant_id}</code></li> <li>TTL m\u1eb7c \u0111\u1ecbnh: 5\u201315 ph\u00fat</li> <li> <p>Invalidation:</p> </li> <li> <p>Khi user b\u1ecb g\u00e1n quy\u1ec1n m\u1edbi</p> </li> <li>Khi user b\u1ecb v\u00f4 hi\u1ec7u h\u00f3a</li> <li>Qua s\u1ef1 ki\u1ec7n Pub/Sub: <code>rbac_updated</code>, <code>user_status_changed</code></li> </ul>","tags":["rbac","security","auth","dx-vas"]},{"location":"ADR/adr-007-rbac/#6-ong-bo-template","title":"6. \u0110\u1ed3ng b\u1ed9 template","text":"<ul> <li> <p>C\u00e1c tenant c\u00f3 th\u1ec3:</p> </li> <li> <p>K\u1ebf th\u1eeba template vai tr\u00f2 t\u1eeb Master (t\u1ef1 \u0111\u1ed9ng \u0111\u1ed3ng b\u1ed9)</p> </li> <li>Clone \u0111\u1ec3 tu\u1ef3 ch\u1ec9nh (\u0111\u1ed9c l\u1eadp v\u1ec1 sau)</li> <li>S\u1ef1 ki\u1ec7n <code>rbac_template_updated</code> \u0111\u01b0\u1ee3c ph\u00e1t t\u1eeb Master \u2192 Sub nh\u1eadn v\u00e0 x\u1eed l\u00fd</li> </ul>","tags":["rbac","security","auth","dx-vas"]},{"location":"ADR/adr-007-rbac/#7-bao-cao-va-quyen-truy-cap-bao-cao","title":"7. B\u00e1o c\u00e1o v\u00e0 quy\u1ec1n truy c\u1eadp b\u00e1o c\u00e1o","text":"<ul> <li>M\u1ed7i Report Template s\u1ebd c\u00f3 m\u1ed9t tr\u01b0\u1eddng <code>required_permission</code>, v\u00ed d\u1ee5 <code>\"report.view_login_by_tenant\"</code>.</li> <li>Ng\u01b0\u1eddi d\u00f9ng ch\u1ec9 c\u00f3 th\u1ec3 truy c\u1eadp template ho\u1eb7c sinh b\u00e1o c\u00e1o khi c\u00f3 \u0111\u1ee7 quy\u1ec1n t\u01b0\u01a1ng \u1ee9ng trong RBAC, \u0111\u01b0\u1ee3c \u0111\u00e1nh gi\u00e1 t\u1ea1i API Gateway.</li> <li><code>required_permission</code> \u0111\u01b0\u1ee3c tra c\u1ee9u t\u1eeb Redis cache t\u01b0\u01a1ng t\u1ef1 nh\u01b0 c\u00e1c API business kh\u00e1c.</li> <li>N\u1ebfu template c\u00f3 <code>scope: global</code>, th\u00ec permission ph\u1ea3i l\u00e0 c\u1ee7a tenant \"superadmin\"; n\u1ebfu l\u00e0 <code>scope: tenant</code>, th\u00ec permission \u0111\u01b0\u1ee3c ki\u1ec3m tra trong context <code>tenant_id</code> hi\u1ec7n t\u1ea1i.</li> </ul>","tags":["rbac","security","auth","dx-vas"]},{"location":"ADR/adr-007-rbac/#8-lien-ket-voi-he-thong-quan-ly-bao-cao","title":"8. Li\u00ean k\u1ebft v\u1edbi h\u1ec7 th\u1ed1ng qu\u1ea3n l\u00fd b\u00e1o c\u00e1o","text":"<ul> <li> <p>B\u1ea3ng <code>permissions_in_tenant</code> c\u00f3 th\u1ec3 l\u01b0u c\u00e1c quy\u1ec1n \u0111\u1eb7c th\u00f9 cho t\u1eebng lo\u1ea1i b\u00e1o c\u00e1o, bao g\u1ed3m:</p> </li> <li> <p><code>\"report.view_*\"</code> \u2013 quy\u1ec1n xem t\u1eebng nh\u00f3m b\u00e1o c\u00e1o</p> </li> <li><code>\"report.manage_templates\"</code> \u2013 quy\u1ec1n qu\u1ea3n l\u00fd \u0111\u1ecbnh ngh\u0129a b\u00e1o c\u00e1o</li> <li><code>\"report.export\"</code> \u2013 quy\u1ec1n export k\u1ebft qu\u1ea3</li> <li>C\u00e1c quy\u1ec1n n\u00e0y c\u0169ng c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 t\u1eeb <code>global_permissions_templates</code> n\u1ebfu b\u00e1o c\u00e1o l\u00e0 to\u00e0n c\u1ee5c.</li> </ul>","tags":["rbac","security","auth","dx-vas"]},{"location":"ADR/adr-007-rbac/#he-qua","title":"H\u1ec7 qu\u1ea3","text":"<p>\u2705 \u01afu \u0111i\u1ec3m:</p> <ul> <li>Ph\u00e2n t\u00e1ch r\u00f5 r\u00e0ng gi\u1eefa \u0111\u1ecbnh danh to\u00e0n c\u1ee5c v\u00e0 ph\u00e2n quy\u1ec1n n\u1ed9i b\u1ed9</li> <li>D\u1ec5 m\u1edf r\u1ed9ng khi c\u00f3 tenant m\u1edbi ho\u1eb7c role m\u1edbi</li> <li>T\u1ed1i \u01b0u hi\u1ec7u n\u0103ng qua Redis cache v\u00e0 Pub/Sub</li> <li>Qu\u1ea3n tr\u1ecb t\u1eadp trung, nh\u01b0ng cho ph\u00e9p m\u1ed7i tenant t\u00f9y bi\u1ebfn \u0111\u1ed9c l\u1eadp</li> <li>H\u1ed7 tr\u1ee3 condition \u0111\u1ed9ng, RBAC \u0111a ng\u1eef c\u1ea3nh</li> </ul> <p>\u26a0\ufe0f L\u01b0u \u00fd:</p> <ul> <li>C\u1ea7n x\u00e2y d\u1ef1ng giao di\u1ec7n qu\u1ea3n l\u00fd role/permission r\u00f5 r\u00e0ng cho t\u1eebng tenant</li> <li>C\u1ea7n c\u01a1 ch\u1ebf trace + audit ph\u00e2n quy\u1ec1n theo <code>tenant_id</code></li> </ul>","tags":["rbac","security","auth","dx-vas"]},{"location":"ADR/adr-007-rbac/#lien-ket-lien-quan","title":"Li\u00ean k\u1ebft li\u00ean quan","text":"<ul> <li>ADR-006 - Auth Strategy</li> <li>ADR-012 - Response Structure</li> <li>ADR-028 - Reporting Architecture</li> <li>ADR-029 - Report Template Schema</li> <li>ADR-030 - Event Schema Governance</li> <li>RBAC Deep Dive</li> <li>README - 2. \u0110\u0103ng nh\u1eadp &amp; Ph\u00e2n quy\u1ec1n \u0111\u1ed9ng RBAC</li> </ul>","tags":["rbac","security","auth","dx-vas"]},{"location":"ADR/adr-008-audit-logging/","title":"ADR-008: Audit Logging \u2013 Nh\u1eadt k\u00fd ho\u1ea1t \u0111\u1ed9ng v\u00e0 gi\u00e1m s\u00e1t an ninh h\u1ec7 th\u1ed1ng","text":"","tags":["audit","logging","observability","dx-vas","security"]},{"location":"ADR/adr-008-audit-logging/#boi-canh","title":"B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas ph\u1ee5c v\u1ee5 nhi\u1ec1u tenant (tr\u01b0\u1eddng th\u00e0nh vi\u00ean), m\u1ed7i tenant c\u00f3 ng\u01b0\u1eddi d\u00f9ng, ph\u00e2n quy\u1ec1n v\u00e0 thao t\u00e1c ri\u00eang bi\u1ec7t. Vi\u1ec7c theo d\u00f5i v\u00e0 ghi l\u1ea1i \u0111\u1ea7y \u0111\u1ee7 c\u00e1c h\u00e0nh vi quan tr\u1ecdng l\u00e0 thi\u1ebft y\u1ebfu \u0111\u1ec3:</p> <ul> <li>\u0110\u1ea3m b\u1ea3o minh b\u1ea1ch trong thao t\u00e1c ph\u00e2n quy\u1ec1n</li> <li>Ph\u00e1t hi\u1ec7n s\u1edbm c\u00e1c h\u00e0nh vi \u0111\u00e1ng ng\u1edd ho\u1eb7c sai l\u1ec7ch</li> <li>H\u1ed7 tr\u1ee3 ph\u00e2n t\u00edch l\u1ed7i, truy v\u1ebft s\u1ef1 c\u1ed1 v\u00e0 \u0111\u1ed1i so\u00e1t ho\u1ea1t \u0111\u1ed9ng</li> <li>\u0110\u00e1p \u1ee9ng y\u00eau c\u1ea7u b\u1ea3o m\u1eadt v\u00e0 ki\u1ec3m to\u00e1n theo t\u1eebng tenant</li> </ul>","tags":["audit","logging","observability","dx-vas","security"]},{"location":"ADR/adr-008-audit-logging/#quyet-inh","title":"Quy\u1ebft \u0111\u1ecbnh","text":"","tags":["audit","logging","observability","dx-vas","security"]},{"location":"ADR/adr-008-audit-logging/#1-moi-hanh-ong-quan-trong-phai-uoc-ghi-log","title":"1. M\u1ecdi h\u00e0nh \u0111\u1ed9ng quan tr\u1ecdng ph\u1ea3i \u0111\u01b0\u1ee3c ghi log","text":"<p>Bao g\u1ed3m (nh\u01b0ng kh\u00f4ng gi\u1edbi h\u1ea1n):</p> <ul> <li>\u0110\u0103ng nh\u1eadp / \u0110\u0103ng xu\u1ea5t (Google OAuth2, OTP, Local)</li> <li>G\u00e1n quy\u1ec1n (user \u2194 role \u2194 permission)</li> <li>Thay \u0111\u1ed5i tr\u1ea1ng th\u00e1i ng\u01b0\u1eddi d\u00f9ng (<code>is_active</code>, <code>is_active_in_tenant</code>)</li> <li>G\u1eedi th\u00f4ng b\u00e1o (qua Sub Notification Service ho\u1eb7c t\u1eeb Master)</li> <li>T\u1ea1o / s\u1eeda / xo\u00e1 role, permission, template</li> <li>B\u1ea5t k\u1ef3 h\u00e0nh \u0111\u1ed9ng h\u1ec7 th\u1ed1ng li\u00ean quan t\u1edbi t\u00e0i ch\u00ednh, h\u1ecdc sinh, h\u1ed3 s\u01a1</li> </ul>","tags":["audit","logging","observability","dx-vas","security"]},{"location":"ADR/adr-008-audit-logging/#2-log-bat-buoc-phai-chua-cac-truong","title":"2. Log b\u1eaft bu\u1ed9c ph\u1ea3i ch\u1ee9a c\u00e1c tr\u01b0\u1eddng:","text":"Tr\u01b0\u1eddng \u00dd ngh\u0129a <code>tenant_id</code> Tenant n\u01a1i x\u1ea3y ra h\u00e0nh \u0111\u1ed9ng <code>actor_user_id</code> ID ng\u01b0\u1eddi th\u1ef1c hi\u1ec7n h\u00e0nh \u0111\u1ed9ng (user \u0111\u0103ng nh\u1eadp) <code>target_resource_type</code> Lo\u1ea1i t\u00e0i nguy\u00ean b\u1ecb t\u00e1c \u0111\u1ed9ng (user, role, permission, notification, ...) <code>target_resource_id</code> ID t\u00e0i nguy\u00ean b\u1ecb t\u00e1c \u0111\u1ed9ng (n\u1ebfu c\u00f3) <code>action_type</code> H\u00e0nh \u0111\u1ed9ng c\u1ee5 th\u1ec3 (assign_role, update_user, send_notification, ...) <code>action_scope</code> Ph\u1ea1m vi t\u00e1c \u0111\u1ed9ng (global / per-tenant) <code>trace_id</code> ID theo d\u00f5i xuy\u00ean su\u1ed1t chu\u1ed7i s\u1ef1 ki\u1ec7n <code>timestamp</code> Th\u1eddi \u0111i\u1ec3m x\u1ea3y ra <code>ip</code>, <code>user_agent</code> (n\u1ebfu c\u00f3 th\u1ec3 l\u1ea5y) t\u1eeb request \u0111\u1ea7u v\u00e0o <code>payload_before</code>, <code>payload_after</code> Ghi nh\u1eadn gi\u00e1 tr\u1ecb tr\u01b0\u1edbc/sau (cho audit thay \u0111\u1ed5i) <p>Trong tr\u01b0\u1eddng h\u1ee3p audit RBAC ho\u1eb7c notification, c\u00f3 th\u1ec3 log <code>target_resource_type = \"user\"</code>, <code>target_resource_id = &lt;user_id&gt;</code> \u0111\u1ec3 th\u1ec3 hi\u1ec7n user b\u1ecb g\u00e1n vai tr\u00f2 ho\u1eb7c nh\u1eadn th\u00f4ng b\u00e1o.</p>","tags":["audit","logging","observability","dx-vas","security"]},{"location":"ADR/adr-008-audit-logging/#3-giao-tiep-giua-service-phai-traceable","title":"3. Giao ti\u1ebfp gi\u1eefa service ph\u1ea3i traceable","text":"<ul> <li>C\u00e1c service (Auth, Gateway, Sub Service) g\u1eafn <code>trace_id</code> v\u00e0o log</li> <li>N\u1ebfu l\u00e0 call qua Pub/Sub \u2192 g\u1eafn <code>message_id</code>, <code>correlation_id</code></li> </ul>","tags":["audit","logging","observability","dx-vas","security"]},{"location":"ADR/adr-008-audit-logging/#4-notification-service-pubsub-option-b-ghi-log-nhu-sau","title":"4. Notification Service (Pub/Sub Option B) ghi log nh\u01b0 sau:","text":"<ul> <li>M\u1ed7i Sub Notification Service:</li> <li>Ghi log tr\u1ea1ng th\u00e1i g\u1eedi th\u00f4ng b\u00e1o (<code>sent</code>, <code>failed</code>, <code>queued</code>, <code>skipped</code>)</li> <li>G\u1eafn: <code>tenant_id</code>, <code>notification_id</code>, <code>channel</code>, <code>receiver_count</code>, <code>error_detail</code> (n\u1ebfu c\u00f3)</li> <li> <p>Log c\u00f3 th\u1ec3 g\u1eafn <code>correlation_id</code> theo s\u1ef1 ki\u1ec7n t\u1eeb Master</p> </li> <li> <p>Notification Master:</p> </li> <li>L\u1eafng nghe c\u00e1c s\u1ef1 ki\u1ec7n <code>tenant_notification_batch_status</code> \u0111\u1ec3 t\u1ed5ng h\u1ee3p k\u1ebft qu\u1ea3 to\u00e0n h\u1ec7 th\u1ed1ng</li> <li>T\u1ed5ng h\u1ee3p n\u00e0y c\u0169ng \u0111\u01b0\u1ee3c ghi log d\u01b0\u1edbi d\u1ea1ng audit, v\u00ed d\u1ee5:     <pre><code>{\n  \"actor_user_id\": \"&lt;superadmin_id&gt;\",\n  \"action_type\": \"global_notification_summary\",\n  \"target_resource_type\": \"notification\",\n  \"target_resource_id\": \"notif-xyz\",\n  \"success_count\": 2,\n  \"fail_count\": 1,\n  \"trace_id\": \"...\",\n  \"timestamp\": \"...\"\n}\n</code></pre></li> <li>Ghi r\u00f5 tenant n\u00e0o nh\u1eadn th\u00e0nh c\u00f4ng / th\u1ea5t b\u1ea1i (n\u1ebfu c\u1ea7n \u0111\u1ed1i so\u00e1t)</li> </ul>","tags":["audit","logging","observability","dx-vas","security"]},{"location":"ADR/adr-008-audit-logging/#5-he-thong-log-tap-trung","title":"5. H\u1ec7 th\u1ed1ng log t\u1eadp trung","text":"<ul> <li>D\u00f9ng Cloud Logging / Stackdriver</li> <li>T\u1ea5t c\u1ea3 log \u0111\u1ec1u c\u00f3 c\u1ea5u tr\u00fac JSON chu\u1ea9n \u2192 d\u1ec5 ph\u00e2n t\u00edch b\u1eb1ng BigQuery</li> <li>Cho ph\u00e9p filter theo <code>tenant_id</code>, <code>action_type</code>, <code>trace_id</code></li> </ul>","tags":["audit","logging","observability","dx-vas","security"]},{"location":"ADR/adr-008-audit-logging/#6-ghi-log-truy-cap-bao-cao-tu-reporting-service","title":"6. Ghi log truy c\u1eadp b\u00e1o c\u00e1o (t\u1eeb Reporting Service)","text":"<ul> <li>M\u1ecdi truy c\u1eadp c\u00e1c API <code>/reports/*</code>, <code>/report-templates/*</code>, <code>/saved-reports/*</code> s\u1ebd \u0111\u01b0\u1ee3c ghi audit log.</li> <li>Th\u00f4ng tin c\u1ea7n log:</li> <li><code>actor_user_id</code>: ng\u01b0\u1eddi th\u1ef1c hi\u1ec7n truy c\u1eadp</li> <li><code>action_type</code>: <code>view_report</code>, <code>list_templates</code>, <code>generate_report</code>, <code>download_report</code>, ...</li> <li><code>target_resource_type</code>: <code>\"report_template\"</code> ho\u1eb7c <code>\"report_result\"</code></li> <li><code>target_resource_id</code>: id c\u1ee7a template ho\u1eb7c report (n\u1ebfu c\u00f3)</li> <li><code>input_parameters</code>: (n\u1ebfu c\u00f3) \u2013 \u0111\u01b0\u1ee3c mask n\u1ebfu ch\u1ee9a th\u00f4ng tin nh\u1ea1y c\u1ea3m</li> <li><code>duration_ms</code>: th\u1eddi gian th\u1ef1c thi truy v\u1ea5n</li> <li><code>tenant_id</code>, <code>trace_id</code>, <code>timestamp</code></li> <li>C\u00e1c tr\u01b0\u1eddng nh\u1ea1y c\u1ea3m trong <code>input_parameters</code> nh\u01b0 email, s\u1ed1 \u0111i\u1ec7n tho\u1ea1i c\u1ea7n \u0111\u01b0\u1ee3c mask ho\u1eb7c lo\u1ea1i tr\u1eeb ra kh\u1ecfi log.</li> <li>Vi\u1ec7c masking ph\u1ea3i tu\u00e2n th\u1ee7 <code>ADR-024 - Data Anonymization &amp; Retention</code>.</li> <li>C\u1ea7n x\u00e2y d\u1ef1ng m\u1ed9t danh s\u00e1ch whitelist ho\u1eb7c pattern-based detection cho c\u00e1c tham s\u1ed1 c\u1ea7n \u0111\u01b0\u1ee3c \u1ea9n/mask, v\u00e0 \u00e1p d\u1ee5ng nh\u1ea5t qu\u00e1n b\u1eb1ng middleware ho\u1eb7c utility tr\u01b0\u1edbc khi log.</li> <li><code>target_resource_id</code>:</li> <li>V\u1edbi <code>generate_report</code>, \u0111\u00e2y th\u01b0\u1eddng l\u00e0 ID c\u1ee7a <code>report_template</code>.</li> <li>N\u1ebfu h\u1ec7 th\u1ed1ng sinh ra m\u1ed9t <code>report_result_id</code> ri\u00eang (v\u00ed d\u1ee5 khi export ho\u1eb7c l\u01b0u b\u00e1o c\u00e1o), th\u00ec c\u00f3 th\u1ec3 s\u1eed d\u1ee5ng <code>report_result_id</code> l\u00e0m <code>target_resource_id</code>.</li> </ul> <p>V\u00ed d\u1ee5: <pre><code>{\n  \"actor_user_id\": \"admin-001\",\n  \"action_type\": \"generate_report\",\n  \"target_resource_type\": \"report_template\",\n  \"target_resource_id\": \"login-by-tenant\",\n  \"input_parameters\": {\n    \"start_date\": \"2024-01-01\",\n    \"end_date\": \"2024-01-31\",\n    \"tenant_id\": \"vas-hn\"\n  },\n  \"duration_ms\": 142,\n  \"trace_id\": \"abc-xyz-123\",\n  \"tenant_id\": \"vas-superadmin\",\n  \"timestamp\": \"2025-06-03T08:00:00Z\"\n}\n</code></pre></p>","tags":["audit","logging","observability","dx-vas","security"]},{"location":"ADR/adr-008-audit-logging/#he-qua","title":"H\u1ec7 qu\u1ea3","text":"<p>\u2705 \u01afu \u0111i\u1ec3m:</p> <ul> <li>D\u1ec5 theo d\u00f5i ho\u1ea1t \u0111\u1ed9ng c\u1ee7a t\u1eebng ng\u01b0\u1eddi d\u00f9ng trong t\u1eebng tenant</li> <li>Gi\u00fap truy v\u1ebft nhanh khi c\u00f3 l\u1ed7i, gian l\u1eadn ho\u1eb7c b\u1ea5t th\u01b0\u1eddng</li> <li>H\u1ed7 tr\u1ee3 qu\u1ea3n tr\u1ecb t\u1eadp trung nh\u01b0ng ph\u00e2n quy\u1ec1n ph\u00e2n t\u00edch theo tenant</li> </ul> <p>\u26a0\ufe0f L\u01b0u \u00fd:</p> <ul> <li>D\u1eef li\u1ec7u log c\u1ea7n \u0111\u01b0\u1ee3c b\u1ea3o v\u1ec7 ri\u00eang, c\u00f3 retention ph\u00f9 h\u1ee3p</li> <li>Audit log quan tr\u1ecdng (RBAC, ph\u00e2n quy\u1ec1n) kh\u00f4ng \u0111\u01b0\u1ee3c ph\u00e9p x\u00f3a</li> <li>C\u1ea7n c\u01a1 ch\u1ebf mask d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m khi export (email, s\u1ed1 \u0111i\u1ec7n tho\u1ea1i)</li> </ul>","tags":["audit","logging","observability","dx-vas","security"]},{"location":"ADR/adr-008-audit-logging/#lien-ket-lien-quan","title":"Li\u00ean k\u1ebft li\u00ean quan","text":"<ul> <li>ADR-006 - Auth Strategy</li> <li>ADR-007 - RBAC v\u00e0 ph\u00e2n quy\u1ec1n \u0111\u1ed9ng</li> <li>ADR-012 - Response Structure</li> <li>ADR-028 - Reporting Architecture</li> <li>ADR-029 - Report Template Schema</li> <li>ADR-030 - Event Schema Governance</li> <li>RBAC Deep Dive</li> <li>README - 17. B\u1ea3o m\u1eadt &amp; gi\u00e1m s\u00e1t</li> </ul> <p>\u201cN\u1ebfu b\u1ea1n kh\u00f4ng ghi l\u1ea1i h\u00e0nh vi c\u1ee7a h\u1ec7 th\u1ed1ng \u2013 b\u1ea1n s\u1ebd kh\u00f4ng bao gi\u1edd bi\u1ebft \u0111i\u1ec1u g\u00ec \u0111\u00e3 x\u1ea3y ra khi n\u00f3 x\u1ea3y ra.\u201d</p>","tags":["audit","logging","observability","dx-vas","security"]},{"location":"ADR/adr-009-api-governance/","title":"ADR-009 - Ch\u00ednh s\u00e1ch Qu\u1ea3n tr\u1ecb API (API Governance) cho h\u1ec7 th\u1ed1ng dx-vas","text":"","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas bao g\u1ed3m nhi\u1ec1u d\u1ecbch v\u1ee5 cung c\u1ea5p v\u00e0 ti\u00eau th\u1ee5 API: - API Gateway (\u0111i\u1ec3m v\u00e0o trung t\u00e2m) - C\u00e1c backend: CRM Adapter, LMS Proxy, Notification Service, SIS Adapter... - Frontend webapp (Portal, Admin) - D\u1ecbch v\u1ee5 b\u00ean ngo\u00e0i (Zalo, Google OAuth, Firebase...)</p> <p>\u0110\u1ec3 \u0111\u1ea3m b\u1ea3o s\u1ef1 th\u1ed1ng nh\u1ea5t, b\u1ea3o tr\u00ec l\u00e2u d\u00e0i v\u00e0 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng, to\u00e0n h\u1ec7 th\u1ed1ng c\u1ea7n c\u00f3 ch\u00ednh s\u00e1ch qu\u1ea3n tr\u1ecb API (API Governance) chung.</p>","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#quyet-inh","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh","text":"<p>\u00c1p d\u1ee5ng ch\u00ednh s\u00e1ch API Governance chu\u1ea9n, bao g\u1ed3m versioning, linting, schema h\u00f3a OpenAPI, quy tr\u00ecnh review, v\u00e0 t\u00e0i li\u1ec7u ho\u00e1 t\u1ef1 \u0111\u1ed9ng. \u00c1p d\u1ee5ng cho t\u1ea5t c\u1ea3 c\u00e1c API n\u1ed9i b\u1ed9 v\u00e0 external-facing trong dx-vas.</p>","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#nguyen-tac-chung","title":"\ud83d\udcd0 Nguy\u00ean t\u1eafc chung","text":"","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#1-api-phai-co-version-ro-rang","title":"1. API ph\u1ea3i c\u00f3 version r\u00f5 r\u00e0ng","text":"<ul> <li>S\u1eed d\u1ee5ng prefix trong path: <code>/api/v1/...</code></li> <li>Thay \u0111\u1ed5i breaking \u2192 t\u1ea1o version m\u1edbi (<code>v2</code>)</li> <li>C\u00e1c version song song \u0111\u01b0\u1ee3c duy tr\u00ec trong th\u1eddi gian chuy\u1ec3n ti\u1ebfp (6\u201312 th\u00e1ng)</li> </ul>","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#2-api-phai-co-tai-lieu-openapi","title":"2. API ph\u1ea3i c\u00f3 t\u00e0i li\u1ec7u OpenAPI","text":"<ul> <li>Vi\u1ebft OpenAPI schema (YAML/JSON) theo chu\u1ea9n 3.x</li> <li>M\u1ed7i service c\u1ea7n expose <code>GET /openapi.json</code></li> <li>D\u00f9ng Swagger UI ho\u1eb7c Redoc \u0111\u1ec3 render trong CI ho\u1eb7c Docs</li> </ul>","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#3-linting-kiem-tra-tu-ong","title":"3. Linting &amp; ki\u1ec3m tra t\u1ef1 \u0111\u1ed9ng","text":"<ul> <li>D\u00f9ng <code>speccy</code>, <code>spectral</code>, ho\u1eb7c <code>oas-linter</code> \u0111\u1ec3:</li> <li>B\u1eaft l\u1ed7i thi\u1ebfu description, type</li> <li>Ki\u1ec3m tra naming convention, security scheme, 2xx/4xx \u0111\u1ea7y \u0111\u1ee7</li> <li>T\u00edch h\u1ee3p trong CI/CD:</li> <li>Fail build n\u1ebfu OpenAPI c\u00f3 l\u1ed7i n\u1eb7ng</li> </ul>","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#4-ten-endpoint-va-schema-co-quy-tac","title":"4. T\u00ean endpoint v\u00e0 schema c\u00f3 quy t\u1eafc","text":"<ul> <li>T\u00ean endpoint RESTful: <code>/students/{id}</code>, <code>/grades/{student_id}</code></li> <li>Tham s\u1ed1 \u0111\u01b0\u1eddng d\u1eabn <code>snake_case</code>, danh t\u1eeb s\u1ed1 nhi\u1ec1u</li> <li>D\u1eef li\u1ec7u tr\u1ea3 v\u1ec1 d\u1ea1ng JSON, response chu\u1ea9n ho\u00e1 <code>{data, error, meta}</code></li> </ul>","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#5-versioning-deprecation-policy","title":"5. Versioning &amp; Deprecation Policy","text":"<ul> <li>M\u1ed7i version API \u0111\u01b0\u1ee3c ghi r\u00f5 ng\u00e0y ph\u00e1t h\u00e0nh v\u00e0 ng\u00e0y d\u1ef1 ki\u1ebfn ng\u01b0ng h\u1ed7 tr\u1ee3 (sunset date)</li> <li>Endpoint c\u0169 \u0111\u01b0\u1ee3c th\u00eam header:   <pre><code>Deprecation: true\nSunset: Wed, 31 Dec 2025 23:59:59 GMT\nLink: &lt;/api/v2/...&gt;; rel=\"successor-version\"\n</code></pre></li> <li>C\u00f3 endpoint <code>/api/docs/deprecation</code> \u0111\u1ec3 li\u1ec7t k\u00ea API s\u1eafp ng\u01b0ng h\u1ed7 tr\u1ee3</li> </ul>","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#6-quy-trinh-review-va-phe-duyet","title":"6. Quy tr\u00ecnh review v\u00e0 ph\u00ea duy\u1ec7t","text":"<ul> <li>M\u1ed7i thay \u0111\u1ed5i schema c\u1ea7n m\u1edf Pull Request v\u1edbi:</li> <li>File OpenAPI m\u1edbi ho\u1eb7c diff</li> <li>Ghi r\u00f5 breaking / non-breaking</li> <li>Ch\u1ea1y pass linter + test contract (xem ADR-010)</li> <li>Review b\u1edfi team ki\u1ebfn tr\u00fac v\u00e0 \u0111\u1ea1i di\u1ec7n frontend/backend li\u00ean quan</li> </ul>","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#7-gan-metadata-cho-moi-api","title":"7. G\u1eafn metadata cho m\u1ed7i API","text":"<ul> <li>Th\u00eam tag, owner, description trong OpenAPI</li> <li>M\u1ee5c ti\u00eau: gi\u00fap team ph\u00e2n t\u00edch v\u00e0 hi\u1ec3u r\u00f5 t\u1eebng API endpoint</li> </ul> <pre><code>x-metadata:\n  owner: lms_team\n  tier: critical\n  service: lms_proxy\n</code></pre>","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#cong-cu-e-xuat","title":"\ud83d\udee0 C\u00f4ng c\u1ee5 \u0111\u1ec1 xu\u1ea5t","text":"M\u1ee5c ti\u00eau C\u00f4ng c\u1ee5 Lint &amp; ki\u1ec3m tra schema Spectral, Speccy, oasdiff So s\u00e1nh version <code>oasdiff</code>, <code>schemathesis diff</code> Render docs Redoc, Swagger UI, Stoplight CI/CD t\u00edch h\u1ee3p GitHub Actions (<code>lint-openapi.yml</code>)","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>API d\u1ec5 hi\u1ec3u, d\u1ec5 t\u00edch h\u1ee3p v\u00e0 m\u1edf r\u1ed9ng</li> <li>Gi\u1ea3m l\u1ed7i khi t\u00edch h\u1ee3p \u0111a d\u1ecbch v\u1ee5 / frontend</li> <li>T\u0103ng kh\u1ea3 n\u0103ng tu\u00e2n th\u1ee7, ki\u1ec3m so\u00e1t thay \u0111\u1ed5i API</li> <li>Gi\u00fap c\u00e1c team l\u00e0m vi\u1ec7c tr\u01a1n tru h\u01a1n nh\u1edd t\u00e0i li\u1ec7u t\u1ef1 \u0111\u1ed9ng v\u00e0 th\u1ed1ng nh\u1ea5t</li> </ul>","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p API kh\u00f4ng c\u00f3 schema r\u00f5 r\u00e0ng \u2192 l\u1ed7i t\u00edch h\u1ee3p B\u1eaft bu\u1ed9c check trong CI/CD, fail n\u1ebfu thi\u1ebfu OpenAPI Kh\u00f4ng qu\u1ea3n l\u00fd version t\u1ed1t \u2192 ph\u00e1 v\u1ee1 t\u00edch h\u1ee3p G\u1eafn version, \u00e1p d\u1ee5ng ch\u00ednh s\u00e1ch deprecation r\u00f5 r\u00e0ng Review b\u1ecb ch\u1eadm C\u00f3 checklist PR + ph\u00e2n quy\u1ec1n ng\u01b0\u1eddi duy\u1ec7t theo module","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#cac-phuong-an-a-loai-bo","title":"\ud83d\udd04 C\u00e1c ph\u01b0\u01a1ng \u00e1n \u0111\u00e3 lo\u1ea1i b\u1ecf","text":"Ph\u01b0\u01a1ng \u00e1n L\u00fd do kh\u00f4ng ch\u1ecdn Kh\u00f4ng d\u00f9ng version prefix D\u1ec5 g\u00e2y breaking change ng\u1ea7m Ch\u1ec9 vi\u1ebft t\u00e0i li\u1ec7u Markdown Kh\u00f4ng t\u1ef1 sinh schema, kh\u00f3 check t\u1ef1 \u0111\u1ed9ng Qu\u1ea3n l\u00fd API t\u1ef1 do theo t\u1eebng team Thi\u1ebfu chu\u1ea9n ho\u00e1, kh\u00f3 maintain h\u1ec7 th\u1ed1ng l\u1edbn","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-009-api-governance/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Contract Testing: ADR-010</li> <li>Deployment Strategy: ADR-010</li> <li>CI/CD Strategy: ADR-001</li> </ul> <p>\u201cAPI t\u1ed1t l\u00e0 t\u00e0i li\u1ec7u \u2013 nh\u01b0ng API c\u00f3 governance t\u1ed1t l\u00e0 t\u00e0i s\u1ea3n c\u1ee7a c\u1ea3 t\u1ed5 ch\u1ee9c.\u201d</p>","tags":["api","governance","versioning","standards","dx-vas"]},{"location":"ADR/adr-010-contract-testing/","title":"ADR-010: Contract Testing gi\u1eefa c\u00e1c d\u1ecbch v\u1ee5","text":"","tags":["contract-testing","pact","integration","api","dx-vas"]},{"location":"ADR/adr-010-contract-testing/#boi-canh","title":"B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas bao g\u1ed3m nhi\u1ec1u service giao ti\u1ebfp qua HTTP ho\u1eb7c Pub/Sub. Vi\u1ec7c \u0111\u1ea3m b\u1ea3o c\u00e1c service t\u01b0\u01a1ng t\u00e1c \u0111\u00fang v\u1edbi nhau (h\u1ee3p \u0111\u1ed3ng API kh\u00f4ng b\u1ecb ph\u00e1 v\u1ee1 khi c\u1eadp nh\u1eadt) l\u00e0 r\u1ea5t quan tr\u1ecdng, \u0111\u1eb7c bi\u1ec7t trong m\u00f4 h\u00ecnh microservices \u0111a tenant.</p> <p>Contract testing s\u1ebd gi\u00fap ph\u00e1t hi\u1ec7n s\u1edbm l\u1ed7i t\u01b0\u01a1ng th\u00edch khi c\u00f3 thay \u0111\u1ed5i schema, \u0111\u1ea7u v\u00e0o/\u0111\u1ea7u ra, ho\u1eb7c khi c\u00e1c team ph\u00e1t tri\u1ec3n \u0111\u1ed9c l\u1eadp.</p>","tags":["contract-testing","pact","integration","api","dx-vas"]},{"location":"ADR/adr-010-contract-testing/#quyet-inh","title":"Quy\u1ebft \u0111\u1ecbnh","text":"","tags":["contract-testing","pact","integration","api","dx-vas"]},{"location":"ADR/adr-010-contract-testing/#1-ap-dung-hinh-thuc-contract-testing","title":"1. \u00c1p d\u1ee5ng h\u00ecnh th\u1ee9c contract testing","text":"<ul> <li>S\u1eed d\u1ee5ng m\u00f4 h\u00ecnh Consumer-Driven Contract Testing</li> <li>Tools \u0111\u1ec1 xu\u1ea5t: Pact, Dredd, ho\u1eb7c custom test runners</li> <li>C\u00e1c consumer (Gateway, Frontend, Service kh\u00e1c) \u0111\u1ecbnh ngh\u0129a expectation \u2192 producer (Sub Service) cam k\u1ebft \u0111\u00e1p \u1ee9ng</li> </ul>","tags":["contract-testing","pact","integration","api","dx-vas"]},{"location":"ADR/adr-010-contract-testing/#2-contract-testing-phai-ho-tro-tenant-context","title":"2. Contract testing ph\u1ea3i h\u1ed7 tr\u1ee3 tenant context","text":"<p>V\u1edbi m\u00f4 h\u00ecnh multi-tenant, m\u1ecdi l\u1eddi g\u1ecdi service \u0111\u1ec1u c\u00f3 ng\u1eef c\u1ea3nh <code>tenant_id</code>, <code>user_id</code>, <code>roles</code>, v.v.</p> <p>Do \u0111\u00f3, contract test c\u1ea7n bao g\u1ed3m:</p> <ul> <li>Header: <code>x-tenant-id</code>, <code>authorization (Bearer &lt;jwt&gt;)</code></li> <li>Payload c\u00f3 ch\u1ee9a: <code>user_id</code>, ho\u1eb7c th\u00f4ng tin RBAC li\u00ean quan</li> <li>Response ph\u00f9 h\u1ee3p v\u1edbi d\u1eef li\u1ec7u trong ng\u1eef c\u1ea3nh tenant c\u1ee5 th\u1ec3</li> </ul>","tags":["contract-testing","pact","integration","api","dx-vas"]},{"location":"ADR/adr-010-contract-testing/#3-cac-nhom-service-can-testing","title":"3. C\u00e1c nh\u00f3m service c\u1ea7n testing","text":"Service Consumer M\u1ee5c ti\u00eau contract Sub User Service Auth Service / Gateway \u0110\u1ea3m b\u1ea3o cung c\u1ea5p \u0111\u00fang <code>roles</code>, <code>permissions</code> cho <code>user_id</code>, <code>tenant_id</code> Sub Notification Service Notification Master \u0110\u1ea3m b\u1ea3o nh\u1eadn s\u1ef1 ki\u1ec7n <code>global_notification_requested</code> v\u00e0 ph\u1ea3n h\u1ed3i \u0111\u00fang Sub Auth Service Frontend / Gateway \u0110\u1ea3m b\u1ea3o login OTP tr\u1ea3 JWT \u0111\u00fang \u0111\u1ecbnh d\u1ea1ng, context SIS Adapter Sub User Service Tr\u1ea3 th\u00f4ng tin h\u1ecdc sinh \u0111\u00fang RBAC/tenant context","tags":["contract-testing","pact","integration","api","dx-vas"]},{"location":"ADR/adr-010-contract-testing/#4-ket-noi-voi-cicd","title":"4. K\u1ebft n\u1ed1i v\u1edbi CI/CD","text":"<ul> <li>M\u1ed7i PR v\u00e0o service ph\u1ea3i ch\u1ea1y contract test li\u00ean quan</li> <li>N\u1ebfu h\u1ee3p \u0111\u1ed3ng b\u1ecb thay \u0111\u1ed5i \u2192 y\u00eau c\u1ea7u ph\u00ea duy\u1ec7t t\u1eeb consumer t\u01b0\u01a1ng \u1ee9ng</li> <li>Contracts \u0111\u01b0\u1ee3c l\u01b0u \u1edf repo ri\u00eang ho\u1eb7c c\u00f9ng repo backend (trong th\u01b0 m\u1ee5c <code>/contracts</code>)</li> </ul>","tags":["contract-testing","pact","integration","api","dx-vas"]},{"location":"ADR/adr-010-contract-testing/#he-qua","title":"H\u1ec7 qu\u1ea3","text":"<p>\u2705 \u01afu \u0111i\u1ec3m:</p> <ul> <li>Gi\u1ea3m thi\u1ec3u l\u1ed7i kh\u00f4ng t\u01b0\u01a1ng th\u00edch gi\u1eefa c\u00e1c d\u1ecbch v\u1ee5</li> <li>B\u1ea3o v\u1ec7 lu\u1ed3ng x\u00e1c th\u1ef1c v\u00e0 ph\u00e2n quy\u1ec1n \u0111a tenant</li> <li>Ph\u00e1t hi\u1ec7n s\u1edbm sai kh\u00e1c n\u1ebfu service thay \u0111\u1ed5i (VD: schema, auth claim, error format)</li> </ul> <p>\u26a0\ufe0f L\u01b0u \u00fd:</p> <ul> <li>Contract test c\u1ea7n d\u1eef li\u1ec7u m\u1eabu theo t\u1eebng <code>tenant_id</code></li> <li>JWT test n\u00ean d\u00f9ng fixture/generator thay v\u00ec token th\u1eadt</li> <li>M\u1ed9t s\u1ed1 service s\u1eed d\u1ee5ng Pub/Sub c\u1ea7n th\u00eam test listener gi\u1ea3 l\u1eadp (ho\u1eb7c s\u1eed d\u1ee5ng test harness)</li> </ul>","tags":["contract-testing","pact","integration","api","dx-vas"]},{"location":"ADR/adr-010-contract-testing/#lien-ket-lien-quan","title":"Li\u00ean k\u1ebft li\u00ean quan","text":"<ul> <li><code>adr-006-auth-strategy.md</code></li> <li><code>adr-007-rbac.md</code></li> <li><code>README.md#15-testing--contract</code></li> </ul> <p>\u201cContract testing l\u00e0 c\u00e1ch \u0111\u1ec3 c\u00e1c d\u1ecbch v\u1ee5 giao ti\u1ebfp b\u1eb1ng s\u1ef1 tin c\u1eady \u2013 ch\u1ee9 kh\u00f4ng ph\u1ea3i ni\u1ec1m tin m\u00f9 qu\u00e1ng.\u201d</p>","tags":["contract-testing","pact","integration","api","dx-vas"]},{"location":"ADR/adr-011-api-error-format/","title":"ADR-011: API Error Format","text":"","tags":["api","error","format","dx-vas"]},{"location":"ADR/adr-011-api-error-format/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>C\u00e1c d\u1ecbch v\u1ee5 API c\u1ee7a dx-vas ph\u1ee5c v\u1ee5 web, mobile, admin dashboard v\u00e0 service-to-service. Sau Change Request 03-cr-token-service (gi\u1edbi thi\u1ec7u TokenService &amp; namespace m\u00e3 l\u1ed7i) y\u00eau c\u1ea7u m\u1ecdi service th\u1ed1ng nh\u1ea5t c\u1ea5u tr\u00fac l\u1ed7i v\u00e0 quy \u01b0\u1edbc \u0111\u1eb7t t\u00ean <code>error.code</code> \u0111\u1ec3:</p> <ul> <li>Frontend/i18n d\u1ecbch th\u00f4ng b\u00e1o d\u1ec5 d\u00e0ng.  </li> <li>Gateway &amp; observability truy v\u1ea5n log theo <code>namespace.*</code>.  </li> <li>TokenService, Auth, Gateway d\u00f9ng chung b\u1ea3ng m\u00e3 l\u1ed7i (token., session., \u2026) :contentReference[oaicite:0]{index=0}.</li> </ul>","tags":["api","error","format","dx-vas"]},{"location":"ADR/adr-011-api-error-format/#quyet-inh","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh","text":"","tags":["api","error","format","dx-vas"]},{"location":"ADR/adr-011-api-error-format/#1-errorenvelope-chuan","title":"1. ErrorEnvelope chu\u1ea9n","text":"<pre><code>{\n  \"error\": {\n    \"code\": \"&lt;namespace.error_key&gt;\",\n    \"message\": \"&lt;Human-readable&gt;\",\n    \"details\": { /* optional for debug */ }\n  },\n  \"meta\": {\n    \"timestamp\": \"2025-06-09T12:34:56Z\",\n    \"trace_id\": \"trace-xyz\",\n    \"service\": \"api_gateway\"\n  }\n}\n</code></pre> <ul> <li>HTTP status v\u1eabn tu\u00e2n th\u1ee7 REST (<code>400</code>, <code>401</code>, <code>403</code>, <code>404</code>, <code>409</code>, <code>422</code>, <code>500</code>\u2026).</li> <li><code>meta.trace_id</code> kh\u1edbp h\u1ec7 th\u1ed1ng tracing; lu\u00f4n c\u00f3 timestamp.</li> <li><code>error.details</code> ch\u1ec9 d\u00f9ng n\u1ed9i b\u1ed9; kh\u00f4ng tr\u1ea3 PII ra ngo\u00e0i.</li> </ul>","tags":["api","error","format","dx-vas"]},{"location":"ADR/adr-011-api-error-format/#2-quy-uoc-errorcode","title":"2. Quy \u01b0\u1edbc <code>error.code</code>","text":"<ul> <li>C\u1ea5u tr\u00fac: <code>namespace.error_key</code> (snake_case).</li> <li> <p>Danh s\u00e1ch ch\u00ednh th\u1ee9c duy tr\u00ec t\u1ea1i docs/standards/error-codes.md .</p> </li> <li> <p>V\u00ed d\u1ee5: <code>token.expired</code>, <code>session.not_found</code>, <code>auth.unauthorized</code>, <code>common.validation_failed</code>.</p> </li> <li>M\u1ed7i service \u0111\u0103ng k\u00fd namespace m\u1edbi qua PR c\u1eadp nh\u1eadt file chu\u1ea9n.</li> </ul>","tags":["api","error","format","dx-vas"]},{"location":"ADR/adr-011-api-error-format/#3-mapping-http-errorcode","title":"3. Mapping HTTP \u2194 <code>error.code</code>","text":"HTTP Namespace v\u00ed d\u1ee5 Ghi ch\u00fa 400 <code>common.validation_failed</code> Payload sai ho\u1eb7c thi\u1ebfu tr\u01b0\u1eddng 401 <code>auth.unauthorized</code> Thi\u1ebfu token 403 <code>auth.permission_denied</code> Kh\u00f4ng \u0111\u1ee7 quy\u1ec1n 404 <code>user.not_found</code>, <code>session.not_found</code> Kh\u00f4ng t\u00ecm th\u1ea5y resource / phi\u00ean 409 <code>user.already_exists</code> Xung \u0111\u1ed9t 422 <code>token.invalid</code> JWT sai ch\u1eef k\u00fd or malformed 500 <code>common.internal_error</code> L\u1ed7i kh\u00f4ng x\u00e1c \u0111\u1ecbnh","tags":["api","error","format","dx-vas"]},{"location":"ADR/adr-011-api-error-format/#4-inh-nghia-openapi-schema-tham-chieu-adr-012","title":"4. \u0110\u1ecbnh ngh\u0129a OpenAPI Schema (tham chi\u1ebfu ADR-012)","text":"<pre><code>components:\n  schemas:\n    ApiErrorInternal:\n      type: object\n      required: [code, message]\n      properties:\n        code:\n          type: string\n          example: token.expired\n        message:\n          type: string\n          example: Token \u0111\u00e3 h\u1ebft h\u1ea1n\n        details:\n          type: object\n          additionalProperties: true\n    ApiErrorResponse:\n      type: object\n      properties:\n        error:\n          $ref: '#/components/schemas/ApiErrorInternal'\n        meta:\n          $ref: '#/components/schemas/ResponseMeta'\n</code></pre> <p>(<code>ResponseMeta</code> \u0111\u1ecbnh ngh\u0129a t\u1ea1i ADR-012 \u2013 Response Structure).</p>","tags":["api","error","format","dx-vas"]},{"location":"ADR/adr-011-api-error-format/#5-vi-du-phan-hoi","title":"5. V\u00ed d\u1ee5 ph\u1ea3n h\u1ed3i","text":"","tags":["api","error","format","dx-vas"]},{"location":"ADR/adr-011-api-error-format/#loi-token-het-han","title":"\u274c L\u1ed7i token h\u1ebft h\u1ea1n","text":"<pre><code>{\n  \"error\": {\n    \"code\": \"token.expired\",\n    \"message\": \"Phi\u00ean \u0111\u0103ng nh\u1eadp \u0111\u00e3 h\u1ebft h\u1ea1n, vui l\u00f2ng \u0111\u0103ng nh\u1eadp l\u1ea1i.\"\n  },\n  \"meta\": {\n    \"timestamp\": \"2025-06-09T12:00:00Z\",\n    \"trace_id\": \"trace-token-123\",\n    \"service\": \"api_gateway\"\n  }\n}\n</code></pre>","tags":["api","error","format","dx-vas"]},{"location":"ADR/adr-011-api-error-format/#thanh-cong","title":"\u2705 Th\u00e0nh c\u00f4ng","text":"<pre><code>{\n  \"data\": {\n    \"user_id\": \"u123\",\n    \"roles\": [\"student\"]\n  },\n  \"error\": null,\n  \"meta\": {\n    \"timestamp\": \"2025-06-09T12:00:05Z\",\n    \"trace_id\": \"trace-token-123\",\n    \"service\": \"token_service\"\n  }\n}\n</code></pre>","tags":["api","error","format","dx-vas"]},{"location":"ADR/adr-011-api-error-format/#6-tich-hop-ci","title":"6. T\u00edch h\u1ee3p &amp; CI","text":"<ul> <li>Middleware m\u1ed7i service t\u1ef1 \u0111\u1ed9ng \u0111\u00f3ng g\u00f3i l\u1ed7i th\u00e0nh ErrorEnvelope.</li> <li>CI linter ki\u1ec3m tra t\u1ea5t c\u1ea3 response m\u1eabu (OpenAPI) ph\u1ea3i d\u1eabn xu\u1ea5t t\u1eeb <code>ApiErrorResponse</code>.</li> <li>Wrapper client (frontend &amp; inter-service) b\u1eaft <code>error.code</code> \u0111\u1ec3 x\u1eed l\u00fd logic/i18n.</li> </ul>","tags":["api","error","format","dx-vas"]},{"location":"ADR/adr-011-api-error-format/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>Nh\u1ea5t qu\u00e1n to\u00e0n h\u1ec7 th\u1ed1ng, d\u1ec5 debug v\u00e0 monitor.</li> <li>D\u1ec5 m\u1edf r\u1ed9ng namespace m\u1edbi m\u00e0 kh\u00f4ng ph\u00e1 v\u1ee1 client.</li> <li>B\u1ea3o m\u1eadt: chi ti\u1ebft debug \u1ea9n sau <code>details</code>, ch\u1ec9 log n\u1ed9i b\u1ed9.</li> </ul>","tags":["api","error","format","dx-vas"]},{"location":"ADR/adr-011-api-error-format/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p Service legacy ch\u01b0a theo chu\u1ea9n Wrapper chuy\u1ec3n \u0111\u1ed5i &amp; task tech-debt trong roadmap \u0110\u1ed9i dev \u0111\u1eb7t <code>error.code</code> tr\u00f9ng l\u1eb7p PR b\u1eaft bu\u1ed9c c\u1eadp nh\u1eadt <code>error-codes.md</code>, code-review Qu\u00ean g\u1eedi <code>trace_id</code> / <code>timestamp</code> Middleware t\u1ef1 \u0111\u1ed9ng b\u1ed5 sung, CI unit-test enforced","tags":["api","error","format","dx-vas"]},{"location":"ADR/adr-011-api-error-format/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Change Request: 03-cr-token-service.md </li> <li>M\u00e3 l\u1ed7i chu\u1ea9n: Error Codes Standard </li> <li>Auth Strategy: ADR-006</li> <li>Response Structure: ADR-012</li> <li>API Governance: ADR-009</li> </ul> <p>\u201cL\u1ed7i l\u00e0 \u0111i\u1ec1u kh\u00f4ng tr\u00e1nh kh\u1ecfi \u2013 chu\u1ea9n h\u00f3a c\u00e1ch ta n\u00f3i v\u1ec1 l\u1ed7i m\u1edbi l\u00e0 ch\u00eca kh\u00f3a cho h\u1ec7 th\u1ed1ng \u0111\u00e1ng tin c\u1eady.\u201d</p>","tags":["api","error","format","dx-vas"]},{"location":"ADR/adr-012-response-structure/","title":"ADR-012 - Chu\u1ea9n h\u00f3a c\u1ea5u tr\u00fac ph\u1ea3n h\u1ed3i (API Response Structure) cho h\u1ec7 th\u1ed1ng dx-vas","text":"","tags":["api","design","response","standard","dx-vas"]},{"location":"ADR/adr-012-response-structure/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>C\u00e1c API trong h\u1ec7 th\u1ed1ng dx-vas c\u1ea7n \u0111\u1ea3m b\u1ea3o:</p> <ul> <li>Frontend c\u00f3 th\u1ec3 x\u1eed l\u00fd response d\u1ec5 d\u00e0ng v\u00e0 \u0111\u1ed3ng nh\u1ea5t</li> <li>C\u00e1c service c\u00f3 th\u1ec3 t\u00edch h\u1ee3p v\u1edbi nhau v\u1edbi \u00edt c\u00f4ng s\u1ee9c chuy\u1ec3n \u0111\u1ed5i \u0111\u1ecbnh d\u1ea1ng</li> <li>D\u1eef li\u1ec7u, l\u1ed7i, v\u00e0 th\u00f4ng tin ph\u1ee5 tr\u1ee3 (metadata) \u0111\u01b0\u1ee3c t\u00e1ch b\u1ea1ch r\u00f5 r\u00e0ng</li> </ul> <p>Hi\u1ec7n t\u1ea1i, m\u1ed9t s\u1ed1 API tr\u1ea3 v\u1ec1:</p> <ul> <li>D\u1eef li\u1ec7u g\u1ed1c (list, object)</li> <li>D\u1eef li\u1ec7u g\u00f3i trong <code>{data: ...}</code></li> <li>M\u1ed9t s\u1ed1 c\u00f3 th\u00eam <code>{meta}</code>, s\u1ed1 kh\u00e1c th\u00ec kh\u00f4ng</li> </ul> <p>\u0110i\u1ec1u n\u00e0y g\u00e2y kh\u00f3 kh\u0103n khi th\u1ed1ng nh\u1ea5t v\u00e0 t\u00edch h\u1ee3p \u0111a h\u1ec7 th\u1ed1ng (API Gateway, CRM Adapter, LMS Proxy, Notification Service...).</p>","tags":["api","design","response","standard","dx-vas"]},{"location":"ADR/adr-012-response-structure/#quyet-inh","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh","text":"<p>Chu\u1ea9n h\u00f3a t\u1ea5t c\u1ea3 API tr\u1ea3 v\u1ec1 c\u1ea5u tr\u00fac ph\u1ea3n h\u1ed3i d\u1ea1ng JSON:</p> <pre><code>{\n  \"data\": {...},\n  \"error\": null,\n  \"meta\": {...}\n}\n</code></pre> <ul> <li><code>data</code>: n\u1ed9i dung ch\u00ednh m\u00e0 API tr\u1ea3 v\u1ec1 (c\u00f3 th\u1ec3 l\u00e0 object, list, null)</li> <li><code>error</code>: null n\u1ebfu th\u00e0nh c\u00f4ng, ho\u1eb7c object l\u1ed7i tu\u00e2n th\u1ee7 ho\u00e0n to\u00e0n theo ADR-011, g\u1ed3m <code>code</code>, <code>message</code>, <code>details</code></li> <li><code>meta</code>: th\u00f4ng tin ph\u1ee5 tr\u1ee3 c\u1ee7a response, lu\u00f4n bao g\u1ed3m <code>timestamp</code> v\u00e0 <code>trace_id</code> nh\u01b0 trong ADR-011, c\u00f3 th\u1ec3 m\u1edf r\u1ed9ng th\u00eam nh\u01b0 <code>pagination</code>, <code>version</code>, <code>source</code>, <code>duration_ms</code>...</li> </ul>","tags":["api","design","response","standard","dx-vas"]},{"location":"ADR/adr-012-response-structure/#mau-phan-hoi-chi-tiet","title":"\ud83d\udce6 M\u1eabu ph\u1ea3n h\u1ed3i chi ti\u1ebft","text":"","tags":["api","design","response","standard","dx-vas"]},{"location":"ADR/adr-012-response-structure/#truong-hop-thanh-cong-http-200","title":"\u2705 Tr\u01b0\u1eddng h\u1ee3p th\u00e0nh c\u00f4ng (HTTP 200)","text":"<pre><code>{\n  \"data\": {\n    \"student_id\": \"s_123\",\n    \"name\": \"Nguy\u1ec5n V\u0103n A\",\n    \"class\": \"5A\"\n  },\n  \"error\": null,\n  \"meta\": {\n    \"timestamp\": \"2025-06-22T12:00:00Z\",\n    \"trace_id\": \"trace-success-xyz789\",\n    \"version\": \"v1\",\n    \"source\": \"lms_proxy\"\n  }\n}\n</code></pre>","tags":["api","design","response","standard","dx-vas"]},{"location":"ADR/adr-012-response-structure/#truong-hop-loi-http-404","title":"\u274c Tr\u01b0\u1eddng h\u1ee3p l\u1ed7i (HTTP 404)","text":"<pre><code>{\n  \"data\": null,\n  \"error\": {\n    \"code\": \"STUDENT_NOT_FOUND\",\n    \"message\": \"Kh\u00f4ng t\u00ecm th\u1ea5y h\u1ecdc sinh v\u1edbi ID s_999\",\n    \"details\": {\n      \"student_id\": \"s_999\"\n    }\n  },\n  \"meta\": {\n    \"timestamp\": \"2025-06-22T12:01:00Z\",\n    \"trace_id\": \"abc-1234\",\n    \"source\": \"lms_proxy\"\n  }\n}\n</code></pre>","tags":["api","design","response","standard","dx-vas"]},{"location":"ADR/adr-012-response-structure/#nguyen-tac-ap-dung","title":"\ud83d\udd27 Nguy\u00ean t\u1eafc \u00e1p d\u1ee5ng","text":"<ul> <li>Lu\u00f4n c\u00f3 \u0111\u1ee7 3 tr\u01b0\u1eddng <code>data</code>, <code>error</code>, <code>meta</code> trong m\u1ecdi response</li> <li>N\u1ebfu l\u1ed7i x\u1ea3y ra, <code>data = null</code>, <code>error</code> ch\u1ee9a th\u00f4ng tin l\u1ed7i chu\u1ea9n \u2192 tham chi\u1ebfu <code>adr-011</code></li> <li>N\u1ebfu th\u00e0nh c\u00f4ng, <code>error = null</code></li> <li><code>meta</code> lu\u00f4n bao g\u1ed3m <code>timestamp</code>, <code>trace_id</code>, v\u00e0 c\u00f3 th\u1ec3 m\u1edf r\u1ed9ng th\u00eam c\u00e1c tr\u01b0\u1eddng nh\u01b0: <code>pagination</code>, <code>version</code>, <code>source</code>, <code>duration_ms</code></li> </ul>","tags":["api","design","response","standard","dx-vas"]},{"location":"ADR/adr-012-response-structure/#tich-hop-ci-openapi","title":"\ud83d\udee0 T\u00edch h\u1ee3p CI &amp; OpenAPI","text":"<pre><code>ApiResponse:\n  type: object\n  required:\n    - data\n    - error\n    - meta\n  properties:\n    data: {}\n    error:\n      type: object\n      nullable: true\n      required:\n        - code\n        - message\n      properties:\n        code:\n          type: string\n          description: M\u00e3 l\u1ed7i t\u0129nh.\n        message:\n          type: string\n          description: M\u00f4 t\u1ea3 l\u1ed7i d\u00e0nh cho ng\u01b0\u1eddi d\u00f9ng.\n        details:\n          type: object\n          nullable: true\n          description: Th\u00f4ng tin chi ti\u1ebft b\u1ed5 sung cho vi\u1ec7c g\u1ee1 l\u1ed7i (t\u00f9y ch\u1ecdn).\n          additionalProperties: true\n    meta:\n      $ref: '#/components/schemas/ResponseMeta'\n\nResponseMeta:\n  type: object\n  required:\n    - timestamp\n    - trace_id\n  properties:\n    timestamp:\n      type: string\n      format: date-time\n      description: Th\u1eddi \u0111i\u1ec3m t\u1ea1o response.\n    trace_id:\n      type: string\n      description: ID duy nh\u1ea5t \u0111\u1ec3 theo d\u00f5i request qua c\u00e1c h\u1ec7 th\u1ed1ng.\n    source:\n      type: string\n      description: T\u00ean service t\u1ea1o ra response.\n    version:\n      type: string\n      description: Phi\u00ean b\u1ea3n c\u1ee7a API.\n    duration_ms:\n      type: integer\n      description: Th\u1eddi gian x\u1eed l\u00fd request (n\u1ebfu c\u00f3)\n</code></pre> <ul> <li>Check trong CI linter: endpoint n\u00e0o kh\u00f4ng tr\u1ea3 v\u1ec1 \u0111\u1ee7 3 field s\u1ebd b\u1ecb c\u1ea3nh b\u00e1o</li> <li>M\u1eabu response chu\u1ea9n \u0111\u01b0\u1ee3c render trong Swagger / Redoc cho t\u1ea5t c\u1ea3 d\u1ecbch v\u1ee5</li> </ul>","tags":["api","design","response","standard","dx-vas"]},{"location":"ADR/adr-012-response-structure/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>Frontend d\u1ec5 d\u00e0ng x\u00e2y d\u1ef1ng handler cho response chung</li> <li>D\u1ec5 log, th\u1ed1ng k\u00ea, ph\u00e2n t\u00edch request/response to\u00e0n h\u1ec7 th\u1ed1ng</li> <li>Giao ti\u1ebfp service-to-service r\u00f5 r\u00e0ng, d\u1ec5 test v\u00e0 mock</li> <li>\u0110\u1ed3ng b\u1ed9 v\u1edbi error handling (<code>adr-011</code>) v\u00e0 API Governance (<code>adr-009</code>)</li> </ul>","tags":["api","design","response","standard","dx-vas"]},{"location":"ADR/adr-012-response-structure/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p M\u1ed9t s\u1ed1 service legacy ch\u01b0a chuy\u1ec3n \u0111\u1ed5i Cung c\u1ea5p wrapper chu\u1ea9n \u0111\u1ec3 h\u1ed7 tr\u1ee3 nhanh chuy\u1ec3n \u0111\u1ed5i D\u1eef li\u1ec7u qu\u00e1 l\u1edbn d\u1eabn \u0111\u1ebfn response n\u1eb7ng S\u1eed d\u1ee5ng paging, limit, lazy loading ho\u1eb7c exclude <code>meta</code> n\u1ebfu kh\u00f4ng c\u1ea7n Frontend qu\u00ean ki\u1ec3m tra <code>error</code> v\u00e0 d\u00f9ng tr\u1ef1c ti\u1ebfp <code>data</code> Lint ho\u1eb7c wrapper \u1edf client \u0111\u1ec3 enforce quy t\u1eafc x\u1eed l\u00fd response","tags":["api","design","response","standard","dx-vas"]},{"location":"ADR/adr-012-response-structure/#cac-phuong-an-a-loai-bo","title":"\ud83d\udd04 C\u00e1c ph\u01b0\u01a1ng \u00e1n \u0111\u00e3 lo\u1ea1i b\u1ecf","text":"Ph\u01b0\u01a1ng \u00e1n L\u00fd do kh\u00f4ng ch\u1ecdn Tr\u1ea3 tr\u1ef1c ti\u1ebfp object ho\u1eb7c list Kh\u00f4ng ph\u00e2n bi\u1ec7t r\u00f5 th\u00e0nh c\u00f4ng/th\u1ea5t b\u1ea1i Tr\u1ea3 ri\u00eang c\u1ea5u tr\u00fac cho t\u1eebng API G\u00e2y r\u1ed1i lo\u1ea1n, kh\u00f3 b\u1ea3o tr\u00ec v\u00e0 t\u00edch h\u1ee3p","tags":["api","design","response","standard","dx-vas"]},{"location":"ADR/adr-012-response-structure/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>API Error format: ADR-011</li> <li>API Governance: ADR-009</li> <li>CI/CD Strategy: ADR-001</li> </ul> <p>\"API kh\u00f4ng ch\u1ec9 c\u1ea7n \u0111\u00fang d\u1eef li\u1ec7u \u2013 m\u00e0 c\u00f2n c\u1ea7n \u0111\u00fang \u0111\u1ecbnh d\u1ea1ng.\"</p>","tags":["api","design","response","standard","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/","title":"ADR-013 - Quy \u01b0\u1edbc \u0111\u1eb7t t\u00ean endpoint, method v\u00e0 tham s\u1ed1 cho API h\u1ec7 th\u1ed1ng dx-vas","text":"","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>Trong h\u1ec7 th\u1ed1ng dx-vas, nhi\u1ec1u API \u0111\u01b0\u1ee3c ph\u00e1t tri\u1ec3n b\u1edfi c\u00e1c \u0111\u1ed9i kh\u00e1c nhau. M\u1ed9t s\u1ed1 inconsistency ph\u1ed5 bi\u1ebfn \u0111\u00e3 x\u1ea3y ra: - Endpoint d\u1ea1ng <code>/getAllStudents</code>, <code>/updateCourse</code>, kh\u00f4ng tu\u00e2n theo chu\u1ea9n REST - Tham s\u1ed1 c\u00f3 l\u00fac l\u00e0 <code>snake_case</code>, l\u00fac l\u1ea1i <code>camelCase</code> - \u0110\u00f4i khi action \u0111\u01b0\u1ee3c encode v\u00e0o t\u00ean path thay v\u00ec d\u00f9ng HTTP method \u0111\u00fang c\u00e1ch</p> <p>\u0110i\u1ec1u n\u00e0y g\u00e2y kh\u00f3 kh\u0103n cho: - Ng\u01b0\u1eddi d\u00f9ng API (frontend, mobile, service kh\u00e1c) - Vi\u1ec7c sinh t\u00e0i li\u1ec7u t\u1ef1 \u0111\u1ed9ng t\u1eeb OpenAPI - Kh\u1ea3 n\u0103ng ph\u00e2n t\u00edch logs v\u00e0 theo d\u00f5i endpoint</p>","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#quyet-inh","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh","text":"<p>\u00c1p d\u1ee5ng chu\u1ea9n RESTful + \u0111\u1eb7t t\u00ean nh\u1ea5t qu\u00e1n cho path, method v\u00e0 tham s\u1ed1 API to\u00e0n h\u1ec7 th\u1ed1ng, tu\u00e2n theo quy \u01b0\u1edbc c\u1ee5 th\u1ec3 sau.</p>","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#quy-uoc-at-ten-path","title":"\ud83d\udccf Quy \u01b0\u1edbc \u0111\u1eb7t t\u00ean path","text":"","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#ten-tai-nguyen-dung-so-nhieu-snake_case-tieng-anh","title":"\u2705 T\u00ean t\u00e0i nguy\u00ean d\u00f9ng s\u1ed1 nhi\u1ec1u, <code>snake_case</code>, ti\u1ebfng Anh","text":"<ul> <li>V\u00ed d\u1ee5: <code>/students</code>, <code>/courses</code>, <code>/teachers</code></li> <li>N\u1ebfu truy c\u1eadp 1 ph\u1ea7n t\u1eed: <code>/students/{student_id}</code></li> </ul>","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#dung-tien-to-version-apiv1","title":"\u2705 D\u00f9ng ti\u1ec1n t\u1ed1 version: <code>/api/v1/...</code>","text":"","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#khong-encode-hanh-ong-vao-ten-path","title":"\u2705 Kh\u00f4ng encode h\u00e0nh \u0111\u1ed9ng v\u00e0o t\u00ean path","text":"<ul> <li>\u274c Kh\u00f4ng d\u00f9ng: <code>/createStudent</code>, <code>/getAllCourses</code>, <code>/deleteUser</code></li> <li>\u2705 Thay b\u1eb1ng:</li> <li><code>POST /students</code></li> <li><code>GET /courses</code></li> <li><code>DELETE /users/{id}</code></li> </ul>","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#hanh-ong-ac-biet-dung-sub-path-dang-ong-tu","title":"\u2705 H\u00e0nh \u0111\u1ed9ng \u0111\u1eb7c bi\u1ec7t d\u00f9ng sub-path d\u1ea1ng \u0111\u1ed9ng t\u1eeb","text":"<ul> <li><code>POST /students/{id}/deactivate</code></li> <li><code>POST /classes/{id}/assign</code></li> <li>Lu\u00f4n document r\u00f5 action n\u00e0y l\u00e0 \u201ccustom\u201d</li> </ul>","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#tham-so-path-dung-snake_case","title":"\u2705 Tham s\u1ed1 path d\u00f9ng <code>snake_case</code>","text":"<ul> <li><code>GET /students/{student_id}</code> (not <code>studentId</code> or <code>StudentId</code>)</li> </ul>","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#quy-uoc-http-method","title":"\u2699\ufe0f Quy \u01b0\u1edbc HTTP Method","text":"Method M\u1ee5c \u0111\u00edch V\u00ed d\u1ee5 <code>GET</code> L\u1ea5y d\u1eef li\u1ec7u <code>GET /students</code>, <code>GET /students/{id}</code> <code>POST</code> T\u1ea1o m\u1edbi <code>POST /students</code> <code>PUT</code> Ghi \u0111\u00e8 to\u00e0n b\u1ed9 <code>PUT /students/{id}</code> <code>PATCH</code> C\u1eadp nh\u1eadt m\u1ed9t ph\u1ea7n <code>PATCH /students/{id}</code> <code>DELETE</code> Xo\u00e1 <code>DELETE /students/{id}</code>","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#quy-uoc-tham-so-truy-van-query-param","title":"\ud83d\udd0d Quy \u01b0\u1edbc tham s\u1ed1 truy v\u1ea5n (query param)","text":"","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#ten-tham-so-snake_case-ro-nghia","title":"\u2705 T\u00ean tham s\u1ed1 <code>snake_case</code>, r\u00f5 ngh\u0129a","text":"<ul> <li><code>?class_id=5A&amp;page=2&amp;limit=20</code></li> </ul>","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#paging-su-dung-page-limit","title":"\u2705 Paging: s\u1eed d\u1ee5ng <code>page</code>, <code>limit</code>","text":"<ul> <li><code>page</code>: s\u1ed1 trang b\u1eaft \u0111\u1ea7u t\u1eeb 1</li> <li><code>limit</code>: s\u1ed1 ph\u1ea7n t\u1eed t\u1ed1i \u0111a m\u1ed7i trang</li> <li>V\u00ed d\u1ee5: <code>?page=2&amp;limit=10</code> \u2192 l\u1ea5y ph\u1ea7n t\u1eed th\u1ee9 11 \u0111\u1ebfn 20</li> </ul>","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#sap-xep-dung-sort_by-order","title":"\u2705 S\u1eafp x\u1ebfp: d\u00f9ng <code>sort_by</code>, <code>order</code>","text":"<ul> <li><code>sort_by</code>: t\u00ean field \u0111\u1ec3 s\u1eafp x\u1ebfp (v\u00ed d\u1ee5: <code>created_at</code>, <code>score</code>)</li> <li><code>order</code>: h\u01b0\u1edbng s\u1eafp x\u1ebfp, nh\u1eadn gi\u00e1 tr\u1ecb <code>asc</code> ho\u1eb7c <code>desc</code> (m\u1eb7c \u0111\u1ecbnh l\u00e0 <code>asc</code> n\u1ebfu kh\u00f4ng c\u00f3)</li> <li>Quy \u01b0\u1edbc \u00e1p d\u1ee5ng khi s\u1eafp x\u1ebfp nhi\u1ec1u tr\u01b0\u1eddng:</li> <li>D\u00f9ng ti\u1ec1n t\u1ed1 <code>-</code> tr\u01b0\u1edbc t\u00ean field \u0111\u1ec3 ch\u1ec9 <code>desc</code>, kh\u00f4ng c\u00f3 ti\u1ec1n t\u1ed1 l\u00e0 <code>asc</code></li> <li>V\u00ed d\u1ee5: <code>?sort_by=-created_at,name</code> \u2192 s\u1eafp x\u1ebfp <code>created_at DESC, name ASC</code></li> </ul>","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#kiem-tra-tu-ong","title":"\ud83e\uddea Ki\u1ec3m tra t\u1ef1 \u0111\u1ed9ng","text":"<ul> <li>T\u00edch h\u1ee3p linter v\u00e0o CI/CD \u0111\u1ec3 b\u1eaft endpoint sai \u0111\u1ecbnh d\u1ea1ng</li> <li>Lint rule cho OpenAPI generator \u0111\u1ec3 enforce path/method/param \u0111\u00fang</li> </ul>","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>Gi\u1ea3m chi ph\u00ed h\u1ecdc API cho dev m\u1edbi, client</li> <li>T\u0103ng kh\u1ea3 n\u0103ng sinh docs, test, mock t\u1ef1 \u0111\u1ed9ng</li> <li>Th\u1ed1ng nh\u1ea5t khi log v\u00e0 monitor endpoint API</li> </ul>","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p C\u00e1c API legacy kh\u00f4ng theo chu\u1ea9n C\u00f3 layer chuy\u1ec3n \u0111\u1ed5i t\u1ea1m (alias route), ho\u1eb7c b\u1ed5 sung docs c\u1ea3nh b\u00e1o M\u1ed9t s\u1ed1 action \u0111\u1eb7c bi\u1ec7t kh\u00f4ng th\u1ec3 bi\u1ec3u di\u1ec5n b\u1eb1ng REST Cho ph\u00e9p d\u00f9ng <code>/resource/{id}/action</code> d\u1ea1ng POST, nh\u01b0ng ph\u1ea3i document r\u00f5","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#cac-phuong-an-a-loai-bo","title":"\ud83d\udd04 C\u00e1c ph\u01b0\u01a1ng \u00e1n \u0111\u00e3 lo\u1ea1i b\u1ecf","text":"Ph\u01b0\u01a1ng \u00e1n L\u00fd do kh\u00f4ng ch\u1ecdn \u0110\u1eb7t t\u00ean tu\u1ef3 \u00fd theo h\u00e0nh \u0111\u1ed9ng (get, create...) Vi ph\u1ea1m chu\u1ea9n REST, kh\u00f3 sinh tool/docs D\u00f9ng camelCase trong path/params Kh\u00f4ng th\u1ed1ng nh\u1ea5t v\u1edbi ph\u1ea7n c\u00f2n l\u1ea1i (\u0111a s\u1ed1 codebase snake_case)","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-013-path-naming-convention/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>API Error format: ADR-011</li> <li>API Governance: ADR-009</li> <li>CI/CD Strategy: ADR-001</li> </ul> <p>\"M\u1ed9t API t\u1ed1t \u0111\u01b0\u1ee3c nh\u1eadn bi\u1ebft kh\u00f4ng ch\u1ec9 qua d\u1eef li\u1ec7u n\u00f3 tr\u1ea3 \u2013 m\u00e0 qua c\u00e1ch n\u00f3 \u0111\u1eb7t t\u00ean.\"</p>","tags":["api","naming","path","rest","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/","title":"ADR-014 - Chi\u1ebfn l\u01b0\u1ee3c Tri\u1ec3n khai Kh\u00f4ng Gi\u00e1n \u0110o\u1ea1n (Zero-Downtime Deployment) cho h\u1ec7 th\u1ed1ng dx-vas","text":"","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas bao g\u1ed3m nhi\u1ec1u lo\u1ea1i d\u1ecbch v\u1ee5: - API Gateway (critical) - C\u00e1c backend adapters (LMS, CRM, Notification) - Frontend WebApp (Admin, Portal)</p> <p>C\u00e1c d\u1ecbch v\u1ee5 n\u00e0y \u0111\u01b0\u1ee3c tri\u1ec3n khai tr\u00ean n\u1ec1n t\u1ea3ng Google Cloud Run, v\u1ed1n h\u1ed7 tr\u1ee3 rolling update v\u00e0 traffic splitting qua revision. Tuy nhi\u00ean, n\u1ebfu tri\u1ec3n khai kh\u00f4ng \u0111\u00fang c\u00e1ch, v\u1eabn c\u00f3 th\u1ec3 g\u00e2y: - M\u1ea5t phi\u00ean l\u00e0m vi\u1ec7c (session/token invalid) - L\u1ed7i b\u1ea5t t\u01b0\u01a1ng th\u00edch schema khi database ho\u1eb7c contract kh\u00f4ng backward-compatible - Tr\u1ea1ng th\u00e1i t\u1ea1m th\u1eddi \"n\u1eeda version n\u00e0y, n\u1eeda version kh\u00e1c\" g\u00e2y l\u1ed7i frontend/backend</p>","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#quyet-inh","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh","text":"<p>\u00c1p d\u1ee5ng chi\u1ebfn l\u01b0\u1ee3c tri\u1ec3n khai kh\u00f4ng gi\u00e1n \u0111o\u1ea1n (zero-downtime) cho to\u00e0n h\u1ec7 th\u1ed1ng dx-vas, b\u1eb1ng c\u00e1ch s\u1eed d\u1ee5ng Cloud Run revision, ki\u1ec3m so\u00e1t traffic shifting, \u0111\u1ea3m b\u1ea3o backward compatibility v\u00e0 ki\u1ec3m th\u1eed k\u1ef9 tr\u01b0\u1edbc khi full rollout.</p>","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#nguyen-tac-trien-khai-an-toan","title":"\ud83e\udde9 Nguy\u00ean t\u1eafc tri\u1ec3n khai an to\u00e0n","text":"","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#1-su-dung-revision-trong-cloud-run","title":"1. S\u1eed d\u1ee5ng Revision trong Cloud Run","text":"<ul> <li>M\u1ed7i deploy t\u1ea1o ra 1 revision m\u1edbi \u2192 kh\u00f4ng ghi \u0111\u00e8</li> <li>Revisions \u0111\u01b0\u1ee3c \u0111\u1ecbnh danh theo Git SHA ho\u1eb7c <code>app_version</code></li> </ul>","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#2-traffic-splitting-canary","title":"2. Traffic Splitting / Canary","text":"<ul> <li>B\u1eaft \u0111\u1ea7u v\u1edbi <code>1%</code>, <code>10%</code>, <code>25%</code>, <code>50%</code> \u2192 ki\u1ec3m tra log, error rate, latency</li> <li>Sau \u0111\u00f3 m\u1edbi <code>100%</code> \u2192 stable rollout</li> <li>C\u00f3 th\u1ec3 rollback ngay v\u1ec1 revision c\u0169 n\u1ebfu l\u1ed7i xu\u1ea5t hi\u1ec7n</li> </ul>","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#3-backward-compatibility-bc","title":"3. Backward Compatibility (BC)","text":"<ul> <li>M\u1ecdi API m\u1edbi ph\u1ea3i:</li> <li>Gi\u1eef nguy\u00ean format response c\u0169</li> <li>Kh\u00f4ng b\u1eaft bu\u1ed9c c\u00e1c field m\u1edbi khi deserialize (frontend, consumer)</li> <li>\u0110\u1ea3m b\u1ea3o DB migration l\u00e0 additive (<code>ADD COLUMN</code>, kh\u00f4ng <code>DROP</code>/<code>RENAME</code> ngay)</li> </ul>","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#4-db-migration-an-toan","title":"4. DB Migration an to\u00e0n","text":"<ul> <li>Migration t\u00e1ch bi\u1ec7t kh\u1ecfi deploy (ch\u1ea1y tr\u01b0\u1edbc)</li> <li>Add field tr\u01b0\u1edbc \u2013 app d\u00f9ng field sau</li> <li>Sau khi deploy \u1ed5n \u0111\u1ecbnh \u2192 cleanup field c\u0169 (qua release sau)</li> </ul>","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#5-health-check-startup-readiness","title":"5. Health Check &amp; Startup Readiness","text":"<ul> <li>S\u1eed d\u1ee5ng <code>startup probe</code> ho\u1eb7c <code>readiness probe</code> \u0111\u1ec3 tr\u00e1nh nh\u1eadn traffic qu\u00e1 s\u1edbm</li> <li>B\u1eaft bu\u1ed9c tr\u1ea3 HTTP 200 t\u1ea1i <code>/healthz</code>, <code>/readyz</code> tr\u01b0\u1edbc khi nh\u1eadn request th\u1eadt</li> </ul>","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#6-sessiontoken-stability","title":"6. Session/Token Stability","text":"<ul> <li>JWT k\u00fd v\u1edbi key ch\u01b0a thay \u0111\u1ed5i \u2192 client kh\u00f4ng b\u1ecb logout</li> <li>Kh\u00f4ng x\u00f3a refresh token / session store trong qu\u00e1 tr\u00ecnh deploy</li> </ul>","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#tich-hop-cicd","title":"\ud83e\uddea T\u00edch h\u1ee3p CI/CD","text":"<ul> <li>Tri\u1ec3n khai staging auto 100% traffic khi merge v\u00e0o <code>dev</code></li> <li>Tri\u1ec3n khai production manual + canary khi merge v\u00e0o <code>main</code></li> <li>Canary theo tag: <code>--tag canary-v1</code></li> <li>Rollback qua UI ho\u1eb7c <code>gcloud run services update-traffic</code></li> </ul>","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#ap-dung-linh-hoat-theo-dich-vu","title":"\ud83d\udd27 \u00c1p d\u1ee5ng linh ho\u1ea1t theo d\u1ecbch v\u1ee5","text":"Lo\u1ea1i service Chi\u1ebfn l\u01b0\u1ee3c c\u1ee5 th\u1ec3 API Gateway Canary + rollout ch\u1eb7t, BC nghi\u00eam ng\u1eb7t LMS/CRM Adapter C\u00f3 th\u1ec3 rollout nhanh h\u01a1n, mi\u1ec5n kh\u00f4ng vi ph\u1ea1m contract Frontend Webapp Tri\u1ec3n khai SSR Cloud Run \u2192 n\u00ean d\u00f9ng Canary n\u1ebfu g\u1eafn session/token Notification Service \u00cdt critical h\u01a1n \u2192 rollout nhanh, test k\u1ef9 queue retry","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>Tr\u00e1nh downtime g\u00e2y gi\u00e1n \u0111o\u1ea1n cho ng\u01b0\u1eddi d\u00f9ng</li> <li>Tri\u1ec3n khai c\u00f3 th\u1ec3 rollback nhanh ch\u00f3ng</li> <li>\u0110\u1ea3m b\u1ea3o \u1ed5n \u0111\u1ecbnh h\u1ec7 th\u1ed1ng d\u00f9 \u0111ang n\u00e2ng c\u1ea5p</li> </ul>","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p \u0110\u1ea9y traffic qu\u00e1 nhanh \u2192 kh\u00f4ng ph\u00e1t hi\u1ec7n l\u1ed7i k\u1ecbp Chia nh\u1ecf canary, theo d\u00f5i error rate, latency B\u1ea5t t\u01b0\u01a1ng th\u00edch DB \u2192 l\u1ed7i runtime Lu\u00f4n ch\u1ea1y migration t\u00e1ch bi\u1ec7t, forward-compatible tr\u01b0\u1edbc Version mismatch gi\u1eefa frontend/backend D\u00f9ng header <code>X-App-Version</code>, log mismatch, tr\u00e1nh breaking change","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#cac-phuong-an-a-loai-bo","title":"\ud83d\udd04 C\u00e1c ph\u01b0\u01a1ng \u00e1n \u0111\u00e3 lo\u1ea1i b\u1ecf","text":"Ph\u01b0\u01a1ng \u00e1n L\u00fd do kh\u00f4ng ch\u1ecdn Redeploy \u0111\u00e8 revision (default) Kh\u00f4ng rollback \u0111\u01b0\u1ee3c, d\u1ec5 m\u1ea5t session, kh\u00f3 trace l\u1ed7i Manual rollout kh\u00f4ng ki\u1ec3m so\u00e1t traffic Kh\u00f4ng ph\u00f9 h\u1ee3p h\u1ec7 th\u1ed1ng c\u1ea7n SLA cao","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-014-zero-downtime/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>API Governance: ADR-009</li> <li>CI/CD Strategy: ADR-001</li> <li>Env Config: ADR-005</li> </ul> <p>\u201cTri\u1ec3n khai kh\u00f4ng gi\u00e1n \u0111o\u1ea1n kh\u00f4ng ph\u1ea3i l\u00e0 may m\u1eafn \u2013 m\u00e0 l\u00e0 k\u1ef9 thu\u1eadt.\u201d</p>","tags":["deployment","cloud-run","traffic-split","dx-vas"]},{"location":"ADR/adr-015-deployment-strategy/","title":"ADR-015: Chi\u1ebfn l\u01b0\u1ee3c Tri\u1ec3n khai (Deployment Strategy)","text":"","tags":["deployment","strategy","cloud-run","ci-cd","dx-vas"]},{"location":"ADR/adr-015-deployment-strategy/#boi-canh","title":"B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas c\u1ea7n h\u1ed7 tr\u1ee3 v\u1eadn h\u00e0nh \u1ed5n \u0111\u1ecbnh cho nhi\u1ec1u tr\u01b0\u1eddng th\u00e0nh vi\u00ean (tenant), v\u1edbi c\u00e1c y\u00eau c\u1ea7u:</p> <ul> <li>T\u00e1ch bi\u1ec7t m\u00f4i tr\u01b0\u1eddng c\u1ee7a t\u1eebng tenant \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o b\u1ea3o m\u1eadt v\u00e0 t\u00ednh \u1ed5n \u0111\u1ecbnh</li> <li>D\u1ec5 d\u00e0ng m\u1edf r\u1ed9ng khi c\u00f3 tenant m\u1edbi</li> <li>Qu\u1ea3n l\u00fd deployment theo c\u1ee5m d\u1ecbch v\u1ee5 ri\u00eang bi\u1ec7t (core / tenant)</li> <li>\u0110\u1ea3m b\u1ea3o kh\u1ea3 n\u0103ng t\u1ef1 \u0111\u1ed9ng h\u00f3a CI/CD, rollback, v\u00e0 gi\u00e1m s\u00e1t theo tenant</li> </ul>","tags":["deployment","strategy","cloud-run","ci-cd","dx-vas"]},{"location":"ADR/adr-015-deployment-strategy/#quyet-inh","title":"Quy\u1ebft \u0111\u1ecbnh","text":"","tags":["deployment","strategy","cloud-run","ci-cd","dx-vas"]},{"location":"ADR/adr-015-deployment-strategy/#1-kien-truc-trien-khai-tong-the","title":"1. Ki\u1ebfn tr\u00fac tri\u1ec3n khai t\u1ed5ng th\u1ec3","text":"<p>H\u1ec7 th\u1ed1ng \u0111\u01b0\u1ee3c chia l\u00e0m 2 nh\u00f3m tri\u1ec3n khai ch\u00ednh:</p> Nh\u00f3m N\u1ed9i dung M\u00f4i tr\u01b0\u1eddng Shared Core Services Gateway, Auth Master, User Master, Notification Master, Redis, Pub/Sub <code>dx-vas-core</code> Tenant Stack (per tenant) Frontend apps, Sub Auth, Sub User, CRM/SIS/LMS Adapters, Sub Notification <code>dx-vas-tenant-abc</code>, <code>dx-vas-tenant-xyz</code>, ... <p>M\u1ed7i tenant c\u00f3 th\u1ec3 ch\u1ea1y \u0111\u1ed9c l\u1eadp tr\u00ean m\u1ed9t GCP project ri\u00eang \u2192 d\u1ec5 qu\u1ea3n l\u00fd billing, t\u00e0i nguy\u00ean, b\u1ea3o m\u1eadt.</p>","tags":["deployment","strategy","cloud-run","ci-cd","dx-vas"]},{"location":"ADR/adr-015-deployment-strategy/#2-mo-hinh-project-tren-google-cloud","title":"2. M\u00f4 h\u00ecnh project tr\u00ean Google Cloud","text":"Project Vai tr\u00f2 <code>dx-vas-core</code> D\u1ecbch v\u1ee5 chung (Gateway, Auth/User Master, Redis, Pub/Sub) <code>dx-vas-tenant-[name]</code> Stack ri\u00eang c\u1ee7a t\u1eebng tenant <code>dx-vas-monitoring</code> Gi\u00e1m s\u00e1t, alerting, log t\u1eadp trung <code>dx-vas-data</code> Cloud SQL, BigQuery, GCS d\u00f9ng chung ho\u1eb7c chia theo namespace","tags":["deployment","strategy","cloud-run","ci-cd","dx-vas"]},{"location":"ADR/adr-015-deployment-strategy/#3-ten-mien-va-inh-danh-dich-vu","title":"3. T\u00ean mi\u1ec1n v\u00e0 \u0111\u1ecbnh danh d\u1ecbch v\u1ee5","text":"<ul> <li>M\u1ed7i frontend tenant c\u00f3 domain ri\u00eang: <code>admin.abcschool.edu.vn</code>, <code>portal.xyzschool.edu.vn</code></li> <li>M\u1ed7i d\u1ecbch v\u1ee5 backend \u0111\u01b0\u1ee3c \u0111\u1eb7t theo chu\u1ea9n: <code>auth-service-master</code>, <code>user-service-master</code>, <code>auth-service-[tenant]</code>, <code>user-service-[tenant]</code>, ...</li> <li>API Gateway \u0111\u1ecbnh tuy\u1ebfn theo <code>tenant_id</code> ho\u1eb7c domain/subdomain</li> </ul>","tags":["deployment","strategy","cloud-run","ci-cd","dx-vas"]},{"location":"ADR/adr-015-deployment-strategy/#4-tach-biet-deployment-pipeline","title":"4. T\u00e1ch bi\u1ec7t deployment &amp; pipeline","text":"<ul> <li>CI/CD \u0111\u01b0\u1ee3c chia theo module:</li> <li>Core: <code>gateway/</code>, <code>auth-master/</code>, <code>user-master/</code>, ...</li> <li>Tenant: <code>tenant-[name]/auth/</code>, <code>tenant-[name]/frontend/</code>, ...</li> <li>M\u1ed7i tenant c\u00f3 th\u1ec3 deploy ri\u00eang kh\u00f4ng \u1ea3nh h\u01b0\u1edfng tenant kh\u00e1c</li> <li>Superadmin Webapp c\u00f3 th\u1ec3 kh\u1edfi t\u1ea1o tenant m\u1edbi b\u1eb1ng script (<code>terraform + deploy</code>)</li> </ul>","tags":["deployment","strategy","cloud-run","ci-cd","dx-vas"]},{"location":"ADR/adr-015-deployment-strategy/#5-giam-sat-quan-ly-moi-truong","title":"5. Gi\u00e1m s\u00e1t &amp; qu\u1ea3n l\u00fd m\u00f4i tr\u01b0\u1eddng","text":"<ul> <li>M\u1ed7i tenant c\u00f3 log, alert ri\u00eang bi\u1ec7t (theo project)</li> <li>C\u00f3 kh\u1ea3 n\u0103ng collect to\u00e0n b\u1ed9 log v\u1ec1 Stackdriver chung (theo <code>tenant_id</code>)</li> <li>H\u1ed7 tr\u1ee3 m\u00f4i tr\u01b0\u1eddng <code>dev</code>, <code>staging</code>, <code>prod</code> ri\u00eang bi\u1ec7t per stack</li> </ul>","tags":["deployment","strategy","cloud-run","ci-cd","dx-vas"]},{"location":"ADR/adr-015-deployment-strategy/#he-qua","title":"H\u1ec7 qu\u1ea3","text":"<p>\u2705 \u01afu \u0111i\u1ec3m:</p> <ul> <li>M\u1ed7i tr\u01b0\u1eddng c\u00f3 th\u1ec3 v\u1eadn h\u00e0nh \u0111\u1ed9c l\u1eadp (t\u1eeb x\u00e1c th\u1ef1c \u2192 g\u1eedi th\u00f4ng b\u00e1o)</li> <li>D\u1ec5 scale khi c\u00f3 th\u00eam tenant</li> <li>\u0110\u1ea3m b\u1ea3o isolation v\u1ec1 b\u1ea3o m\u1eadt, performance</li> <li>D\u1ec5 t\u1ed5 ch\u1ee9c CI/CD theo module r\u00f5 r\u00e0ng</li> </ul> <p>\u26a0\ufe0f L\u01b0u \u00fd:</p> <ul> <li>C\u1ea7n chi ph\u00ed tri\u1ec3n khai th\u00eam GCP project v\u00e0 stack per tenant</li> <li>Qu\u1ea3n tr\u1ecb multi-project c\u1ea7n Terraform module chu\u1ea9n h\u00f3a</li> <li>Quy tr\u00ecnh deploy tenant m\u1edbi c\u1ea7n \u0111\u01b0\u1ee3c chu\u1ea9n h\u00f3a k\u1ef9 c\u00e0ng (t\u1ef1 \u0111\u1ed9ng c\u00e0ng t\u1ed1t)</li> </ul>","tags":["deployment","strategy","cloud-run","ci-cd","dx-vas"]},{"location":"ADR/adr-015-deployment-strategy/#lien-ket-lien-quan","title":"Li\u00ean k\u1ebft li\u00ean quan","text":"<ul> <li><code>adr-019-project-layout.md</code></li> <li><code>adr-006-auth-strategy.md</code></li> <li><code>adr-007-rbac.md</code></li> <li><code>system-diagrams.md#5-s\u01a1-\u0111\u1ed3-tri\u1ec3n-khai-h\u1ea1-t\u1ea7ng-deployment-diagram</code></li> </ul> <p>\"Tri\u1ec3n khai \u0111\u00fang kh\u00f4ng ch\u1ec9 l\u00e0 push code \u2013 m\u00e0 l\u00e0 ki\u1ec3m so\u00e1t r\u1ee7i ro v\u00e0 t\u1ea1o ni\u1ec1m tin.\"</p>","tags":["deployment","strategy","cloud-run","ci-cd","dx-vas"]},{"location":"ADR/adr-016-auto-scaling/","title":"ADR-016 - Chi\u1ebfn l\u01b0\u1ee3c Auto Scaling cho h\u1ec7 th\u1ed1ng dx-vas","text":"","tags":["scaling","cloud-run","performance","cost","dx-vas"]},{"location":"ADR/adr-016-auto-scaling/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>C\u00e1c d\u1ecbch v\u1ee5 trong h\u1ec7 th\u1ed1ng dx-vas (API Gateway, LMS Adapter, CRM Proxy, SSR frontend...) \u0111\u1ec1u tri\u1ec3n khai tr\u00ean Google Cloud Run, n\u01a1i m\u1ed7i service c\u00f3 th\u1ec3 scale \u0111\u1ed9c l\u1eadp. Vi\u1ec7c kh\u00f4ng t\u1ed1i \u01b0u h\u00f3a auto scaling s\u1ebd d\u1eabn \u0111\u1ebfn: - Ch\u1eadm ph\u1ea3n h\u1ed3i ho\u1eb7c timeout khi traffic t\u0103ng cao \u0111\u1ed9t ng\u1ed9t - T\u1ed1n chi ph\u00ed khi duy tr\u00ec qu\u00e1 nhi\u1ec1u instance kh\u00f4ng c\u1ea7n thi\u1ebft - D\u1ec5 v\u01b0\u1ee3t quota ho\u1eb7c b\u1ecb rate-limit n\u1ebfu concurrency kh\u00f4ng \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh \u0111\u00fang</p>","tags":["scaling","cloud-run","performance","cost","dx-vas"]},{"location":"ADR/adr-016-auto-scaling/#quyet-inh","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh","text":"<p>\u00c1p d\u1ee5ng chi\u1ebfn l\u01b0\u1ee3c auto scaling t\u1ed1i \u01b0u cho t\u1eebng lo\u1ea1i service trong h\u1ec7 th\u1ed1ng dx-vas, s\u1eed d\u1ee5ng Cloud Run concurrency, min/max instance v\u00e0 metric-based scaling \u0111\u1ec3 c\u00e2n b\u1eb1ng chi ph\u00ed \u2013 hi\u1ec7u n\u0103ng \u2013 \u0111\u1ed9 tin c\u1eady.</p>","tags":["scaling","cloud-run","performance","cost","dx-vas"]},{"location":"ADR/adr-016-auto-scaling/#cau-hinh-cloud-run-e-xuat","title":"\u2699\ufe0f C\u1ea5u h\u00ecnh Cloud Run \u0111\u1ec1 xu\u1ea5t","text":"Lo\u1ea1i service Concurrency Min instance Max instance Kh\u00e1c API Gateway 1 2 (always warm) 10 latency-sensitive LMS/CRM Adapter 10 0 20 x\u1eed l\u00fd IO/batch t\u1ed1t Frontend SSR 2 1 5 c\u1ea7n warm start \u0111\u1ec3 SSR nhanh Notification Service 20 0 5 background burst","tags":["scaling","cloud-run","performance","cost","dx-vas"]},{"location":"ADR/adr-016-auto-scaling/#giai-thich","title":"\u2705 Gi\u1ea3i th\u00edch:","text":"<ul> <li>Concurrency:</li> <li>API Gateway \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh <code>concurrency = 1</code> do \u0111\u1eb7c t\u00ednh latency-sensitive v\u00e0 \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o m\u1ed7i request \u0111\u01b0\u1ee3c x\u1eed l\u00fd nhanh nh\u1ea5t c\u00f3 th\u1ec3 tr\u00ean m\u1ed9t instance, tr\u00e1nh \u1ea3nh h\u01b0\u1edfng l\u1eabn nhau gi\u1eefa c\u00e1c request song song. \u0110i\u1ec1u n\u00e0y gi\u00fap gi\u1ea3m \u0111\u1ed9 tr\u1ec5 t\u1eebng request, nh\u01b0ng c\u00f3 th\u1ec3 d\u1eabn \u0111\u1ebfn c\u1ea7n nhi\u1ec1u instance h\u01a1n khi traffic cao. Gi\u00e1 tr\u1ecb n\u00e0y s\u1ebd \u0111\u01b0\u1ee3c theo d\u00f5i v\u00e0 tinh ch\u1ec9nh d\u1ef1a tr\u00ean k\u1ebft qu\u1ea3 load testing v\u00e0 d\u1eef li\u1ec7u v\u1eadn h\u00e0nh th\u1ef1c t\u1ebf.</li> <li> <p><code>10\u201320</code> cho service IO-bound (adapter, notification)</p> </li> <li> <p>Min instance:</p> </li> <li><code>&gt;0</code> n\u1ebfu mu\u1ed1n warm start (frontend SSR, Gateway)</li> <li> <p><code>0</code> cho service kh\u00f4ng c\u1ea7n s\u1eb5n s\u00e0ng li\u00ean t\u1ee5c (adapter, batch)</p> </li> <li> <p>Max instance:</p> </li> <li>T\u00f9y v\u00e0o quota, chi ph\u00ed v\u00e0 SLA</li> </ul>","tags":["scaling","cloud-run","performance","cost","dx-vas"]},{"location":"ADR/adr-016-auto-scaling/#auto-scaling-theo-metric","title":"\ud83d\udd0d Auto Scaling theo Metric","text":"<p>Cloud Run scale d\u1ef1a tr\u00ean: - CPU utilization - Request latency / concurrency - Traffic volume (HTTP request rate)</p> <p>Ghi ch\u00fa: h\u00e0nh vi \"scale out n\u1ebfu error rate t\u0103ng cao + concurrency &gt; ng\u01b0\u1ee1ng\" l\u00e0 quan s\u00e1t t\u1eeb behavior m\u1eb7c \u0111\u1ecbnh c\u1ee7a Cloud Run, ch\u1ee9 kh\u00f4ng ph\u1ea3i m\u1ed9t h\u00e0nh \u0111\u1ed9ng ch\u1ee7 \u0111\u1ed9ng t\u1ef1 \u0111\u1ed9ng ho\u00e1. Tuy nhi\u00ean, c\u00e1c alert n\u00e0y c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c d\u00f9ng \u0111\u1ec3 trigger h\u00e0nh \u0111\u1ed9ng nh\u01b0 t\u0103ng <code>min_instances</code> t\u1ea1m th\u1eddi ho\u1eb7c ki\u1ec3m tra l\u1ea1i c\u1ea5u h\u00ecnh autoscaling.</p> <p>S\u1ebd t\u00edch h\u1ee3p alert qua: - Cloud Monitoring: alert n\u1ebfu request latency &gt; 2s - Scale out behavior \u0111\u01b0\u1ee3c h\u1ed7 tr\u1ee3 t\u1ef1 \u0111\u1ed9ng, nh\u01b0ng c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c k\u1ebft h\u1ee3p v\u1edbi script \u0111i\u1ec1u ch\u1ec9nh th\u1ee7 c\u00f4ng n\u1ebfu c\u1ea7n</p>","tags":["scaling","cloud-run","performance","cost","dx-vas"]},{"location":"ADR/adr-016-auto-scaling/#tich-hop-cicd-terraform","title":"\ud83d\udee0 T\u00edch h\u1ee3p CI/CD &amp; Terraform","text":"<ul> <li>M\u1ed7i service c\u00f3 file <code>infra.tf</code> \u0111\u1ecbnh ngh\u0129a: <pre><code>resource \"google_cloud_run_service\" \"service_name\" {\n  template {\n    spec {\n      container_concurrency = 10\n      min_instances = 0\n      max_instances = 20\n    }\n  }\n}\n</code></pre></li> <li>GitHub Actions s\u1ebd validate scaling config tr\u01b0\u1edbc deploy (check hard limit, quota)</li> <li>C\u00f3 th\u1ec3 t\u00e1ch autoscaling policy ra file ri\u00eang (module reusable)</li> </ul>","tags":["scaling","cloud-run","performance","cost","dx-vas"]},{"location":"ADR/adr-016-auto-scaling/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>T\u0103ng hi\u1ec7u n\u0103ng khi c\u1ea7n, ti\u1ebft ki\u1ec7m khi idle</li> <li>Tr\u00e1nh cold start v\u1edbi d\u1ecbch v\u1ee5 c\u1ea7n ph\u1ea3n h\u1ed3i nhanh (gateway, frontend SSR)</li> <li>Ch\u1ee7 \u0111\u1ed9ng ki\u1ec3m so\u00e1t chi ph\u00ed Cloud Run</li> </ul>","tags":["scaling","cloud-run","performance","cost","dx-vas"]},{"location":"ADR/adr-016-auto-scaling/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p Scale qu\u00e1 nhanh \u2192 backend overload Gi\u1edbi h\u1ea1n <code>max_instance</code> + alert precondition Cold start g\u00e2y ch\u1eadm cho user \u0111\u1ea7u ti\u00ean Gi\u1eef <code>min_instance &gt; 0</code> cho service critical Thay \u0111\u1ed5i concurrency kh\u00f4ng \u0111\u1ed3ng b\u1ed9 v\u1edbi logic service Document r\u00f5 r\u00e0ng, enforced qua CI review v\u00e0 th\u00f4ng qua load testing k\u1ef9 l\u01b0\u1ee1ng","tags":["scaling","cloud-run","performance","cost","dx-vas"]},{"location":"ADR/adr-016-auto-scaling/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>CI/CD Strategy: ADR-001</li> <li>Zero downtime: ADR-014</li> <li>Deployment Strategy: ADR-015</li> </ul> <p>\u201cAuto Scaling kh\u00f4ng ch\u1ec9 \u0111\u1ec3 ti\u1ebft ki\u1ec7m \u2013 m\u00e0 l\u00e0 \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o b\u1ea1n lu\u00f4n s\u1eb5n s\u00e0ng.\u201d</p>","tags":["scaling","cloud-run","performance","cost","dx-vas"]},{"location":"ADR/adr-017-env-deploy-boundary/","title":"ADR-017 - Quy t\u1eafc tri\u1ec3n khai theo m\u00f4i tr\u01b0\u1eddng cho h\u1ec7 th\u1ed1ng dx-vas","text":"","tags":["environment","deployment","boundary","dx-vas","config"]},{"location":"ADR/adr-017-env-deploy-boundary/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas v\u1eadn h\u00e0nh qua nhi\u1ec1u m\u00f4i tr\u01b0\u1eddng: - <code>dev</code>: ph\u00e1t tri\u1ec3n, test c\u00e1 nh\u00e2n, staging n\u1ed9i b\u1ed9 - <code>staging</code>: ki\u1ec3m th\u1eed t\u00edch h\u1ee3p, pre-prod, tr\u00ecnh di\u1ec5n - <code>production</code>: m\u00f4i tr\u01b0\u1eddng ch\u00ednh th\u1ee9c ph\u1ee5c v\u1ee5 ng\u01b0\u1eddi d\u00f9ng th\u1ef1c - <code>sandbox</code>: d\u00f9ng cho API c\u00f4ng khai b\u00ean ngo\u00e0i</p> <p>C\u00e1c l\u1ed7i tri\u1ec3n khai th\u01b0\u1eddng \u0111\u1ebfn t\u1eeb: - Deploy sai config m\u00f4i tr\u01b0\u1eddng - Rollback nh\u1ea7m gi\u1eefa staging v\u00e0 production - Kh\u00f4ng c\u00f3 quy t\u1eafc r\u00f5 r\u00e0ng v\u1ec1 quy tr\u00ecnh release / \u0111i\u1ec1u ki\u1ec7n cho m\u1ed7i m\u00f4i tr\u01b0\u1eddng</p>","tags":["environment","deployment","boundary","dx-vas","config"]},{"location":"ADR/adr-017-env-deploy-boundary/#quyet-inh","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh","text":"<p>X\u00e1c \u0111\u1ecbnh r\u00f5 r\u00e0ng boundary v\u00e0 \u0111i\u1ec1u ki\u1ec7n tri\u1ec3n khai cho t\u1eebng m\u00f4i tr\u01b0\u1eddng trong h\u1ec7 th\u1ed1ng dx-vas, bao g\u1ed3m quy\u1ec1n h\u1ea1n, lu\u1ed3ng CI/CD, c\u1ea5u h\u00ecnh, v\u00e0 c\u00e1c y\u00eau c\u1ea7u ki\u1ec3m th\u1eed / ph\u00ea duy\u1ec7t.</p>","tags":["environment","deployment","boundary","dx-vas","config"]},{"location":"ADR/adr-017-env-deploy-boundary/#quy-tac-trien-khai-theo-moi-truong","title":"\ud83e\udde9 Quy t\u1eafc tri\u1ec3n khai theo m\u00f4i tr\u01b0\u1eddng","text":"M\u00f4i tr\u01b0\u1eddng M\u1ee5c \u0111\u00edch Tri\u1ec3n khai t\u1eeb branch \u0110i\u1ec1u ki\u1ec7n deploy Ph\u00ea duy\u1ec7t c\u1ea7n thi\u1ebft <code>dev</code> Ph\u00e1t tri\u1ec3n &amp; test <code>feature/*</code>, <code>dev</code> CI pass Kh\u00f4ng <code>staging</code> Ki\u1ec3m th\u1eed t\u00edch h\u1ee3p <code>dev</code>, <code>release/*</code> CI pass + contract test pass Kh\u00f4ng <code>production</code> Public release ch\u00ednh th\u1ee9c <code>main</code> CI pass + manual approval + monitoring ready \u2705 Theo <code>adr-018-release-approval-policy.md</code> <code>sandbox</code> Th\u1eed nghi\u1ec7m API public <code>sandbox</code> ho\u1eb7c t\u00e1ch ri\u00eang t\u1eeb <code>main</code> CI pass \u2705 \u0110\u1ed9i h\u1ea1 t\u1ea7ng approve","tags":["environment","deployment","boundary","dx-vas","config"]},{"location":"ADR/adr-017-env-deploy-boundary/#quy-tac-bao-ve-moi-truong-production","title":"\ud83d\udd12 Quy t\u1eafc b\u1ea3o v\u1ec7 m\u00f4i tr\u01b0\u1eddng production","text":"<ul> <li>Ch\u1ec9 nh\u00f3m <code>Platform</code> ho\u1eb7c ng\u01b0\u1eddi c\u00f3 quy\u1ec1n release m\u1edbi \u0111\u01b0\u1ee3c merge v\u00e0o <code>main</code></li> <li>Pipeline deploy production y\u00eau c\u1ea7u:</li> <li>Check list \u0111\u1ea7y \u0111\u1ee7:<ul> <li>\u2705 Migration \u0111\u00e3 ch\u1ea1y t\u00e1ch bi\u1ec7t</li> <li>\u2705 Contract test pass</li> <li>\u2705 Canary OK (n\u1ebfu \u00e1p d\u1ee5ng)</li> <li>\u2705 Alert \u0111\u00e3 thi\u1ebft l\u1eadp v\u00e0 theo d\u00f5i</li> <li>\u2705 T\u00e0i li\u1ec7u release note</li> </ul> </li> <li>Ph\u00ea duy\u1ec7t ng\u01b0\u1eddi c\u00f3 vai tr\u00f2 <code>release approver</code></li> <li>Sau deploy ph\u1ea3i c\u00f3:</li> <li>Tag version (<code>v1.4.0</code>, ...) trong Git</li> <li>Rollback script kh\u1ea3 d\u1ee5ng (n\u1ebfu c\u1ea7n), theo h\u01b0\u1edbng d\u1eabn rollback trong <code>adr-015-deployment-strategy.md</code></li> </ul>","tags":["environment","deployment","boundary","dx-vas","config"]},{"location":"ADR/adr-017-env-deploy-boundary/#cau-hinh-runtime-theo-moi-truong","title":"\ud83d\udd27 C\u1ea5u h\u00ecnh runtime theo m\u00f4i tr\u01b0\u1eddng","text":"<ul> <li>D\u00f9ng file <code>.env</code>, <code>config.json</code> ho\u1eb7c bi\u1ebfn m\u00f4i tr\u01b0\u1eddng</li> <li>C\u1ea5u h\u00ecnh s\u1ebd kh\u00e1c theo env:</li> <li>DB endpoint</li> <li>JWT signing key</li> <li>Email, webhook, storage bucket</li> <li>External API key (Zalo, Firebase...)</li> <li>File v\u00ed d\u1ee5: <pre><code>.env.development\n.env.staging\n.env.production\n</code></pre></li> <li>\u0110\u01b0\u1ee3c load b\u1eb1ng <code>pydantic-settings</code>, <code>dotenv</code>, ho\u1eb7c config server</li> <li>Xem th\u00eam h\u01b0\u1edbng d\u1eabn chi ti\u1ebft trong <code>adr-005-env-config.md</code></li> </ul>","tags":["environment","deployment","boundary","dx-vas","config"]},{"location":"ADR/adr-017-env-deploy-boundary/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>H\u1ea1n ch\u1ebf l\u1ed7i do tri\u1ec3n khai nh\u1ea7m m\u00f4i tr\u01b0\u1eddng</li> <li>R\u00f5 r\u00e0ng quy\u1ec1n v\u00e0 tr\u00e1ch nhi\u1ec7m theo t\u1eebng env</li> <li>D\u1ec5 thi\u1ebft l\u1eadp CI/CD pipeline ri\u00eang cho t\u1eebng giai \u0111o\u1ea1n</li> <li>Chu\u1ea9n b\u1ecb t\u1ed1t h\u01a1n cho audit, rollback, tracking release</li> </ul>","tags":["environment","deployment","boundary","dx-vas","config"]},{"location":"ADR/adr-017-env-deploy-boundary/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p Nh\u1ea7m m\u00f4i tr\u01b0\u1eddng khi deploy Pipeline enforce branch-env mapping Rollback kh\u00f4ng chu\u1ea9n gi\u1eefa env C\u00f3 file rollback ri\u00eang + tag r\u00f5 r\u00e0ng version, tham kh\u1ea3o <code>adr-015</code> Kh\u00f4ng t\u00e1ch bi\u1ec7t d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m gi\u1eefa env D\u00f9ng secrets ri\u00eang, Cloud Secret Manager theo env, tham kh\u1ea3o <code>adr-003-secrets.md</code>","tags":["environment","deployment","boundary","dx-vas","config"]},{"location":"ADR/adr-017-env-deploy-boundary/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>CI/CD Strategy: ADR-001</li> <li>Env Config: ADR-005</li> <li>Secrets: ADR-003</li> <li>Deployment Strategy: ADR-015</li> <li>Release Approval Policy: ADR-018</li> </ul> <p>\u201cM\u1ed9t m\u00f4i tr\u01b0\u1eddng \u0111\u01b0\u1ee3c b\u1ea3o v\u1ec7 t\u1ed1t ch\u00ednh l\u00e0 l\u1edbp ph\u00f2ng th\u1ee7 \u0111\u1ea7u ti\u00ean cho h\u1ec7 th\u1ed1ng production.\u201d</p>","tags":["environment","deployment","boundary","dx-vas","config"]},{"location":"ADR/adr-018-release-approval-policy/","title":"ADR-018: Ch\u00ednh s\u00e1ch Ph\u00ea duy\u1ec7t Ph\u00e1t h\u00e0nh (Release Approval Policy)","text":"","tags":["release","approval","rollback","dx-vas","production"]},{"location":"ADR/adr-018-release-approval-policy/#boi-canh","title":"B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas v\u1eadn h\u00e0nh theo m\u00f4 h\u00ecnh multi-tenant. M\u1ed7i tenant l\u00e0 m\u1ed9t tr\u01b0\u1eddng th\u00e0nh vi\u00ean, c\u00f3 stack ri\u00eang (frontend, backend, adapter), \u0111\u01b0\u1ee3c deploy tr\u00ean GCP project ri\u00eang.</p> <p>C\u00e1c d\u1ecbch v\u1ee5 core (Gateway, Auth Master, User Master...) \u0111\u01b0\u1ee3c chia s\u1ebb gi\u1eefa c\u00e1c tenant v\u00e0 c\u1ea7n \u0111\u1ed9 \u1ed5n \u0111\u1ecbnh cao. V\u00ec v\u1eady, h\u1ec7 th\u1ed1ng c\u1ea7n m\u1ed9t ch\u00ednh s\u00e1ch ph\u00ea duy\u1ec7t ph\u00e1t h\u00e0nh r\u00f5 r\u00e0ng, h\u1ed7 tr\u1ee3:</p> <ul> <li>Ph\u00e1t h\u00e0nh nhanh cho c\u00e1c tenant (khi c\u1ea7n fix l\u1ed7i ri\u00eang)</li> <li>Ph\u00ea duy\u1ec7t ch\u1eb7t ch\u1ebd cho c\u00e1c thay \u0111\u1ed5i h\u1ec7 th\u1ed1ng d\u00f9ng chung</li> <li>T\u1ef1 \u0111\u1ed9ng ho\u00e1 pipeline CI/CD nh\u01b0ng v\u1eabn \u0111\u1ea3m b\u1ea3o ki\u1ec3m so\u00e1t ch\u1ea5t l\u01b0\u1ee3ng</li> </ul>","tags":["release","approval","rollback","dx-vas","production"]},{"location":"ADR/adr-018-release-approval-policy/#quyet-inh","title":"Quy\u1ebft \u0111\u1ecbnh","text":"","tags":["release","approval","rollback","dx-vas","production"]},{"location":"ADR/adr-018-release-approval-policy/#1-tach-pipeline-theo-nhom","title":"1. T\u00e1ch pipeline theo nh\u00f3m","text":"Nh\u00f3m d\u1ecbch v\u1ee5 V\u00ed d\u1ee5 Ph\u00ea duy\u1ec7t Core Services Gateway, Auth Master, User Master, Notification Master Ph\u1ea3i ph\u00ea duy\u1ec7t th\u1ee7 c\u00f4ng tr\u00ean m\u00f4i tr\u01b0\u1eddng staging tr\u01b0\u1edbc khi l\u00ean production Tenant Services Sub Auth, Sub User, Frontend Tenant A/B C\u00f3 th\u1ec3 t\u1ef1 \u0111\u1ed9ng n\u1ebfu qua test, ho\u1eb7c y\u00eau c\u1ea7u duy\u1ec7t t\u00f9y tenant","tags":["release","approval","rollback","dx-vas","production"]},{"location":"ADR/adr-018-release-approval-policy/#2-nguyen-tac-phe-duyet","title":"2. Nguy\u00ean t\u1eafc ph\u00ea duy\u1ec7t","text":"<ul> <li>Core services:</li> <li>Ph\u1ea3i c\u00f3 staging ri\u00eang</li> <li>Ph\u1ea3i ch\u1ea1y to\u00e0n b\u1ed9 test (unit + integration)</li> <li> <p>Ch\u1ec9 release sau khi \u0111\u01b0\u1ee3c Superadmin ho\u1eb7c DevOps Lead duy\u1ec7t th\u1ee7 c\u00f4ng</p> </li> <li> <p>Tenant stack:</p> </li> <li>M\u1ed7i tenant c\u00f3 m\u00f4i tr\u01b0\u1eddng staging ri\u00eang (VD: <code>staging-tenant-a.dx-vas.vn</code>)</li> <li>C\u00f3 th\u1ec3 ph\u00ea duy\u1ec7t t\u1ef1 \u0111\u1ed9ng n\u1ebfu:<ul> <li>Thay \u0111\u1ed5i kh\u00f4ng \u1ea3nh h\u01b0\u1edfng schema / auth / rbac</li> <li>CI/CD ch\u1ea1y pass to\u00e0n b\u1ed9 ki\u1ec3m th\u1eed</li> </ul> </li> <li>N\u1ebfu thay \u0111\u1ed5i l\u1edbn \u2192 y\u00eau c\u1ea7u duy\u1ec7t b\u1edfi qu\u1ea3n tr\u1ecb vi\u00ean k\u1ef9 thu\u1eadt tenant (ho\u1eb7c Superadmin n\u1ebfu nghi\u00eam tr\u1ecdng)</li> </ul>","tags":["release","approval","rollback","dx-vas","production"]},{"location":"ADR/adr-018-release-approval-policy/#3-cong-cu-va-audit","title":"3. C\u00f4ng c\u1ee5 v\u00e0 audit","text":"<ul> <li>S\u1eed d\u1ee5ng GitHub Actions + Approval Gates + m\u00f4i tr\u01b0\u1eddng <code>environments</code></li> <li>M\u1ecdi h\u00e0nh \u0111\u1ed9ng ph\u00ea duy\u1ec7t \u0111\u1ec1u \u0111\u01b0\u1ee3c log trong GitHub v\u00e0 chuy\u1ec3n v\u1ec1 Cloud Audit</li> <li>C\u00f3 webhook g\u1eedi notification khi release th\u00e0nh c\u00f4ng cho t\u1eebng tenant (qua Zalo/Slack)</li> </ul>","tags":["release","approval","rollback","dx-vas","production"]},{"location":"ADR/adr-018-release-approval-policy/#4-trien-khai-a-moi-truong","title":"4. Tri\u1ec3n khai \u0111a m\u00f4i tr\u01b0\u1eddng","text":"<ul> <li><code>dev</code>: t\u1ef1 \u0111\u1ed9ng ph\u00e1t h\u00e0nh sau khi merge \u2192 \u0111\u1ec3 test nhanh</li> <li><code>staging</code>: m\u00f4i tr\u01b0\u1eddng trung gian, b\u1eaft bu\u1ed9c ki\u1ec3m th\u1eed th\u1ee7 c\u00f4ng v\u1edbi d\u1eef li\u1ec7u th\u1eadt (clone)</li> <li><code>prod</code>: m\u00f4i tr\u01b0\u1eddng ch\u00ednh th\u1ee9c, ch\u1ec9 ph\u00e1t h\u00e0nh sau ph\u00ea duy\u1ec7t (core v\u00e0 tenant)</li> </ul>","tags":["release","approval","rollback","dx-vas","production"]},{"location":"ADR/adr-018-release-approval-policy/#he-qua","title":"H\u1ec7 qu\u1ea3","text":"<p>\u2705 \u01afu \u0111i\u1ec3m:</p> <ul> <li>Ki\u1ec3m so\u00e1t ch\u1eb7t ch\u1ebd c\u00e1c thay \u0111\u1ed5i \u1ea3nh h\u01b0\u1edfng to\u00e0n h\u1ec7 th\u1ed1ng</li> <li>Tenant v\u1eabn c\u00f3 s\u1ef1 linh ho\u1ea1t cao \u0111\u1ec3 ph\u00e1t h\u00e0nh ri\u00eang</li> <li>Ph\u00e2n bi\u1ec7t r\u00f5 tr\u00e1ch nhi\u1ec7m qu\u1ea3n l\u00fd gi\u1eefa Superadmin v\u00e0 qu\u1ea3n tr\u1ecb tenant</li> <li>T\u1ed1i \u01b0u CI/CD theo m\u00f4 h\u00ecnh t\u00e1ch stack</li> </ul> <p>\u26a0\ufe0f L\u01b0u \u00fd:</p> <ul> <li>C\u1ea7n quy tr\u00ecnh rollback nhanh n\u1ebfu release l\u1ed7i</li> <li>Pipeline ph\u1ee9c t\u1ea1p h\u01a1n n\u1ebfu s\u1ed1 tenant t\u0103ng nhi\u1ec1u \u2192 n\u00ean gom pipeline theo template</li> </ul>","tags":["release","approval","rollback","dx-vas","production"]},{"location":"ADR/adr-018-release-approval-policy/#lien-ket-lien-quan","title":"Li\u00ean k\u1ebft li\u00ean quan","text":"<ul> <li><code>adr-015-deployment-strategy.md</code></li> <li><code>adr-019-project-layout.md</code></li> <li><code>README.md#11-ci-cd--release-approval</code></li> </ul> <p>\"M\u1ed9t b\u1ea3n release t\u1ed1t b\u1eaft \u0111\u1ea7u t\u1eeb s\u1ef1 chu\u1ea9n b\u1ecb k\u1ef9 v\u00e0 k\u1ebft th\u00fac b\u1eb1ng kh\u1ea3 n\u0103ng rollback t\u1ed1t h\u01a1n.\"</p>","tags":["release","approval","rollback","dx-vas","production"]},{"location":"ADR/adr-019-project-layout/","title":"ADR-019: Chi\u1ebfn l\u01b0\u1ee3c chia t\u00e1ch project GCP (Project Layout Strategy)","text":"","tags":["iac","gcp","terraform","networking","multi-project","dx-vas"]},{"location":"ADR/adr-019-project-layout/#boi-canh","title":"B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas tri\u1ec3n khai tr\u00ean Google Cloud Platform (GCP), v\u1edbi y\u00eau c\u1ea7u:</p> <ul> <li>Ph\u00e2n chia r\u00f5 r\u00e0ng t\u00e0i nguy\u00ean gi\u1eefa c\u00e1c kh\u1ed1i ch\u1ee9c n\u0103ng (core vs tenant)</li> <li>H\u1ed7 tr\u1ee3 t\u00e1ch chi ph\u00ed theo tenant</li> <li>D\u1ec5 m\u1edf r\u1ed9ng khi c\u00f3 th\u00eam tr\u01b0\u1eddng m\u1edbi</li> <li>H\u1ed7 tr\u1ee3 tri\u1ec3n khai, gi\u00e1m s\u00e1t v\u00e0 b\u1ea3o m\u1eadt theo t\u1eebng \u0111\u01a1n v\u1ecb \u0111\u1ed9c l\u1eadp</li> </ul>","tags":["iac","gcp","terraform","networking","multi-project","dx-vas"]},{"location":"ADR/adr-019-project-layout/#quyet-inh","title":"Quy\u1ebft \u0111\u1ecbnh","text":"","tags":["iac","gcp","terraform","networking","multi-project","dx-vas"]},{"location":"ADR/adr-019-project-layout/#1-phan-chia-project-theo-nhom-chuc-nang","title":"1. Ph\u00e2n chia project theo nh\u00f3m ch\u1ee9c n\u0103ng","text":"<p>H\u1ec7 th\u1ed1ng \u0111\u01b0\u1ee3c chia th\u00e0nh c\u00e1c GCP project nh\u01b0 sau:</p> Project Vai tr\u00f2 <code>dx-vas-core</code> D\u1ecbch v\u1ee5 chung to\u00e0n h\u1ec7 th\u1ed1ng: Gateway, Auth Master, User Master, Notification Master, Redis, Pub/Sub <code>dx-vas-tenant-abc</code>, <code>dx-vas-tenant-xyz</code>, ... M\u1ed7i tr\u01b0\u1eddng (tenant) c\u00f3 project ri\u00eang ch\u1ee9a: Frontend App, Sub Auth, Sub User, CRM/SIS/LMS Adapter, Sub Notification <code>dx-vas-monitoring</code> Log t\u1eadp trung, Alerting, Metrics (Stackdriver / Cloud Monitoring) <code>dx-vas-data</code> Cloud SQL, BigQuery, GCS ph\u1ee5c v\u1ee5 d\u1eef li\u1ec7u chia s\u1ebb ho\u1eb7c t\u00edch h\u1ee3p BI","tags":["iac","gcp","terraform","networking","multi-project","dx-vas"]},{"location":"ADR/adr-019-project-layout/#2-uu-iem-cua-mo-hinh-nay","title":"2. \u01afu \u0111i\u1ec3m c\u1ee7a m\u00f4 h\u00ecnh n\u00e0y","text":"<ul> <li>Isolation m\u1ea1nh: m\u1ed7i tenant c\u00e1ch ly v\u1ec1 network, t\u00e0i nguy\u00ean, log, secret</li> <li>T\u00e1ch billing: chi ph\u00ed theo tenant, ph\u1ee5c v\u1ee5 b\u00e1o c\u00e1o n\u1ed9i b\u1ed9 ho\u1eb7c kh\u00e1ch h\u00e0ng</li> <li>T\u1ef1 \u0111\u1ed9ng h\u00f3a linh ho\u1ea1t: m\u1ed7i project c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c kh\u1edfi t\u1ea1o t\u1eeb module Terraform ri\u00eang</li> <li>Ph\u00e2n quy\u1ec1n IAM r\u00f5 r\u00e0ng: team DevOps t\u1eebng tr\u01b0\u1eddng ch\u1ec9 c\u1ea7n quy\u1ec1n tr\u00ean project t\u01b0\u01a1ng \u1ee9ng</li> </ul>","tags":["iac","gcp","terraform","networking","multi-project","dx-vas"]},{"location":"ADR/adr-019-project-layout/#3-nguyen-tac-inh-danh-dich-vu","title":"3. Nguy\u00ean t\u1eafc \u0111\u1ecbnh danh d\u1ecbch v\u1ee5","text":"<ul> <li>T\u00ean d\u1ecbch v\u1ee5 theo chu\u1ea9n:  </li> <li><code>auth-service-master</code>, <code>user-service-master</code>, <code>notification-master</code></li> <li><code>auth-service-[tenant]</code>, <code>user-service-[tenant]</code>, <code>frontend-[tenant]</code>, ...</li> <li>Subdomain theo tenant:  </li> <li><code>admin.abcschool.edu.vn</code>, <code>portal.xyzschool.edu.vn</code></li> </ul>","tags":["iac","gcp","terraform","networking","multi-project","dx-vas"]},{"location":"ADR/adr-019-project-layout/#4-networking-truy-cap-noi-bo","title":"4. Networking &amp; truy c\u1eadp n\u1ed9i b\u1ed9","text":"<ul> <li>C\u00e1c service n\u1ed9i b\u1ed9 giao ti\u1ebfp qua API Gateway (tri\u1ec3n khai t\u1ea1i <code>dx-vas-core</code>)</li> <li>Gateway \u0111\u1ecbnh tuy\u1ebfn theo <code>tenant_id</code>, ho\u1eb7c host/domain t\u00f9y context</li> <li>N\u1ebfu c\u1ea7n giao ti\u1ebfp n\u1ed9i b\u1ed9 (master \u2192 sub), s\u1eed d\u1ee5ng service token ho\u1eb7c mTLS + header <code>X-Internal-Call</code></li> <li>Sub Service ch\u1ec9 nh\u1eadn request t\u1eeb API Gateway (qua VPC connector ho\u1eb7c ingress restriction)</li> </ul>","tags":["iac","gcp","terraform","networking","multi-project","dx-vas"]},{"location":"ADR/adr-019-project-layout/#5-terraform-tu-ong-hoa","title":"5. Terraform &amp; T\u1ef1 \u0111\u1ed9ng h\u00f3a","text":"<ul> <li>M\u1ed7i lo\u1ea1i project (core, tenant, monitoring) c\u00f3 module Terraform ri\u00eang</li> <li>T\u1ea1o tenant m\u1edbi = t\u1ea1o project + stack = <code>terraform apply -var=\"tenant=abc\"</code></li> <li>Bi\u1ebfn m\u00f4i tr\u01b0\u1eddng, secrets, domain \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh t\u1ef1 \u0111\u1ed9ng qua CI/CD</li> </ul>","tags":["iac","gcp","terraform","networking","multi-project","dx-vas"]},{"location":"ADR/adr-019-project-layout/#he-qua","title":"H\u1ec7 qu\u1ea3","text":"<p>\u2705 \u01afu \u0111i\u1ec3m:</p> <ul> <li>T\u00e1ch b\u1ea1ch r\u00f5 r\u00e0ng, d\u1ec5 qu\u1ea3n tr\u1ecb v\u00e0 b\u1ea3o m\u1eadt</li> <li>Tri\u1ec3n khai song song, kh\u00f4ng \u1ea3nh h\u01b0\u1edfng gi\u1eefa c\u00e1c tenant</li> <li>Scale l\u00ean h\u00e0ng ch\u1ee5c tenant v\u1eabn gi\u1eef \u0111\u01b0\u1ee3c \u0111\u1ed9 r\u00f5 r\u00e0ng</li> <li>Ph\u00f9 h\u1ee3p m\u00f4 h\u00ecnh team DevOps chia theo tr\u01b0\u1eddng</li> </ul> <p>\u26a0\ufe0f L\u01b0u \u00fd:</p> <ul> <li>T\u0103ng s\u1ed1 l\u01b0\u1ee3ng project c\u1ea7n qu\u1ea3n l\u00fd \u2192 c\u1ea7n c\u00f3 c\u00f4ng c\u1ee5 t\u1ed5ng th\u1ec3 (Cloud Resource Manager, Folder Policy)</li> <li>IAM ph\u1ee9c t\u1ea1p h\u01a1n n\u1ebfu kh\u00f4ng c\u00f3 quy \u01b0\u1edbc \u0111\u1eb7t t\u00ean &amp; ph\u00e2n quy\u1ec1n chu\u1ea9n</li> </ul>","tags":["iac","gcp","terraform","networking","multi-project","dx-vas"]},{"location":"ADR/adr-019-project-layout/#lien-ket-lien-quan","title":"Li\u00ean k\u1ebft li\u00ean quan","text":"<ul> <li><code>adr-015-deployment-strategy.md</code></li> <li><code>adr-004-security.md</code></li> <li><code>README.md#8-h\u1ea1-t\u1ea7ng-tri\u1ec3n-khai</code></li> <li><code>system-diagrams.md#5-s\u01a1-\u0111\u1ed3-tri\u1ec3n-khai-h\u1ea1-t\u1ea7ng</code></li> </ul> <p>\u201cKi\u1ebfn tr\u00fac t\u1ed1t b\u1eaft \u0111\u1ea7u t\u1eeb m\u1ed9t n\u1ec1n m\u00f3ng project r\u00f5 r\u00e0ng.\u201d</p>","tags":["iac","gcp","terraform","networking","multi-project","dx-vas"]},{"location":"ADR/adr-020-cost-observability/","title":"ADR-020 - Theo d\u00f5i v\u00e0 t\u1ed1i \u01b0u chi ph\u00ed v\u1eadn h\u00e0nh cho h\u1ec7 th\u1ed1ng dx-vas","text":"","tags":["observability","cost","monitoring","cloud-run","dx-vas"]},{"location":"ADR/adr-020-cost-observability/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>Chi ph\u00ed v\u1eadn h\u00e0nh h\u1ec7 th\u1ed1ng dx-vas bao g\u1ed3m: - D\u1ecbch v\u1ee5 Cloud Run (API Gateway, adapters, frontend SSR...) - Cloud Storage, Firestore, Redis (MemoryStore), BigQuery - Logging &amp; Monitoring (Cloud Logging, Cloud Monitoring) - Traffic egress (khi g\u1ecdi external API ho\u1eb7c frontend SSR qua CDN)</p> <p>Trong qu\u00e1 kh\u1ee9 \u0111\u00e3 x\u1ea3y ra c\u00e1c v\u1ea5n \u0111\u1ec1 nh\u01b0: - Cloud Run scale qu\u00e1 m\u1ee9c \u2192 t\u0103ng \u0111\u1ed9t bi\u1ebfn chi ph\u00ed h\u00e0ng th\u00e1ng - Logging qu\u00e1 chi ti\u1ebft \u2192 t\u0103ng chi ph\u00ed Cloud Logging - Redis gi\u1eef session kh\u00f4ng x\u00f3a \u2192 billing t\u0103ng kh\u00f4ng ki\u1ec3m so\u00e1t</p> <p>C\u1ea7n m\u1ed9t chi\u1ebfn l\u01b0\u1ee3c ch\u1ee7 \u0111\u1ed9ng \u0111\u1ec3 gi\u00e1m s\u00e1t, d\u1ef1 \u0111o\u00e1n v\u00e0 t\u1ed1i \u01b0u chi ph\u00ed cloud, v\u1eeba \u0111\u1ec3 ti\u1ebft ki\u1ec7m, v\u1eeba \u0111\u1ec3 s\u1edbm ph\u00e1t hi\u1ec7n b\u1ea5t th\u01b0\u1eddng.</p>","tags":["observability","cost","monitoring","cloud-run","dx-vas"]},{"location":"ADR/adr-020-cost-observability/#quyet-inh","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh","text":"<p>\u00c1p d\u1ee5ng h\u1ec7 th\u1ed1ng quan s\u00e1t v\u00e0 c\u1ea3nh b\u00e1o chi ph\u00ed theo t\u1eebng d\u1ecbch v\u1ee5 v\u00e0 t\u00e0i nguy\u00ean ch\u00ednh c\u1ee7a h\u1ec7 th\u1ed1ng dx-vas. T\u00edch h\u1ee3p v\u1edbi dashboard theo d\u00f5i real-time, b\u00e1o c\u00e1o \u0111\u1ecbnh k\u1ef3, v\u00e0 c\u1ea3nh b\u00e1o v\u01b0\u1ee3t ng\u01b0\u1ee1ng.</p>","tags":["observability","cost","monitoring","cloud-run","dx-vas"]},{"location":"ADR/adr-020-cost-observability/#cac-nguon-chi-phi-chinh","title":"\ud83d\udcb0 C\u00e1c ngu\u1ed3n chi ph\u00ed ch\u00ednh","text":"Ngu\u1ed3n C\u00f4ng c\u1ee5 \u0110\u01a1n v\u1ecb C\u1ea3nh b\u00e1o \u0111\u1ec1 xu\u1ea5t Cloud Run Google Cloud Billing VND/hour &gt; 300K/ng\u00e0y/service Redis MemoryStore billing GB RAM/hour &gt; 4 GB ho\u1eb7c &gt; 100K ops/min Cloud Logging Logging bytes GB/ng\u00e0y &gt; 1GB/ng\u00e0y/service BigQuery Storage &amp; Query GB scanned &gt; 5GB/ng\u00e0y Cloud Monitoring Uptime/Alerting API calls Kh\u00f4ng c\u1ea7n alert, nh\u01b0ng log usage Firestore / Storage GB stored + reads GB &amp; IOPS Theo d\u00f5i xu h\u01b0\u1edbng t\u0103ng li\u00ean t\u1ee5c","tags":["observability","cost","monitoring","cloud-run","dx-vas"]},{"location":"ADR/adr-020-cost-observability/#dashboard-phan-nhom-chi-phi","title":"\ud83d\udcca Dashboard &amp; Ph\u00e2n nh\u00f3m chi ph\u00ed","text":"<p>T\u1ea1o dashboard chi ph\u00ed trong Cloud Billing &gt; Budgets &amp; reports: - Nh\u00f3m theo <code>service.label</code>, <code>resource.name</code>, <code>project</code> - G\u00e1n tag: <code>env=prod|staging|dev</code>, <code>owner=platform|lms|crm</code>, <code>critical=true</code> - G\u1eafn cost attribution qua label: <code>dx-vas_service</code>, <code>env</code>, <code>module</code></p> <p>M\u1ed7i service Cloud Run n\u00ean c\u00f3 \u00edt nh\u1ea5t: - <code>cloud.googleapis.com/run/container/start_count</code> - <code>cloud.googleapis.com/run/request_count</code> - <code>billing/cost</code> metric qua Cloud Monitoring + BigQuery export</p>","tags":["observability","cost","monitoring","cloud-run","dx-vas"]},{"location":"ADR/adr-020-cost-observability/#chi-phi-reporting-service-bigquery","title":"\ud83d\udcc8 Chi ph\u00ed Reporting Service &amp; BigQuery","text":"","tags":["observability","cost","monitoring","cloud-run","dx-vas"]},{"location":"ADR/adr-020-cost-observability/#bo-sung-bang-chi-phi","title":"\ud83d\udcb0 B\u1ed5 sung b\u1ea3ng chi ph\u00ed:","text":"Ngu\u1ed3n C\u00f4ng c\u1ee5 \u0110\u01a1n v\u1ecb C\u1ea3nh b\u00e1o \u0111\u1ec1 xu\u1ea5t Reporting Service Cloud Run VND/hour &gt; 150K/ng\u00e0y BigQuery Query &amp; Storage GB scanned &gt; 5GB/ng\u00e0y","tags":["observability","cost","monitoring","cloud-run","dx-vas"]},{"location":"ADR/adr-020-cost-observability/#dashboard-attribution-bo-sung","title":"\ud83d\udcca Dashboard &amp; Attribution (b\u1ed5 sung):","text":"<ul> <li> <p>Label g\u1ee3i \u00fd cho Reporting Service:</p> </li> <li> <p><code>dx-vas_service=reporting-service</code></p> </li> <li><code>module=reporting</code></li> <li> <p><code>critical=true</code></p> </li> <li> <p>V\u1edbi BigQuery:</p> </li> <li> <p>G\u1eafn label <code>report_query_type=dashboard|ad-hoc|scheduled</code></p> </li> <li>Theo d\u00f5i c\u1ee5 th\u1ec3 c\u00e1c query ch\u1ea1y b\u1edfi Reporting Service (qua <code>user_email</code>, <code>labels</code> trong <code>INFORMATION_SCHEMA.JOBS</code>)</li> </ul>","tags":["observability","cost","monitoring","cloud-run","dx-vas"]},{"location":"ADR/adr-020-cost-observability/#alerting-noti","title":"\ud83d\udea8 Alerting &amp; Noti","text":"<ul> <li>Thi\u1ebft l\u1eadp Cloud Budget alert:</li> <li> <p>90% monthly quota \u2192 g\u1eedi email/slack</p> </li> <li> <p>110% week-over-week cost \u2192 Slack + log</p> </li> <li>Alert rule (Monitoring):</li> <li>Redis memory &gt; 80%</li> <li>Logging usage &gt; 1GB/day/service</li> <li>Cloud Run instance spike &gt; 3x b\u00ecnh th\u01b0\u1eddng trong 15 ph\u00fat</li> <li>Query n\u00e0o v\u01b0\u1ee3t &gt;1GB scanned \u2192 g\u1eafn v\u00e0o log c\u1ea3nh b\u00e1o</li> <li>T\u1ea7n su\u1ea5t b\u00e1o c\u00e1o t\u1ef1 \u0111\u1ed9ng &gt; 100 l\u1ea7n/ng\u00e0y \u2192 c\u1ea3nh b\u00e1o spam</li> <li>T\u1ed5ng chi ph\u00ed BigQuery &gt; 2M VND/th\u00e1ng \u2192 Slack alert</li> </ul>","tags":["observability","cost","monitoring","cloud-run","dx-vas"]},{"location":"ADR/adr-020-cost-observability/#tich-hop-ky-thuat","title":"\ud83d\udee0 T\u00edch h\u1ee3p k\u1ef9 thu\u1eadt","text":"<ul> <li>T\u1ef1 \u0111\u1ed9ng export billing \u2192 BigQuery</li> <li>Giao di\u1ec7n dashboard qua Looker Studio ho\u1eb7c Metabase (n\u1ebfu private)</li> <li>Script cron ph\u00e2n t\u00edch log: log traffic v\u01b0\u1ee3t 100K req/day/service \u2192 g\u1eedi c\u1ea3nh b\u00e1o</li> <li>G\u1eafn cost estimator v\u00e0o CI/CD (Terraform plan \u2192 \u01b0\u1edbc l\u01b0\u1ee3ng chi ph\u00ed)</li> </ul>","tags":["observability","cost","monitoring","cloud-run","dx-vas"]},{"location":"ADR/adr-020-cost-observability/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>D\u1ef1 b\u00e1o chi ph\u00ed theo th\u1eddi gian th\u1ef1c</li> <li>Ph\u00e1t hi\u1ec7n s\u1edbm b\u1ea5t th\u01b0\u1eddng do c\u1ea5u h\u00ecnh sai (scale, cache, logging)</li> <li>T\u1ed1i \u01b0u billing t\u1eebng microservice r\u00f5 r\u00e0ng</li> <li>Ph\u00e2n b\u1ed5 chi ph\u00ed c\u00f4ng b\u1eb1ng theo team/module</li> </ul>","tags":["observability","cost","monitoring","cloud-run","dx-vas"]},{"location":"ADR/adr-020-cost-observability/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p Qu\u00e1 nhi\u1ec1u alert g\u00e2y nhi\u1ec5u G\u1ed9p alert theo nh\u00f3m, alert only trend not spikes Kh\u00f4ng g\u00e1n tag cost \u2192 kh\u00f4ng trace \u0111\u01b0\u1ee3c CI enforce label &amp; billing tag tr\u00ean resource Cloud Billing export b\u1ecb ng\u1eaft C\u00f3 job ki\u1ec3m tra cron export ho\u1ea1t \u0111\u1ed9ng li\u00ean t\u1ee5c","tags":["observability","cost","monitoring","cloud-run","dx-vas"]},{"location":"ADR/adr-020-cost-observability/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Auto Scaling: ADR-016</li> <li>CI/CD Strategy: ADR-001</li> <li>IaC Strategy: ADR-002</li> </ul> <p>\u201cKh\u00f4ng quan s\u00e1t \u0111\u01b0\u1ee3c chi ph\u00ed, s\u1edbm mu\u1ed9n s\u1ebd v\u01b0\u1ee3t ng\u00e2n s\u00e1ch.\u201d</p>","tags":["observability","cost","monitoring","cloud-run","dx-vas"]},{"location":"ADR/adr-021-external-observability/","title":"ADR-021 - Ch\u00ednh s\u00e1ch t\u00edch h\u1ee3p Observability v\u1edbi h\u1ec7 th\u1ed1ng b\u00ean ngo\u00e0i cho dx-vas","text":"","tags":["observability","logging","metrics","tracing","dx-vas","external","otlp"]},{"location":"ADR/adr-021-external-observability/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>Trong h\u1ec7 th\u1ed1ng dx-vas, ph\u1ea7n l\u1edbn d\u1eef li\u1ec7u log, metric v\u00e0 trace \u0111ang \u0111\u01b0\u1ee3c thu th\u1eadp v\u00e0 gi\u00e1m s\u00e1t qua Google Cloud Platform (Cloud Logging, Cloud Monitoring, Cloud Trace). Tuy nhi\u00ean, t\u1ed5 ch\u1ee9c c\u00f3 th\u1ec3 c\u00f3 nhu c\u1ea7u: - T\u1eadp trung h\u00f3a d\u1eef li\u1ec7u v\u00e0o m\u1ed9t h\u1ec7 th\u1ed1ng gi\u00e1m s\u00e1t hi\u1ec7n c\u00f3 nh\u01b0 Datadog, Grafana Cloud, ELK, Sentry, ho\u1eb7c New Relic - T\u00edch h\u1ee3p d\u1eef li\u1ec7u c\u1ea3nh b\u00e1o v\u1edbi h\u1ec7 th\u1ed1ng incident management ho\u1eb7c Security Operations Center (SOC) hi\u1ec7n t\u1ea1i - Ph\u00e2n t\u00edch log/metric theo c\u00e1ch Google Cloud kh\u00f4ng h\u1ed7 tr\u1ee3 t\u1ed1t</p> <p>Vi\u1ec7c t\u00edch h\u1ee3p external observability n\u00e0y c\u1ea7n \u0111\u01b0\u1ee3c chu\u1ea9n h\u00f3a v\u00e0 b\u1ea3o v\u1ec7 \u0111\u1ec3: - \u0110\u1ea3m b\u1ea3o b\u1ea3o m\u1eadt v\u00e0 tu\u00e2n th\u1ee7 d\u1eef li\u1ec7u - Ki\u1ec3m so\u00e1t chi ph\u00ed egress traffic v\u00e0 licensing - Gi\u1eef nguy\u00ean trace ID v\u00e0 context \u0111\u1ec3 ph\u00e2n t\u00edch li\u00ean h\u1ec7 gi\u1eefa h\u1ec7 th\u1ed1ng n\u1ed9i b\u1ed9 v\u00e0 b\u00ean ngo\u00e0i</p>","tags":["observability","logging","metrics","tracing","dx-vas","external","otlp"]},{"location":"ADR/adr-021-external-observability/#quyet-inh","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas cho ph\u00e9p v\u00e0 h\u1ed7 tr\u1ee3 t\u00edch h\u1ee3p v\u1edbi c\u00e1c h\u1ec7 th\u1ed1ng observability b\u00ean ngo\u00e0i khi c\u00f3 nhu c\u1ea7u ch\u00ednh \u0111\u00e1ng, theo c\u00e1c ti\u00eau chu\u1ea9n k\u1ef9 thu\u1eadt, b\u1ea3o m\u1eadt v\u00e0 chi ph\u00ed \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong t\u00e0i li\u1ec7u n\u00e0y.</p>","tags":["observability","logging","metrics","tracing","dx-vas","external","otlp"]},{"location":"ADR/adr-021-external-observability/#khi-nao-nen-tich-hop-voi-he-thong-ben-ngoai","title":"\ud83d\udd0d Khi n\u00e0o n\u00ean t\u00edch h\u1ee3p v\u1edbi h\u1ec7 th\u1ed1ng b\u00ean ngo\u00e0i?","text":"<ul> <li>C\u00f3 h\u1ec7 th\u1ed1ng SOC, SIEM ho\u1eb7c centralized monitoring ngo\u00e0i GCP</li> <li>C\u1ea7n t\u00ednh n\u0103ng m\u00e0 Cloud Monitoring kh\u00f4ng \u0111\u00e1p \u1ee9ng \u0111\u01b0\u1ee3c (alert logic ph\u1ee9c t\u1ea1p, correlation, SLO dashboard tu\u1ef3 ch\u1ec9nh...)</li> <li>Y\u00eau c\u1ea7u tu\u00e2n th\u1ee7 t\u1ed5 ch\u1ee9c (log ph\u1ea3i l\u01b0u tr\u1eef t\u1eadp trung)</li> <li>D\u1eef li\u1ec7u ph\u1ee5c v\u1ee5 cross-system analysis (backend t\u1eeb nhi\u1ec1u n\u1ec1n t\u1ea3ng)</li> </ul>","tags":["observability","logging","metrics","tracing","dx-vas","external","otlp"]},{"location":"ADR/adr-021-external-observability/#loai-du-lieu-uoc-export","title":"\ud83d\udce6 Lo\u1ea1i d\u1eef li\u1ec7u \u0111\u01b0\u1ee3c export","text":"Lo\u1ea1i V\u00ed d\u1ee5 \u0110i\u1ec1u ki\u1ec7n Logs error logs, audit logs Mask nh\u1ea1y c\u1ea3m, gi\u1eef trace_id Metrics latency, request count, memory C\u00f3 label <code>dx-vas_service</code> v\u00e0 <code>env</code> Traces Cloud Trace \u2192 OTLP span Mapping span name, attributes chu\u1ea9n Alerts/Events Deployment alert, billing alert Webhook ho\u1eb7c Pub/Sub stream","tags":["observability","logging","metrics","tracing","dx-vas","external","otlp"]},{"location":"ADR/adr-021-external-observability/#giao-thuc-phuong-thuc-tich-hop-chuan","title":"\ud83d\udd17 Giao th\u1ee9c &amp; ph\u01b0\u01a1ng th\u1ee9c t\u00edch h\u1ee3p chu\u1ea9n","text":"D\u1eef li\u1ec7u Giao th\u1ee9c Ph\u01b0\u01a1ng ph\u00e1p Ghi ch\u00fa Logs Pub/Sub, OTLP, HTTPS Logging Sink \u2192 Pub/Sub \u2192 forwarder Forward t\u1eeb Pub/Sub \u0111\u1ebfn Fluent Bit / Logstash agent Metrics OTLP, Prometheus remote write OpenTelemetry Collector \u2192 Backend Expose metrics n\u1ebfu c\u1ea7n pull Traces OTLP OTEL Collector H\u1ed7 tr\u1ee3 span enrich + mapping Alerts Webhook Cloud Monitoring \u2192 Webhook T\u1edbi Slack, PagerDuty, external API","tags":["observability","logging","metrics","tracing","dx-vas","external","otlp"]},{"location":"ADR/adr-021-external-observability/#cac-he-thong-external-co-the-tich-hop","title":"\u2705 C\u00e1c h\u1ec7 th\u1ed1ng external c\u00f3 th\u1ec3 t\u00edch h\u1ee3p","text":"H\u1ec7 th\u1ed1ng Lo\u1ea1i Ghi ch\u00fa Datadog Log, Metric, APM C\u00f3 agent + API push Grafana Cloud Metric, Logs Qua OTLP ho\u1eb7c Prometheus remote write Sentry Error tracking SDK ho\u1eb7c forwarding log v\u1edbi context New Relic Metric, APM T\u00edch h\u1ee3p OTLP chu\u1ea9n ELK / OpenSearch Logs Qua Fluent Bit ho\u1eb7c Logstash","tags":["observability","logging","metrics","tracing","dx-vas","external","otlp"]},{"location":"ADR/adr-021-external-observability/#nguyen-tac-lua-chon-he-thong","title":"Nguy\u00ean t\u1eafc l\u1ef1a ch\u1ecdn h\u1ec7 th\u1ed1ng:","text":"<ul> <li>H\u1ed7 tr\u1ee3 chu\u1ea9n m\u1edf (OTLP, Prometheus, OpenTracing)</li> <li>C\u00f3 c\u01a1 ch\u1ebf b\u1ea3o v\u1ec7, x\u00e1c th\u1ef1c, gi\u1edbi h\u1ea1n truy c\u1eadp</li> <li>T\u00ednh n\u0103ng v\u01b0\u1ee3t tr\u1ed9i so v\u1edbi GCP n\u1ebfu d\u00f9ng song song</li> <li>C\u00f3 c\u1ea3nh b\u00e1o n\u1ebfu chi ph\u00ed v\u01b0\u1ee3t d\u1ef1 \u0111o\u00e1n</li> </ul>","tags":["observability","logging","metrics","tracing","dx-vas","external","otlp"]},{"location":"ADR/adr-021-external-observability/#tagging-metadata-chuan-hoa","title":"\ud83e\uddfe Tagging &amp; Metadata chu\u1ea9n ho\u00e1","text":"<p>M\u1ecdi d\u1eef li\u1ec7u g\u1eedi ra ph\u1ea3i c\u00f3 c\u00e1c metadata sau: <pre><code>trace_id: ...\ncorrelation_id: ...\nenv: production|staging|dev\nservice: api_gateway | lms_adapter | ...\nmodule: auth | user | crm\nteam: platform | lms | frontend\n</code></pre></p>","tags":["observability","logging","metrics","tracing","dx-vas","external","otlp"]},{"location":"ADR/adr-021-external-observability/#bao-mat-tuan-thu","title":"\ud83d\udd10 B\u1ea3o m\u1eadt &amp; tu\u00e2n th\u1ee7","text":"<ul> <li>M\u1ecdi log ch\u1ee9a d\u1eef li\u1ec7u ng\u01b0\u1eddi d\u00f9ng ph\u1ea3i \u0111\u01b0\u1ee3c mask tr\u01b0\u1edbc khi export</li> <li>Ch\u1ec9 export t\u1eeb m\u00f4i tr\u01b0\u1eddng <code>staging</code>, <code>prod</code>, kh\u00f4ng t\u1eeb <code>dev</code> n\u1ebfu kh\u00f4ng c\u00f3 nhu c\u1ea7u gi\u00e1m s\u00e1t</li> <li>D\u00f9ng HTTPS ho\u1eb7c mTLS cho webhook/API endpoint</li> <li>\u0110\u1eb7t rule IAM r\u00f5 r\u00e0ng cho b\u00ean nh\u1eadn d\u1eef li\u1ec7u</li> <li>\u0110\u1ea3m b\u1ea3o region residency n\u1ebfu c\u00f3 r\u00e0ng bu\u1ed9c ch\u1ee7 quy\u1ec1n d\u1eef li\u1ec7u</li> </ul>","tags":["observability","logging","metrics","tracing","dx-vas","external","otlp"]},{"location":"ADR/adr-021-external-observability/#kiem-soat-chi-phi","title":"\ud83d\udcb5 Ki\u1ec3m so\u00e1t chi ph\u00ed","text":"Chi ph\u00ed Qu\u1ea3n l\u00fd Egress traffic G\u1eafn label trace/log \u0111\u1ec3 t\u00ednh theo team External licensing T\u00e1ch bill theo project/module Volume logs/traces \u00c1p d\u1ee5ng sampling ho\u1eb7c filter logs t\u1eeb Cloud Logging","tags":["observability","logging","metrics","tracing","dx-vas","external","otlp"]},{"location":"ADR/adr-021-external-observability/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>Cho ph\u00e9p \u0111\u1ed9i DevOps/SOC t\u00edch h\u1ee3p gi\u00e1m s\u00e1t linh ho\u1ea1t</li> <li>\u0110\u1ea3m b\u1ea3o compliance v\u00e0 kh\u1ea3 n\u0103ng \u0111i\u1ec1u tra t\u1ed1t h\u01a1n</li> <li>D\u1ec5 t\u00edch h\u1ee3p v\u1edbi quy tr\u00ecnh v\u1eadn h\u00e0nh/ph\u00e2n t\u00edch s\u1ef1 c\u1ed1 c\u1ee7a t\u1ed5 ch\u1ee9c</li> </ul>","tags":["observability","logging","metrics","tracing","dx-vas","external","otlp"]},{"location":"ADR/adr-021-external-observability/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p D\u1eef li\u1ec7u r\u00f2 r\u1ec9 ho\u1eb7c export sai Masking, ki\u1ec3m tra \u0111\u1ecbnh k\u1ef3, trace log outbound Egress traffic v\u01b0\u1ee3t ki\u1ec3m so\u00e1t Sampling, alert tr\u00ean volume log D\u1eef li\u1ec7u export kh\u00f4ng li\u00ean k\u1ebft \u0111\u01b0\u1ee3c v\u1edbi trong GCP G\u1eafn <code>trace_id</code>, <code>correlation_id</code> \u0111\u1ea7y \u0111\u1ee7","tags":["observability","logging","metrics","tracing","dx-vas","external","otlp"]},{"location":"ADR/adr-021-external-observability/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Cost Observability: ADR-020</li> <li>Auto Scaling: ADR-016</li> <li>CI/CD Strategy: ADR-001</li> <li>Security: ADR-004</li> <li>Secrets: ADR-003</li> </ul> <p>\"Observability kh\u00f4ng n\u00ean b\u1ecb gi\u1edbi h\u1ea1n trong n\u1ed9i b\u1ed9 \u2013 n\u1ebfu vi\u1ec7c nh\u00ecn xa gi\u00fap b\u1ea1n ph\u1ea3n \u1ee9ng nhanh h\u01a1n.\"</p>","tags":["observability","logging","metrics","tracing","dx-vas","external","otlp"]},{"location":"ADR/adr-022-sla-slo-monitoring/","title":"ADR-022: SLA, SLO v\u00e0 Gi\u00e1m s\u00e1t (Monitoring Strategy)","text":"","tags":["sla","slo","monitoring","observability","reliability","dx-vas"]},{"location":"ADR/adr-022-sla-slo-monitoring/#trang-thai","title":"Tr\u1ea1ng th\u00e1i","text":"<p>Accepted</p>","tags":["sla","slo","monitoring","observability","reliability","dx-vas"]},{"location":"ADR/adr-022-sla-slo-monitoring/#boi-canh","title":"B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas ph\u1ee5c v\u1ee5 nhi\u1ec1u tr\u01b0\u1eddng th\u00e0nh vi\u00ean (multi-tenant). \u0110\u1ec3 \u0111\u1ea3m b\u1ea3o ch\u1ea5t l\u01b0\u1ee3ng d\u1ecbch v\u1ee5 v\u00e0 d\u1ec5 truy v\u1ebft khi c\u00f3 s\u1ef1 c\u1ed1, h\u1ec7 th\u1ed1ng c\u1ea7n \u0111\u1ecbnh ngh\u0129a r\u00f5 SLA/SLO cho t\u1eebng th\u00e0nh ph\u1ea7n v\u00e0 c\u00f3 h\u1ec7 th\u1ed1ng gi\u00e1m s\u00e1t ph\u00f9 h\u1ee3p.</p> <p>M\u1ed7i tenant c\u00f3 stack d\u1ecbch v\u1ee5 ri\u00eang bi\u1ec7t (Sub Service, Frontend, Adapter...), do \u0111\u00f3 vi\u1ec7c theo d\u00f5i ri\u00eang theo t\u1eebng tenant l\u00e0 c\u1ea7n thi\u1ebft.</p>","tags":["sla","slo","monitoring","observability","reliability","dx-vas"]},{"location":"ADR/adr-022-sla-slo-monitoring/#quyet-inh","title":"Quy\u1ebft \u0111\u1ecbnh","text":"","tags":["sla","slo","monitoring","observability","reliability","dx-vas"]},{"location":"ADR/adr-022-sla-slo-monitoring/#1-inh-nghia-slaslo-cho-tung-nhom-dich-vu","title":"1. \u0110\u1ecbnh ngh\u0129a SLA/SLO cho t\u1eebng nh\u00f3m d\u1ecbch v\u1ee5","text":"D\u1ecbch v\u1ee5 SLO \u0111\u1ec1 xu\u1ea5t SLA target Auth (Master/Sub) 99.9% request th\u00e0nh c\u00f4ng d\u01b0\u1edbi 500ms \u2265 99.5% API Gateway 99.9% routing ch\u00ednh x\u00e1c, kh\u00f4ng l\u1ed7i 5xx \u2265 99.9% Sub User / Sub Notification 99.9% uptime / latency \u1ed5n \u0111\u1ecbnh &lt; 700ms \u2265 99.5% Pub/Sub Processing \u2264 5s t\u1eeb l\u00fac publish \u2192 x\u1eed l\u00fd xong t\u1ea1i Sub Service \u2265 99.0%","tags":["sla","slo","monitoring","observability","reliability","dx-vas"]},{"location":"ADR/adr-022-sla-slo-monitoring/#2-moi-tenant-stack-co-metric-alert-rieng","title":"2. M\u1ed7i tenant stack c\u00f3 metric &amp; alert ri\u00eang","text":"<ul> <li>M\u1ed7i tenant c\u00f3 dashboard ri\u00eang (d\u00f9ng Cloud Monitoring ho\u1eb7c Grafana)</li> <li>M\u1ed7i alert ph\u1ea3i g\u1eafn label <code>tenant_id</code>, v\u00ed d\u1ee5:</li> </ul> <pre><code>labels:\n  tenant_id: \"abc\"\n  service: \"sub-user\"\n  severity: \"critical\"\n</code></pre> <ul> <li>Superadmin c\u00f3 giao di\u1ec7n t\u1ed5ng h\u1ee3p alert theo tenant</li> <li>C\u00e1c ch\u1ec9 s\u1ed1 \u0111\u01b0\u1ee3c ph\u00e2n lo\u1ea1i theo nh\u00f3m:</li> </ul> Nh\u00f3m V\u00ed d\u1ee5 ch\u1ec9 s\u1ed1 Latency P95 response time per service per tenant Availability Uptime Sub Service theo <code>tenant_id</code> Error Rate 5xx ratio, failed login OTP, message delivery failure Pub/Sub Event delay, processing time, ack timeout per tenant","tags":["sla","slo","monitoring","observability","reliability","dx-vas"]},{"location":"ADR/adr-022-sla-slo-monitoring/#3-log-tap-trung-theo-tenant","title":"3. Log t\u1eadp trung theo tenant","text":"<ul> <li>T\u1ea5t c\u1ea3 log \u0111\u1ec1u c\u00f3 field <code>tenant_id</code></li> <li>Cho ph\u00e9p truy v\u1ea5n nhanh theo tenant:</li> </ul> <pre><code>SELECT * FROM logs\nWHERE tenant_id = \"abc\"\nAND severity = \"ERROR\"\nAND timestamp &gt; TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 HOUR)\n</code></pre> <ul> <li>Logs g\u1eedi v\u1ec1 Stackdriver ho\u1eb7c BigQuery \u0111\u1ec3 ph\u00e2n t\u00edch</li> </ul>","tags":["sla","slo","monitoring","observability","reliability","dx-vas"]},{"location":"ADR/adr-022-sla-slo-monitoring/#4-alert-routing-va-escalation","title":"4. Alert routing v\u00e0 escalation","text":"<ul> <li>Alert g\u1eedi qua Zalo/Email theo tenant</li> <li>Alert <code>core service</code> g\u1eedi v\u1ec1 nh\u00f3m DevOps ch\u00ednh</li> <li>Alert <code>tenant stack</code> c\u00f3 th\u1ec3 g\u1eedi ri\u00eang cho qu\u1ea3n tr\u1ecb vi\u00ean k\u1ef9 thu\u1eadt c\u1ee7a tr\u01b0\u1eddng</li> </ul>","tags":["sla","slo","monitoring","observability","reliability","dx-vas"]},{"location":"ADR/adr-022-sla-slo-monitoring/#he-qua","title":"H\u1ec7 qu\u1ea3","text":"<p>\u2705 \u01afu \u0111i\u1ec3m:</p> <ul> <li>D\u1ec5 truy v\u1ebft l\u1ed7i theo t\u1eebng tr\u01b0\u1eddng/tenant</li> <li>Gi\u00fap ki\u1ec3m so\u00e1t ch\u1ea5t l\u01b0\u1ee3ng d\u1ecbch v\u1ee5 \u0111a t\u1ea7ng (core + tenant)</li> <li>H\u1ed7 tr\u1ee3 t\u00ednh to\u00e1n SLA/SLO minh b\u1ea1ch v\u1edbi kh\u00e1ch h\u00e0ng (tr\u01b0\u1eddng)</li> </ul> <p>\u26a0\ufe0f L\u01b0u \u00fd:</p> <ul> <li>C\u1ea7n c\u00f4ng c\u1ee5 t\u1ef1 \u0111\u1ed9ng c\u1ea5u h\u00ecnh alert theo tenant m\u1edbi</li> <li>Ph\u1ea3i \u0111\u1ea3m b\u1ea3o log kh\u00f4ng b\u1ecb tr\u1ed9n gi\u1eefa tenants</li> </ul>","tags":["sla","slo","monitoring","observability","reliability","dx-vas"]},{"location":"ADR/adr-022-sla-slo-monitoring/#lien-ket-lien-quan","title":"Li\u00ean k\u1ebft li\u00ean quan","text":"<ul> <li><code>adr-015-deployment-strategy.md</code></li> <li><code>adr-004-security.md</code></li> <li><code>adr-008-audit-logging.md</code></li> </ul> <p>\u201cSLA l\u00e0 l\u1eddi h\u1ee9a. SLO l\u00e0 la b\u00e0n. SLI l\u00e0 chi\u1ebfc g\u01b0\u01a1ng s\u1ef1 th\u1eadt.\u201d</p>","tags":["sla","slo","monitoring","observability","reliability","dx-vas"]},{"location":"ADR/adr-023-schema-migration-strategy/","title":"ADR-023 - Chi\u1ebfn l\u01b0\u1ee3c thay \u0111\u1ed5i schema d\u1eef li\u1ec7u an to\u00e0n v\u00e0 c\u00f3 th\u1ec3 rollback cho h\u1ec7 th\u1ed1ng dx-vas","text":"","tags":["schema","database","migration","compatibility","dx-vas"]},{"location":"ADR/adr-023-schema-migration-strategy/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>Nhi\u1ec1u th\u00e0nh ph\u1ea7n trong h\u1ec7 th\u1ed1ng dx-vas s\u1eed d\u1ee5ng c\u01a1 s\u1edf d\u1eef li\u1ec7u quan h\u1ec7 ho\u1eb7c NoSQL (PostgreSQL, Firestore, Redis). Khi tri\u1ec3n khai t\u00ednh n\u0103ng m\u1edbi ho\u1eb7c refactor, thay \u0111\u1ed5i schema l\u00e0 \u0111i\u1ec1u kh\u00f4ng th\u1ec3 tr\u00e1nh kh\u1ecfi. Tuy nhi\u00ean, n\u1ebfu l\u00e0m kh\u00f4ng c\u1ea9n th\u1eadn, migration c\u00f3 th\u1ec3 g\u00e2y: - M\u1ea5t d\u1eef li\u1ec7u ho\u1eb7c m\u1ea5t t\u01b0\u01a1ng th\u00edch ng\u01b0\u1ee3c (breaking change) - Downtime n\u1ebfu migration qu\u00e1 n\u1eb7ng ho\u1eb7c x\u1ea3y ra khi h\u1ec7 th\u1ed1ng \u0111ang online - Kh\u00f4ng rollback \u0111\u01b0\u1ee3c n\u1ebfu kh\u00f4ng c\u00f3 chi\u1ebfn l\u01b0\u1ee3c t\u00e1ch bi\u1ec7t v\u00e0 ki\u1ec3m so\u00e1t t\u1ed1t</p>","tags":["schema","database","migration","compatibility","dx-vas"]},{"location":"ADR/adr-023-schema-migration-strategy/#quyet-inh","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh","text":"<p>\u00c1p d\u1ee5ng chi\u1ebfn l\u01b0\u1ee3c migration an to\u00e0n theo h\u01b0\u1edbng forward-compatible, rollbackable v\u00e0 kh\u00f4ng g\u00e2y downtime cho h\u1ec7 th\u1ed1ng dx-vas. Migration ph\u1ea3i \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd \u0111\u1ed9c l\u1eadp v\u1edbi code deploy.</p>","tags":["schema","database","migration","compatibility","dx-vas"]},{"location":"ADR/adr-023-schema-migration-strategy/#chien-luoc-trien-khai-migration-theo-3-buoc","title":"\ud83e\uddf1 Chi\u1ebfn l\u01b0\u1ee3c tri\u1ec3n khai migration theo 3 b\u01b0\u1edbc","text":"","tags":["schema","database","migration","compatibility","dx-vas"]},{"location":"ADR/adr-023-schema-migration-strategy/#1-prepare-add-khong-thay-the","title":"1. Prepare \u2013 Add, kh\u00f4ng thay th\u1ebf","text":"<ul> <li>Th\u00eam tr\u01b0\u1eddng m\u1edbi (nullable, optional), KH\u00d4NG \u0111\u1ed5i t\u00ean ho\u1eb7c x\u00f3a tr\u1ef1c ti\u1ebfp</li> <li>Kh\u00f4ng thay \u0111\u1ed5i ki\u1ec3u d\u1eef li\u1ec7u \u0111\u1ed9t ng\u1ed9t</li> <li>N\u1ebfu c\u1ea7n chuy\u1ec3n \u0111\u1ed5i d\u1eef li\u1ec7u, th\u00eam c\u1ed9t m\u1edbi v\u00e0 chuy\u1ec3n d\u1ea7n sang (shadow field)</li> </ul>","tags":["schema","database","migration","compatibility","dx-vas"]},{"location":"ADR/adr-023-schema-migration-strategy/#2-transition-ung-dung-ho-tro-ca-schema-cu-moi","title":"2. Transition \u2013 \u1ee8ng d\u1ee5ng h\u1ed7 tr\u1ee3 c\u1ea3 schema c\u0169 &amp; m\u1edbi","text":"<ul> <li>Code ph\u1ea3i t\u01b0\u01a1ng th\u00edch c\u1ea3 hai schema (\u0111\u1ecdc c\u1ea3 field c\u0169 v\u00e0 m\u1edbi)</li> <li>T\u1ea1o flag/toggle \u0111\u1ec3 ki\u1ec3m so\u00e1t h\u00e0nh vi migration (t\u1ed1t h\u01a1n n\u1ebfu c\u00f3 experiment rollout)</li> <li>Ch\u1ea1y migration script ri\u00eang bi\u1ec7t, kh\u00f4ng g\u1eafn v\u00e0o code deploy</li> </ul>","tags":["schema","database","migration","compatibility","dx-vas"]},{"location":"ADR/adr-023-schema-migration-strategy/#3-cleanup-chi-sau-khi-a-hoan-tat-rollout-va-verify","title":"3. Cleanup \u2013 Ch\u1ec9 sau khi \u0111\u00e3 ho\u00e0n t\u1ea5t rollout v\u00e0 verify","text":"<ul> <li>Ch\u1ec9 x\u00f3a/rename schema c\u0169 khi:</li> <li>Kh\u00f4ng c\u00f2n service n\u00e0o s\u1eed d\u1ee5ng</li> <li>Monitoring x\u00e1c nh\u1eadn kh\u00f4ng c\u00f3 traffic d\u00f9ng field c\u0169</li> <li>\u0110\u00e3 rollback \u0111\u01b0\u1ee3c migration data n\u1ebfu c\u1ea7n</li> </ul>","tags":["schema","database","migration","compatibility","dx-vas"]},{"location":"ADR/adr-023-schema-migration-strategy/#cong-cu-quy-trinh-ky-thuat","title":"\ud83e\uddf0 C\u00f4ng c\u1ee5 &amp; Quy tr\u00ecnh k\u1ef9 thu\u1eadt","text":"<ul> <li>Migration script n\u00ean s\u1eed d\u1ee5ng:</li> <li>Alembic (PostgreSQL)</li> <li>Firebase Admin SDK (Firestore)</li> <li>Custom script Python/NodeJS (Redis, Mongo, etc.)</li> <li>M\u1ed7i migration c\u00f3:</li> <li>ID duy nh\u1ea5t, version h\u00f3a theo timestamp</li> <li>Ch\u1ea1y qua <code>pre-release checklist</code></li> <li>C\u00f3 tr\u1ea1ng th\u00e1i: <code>pending</code>, <code>running</code>, <code>done</code>, <code>rolled_back</code></li> <li>Script l\u01b0u log t\u1ea1i Cloud Logging + BigQuery \u0111\u1ec3 audit</li> <li>Rollback script \u0111i k\u00e8m migration (n\u1ebfu destructive)</li> </ul>","tags":["schema","database","migration","compatibility","dx-vas"]},{"location":"ADR/adr-023-schema-migration-strategy/#thoi-iem-chay-migration","title":"\u23f1 Th\u1eddi \u0111i\u1ec3m ch\u1ea1y migration","text":"Lo\u1ea1i migration Th\u1eddi \u0111i\u1ec3m ch\u1ea1y Ghi ch\u00fa Add column/index Tr\u01b0\u1edbc deploy Kh\u00f4ng \u1ea3nh h\u01b0\u1edfng code c\u0169 Populate data m\u1edbi Sau deploy Code m\u1edbi c\u00f3 th\u1ec3 \u0111\u1ecdc field \u0111\u00f3 Drop/rename field Sau nhi\u1ec1u ng\u00e0y Ph\u1ea3i ch\u1eafc ch\u1eafn backward compat \u0111\u00e3 \u0111\u01b0\u1ee3c lo\u1ea1i b\u1ecf","tags":["schema","database","migration","compatibility","dx-vas"]},{"location":"ADR/adr-023-schema-migration-strategy/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>Migration kh\u00f4ng l\u00e0m gi\u00e1n \u0111o\u1ea1n h\u1ec7 th\u1ed1ng</li> <li>C\u00f3 kh\u1ea3 n\u0103ng rollback n\u1ebfu deployment th\u1ea5t b\u1ea1i</li> <li>Cho ph\u00e9p rollout thay \u0111\u1ed5i l\u1edbn theo t\u1eebng giai \u0111o\u1ea1n, kh\u00f4ng bu\u1ed9c all-or-nothing</li> </ul>","tags":["schema","database","migration","compatibility","dx-vas"]},{"location":"ADR/adr-023-schema-migration-strategy/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p Ch\u1ea1y migration qu\u00e1 l\u00e2u g\u00e2y lock Batch + timeout h\u1ee3p l\u00fd, ch\u1ea1y n\u1ec1n (async worker) Migration l\u00e9n g\u1eafn v\u00e0o code deploy CI/CD enforce separation, checklist b\u1eaft bu\u1ed9c Kh\u00f4ng rollback \u0111\u01b0\u1ee3c khi rename/drop D\u00f9ng shadow field + delay cleanup + backup tr\u01b0\u1edbc khi drop","tags":["schema","database","migration","compatibility","dx-vas"]},{"location":"ADR/adr-023-schema-migration-strategy/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>CI/CD Strategy: ADR-001</li> <li>Release Approval: ADR-018</li> <li>Deployment Strategy: ADR-015</li> <li>Schema versioning (n\u1ebfu c\u00f3): S\u1ebd b\u1ed5 sung n\u1ebfu d\u00f9ng Proto ho\u1eb7c GraphQL schema</li> </ul> <p>\u201cM\u1ed9t h\u1ec7 th\u1ed1ng t\u1ed1t kh\u00f4ng ch\u1ec9 deploy nhanh \u2013 m\u00e0 rollback \u0111\u01b0\u1ee3c c\u1ea3 khi thay \u0111\u1ed5i schema.\u201d</p>","tags":["schema","database","migration","compatibility","dx-vas"]},{"location":"ADR/adr-024-data-anonymization-retention/","title":"ADR-024 - Ch\u00ednh s\u00e1ch \u1ea9n danh h\u00f3a v\u00e0 l\u01b0u tr\u1eef d\u1eef li\u1ec7u cho h\u1ec7 th\u1ed1ng dx-vas","text":"","tags":["privacy","anonymization","retention","data-governance","dx-vas"]},{"location":"ADR/adr-024-data-anonymization-retention/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas l\u01b0u tr\u1eef v\u00e0 x\u1eed l\u00fd nhi\u1ec1u lo\u1ea1i d\u1eef li\u1ec7u c\u00f3 kh\u1ea3 n\u0103ng nh\u1eadn d\u1ea1ng c\u00e1 nh\u00e2n (PII): - Th\u00f4ng tin h\u1ecdc sinh, ph\u1ee5 huynh, gi\u00e1o vi\u00ean (h\u1ecd t\u00ean, s\u1ed1 \u0111i\u1ec7n tho\u1ea1i, email) - Nh\u1eadt k\u00fd h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng (logs, trace) - Th\u00f4ng tin c\u1ea5u h\u00ecnh t\u00e0i kho\u1ea3n, l\u1ecbch s\u1eed thao t\u00e1c h\u1ec7 th\u1ed1ng</p> <p>Ngo\u00e0i ra, h\u1ec7 th\u1ed1ng c\u00f2n c\u1ea7n sao l\u01b0u, t\u1ea1o m\u00f4i tr\u01b0\u1eddng th\u1eed nghi\u1ec7m (sandbox/dev), v\u00e0 ph\u00e2n t\u00edch s\u1ef1 ki\u1ec7n ph\u1ee5c v\u1ee5 c\u1ea3i ti\u1ebfn. N\u1ebfu kh\u00f4ng ki\u1ec3m so\u00e1t t\u1ed1t: - D\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m c\u00f3 th\u1ec3 b\u1ecb r\u00f2 r\u1ec9 ra m\u00f4i tr\u01b0\u1eddng kh\u00f4ng b\u1ea3o m\u1eadt - Log c\u00f3 th\u1ec3 ch\u1ee9a th\u00f4ng tin PII kh\u00f4ng c\u1ea7n thi\u1ebft - Th\u00f4ng tin c\u00e1 nh\u00e2n c\u00f3 th\u1ec3 b\u1ecb l\u01b0u tr\u1eef qu\u00e1 l\u00e2u m\u00e0 kh\u00f4ng c\u00f3 l\u00fd do h\u1ee3p l\u1ec7</p>","tags":["privacy","anonymization","retention","data-governance","dx-vas"]},{"location":"ADR/adr-024-data-anonymization-retention/#quyet-inh","title":"\ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh","text":"<p>Thi\u1ebft l\u1eadp ch\u00ednh s\u00e1ch ph\u00e2n lo\u1ea1i, \u1ea9n danh h\u00f3a v\u00e0 l\u01b0u tr\u1eef d\u1eef li\u1ec7u chu\u1ea9n ho\u00e1 tr\u00ean to\u00e0n h\u1ec7 th\u1ed1ng dx-vas \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o an to\u00e0n, tu\u00e2n th\u1ee7, v\u00e0 d\u1ec5 d\u00e0ng \u00e1p d\u1ee5ng sandbox ho\u1eb7c audit.</p>","tags":["privacy","anonymization","retention","data-governance","dx-vas"]},{"location":"ADR/adr-024-data-anonymization-retention/#phan-loai-du-lieu","title":"\ud83e\udde9 Ph\u00e2n lo\u1ea1i d\u1eef li\u1ec7u","text":"Lo\u1ea1i d\u1eef li\u1ec7u V\u00ed d\u1ee5 Ph\u00e2n lo\u1ea1i PII H\u1ecd t\u00ean, email, S\u0110T, IP Nh\u1ea1y c\u1ea3m \u2013 c\u1ea7n \u1ea9n danh ho\u1eb7c h\u1ea1n ch\u1ebf truy c\u1eadp Technical log API path, trace ID, latency C\u00f3 th\u1ec3 ch\u1ee9a PII n\u1ebfu bao g\u1ed3m IP \u0111\u1ea7y \u0111\u1ee7 \u2013 c\u1ea7n ki\u1ec3m so\u00e1t v\u00e0 l\u1ecdc Audit trail Ai l\u00e0m g\u00ec, l\u00fac n\u00e0o Nh\u1ea1y c\u1ea3m m\u1ee9c v\u1eeba \u2013 c\u1ea7n gi\u1eef nguy\u00ean nh\u01b0ng b\u1ea3o v\u1ec7 truy c\u1eadp Business metrics s\u1ed1 h\u1ecdc sinh \u0111\u0103ng k\u00fd, doanh thu T\u1ed5ng h\u1ee3p, kh\u00f4ng c\u1ea7n \u1ea9n danh","tags":["privacy","anonymization","retention","data-governance","dx-vas"]},{"location":"ADR/adr-024-data-anonymization-retention/#chinh-sach-an-danh-hoa-anonymization","title":"\ud83d\udd10 Ch\u00ednh s\u00e1ch \u1ea9n danh h\u00f3a (Anonymization)","text":"Tr\u01b0\u1eddng Ph\u01b0\u01a1ng ph\u00e1p Email, t\u00ean Mask (<code>n***@gmail.com</code>), randomize, fake data IP address Hash (SHA256) ho\u1eb7c c\u1eaft b\u1edbt (e.g., /24 subnet) \u2013 coi l\u00e0 PII n\u1ebfu \u0111\u1ea7y \u0111\u1ee7 M\u00e3 h\u1ecdc sinh T\u1ea1o mapping t\u1ea1m th\u1eddi (UUID \u2194 student_id) Logs ch\u1ee9a PII D\u00f9ng l\u1edbp middleware/log filter \u0111\u1ec3 l\u1ecdc/mask tr\u01b0\u1edbc khi ghi. Kh\u00f4ng log tr\u1ef1c ti\u1ebfp PII d\u00f9 \u1edf m\u1ee9c debug/info. <p>T\u1ea5t c\u1ea3 log ph\u1ea3i \u0111i qua l\u1edbp filter tr\u01b0\u1edbc khi g\u1eedi ra ngo\u00e0i (GCP Logging, Datadog...)</p>","tags":["privacy","anonymization","retention","data-governance","dx-vas"]},{"location":"ADR/adr-024-data-anonymization-retention/#sandbox-test-environment","title":"\ud83d\udce6 Sandbox &amp; Test Environment","text":"<ul> <li>Clone d\u1eef li\u1ec7u th\u1eadt \u2192 ch\u1ea1y script <code>anonymize_dataset.py</code></li> <li>D\u1eef li\u1ec7u sau khi \u1ea9n danh:</li> <li>Kh\u00f4ng c\u00f2n truy ng\u01b0\u1ee3c h\u1ecdc sinh th\u1ef1c t\u1ebf</li> <li>Kh\u00f4ng ch\u1ee9a th\u00f4ng tin li\u00ean l\u1ea1c th\u1eadt</li> <li> <p>C\u00f3 th\u1ec3 d\u00f9ng trong dev/test/demo/public QA</p> </li> <li> <p>M\u1ecdi m\u00f4i tr\u01b0\u1eddng ngo\u00e0i production b\u1eaft bu\u1ed9c d\u00f9ng d\u1eef li\u1ec7u \u0111\u00e3 \u1ea9n danh</p> </li> </ul>","tags":["privacy","anonymization","retention","data-governance","dx-vas"]},{"location":"ADR/adr-024-data-anonymization-retention/#chinh-sach-luu-tru-du-lieu-retention","title":"\ud83d\uddc2 Ch\u00ednh s\u00e1ch l\u01b0u tr\u1eef d\u1eef li\u1ec7u (Retention)","text":"Lo\u1ea1i d\u1eef li\u1ec7u Retention Ghi ch\u00fa Logs h\u1ec7 th\u1ed1ng 30 ng\u00e0y (default) C\u00f3 th\u1ec3 archive 6 th\u00e1ng v\u1edbi BigQuery Audit logs 180 ng\u00e0y (prod), 30 ng\u00e0y (dev) Tu\u00e2n th\u1ee7 audit n\u1ed9i b\u1ed9 D\u1eef li\u1ec7u h\u1ecdc sinh kh\u00f4ng c\u00f2n ho\u1ea1t \u0111\u1ed9ng 365 ng\u00e0y Tu\u00e2n th\u1ee7 theo th\u00f4ng t\u01b0 ng\u00e0nh gi\u00e1o d\u1ee5c v\u1ec1 l\u01b0u tr\u1eef h\u1ed3 s\u01a1 h\u1ecdc sinh Access token 15 ph\u00fat Theo <code>adr-006</code> \u2013 d\u00f9ng cho phi\u00ean ho\u1ea1t \u0111\u1ed9ng Refresh token 30\u201390 ng\u00e0y t\u00f9y lo\u1ea1i user Theo <code>adr-006</code> \u2013 l\u01b0u trong Redis ho\u1eb7c encrypted store <p>T\u1ea5t c\u1ea3 retention s\u1ebd \u0111\u01b0\u1ee3c ki\u1ec3m so\u00e1t qua lifecycle rule (Cloud Storage), TTL (Firestore/Redis), ho\u1eb7c job cleanup t\u1ef1 \u0111\u1ed9ng (batch script)</p>","tags":["privacy","anonymization","retention","data-governance","dx-vas"]},{"location":"ADR/adr-024-data-anonymization-retention/#bao-mat-quyen-truy-cap","title":"\ud83d\udee1\ufe0f B\u1ea3o m\u1eadt &amp; Quy\u1ec1n truy c\u1eadp","text":"<ul> <li>Ch\u1ec9 nh\u00f3m Platform/Data c\u00f3 quy\u1ec1n truy c\u1eadp d\u1eef li\u1ec7u g\u1ed1c</li> <li>M\u1ecdi export d\u1eef li\u1ec7u ph\u1ea3i:</li> <li>\u0110\u01b0\u1ee3c ghi nh\u1eadn trong audit log</li> <li>C\u00f3 l\u00fd do c\u1ee5 th\u1ec3 (debug, incident, product research)</li> <li>N\u1ebfu ch\u1ee9a PII \u2192 ph\u1ea3i x\u1eed l\u00fd \u1ea9n danh tr\u01b0\u1edbc khi chia s\u1ebb</li> </ul>","tags":["privacy","anonymization","retention","data-governance","dx-vas"]},{"location":"ADR/adr-024-data-anonymization-retention/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>\u0110\u1ea3m b\u1ea3o compliance n\u1ebfu \u00e1p d\u1ee5ng ch\u00ednh s\u00e1ch nh\u01b0 GDPR, FERPA</li> <li>H\u1ea1n ch\u1ebf r\u1ee7i ro l\u1ed9 d\u1eef li\u1ec7u qua log, demo, testing</li> <li>D\u1ec5 d\u00e0ng t\u1ea1o sandbox \u0111\u1ec3 hu\u1ea5n luy\u1ec7n AI, ki\u1ec3m th\u1eed s\u1ea3n ph\u1ea9m</li> </ul>","tags":["privacy","anonymization","retention","data-governance","dx-vas"]},{"location":"ADR/adr-024-data-anonymization-retention/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p Developer v\u00f4 t\u00ecnh log th\u00f4ng tin nh\u1ea1y c\u1ea3m Filter log + CI/CD linter check log string D\u1eef li\u1ec7u th\u1eadt l\u1ecdt ra m\u00f4i tr\u01b0\u1eddng staging Anonymize b\u1eaft bu\u1ed9c + ki\u1ec3m tra sau deploy Retention config b\u1ecb b\u1ecf qu\u00ean C\u00f3 cron job + dashboard ki\u1ec3m tra TTL, storage usage","tags":["privacy","anonymization","retention","data-governance","dx-vas"]},{"location":"ADR/adr-024-data-anonymization-retention/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Secrets: ADR-003</li> <li>Security:ADR-004</li> <li>Observability: ADR-005</li> <li>External Observability: ADR-021</li> <li>Audit Logging: ADR-008</li> <li>Schema Migration: ADR-023</li> <li>Auth Strategy: ADR-006</li> </ul> <p>\u201cD\u1eef li\u1ec7u th\u1eadt r\u1ea5t gi\u00e1 tr\u1ecb \u2013 v\u00e0 c\u00e0ng ph\u1ea3i \u0111\u01b0\u1ee3c b\u1ea3o v\u1ec7 nghi\u00eam ng\u1eb7t h\u01a1n khi d\u00f9ng sai m\u1ee5c \u0111\u00edch.\u201d</p>","tags":["privacy","anonymization","retention","data-governance","dx-vas"]},{"location":"ADR/adr-025-multi-tenant-versioning/","title":"ADR-025: Chi\u1ebfn l\u01b0\u1ee3c Phi\u00ean b\u1ea3n h\u00f3a Tenant Stack (Multi-Tenant Versioning Strategy)","text":"","tags":["multi-tenant","versioning","deployment","ci-cd","tenant-stack","release-management","backward-compatibility","staging","rollout-strategy"]},{"location":"ADR/adr-025-multi-tenant-versioning/#boi-canh","title":"B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas tri\u1ec3n khai theo m\u00f4 h\u00ecnh multi-tenant v\u1edbi m\u1ed7i tr\u01b0\u1eddng (tenant) c\u00f3 stack d\u1ecbch v\u1ee5 ri\u00eang bi\u1ec7t. Trong m\u1ed9t s\u1ed1 tr\u01b0\u1eddng h\u1ee3p th\u1ef1c t\u1ebf, kh\u00f4ng ph\u1ea3i t\u1ea5t c\u1ea3 tenant \u0111\u1ec1u s\u1eb5n s\u00e0ng n\u00e2ng c\u1ea5p l\u00ean phi\u00ean b\u1ea3n m\u1edbi c\u00f9ng l\u00fac (do l\u00fd do nghi\u1ec7p v\u1ee5, th\u1eddi gian tri\u1ec3n khai, ki\u1ec3m th\u1eed\u2026).</p> <p>Do \u0111\u00f3, h\u1ec7 th\u1ed1ng c\u1ea7n m\u1ed9t chi\u1ebfn l\u01b0\u1ee3c phi\u00ean b\u1ea3n h\u00f3a ph\u00f9 h\u1ee3p \u0111\u1ec3: - H\u1ed7 tr\u1ee3 \u0111\u1ed3ng th\u1eddi nhi\u1ec1u phi\u00ean b\u1ea3n d\u1ecbch v\u1ee5 (per tenant) - Gi\u1ea3m thi\u1ec3u r\u1ee7i ro c\u1eadp nh\u1eadt h\u00e0ng lo\u1ea1t - Cho ph\u00e9p tenant th\u1eed nghi\u1ec7m tr\u01b0\u1edbc tr\u00ean staging</p>","tags":["multi-tenant","versioning","deployment","ci-cd","tenant-stack","release-management","backward-compatibility","staging","rollout-strategy"]},{"location":"ADR/adr-025-multi-tenant-versioning/#quyet-inh","title":"Quy\u1ebft \u0111\u1ecbnh","text":"","tags":["multi-tenant","versioning","deployment","ci-cd","tenant-stack","release-management","backward-compatibility","staging","rollout-strategy"]},{"location":"ADR/adr-025-multi-tenant-versioning/#1-moi-tenant-co-thong-tin-version-rieng","title":"1. M\u1ed7i tenant c\u00f3 th\u00f4ng tin version ri\u00eang","text":"<ul> <li>Trong config (ho\u1eb7c secret) c\u1ee7a t\u1eebng tenant, c\u00f3 tr\u01b0\u1eddng <code>stack_version</code>:</li> </ul> <pre><code>tenant_id: \"abc\"\nstack_version: \"v1.3.5\"\n</code></pre> <ul> <li> <p>Gi\u00e1 tr\u1ecb n\u00e0y d\u00f9ng \u0111\u1ec3:</p> </li> <li> <p>G\u1eafn v\u00e0o log, alert, metric</p> </li> <li>\u0110\u1ecbnh danh Docker image \u0111\u01b0\u1ee3c deploy</li> <li>\u0110i\u1ec1u h\u01b0\u1edbng contract test t\u01b0\u01a1ng \u1ee9ng</li> </ul>","tags":["multi-tenant","versioning","deployment","ci-cd","tenant-stack","release-management","backward-compatibility","staging","rollout-strategy"]},{"location":"ADR/adr-025-multi-tenant-versioning/#2-pipeline-cicd-ho-tro-build-nhieu-version","title":"2. Pipeline CI/CD h\u1ed7 tr\u1ee3 build nhi\u1ec1u version","text":"<ul> <li> <p>M\u1ed7i commit \u0111\u01b0\u1ee3c tag <code>vX.Y.Z</code> s\u1ebd:</p> </li> <li> <p>Build Docker image <code>sub-user:vX.Y.Z</code></p> </li> <li>T\u1ea1o release notes, changelog t\u1ef1 \u0111\u1ed9ng</li> <li> <p>Pipeline ph\u00e1t h\u00e0nh theo tenant:</p> </li> <li> <p><code>dx-deploy --tenant abc --version v1.3.5</code></p> </li> </ul>","tags":["multi-tenant","versioning","deployment","ci-cd","tenant-stack","release-management","backward-compatibility","staging","rollout-strategy"]},{"location":"ADR/adr-025-multi-tenant-versioning/#3-tenant-staging-e-kiem-thu-truoc","title":"3. Tenant staging \u0111\u1ec3 ki\u1ec3m th\u1eed tr\u01b0\u1edbc","text":"<ul> <li>M\u1ed7i tenant c\u00f3 m\u00f4i tr\u01b0\u1eddng <code>staging.tenant-a.dx-vas.vn</code></li> <li>Tenant c\u00f3 th\u1ec3 th\u1eed phi\u00ean b\u1ea3n m\u1edbi t\u1ea1i staging tr\u01b0\u1edbc khi duy\u1ec7t l\u00ean <code>prod</code></li> </ul>","tags":["multi-tenant","versioning","deployment","ci-cd","tenant-stack","release-management","backward-compatibility","staging","rollout-strategy"]},{"location":"ADR/adr-025-multi-tenant-versioning/#4-superadmin-quan-ly-mapping-version","title":"4. Superadmin qu\u1ea3n l\u00fd mapping version","text":"<ul> <li>Superadmin Webapp c\u00f3 b\u1ea3ng mapping:</li> </ul> Tenant Version Tr\u1ea1ng th\u00e1i A v1.3.5 Production B v1.4.0-beta Staging C v1.2.9 Legacy <ul> <li>Cho ph\u00e9p ki\u1ec3m so\u00e1t rollback, hotfix ri\u00eang cho t\u1eebng tenant</li> </ul>","tags":["multi-tenant","versioning","deployment","ci-cd","tenant-stack","release-management","backward-compatibility","staging","rollout-strategy"]},{"location":"ADR/adr-025-multi-tenant-versioning/#he-qua","title":"H\u1ec7 qu\u1ea3","text":"<p>\u2705 \u01afu \u0111i\u1ec3m:</p> <ul> <li>Cho ph\u00e9p rollout theo c\u1ee5m ho\u1eb7c t\u1eebng tenant</li> <li>Gi\u1ea3m r\u1ee7i ro l\u1ed7i di\u1ec7n r\u1ed9ng</li> <li>H\u1ed7 tr\u1ee3 A/B testing, backward compatibility d\u1ec5 d\u00e0ng</li> <li>Tenant ch\u1ee7 \u0111\u1ed9ng ki\u1ec3m th\u1eed m\u00e0 kh\u00f4ng \u1ea3nh h\u01b0\u1edfng s\u1ea3n ph\u1ea9m ch\u00ednh</li> </ul> <p>\u26a0\ufe0f L\u01b0u \u00fd:</p> <ul> <li>Qu\u1ea3n l\u00fd version c\u1ea7n \u0111\u1ed3ng b\u1ed9 v\u1edbi DB schema \u2192 c\u1ea7n k\u1ebft h\u1ee3p v\u1edbi <code>adr-023-schema-migration-strategy.md</code></li> <li>T\u0103ng \u0111\u1ed9 ph\u1ee9c t\u1ea1p c\u1ee7a CI/CD &amp; Monitoring</li> </ul>","tags":["multi-tenant","versioning","deployment","ci-cd","tenant-stack","release-management","backward-compatibility","staging","rollout-strategy"]},{"location":"ADR/adr-025-multi-tenant-versioning/#lien-ket-lien-quan","title":"Li\u00ean k\u1ebft li\u00ean quan","text":"<ul> <li><code>adr-015-deployment-strategy.md</code></li> <li><code>adr-018-release-approval-policy.md</code></li> <li><code>adr-023-schema-migration-strategy.md</code></li> <li><code>adr-022-sla-slo-monitoring.md</code></li> </ul>","tags":["multi-tenant","versioning","deployment","ci-cd","tenant-stack","release-management","backward-compatibility","staging","rollout-strategy"]},{"location":"ADR/adr-026-hard-delete-policy/","title":"ADR-026: Ch\u00ednh s\u00e1ch X\u00f3a D\u1eef li\u1ec7u (Hard Delete) trong h\u1ec7 th\u1ed1ng dx-vas","text":"","tags":["data","retention","deletion","soft-delete","compliance","audit","dx-vas"]},{"location":"ADR/adr-026-hard-delete-policy/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>Trong h\u1ec7 th\u1ed1ng dx-vas, vi\u1ec7c x\u00f3a d\u1eef li\u1ec7u c\u1ea7n \u0111\u01b0\u1ee3c ki\u1ec3m so\u00e1t ch\u1eb7t ch\u1ebd \u0111\u1ec3: - \u0110\u1ea3m b\u1ea3o t\u00ednh truy v\u1ebft (auditability) - Tu\u00e2n th\u1ee7 quy \u0111\u1ecbnh ph\u00e1p l\u00fd (FERPA, GDPR, ...), ch\u00ednh s\u00e1ch ng\u00e0nh gi\u00e1o d\u1ee5c - H\u1ed7 tr\u1ee3 kh\u00f4i ph\u1ee5c (recovery) v\u00e0 ph\u00e2n t\u00edch d\u1eef li\u1ec7u trong t\u01b0\u01a1ng lai</p> <p>Vi\u1ec7c x\u00f3a v\u1eadt l\u00fd (hard delete) th\u01b0\u1eddng kh\u00f4ng \u0111\u01b0\u1ee3c khuy\u1ebfn kh\u00edch n\u1ebfu object c\u00f3 li\u00ean k\u1ebft nghi\u1ec7p v\u1ee5, quan h\u1ec7 tham chi\u1ebfu, ho\u1eb7c \u00fd ngh\u0129a l\u1ecbch s\u1eed. V\u00ec v\u1eady, h\u1ec7 th\u1ed1ng c\u1ea7n c\u00f3 m\u1ed9t chi\u1ebfn l\u01b0\u1ee3c r\u00f5 r\u00e0ng \u0111\u1ec3 x\u00e1c \u0111\u1ecbnh object n\u00e0o KH\u00d4NG n\u00ean hard delete.</p>","tags":["data","retention","deletion","soft-delete","compliance","audit","dx-vas"]},{"location":"ADR/adr-026-hard-delete-policy/#tieu-chi-khong-hard-delete","title":"\ud83e\udde0 Ti\u00eau ch\u00ed Kh\u00f4ng Hard Delete","text":"<p>M\u1ed9t object kh\u00f4ng n\u00ean hard delete n\u1ebfu tho\u1ea3 m\u00e3n m\u1ed9t ho\u1eb7c nhi\u1ec1u ti\u00eau ch\u00ed sau:</p>","tags":["data","retention","deletion","soft-delete","compliance","audit","dx-vas"]},{"location":"ADR/adr-026-hard-delete-policy/#1-co-gia-tri-lich-su-hoac-can-thiet-cho-audit","title":"1. C\u00f3 gi\u00e1 tr\u1ecb l\u1ecbch s\u1eed ho\u1eb7c c\u1ea7n thi\u1ebft cho audit","text":"<ul> <li>V\u00ed d\u1ee5: <code>users_global</code>, <code>audit_logs</code>, <code>user_tenant_assignments</code>, \u0111i\u1ec3m s\u1ed1, l\u1ecbch s\u1eed h\u1ecdc t\u1eadp</li> </ul>","tags":["data","retention","deletion","soft-delete","compliance","audit","dx-vas"]},{"location":"ADR/adr-026-hard-delete-policy/#2-co-quan-he-tham-chieu-quan-trong-foreign-key","title":"2. C\u00f3 quan h\u1ec7 tham chi\u1ebfu quan tr\u1ecdng (foreign key)","text":"<ul> <li>V\u00ed d\u1ee5: <code>users_global</code> \u2194 <code>audit_logs</code>, <code>tenants</code> \u2194 <code>user_tenant_assignments</code>, <code>roles</code> \u2194 <code>user_roles</code></li> </ul>","tags":["data","retention","deletion","soft-delete","compliance","audit","dx-vas"]},{"location":"ADR/adr-026-hard-delete-policy/#3-yeu-cau-phap-ly-hoac-compliance","title":"3. Y\u00eau c\u1ea7u ph\u00e1p l\u00fd ho\u1eb7c compliance","text":"<ul> <li>V\u00ed d\u1ee5: H\u1ed3 s\u01a1 h\u1ecdc sinh, giao d\u1ecbch h\u1ecdc ph\u00ed, PII c\u00f3 retention ri\u00eang</li> </ul>","tags":["data","retention","deletion","soft-delete","compliance","audit","dx-vas"]},{"location":"ADR/adr-026-hard-delete-policy/#4-phuc-vu-phan-tich-hoac-khoi-phuc","title":"4. Ph\u1ee5c v\u1ee5 ph\u00e2n t\u00edch ho\u1eb7c kh\u00f4i ph\u1ee5c","text":"<ul> <li>V\u00ed d\u1ee5: CRM leads, kh\u00f3a h\u1ecdc c\u0169, h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng</li> </ul>","tags":["data","retention","deletion","soft-delete","compliance","audit","dx-vas"]},{"location":"ADR/adr-026-hard-delete-policy/#5-co-kha-nang-kich-hoat-lai-reactivation","title":"5. C\u00f3 kh\u1ea3 n\u0103ng k\u00edch ho\u1ea1t l\u1ea1i (reactivation)","text":"<ul> <li>V\u00ed d\u1ee5: Nh\u00e2n s\u1ef1 quay l\u1ea1i, tr\u01b0\u1eddng ho\u1ea1t \u0111\u1ed9ng tr\u1edf l\u1ea1i, ph\u00e2n quy\u1ec1n \u0111\u01b0\u1ee3c kh\u00f4i ph\u1ee5c</li> </ul>","tags":["data","retention","deletion","soft-delete","compliance","audit","dx-vas"]},{"location":"ADR/adr-026-hard-delete-policy/#danh-sach-object-khong-uoc-hard-delete","title":"\u2705 Danh s\u00e1ch object KH\u00d4NG \u0111\u01b0\u1ee3c hard delete","text":"Object Gi\u1ea3i ph\u00e1p thay th\u1ebf hard delete <code>users_global</code> Tr\u01b0\u1eddng <code>status</code>: <code>active</code> / <code>inactive</code> / <code>deleted</code> <code>tenants</code> Tr\u01b0\u1eddng <code>status</code>: <code>active</code> / <code>suspended</code> / <code>archived</code> <code>user_tenant_assignments</code> Tr\u01b0\u1eddng <code>assignment_status</code>: <code>active</code> / <code>revoked</code> <code>roles_in_tenant</code> Tr\u01b0\u1eddng <code>status</code> ho\u1eb7c <code>is_active</code> <code>global_roles_templates</code> Tr\u01b0\u1eddng <code>status</code> ho\u1eb7c <code>is_archived</code> <code>permissions_in_tenant</code>, <code>global_permissions_templates</code> Kh\u00f4ng x\u00f3a, ch\u1ec9 deprecate code <code>student_records</code> (SIS) Tr\u01b0\u1eddng <code>enrollment_status</code>, <code>is_archived</code> \u0110i\u1ec3m s\u1ed1, giao d\u1ecbch h\u1ecdc ph\u00ed Kh\u00f4ng bao gi\u1edd x\u00f3a, c\u00f3 retention policy <code>audit_logs</code> L\u01b0u tr\u1eef c\u00f3 th\u1eddi h\u1ea1n, kh\u00f4ng x\u00f3a th\u1ee7 c\u00f4ng Leads (CRM) Soft delete ho\u1eb7c archive sau th\u1eddi gian kh\u00f4ng ho\u1ea1t \u0111\u1ed9ng","tags":["data","retention","deletion","soft-delete","compliance","audit","dx-vas"]},{"location":"ADR/adr-026-hard-delete-policy/#cach-trien-khai-soft-delete-archive","title":"\ud83e\uddf0 C\u00e1ch tri\u1ec3n khai Soft Delete / Archive","text":"<ul> <li>D\u00f9ng tr\u01b0\u1eddng <code>status</code>, <code>is_deleted</code>, <code>is_archived</code>, t\u00f9y ng\u1eef c\u1ea3nh</li> <li>Logic API ph\u1ea3i filter c\u00e1c b\u1ea3n ghi \u0111\u00e3 b\u1ecb soft delete</li> <li>C\u00f3 th\u1ec3 thi\u1ebft l\u1eadp cronjob d\u1ecdn d\u1eb9p (purge) theo retention policy r\u00f5 r\u00e0ng</li> </ul>","tags":["data","retention","deletion","soft-delete","compliance","audit","dx-vas"]},{"location":"ADR/adr-026-hard-delete-policy/#object-co-the-hard-delete-an-toan","title":"\u2705 Object c\u00f3 th\u1ec3 hard delete an to\u00e0n","text":"Object \u0110i\u1ec1u ki\u1ec7n Temporary upload file H\u1ebft h\u1ea1n sau 7 ng\u00e0y OTP, m\u00e3 x\u00e1c minh H\u1ebft h\u1ea1n, kh\u00f4ng c\u00f2n d\u00f9ng Draft form ch\u01b0a submit Sau 30 ng\u00e0y ho\u1eb7c khi user xo\u00e1","tags":["data","retention","deletion","soft-delete","compliance","audit","dx-vas"]},{"location":"ADR/adr-026-hard-delete-policy/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>B\u1ea3o to\u00e0n d\u1eef li\u1ec7u c\u00f3 gi\u00e1 tr\u1ecb</li> <li>H\u1ed7 tr\u1ee3 audit, rollback, reactivation</li> <li>\u0110\u00e1p \u1ee9ng quy \u0111\u1ecbnh compliance v\u00e0 ph\u00e2n t\u00edch nghi\u1ec7p v\u1ee5</li> </ul>","tags":["data","retention","deletion","soft-delete","compliance","audit","dx-vas"]},{"location":"ADR/adr-026-hard-delete-policy/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p Qu\u00e1 t\u1ea3i d\u1eef li\u1ec7u \"\u0111\u00e3 xo\u00e1\" C\u00f3 purge policy theo th\u1eddi gian Developer l\u1ee1 xo\u00e1 nh\u1ea7m B\u1eaft bu\u1ed9c soft delete m\u1eb7c \u0111\u1ecbnh qua API Kh\u00f4ng th\u1ed1ng nh\u1ea5t tr\u1ea1ng th\u00e1i X\u00e2y d\u1ef1ng enum <code>status</code> chu\u1ea9n d\u00f9ng chung to\u00e0n h\u1ec7 th\u1ed1ng","tags":["data","retention","deletion","soft-delete","compliance","audit","dx-vas"]},{"location":"ADR/adr-026-hard-delete-policy/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Data Retention &amp; Privacy: ADR-024</li> <li>Audit Logging: ADR-008</li> <li>User Service: ADR-006, ADR-007</li> <li>Schema Migration: ADR-023</li> </ul> <p>\u201cD\u1eef li\u1ec7u kh\u00f4ng bao gi\u1edd ch\u1ec9 l\u00e0 d\u1eef li\u1ec7u \u2013 n\u00f3 l\u00e0 l\u1ecbch s\u1eed, ph\u00e1p l\u00fd, v\u00e0 s\u1ef1 th\u1eadt c\u1ea7n \u0111\u01b0\u1ee3c b\u1ea3o v\u1ec7.\u201d</p>","tags":["data","retention","deletion","soft-delete","compliance","audit","dx-vas"]},{"location":"ADR/adr-027-data-management-strategy/","title":"ADR-027: Chi\u1ebfn l\u01b0\u1ee3c Qu\u1ea3n l\u00fd D\u1eef li\u1ec7u cho h\u1ec7 th\u1ed1ng dx-vas","text":"","tags":["data","retention","anonymization","deletion","audit","schema","dx-vas"]},{"location":"ADR/adr-027-data-management-strategy/#boi-canh","title":"\ud83d\udccc B\u1ed1i c\u1ea3nh","text":"<p>H\u1ec7 th\u1ed1ng dx-vas x\u1eed l\u00fd nhi\u1ec1u lo\u1ea1i d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m, l\u1ecbch s\u1eed, v\u00e0 nghi\u1ec7p v\u1ee5 \u2013 bao g\u1ed3m th\u00f4ng tin h\u1ecdc sinh, nh\u00e2n vi\u00ean, ph\u00e2n quy\u1ec1n, h\u1ecdc ph\u00ed, log s\u1ef1 ki\u1ec7n... Vi\u1ec7c qu\u1ea3n l\u00fd d\u1eef li\u1ec7u kh\u00f4ng ch\u1ec9 c\u1ea7n tu\u00e2n th\u1ee7 c\u00e1c quy \u0111\u1ecbnh ph\u00e1p l\u00fd (FERPA, GDPR) m\u00e0 c\u00f2n ph\u1ea3i \u0111\u1ea3m b\u1ea3o: - T\u00ednh truy v\u1ebft v\u00e0 kh\u00f4i ph\u1ee5c (audit &amp; recovery) - B\u1ea3o m\u1eadt v\u00e0 gi\u1edbi h\u1ea1n truy c\u1eadp h\u1ee3p l\u00fd - T\u1ed1i \u01b0u h\u00f3a chi ph\u00ed l\u01b0u tr\u1eef &amp; hi\u1ec7u su\u1ea5t</p>","tags":["data","retention","anonymization","deletion","audit","schema","dx-vas"]},{"location":"ADR/adr-027-data-management-strategy/#thanh-phan-chien-luoc-quan-ly-du-lieu","title":"\ud83e\uddf1 Th\u00e0nh ph\u1ea7n chi\u1ebfn l\u01b0\u1ee3c qu\u1ea3n l\u00fd d\u1eef li\u1ec7u","text":"","tags":["data","retention","anonymization","deletion","audit","schema","dx-vas"]},{"location":"ADR/adr-027-data-management-strategy/#1-phan-loai-du-lieu","title":"1. Ph\u00e2n lo\u1ea1i d\u1eef li\u1ec7u","text":"Lo\u1ea1i d\u1eef li\u1ec7u V\u00ed d\u1ee5 Ghi ch\u00fa PII (c\u00f3 th\u1ec3 \u0111\u1ecbnh danh) H\u1ecd t\u00ean, email, IP, S\u0110T Ph\u1ea3i \u0111\u01b0\u1ee3c mask ho\u1eb7c \u1ea9n danh khi kh\u00f4ng c\u00f2n s\u1eed d\u1ee5ng D\u1eef li\u1ec7u nghi\u1ec7p v\u1ee5 \u0110i\u1ec3m s\u1ed1, l\u1ecbch s\u1eed l\u1edbp h\u1ecdc, user-role Gi\u1eef l\u00e2u d\u00e0i, ph\u1ee5c v\u1ee5 ph\u00e2n t\u00edch v\u00e0 audit D\u1eef li\u1ec7u t\u1ea1m th\u1eddi OTP, upload draft, x\u00e1c minh C\u00f3 th\u1ec3 hard delete sau 1\u20137 ng\u00e0y Logs / Audit trail request logs, h\u00e0nh \u0111\u1ed9ng ng\u01b0\u1eddi d\u00f9ng Kh\u00f4ng x\u00f3a th\u1ee7 c\u00f4ng, c\u00f3 retention r\u00f5 r\u00e0ng D\u1eef li\u1ec7u ph\u00e2n t\u00edch T\u1ed5ng h\u1ee3p s\u1ed1 li\u1ec7u, h\u00e0nh vi C\u00f3 th\u1ec3 \u1ea9n danh \u0111\u1ec3 d\u00f9ng l\u00e2u d\u00e0i cho BI/ML","tags":["data","retention","anonymization","deletion","audit","schema","dx-vas"]},{"location":"ADR/adr-027-data-management-strategy/#2-chinh-sach-anonymization-privacy","title":"2. Ch\u00ednh s\u00e1ch Anonymization &amp; Privacy","text":"<p>Theo ADR-024 - Data Anonymization Retention: - D\u1eef li\u1ec7u production ch\u1ec9 d\u00f9ng cho dev/test sau khi \u0111\u00e3 \u1ea9n danh h\u00f3a - Email \u2192 <code>n***@gmail.com</code>, IP \u2192 <code>/24 subnet</code> ho\u1eb7c SHA256 - Logs ph\u1ea3i \u0111\u01b0\u1ee3c filter \u0111\u1ec3 lo\u1ea1i b\u1ecf PII tr\u01b0\u1edbc khi g\u1eedi ra ngo\u00e0i</p>","tags":["data","retention","anonymization","deletion","audit","schema","dx-vas"]},{"location":"ADR/adr-027-data-management-strategy/#3-soft-delete-retention","title":"3. Soft Delete &amp; Retention","text":"<p>Theo ADR-026 - Hard Delete Policy: - KH\u00d4NG hard delete c\u00e1c object c\u00f3 li\u00ean k\u1ebft l\u1ecbch s\u1eed, audit, compliance, ho\u1eb7c kh\u1ea3 n\u0103ng ph\u1ee5c h\u1ed3i - S\u1eed d\u1ee5ng <code>status</code>, <code>is_deleted</code>, <code>is_archived</code> \u0111\u1ec3 soft delete - Cronjob \u0111\u1ecbnh k\u1ef3 c\u00f3 th\u1ec3 purge d\u1eef li\u1ec7u \u0111\u00e3 b\u1ecb x\u00f3a m\u1ec1m sau 365 ng\u00e0y (n\u1ebfu h\u1ee3p l\u1ec7)</p> Object Tr\u1ea1ng th\u00e1i soft delete Retention t\u1ed1i thi\u1ec3u <code>users_global</code> <code>status = deleted</code> \u2265 1 n\u0103m <code>user_tenant_assignments</code> <code>assignment_status = revoked</code> \u2265 1 n\u0103m <code>student_records</code> <code>is_archived = true</code> \u2265 5 n\u0103m <code>audit_logs</code> Kh\u00f4ng \u0111\u01b0\u1ee3c x\u00f3a 180 ng\u00e0y (prod) OTP / Draft X\u00f3a v\u1eadt l\u00fd 1\u20137 ng\u00e0y","tags":["data","retention","anonymization","deletion","audit","schema","dx-vas"]},{"location":"ADR/adr-027-data-management-strategy/#4-migration-schema-tinh-tuong-thich","title":"4. Migration Schema &amp; T\u00ednh t\u01b0\u01a1ng th\u00edch","text":"<p>Theo ADR-023 - Schema Migration Strategy: - M\u1ecdi thay \u0111\u1ed5i schema \u0111\u1ec1u ph\u1ea3i qua b\u01b0\u1edbc chu\u1ea9n b\u1ecb \u2192 chuy\u1ec3n ti\u1ebfp \u2192 d\u1ecdn d\u1eb9p - Kh\u00f4ng rename/drop tr\u1ef1c ti\u1ebfp trong b\u1ea3n deploy - Script migration v\u00e0 rollback \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd ri\u00eang qua CI/CD</p>","tags":["data","retention","anonymization","deletion","audit","schema","dx-vas"]},{"location":"ADR/adr-027-data-management-strategy/#5-quy-trinh-truy-cap-bao-mat-du-lieu","title":"5. Quy tr\u00ecnh truy c\u1eadp &amp; b\u1ea3o m\u1eadt d\u1eef li\u1ec7u","text":"<p>Theo ADR-003 - Secrets v\u00e0 ADR-004 - Security: - Secrets l\u01b0u trong Google Secret Manager theo m\u00f4i tr\u01b0\u1eddng - Truy c\u1eadp PII ch\u1ec9 \u0111\u01b0\u1ee3c c\u1ea5p cho nh\u00f3m Platform/Data c\u00f3 audit trail - M\u1ecdi action export d\u1eef li\u1ec7u th\u1eadt ph\u1ea3i log v\u00e0 ghi l\u00fd do</p>","tags":["data","retention","anonymization","deletion","audit","schema","dx-vas"]},{"location":"ADR/adr-027-data-management-strategy/#6-cost-observability-logging","title":"6. Cost Observability &amp; Logging","text":"<p>Theo ADR-020 - Cost Observability: - M\u1ecdi service/data resource g\u1eafn tag: <code>dx-vas_service</code>, <code>env</code>, <code>team</code> - Thi\u1ebft l\u1eadp alert n\u1ebfu chi ph\u00ed logging, Redis, Cloud Run v\u01b0\u1ee3t ng\u01b0\u1ee1ng - Export billing \u2192 BigQuery \u2192 Dashboard Looker Studio</p> <p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 MARKDOWN BLOCK c\u1eadp nh\u1eadt cho <code>adr-027-data-management-strategy.md</code> theo c\u00e1c change request m\u1edbi:</p>","tags":["data","retention","anonymization","deletion","audit","schema","dx-vas"]},{"location":"ADR/adr-027-data-management-strategy/#7-tich-hop-voi-data-warehouse-reporting-service","title":"7. T\u00edch h\u1ee3p v\u1edbi Data Warehouse / Reporting Service","text":"<ul> <li>D\u1eef li\u1ec7u ph\u00e2n t\u00edch t\u1eeb c\u00e1c service ngu\u1ed3n s\u1ebd \u0111\u01b0\u1ee3c tr\u00edch xu\u1ea5t \u0111\u1ecbnh k\u1ef3 ho\u1eb7c realtime v\u00e0o Data Warehouse (BigQuery) \u0111\u1ec3 ph\u1ee5c v\u1ee5 b\u00e1o c\u00e1o, ph\u00e2n t\u00edch, v\u00e0 AI.</li> <li> <p>C\u00e1c b\u1ea3ng/fact table trong Data Warehouse ph\u1ea3i:</p> </li> <li> <p>\u0110\u01b0\u1ee3c t\u00e1ch ri\u00eang kh\u1ecfi OLTP schema.</p> </li> <li>C\u00f3 quy \u01b0\u1edbc version/schema r\u00f5 r\u00e0ng (tu\u00e2n theo <code>ADR-030 - Event Schema Governance</code> n\u1ebfu sinh t\u1eeb Pub/Sub).</li> <li>C\u00f3 retention ph\u00f9 h\u1ee3p: t\u1ed1i thi\u1ec3u 1 n\u0103m, \u01b0u ti\u00ean l\u01b0u l\u00e2u d\u00e0i d\u1ea1ng \u0111\u00e3 \u1ea9n danh.</li> <li> <p>M\u1ecdi ETL pipeline ph\u1ea3i:</p> </li> <li> <p>Ghi log \u0111\u1ea7y \u0111\u1ee7 v\u00e0 c\u00f3 c\u01a1 ch\u1ebf ki\u1ec3m tra ch\u1ea5t l\u01b0\u1ee3ng d\u1eef li\u1ec7u (data quality checks).</p> </li> <li>Mask th\u00f4ng tin nh\u1ea1y c\u1ea3m tr\u01b0\u1edbc khi ghi d\u1eef li\u1ec7u v\u00e0o b\u1ea3ng ph\u00e2n t\u00edch, tr\u1eeb khi \u0111\u00e3 \u0111\u01b0\u1ee3c \u1ee7y quy\u1ec1n.</li> <li>Tu\u00e2n th\u1ee7 chi\u1ebfn l\u01b0\u1ee3c \u1ea9n danh h\u00f3a c\u1ee7a <code>ADR-024</code>.</li> </ul>","tags":["data","retention","anonymization","deletion","audit","schema","dx-vas"]},{"location":"ADR/adr-027-data-management-strategy/#loi-ich","title":"\u2705 L\u1ee3i \u00edch","text":"<ul> <li>D\u1ec5 truy v\u1ebft, kh\u00f4i ph\u1ee5c v\u00e0 ph\u00e2n t\u00edch d\u1eef li\u1ec7u l\u1ecbch s\u1eed</li> <li>Tu\u00e2n th\u1ee7 t\u1ed1t c\u00e1c y\u00eau c\u1ea7u ph\u00e1p l\u00fd v\u00e0 ch\u00ednh s\u00e1ch n\u1ed9i b\u1ed9</li> <li>T\u1ed1i \u01b0u hi\u1ec7u su\u1ea5t v\u00e0 chi ph\u00ed l\u01b0u tr\u1eef</li> <li>Tr\u00e1nh l\u1ed7i x\u00f3a d\u1eef li\u1ec7u kh\u00f4ng th\u1ec3 kh\u00f4i ph\u1ee5c</li> </ul>","tags":["data","retention","anonymization","deletion","audit","schema","dx-vas"]},{"location":"ADR/adr-027-data-management-strategy/#rui-ro-giai-phap","title":"\u274c R\u1ee7i ro &amp; Gi\u1ea3i ph\u00e1p","text":"R\u1ee7i ro Gi\u1ea3i ph\u00e1p Qu\u1ea3n l\u00fd tr\u1ea1ng th\u00e1i soft delete thi\u1ebfu th\u1ed1ng nh\u1ea5t Chu\u1ea9n h\u00f3a enum <code>status</code>, enforce qua CI/CD D\u1eef li\u1ec7u th\u1eadt b\u1ecb d\u00f9ng sai m\u1ee5c \u0111\u00edch T\u1ea5t c\u1ea3 m\u00f4i tr\u01b0\u1eddng dev/staging ph\u1ea3i d\u00f9ng d\u1eef li\u1ec7u \u0111\u00e3 \u1ea9n danh Qu\u00e1 t\u1ea3i d\u1eef li\u1ec7u log ho\u1eb7c d\u1eef li\u1ec7u c\u0169 Purge t\u1ef1 \u0111\u1ed9ng, cold storage, retention policy","tags":["data","retention","anonymization","deletion","audit","schema","dx-vas"]},{"location":"ADR/adr-027-data-management-strategy/#tai-lieu-lien-quan","title":"\ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>ADR-003 - Secrets</li> <li>ADR-004 - Security</li> <li>ADR-023 - Schema Migration</li> <li>ADR-024 - Data Anonymization &amp; Retention</li> <li>ADR-026 - Hard Delete Policy</li> <li>ADR-020 - Cost Observability</li> <li>ADR-028 - Reporting Architecture</li> <li>ADR-029 - Report Template Schema</li> <li>ADR-030 - Event Schema Governance</li> </ul> <p>\u201cD\u1eef li\u1ec7u t\u1ed1t l\u00e0 d\u1eef li\u1ec7u \u0111\u01b0\u1ee3c ki\u1ec3m so\u00e1t, b\u1ea3o v\u1ec7 v\u00e0 hi\u1ec3u \u0111\u00fang m\u1ee5c \u0111\u00edch.\u201d</p>","tags":["data","retention","anonymization","deletion","audit","schema","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/","title":"ADR-028: Ki\u1ebfn tr\u00fac h\u1ec7 th\u1ed1ng b\u00e1o c\u00e1o v\u00e0 ph\u00e2n t\u00edch \u0111a tenant","text":"","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/#1-boi-canh-context","title":"1. \ud83d\udccc B\u1ed1i c\u1ea3nh (Context)","text":"<p>H\u1ec7 th\u1ed1ng DX-VAS hi\u1ec7n t\u1ea1i ch\u01b0a c\u00f3 n\u1ec1n t\u1ea3ng b\u00e1o c\u00e1o t\u1eadp trung ph\u1ee5c v\u1ee5 cho c\u00e1c y\u00eau c\u1ea7u v\u1eadn h\u00e0nh t\u1eeb Ban Gi\u00e1m \u0111\u1ed1c (BoD), \u0111\u1eb7c bi\u1ec7t l\u00e0 b\u00e1o c\u00e1o c\u00f3 t\u00ednh t\u1ed5ng h\u1ee3p, \u0111a tenant v\u00e0 kh\u1ea3 n\u0103ng t\u00f9y bi\u1ebfn linh ho\u1ea1t. Vi\u1ec7c ch\u1ea1y truy v\u1ea5n ph\u00e2n t\u00edch tr\u00ean h\u1ec7 th\u1ed1ng transactional (OLTP) hi\u1ec7n t\u1ea1i kh\u00f4ng \u0111\u1ea3m b\u1ea3o hi\u1ec7u n\u0103ng, b\u1ea3o m\u1eadt v\u00e0 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng.</p> <p>Trong khi \u0111\u00f3, c\u00e1c h\u1ec7 th\u1ed1ng hi\u1ec7n t\u1ea1i nh\u01b0 User Service, Auth, CRM/SIS/LMS \u0111\u1ec1u ph\u00e1t sinh nhi\u1ec1u d\u1eef li\u1ec7u quan tr\u1ecdng c\u1ea7n \u0111\u01b0\u1ee3c t\u1ed5ng h\u1ee3p, ph\u00e2n t\u00edch v\u00e0 tr\u1ef1c quan h\u00f3a. \u0110\u1ed3ng th\u1eddi, l\u1ed9 tr\u00ecnh t\u00edch h\u1ee3p AI Agent h\u1ed7 tr\u1ee3 BoD trong t\u01b0\u01a1ng lai y\u00eau c\u1ea7u d\u1eef li\u1ec7u ph\u1ea3i \u0111\u01b0\u1ee3c chu\u1ea9n h\u00f3a, c\u00f3 phi\u00ean b\u1ea3n v\u00e0 d\u1ec5 truy xu\u1ea5t.</p> <p>N\u1ebfu kh\u00f4ng \u0111\u01b0a ra quy\u1ebft \u0111\u1ecbnh s\u1edbm, to\u00e0n h\u1ec7 th\u1ed1ng s\u1ebd \u0111\u1ed1i m\u1eb7t v\u1edbi nguy c\u01a1: - Truy v\u1ea5n b\u00e1o c\u00e1o ch\u1eadm v\u00e0 \u1ea3nh h\u01b0\u1edfng \u0111\u1ebfn h\u1ec7 th\u1ed1ng ch\u00ednh. - Kh\u00f4ng th\u1ec3 t\u1ed5ng h\u1ee3p v\u00e0 chu\u1ea9n h\u00f3a th\u00f4ng tin gi\u1eefa c\u00e1c tenant. - Kh\u00f4ng th\u1ec3 m\u1edf r\u1ed9ng kh\u1ea3 n\u0103ng t\u1ef1 \u0111\u1ed9ng h\u00f3a / t\u00edch h\u1ee3p AI dashboard.</p>","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/#2-quyet-inh-decision","title":"2. \ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh (Decision)","text":"<p>Ch\u00fang t\u00f4i quy\u1ebft \u0111\u1ecbnh thi\u1ebft k\u1ebf v\u00e0 tri\u1ec3n khai m\u1ed9t n\u1ec1n t\u1ea3ng b\u00e1o c\u00e1o m\u1edbi bao g\u1ed3m:</p> <ul> <li>M\u1ed9t Reporting Service chuy\u00ean bi\u1ec7t (microservice m\u1edbi).</li> <li>M\u1ed9t Data Warehouse v\u1edbi schema chu\u1ea9n h\u00f3a, h\u1ed7 tr\u1ee3 truy v\u1ea5n OLAP.</li> <li>Data Pipeline g\u1ed3m c\u1ea3 Pub/Sub (streaming) v\u00e0 Batch ETL.</li> <li>Superadmin Webapp s\u1ebd t\u00edch h\u1ee3p hai module m\u1edbi: tr\u00ecnh xem b\u00e1o c\u00e1o v\u00e0 tr\u00ecnh qu\u1ea3n l\u00fd report template.</li> <li>B\u00e1o c\u00e1o \u0111\u01b0\u1ee3c ki\u1ec3m so\u00e1t ch\u1eb7t ch\u1ebd qua RBAC, c\u00f3 audit log v\u00e0 xu\u1ea5t hi\u1ec7n trong h\u1ec7 th\u1ed1ng permission to\u00e0n c\u1ee5c.</li> </ul>","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/#3-chi-tiet-thiet-ke-giai-phap-design-solution-details","title":"3. \ud83e\uddf1 Chi ti\u1ebft Thi\u1ebft k\u1ebf / Gi\u1ea3i ph\u00e1p (Design / Solution Details)","text":"","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/#31-thanh-phan-moi-va-so-o-kien-truc","title":"3.1. Th\u00e0nh ph\u1ea7n m\u1edbi v\u00e0 s\u01a1 \u0111\u1ed3 ki\u1ebfn tr\u00fac","text":"<pre><code>flowchart TD\n  subgraph Sources\n    US(User Service)\n    AS(Auth Service)\n    AD(Adapters: CRM/SIS/LMS)\n  end\n\n  subgraph Ingestion\n    PS(Pub/Sub CDC)\n    ETL(Batch ETL Jobs)\n  end\n\n  subgraph Storage\n    DW(Data Warehouse)\n  end\n\n  subgraph Reporting Layer\n    RS(Reporting Service)\n  end\n\n  subgraph Frontend\n    WEB(Superadmin Webapp)\n  end\n\n  US --&gt; PS\n  AS --&gt; PS\n  AD --&gt; ETL\n  PS --&gt; DW\n  ETL --&gt; DW\n  DW --&gt; RS\n  RS --&gt; WEB\n</code></pre> <ul> <li><code>Reporting Service</code>:</li> <li>API: <code>/reports</code>, <code>/report-templates</code>, <code>/saved-reports</code></li> <li>Truy v\u1ea5n tr\u00ean predefined views ho\u1eb7c validated query templates: l\u00e0 nh\u1eefng c\u1ea5u tr\u00fac truy v\u1ea5n \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a tr\u01b0\u1edbc, cho ph\u00e9p truy\u1ec1n tham s\u1ed1 \u0111\u1ea7u v\u00e0o nh\u01b0ng kh\u00f4ng cho ph\u00e9p thay \u0111\u1ed5i logic l\u00f5i. C\u00e1c template n\u00e0y \u0111\u01b0\u1ee3c l\u01b0u tr\u1eef nh\u01b0 m\u1ed9t ph\u1ea7n c\u1ee7a Report Template (chi ti\u1ebft t\u1ea1i ADR-029).</li> <li>Tr\u1ea3 d\u1eef li\u1ec7u theo <code>ReportEnvelope</code> chu\u1ea9n <code>ADR-012</code></li> <li> <p>Ghi log truy c\u1eadp theo <code>ADR-008</code></p> </li> <li> <p><code>Data Warehouse</code>:</p> </li> <li>Fact tables: <code>fact_login</code>, <code>fact_user</code>, <code>fact_permission</code></li> <li>Dim tables: <code>dim_tenant</code>, <code>dim_time</code>, <code>dim_role</code></li> <li>Partition theo th\u1eddi gian + tenant</li> <li> <p>H\u1ed7 tr\u1ee3 schema versioning v\u00e0 schema evolution \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng v\u00e0 b\u1ea3o tr\u00ec khi c\u00e1c service ngu\u1ed3n thay \u0111\u1ed5i d\u1eef li\u1ec7u.</p> </li> <li> <p><code>Data Pipeline</code>:</p> </li> <li>CDC t\u1eeb Pub/Sub: <code>vas.auth.login.v1</code>, <code>vas.user.created.v1</code>, <code>vas.lms.activity.v1</code></li> <li>Batch extract t\u1eeb APIs n\u1ebfu adapter kh\u00f4ng h\u1ed7 tr\u1ee3 Pub/Sub</li> <li> <p>C\u1ea7n t\u00edch h\u1ee3p c\u00e1c b\u01b0\u1edbc ki\u1ec3m tra ch\u1ea5t l\u01b0\u1ee3ng d\u1eef li\u1ec7u (Data Quality checks) trong qu\u00e1 tr\u00ecnh ETL/ELT \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o t\u00ednh \u0111\u00fang \u0111\u1eafn v\u00e0 \u0111\u00e1ng tin c\u1eady c\u1ee7a d\u1eef li\u1ec7u \u0111\u1ea7u v\u00e0o.</p> </li> <li> <p><code>UI Webapp</code>:</p> </li> <li>Module 1: B\u00e1o c\u00e1o (viewer, filter, chart)</li> <li>Module 2: Qu\u1ea3n l\u00fd m\u1eabu (define, test, assign permission)</li> </ul>","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/#32-kien-truc-phan-quyen-va-bao-mat","title":"3.2. Ki\u1ebfn tr\u00fac ph\u00e2n quy\u1ec1n v\u00e0 b\u1ea3o m\u1eadt","text":"<ul> <li>RBAC \u00e1p d\u1ee5ng tr\u00ean t\u1eebng API: v\u00ed d\u1ee5 <code>report.view_usage</code>, <code>report.manage_templates</code></li> <li>M\u1ed7i b\u00e1o c\u00e1o c\u00f3 metadata <code>required_permission</code>, <code>scope</code>, <code>tenant_mode</code> \u2192 \u0111\u01b0\u1ee3c l\u01b0u nh\u01b0 m\u1ed9t ph\u1ea7n c\u1ee7a c\u1ea5u tr\u00fac Report Template (\u0111\u1ecbnh ngh\u0129a chi ti\u1ebft t\u1ea1i ADR-029).</li> <li>Truy v\u1ea5n c\u00e1 nh\u00e2n h\u00f3a cho ng\u01b0\u1eddi d\u00f9ng (qua <code>saved-config</code>)</li> <li>Audit log ghi: user, report_id, params, duration</li> </ul>","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/#33-adr-va-he-thong-quan-ly-schema","title":"3.3. ADR v\u00e0 h\u1ec7 th\u1ed1ng qu\u1ea3n l\u00fd schema","text":"<ul> <li>T\u1ea1o <code>adr-029-report-template-schema.md</code> \u0111\u1ec3 m\u00f4 t\u1ea3 chu\u1ea9n template</li> <li>T\u1ea1o <code>adr-030-event-schema-governance.md</code> \u0111\u1ec3 qu\u1ea3n l\u00fd versioning Pub/Sub schema</li> <li>Chu\u1ea9n h\u00f3a c\u00e1c s\u1ef1 ki\u1ec7n g\u1eedi t\u1eeb c\u00e1c service hi\u1ec7n t\u1ea1i</li> </ul>","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/#4-he-qua-consequences","title":"4. \u2705 H\u1ec7 qu\u1ea3 (Consequences)","text":"","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/#41-uu-iem","title":"4.1. \u01afu \u0111i\u1ec3m","text":"<ul> <li>\u2705 Cho ph\u00e9p t\u1ed5ng h\u1ee3p d\u1eef li\u1ec7u xuy\u00ean tenant m\u00e0 v\u1eabn \u0111\u1ea3m b\u1ea3o ph\u00e2n quy\u1ec1n.</li> <li>\u2705 T\u1ed1i \u01b0u h\u00f3a hi\u1ec7u n\u0103ng truy v\u1ea5n b\u1eb1ng c\u00e1ch t\u00e1ch bi\u1ec7t OLAP/OLTP.</li> <li>\u2705 \u0110\u1eb7t n\u1ec1n m\u00f3ng cho dashboard AI-ready v\u00e0 automation.</li> <li>\u2705 C\u1ea3i thi\u1ec7n t\u00ednh minh b\u1ea1ch v\u00e0 gi\u00e1m s\u00e1t qua audit logging.</li> </ul>","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/#42-nhuoc-iem-rui-ro-luu-y","title":"4.2. Nh\u01b0\u1ee3c \u0111i\u1ec3m / R\u1ee7i ro / L\u01b0u \u00fd","text":"<ul> <li>\u26a0\ufe0f Ph\u1ee9c t\u1ea1p h\u01a1n trong tri\u1ec3n khai: th\u00eam nhi\u1ec1u th\u00e0nh ph\u1ea7n m\u1edbi</li> <li>Gi\u1ea3i ph\u00e1p: \u00c1p d\u1ee5ng roadmap 8 tu\u1ea7n, chia nh\u1ecf module theo milestone</li> <li>\u26a0\ufe0f Chi ph\u00ed s\u1eed d\u1ee5ng warehouse (BigQuery, etc)</li> <li>Gi\u1ea3i ph\u00e1p: Theo d\u00f5i v\u00e0 t\u1ed1i \u01b0u chi ph\u00ed qua <code>ADR-020</code>, d\u00f9ng tier cold/hot</li> <li>\u26a0\ufe0f Y\u00eau c\u1ea7u schema \u0111\u1ed3ng nh\u1ea5t t\u1eeb c\u00e1c adapter c\u0169</li> <li>Gi\u1ea3i ph\u00e1p: T\u1ea1o wrapper services ho\u1eb7c schema mapping adapters</li> </ul>","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/#43-tac-ong-en-cac-thanh-phan-khac","title":"4.3. T\u00e1c \u0111\u1ed9ng \u0111\u1ebfn c\u00e1c th\u00e0nh ph\u1ea7n kh\u00e1c","text":"<ul> <li>User Service Master: c\u1ea7n expose th\u00eam permission <code>report.*</code></li> <li>Auth Service: c\u1ea7n ph\u00e1t s\u1ef1 ki\u1ec7n login th\u00e0nh c\u00f4ng c\u00f3 d\u1ea1ng chu\u1ea9n</li> <li>Superadmin Webapp: th\u00eam 2 module m\u1edbi</li> <li>ADR-020: c\u1ea7n b\u1ed5 sung ph\u1ea7n qu\u1ea3n l\u00fd cost cho query OLAP</li> </ul>","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/#5-cac-phuong-an-khac-a-can-nhac","title":"5. \ud83d\udd04 C\u00e1c Ph\u01b0\u01a1ng \u00e1n Kh\u00e1c \u0111\u00e3 C\u00e2n nh\u1eafc","text":"","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/#51-phuong-an-a-goi-truc-tiep-vao-oltp-e-tao-bao-cao","title":"5.1. Ph\u01b0\u01a1ng \u00e1n A: G\u1ecdi tr\u1ef1c ti\u1ebfp v\u00e0o OLTP \u0111\u1ec3 t\u1ea1o b\u00e1o c\u00e1o","text":"<ul> <li>L\u00fd do kh\u00f4ng ch\u1ecdn: \u1ea2nh h\u01b0\u1edfng hi\u1ec7u n\u0103ng h\u1ec7 th\u1ed1ng, kh\u00f3 m\u1edf r\u1ed9ng</li> </ul>","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/#52-phuong-an-b-su-dung-cong-cu-bi-ben-ngoai-metabase-powerbi","title":"5.2. Ph\u01b0\u01a1ng \u00e1n B: S\u1eed d\u1ee5ng c\u00f4ng c\u1ee5 BI b\u00ean ngo\u00e0i (Metabase, PowerBI)","text":"<ul> <li>L\u00fd do kh\u00f4ng ch\u1ecdn: Kh\u00f4ng ki\u1ec3m so\u00e1t \u0111\u01b0\u1ee3c RBAC t\u00edch h\u1ee3p, kh\u00f4ng ph\u00f9 h\u1ee3p v\u1edbi \u0111\u1eb7c th\u00f9 \u0111a tenant v\u00e0 workflow tinh ch\u1ec9nh</li> </ul>","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-028-reporting-architecture/#6-tai-lieu-lien-quan","title":"6. \ud83d\udc4e T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>ADR-012 - C\u1ea5u tr\u00fac response chu\u1ea9n</li> <li>ADR-007 - RBAC v\u00e0 ph\u00e2n quy\u1ec1n \u0111\u1ed9ng</li> <li>ADR-008 - Audit Logging</li> <li>ADR-020 - Chi\u1ebfn l\u01b0\u1ee3c Cost Observability</li> <li>ADR-027 - Chi\u1ebfn l\u01b0\u1ee3c qu\u1ea3n l\u00fd d\u1eef li\u1ec7u</li> <li>ADR-029 - Report Template Schema</li> <li>ADR-030 - Event Schema Governance</li> <li>README.md h\u1ec7 th\u1ed1ng DX VAS</li> <li>system-diagrams.md</li> </ul>","tags":["reporting","data-warehouse","rbac","analytics","dx-vas"]},{"location":"ADR/adr-029-report-template-schema/","title":"ADR-029: C\u1ea5u tr\u00fac chu\u1ea9n cho Report Template trong Reporting Service","text":"","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#1-boi-canh-context","title":"1. \ud83d\udccc B\u1ed1i c\u1ea3nh (Context)","text":"<p>Reporting Service trong h\u1ec7 th\u1ed1ng DX-VAS c\u1ea7n h\u1ed7 tr\u1ee3 nhi\u1ec1u lo\u1ea1i b\u00e1o c\u00e1o kh\u00e1c nhau, m\u1ed7i b\u00e1o c\u00e1o c\u00f3 th\u1ec3 c\u00f3 c\u1ea5u tr\u00fac tham s\u1ed1, quy\u1ec1n truy c\u1eadp, truy v\u1ea5n d\u1eef li\u1ec7u, v\u00e0 ki\u1ec3u hi\u1ec3n th\u1ecb kh\u00e1c nhau. C\u00e1c b\u00e1o c\u00e1o n\u00e0y c\u1ea7n \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a theo c\u00e1ch c\u00f3 th\u1ec3 qu\u1ea3n l\u00fd t\u1eadp trung, c\u1ea5u h\u00ecnh l\u1ea1i d\u1ec5 d\u00e0ng, ph\u00e2n quy\u1ec1n r\u00f5 r\u00e0ng, v\u00e0 an to\u00e0n cho truy v\u1ea5n d\u1eef li\u1ec7u.</p> <p>Hi\u1ec7n ch\u01b0a c\u00f3 \u0111\u1ecbnh ngh\u0129a chu\u1ea9n v\u1ec1 m\u1ed9t Report Template \u2013 d\u1eabn \u0111\u1ebfn vi\u1ec7c kh\u00f3 b\u1ea3o tr\u00ec, ki\u1ec3m so\u00e1t quy\u1ec1n, v\u00e0 t\u00e1i s\u1eed d\u1ee5ng. Ngo\u00e0i ra, trong t\u01b0\u01a1ng lai, AI Agent s\u1ebd c\u1ea7n s\u1eed d\u1ee5ng c\u1ea5u tr\u00fac n\u00e0y \u0111\u1ec3 t\u1ef1 \u0111\u1ed9ng sinh ho\u1eb7c g\u1ee3i \u00fd b\u00e1o c\u00e1o \u2013 do \u0111\u00f3 vi\u1ec7c chu\u1ea9n h\u00f3a l\u00e0 b\u1eaft bu\u1ed9c.</p>","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#2-quyet-inh-decision","title":"2. \ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh (Decision)","text":"<p>Ch\u00fang t\u00f4i quy\u1ebft \u0111\u1ecbnh chu\u1ea9n h\u00f3a Report Template d\u01b0\u1edbi d\u1ea1ng m\u1ed9t schema c\u00f3 c\u1ea5u tr\u00fac, l\u01b0u tr\u1eef trong c\u01a1 s\u1edf d\u1eef li\u1ec7u c\u1ee7a <code>Reporting Service</code>, ph\u1ee5c v\u1ee5 nh\u01b0 ngu\u1ed3n ch\u00ednh \u0111\u1ec3 sinh b\u00e1o c\u00e1o.</p> <p>M\u1ed7i template s\u1ebd bao g\u1ed3m metadata, tham s\u1ed1 \u0111\u1ea7u v\u00e0o, \u0111\u1ecbnh ngh\u0129a view ho\u1eb7c truy v\u1ea5n, c\u1ea5u tr\u00fac ph\u00e2n quy\u1ec1n, v\u00e0 h\u01b0\u1edbng d\u1eabn hi\u1ec3n th\u1ecb.</p>","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#3-chi-tiet-thiet-ke-giai-phap-design-solution-details","title":"3. \ud83e\uddf1 Chi ti\u1ebft Thi\u1ebft k\u1ebf / Gi\u1ea3i ph\u00e1p (Design / Solution Details)","text":"","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#31-cau-truc-report-template","title":"3.1. C\u1ea5u tr\u00fac Report Template","text":"<pre><code>{\n  \"id\": \"usage-by-tenant\",\n  \"name\": \"S\u1ed1 l\u01b0\u1ee3ng \u0111\u0103ng nh\u1eadp theo tenant\",\n  \"description\": \"B\u00e1o c\u00e1o t\u1ed5ng h\u1ee3p s\u1ed1 l\u01b0\u1ee3ng \u0111\u0103ng nh\u1eadp theo t\u1eebng tenant theo th\u1eddi gian\",\n  \"input_parameters\": [\n  {\n    \"name\": \"start_date\",\n    \"type\": \"date\",\n    \"required\": true,\n    \"description\": \"Ng\u00e0y b\u1eaft \u0111\u1ea7u truy v\u1ea5n\",\n    \"default_value\": null,\n    \"validation_rules\": {\n      \"format\": \"YYYY-MM-DD\"\n    }\n  },\n  {\n    \"name\": \"end_date\",\n    \"type\": \"date\",\n    \"required\": true,\n    \"description\": \"Ng\u00e0y k\u1ebft th\u00fac truy v\u1ea5n\",\n    \"default_value\": null,\n    \"validation_rules\": {\n      \"format\": \"YYYY-MM-DD\"\n    }\n  },\n  {\n    \"name\": \"tenant_id\",\n    \"type\": \"string\",\n    \"required\": false,\n    \"description\": \"M\u00e3 tenant c\u1ea7n l\u1ecdc\",\n    \"default_value\": null,\n    \"validation_rules\": {\n      \"maxLength\": 64,\n      \"pattern\": \"^[a-zA-Z0-9_-]+$\",\n      \"enum\": [\"tenant_01\", \"tenant_02\", \"tenant_03\"]\n    }\n  },\n  {\n    \"name\": \"max_results\",\n    \"type\": \"integer\",\n    \"required\": false,\n    \"description\": \"Gi\u1edbi h\u1ea1n s\u1ed1 d\u00f2ng tr\u1ea3 v\u1ec1\",\n    \"default_value\": 100,\n    \"validation_rules\": {\n      \"minimum\": 10,\n      \"maximum\": 1000\n    }\n  }\n]\n</code></pre> <p>Gi\u1ea3i th\u00edch b\u1ed5 sung: - <code>data_view</code>: L\u00e0 t\u00ean c\u1ee7a m\u1ed9t view ho\u1eb7c data mart \u0111\u00e3 \u0111\u01b0\u1ee3c predefined trong Data Warehouse. Truy v\u1ea5n trong <code>query_template</code> ch\u1ec9 \u0111\u01b0\u1ee3c ph\u00e9p ho\u1ea1t \u0111\u1ed9ng trong ph\u1ea1m vi view n\u00e0y \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o t\u00ednh an to\u00e0n v\u00e0 hi\u1ec7u n\u0103ng cao. - <code>version</code>: C\u00e1c template khi ch\u1ec9nh s\u1eeda s\u1ebd kh\u00f4ng c\u1eadp nh\u1eadt inplace, m\u00e0 s\u1ebd t\u1ea1o th\u00e0nh b\u1ea3n m\u1edbi v\u1edbi version t\u0103ng d\u1ea7n. C\u00e1c c\u1ea5u h\u00ecnh b\u00e1o c\u00e1o c\u00e1 nh\u00e2n (<code>Saved Report Config</code>) s\u1ebd tham chi\u1ebfu version c\u1ee5 th\u1ec3, \u0111\u1ea3m b\u1ea3o s\u1ef1 \u1ed5n \u0111\u1ecbnh theo th\u1eddi gian. - <code>enum</code> n\u00e0y \u0111\u01b0\u1ee3c Superadmin Webapp l\u1ea5y \u0111\u1ed9ng t\u1eeb API <code>GET /tenants</code> c\u1ee7a User Service Master \u0111\u1ec3 hi\u1ec3n th\u1ecb cho ng\u01b0\u1eddi d\u00f9ng ch\u1ecdn</p>","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#32-luong-su-dung","title":"3.2. Lu\u1ed3ng s\u1eed d\u1ee5ng","text":"<ol> <li>Superadmin Webapp g\u1ecdi API <code>GET /report-templates</code> \u0111\u1ec3 l\u1ea5y danh s\u00e1ch template.</li> <li>Ng\u01b0\u1eddi d\u00f9ng ch\u1ecdn template \u2192 client hi\u1ec3n th\u1ecb form t\u01b0\u01a1ng \u1ee9ng v\u1edbi <code>input_parameters</code>.</li> <li>G\u1eedi y\u00eau c\u1ea7u <code>GET /reports/{template_id}</code> k\u00e8m theo tham s\u1ed1 \u2192 h\u1ec7 th\u1ed1ng validate:</li> <li>Lo\u1ea1i tham s\u1ed1 \u0111\u00fang</li> <li>Gi\u00e1 tr\u1ecb h\u1ee3p l\u1ec7 theo <code>validation_rules</code></li> <li>Ng\u01b0\u1eddi d\u00f9ng c\u00f3 \u0111\u1ee7 <code>required_permission</code></li> <li>Reporting Service sinh truy v\u1ea5n t\u1eeb <code>query_template</code> \u2192 ch\u1ea1y tr\u00ean Data Warehouse \u2192 tr\u1ea3 k\u1ebft qu\u1ea3.</li> </ol>","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#33-phan-quyen-va-scope","title":"3.3. Ph\u00e2n quy\u1ec1n v\u00e0 scope","text":"<ul> <li>M\u1ed7i template ch\u1ee9a <code>required_permission</code>, c\u00f3 th\u1ec3 k\u1ebft h\u1ee3p v\u1edbi RBAC c\u1ee7a ng\u01b0\u1eddi d\u00f9ng \u0111\u1ec3 ki\u1ec3m tra truy c\u1eadp.</li> <li><code>scope</code> c\u00f3 th\u1ec3 l\u00e0 <code>global</code> (to\u00e0n h\u1ec7 th\u1ed1ng) ho\u1eb7c <code>per-tenant</code>.</li> </ul>","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#34-dsl-va-kiem-tra-an-toan","title":"3.4. DSL v\u00e0 ki\u1ec3m tra an to\u00e0n","text":"<ul> <li><code>query_template</code> l\u00e0 m\u1ed9t template \u0111\u01a1n gi\u1ea3n (Jinja ho\u1eb7c t\u01b0\u01a1ng \u0111\u01b0\u01a1ng), ch\u1ec9 cho ph\u00e9p:</li> <li>Ch\u00e8n tham s\u1ed1 an to\u00e0n (<code>{{param}}</code>)</li> <li>C\u00e2u l\u1ec7nh <code>if</code>, <code>else</code>, <code>default</code></li> <li>Kh\u00f4ng cho ph\u00e9p l\u1ec7nh SQL \u0111\u1ed9ng nh\u01b0 <code>ORDER BY {{column}}</code> kh\u00f4ng ki\u1ec3m so\u00e1t.</li> <li>C\u00f3 c\u01a1 ch\u1ebf static validation tr\u01b0\u1edbc khi ch\u1ea1y truy v\u1ea5n.</li> </ul>","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#35-ghi-chu-ve-saved-report-config-lien-quan","title":"3.5. Ghi ch\u00fa v\u1ec1 Saved Report Config (li\u00ean quan)","text":"<ul> <li>M\u1ed7i ng\u01b0\u1eddi d\u00f9ng c\u00f3 th\u1ec3 l\u01b0u m\u1ed9t ho\u1eb7c nhi\u1ec1u c\u1ea5u h\u00ecnh b\u00e1o c\u00e1o (<code>Saved Report Config</code>) bao g\u1ed3m:</li> <li><code>template_id</code></li> <li><code>version</code> c\u1ee7a template</li> <li>C\u00e1c gi\u00e1 tr\u1ecb tham s\u1ed1 c\u1ee5 th\u1ec3 \u0111\u00e3 ch\u1ecdn (<code>input_parameters</code>)</li> <li>T\u00f9y ch\u1ecdn hi\u1ec3n th\u1ecb (chart/table), filter m\u1eb7c \u0111\u1ecbnh...</li> <li>\u0110i\u1ec1u n\u00e0y \u0111\u1ea3m b\u1ea3o n\u1ebfu template thay \u0111\u1ed5i v\u1ec1 sau, ng\u01b0\u1eddi d\u00f9ng v\u1eabn c\u00f3 th\u1ec3 truy c\u1eadp l\u1ea1i b\u1ea3n b\u00e1o c\u00e1o c\u0169 v\u1edbi logic \u1ed5n \u0111\u1ecbnh.</li> </ul>","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#4-he-qua-consequences","title":"4. \u2705 H\u1ec7 qu\u1ea3 (Consequences)","text":"","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#41-uu-iem","title":"4.1. \u01afu \u0111i\u1ec3m","text":"<ul> <li>\u2705 Chu\u1ea9n h\u00f3a vi\u1ec7c \u0111\u1ecbnh ngh\u0129a v\u00e0 ph\u00e2n ph\u1ed1i b\u00e1o c\u00e1o</li> <li>\u2705 Cho ph\u00e9p hi\u1ec3n th\u1ecb \u0111\u1ed9ng v\u00e0 linh ho\u1ea1t tr\u00ean Webapp</li> <li>\u2705 H\u1ed7 tr\u1ee3 AI Agent hi\u1ec3u v\u00e0 sinh b\u00e1o c\u00e1o trong t\u01b0\u01a1ng lai</li> <li>\u2705 T\u0103ng kh\u1ea3 n\u0103ng t\u00e1i s\u1eed d\u1ee5ng v\u00e0 ki\u1ec3m so\u00e1t truy c\u1eadp t\u1ed1t h\u01a1n</li> </ul>","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#42-nhuoc-iem-rui-ro-luu-y","title":"4.2. Nh\u01b0\u1ee3c \u0111i\u1ec3m / R\u1ee7i ro / L\u01b0u \u00fd","text":"<ul> <li>\u26a0\ufe0f T\u0103ng \u0111\u1ed9 ph\u1ee9c t\u1ea1p trong kh\u00e2u validate template</li> <li>Gi\u1ea3i ph\u00e1p: D\u00f9ng static validator v\u00e0 test tr\u01b0\u1edbc khi l\u01b0u</li> <li>\u26a0\ufe0f N\u1ebfu d\u00f9ng DSL m\u1edf r\u1ed9ng, c\u00f3 th\u1ec3 ph\u00e1t sinh l\u1ed7 h\u1ed5ng</li> <li>Gi\u1ea3i ph\u00e1p: Gi\u1edbi h\u1ea1n c\u00e2u l\u1ec7nh template, audit code DSL r\u00f5 r\u00e0ng</li> </ul>","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#43-tac-ong-en-cac-thanh-phan-khac-neu-co","title":"4.3. T\u00e1c \u0111\u1ed9ng \u0111\u1ebfn c\u00e1c th\u00e0nh ph\u1ea7n kh\u00e1c (n\u1ebfu c\u00f3)","text":"<ul> <li>reporting-service: c\u1ea7n implement schema n\u00e0y, th\u00eam API qu\u1ea3n l\u00fd template</li> <li>superadmin-webapp: c\u1ea7n hi\u1ec3n th\u1ecb \u0111\u00fang form \u0111\u1ea7u v\u00e0o theo <code>input_parameters</code></li> <li>ADR-028: ph\u1ee5 thu\u1ed9c v\u00e0o ADR n\u00e0y</li> </ul>","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#5-cac-phuong-an-khac-a-can-nhac","title":"5. \ud83d\udd04 C\u00e1c Ph\u01b0\u01a1ng \u00e1n Kh\u00e1c \u0111\u00e3 C\u00e2n nh\u1eafc","text":"","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#51-phuong-an-a-viet-truy-van-sql-thu-cong-tu-frontend","title":"5.1. Ph\u01b0\u01a1ng \u00e1n A: Vi\u1ebft truy v\u1ea5n SQL th\u1ee7 c\u00f4ng t\u1eeb frontend","text":"<ul> <li>L\u00fd do kh\u00f4ng ch\u1ecdn: Kh\u00f4ng an to\u00e0n, kh\u00f4ng ki\u1ec3m so\u00e1t permission</li> </ul>","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#52-phuong-an-b-tao-bao-cao-bang-predefined-views-co-inh","title":"5.2. Ph\u01b0\u01a1ng \u00e1n B: T\u1ea1o b\u00e1o c\u00e1o b\u1eb1ng predefined views c\u1ed1 \u0111\u1ecbnh","text":"<ul> <li>L\u00fd do kh\u00f4ng ch\u1ecdn: Thi\u1ebfu t\u00ednh linh ho\u1ea1t, kh\u00f3 t\u00f9y ch\u1ec9nh filter theo user</li> </ul>","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-029-report-template-schema/#6-tai-lieu-lien-quan-related-documents","title":"6. \ud83d\udc4e T\u00e0i li\u1ec7u li\u00ean quan (Related Documents)","text":"<ul> <li>ADR-028 - Reporting Architecture</li> <li>reporting-service/design.md</li> <li>ADR-007 - Ph\u00e2n quy\u1ec1n RBAC</li> <li>ADR-012 - Response Structure</li> <li>README.md c\u1ee7a d\u1ef1 \u00e1n</li> </ul>","tags":["reporting","template","dx-vas","multi-tenant","schema"]},{"location":"ADR/adr-030-event-schema-governance/","title":"ADR-030: Chi\u1ebfn l\u01b0\u1ee3c qu\u1ea3n l\u00fd schema s\u1ef1 ki\u1ec7n (event schema governance)","text":"","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#1-boi-canh-context","title":"1. \ud83d\udccc B\u1ed1i c\u1ea3nh (Context)","text":"<p>Trong ki\u1ebfn tr\u00fac DX-VAS, nhi\u1ec1u service quan tr\u1ecdng nh\u01b0 User Service, Auth Service, SMS s\u1eed d\u1ee5ng Pub/Sub \u0111\u1ec3 ph\u00e1t c\u00e1c s\u1ef1 ki\u1ec7n (events) ph\u1ee5c v\u1ee5 cho t\u00ednh n\u0103ng realtime ho\u1eb7c t\u00edch h\u1ee3p xu\u1ed1ng c\u00e1c h\u1ec7 th\u1ed1ng ph\u00e2n t\u00edch. </p> <p>Tuy nhi\u00ean, h\u1ec7 th\u1ed1ng hi\u1ec7n ch\u01b0a c\u00f3 m\u1ed9t c\u01a1 ch\u1ebf qu\u1ea3n l\u00fd schema s\u1ef1 ki\u1ec7n r\u00f5 r\u00e0ng, d\u1eabn \u0111\u1ebfn nguy c\u01a1: - Thay \u0111\u1ed5i field trong s\u1ef1 ki\u1ec7n g\u00e2y l\u1ed7i ng\u1ea7m \u1edf c\u00e1c consumer. - Kh\u00f4ng ki\u1ec3m so\u00e1t versioning schema theo th\u1eddi gian. - Kh\u00f3 t\u00edch h\u1ee3p v\u00e0o pipeline ETL ho\u1eb7c AI analytics engine.</p> <p>\u0110\u1eb7c bi\u1ec7t, \u0111\u1ec3 ph\u1ee5c v\u1ee5 cho Data Lake / Reporting Service v\u00e0 c\u00e1c d\u1ef1 \u00e1n AI sau n\u00e0y, m\u1ecdi s\u1ef1 ki\u1ec7n c\u1ea7n \u0111\u01b0\u1ee3c schema h\u00f3a, version h\u00f3a v\u00e0 ki\u1ec3m so\u00e1t ch\u1eb7t ch\u1ebd.</p>","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#2-quyet-inh-decision","title":"2. \ud83e\udde0 Quy\u1ebft \u0111\u1ecbnh (Decision)","text":"<p>Ch\u00fang t\u00f4i quy\u1ebft \u0111\u1ecbnh chu\u1ea9n h\u00f3a chi\u1ebfn l\u01b0\u1ee3c qu\u1ea3n l\u00fd schema s\u1ef1 ki\u1ec7n theo h\u01b0\u1edbng: - M\u1ed7i s\u1ef1 ki\u1ec7n c\u00f3 m\u1ed9t schema \u0111\u1ecbnh ngh\u0129a chu\u1ea9n (JSON Schema ho\u1eb7c Protobuf). - M\u1ed7i s\u1ef1 ki\u1ec7n mang theo th\u00f4ng tin version r\u00f5 r\u00e0ng (vd: <code>vas.user.created.v1</code>) - T\u1ea5t c\u1ea3 schema \u0111\u01b0\u1ee3c l\u01b0u tr\u1eef v\u00e0 c\u00f4ng b\u1ed1 trong m\u1ed9t event registry trung t\u00e2m. - C\u00e1c service c\u00f3 th\u1ec3 ph\u00e1t s\u1ef1 ki\u1ec7n th\u1ee9 c\u1ea5p (vd: <code>vas.audit.persisted.v1</code>) \u0111\u1ec3 ph\u1ee5c v\u1ee5 h\u1ec7 th\u1ed1ng downstream nh\u01b0 ETL pipeline, AI analytics ho\u1eb7c alerting system.  - C\u00e1c schema n\u00e0y v\u1eabn ph\u1ea3i \u0111\u0103ng k\u00fd &amp; qu\u1ea3n l\u00fd nh\u01b0 c\u00e1c schema th\u00f4ng th\u01b0\u1eddng.</p>","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#3-chi-tiet-thiet-ke-giai-phap-design-solution-details","title":"3. \ud83e\uddf1 Chi ti\u1ebft Thi\u1ebft k\u1ebf / Gi\u1ea3i ph\u00e1p (Design / Solution Details)","text":"","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#31-inh-danh-su-kien-event-naming","title":"3.1. \u0110\u1ecbnh danh s\u1ef1 ki\u1ec7n (Event Naming)","text":"<p>\u0110\u1ecbnh danh theo chu\u1ea9n: <pre><code>vas.&lt;domain&gt;.\\&lt;event\\_name&gt;.v&lt;version&gt;\n</code></pre></p> <p>V\u00ed d\u1ee5: - <code>vas.auth.login_success.v1</code> - <code>vas.user.created.v2</code> - <code>vas.lms.lesson_completed.v1</code></p> <ul> <li>T\u00ean s\u1ef1 ki\u1ec7n c\u00f3 th\u1ec3 ph\u1ea3n \u00e1nh m\u1ee5c \u0111\u00edch n\u1ed9i b\u1ed9 ho\u1eb7c downstream nh\u01b0:</li> <li><code>vas.audit.persisted.v1</code> (\u0111\u01b0\u1ee3c ph\u00e1t b\u1edfi Audit Logging Service)</li> <li><code>vas.report.generated.v1</code> (do Reporting Service ph\u00e1t sau khi sinh xong b\u00e1o c\u00e1o)</li> <li>Nh\u1eefng s\u1ef1 ki\u1ec7n n\u00e0y g\u1ecdi l\u00e0 s\u1ef1 ki\u1ec7n th\u1ee9 c\u1ea5p (secondary events) \u2013 kh\u00f4ng b\u1eaft bu\u1ed9c, nh\u01b0ng h\u1eefu \u00edch cho t\u00edch h\u1ee3p ph\u00e2n t\u00edch/AI/logging.</li> </ul>","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#32-quy-uoc-schema","title":"3.2. Quy \u01b0\u1edbc schema","text":"<p>...</p> <ul> <li>M\u1ecdi field m\u1edbi \u0111\u1ec1u ph\u1ea3i tu\u00e2n theo Backward-compatible changes:</li> <li>\u2705 Add optional field</li> <li>\u2705 Extend enum</li> <li>\u274c Remove required field</li> <li> <p>\u274c Rename field</p> </li> <li> <p>Khi m\u1ed9t version m\u1edbi \u0111\u01b0\u1ee3c ph\u00e1t h\u00e0nh v\u1edbi thay \u0111\u1ed5i ph\u00e1 v\u1ee1 (breaking change), producer c\u00f3 th\u1ec3 t\u1ea1m th\u1eddi ph\u00e1t song song version c\u0169 v\u00e0 m\u1edbi (dual-publish) \u0111\u1ec3 h\u1ed7 tr\u1ee3 c\u00e1c consumer ch\u01b0a n\u00e2ng c\u1ea5p k\u1ecbp. Th\u1eddi gian h\u1ed7 tr\u1ee3 song song c\u1ea7n \u0111\u01b0\u1ee3c th\u1ed1ng nh\u1ea5t gi\u1eefa c\u00e1c b\u00ean li\u00ean quan ho\u1eb7c \u0111\u01b0\u1ee3c c\u00f4ng b\u1ed1 trong <code>README</code> registry.</p> </li> </ul>","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#33-kho-luu-tru-public-registry","title":"3.3. Kho l\u01b0u tr\u1eef &amp; Public registry","text":"<ul> <li>T\u1ea1o th\u01b0 m\u1ee5c <code>/event-schemas/</code> trong repo ch\u00ednh.</li> <li>M\u1ed7i file schema l\u00e0 m\u1ed9t version c\u1ed1 \u0111\u1ecbnh: <code>user.created.v1.schema.json</code></li> <li>Vi\u1ebft <code>README.md</code> li\u1ec7t k\u00ea t\u1ea5t c\u1ea3 c\u00e1c s\u1ef1 ki\u1ec7n h\u1ee3p l\u1ec7. N\u1ed9i dung <code>event registry</code> bao g\u1ed3m:</li> <li>T\u00ean s\u1ef1 ki\u1ec7n: <code>vas.&lt;domain&gt;.&lt;event&gt;.v&lt;version&gt;</code></li> <li>Link \u0111\u1ebfn schema file</li> <li>M\u00f4 t\u1ea3 ng\u1eafn g\u1ecdn ch\u1ee9c n\u0103ng s\u1ef1 ki\u1ec7n</li> <li>Producer ch\u00ednh</li> <li>Consumer hi\u1ec7n t\u1ea1i ho\u1eb7c ti\u1ec1m n\u0103ng (n\u1ebfu bi\u1ebft)</li> <li>Tr\u1ea1ng th\u00e1i: <code>active</code>, <code>deprecated</code>, <code>draft</code>, ...</li> <li> <p>Ph\u00e2n lo\u1ea1i: <code>primary</code> (ng\u01b0\u1eddi d\u00f9ng g\u00e2y ra) / <code>secondary</code> (n\u1ed9i b\u1ed9 h\u1ec7 th\u1ed1ng t\u1ea1o ra \u0111\u1ec3 tracking ho\u1eb7c downstream)</p> </li> <li> <p>(T\u01b0\u01a1ng lai) C\u00f3 th\u1ec3 c\u00e2n nh\u1eafc s\u1eed d\u1ee5ng m\u1ed9t Schema Registry chuy\u00ean d\u1ee5ng nh\u01b0 Google Schema Registry, Confluent Schema Registry ho\u1eb7c d\u1ecbch v\u1ee5 t\u00f9y bi\u1ebfn \u0111\u1ec3 qu\u1ea3n l\u00fd t\u1ed1t h\u01a1n khi s\u1ed1 l\u01b0\u1ee3ng schema l\u1edbn.</p> </li> </ul>","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#34-cong-cu-kiem-tra-validate","title":"3.4. C\u00f4ng c\u1ee5 ki\u1ec3m tra &amp; validate","text":"<ul> <li>M\u1ecdi producer ph\u1ea3i validate schema tr\u01b0\u1edbc khi ph\u00e1t s\u1ef1 ki\u1ec7n (unit test ho\u1eb7c linter).</li> <li>Consumer c\u00f3 th\u1ec3 s\u1eed d\u1ee5ng auto-codegen t\u1eeb schema \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o \u0111\u1ed3ng b\u1ed9.</li> <li>Khuy\u1ebfn kh\u00edch s\u1eed d\u1ee5ng th\u01b0 vi\u1ec7n h\u1ed7 tr\u1ee3 deserialize + validate JSON Schema (nh\u01b0 <code>ajv</code>, <code>jsonschema</code>, <code>pydantic</code>, <code>zod</code>, ...) \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o d\u1eef li\u1ec7u s\u1ef1 ki\u1ec7n h\u1ee3p l\u1ec7 tr\u01b0\u1edbc khi x\u1eed l\u00fd logic downstream.</li> </ul>","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#35-luong-thay-oi-schema","title":"3.5. Lu\u1ed3ng thay \u0111\u1ed5i schema","text":"<ol> <li>Th\u00eam schema m\u1edbi \u2192 PR v\u00e0o <code>/event-schemas/</code></li> <li>Reviewer ki\u1ec3m tra backward-compatibility</li> <li>Merge \u2192 c\u1eadp nh\u1eadt README registry + g\u1eafn version</li> <li>V\u1edbi s\u1ef1 ki\u1ec7n th\u1ee9 c\u1ea5p (<code>*.persisted.v1</code>, <code>*.failed.v1</code>), c\u1ea7n m\u00f4 t\u1ea3 r\u00f5 trigger v\u00e0 gi\u00e1 tr\u1ecb ph\u00e2n t\u00edch \u0111\u1ec3 tr\u00e1nh l\u1ea1m d\u1ee5ng ph\u00e1t t\u00e1n.</li> </ol>","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#36-vi-du-bo-sung-schema-audit_log_persistedv1-at-tai-event-schemasauditpersistedv1schemajson","title":"3.6. \ud83d\udce6 V\u00ed d\u1ee5 b\u1ed5 sung schema <code>audit_log_persisted.v1</code> (\u0111\u1eb7t t\u1ea1i <code>/event-schemas/audit.persisted.v1.schema.json</code>)","text":"<p>S\u1ebd do ALS ph\u00e1t sau khi ghi log th\u00e0nh c\u00f4ng.</p> <pre><code>{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"title\": \"AuditLogPersisted\",\n  \"type\": \"object\",\n  \"properties\": {\n    \"event\": { \"type\": \"string\", \"enum\": [\"vas.audit.persisted.v1\"] },\n    \"log_id\": { \"type\": \"string\", \"description\": \"ID c\u1ee7a log trong BigQuery ho\u1eb7c Firestore\" },\n    \"tenant_id\": { \"type\": \"string\" },\n    \"timestamp\": { \"type\": \"string\", \"format\": \"date-time\" },\n    \"source_service\": { \"type\": \"string\" },\n    \"action_type\": { \"type\": \"string\" }\n  },\n  \"required\": [\"event\", \"log_id\", \"tenant_id\", \"timestamp\", \"source_service\", \"action_type\"]\n}\n</code></pre>","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#4-he-qua-consequences","title":"4. \u2705 H\u1ec7 qu\u1ea3 (Consequences)","text":"","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#41-uu-iem","title":"4.1. \u01afu \u0111i\u1ec3m","text":"<ul> <li>\u2705 Truy v\u1ebft, version r\u00f5 r\u00e0ng m\u1ecdi s\u1ef1 ki\u1ec7n tr\u00ean h\u1ec7 th\u1ed1ng</li> <li>\u2705 B\u1ea3o v\u1ec7 c\u00e1c consumer tr\u01b0\u1edbc thay \u0111\u1ed5i ph\u00e1 v\u1ee1</li> <li>\u2705 Cho ph\u00e9p gen code t\u1ef1 \u0111\u1ed9ng t\u1eeb schema (cho ETL ho\u1eb7c AI)</li> <li>\u2705 L\u00e0m n\u1ec1n t\u1ea3ng cho AI Agent hi\u1ec3u \u0111\u01b0\u1ee3c context t\u1eebng s\u1ef1 ki\u1ec7n</li> </ul>","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#42-nhuoc-iem-rui-ro-luu-y","title":"4.2. Nh\u01b0\u1ee3c \u0111i\u1ec3m / R\u1ee7i ro / L\u01b0u \u00fd","text":"<ul> <li>\u26a0\ufe0f T\u0103ng chi ph\u00ed qu\u1ea3n l\u00fd schema</li> <li>Gi\u1ea3i ph\u00e1p: D\u00f9ng codegen + CI validate schema</li> <li>\u26a0\ufe0f M\u1ed9t s\u1ed1 adapter c\u0169 kh\u00f4ng h\u1ed7 tr\u1ee3 Pub/Sub chu\u1ea9n</li> <li>Gi\u1ea3i ph\u00e1p: C\u00f3 th\u1ec3 d\u00f9ng wrapper service ho\u1eb7c ETL pull</li> </ul>","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#5-cac-phuong-an-khac-a-can-nhac","title":"5. \ud83d\udd04 C\u00e1c Ph\u01b0\u01a1ng \u00e1n Kh\u00e1c \u0111\u00e3 C\u00e2n nh\u1eafc","text":"","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#51-khong-dung-version-trong-ten-su-kien","title":"5.1. Kh\u00f4ng d\u00f9ng version trong t\u00ean s\u1ef1 ki\u1ec7n","text":"<ul> <li>L\u00fd do kh\u00f4ng ch\u1ecdn: G\u00e2y kh\u00f3 kh\u0103n khi breaking changes x\u1ea3y ra</li> </ul>","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#52-dung-schema-tu-do-khong-inh-danh","title":"5.2. D\u00f9ng schema t\u1ef1 do / kh\u00f4ng \u0111\u1ecbnh danh","text":"<ul> <li>L\u00fd do kh\u00f4ng ch\u1ecdn: Kh\u00f4ng th\u1ec3 scale khi s\u1ed1 l\u01b0\u1ee3ng event t\u0103ng</li> </ul>","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"ADR/adr-030-event-schema-governance/#6-tai-lieu-lien-quan","title":"6. \ud83d\udcce T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>ADR-028 - Reporting Architecture</li> <li>ADR-029 - Report Template Schema</li> <li>README.md - S\u01a1 \u0111\u1ed3 h\u1ec7 th\u1ed1ng</li> <li>event-schemas/registry</li> </ul>","tags":["event","schema","pubsub","governance","dx-vas"]},{"location":"architecture/rbac-deep-dive/","title":"Ph\u00e2n t\u00edch Chuy\u00ean s\u00e2u: Ki\u1ebfn tr\u00fac Ph\u00e2n quy\u1ec1n \u0110\u1ed9ng (RBAC) trong H\u1ec7 th\u1ed1ng dx-vas","text":""},{"location":"architecture/rbac-deep-dive/#muc-luc-chi-tiet-phan-tich-kien-truc-phan-quyen-ong-rbac","title":"\ud83d\udcda M\u1ee5c l\u1ee5c Chi ti\u1ebft \u2013 Ph\u00e2n t\u00edch Ki\u1ebfn tr\u00fac Ph\u00e2n quy\u1ec1n \u0110\u1ed9ng (RBAC)","text":"STT T\u00ean m\u1ee5c M\u00f4 t\u1ea3 Li\u00ean k\u1ebft 1\ufe0f\u20e3 T\u1ed5ng quan &amp; \u0110\u1ecbnh ngh\u0129a RBAC Kh\u00e1i ni\u1ec7m role, permission, condition, \u00e1p d\u1ee5ng trong ki\u1ebfn tr\u00fac \u0111a tenant Xem m\u1ee5c 2\ufe0f\u20e3 Ph\u00e2n t\u1ea7ng Qu\u1ea3n l\u00fd \u0110\u1ecbnh danh &amp; Ph\u00e2n quy\u1ec1n Vai tr\u00f2 c\u1ee7a User Service Master v\u00e0 Sub User Service Xem m\u1ee5c 3\ufe0f\u20e3 Lu\u1ed3ng X\u00e1c th\u1ef1c &amp; Ph\u00e2n quy\u1ec1n (Multi-Tenant) C\u00e1ch JWT \u0111\u01b0\u1ee3c ph\u00e1t h\u00e0nh v\u00e0 RBAC \u0111\u01b0\u1ee3c \u0111\u00e1nh gi\u00e1 t\u1ea1i Gateway Xem m\u1ee5c 4\ufe0f\u20e3 M\u00f4 h\u00ecnh D\u1eef li\u1ec7u RBAC (Master vs Sub) Chi ti\u1ebft c\u00e1c b\u1ea3ng schema t\u1ea1i Master v\u00e0 Sub Service Xem m\u1ee5c 5\ufe0f\u20e3 Permission c\u00f3 \u0111i\u1ec1u ki\u1ec7n (Condition JSONB) M\u00f4 h\u00ecnh <code>condition</code> \u0111\u1ed9ng d\u1ef1a tr\u00ean context ng\u01b0\u1eddi d\u00f9ng &amp; request Xem m\u1ee5c 6\ufe0f\u20e3 Chi\u1ebfn l\u01b0\u1ee3c Cache RBAC t\u1ea1i API Gateway C\u00e1ch Redis cache gi\u00fap t\u0103ng hi\u1ec7u n\u0103ng v\u00e0 logic invalidation Xem m\u1ee5c 7\ufe0f\u20e3 Chi\u1ebfn l\u01b0\u1ee3c \u0110\u1ed3ng b\u1ed9 RBAC T\u1eeb template Master \u0111\u1ebfn Sub User Service (k\u1ebf th\u1eeba ho\u1eb7c clone) Xem m\u1ee5c 8\ufe0f\u20e3 Hi\u1ec7u n\u0103ng &amp; Kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng K\u1ef9 thu\u1eadt t\u1ed1i \u01b0u cache, pub/sub, autoscale theo tenant Xem m\u1ee5c 9\ufe0f\u20e3 B\u1ea3o m\u1eadt chuy\u00ean s\u00e2u trong RBAC Isolation theo tenant, JWT trust, \u0111\u1ecbnh danh vai tr\u00f2 Xem m\u1ee5c \ud83d\udd1f Gi\u00e1m s\u00e1t &amp; G\u1ee1 l\u1ed7i Audit logs, debug header, metric h\u1ec7 th\u1ed1ng RBAC Xem m\u1ee5c 1\ufe0f\u20e31\ufe0f\u20e3 Best Practices cho Qu\u1ea3n tr\u1ecb RBAC C\u00e1c khuy\u1ebfn ngh\u1ecb t\u00ean role, s\u1ed1 l\u01b0\u1ee3ng role/user, ph\u00e2n quy\u1ec1n t\u1ed1i \u01b0u Xem m\u1ee5c 1\ufe0f\u20e32\ufe0f\u20e3 C\u00f4ng c\u1ee5 &amp; T\u00e0i li\u1ec7u li\u00ean quan Li\u00ean k\u1ebft t\u1edbi ADR, data-model, s\u01a1 \u0111\u1ed3, spec JSONB, OpenAPI Xem m\u1ee5c"},{"location":"architecture/rbac-deep-dive/#1-tong-quan-inh-nghia-rbac","title":"1. T\u1ed5ng quan &amp; \u0110\u1ecbnh ngh\u0129a RBAC","text":"<p>RBAC (Role-Based Access Control) trong h\u1ec7 th\u1ed1ng dx-vas cho ph\u00e9p ki\u1ec3m so\u00e1t quy\u1ec1n truy c\u1eadp m\u1ed9t c\u00e1ch linh ho\u1ea1t v\u00e0 c\u00f3 th\u1ec3 m\u1edf r\u1ed9ng, d\u1ef1a tr\u00ean:</p> <ul> <li>Vai tr\u00f2 ng\u01b0\u1eddi d\u00f9ng (Role) trong t\u1eebng tr\u01b0\u1eddng th\u00e0nh vi\u00ean (tenant)</li> <li>T\u1eadp h\u1ee3p quy\u1ec1n (Permission) \u0111\u01b0\u1ee3c g\u00e1n cho m\u1ed7i role</li> <li>\u0110i\u1ec1u ki\u1ec7n th\u1ef1c thi (Condition, n\u1ebfu c\u00f3) \u00e1p d\u1ee5ng \u1edf c\u1ea5p permission</li> </ul> <p>M\u00f4 h\u00ecnh RBAC n\u00e0y ho\u1ea1t \u0111\u1ed9ng trong b\u1ed1i c\u1ea3nh multi-tenant, n\u01a1i m\u1ed7i tenant (tr\u01b0\u1eddng th\u00e0nh vi\u00ean) c\u00f3 RBAC \u0111\u1ed9c l\u1eadp, nh\u01b0ng v\u1eabn k\u1ebf th\u1eeba m\u1ed9t ph\u1ea7n t\u1eeb template to\u00e0n h\u1ec7 th\u1ed1ng do User Service Master cung c\u1ea5p.</p>"},{"location":"architecture/rbac-deep-dive/#2-phan-tang-quan-ly-inh-danh-phan-quyen","title":"2. Ph\u00e2n t\u1ea7ng Qu\u1ea3n l\u00fd \u0110\u1ecbnh danh &amp; Ph\u00e2n quy\u1ec1n","text":""},{"location":"architecture/rbac-deep-dive/#user-service-master","title":"\ud83e\udde0 User Service Master","text":"<ul> <li>L\u00e0 ngu\u1ed3n ch\u00e2n l\u00fd duy nh\u1ea5t cho to\u00e0n b\u1ed9 ng\u01b0\u1eddi d\u00f9ng (<code>users_global</code>)</li> <li>Qu\u1ea3n l\u00fd:</li> <li>Danh s\u00e1ch tenant (<code>tenants</code>)</li> <li>M\u1ed1i quan h\u1ec7 user \u2194 tenant (<code>user_tenant_assignments</code>)</li> <li>C\u00e1c template vai tr\u00f2 v\u00e0 quy\u1ec1n to\u00e0n h\u1ec7 th\u1ed1ng:<ul> <li><code>global_roles_templates</code></li> <li><code>global_permissions_templates</code></li> </ul> </li> <li>Kh\u00f4ng tr\u1ef1c ti\u1ebfp \u0111\u00e1nh gi\u00e1 RBAC, m\u00e0 cung c\u1ea5p \u0111\u1ecbnh danh v\u00e0 template cho Sub Services</li> </ul>"},{"location":"architecture/rbac-deep-dive/#sub-user-service-per-tenant","title":"\ud83e\udde9 Sub User Service (per Tenant)","text":"<ul> <li>M\u1ed7i tenant c\u00f3 1 instance ri\u00eang, qu\u1ea3n l\u00fd:</li> <li>Ng\u01b0\u1eddi d\u00f9ng thu\u1ed9c tenant (<code>users_in_tenant</code>) \u2013 \u00e1nh x\u1ea1 \u0111\u1ebfn <code>user_id_global</code></li> <li>Tr\u1ea1ng th\u00e1i ho\u1ea1t \u0111\u1ed9ng n\u1ed9i b\u1ed9: <code>is_active_in_tenant</code></li> <li>Vai tr\u00f2 (<code>roles_in_tenant</code>), quy\u1ec1n (<code>permissions_in_tenant</code>)</li> <li>Mapping:<ul> <li><code>user_role_in_tenant</code></li> <li><code>role_permission_in_tenant</code></li> </ul> </li> <li>Cho ph\u00e9p k\u1ebf th\u1eeba t\u1eeb template Master ho\u1eb7c t\u1ef1 \u0111\u1ecbnh ngh\u0129a</li> </ul>"},{"location":"architecture/rbac-deep-dive/#3-luong-xac-thuc-phan-quyen-multi-tenant","title":"3. Lu\u1ed3ng X\u00e1c th\u1ef1c &amp; Ph\u00e2n quy\u1ec1n (Multi-Tenant)","text":""},{"location":"architecture/rbac-deep-dive/#luong-phat-hanh-jwt","title":"\ud83d\udd10 Lu\u1ed3ng ph\u00e1t h\u00e0nh JWT","text":"<ol> <li>Ng\u01b0\u1eddi d\u00f9ng \u0111\u0103ng nh\u1eadp qua:</li> <li>Google OAuth2 \u2192 Auth Master</li> <li>OTP/Local \u2192 Sub Auth Service</li> <li>Sau khi x\u00e1c th\u1ef1c:</li> <li><code>tenant_id</code> \u0111\u01b0\u1ee3c ch\u1ecdn (n\u1ebfu ng\u01b0\u1eddi d\u00f9ng thu\u1ed9c nhi\u1ec1u tenant).</li> <li>Auth Service g\u1ecdi User Service Master \u2192 ki\u1ec3m tra <code>user_id_global</code> &amp; quy\u1ec1n truy c\u1eadp tenant.</li> <li>G\u1ecdi Sub User Service \u2192 l\u1ea5y <code>roles</code>, <code>permissions</code>.</li> <li>G\u1ecdi Token Service <code>POST /token/issue</code> \u2192 nh\u1eadn JWT k\u00fd RS256.</li> <li>JWT \u0111\u01b0\u1ee3c ph\u00e1t h\u00e0nh v\u1edbi:</li> <li><code>user_id</code>, <code>tenant_id</code>, <code>roles</code>, <code>permissions</code>, <code>auth_provider</code>,</li> <li><code>jti</code>, <code>sid</code>, <code>exp</code> (ph\u1ee5c v\u1ee5 thu h\u1ed3i token &amp; qu\u1ea3n l\u00fd phi\u00ean).</li> </ol>"},{"location":"architecture/rbac-deep-dive/#api-gateway-anh-gia-rbac","title":"\ud83d\udee1\ufe0f API Gateway \u0111\u00e1nh gi\u00e1 RBAC","text":"<ul> <li>X\u00e1c th\u1ef1c ch\u1eef k\u00fd JWT offline qua JWKS cache 10\u2032.</li> <li>Ki\u1ec3m tra <code>tenant_id</code>, <code>exp</code> v\u00e0 tr\u1ea1ng th\u00e1i ng\u01b0\u1eddi d\u00f9ng (<code>is_active</code>, <code>is_active_in_tenant</code>).</li> <li>Tra Redis: <code>revoked:{jti}</code> \u2192 n\u1ebfu hit \u21d2 tr\u1ea3 <code>403</code> (<code>token.revoked</code>), hu\u1ef7 cache RBAC.</li> <li>Truy v\u1ea5n Redis cache RBAC: <code>rbac:{user_id}:{tenant_id}</code> \u2192 n\u1ebfu miss g\u1ecdi Sub User Service \u0111\u1ec3 n\u1ea1p l\u1ea1i.</li> <li>\u0110\u00e1nh gi\u00e1 <code>condition</code> n\u1ebfu permission c\u00f3 r\u00e0ng bu\u1ed9c \u0111\u1ed9ng.</li> </ul>"},{"location":"architecture/rbac-deep-dive/#4-mo-hinh-du-lieu-rbac-master-vs-sub","title":"4. M\u00f4 h\u00ecnh D\u1eef li\u1ec7u RBAC (Master vs Sub)","text":"<p>Nguy\u00ean t\u1eafc chung User Service Master (Core \u2014 PostgreSQL) l\u01b0u danh t\u00ednh to\u00e0n c\u1ee5c &amp; template RBAC chu\u1ea9n. Sub User Service (per-tenant \u2014 MariaDB) ch\u1ec9 l\u01b0u RBAC c\u1ee5c b\u1ed9, \u0111\u1ed3ng b\u1ed9 b\u1ea5t \u0111\u1ed3ng b\u1ed9 qua Pub/Sub. * M\u1ecdi b\u1ea3ng ph\u1ea3i c\u00f3 kho\u00e1 ch\u00ednh r\u00f5 r\u00e0ng, theo chu\u1ea9n \u2b502 Data Model Standard.</p>"},{"location":"architecture/rbac-deep-dive/#tai-user-service-master-postgresql","title":"\ud83d\udce6 T\u1ea1i User Service Master (PostgreSQL)","text":"<pre><code>-- +flyway\n-- 4.1  Ng\u01b0\u1eddi d\u00f9ng to\u00e0n h\u1ec7 th\u1ed1ng\nCREATE TABLE users_global (\n  user_id           UUID PRIMARY KEY,\n  full_name         TEXT NOT NULL,\n  email             TEXT NOT NULL,\n  phone             TEXT,\n  auth_provider     TEXT NOT NULL CHECK (auth_provider IN ('google', 'local')),\n  local_auth_tenant_id UUID,\n  is_active         BOOLEAN DEFAULT TRUE,\n  UNIQUE (email, auth_provider)\n);\n\n-- 4.2  Danh s\u00e1ch tenant\nCREATE TABLE tenants (\n  tenant_id   UUID PRIMARY KEY,\n  tenant_name TEXT NOT NULL,\n  status      TEXT NOT NULL CHECK (status IN ('active', 'inactive'))\n);\n\n-- 4.3  \u00c1nh x\u1ea1 user \u2194 tenant\nCREATE TABLE user_tenant_assignments (\n  user_id    UUID REFERENCES users_global(user_id),\n  tenant_id  UUID REFERENCES tenants(tenant_id),\n  assigned_by UUID,\n  assigned_at TIMESTAMP,\n  PRIMARY KEY (user_id, tenant_id)\n);\n\n-- 4.4  Template vai tr\u00f2 &amp; quy\u1ec1n to\u00e0n c\u1ee5c\nCREATE TABLE global_roles_templates (\n  template_id  UUID PRIMARY KEY,\n  template_code TEXT UNIQUE NOT NULL,\n  description  TEXT\n);\n\nCREATE TABLE global_permissions_templates (\n  template_id     UUID PRIMARY KEY,\n  permission_code TEXT UNIQUE NOT NULL,\n  action          TEXT NOT NULL,\n  resource        TEXT NOT NULL,\n  default_condition JSONB   -- PostgreSQL JSONB\n);\n</code></pre> <p>V\u00ed d\u1ee5 quy\u1ec1n to\u00e0n c\u1ee5c</p> permission_code description <code>report.view_login_by_tenant</code> Xem b\u00e1o c\u00e1o \u0111\u0103ng nh\u1eadp theo tenant <code>report.view_financial_summary</code> Xem b\u00e1o c\u00e1o t\u00e0i ch\u00ednh t\u1ed5ng h\u1ee3p <code>report.manage_report_templates</code> T\u1ea1o/ c\u1eadp nh\u1eadt template b\u00e1o c\u00e1o"},{"location":"architecture/rbac-deep-dive/#tai-sub-user-service-moi-tenant-mariadb","title":"\ud83d\udce6 T\u1ea1i Sub User Service (m\u1ed7i tenant \u2014 MariaDB)","text":"<pre><code>-- +flyway\n-- 4.5  Ng\u01b0\u1eddi d\u00f9ng c\u1ee5c b\u1ed9 (tham chi\u1ebfu user_id to\u00e0n c\u1ee5c)\nCREATE TABLE users_in_tenant (\n  user_id UUID PRIMARY KEY,\n  is_active_in_tenant BOOLEAN DEFAULT TRUE\n);\n\n-- 4.6  Vai tr\u00f2 &amp; quy\u1ec1n trong tenant\nCREATE TABLE roles_in_tenant (\n  role_id   UUID PRIMARY KEY,\n  role_code TEXT UNIQUE NOT NULL,\n  role_name TEXT NOT NULL\n);\n\nCREATE TABLE permissions_in_tenant (\n  permission_id    UUID PRIMARY KEY,\n  permission_code  TEXT UNIQUE NOT NULL,\n  action           TEXT NOT NULL,\n  resource         TEXT NOT NULL,\n  condition        JSON        -- MariaDB JSON\n, schema_version   INT  NOT NULL DEFAULT 1 COMMENT 'Event-schema version'\n);\n\n-- 4.7  Mapping user \u2194 role\nCREATE TABLE user_role_in_tenant (\n  user_id UUID REFERENCES users_in_tenant(user_id),\n  role_id UUID REFERENCES roles_in_tenant(role_id),\n  PRIMARY KEY (user_id, role_id)\n);\n\n-- 4.8  Mapping role \u2194 permission\nCREATE TABLE role_permission_in_tenant (\n  role_id       UUID REFERENCES roles_in_tenant(role_id),\n  permission_id UUID REFERENCES permissions_in_tenant(permission_id),\n  PRIMARY KEY (role_id, permission_id)\n);\n</code></pre> <p>V\u00ed d\u1ee5 quy\u1ec1n trong tenant</p> permission_code scope is_custom note <code>report.view_login_by_tenant</code> tenant false K\u1ebf th\u1eeba t\u1eeb Master <code>report.view_financial_summary</code> global false Ch\u1ec9 c\u1ea5p cho vai tr\u00f2 qu\u1ea3n l\u00fd <code>grade.edit_assignment</code> class true Quy\u1ec1n tu\u1ef3 ch\u1ec9nh do Admin tenant t\u1ea1o"},{"location":"architecture/rbac-deep-dive/#tai-lieu-chi-tiet","title":"\ud83d\udcd8 T\u00e0i li\u1ec7u chi ti\u1ebft","text":"<ul> <li><code>user-service/master/data-model.md</code> \u2013 M\u00f4 h\u00ecnh &amp; migration PostgreSQL.</li> <li><code>user-service/tenant/data-model.md</code> \u2013 M\u00f4 h\u00ecnh MariaDB &amp; chi\u1ebfn l\u01b0\u1ee3c sync Pub/Sub.</li> </ul> <p>M\u00f4 h\u00ecnh n\u00e0y t\u00e1ch bi\u1ec7t r\u00f5 r\u00e0ng danh t\u00ednh to\u00e0n c\u1ee5c v\u1edbi RBAC c\u1ee5c b\u1ed9, \u0111\u1ed3ng th\u1eddi h\u1ed7 tr\u1ee3 version schema (c\u1ed9t <code>schema_version</code>) cho h\u1ec7 th\u1ed1ng Event Schema Governance (ADR-030).</p>"},{"location":"architecture/rbac-deep-dive/#5-permission-co-ieu-kien-conditional-permission","title":"5. Permission C\u00f3 \u0110i\u1ec1u Ki\u1ec7n (Conditional Permission)","text":"<p>M\u1ee5c ti\u00eau \u2013 Cho ph\u00e9p RBAC linh ho\u1ea1t d\u1ef1a tr\u00ean ng\u1eef c\u1ea3nh (context-aware). Thay v\u00ec g\u00e1n quy\u1ec1n \u201cc\u1ee9ng\u201d, m\u1ed7i permission c\u00f3 th\u1ec3 \u0111\u00ednh k\u00e8m tr\u01b0\u1eddng <code>condition</code> d\u01b0\u1edbi d\u1ea1ng JSON (<code>JSONB</code> tr\u00ean PostgreSQL Core, <code>JSON</code> tr\u00ean MariaDB Tenant).</p>"},{"location":"architecture/rbac-deep-dive/#51-cu-phap-context","title":"5.1 C\u00fa ph\u00e1p &amp; Context","text":"Placeholder Ngu\u1ed3n d\u1eef li\u1ec7u V\u00ed d\u1ee5 <code>$user.&lt;field&gt;</code> B\u1ea3n ghi <code>users_in_tenant</code> (Sub DB) <code>$user.class_id</code> <code>$request.&lt;field&gt;</code> Body / query-param / header HTTP <code>$request.class_id</code> <code>$tenant.&lt;field&gt;</code> Metadata c\u1ee7a tenant (b\u1ea3ng <code>tenants</code>) <code>$tenant.tier</code> <p>To\u00e1n t\u1eed m\u1eb7c \u0111\u1ecbnh: so s\u00e1nh b\u1eb1ng (<code>==</code>). To\u00e1n t\u1eed m\u1edf r\u1ed9ng (v2): <code>$in</code>, <code>$contains</code>, <code>$gte</code>, <code>$lte</code>.</p>"},{"location":"architecture/rbac-deep-dive/#52-vi-du-ieu-kien","title":"5.2 V\u00ed d\u1ee5 \u0111i\u1ec1u ki\u1ec7n","text":"M\u00f4 t\u1ea3 JSON \u0111i\u1ec1u ki\u1ec7n Di\u1ec5n gi\u1ea3i Ch\u1ec9 xem l\u1edbp c\u1ee7a ch\u00ednh m\u00ecnh <code>{ \"class_id\": \"$user.class_id\" }</code> <code>class_id (request)</code> <code>==</code> <code>class_id (user)</code> H\u1ea1n ch\u1ebf b\u00e1o c\u00e1o theo kh\u1ed1i tr\u01b0\u1eddng <code>{ \"grade\": \"$user.grade\" }</code> So s\u00e1nh <code>grade</code> Quy\u1ec1n admin tenant cao c\u1ea5p <code>{ \"$tenant.tier\": \"premium\" }</code> Tenant ph\u1ea3i \u1edf g\u00f3i \u201cpremium\u201d"},{"location":"architecture/rbac-deep-dive/#53-luong-anh-gia-evaluation-flow","title":"5.3 Lu\u1ed3ng \u0111\u00e1nh gi\u00e1 (Evaluation Flow)","text":"<pre><code>flowchart LR\n  APIGW(API Gateway) --&gt; CondEval(Condition Engine)\n  CondEval --&gt;|read| RedisRBAC[(RBAC cache)]\n  CondEval --&gt;|read| RequestCtx[/HTTP Request/]\n  CondEval --&gt;|read| JWTClaim[/JWT/]\n  CondEval --&gt;|read| TenantMeta[(Tenant metadata)]\n</code></pre> <ol> <li>API Gateway \u0111\u00e3 x\u00e1c th\u1ef1c JWT &amp; t\u1ea3i RBAC cache.</li> <li> <p>Condition Engine l\u1eb7p qua list permission:</p> </li> <li> <p>N\u1ebfu <code>condition == null</code> \u21d2 pass.</p> </li> <li>N\u1ebfu c\u00f3 <code>condition</code> \u21d2 render placeholder \u2192 so s\u00e1nh.</li> <li>N\u1ebfu b\u1ea5t k\u1ef3 permission pass \u21d2 request \u0111\u01b0\u1ee3c ph\u00e9p.</li> <li>K\u1ebft qu\u1ea3 cache <code>rbac:{user_id}:{tenant_id}</code> theo TTL.</li> </ol>"},{"location":"architecture/rbac-deep-dive/#54-kich-ban-quan-trong","title":"5.4 K\u1ecbch b\u1ea3n quan tr\u1ecdng","text":"K\u1ecbch b\u1ea3n Handling Token b\u1ecb thu h\u1ed3i Gateway tr\u1ea3 <code>403</code> <code>token.revoked</code> tr\u01b0\u1edbc khi evaluate. Placeholder thi\u1ebfu Tr\u1ea3 <code>400</code> <code>common.validation_failed</code>. Type mismatch Tr\u1ea3 <code>400</code>; log detail v\u00e0o Audit-Logging. Condition n\u1eb7ng Flag \u201cslow condition\u201d khi eval &gt; 5 ms \u2013 metric <code>rbac_cond_latency_p95</code>."},{"location":"architecture/rbac-deep-dive/#55-quan-tri-template","title":"5.5 Qu\u1ea3n tr\u1ecb &amp; Template","text":"<ul> <li>Template quy\u1ec1n (level Master) l\u01b0u \u1edf <code>global_permissions_templates.default_condition</code>.</li> <li>Tenant override b\u1eb1ng c\u00e1ch vi\u1ebft <code>condition</code> m\u1edbi trong <code>permissions_in_tenant</code>.</li> <li>Report-related permission (<code>report.*</code>) \u0111i k\u00e8m <code>data_scope</code> (ADR-029).</li> </ul> <p>L\u01b0u \u00fd b\u1ea3o m\u1eadt</p> <ul> <li>Kh\u00f4ng cho ph\u00e9p placeholder t\u1ef1 do; ch\u1ec9 whitelist <code>$user</code>, <code>$request</code>, <code>$tenant</code>.</li> <li>\u0110\u1ed1i v\u1edbi d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m (PII), placeholder ph\u1ea3i \u1ea9n danh (hash) tr\u01b0\u1edbc khi so s\u00e1nh.</li> </ul>"},{"location":"architecture/rbac-deep-dive/#6-chien-luoc-cache-rbac-tai-api-gateway","title":"6. Chi\u1ebfn l\u01b0\u1ee3c Cache RBAC t\u1ea1i API Gateway","text":"<p>M\u1ee5c ti\u00eau \u2013 Gi\u1ea3m \u0111\u1ed9 tr\u1ec5 u\u1ef7 quy\u1ec1n v\u00e0 t\u1ea3i truy v\u1ea5n RBAC, nh\u01b0ng v\u1eabn b\u1ea3o \u0111\u1ea3m c\u1eadp nh\u1eadt t\u1ee9c th\u1eddi khi quy\u1ec1n thay \u0111\u1ed5i ho\u1eb7c token b\u1ecb thu h\u1ed3i.</p>"},{"location":"architecture/rbac-deep-dive/#61-co-che-tong-quan","title":"6.1 C\u01a1 ch\u1ebf t\u1ed5ng quan","text":"<ol> <li>Gateway x\u00e1c th\u1ef1c ch\u1eef k\u00fd JWT offline b\u1eb1ng JWKS (cache 10 \u2032).  </li> <li>Tr\u01b0\u1edbc khi \u0111\u00e1nh gi\u00e1 RBAC, Gateway:  </li> <li>Ki\u1ec3m tra kho\u00e1 <code>revoked:{jti}</code> trong Redis (TTL 15 \u2032).  </li> <li>N\u1ebfu miss cache RBAC (<code>rbac:{user_id}:{tenant_id}</code>) \u2192 g\u1ecdi Sub User Service n\u1ea1p l\u1ea1i.  </li> <li>Quy\u1ec1n m\u1edbi / thu h\u1ed3i token \u0111\u01b0\u1ee3c \u0111\u1ea9y s\u1ef1 ki\u1ec7n qua Pub/Sub \u0111\u1ec3 Gateway t\u1ef1 xo\u00e1 cache.</li> </ol>"},{"location":"architecture/rbac-deep-dive/#62-cau-truc-cache","title":"6.2 C\u1ea5u tr\u00fac cache","text":""},{"location":"architecture/rbac-deep-dive/#key","title":"\ud83d\udd11 Key","text":"<pre><code>rbac:{user_id}:{tenant_id}\n</code></pre>"},{"location":"architecture/rbac-deep-dive/#value","title":"\ud83d\udce6 Value","text":"<pre><code>{\n  \"roles\": [\"teacher\"],\n  \"permissions\": [\"grade.edit_assignment\", \"report.view_login_by_tenant\"],\n  \"issued_at\": \"2025-07-01T12:00:00Z\"\n}\n</code></pre>"},{"location":"architecture/rbac-deep-dive/#ttl-lam-moi","title":"\u23f1 TTL &amp; L\u00e0m m\u1edbi","text":"TTL M\u1ee9c \u00e1p d\u1ee5ng Ghi ch\u00fa 10 ph\u00fat Core services (Gateway \u2192 Master) Gi\u00e1 tr\u1ecb m\u1eb7c \u0111\u1ecbnh 5\u201315 ph\u00fat Tenant stack (Gateway \u2192 Sub) \u0110i\u1ec1u ch\u1ec9nh theo t\u1ea3i tenant Invalidate Khi JWT m\u1edbi c\u00f3 RBAC m\u1edbi ho\u1eb7c event <code>rbac_updated</code> T\u1ee9c th\u1eddi xo\u00e1 cache"},{"location":"architecture/rbac-deep-dive/#63-kiem-tra-token-bi-thu-hoi-revoked","title":"6.3 Ki\u1ec3m tra token b\u1ecb thu h\u1ed3i (revoked)","text":"<ul> <li> <p>Redis key <code>revoked:{jti}</code> (TTL 15 \u2032) \u2013 Token Service \u0111\u1ed3ng b\u1ed9 ngay sau <code>/token/revoke</code>.</p> </li> <li> <p>Gateway tra key tr\u01b0\u1edbc khi \u0111\u00e1nh gi\u00e1 RBAC:</p> </li> </ul> <pre><code>403\n{\n  \"error\": { \"code\": \"token.revoked\", \"message\": \"Token \u0111\u00e3 b\u1ecb thu h\u1ed3i\" },\n  \"meta\": { \"trace_id\": \"\u2026\", \"service\": \"api_gateway\", \"timestamp\": \"\u2026\" }\n}\n</code></pre> <ul> <li> <p>N\u1ebfu cache-miss, Gateway g\u1ecdi <code>POST /token/introspect</code> \u0111\u1ec3 x\u00e1c minh.</p> </li> <li> <p>Metric gi\u00e1m s\u00e1t</p> </li> <li> <p><code>revoked_token_cache_hit_ratio</code> \u2265 98 % \u2013 alert &lt; 90 % 10\u2032.</p> </li> <li><code>rbac_cache_latency_p95</code> &lt; 5 ms.</li> </ul>"},{"location":"architecture/rbac-deep-dive/#64-invalidation-qua-pubsub","title":"6.4 Invalidation qua Pub/Sub","text":"S\u1ef1 ki\u1ec7n N\u01a1i ph\u00e1t H\u00e0nh \u0111\u1ed9ng Gateway <code>rbac_updated</code> Sub User Service Xo\u00e1 <code>rbac:{user_id}:{tenant_id}</code> <code>token.revoked</code> Token Service Xo\u00e1 <code>revoked:{jti}</code> &amp; cache RBAC li\u00ean quan <code>user_status_changed</code> User Master / Sub V\u00f4 hi\u1ec7u ho\u00e1 JWT &amp; cache RBAC"},{"location":"architecture/rbac-deep-dive/#65-quy-tac-ac-biet-cho-bao-cao","title":"6.5 Quy t\u1eafc \u0111\u1eb7c bi\u1ec7t cho b\u00e1o c\u00e1o","text":"<ul> <li>C\u00e1c permission <code>report.*</code> th\u01b0\u1eddng \u0111\u01b0\u1ee3c \u0111\u00e1nh gi\u00e1 t\u1ea1i Gateway khi Superadmin Webapp g\u1ecdi Reporting Service.</li> <li>N\u1ebfu permission c\u00f3 <code>condition</code>, Condition Engine so kh\u1edbp <code>input_parameters</code> v\u1edbi context ng\u01b0\u1eddi d\u00f9ng. (Xem m\u1ee5c 5).</li> </ul> <p>\ud83d\udcd8 \u0110\u1ecbnh ngh\u0129a schema s\u1ef1 ki\u1ec7n: <code>rbac-events.md</code></p>"},{"location":"architecture/rbac-deep-dive/#7-chien-luoc-ong-bo-rbac","title":"7. Chi\u1ebfn l\u01b0\u1ee3c \u0110\u1ed3ng b\u1ed9 RBAC","text":"<p>M\u1ee5c ti\u00eau \u2013 Cho ph\u00e9p tenant k\u1ebf th\u1eeba RBAC chu\u1ea9n, tu\u1ef3 ch\u1ec9nh khi c\u1ea7n, nh\u01b0ng v\u1eabn gi\u1eef t\u00ednh nh\u1ea5t qu\u00e1n &amp; d\u1ec5 quan s\u00e1t. C\u01a1 ch\u1ebf \u0111\u1ed3ng b\u1ed9 d\u1ef1a tr\u00ean Pub/Sub v\u00e0 schema versioning (ADR-030).</p>"},{"location":"architecture/rbac-deep-dive/#71-ke-thua-tuy-chinh","title":"7.1 K\u1ebf th\u1eeba &amp; T\u00f9y ch\u1ec9nh","text":"H\u00e0nh \u0111\u1ed9ng API / S\u1ef1 ki\u1ec7n K\u1ebft qu\u1ea3 Import template <code>POST /rbac/templates/import</code> Tenant l\u1ea5y b\u1ea3n snapshot Role/Permission t\u1eeb Master (version hi\u1ec7n t\u1ea1i). Clone template <code>POST /rbac/templates/clone</code> T\u1ea1o b\u1ea3n sao (<code>schema_version</code> k\u1ebf th\u1eeba) \u2192 s\u1eeda <code>role_name</code>, <code>condition</code>. T\u1ea1o m\u1edbi <code>POST /rbac/templates</code> B\u1ea3n tr\u1eafng ho\u00e0n to\u00e0n, version m\u1eb7c \u0111\u1ecbnh 1. Sync \u0111\u1ecbnh k\u1ef3 Cron-option (<code>weekly</code>, <code>monthly</code>) Ch\u1ec9 \u00e1p d\u1ee5ng template ch\u01b0a clone; diff \u2192 update t\u1ef1 \u0111\u1ed9ng. <p>Tenant clone = m\u1ea5t \u0111\u01b0\u1eddng sync; ph\u1ea3i c\u1eadp nh\u1eadt th\u1ee7 c\u00f4ng n\u1ebfu Master \u0111\u1ed5i.</p>"},{"location":"architecture/rbac-deep-dive/#72-gan-role-cho-nguoi-dung","title":"7.2 G\u00e1n Role cho Ng\u01b0\u1eddi d\u00f9ng","text":"<ul> <li>API Sub User Service (\u0111\u01b0\u1ee3c Admin Portal s\u1eed d\u1ee5ng):  </li> <li><code>PUT /users/{id}/roles</code> \u2013 g\u00e1n ho\u1eb7c g\u1ee1 <code>role_id</code>.  </li> <li><code>PATCH /users/{id}</code> \u2013 c\u1eadp nh\u1eadt <code>is_active_in_tenant</code>.  </li> <li><code>POST /roles</code> \u2013 t\u1ea1o role tu\u1ef3 ch\u1ec9nh (y\u00eau c\u1ea7u permission <code>rbac.manage_role</code>).  </li> <li>M\u1ed7i thao t\u00e1c xu\u1ea5t s\u1ef1 ki\u1ec7n <code>rbac_updated</code> (payload c\u00f3 <code>schema_version</code>).</li> </ul>"},{"location":"architecture/rbac-deep-dive/#73-ong-bo-invalidate-pubsub","title":"7.3 \u0110\u1ed3ng b\u1ed9 &amp; Invalidate (Pub/Sub)","text":"<pre><code>flowchart LR\n  RBT(\ud83d\udce5 rbac_updated) -- publish --&gt; Bus((Pub/Sub))\n  Bus -- fan-out --&gt; GW(API Gateway)\n  Bus -- fan-out --&gt; Audit(Audit-Logging)\n  GW -- purge --&gt; RedisRBAC[(\"rbac:{user_id}:{tid}\")]\n</code></pre> S\u1ef1 ki\u1ec7n Ph\u00e1t t\u1eeb H\u00e0nh \u0111\u1ed9ng Gateway <code>rbac_updated.v1</code> Sub User Service Xo\u00e1 cache RBAC li\u00ean quan <code>rbac_template_cloned.v1</code> Tenant Admin Ch\u1ec9 ghi log, kh\u00f4ng t\u1ef1 sync <code>rbac_template_synced.v1</code> Job Master\u2192Tenant C\u1eadp nh\u1eadt <code>schema_version</code> m\u1edbi"},{"location":"architecture/rbac-deep-dive/#74-versioning-conflict","title":"7.4 Versioning &amp; Conflict","text":"<ul> <li>M\u1ed7i b\u1ea3n ghi role / permission c\u00f3 <code>schema_version</code>.</li> <li>Khi Master n\u00e2ng version, pipeline <code>template_sync</code> g\u1eedi diff; n\u1ebfu b\u1ea3n tenant \u0111\u00e3 clone \u2192 c\u1ea3nh b\u00e1o \u201cforked template\u201d.</li> <li>\u0110i\u1ec1u ki\u1ec7n conflict: <code>permission_code</code> tr\u00f9ng nh\u01b0ng version kh\u00e1c \u2192 job flag <code>status=conflict</code>, y\u00eau c\u1ea7u Admin tenant r\u00e0 so\u00e1t.</li> </ul>"},{"location":"architecture/rbac-deep-dive/#75-ong-bo-inh-ky-tuy-chon","title":"7.5 \u0110\u1ed3ng b\u1ed9 \u0111\u1ecbnh k\u1ef3 (t\u00f9y ch\u1ecdn)","text":"<ul> <li>Tenant ch\u1ecdn trong Settings \u2192 RBAC Sync: <code>off</code> / <code>weekly</code> / <code>monthly</code>.</li> <li>Job Cloud Scheduler + Cloud Run g\u1ecdi <code>POST /templates/sync</code> \u2192 Master t\u00ednh diff \u2192 ph\u00e1t <code>rbac_template_synced.v1</code>.</li> </ul>"},{"location":"architecture/rbac-deep-dive/#76-kpi-monitoring","title":"7.6 KPI &amp; Monitoring","text":"Metric M\u1ee5c ti\u00eau Alert <code>rbac_sync_success_rate</code> = 100 % b\u1ea5t k\u1ef3 failure <code>rbac_conflict_count</code> = 0 &gt; 0 t\u1ea1o Jira ticket <code>rbac_template_age_days</code> &lt; 30 ng\u00e0y (sync weekly) &gt; 45 ng\u00e0y <p>\ud83d\udcd8 Schema s\u1ef1 ki\u1ec7n chi ti\u1ebft xem <code>rbac-events.md</code>.</p>"},{"location":"architecture/rbac-deep-dive/#8-hieu-nang-kha-nang-mo-rong","title":"8. Hi\u1ec7u n\u0103ng &amp; Kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng","text":"<p>H\u1ec7 th\u1ed1ng RBAC c\u1ee7a dx-vas ph\u1ea3i ph\u1ee5c v\u1ee5 200+ tenant v\u1edbi h\u00e0ng ng\u00e0n ng\u01b0\u1eddi d\u00f9ng/tenant, \u0111\u1ed3ng th\u1eddi gi\u1eef p95 latency &lt; 5 ms cho b\u01b0\u1edbc u\u1ef7 quy\u1ec1n t\u1ea1i API Gateway.</p>"},{"location":"architecture/rbac-deep-dive/#81-ky-thuat-toi-uu","title":"8.1 K\u1ef9 thu\u1eadt t\u1ed1i \u01b0u","text":"K\u1ef9 thu\u1eadt M\u00f4 t\u1ea3 L\u1ee3i \u00edch Gateway RBAC cache L\u01b0u <code>rbac:{user_id}:{tenant_id}</code> 5\u201315 ph\u00fat Tr\u00e1nh round-trip Sub Service \u2192 gi\u1ea3m ~2 ms / request Redis revoked-token cache Key <code>revoked:{jti}</code> TTL 15\u2032 Ki\u1ec3m tra thu h\u1ed3i token c\u1ee5c b\u1ed9, kh\u00f4ng g\u1ecdi <code>/token/introspect</code> Pub/Sub Fan-out invalidate S\u1ef1 ki\u1ec7n <code>rbac_updated</code>, <code>token.revoked</code> \u2192 Gateway xo\u00e1 cache C\u1eadp nh\u1eadt g\u1ea7n-real-time (&lt; 1 s) Condition Engine JSON(B) So s\u00e1nh <code>$user</code>, <code>$request</code>, <code>$tenant</code> t\u1ea1i Gateway RBAC linh ho\u1ea1t, kh\u00f4ng b\u00f9ng n\u1ed5 b\u1ea3ng Permission Batch API <code>POST /users/roles:batchAssign</code> Gi\u1ea3m s\u1ed1 k\u1ebft n\u1ed1i DB / network"},{"location":"architecture/rbac-deep-dive/#82-quy-mo-cloud-cloud-scale","title":"8.2 Quy m\u00f4 Cloud (Cloud-Scale)","text":"<ul> <li>Redis Cluster 3-node, namespace theo <code>tenant_id</code> \u2192 h\u1ea1n ch\u1ebf kho\u00e1 n\u00f3ng, b\u1ea3o v\u1ec7 tenant kh\u00e1c.  </li> <li>Sub User Service autoscale HPA (CPU + RPS) \u2192 tenant b\u1eadn kh\u00f4ng \u1ea3nh h\u01b0\u1edfng tenant r\u1ea3nh.  </li> <li>Message Bus Pub/Sub topic <code>tenant.*</code> chia partition = tenant \u2192 b\u1ea3o \u0111\u1ea3m th\u1ee9 t\u1ef1 trong tenant.  </li> <li>Data Model <code>roles_in_tenant</code> &amp; <code>permissions_in_tenant</code> shard theo <code>tenant_id</code> \u2192 ch\u1ec9 qu\u00e9t ph\u1ea1m vi nh\u1ecf.</li> </ul>"},{"location":"architecture/rbac-deep-dive/#83-monitoring-alerting","title":"8.3 Monitoring &amp; Alerting","text":"Metric M\u1ee5c ti\u00eau Alert <code>rbac_cache_hit_ratio</code> \u2265 98 % &lt; 95 % trong 10\u2032 <code>revoked_token_cache_hit_ratio</code> \u2265 95 % &lt; 90 % trong 10\u2032 <code>rbac_cond_latency_p95</code> &lt; 5 ms &gt; 10 ms trong 5\u2032 <code>rbac_conflict_count</code> = 0 b\u1ea5t k\u1ef3 &gt; 0 <code>user_roles_count_p99</code> &lt; 50 user &gt; 100 role \u2192 Jira ticket <p>Log sample :</p> <pre><code>{\n  \"tenant_id\": \"tenant-abc\",\n  \"user_id\": \"u-123\",\n  \"cache_hit\": true,\n  \"cache_type\": \"rbac\",\n  \"latency_ms\": 1.8,\n  \"trace_id\": \"trace-xyz\"\n}\n</code></pre>"},{"location":"architecture/rbac-deep-dive/#84-inh-huong-toi-uu-tiep-theo","title":"8.4 \u0110\u1ecbnh h\u01b0\u1edbng t\u1ed1i \u01b0u ti\u1ebfp theo","text":"<ul> <li>JWT-signed RBAC claims (\u201cembedded RBAC\u201d) \u2192 TTL 2 \u2032 + checksum, gi\u1ea3m truy v\u1ea5n Redis \u1edf m\u1ee9c c\u1ef1c l\u1edbn.</li> <li>Edge-Cache (CDN) JWKS gi\u1ea3m th\u1eddi gian t\u1ea3i key \u1edf v\u00f9ng xa.</li> <li>Adaptive TTL \u2013 Gateway k\u00e9o d\u00e0i TTL cho user \u00edt thay \u0111\u1ed5i, r\u00fat ng\u1eafn cho admin thao t\u00e1c nhi\u1ec1u quy\u1ec1n.</li> </ul> <p>K\u1ebft qu\u1ea3 mong \u0111\u1ee3i: V\u1edbi c\u00e1c k\u1ef9 thu\u1eadt tr\u00ean, dx-vas gi\u1eef \u0111\u01b0\u1ee3c hi\u1ec7u n\u0103ng \u1ed5n \u0111\u1ecbnh khi m\u1edf r\u1ed9ng tenant m\u1edbi, \u0111\u1ed3ng th\u1eddi b\u1ea3o \u0111\u1ea3m vi\u1ec7c thu h\u1ed3i quy\u1ec1n/token di\u1ec5n ra trong v\u00e0i gi\u00e2y \u2013 kh\u00f4ng \u1ea3nh h\u01b0\u1edfng tr\u1ea3i nghi\u1ec7m ng\u01b0\u1eddi d\u00f9ng.</p>"},{"location":"architecture/rbac-deep-dive/#9-bao-mat-chuyen-sau-trong-rbac","title":"9. B\u1ea3o m\u1eadt chuy\u00ean s\u00e2u trong RBAC","text":"<p>RBAC l\u00e0 l\u1edbp ki\u1ec3m so\u00e1t truy c\u1eadp tr\u1ecdng y\u1ebfu, n\u00ean c\u00e1c nguy\u00ean t\u1eafc b\u1ea3o m\u1eadt sau \u0111\u01b0\u1ee3c \u00e1p d\u1ee5ng nghi\u00eam ng\u1eb7t trong h\u1ec7 th\u1ed1ng dx-vas:</p>"},{"location":"architecture/rbac-deep-dive/#isolation-theo-tenant","title":"\ud83d\udd10 Isolation theo Tenant","text":"<ul> <li>M\u1ed7i Sub User Service ch\u1ec9 truy xu\u1ea5t d\u1eef li\u1ec7u ng\u01b0\u1eddi d\u00f9ng v\u00e0 role/permission c\u1ee7a ch\u00ednh tenant \u0111\u00f3</li> <li>Kh\u00f4ng c\u00f3 API cho ph\u00e9p thao t\u00e1c ch\u00e9o tenant</li> </ul>"},{"location":"architecture/rbac-deep-dive/#ten-inh-danh-va-khong-gian-rbac","title":"\ud83d\udd10 T\u00ean \u0111\u1ecbnh danh v\u00e0 kh\u00f4ng gian RBAC","text":"<ul> <li>C\u00e1c vai tr\u00f2 (<code>role_code</code>) v\u00e0 quy\u1ec1n (<code>permission_code</code>) ph\u1ea3i l\u00e0 duy nh\u1ea5t trong ph\u1ea1m vi tenant</li> <li>Kh\u00f4ng cho ph\u00e9p \u201cshadow\u201d vai tr\u00f2 t\u1eeb tenant kh\u00e1c</li> </ul>"},{"location":"architecture/rbac-deep-dive/#chong-gia-mao-jwt","title":"\ud83d\udd10 Ch\u1ed1ng gi\u1ea3 m\u1ea1o JWT","text":"<ul> <li>JWT \u0111\u01b0\u1ee3c k\u00fd RS256 b\u1edfi Token Service; Gateway x\u00e1c th\u1ef1c offline qua JWKS cache 10\u2032.  </li> <li>Gateway th\u00eam b\u01b0\u1edbc \u201ccheck revoked\u201d (Redis) tr\u01b0\u1edbc khi \u0111\u00e1nh gi\u00e1 RBAC.</li> </ul>"},{"location":"architecture/rbac-deep-dive/#api-rbac-luon-bao-ve-boi-auth-role","title":"\ud83d\udd10 API RBAC lu\u00f4n b\u1ea3o v\u1ec7 b\u1edfi Auth + Role","text":"<ul> <li>M\u1ecdi thao t\u00e1c g\u00e1n quy\u1ec1n, g\u00e1n vai tr\u00f2, c\u1eadp nh\u1eadt ph\u1ea3i c\u00f3 quy\u1ec1n c\u1ee5 th\u1ec3 (<code>manage_rbac</code>, <code>assign_role</code>, v.v.)</li> </ul>"},{"location":"architecture/rbac-deep-dive/#10-giam-sat-go-loi","title":"10. Gi\u00e1m s\u00e1t &amp; G\u1ee1 l\u1ed7i","text":"<p>\u0110\u1ec3 h\u1ed7 tr\u1ee3 v\u1eadn h\u00e0nh v\u00e0 b\u1ea3o m\u1eadt, c\u00e1c h\u00e0nh \u0111\u1ed9ng li\u00ean quan \u0111\u1ebfn RBAC \u0111\u01b0\u1ee3c log v\u00e0 theo d\u00f5i chi ti\u1ebft:</p>"},{"location":"architecture/rbac-deep-dive/#audit-trail","title":"\ud83e\udeb5 Audit Trail","text":"<ul> <li>M\u1ed7i h\u00e0nh \u0111\u1ed9ng:</li> <li>G\u00e1n vai tr\u00f2</li> <li>T\u1ea1o permission</li> <li>C\u1eadp nh\u1eadt condition</li> <li>\u0110\u01b0\u1ee3c log k\u00e8m:</li> <li><code>user_id</code>, <code>actor_id</code>, <code>tenant_id</code>, <code>timestamp</code>, <code>payload_before</code>, <code>payload_after</code></li> <li>C\u00e1c h\u00e0nh vi truy c\u1eadp b\u00e1o c\u00e1o (truy v\u1ea5n, export, xem c\u1ea5u h\u00ecnh) \u0111\u01b0\u1ee3c log v\u00e0o Audit Logging Stack \u0111\u1ec3 h\u1ed7 tr\u1ee3 b\u1ea3o m\u1eadt v\u00e0 ph\u00e2n t\u00edch h\u00e0nh vi.</li> <li>Vi\u1ec7c log n\u00e0y tu\u00e2n th\u1ee7 \u0111\u1ecbnh d\u1ea1ng <code>ADR-008</code> v\u00e0 c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c d\u00f9ng \u0111\u1ec3 sinh c\u00e1c b\u00e1o c\u00e1o ph\u00e2n quy\u1ec1n v\u00e0 audit s\u1eed d\u1ee5ng h\u1ec7 th\u1ed1ng b\u00e1o c\u00e1o.</li> </ul>"},{"location":"architecture/rbac-deep-dive/#debug-flow-tai-gateway","title":"\ud83e\uddea Debug Flow t\u1ea1i Gateway","text":"<ul> <li>G\u1eafn <code>X-RBAC-Trace-ID</code> v\u00e0o m\u1ed7i request n\u1ebfu b\u1eadt debug</li> <li>Log c\u00e1c b\u01b0\u1edbc \u0111\u00e1nh gi\u00e1: permission match, condition eval, cache hit/miss</li> <li>C\u00f3 th\u1ec3 b\u1eadt ch\u1ebf \u0111\u1ed9 \u201cdry-run\u201d RBAC tr\u00ean staging \u0111\u1ec3 ki\u1ec3m tra rule m\u1edbi</li> </ul>"},{"location":"architecture/rbac-deep-dive/#metrics","title":"\ud83d\udcc8 Metrics","text":"<ul> <li>S\u1ed1 l\u01b0\u1ee3ng permission theo tenant</li> <li>T\u1ef7 l\u1ec7 cache hit/miss RBAC</li> <li>C\u1ea3nh b\u00e1o n\u1ebfu user c\u00f3 s\u1ed1 role v\u01b0\u1ee3t ng\u01b0\u1ee1ng</li> <li><code>revoked_token_cache_hit_ratio</code></li> </ul>"},{"location":"architecture/rbac-deep-dive/#11-best-practices-cho-quan-tri-rbac","title":"11. Best Practices cho Qu\u1ea3n tr\u1ecb RBAC","text":"<p>M\u1ed9t s\u1ed1 khuy\u1ebfn ngh\u1ecb \u0111\u01b0\u1ee3c \u00e1p d\u1ee5ng v\u00e0 ki\u1ec3m so\u00e1t qua Superadmin Webapp ho\u1eb7c Admin Webapp t\u1ea1i tenant:</p> <ul> <li>\u2705 \u0110\u1eb7t t\u00ean <code>role_code</code>, <code>permission_code</code> r\u00f5 r\u00e0ng, snake_case</li> <li>\u2705 T\u00e1ch vai tr\u00f2 theo domain ch\u1ee9c n\u0103ng: <code>academic_staff</code>, <code>finance_admin</code>, <code>class_teacher</code></li> <li>\u2705 Gi\u1edbi h\u1ea1n s\u1ed1 vai tr\u00f2/user \u2264 10 \u0111\u1ec3 d\u1ec5 ki\u1ec3m so\u00e1t</li> <li>\u2705 \u01afu ti\u00ean d\u00f9ng permission c\u00f3 <code>condition</code> h\u01a1n l\u00e0 t\u1ea1o th\u00eam role m\u1edbi</li> <li>\u2705 D\u00f9ng template n\u1ebfu tenant kh\u00f4ng c\u00f3 nhu c\u1ea7u tu\u1ef3 ch\u1ec9nh</li> <li>\u274c Kh\u00f4ng cho ph\u00e9p s\u1eeda <code>role_code</code> sau khi g\u00e1n cho user</li> <li>\u274c Kh\u00f4ng c\u1ea5p quy\u1ec1n <code>manage_rbac</code> \u0111\u1ea1i tr\u00e0 \u2013 n\u00ean g\u00e1n cho 1\u20132 ng\u01b0\u1eddi c\u00f3 tr\u00e1ch nhi\u1ec7m</li> <li>\ud83d\udd12 Ph\u00e2n quy\u1ec1n truy c\u1eadp b\u00e1o c\u00e1o k\u1ef9 l\u01b0\u1ee1ng: C\u00e1c permission d\u1ea1ng <code>report.view_*</code> n\u00ean \u0111\u01b0\u1ee3c g\u00e1n r\u00f5 r\u00e0ng theo vai tr\u00f2, gi\u1edbi h\u1ea1n theo scope (<code>tenant</code> ho\u1eb7c <code>global</code>). Nh\u1eefng quy\u1ec1n nh\u01b0 <code>report.manage_report_templates</code> n\u00ean ch\u1ec9 c\u1ea5p cho Superadmin ho\u1eb7c roles \u0111\u1eb7c bi\u1ec7t, \u0111\u1ec3 tr\u00e1nh nguy c\u01a1 r\u00f2 r\u1ec9 th\u00f4ng tin ho\u1eb7c truy v\u1ea5n nh\u1ea1y c\u1ea3m.</li> </ul>"},{"location":"architecture/rbac-deep-dive/#12-cong-cu-tai-lieu-lien-quan","title":"12. C\u00f4ng c\u1ee5 &amp; T\u00e0i li\u1ec7u li\u00ean quan","text":"<p>\ud83d\udcd8 T\u00e0i li\u1ec7u k\u1ef9 thu\u1eadt chi ti\u1ebft li\u00ean quan \u0111\u1ebfn RBAC:</p> M\u1ee5c File Ki\u1ebfn tr\u00fac t\u1ed5ng quan RBAC <code>README.md</code> M\u00f4 h\u00ecnh d\u1eef li\u1ec7u User Master <code>user-service/master/data-model.md</code> M\u00f4 h\u00ecnh d\u1eef li\u1ec7u Sub User Service <code>user-service/tenant/data-model.md</code> Giao di\u1ec7n qu\u1ea3n tr\u1ecb RBAC <code>ic-02-admin-webapp.md</code> Ki\u1ec3m so\u00e1t x\u00e1c th\u1ef1c &amp; JWT <code>adr-006-auth-strategy.md</code> Quy t\u1eafc \u0111i\u1ec1u ki\u1ec7n &amp; JSONB <code>rbac-condition-schema.md</code> S\u1ef1 ki\u1ec7n RBAC &amp; Cache Invalidation <code>rbac-events.md</code> Danh s\u00e1ch role m\u1eabu to\u00e0n h\u1ec7 th\u1ed1ng <code>global-roles-template.yaml</code>"},{"location":"architecture/rbac-deep-dive/#so-o-rbac-phan-tang-user-master-va-sub-user-services","title":"\ud83d\udd0d S\u01a1 \u0111\u1ed3 RBAC Ph\u00e2n t\u1ea7ng \u2013 User Master v\u00e0 Sub User Services","text":"<pre><code>flowchart TD\n\n  subgraph Master[\"User Service Master\"]\n    UGM[users_global]\n    TENTS[tenants]\n    UTA[user_tenant_assignments]\n    GRT[global_roles_templates]\n    GPT[global_permissions_templates]\n  end\n\n  subgraph Tenant_A[\"Sub User Service \u2013 Tenant A\"]\n    UTA1[users_in_tenant]\n    RA1[roles_in_tenant]\n    PA1[permissions_in_tenant]\n    URA1[user_role_in_tenant]\n    RPA1[role_permission_in_tenant]\n  end\n\n  subgraph Tenant_B[\"Sub User Service \u2013 Tenant B\"]\n    UTA2[users_in_tenant]\n    RA2[roles_in_tenant]\n    PA2[permissions_in_tenant]\n    URA2[user_role_in_tenant]\n    RPA2[role_permission_in_tenant]\n  end\n\n  %% Mapping\n  UGM --&gt; UTA\n  TENTS --&gt; UTA\n  UGM --&gt; UTA1\n  UGM --&gt; UTA2\n\n  GRT --&gt; RA1\n  GRT --&gt; RA2\n  GPT --&gt; PA1\n  GPT --&gt; PA2\n\n  UTA1 --&gt; URA1\n  RA1 --&gt; URA1\n  RA1 --&gt; RPA1\n  PA1 --&gt; RPA1\n\n  UTA2 --&gt; URA2\n  RA2 --&gt; URA2\n  RA2 --&gt; RPA2\n  PA2 --&gt; RPA2\n</code></pre> <p>\ud83d\udccc Gi\u1ea3i th\u00edch:</p> <ul> <li><code>users_global</code> l\u00e0 ngu\u1ed3n \u0111\u1ecbnh danh chung, d\u00f9ng cho t\u1ea5t c\u1ea3 c\u00e1c tenant.</li> <li> <p>M\u1ed7i tenant c\u00f3 Sub User Service qu\u1ea3n l\u00fd ri\u00eang:</p> </li> <li> <p><code>users_in_tenant</code> \u00e1nh x\u1ea1 t\u1edbi <code>user_id_global</code></p> </li> <li>Vai tr\u00f2 &amp; quy\u1ec1n c\u1ee5c b\u1ed9, c\u00f3 th\u1ec3 k\u1ebf th\u1eeba t\u1eeb Master ho\u1eb7c t\u1ef1 \u0111\u1ecbnh ngh\u0129a</li> <li>Mapping RBAC (<code>user \u2194 role \u2194 permission</code>) l\u00e0 \u0111\u1ed9c l\u1eadp gi\u1eefa c\u00e1c tenant.</li> </ul> <p>\ud83d\udcd8 S\u01a1 \u0111\u1ed3 n\u00e0y gi\u00fap Superadmin, DevOps v\u00e0 Dev hi\u1ec3u r\u00f5 lu\u1ed3ng ph\u00e2n quy\u1ec1n, v\u1ecb tr\u00ed source of truth, v\u00e0 c\u00e1ch t\u00e1ch bi\u1ec7t b\u1ea3o m\u1eadt gi\u1eefa c\u00e1c tenant.</p>"},{"location":"architecture/rbac-deep-dive/#so-o-luong-kiem-tra-rbac-tai-api-gateway","title":"\ud83d\udd10 S\u01a1 \u0111\u1ed3 Lu\u1ed3ng Ki\u1ec3m tra RBAC t\u1ea1i API Gateway","text":"<pre><code>sequenceDiagram\n    autonumber\n    participant Client as \ud83c\udf10 Client (Frontend)\n    participant Gateway as \ud83d\udee1\ufe0f API Gateway\n    participant Auth as \ud83d\udd10 Auth Service (Master/Sub)\n    participant JWT as \ud83d\udce6 JWT Token\n    participant Redis as \u26a1 RBAC Cache\n    participant SubUser as \ud83e\udde9 Sub User Service (per tenant)\n\n    Client-&gt;&gt;Auth: \u0110\u0103ng nh\u1eadp (OAuth2 / OTP)\n    Auth-&gt;&gt;JWT: Ph\u00e1t h\u00e0nh JWT ch\u1ee9auser_id, tenant_id, roles, permissions\n    Client-&gt;&gt;Gateway: G\u1eedi request k\u00e8m JWT\n\n    Gateway-&gt;&gt;JWT: Gi\u1ea3i m\u00e3 JWT\n    Gateway-&gt;&gt;JWT: L\u1ea5y user_id, tenant_id, permissions\n    alt Cache Hit\n        Gateway-&gt;&gt;Redis: L\u1ea5y RBAC t\u1eeb cacherbac:{user_id}:{tenant_id}\n    else Cache Miss\n        Gateway-&gt;&gt;SubUser: G\u1ecdi API \u0111\u1ec3 l\u1ea5y roles &amp; permissions\n        SubUser--&gt;&gt;Gateway: Tr\u1ea3 v\u1ec1 roles, permissions\n        Gateway-&gt;&gt;Redis: Ghi cache RBAC\n    end\n\n    alt C\u00f3 permission kh\u1edbp + \u0111i\u1ec1u ki\u1ec7n \u0111\u00fang\n        Gateway--&gt;&gt;Client: \u2705 200 OK (forward t\u1edbi backend)\n    else Kh\u00f4ng c\u00f3 quy\u1ec1n / Sai \u0111i\u1ec1u ki\u1ec7n\n        Gateway--&gt;&gt;Client: \u274c 403 Forbidden\n    end\n</code></pre> <p>\ud83d\udccc Gi\u1ea3i th\u00edch nhanh:</p> <ul> <li>Gateway l\u00e0 n\u01a1i trung t\u00e2m \u0111\u00e1nh gi\u00e1 quy\u1ec1n d\u1ef1a tr\u00ean JWT v\u00e0 RBAC.</li> <li>D\u00f9ng cache Redis \u0111\u1ec3 tr\u00e1nh g\u1ecdi Sub User Service qu\u00e1 th\u01b0\u1eddng xuy\u00ean.</li> <li>H\u1ed7 tr\u1ee3 <code>condition JSONB</code> \u0111\u01b0\u1ee3c \u0111\u00e1nh gi\u00e1 t\u1ea1i Gateway b\u1eb1ng context t\u1eeb JWT v\u00e0 request.</li> </ul> <p>\ud83d\udcd8 RBAC cache invalidation \u0111\u01b0\u1ee3c \u0111i\u1ec1u ph\u1ed1i b\u1edfi Pub/Sub events t\u1eeb Sub User Service nh\u01b0 <code>rbac_updated</code> ho\u1eb7c <code>user_status_changed</code>.</p>"},{"location":"architecture/rbac-deep-dive/#so-o-luong-phat-hanh-jwt-a-tenant","title":"\ud83d\udd11 S\u01a1 \u0111\u1ed3 Lu\u1ed3ng Ph\u00e1t h\u00e0nh JWT \u0110a-Tenant","text":"<pre><code>sequenceDiagram\n    autonumber\n    participant FE as \ud83c\udf10 Frontend\n    participant AuthM as \ud83d\udd10 Auth Master\n    participant AuthT as \ud83d\udd10 Auth Sub\n    participant Captcha as \ud83d\udee1\ufe0f reCAPTCHA\n    participant TokenSvc as \ud83d\udddd\ufe0f Token Service\n    participant UserSub as \ud83e\udde9 User Sub (tenant)\n    participant JWT as \ud83d\udce6 JWT\n\n    rect rgba(220,220,220,0.05)\n        FE-&gt;&gt;AuthM: Login Google\n        AuthM-&gt;&gt;UserSub: GET roles/permissions\n        AuthM-&gt;&gt;TokenSvc: POST /token/issue\n        TokenSvc--&gt;&gt;AuthM: JWT (RS256)\n        AuthM--&gt;&gt;FE: Return JWT\n    end\n\n    rect rgba(220,220,220,0.05)\n        FE-&gt;&gt;AuthT: Login OTP\n        AuthT--&gt;&gt;Captcha: verify CAPTCHA\n        Captcha--&gt;&gt;AuthT: OK / Fail\n        AuthT-&gt;&gt;UserSub: GET RBAC\n        AuthT-&gt;&gt;TokenSvc: POST /token/issue\n        TokenSvc--&gt;&gt;AuthT: JWT (RS256)\n        AuthT--&gt;&gt;FE: Return JWT\n    end\n</code></pre> <p>\ud83d\udccc \u0110i\u1ec3m ch\u00ednh:</p> <ul> <li>Auth Master x\u1eed l\u00fd Google OAuth2 + l\u1ef1a ch\u1ecdn tenant.</li> <li>Sub Auth x\u1eed l\u00fd x\u00e1c th\u1ef1c Local/OTP t\u1ea1i tenant.</li> <li>M\u1ecdi JWT ph\u00e1t ra \u0111\u1ec1u ch\u1ee9a <code>user_id_global</code>, <code>tenant_id</code>, <code>roles</code>, <code>permissions</code>, <code>jti</code>, <code>sid</code> \u2013 ph\u1ee5c v\u1ee5 thu h\u1ed3i token &amp; qu\u1ea3n l\u00fd phi\u00ean (See CR-03).</li> </ul> <p>\ud83d\udcd8 Tham kh\u1ea3o chi ti\u1ebft c\u1ea5u tr\u00fac JWT trong <code>adr-006-auth-strategy.md</code></p>"},{"location":"architecture/system-diagrams/","title":"S\u01a1 \u0111\u1ed3 Ki\u1ebfn tr\u00fac H\u1ec7 th\u1ed1ng dx-vas","text":"<p>T\u00e0i li\u1ec7u n\u00e0y t\u1eadp h\u1ee3p t\u1ea5t c\u1ea3 c\u00e1c s\u01a1 \u0111\u1ed3 ki\u1ebfn tr\u00fac quan tr\u1ecdng c\u1ee7a h\u1ec7 th\u1ed1ng chuy\u1ec3n \u0111\u1ed5i s\u1ed1 dx-vas, bao g\u1ed3m:</p> <ul> <li>S\u01a1 \u0111\u1ed3 ki\u1ebfn tr\u00fac t\u1ed5ng th\u1ec3</li> <li>Di\u1ec5n gi\u1ea3i c\u00e1c kh\u1ed1i ch\u1ee9c n\u0103ng</li> <li>C\u00e1c s\u01a1 \u0111\u1ed3 con chi ti\u1ebft theo t\u1eebng lu\u1ed3ng nghi\u1ec7p v\u1ee5 (v\u00ed d\u1ee5: Tuy\u1ec3n sinh, Th\u00f4ng b\u00e1o, Ph\u00e2n quy\u1ec1n RBAC...)</li> </ul>"},{"location":"architecture/system-diagrams/#muc-luc-so-o-kien-truc-he-thong-dx-vas","title":"\ud83d\udcda M\u1ee5c l\u1ee5c S\u01a1 \u0111\u1ed3 Ki\u1ebfn tr\u00fac H\u1ec7 th\u1ed1ng dx-vas","text":"STT T\u00ean s\u01a1 \u0111\u1ed3 M\u00f4 t\u1ea3 ng\u1eafn Li\u00ean k\u1ebft 1\ufe0f\u20e3 Ki\u1ebfn tr\u00fac t\u1ed5ng quan h\u1ec7 th\u1ed1ng Multi-Tenant T\u1ed5ng th\u1ec3 h\u1ec7 th\u1ed1ng g\u1ed3m Shared Core v\u00e0 c\u00e1c Tenant Stack Xem s\u01a1 \u0111\u1ed3 2\ufe0f\u20e3 Lu\u1ed3ng \u0111\u00e1nh gi\u00e1 RBAC t\u1ea1i API Gateway C\u00e1ch Gateway \u0111\u00e1nh gi\u00e1 quy\u1ec1n \u0111\u1ed9ng t\u1eeb JWT + Redis + Sub Service Xem s\u01a1 \u0111\u1ed3 3\ufe0f\u20e3 Lu\u1ed3ng ph\u00e1t h\u00e0nh JWT \u0111a-tenant Qu\u00e1 tr\u00ecnh x\u00e1c th\u1ef1c Google/OTP v\u00e0 ph\u00e1t token Xem s\u01a1 \u0111\u1ed3 4\ufe0f\u20e3 Lu\u1ed3ng g\u1eedi Notification to\u00e0n h\u1ec7 th\u1ed1ng (Option B) Pub/Sub fan-out t\u1eeb Master \u0111\u1ebfn Sub Notification Services Xem s\u01a1 \u0111\u1ed3 5\ufe0f\u20e3 S\u01a1 \u0111\u1ed3 tri\u1ec3n khai h\u1ea1 t\u1ea7ng (Deployment Diagram) T\u1ed5 ch\u1ee9c project GCP cho core/tenant/monitoring/data Xem s\u01a1 \u0111\u1ed3 6\ufe0f\u20e3 V\u00f2ng \u0111\u1eddi t\u00e0i kho\u1ea3n (Account Lifecycle) T\u1eeb t\u1ea1o user \u2192 g\u00e1n tenant \u2192 c\u1ea5p quy\u1ec1n \u2192 v\u00f4 hi\u1ec7u h\u00f3a Xem s\u01a1 \u0111\u1ed3 7\ufe0f\u20e3 Lu\u1ed3ng \u0111\u1ed3ng b\u1ed9 RBAC t\u1eeb Master \u2192 Sub T\u1ef1 \u0111\u1ed9ng ho\u1eb7c th\u1ee7 c\u00f4ng sync role/permission template Xem s\u01a1 \u0111\u1ed3 8\ufe0f\u20e3 Ph\u00e2n quy\u1ec1n giao di\u1ec7n ng\u01b0\u1eddi d\u00f9ng (UI Role Mapping) Vai tr\u00f2 \u0111\u01b0\u1ee3c \u00e1nh x\u1ea1 \u0111\u1ebfn c\u00e1c frontend: Superadmin, Admin, GV, PH Xem s\u01a1 \u0111\u1ed3"},{"location":"architecture/system-diagrams/#1-kien-truc-tong-quan-he-thong-multi-tenant","title":"1. Ki\u1ebfn tr\u00fac t\u1ed5ng quan h\u1ec7 th\u1ed1ng Multi-Tenant","text":"<p>M\u1ee5c ti\u00eau \u2013 Cho th\u1ea5y b\u1ee9c tranh cao nh\u1ea5t: Core Services d\u00f9ng chung, Tenant Stack c\u00f4 l\u1eadp; JWT do Token Service k\u00fd, RBAC cache \u1edf API Gateway, d\u1eef li\u1ec7u nghi\u1ec7p v\u1ee5 g\u00f3i trong SMS (per tenant).</p> <pre><code>flowchart TD\n  %% ======= EXTERNAL =======\n  subgraph ext [\"\ud83c\udf10 External IdP &amp; Channels\"]\n    GoogleOAuth(Google OAuth2)\n    OTPProv(OTP Provider)\n    EmailSvc(Email Gateway)\n    SMSSvc(SMS Gateway)\n  end\n\n  %% ======= FRONTEND =======\n  subgraph fe [\"\ud83d\udcbb Frontend Apps\"]\n    AdminPortal(Admin Portal)\n    TeacherPortal(Teacher Portal)\n    StudentPortal(Student Portal)\n    ParentPortal(Parent Portal)\n  end\n\n  %% ======= CORE SERVICES =======\n  subgraph core [\"\ud83d\udd27 Core Services (Shared)\"]\n    APIGW(API Gateway)\n    TokenSvc(Token Service)\n    AuthM(Auth Master)\n    UserM(User Master)\n    NotifM(Notification Master)\n    RedisRev[Redisrevoked_tokens cache]\n    ReportSvc(Reporting Service)\n    AuditLog(Audit Logging Service)\n    PubSub((Pub / Sub))\n  end\n\n  %% ======= DATA PLATFORM =======\n  subgraph db [\"\ud83d\udd27 Data Platform\"]\n    BQ(Data Warehouse)\n  end\n\n  %% ======= MONITORING STACK =======\n  subgraph mon [\"\ud83d\udcc8 Monitoring Stack\"]\n    CloudLog(Cloud Logging)\n    CloudMon(Cloud Monitoring)\n    AlertSys(Alerting Rules)\n  end\n\n  %% ======= CI / CONTRACT TESTING =======\n  subgraph test [\"\ud83e\uddea CI / Contract Testing\"]\n    CIPipeline(CI/CD Pipeline)\n    ContractEngine(Contract Test Engine)\n    MockUser(Mock: User Service)\n    MockNotif(Mock: Notif Service)\n    MockAuth(Mock: Auth Service)\n  end\n\n  %% ======= TENANT STACK EXAMPLE =======\n  subgraph tenantA [\"\ud83c\udfeb Tenant Stack \u00b7 ABC School\"]\n    subgraph smsgrp [\"School Management System (SMS)\"]\n      SMS(SMS Backend+ MariaDB)\n    end\n    AuthSub(Auth Sub)\n    UserSub(User Sub)\n    NotifSub(Notif Sub)\n  end\n\n  %% ======= FLOWS =======\n  %% Front-door\n  AdminPortal -. https .-&gt; APIGW\n  TeacherPortal -. https .-&gt; APIGW\n  StudentPortal -. https .-&gt; APIGW\n  ParentPortal  -. https .-&gt; APIGW\n\n  %% Auth &amp; Token\n  APIGW --&gt;|/login| AuthM\n  AuthM --&gt;|/token/issue| TokenSvc\n  AuthSub --&gt;|/token/issue| TokenSvc\n  TokenSvc -- JWKS --&gt; APIGW\n\n  %% Revoked-token check\n  APIGW --&gt;|check revoked| RedisRev\n  TokenSvc --&gt;|sync revoked| RedisRev\n\n  %% Core routing\n  APIGW ==&gt; UserM\n  APIGW ==&gt; NotifM\n  APIGW ==&gt; ReportSvc\n  APIGW ==&gt; AuditLog\n\n  %% Tenant routing\n  APIGW ==&gt; AuthSub\n  APIGW ==&gt; UserSub\n  APIGW ==&gt; NotifSub\n  APIGW ==&gt; SMS\n\n  %% Event fan-out\n  UserM -- \"user.*\" --&gt; PubSub\n  NotifM -- \"notif.*\" --&gt; PubSub\n  PubSub -- \"user.*\" --&gt; UserSub\n  PubSub -- \"notif.*\" --&gt; NotifSub\n\n  %% ELT (simplified)\n  SMS -- \"ELT\" --&gt; BQ\n\n  %% Audit Logging\n  AuthM --&gt;|log login| AuditLog\n  TokenSvc --&gt;|log issue/revoke| AuditLog\n  UserM --&gt;|log user change| AuditLog\n  NotifM --&gt;|log notif trigger| AuditLog\n  ReportSvc --&gt;|log report access| AuditLog\n  AuthSub --&gt;|log local login| AuditLog\n  UserSub --&gt;|log role update| AuditLog\n  NotifSub --&gt;|log delivery| AuditLog\n\n  %% Monitoring Stack\n  APIGW --&gt; CloudLog\n  AuthM --&gt; CloudLog\n  TokenSvc --&gt; CloudLog\n  UserM --&gt; CloudLog\n  ReportSvc --&gt; CloudLog\n  AuditLog --&gt; CloudLog\n  AuthSub --&gt; CloudLog\n  UserSub --&gt; CloudLog\n  SMS --&gt; CloudLog\n  NotifSub --&gt; CloudLog\n  CloudLog --&gt; CloudMon\n  CloudMon --&gt; AlertSys\n\n  %% CI/CD &amp; Contract Testing\n  CIPipeline --&gt; ContractEngine\n  ContractEngine --&gt; MockUser\n  ContractEngine --&gt; MockNotif\n  ContractEngine --&gt; MockAuth\n  MockUser --&gt;|simulate calls| APIGW\n  MockNotif --&gt;|simulate notif| APIGW\n  MockAuth --&gt;|simulate login| APIGW\n</code></pre>"},{"location":"architecture/system-diagrams/#chu-thich-mui-ten-uong-net","title":"\ud83d\udddd\ufe0f Ch\u00fa th\u00edch m\u0169i t\u00ean &amp; \u0111\u01b0\u1eddng n\u00e9t","text":"K\u00fd hi\u1ec7u \u00dd ngh\u0129a <code>-. https .-&gt;</code> G\u1ecdi HTTPS t\u1eeb frontend/browser <code>--&gt;</code> G\u1ecdi API \u0111\u1ed3ng b\u1ed9 n\u1ed9i b\u1ed9 <code>==&gt;</code> G\u1ecdi API \u0111\u1ed3ng b\u1ed9 \u01b0u ti\u00ean cao / routing ch\u00ednh <code>..&gt;</code> Lu\u1ed3ng b\u1ea5t \u0111\u1ed3ng b\u1ed9 (Pub/Sub, ELT) <code>-- JWKS --&gt;</code> Gateway t\u1ea3i public key JWKS \u0111\u1ec3 x\u00e1c th\u1ef1c JWT <ul> <li>Token Service k\u00fd JWT (RS256); API Gateway x\u00e1c th\u1ef1c offline qua JWKS cache 10 \u2032 v\u00e0 ki\u1ec3m tra <code>revoked:{jti}</code> trong Redis tr\u01b0\u1edbc khi \u0111\u00e1nh gi\u00e1 RBAC.</li> <li>SMS thay th\u1ebf ho\u00e0n to\u00e0n c\u00e1c adapter CRM/SIS/LMS c\u0169, tr\u1edf th\u00e0nh ngu\u1ed3n d\u1eef li\u1ec7u nghi\u1ec7p v\u1ee5 duy nh\u1ea5t \u1edf m\u1ed7i tenant.</li> <li>M\u1ed7i tenant stack tri\u1ec3n khai \u0111\u1ed9c l\u1eadp; autoscale kh\u00f4ng \u1ea3nh h\u01b0\u1edfng Core Services.</li> </ul> <p>S\u01a1 \u0111\u1ed3 ph\u1ea3n \u00e1nh \u0111\u1ea7y \u0111\u1ee7 hai Change Request g\u1ea7n nh\u1ea5t: Token Service centralization v\u00e0 Tenant Stack simplification v\u1edbi SMS.</p>"},{"location":"architecture/system-diagrams/#2-luong-anh-gia-rbac-tai-api-gateway","title":"2. Lu\u1ed3ng \u0111\u00e1nh gi\u00e1 RBAC t\u1ea1i API Gateway","text":"<p>M\u1ee5c ti\u00eau \u2013 \u0110\u1ea3m b\u1ea3o m\u1ed7i request \u0111\u01b0\u1ee3c x\u00e1c th\u1ef1c (JWT) v\u00e0 u\u1ef7 quy\u1ec1n (RBAC + Condition) &lt; 5 ms p95, \u0111\u1ed3ng th\u1eddi ph\u1ea3n \u1ee9ng t\u1ee9c th\u1eddi khi token b\u1ecb thu h\u1ed3i ho\u1eb7c quy\u1ec1n thay \u0111\u1ed5i.</p>"},{"location":"architecture/system-diagrams/#21-sequence-diagram","title":"2.1 Sequence Diagram","text":"<pre><code>sequenceDiagram\n    autonumber\n    participant FE      as \ud83c\udf10 Frontend\n    participant APIGW   as \ud83d\udee1\ufe0f API Gateway\n    participant RedisRev as \ud83d\udd04 Redis revoked\n    participant RedisRBAC as \ud83d\udd04 Redis RBAC\n    participant UserSub as \ud83e\udde9 User Sub (tenant)\n    participant TokenSvc as \ud83d\udddd\ufe0f Token Service\n\n    FE-&gt;&gt;APIGW: HTTP request + JWT\n    Note right of APIGW: \u2460 Verify RS256 viaJWKS (cache 10\u2032)\n    APIGW-&gt;&gt;RedisRev: GET revoked:{jti}       %% check revoked\n    alt Token revoked\n        APIGW--&gt;&gt;FE: 403 token.revoked\n    else Not revoked\n        APIGW-&gt;&gt;RedisRBAC: GET rbac:{uid}:{tid}\n        alt Cache HIT\n            Note right of APIGW: \u2461 RBAC cache hit\n        else Cache MISS\n            APIGW-&gt;&gt;UserSub: /rbac?uid={uid}\n            UserSub--&gt;&gt;APIGW: roles + perms\n            APIGW-&gt;&gt;RedisRBAC: SET rbac:{uid}:{tid} (TTL)\n        end\n        Note right of APIGW: \u2462 EvaluateCondition Engine\n        alt Permission pass\n            APIGW--&gt;&gt;FE: 2xx success\n        else Denied\n            APIGW--&gt;&gt;FE: 403 auth.permission_denied\n        end\n    end\n</code></pre>"},{"location":"architecture/system-diagrams/#22-buoc-xu-ly-chi-tiet","title":"2.2 B\u01b0\u1edbc x\u1eed l\u00fd chi ti\u1ebft","text":"# B\u01b0\u1edbc Th\u1eddi gian m\u1ee5c ti\u00eau \u2460 X\u00e1c th\u1ef1c ch\u1eef k\u00fd JWT b\u1eb1ng JWKS (cache 10 ph\u00fat) &lt; 0.5 ms \u2461 Tra Redis cache RBAC (<code>rbac:{uid}:{tid}</code>) hit \u2265 98 % \u2462 Engine so s\u00e1nh <code>condition</code> (\\$user, \\$request, \\$tenant) &lt; 4 ms"},{"location":"architecture/system-diagrams/#23-quy-tac-xu-ly","title":"2.3 Quy t\u1eafc x\u1eed l\u00fd","text":"<ol> <li>Token b\u1ecb thu h\u1ed3i \u2192 tr\u1ea3 <code>403 token.revoked</code>, ghi metric <code>revoked_token_cache_hit_ratio</code>.</li> <li>RBAC cache miss \u2192 t\u1ea3i t\u1eeb User Sub r\u1ed3i set TTL 5 \u2013 15 ph\u00fat (tu\u1ef3 tenant).</li> <li>Permission c\u00f3 condition \u2192 n\u1ebfu placeholder thi\u1ebfu / type mismatch \u2192 <code>400 common.validation_failed</code>.</li> <li>M\u1ecdi ph\u1ea3n h\u1ed3i l\u1ed7i d\u00f9ng <code>ErrorEnvelope</code> (ADR-011).</li> </ol>"},{"location":"architecture/system-diagrams/#24-metrics-alert","title":"2.4 Metrics &amp; Alert","text":"Metric M\u1ee5c ti\u00eau Alert <code>rbac_cache_hit_ratio</code> \u2265 98 % &lt; 95 % 10\u2032 <code>revoked_token_cache_hit_ratio</code> \u2265 95 % &lt; 90 % 10\u2032 <code>rbac_cond_latency_p95</code> &lt; 5 ms &gt; 10 ms 5\u2032 <code>rbac_eval_error_rate</code> = 0 b\u1ea5t k\u1ef3 &gt; 0.1 % <p>K\u1ebft qu\u1ea3: V\u1edbi cache hai t\u1ea7ng (RBAC &amp; Revoked) v\u00e0 Engine \u0111i\u1ec1u ki\u1ec7n ch\u1ea1y t\u1ea1i Gateway, dx-vas u\u1ef7 quy\u1ec1n g\u1ea7n-real-time m\u00e0 kh\u00f4ng \u0111\u00e1nh \u0111\u1ed5i hi\u1ec7u n\u0103ng.</p>"},{"location":"architecture/system-diagrams/#3-luong-phat-hanh-jwt-a-tenant","title":"3. Lu\u1ed3ng ph\u00e1t h\u00e0nh JWT \u0111a-tenant","text":"<p>M\u1ee5c ti\u00eau \u2013 T\u1ea1o JWT RS256 ch\u1ee9a \u0111\u1ea7y \u0111\u1ee7 claim (<code>sub</code>, <code>tid</code>, <code>roles</code>, <code>permissions</code>, <code>jti</code>, <code>sid</code>, <code>exp</code>) cho m\u1ecdi ph\u01b0\u01a1ng th\u1ee9c \u0111\u0103ng nh\u1eadp (Google OAuth2 &amp; Local / OTP) v\u00e0 m\u1ecdi tenant.</p>"},{"location":"architecture/system-diagrams/#31-sequence-diagram","title":"3.1 Sequence Diagram","text":"<pre><code>sequenceDiagram\n    autonumber\n    participant FE as \ud83c\udf10 Frontend\n    participant APIGW as \ud83d\udee1\ufe0f API Gateway\n    participant AuthM as \ud83d\udd10 Auth Master\n    participant AuthT as \ud83d\udd10 Auth Sub\n    participant Captcha as \ud83d\udee1\ufe0f reCAPTCHA\n    participant UserSub as \ud83e\udde9 User Sub (tenant)\n    participant TokenSvc as \ud83d\udddd\ufe0f Token Service\n\n    %% JWKS cache line (dashed for offline verify)\n    TokenSvc--&gt;&gt;APIGW: JWKS (cache 10\u2032)\n\n    rect rgba(220,220,220,0.05)\n        FE-&gt;&gt;APIGW: /login/google\n        APIGW-&gt;&gt;AuthM: forward\n        AuthM-&gt;&gt;Google OAuth2: auth code flow\n        Google OAuth2--&gt;&gt;AuthM: id_token\n        AuthM-&gt;&gt;UserSub: GET roles/permissions\n        AuthM-&gt;&gt;TokenSvc: POST /token/issue\n        TokenSvc--&gt;&gt;AuthM: JWT (access + refresh)\n        AuthM--&gt;&gt;APIGW: 200 JWT\n        APIGW--&gt;&gt;FE: 200 JWT\n    end\n\n    rect rgba(220,220,220,0.05)\n        FE-&gt;&gt;APIGW: /login/otp\n        APIGW-&gt;&gt;AuthT: forward\n        AuthT--&gt;&gt;Captcha: verify CAPTCHA\n        Captcha--&gt;&gt;AuthT: OK / Fail\n        AuthT-&gt;&gt;AuthT: verify OTP / password\n        AuthT-&gt;&gt;UserSub: GET RBAC\n        AuthT-&gt;&gt;TokenSvc: POST /token/issue\n        TokenSvc--&gt;&gt;AuthT: JWT (access + refresh)\n        AuthT--&gt;&gt;APIGW: 200 JWT\n        APIGW--&gt;&gt;FE: 200 JWT\n    end\n</code></pre>"},{"location":"architecture/system-diagrams/#32-buoc-xu-ly-chi-tiet","title":"3.2 B\u01b0\u1edbc x\u1eed l\u00fd chi ti\u1ebft","text":"B\u01b0\u1edbc M\u00f4 t\u1ea3 Th\u00e0nh ph\u1ea7n 1 Frontend g\u1eedi y\u00eau c\u1ea7u \u0111\u0103ng nh\u1eadp (Google ho\u1eb7c OTP). FE \u2192 API Gateway 2 Auth Master (Google) ho\u1eb7c Auth Sub (OTP) x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng. AuthM / AuthT 3 G\u1ecdi User Sub l\u1ea5y <code>roles</code>, <code>permissions</code> trong tenant \u0111\u00e3 ch\u1ecdn. AuthM / AuthT 4 G\u1ecdi Token Service <code>POST /token/issue</code> \u2192 nh\u1eadn c\u1eb7p token \u0111\u00e3 k\u00fd RS256. AuthM / AuthT \u2192 TokenSvc 5 Tr\u1ea3 JWT cho Frontend qua API Gateway. AuthM / AuthT \u2192 APIGW \u2192 FE"},{"location":"architecture/system-diagrams/#33-cau-truc-jwt","title":"3.3 C\u1ea5u tr\u00fac JWT","text":"Claim \u00dd ngh\u0129a <code>sub</code> <code>user_id_global</code> <code>tid</code> <code>tenant_id</code> <code>roles</code>, <code>permissions</code> Danh s\u00e1ch vai tr\u00f2 &amp; quy\u1ec1n (RBAC) <code>auth_provider</code> <code>google</code> / <code>local</code> / <code>otp</code> <code>jti</code> UUID duy nh\u1ea5t \u2013 d\u00f9ng thu h\u1ed3i token <code>sid</code> Session ID tham chi\u1ebfu <code>auth_sessions</code> <code>exp</code> H\u1ebft h\u1ea1n \u2264 15 ph\u00fat (access token) <p>Refresh token TTL 14 ng\u00e0y; l\u01b0u <code>auth_sessions</code>.</p>"},{"location":"architecture/system-diagrams/#34-kiem-soat-bao-mat","title":"3.4 Ki\u1ec3m so\u00e1t &amp; B\u1ea3o m\u1eadt","text":"<ul> <li>CAPTCHA b\u1eaft bu\u1ed9c tr\u01b0\u1edbc b\u01b0\u1edbc OTP \u0111\u1ec3 tr\u00e1nh brute-force.</li> <li>JWKS c\u00f4ng khai cache 10 ph\u00fat \u2013 Gateway x\u00e1c th\u1ef1c ch\u1eef k\u00fd offline.</li> <li>Token revocation: <code>/token/revoke</code> th\u00eam <code>jti</code> v\u00e0o Redis (<code>revoked:{jti}</code>) \u2192 Gateway ch\u1eb7n ngay.</li> </ul>"},{"location":"architecture/system-diagrams/#35-metric-giam-sat","title":"3.5 Metric gi\u00e1m s\u00e1t","text":"Metric Target <code>token_issue_latency_p95</code> &lt; 100 ms <code>login_success_rate</code> &gt; 98 % <code>captcha_failure_rate</code> &lt; 2 % <p>K\u1ebft qu\u1ea3: Ng\u01b0\u1eddi d\u00f9ng nh\u1eadn JWT trong m\u1ed9t v\u00f2ng request, c\u00f2n API Gateway s\u1edf h\u1eefu \u0111\u1ee7 th\u00f4ng tin (<code>tid</code>, RBAC, jti) \u0111\u1ec3 x\u00e1c th\u1ef1c &amp; u\u1ef7 quy\u1ec1n si\u00eau nhanh cho t\u1eebng tenant.</p>"},{"location":"architecture/system-diagrams/#4-luong-gui-notification-toan-he-thong-pubsub-fan-out","title":"4. Lu\u1ed3ng g\u1eedi Notification to\u00e0n h\u1ec7 th\u1ed1ng (Pub/Sub fan-out)","text":"<p>M\u1ee5c ti\u00eau \u2013 T\u00e1ch r\u1eddi orchestration (Notification Master) kh\u1ecfi delivery (Notification Sub per tenant), b\u1ea3o \u0111\u1ea3m: \u2022 Th\u1ed1ng nh\u1ea5t template &amp; tracking \u1edf Core. \u2022 Fan-out s\u1ef1 ki\u1ec7n &lt; 1 s t\u1edbi m\u1ecdi tenant. \u2022 Kh\u00f4ng r\u00e0ng bu\u1ed9c tenant v\u00e0o h\u1ea1 t\u1ea7ng SMTP/SMS chung.  </p>"},{"location":"architecture/system-diagrams/#41-sequence-diagram","title":"4.1 Sequence Diagram","text":"<pre><code>sequenceDiagram\n    autonumber\n    participant ServiceX as \ud83d\udcdd Any Core / SMS\n    participant NotifM   as \ud83d\udce3 Notification Master\n    participant PubSub   as \u2601\ufe0f Pub/Subtopic **notification.v1**\n    participant NotifSub as \ud83d\udce9 Notification Sub (tenant)\n    participant EmailSvc as \u2709\ufe0f Email Gateway\n    participant SMSSvc   as \ud83d\udcf1 SMS Gateway\n\n    ServiceX-&gt;&gt;NotifM: POST /notifications (payload, tenant_id)\n    NotifM-&gt;&gt;NotifM: Validate + resolve template\n    NotifM-&gt;&gt;PubSub: \ud83d\udd14 **notif.email_requested.v1**\n    NotifM-&gt;&gt;PubSub: \ud83d\udd14 **notif.sms_requested.v1**\n    PubSub--&gt;&gt;NotifSub: Fan-out event (filter tenant_id)\n    NotifSub-&gt;&gt;EmailSvc: Send email\n    NotifSub-&gt;&gt;SMSSvc: Send SMS\n    NotifSub-&gt;&gt;PubSub: \ud83d\udd14 **notif.sent.v1** (status, message_id)\n    PubSub--&gt;&gt;NotifM: Ack status\n</code></pre>"},{"location":"architecture/system-diagrams/#42-inh-tuyen-schema","title":"4.2 \u0110\u1ecbnh tuy\u1ebfn &amp; Schema","text":"Ch\u1ee7 \u0111\u1ec1 / Event M\u00f4 t\u1ea3 Schema ID (ADR-030) <code>notification.v1</code> Topic chung cho m\u1ecdi s\u1ef1 ki\u1ec7n notificaton \u2014 <code>notif.email_requested.v1</code> Master y\u00eau c\u1ea7u g\u1eedi Email <code>notif_email_req_v1</code> <code>notif.sms_requested.v1</code> Master y\u00eau c\u1ea7u g\u1eedi SMS <code>notif_sms_req_v1</code> <code>notif.sent.v1</code> Sub b\u00e1o c\u00e1o k\u1ebft qu\u1ea3 (OK/FAIL) <code>notif_sent_v1</code> <p>Tenant Sub subscribe v\u1edbi filter <code>attributes.tenant_id == \"&lt;tenant&gt;\"</code> \u2192 t\u00e1ch bi\u1ec7t lu\u1ed3ng.</p>"},{"location":"architecture/system-diagrams/#43-xu-ly-tai-notification-master","title":"4.3 X\u1eed l\u00fd t\u1ea1i Notification Master","text":"<ol> <li>Validate payload &amp; tenant quota.</li> <li>Merge Template \u2194 data; log <code>audit_log.notifications</code>.</li> <li>Publish s\u1ef1 ki\u1ec7n <code>*.requested.v1</code> k\u00e8m <code>schema_version</code>.</li> <li>Track status qua <code>notif.sent.v1</code>; retry n\u1ebfu k\u1ebft qu\u1ea3 <code>FAIL</code>.</li> </ol>"},{"location":"architecture/system-diagrams/#44-xu-ly-tai-notification-sub-per-tenant","title":"4.4 X\u1eed l\u00fd t\u1ea1i Notification Sub (per tenant)","text":"B\u01b0\u1edbc H\u00e0nh \u0111\u1ed9ng Idempotency 1 Nh\u1eadn event; ki\u1ec3m tra <code>dedup_id</code> Redis SETNX 15 m 2 Render template (locale) \u2014 3 G\u1eedi Email / SMS 3 l\u1ea7n retry back-off 4 Publish <code>notif.sent.v1</code> (status, message_id) \u2014"},{"location":"architecture/system-diagrams/#45-kha-nang-mo-rong-sla","title":"4.5 Kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng &amp; SLA","text":"Th\u00e0nh ph\u1ea7n Autoscale SLA Pub/Sub topic <code>notification.v1</code> 100k msg/s \u2265 99.9 % Notification Sub HPA (RPS &amp; queue lag) email &lt; 30 s, sms &lt; 10 s Email/SMS Gateway Ngo\u00e0i ph\u1ea1m vi (3rd-party) \u2014"},{"location":"architecture/system-diagrams/#46-monitoring-alert","title":"4.6 Monitoring &amp; Alert","text":"<ul> <li>Metric <code>notif_sent_success_rate</code> \u2265 97 % (per channel).</li> <li>Lag Pub/Sub <code>subscription/oldest_unacked_age</code> &lt; 5 s.</li> <li>Dashboard s\u1ed1 l\u01b0\u1ee3ng g\u1eedi Email/SMS theo tenant, bounce rate, cost.</li> <li>Alert n\u1ebfu <code>notif.sent.v1</code> FAIL &gt; 2 % trong 5 \u2032.</li> </ul> <p>Nh\u1edd Pub/Sub fan-out, DX-VAS g\u1eedi th\u00f4ng b\u00e1o m\u1ed9t l\u1ea7n \u1edf Core nh\u01b0ng b\u1ea3o \u0111\u1ea3m m\u1ed7i tenant x\u1eed l\u00fd &amp; tu\u1ef3 bi\u1ebfn ri\u00eang, \u0111\u1ed3ng th\u1eddi Master v\u1eabn n\u1eafm \u0111\u1ea7y \u0111\u1ee7 log &amp; KPI.</p>"},{"location":"architecture/system-diagrams/#5-so-o-trien-khai-ha-tang-deployment-diagram","title":"5. S\u01a1 \u0111\u1ed3 tri\u1ec3n khai h\u1ea1 t\u1ea7ng (Deployment Diagram)","text":"<p>Ph\u00e2n t\u00e1ch r\u00f5 hai bi\u00ean: Core Project \u2013 ch\u1ea1y duy nh\u1ea5t, chia s\u1ebb cho m\u1ecdi tenant; Tenant Project \u2013 nh\u00e2n b\u1ea3n cho t\u1eebng tr\u01b0\u1eddng, \u0111\u1ed9c l\u1eadp compute/giao th\u1ee9c m\u1ea1ng, ch\u1ec9 k\u1ebft n\u1ed1i qua API Gateway &amp; Pub/Sub.</p> <pre><code>flowchart TD\n%% ========= CORE PROJECT =========\n  subgraph Core[\ud83c\udfe2 GCP Project **dx-vas-core**]\n    direction TB\n    subgraph CoreVPC[\"\ud83d\udd10 VPC core (GKE)\"]\n      APIGW[\ud83d\udee1\ufe0f API GatewayEnvoy]\n      TokenSvc[\ud83d\udddd\ufe0f Token Service]\n      AuthM[\ud83d\udd10 Auth Master]\n      UserM[\ud83d\udc65 User Master]\n      NotifM[\ud83d\udce3 Notification Master]\n      ReportSvc[\ud83d\udcca Reporting Service]\n    end\n    RedisRev[(\ud83d\udd04 Redis Clusterrevoked_tokens)]\n    CloudSQL[(\ud83d\udc18 PostgreSQL\\nusers_global + audit)]\n    PubSubCore((\u2601\ufe0f Pub/Sub))\n    BQ[(\ud83d\udce6 BigQueryData Warehouse)]\n    SecretMgr[[\ud83d\udd11 Secret Manager]]\n  end\n\n%% ========= TENANT PROJECT (EXAMPLE) =========\n  subgraph TenantA[\ud83c\udfeb GCP Project **dx-vas-tenant-abc**]\n    direction TB\n    subgraph TenantVPC[\"\ud83d\udd10 VPC tenant (GKE)\"]\n      AuthSub[\ud83d\udd10 Auth Sub]\n      UserSub[\ud83d\udc64 User Sub]\n      NotifSub[\ud83d\udce5 Notif Sub]\n      SMS[\ud83c\udfeb SMSBackend]\n    end\n    SMSDB[(\ud83c\udf43 MariaDBGalera Cluster)]\n    RedisTenant[(\ud83d\udd04 Redis Local)]\n    PubSubTenant((\u2601\ufe0f Pub/Subsub-only))\n  end\n\n%% ========= TRAFFIC =========\n  %% Front-end\n  FE[\ud83c\udf10 Portals / Mobile]\n  FE -. https .-&gt; APIGW\n\n  %% Token flow\n  APIGW --&gt; TokenSvc\n  TokenSvc -- JWKS --&gt; APIGW\n  TokenSvc --&gt; RedisRev\n\n  %% Core services\n  APIGW ==&gt; AuthM\n  APIGW ==&gt; UserM\n  APIGW ==&gt; NotifM\n  APIGW ==&gt; ReportSvc\n\n  %% Pub/Sub fan-out\n  NotifM --\"notif.*\"--&gt; PubSubCore\n  UserM --\"user.*\"--&gt; PubSubCore\n  PubSubCore --\"filtered by tenant_id\"--&gt; PubSubTenant\n  PubSubTenant --\"events\"--&gt; NotifSub\n  PubSubTenant --\"events\"--&gt; UserSub\n\n  %% Tenant internal\n  APIGW ==&gt; AuthSub\n  APIGW ==&gt; UserSub\n  APIGW ==&gt; SMS\n  NotifSub --&gt; EmailSvc[[\u2709\ufe0f Email\\nGateway]]\n  NotifSub --&gt; SMSSvc[[\ud83d\udcf1 SMS\\nGateway]]\n\n  %% Data / ELT\n  SMS --&gt;|ELT| BQ\n\n  %% Secrets &amp; KV\n  TokenSvc --&gt; SecretMgr\n  AuthM --&gt; SecretMgr\n\n  %% VPC Peering\n  CoreVPC --- TenantVPC\n\n  %% Legend \u2013 External gateway node\n  ExtGW[[\u2709\ufe0f/\ud83d\udcf1 External Gateway]]\n\n  %% Legend\n  classDef edgeHttps stroke-dasharray: 5 3;\n  class FE edgeHttps;\n</code></pre> <p>Node ExtGW[[\u2709\ufe0f/\ud83d\udcf1 External Gateway]] hi\u1ec3n th\u1ecb bi\u1ec3u t\u01b0\u1ee3ng \u2709\ufe0f/\ud83d\udcf1, t\u01b0\u1ee3ng tr\u01b0ng cho c\u1ea3 Email Gateway v\u00e0 SMS Gateway. \u0110\u1eb7t trong ph\u1ea7n \u201cLegend\u201d gi\u00fap ng\u01b0\u1eddi \u0111\u1ecdc hi\u1ec3u nhanh \u00fd ngh\u0129a c\u1ee7a c\u00e1c n\u00fat EmailSvc v\u00e0 SMSSvc \u0111\u00e3 d\u00f9ng \u1edf Tenant stack.</p>"},{"location":"architecture/system-diagrams/#ghi-chu-chinh-sach","title":"\ud83d\udd11 Ghi ch\u00fa &amp; Ch\u00ednh s\u00e1ch","text":"Th\u00e0nh ph\u1ea7n SLA / SLO Autoscale API Gateway p95 &lt; 20 ms HPA RPS + CPU Token Service p95 &lt; 50 ms; availability 99.95 % HPA CPU Redis Cluster (core) hit \u2265 95 %; failover multi-AZ Manged Memorystore Pub/Sub fan-out latency &lt; 1 s Serverless Tenant GKE c\u00f4 l\u1eadp VPC; node-pool ri\u00eang HPA per tenant MariaDB Galera RPO = 0; RTO &lt; 5 min CloudSQL HA <ul> <li>CI/CD: Argo CD sync <code>core</code> &amp; <code>tenant</code> chart; Terraform Cloud d\u1ef1ng VPC, DB, Secret.</li> <li>VPC peering + firewall ch\u1ec9 m\u1edf c\u1ed5ng 443/mTLS; traffic gi\u1eefa tenant \u2194 core \u0111i qua API Gateway.</li> <li>Secret Manager l\u01b0u RSA key (<code>kid current|next</code>) &amp; SMTP creds; rotation \u2264 90 ng\u00e0y.</li> </ul> <p>K\u1ebft qu\u1ea3 \u2013 Ki\u1ebfn tr\u00fac t\u00e1ch b\u1ea1ch gi\u00fap m\u1edf r\u1ed9ng tenant m\u1edbi b\u1eb1ng m\u1ed9t c\u1ee5m GKE + MariaDB, kh\u00f4ng t\u00e1c \u0111\u1ed9ng Core, \u0111\u1ed3ng th\u1eddi Core duy tr\u00ec single-pane quan s\u00e1t &amp; b\u1ea3o m\u1eadt.</p>"},{"location":"architecture/system-diagrams/#6-vong-oi-tai-khoan-account-lifecycle","title":"6. V\u00f2ng \u0111\u1eddi T\u00e0i kho\u1ea3n (Account Lifecycle)","text":"<p>\u0110\u1ecbnh ngh\u0129a T\u00e0i kho\u1ea3n = b\u1ea3n ghi users_global (User Service Master) + (0\u2026n) b\u1ea3n ghi users_in_tenant. T\u00e0i kho\u1ea3n c\u00f3 th\u1ec3 s\u1ed1ng \u1edf nhi\u1ec1u tenant, \u0111\u00f3ng b\u0103ng (inactive) c\u1ee5c b\u1ed9 ho\u1eb7c to\u00e0n c\u1ee5c, \u0111\u01b0\u1ee3c \u1ea9n danh ho\u1eb7c xo\u00e1 v\u0129nh vi\u1ec5n theo ADR-024 &amp; ADR-026.</p>"},{"location":"architecture/system-diagrams/#61-luong-khoi-tao-create-first-login","title":"6.1 Lu\u1ed3ng kh\u1edfi t\u1ea1o (Create / First Login)","text":"<pre><code>sequenceDiagram\n    autonumber\n    participant FE       as \ud83c\udf10 Frontend\n    participant AuthM    as \ud83d\udd10 Auth Master\n    participant UserM    as \ud83d\udc65 User Master\n    participant UserSub  as \ud83e\udde9 User Sub\n    participant PubSub   as \u2601\ufe0f Pub/Sub\n\n    FE-&gt;&gt;AuthM: Login Google\n    AuthM-&gt;&gt;UserM: GET /users?email=&lt;&gt;\n    alt New user\n        UserM--&gt;&gt;AuthM: 404\n        AuthM-&gt;&gt;UserM: POST /users (create\\, provider)\n    else Exists\n        UserM--&gt;&gt;AuthM: user_id_global\n    end\n    AuthM-&gt;&gt;UserM: PUT /assign tenant_id\n    UserM--&gt;&gt;AuthM: 200 OK\n    UserM--&gt;&gt;PubSub: \ud83d\udd14 **user.created.v1** / **user.tenant_assigned.v1**\n    PubSub--&gt;&gt;UserSub: fan-out\n    UserSub-&gt;&gt;UserSub: UPSERT users_in_tenant\n</code></pre> <ul> <li>Provider: <code>google</code> / <code>local</code> / <code>otp</code> (l\u01b0u trong <code>auth_provider</code>).</li> <li>Event <code>user.created.v1</code> ch\u1ee9a <code>schema_version</code>, d\u00f9ng \u0111\u1ec3 seed tenant DB.</li> </ul>"},{"location":"architecture/system-diagrams/#62-kich-hoat-ngung-hoat-ong","title":"6.2 K\u00edch ho\u1ea1t / Ng\u01b0ng ho\u1ea1t \u0111\u1ed9ng","text":"Ph\u1ea1m vi API Tr\u1ea1ng th\u00e1i Event To\u00e0n c\u1ee5c <code>PATCH /users/{id} is_active=false</code> Kh\u00f3a \u0111\u0103ng nh\u1eadp m\u1ecdi tenant <code>user_status_changed.v1</code> C\u1ee5c b\u1ed9 (tenant) <code>PATCH /users/{id}?tenant_id=... is_active_in_tenant=false</code> Kh\u00f3a trong tenant hi\u1ec7n t\u1ea1i <code>user_status_changed.v1</code> <p>Gateway cache RBAC b\u1ecb xo\u00e1 khi nh\u1eadn event \\\u00a0s; token c\u0169 s\u1ebd b\u1ecb ch\u1eb7n n\u1ebfu user_inactive.</p>"},{"location":"architecture/system-diagrams/#63-cap-nhat-thong-tin-ho-so","title":"6.3 C\u1eadp nh\u1eadt th\u00f4ng tin h\u1ed3 s\u01a1","text":"<ul> <li>To\u00e0n c\u1ee5c: <code>PUT /users/{id}</code> \u2192 b\u1ea3ng <code>users_global</code>.</li> <li>C\u1ee5c b\u1ed9 : <code>PUT /users/{id}</code> + header <code>X-Tenant-ID</code> \u2192 b\u1ea3ng <code>users_in_tenant</code>.</li> <li>Ph\u00e1t event <code>user.profile_updated.v1</code>; ETL \u0111\u1ed3ng b\u1ed9 sang BigQuery.</li> </ul>"},{"location":"architecture/system-diagrams/#64-vong-oi-phien-session-ttl","title":"6.4 V\u00f2ng \u0111\u1eddi phi\u00ean (Session TTL)","text":"Lo\u1ea1i TTL L\u01b0u \u1edf Access token \u2264 15 \u2032 JWT claim <code>exp</code> Refresh token 14 ng\u00e0y b\u1ea3ng <code>auth_sessions</code> Force logout <code>/token/revoke sid=*</code> Xo\u00e1 Redis <code>revoked:{jti}</code>"},{"location":"architecture/system-diagrams/#65-an-danh-xoa-vinh-vien","title":"6.5 \u1ea8n danh &amp; Xo\u00e1 v\u0129nh vi\u1ec5n","text":"Pha Thao t\u00e1c Timeout ADR Soft Delete User self-delete \u2192 <code>is_active = false</code>, flag <code>delete_after = now+30d</code> 30 ng\u00e0y 026 Hard Delete Job <code>user_purge</code> xo\u00e1 b\u1ea3n ghi, \u0111\u1ed5i d\u1eef li\u1ec7u PII \u2192 hash \u2014 024 &amp; 026 <ul> <li>Audit log ghi \u201cuser purged\u201d k\u00e8m <code>gdpr_request_id</code>.</li> <li><code>user.deleted.v1</code> event b\u1eafn l\u00ean Pub/Sub \u2192 Tenant Sub nh\u1eadn &amp; purge b\u1ea3n ghi local.</li> </ul>"},{"location":"architecture/system-diagrams/#66-mapping-jwt-rbac-cache","title":"6.6 Mapping \u2192 JWT &amp; RBAC Cache","text":"Thu\u1ed9c t\u00ednh Ngu\u1ed3n Claim / Cache <code>user_id</code> users_global.user_id <code>sub</code> <code>tenant_id</code> header ch\u1ecdn tenant <code>tid</code> <code>roles / perms</code> JOIN UserSub Cache <code>rbac:{uid}:{tid}</code> 5-15 \u2032 <code>is_active</code> users_global Gateway ch\u1eb7n n\u1ebfu false <code>is_active_in_tenant</code> users_in_tenant Gateway ch\u1eb7n n\u1ebfu false"},{"location":"architecture/system-diagrams/#67-kpi-alert","title":"6.7 KPI &amp; Alert","text":"Metric M\u1ee5c ti\u00eau Alert <code>user_login_success_rate</code> &gt; 98 % tenant-avg &lt; 95 % 15\u2032 <code>user_purge_backlog</code> = 0 &gt; 0 ghi Jira <code>profile_update_latency_p95</code> &lt; 100 ms &gt; 200 ms <p>T\u00f3m t\u1eaft \u2013 V\u00f2ng \u0111\u1eddi t\u00e0i kho\u1ea3n \u0111\u01b0\u1ee3c qu\u1ea3n tr\u1ecb trung t\u00e2m nh\u01b0ng cho ph\u00e9p tenant t\u1ef1 do tu\u1ef3 ch\u1ec9nh RBAC, \u0111\u1ed3ng th\u1eddi tu\u00e2n th\u1ee7 GDPR v\u1ec1 xo\u00e1 v\u00e0 \u1ea9n danh d\u1eef li\u1ec7u.</p>"},{"location":"architecture/system-diagrams/#7-luong-ong-bo-rbac-tu-master-sub-user-services","title":"7. Lu\u1ed3ng \u0111\u1ed3ng b\u1ed9 RBAC t\u1eeb Master \u2192 Sub User Services","text":"<p>M\u1ee5c ti\u00eau \u2013 B\u1ea3o \u0111\u1ea3m Role / Permission lu\u00f4n \u0111\u1ed3ng nh\u1ea5t gi\u1eefa User Master v\u00e0 User Sub m\u00e0 v\u1eabn cho ph\u00e9p tenant t\u00f9y ch\u1ec9nh khi c\u1ea7n. C\u01a1 ch\u1ebf \u0111\u1ed3ng b\u1ed9 k\u1ebft h\u1ee3p s\u1ef1 ki\u1ec7n (event-driven) &amp; \u0111\u1ed3ng b\u1ed9 \u0111\u1ecbnh k\u1ef3 (cron sync), c\u00f3 ki\u1ec3m so\u00e1t schema_version (ADR-030).</p>"},{"location":"architecture/system-diagrams/#71-sequence-diagram-event-driven","title":"7.1 Sequence Diagram (Event-driven)","text":"<pre><code>sequenceDiagram\n    autonumber\n    participant Admin as \ud83c\udf9b\ufe0f Admin Portal (Core)\n    participant UserM as \ud83d\udc65 User Master\n    participant PubSub as \u2601\ufe0f Pub/Sub topic **rbac.v1**\n    participant UserSub as \ud83e\udde9 User Sub (tenant)\n    participant RedisRBAC as \ud83d\udd04 Redis rbac cache\n    participant APIGW as \ud83d\udee1\ufe0f API Gateway\n\n    Admin-&gt;&gt;UserM: POST /roles (create) \ud83d\udd16schema_version=2\n    UserM--&gt;&gt;PubSub: \ud83d\udd14 rbac_updated.v1 { tenant_id=\"*\", ... }\n    PubSub--&gt;&gt;UserSub: fan-out event (filter tenant_id)\n    UserSub-&gt;&gt;UserSub: UPSERT role / permission\n    UserSub--&gt;&gt;PubSub: \ud83d\udd14 rbac_updated_ack.v1\n    PubSub--&gt;&gt;UserM: ack\n\n    Note over APIGW,RedisRBAC: Gateway nh\u1eadn eventx\u00f3a cache rbac:{uid}:{tid}\n</code></pre>"},{"location":"architecture/system-diagrams/#72-su-kien-schema-adr-030","title":"7.2 S\u1ef1 ki\u1ec7n &amp; Schema (ADR-030)","text":"Event Khi n\u00e0o ph\u00e1t Payload ch\u00ednh Ghi ch\u00fa <code>rbac_updated.v1</code> Master thay \u0111\u1ed5i / t\u1ea1o m\u1edbi role, permission <code>tenant_id</code> (<code>*</code> = all), <code>schema_version</code>, <code>diff[]</code> Fan-out t\u1edbi tenant Sub <code>rbac_updated_ack.v1</code> Sub x\u1eed l\u00fd xong diff <code>tenant_id</code>, <code>applied_version</code> Cho Master tracking <code>rbac_template_synced.v1</code> Job sync \u0111\u1ecbnh k\u1ef3 <code>tenant_id</code>, <code>from_version</code>, <code>to_version</code> Ch\u1ec9 khi tenant d\u00f9ng template \u201cinherit\u201d <p>JSON Schema ID l\u01b0u trong Schema Registry, backward-compat \u2265 6 th\u00e1ng.</p>"},{"location":"architecture/system-diagrams/#73-ong-bo-inh-ky-cron-sync","title":"7.3 \u0110\u1ed3ng b\u1ed9 \u0111\u1ecbnh k\u1ef3 (Cron Sync)","text":"Chu k\u1ef3 Trigger \u0110i\u1ec1u ki\u1ec7n ch\u1ea1y H\u00e0nh \u0111\u1ed9ng <code>weekly</code> (default) Cloud Scheduler \u2192 Cloud Run <code>sync-job</code> Tenant c\u00f3 <code>sync_mode=inherit</code> So s\u00e1nh <code>schema_version</code>; publish <code>rbac_template_synced.v1</code> n\u1ebfu kh\u00e1c <code>manual</code> Tenant Admin \u2192 \u201cSync Now\u201d \u2014 G\u1ecdi th\u1eb3ng User Master <code>POST /templates/sync</code> <p>N\u1ebfu tenant \u0111\u00e3 clone template, job ghi log <code>status=forked</code> \u2013 kh\u00f4ng ghi \u0111\u00e8.</p>"},{"location":"architecture/system-diagrams/#74-xu-ly-conflict","title":"7.4 X\u1eed l\u00fd conflict","text":"<p>Conflict = <code>permission_code</code> tr\u00f9ng nh\u01b0ng <code>schema_version</code> kh\u00e1c.</p> <ol> <li>Job <code>sync-job</code> ph\u00e1t hi\u1ec7n \u2192 flag <code>conflict=true</code>, publish <code>rbac_conflict_detected.v1</code>.</li> <li>Tenant nh\u1eadn s\u1ef1 ki\u1ec7n, hi\u1ec3n th\u1ecb banner \u201cRBAC template out-of-date\u201d.</li> <li>Admin tenant c\u00f3 30 ng\u00e0y \u0111\u1ec3 merge / bump version, n\u1ebfu kh\u00f4ng h\u1ec7 th\u1ed1ng s\u1ebd t\u1ef1 \u0111\u1ed9ng lock quy\u1ec1n m\u1edbi (deny by default).</li> </ol>"},{"location":"architecture/system-diagrams/#75-cap-nhat-cache-gateway","title":"7.5 C\u1eadp nh\u1eadt cache &amp; Gateway","text":"<ul> <li>Gateway subscribe <code>rbac_updated.v1</code>, <code>rbac_template_synced.v1</code>, <code>rbac_conflict_detected.v1</code>.</li> <li>Khi s\u1ef1 ki\u1ec7n t\u1edbi: xo\u00e1 <code>rbac:{user_id}:{tenant_id}</code> &amp; <code>revoked:{jti}</code> (n\u1ebfu c\u1ea7n).</li> <li>Metric <code>rbac_cache_invalidate_count</code> t\u0103ng; latency invalidate m\u1ee5c ti\u00eau &lt; 1 s.</li> </ul>"},{"location":"architecture/system-diagrams/#76-kpi-alert","title":"7.6 KPI &amp; Alert","text":"Metric Target Alert <code>rbac_sync_success_rate</code> 100 % b\u1ea5t k\u1ef3 l\u1ed7i <code>rbac_template_age_days</code> &lt; 30 d (inherit) &gt; 45 d <code>rbac_conflict_count</code> 0 &gt; 0 t\u1ea1o Jira <code>sync_job_duration_p95</code> &lt; 60 s &gt; 120 s <p>K\u1ebft qu\u1ea3 \u2013 Tenant lu\u00f4n c\u00f3 RBAC m\u1edbi trong v\u00f2ng 1 gi\u00e2y sau khi Master thay \u0111\u1ed5i, trong khi v\u1eabn c\u00f3 quy\u1ec1n t\u1ef1 ch\u1ee7 v\u1edbi template \u0111\u00e3 clone.</p>"},{"location":"architecture/system-diagrams/#8-phan-quyen-giao-dien-nguoi-dung-ui-role-mapping","title":"8. Ph\u00e2n quy\u1ec1n Giao di\u1ec7n Ng\u01b0\u1eddi D\u00f9ng (UI Role Mapping)","text":"<p>M\u1ee5c ti\u00eau \u2013 Li\u00ean k\u1ebft Role / Permission (RBAC) v\u1edbi t\u00ednh n\u0103ng c\u1ee5 th\u1ec3 tr\u00ean b\u1ed1n c\u1ed5ng Admin \u00b7 Teacher \u00b7 Student \u00b7 Parent, gi\u00fap \u0111\u1ed9i frontend hi\u1ec3n th\u1ecb/\u1ea9n n\u00fat v\u00e0 ki\u1ec3m tra quy\u1ec1n th\u1ed1ng nh\u1ea5t gi\u1eefa UI &amp; Gateway.</p>"},{"location":"architecture/system-diagrams/#81-ma-tran-portal-vai-tro-chuan","title":"8.1 Ma tr\u1eadn Portal \u2192 Vai tr\u00f2 Chu\u1ea9n","text":"Portal Role m\u1eb7c \u0111\u1ecbnh (<code>role_code</code>) \u0110\u1ed1i t\u01b0\u1ee3ng Admin Portal <code>admin.super</code>, <code>admin.finance</code>, <code>admin.academic</code> Qu\u1ea3n tr\u1ecb tr\u01b0\u1eddng Teacher Portal <code>teacher.homeroom</code>, <code>teacher.subject</code> Gi\u00e1o vi\u00ean Student Portal <code>student.default</code> H\u1ecdc sinh Parent Portal <code>parent.default</code> Ph\u1ee5 huynh <p>Tenant c\u00f3 th\u1ec3 clone v\u00e0 \u0111\u1ed5i t\u00ean role; <code>schema_version</code> t\u0103ng l\u00ean khi s\u1eeda.</p>"},{"location":"architecture/system-diagrams/#82-mapping-ui-permission","title":"8.2 Mapping UI \u2192 Permission","text":"Khu v\u1ef1c UI H\u00e0nh \u0111\u1ed9ng Permission y\u00eau c\u1ea7u (<code>permission_code</code>) Dashboard Xem b\u00e1o c\u00e1o \u0111\u0103ng nh\u1eadp <code>report.view_login_by_tenant</code> Finance Xem b\u00e1o c\u00e1o t\u00e0i ch\u00ednh <code>report.view_financial_summary</code> Gradebook S\u1eeda \u0111i\u1ec3m <code>grade.edit_assignment</code> (teacher) Attendance \u0110i\u1ec3m danh <code>attendance.mark</code> User Management G\u00e1n role <code>rbac.manage_role</code> Settings \u0110\u1ed3ng b\u1ed9 RBAC template <code>rbac.sync_template</code> SMS Broadcast G\u1eedi SMS h\u00e0ng lo\u1ea1t <code>notif.broadcast_sms</code> <p>UI component \u0111\u1ecdc JWT claim <code>permissions</code> (\u0111\u00e3 t\u1ed1i \u01b0u b\u1edfi Gateway cache), \u1ea9n n\u00fat n\u1ebfu kh\u00f4ng \u0111\u1ee7 quy\u1ec1n.</p>"},{"location":"architecture/system-diagrams/#83-kiem-tra-quyen-frontend","title":"8.3 Ki\u1ec3m tra quy\u1ec1n (Frontend)","text":"<pre><code>// React helper\nimport { useAuth } from \"@/hooks/useAuth\";\n\nexport function Can({ perm, children }) {\n  const { permissions } = useAuth();          // l\u1ea5y t\u1eeb JWT decode\n  if (permissions.includes(perm)) return children;\n  return null;                                // \u1ea9n UI n\u1ebfu thi\u1ebfu quy\u1ec1n\n}\n</code></pre> <p>\u00c1p d\u1ee5ng pattern n\u00e0y cho button/menu t\u1eebng portal; tr\u00e1nh \u201chard-code\u201d role.</p>"},{"location":"architecture/system-diagrams/#84-dynamic-condition","title":"8.4 Dynamic Condition","text":"<ul> <li>V\u1edbi permission c\u00f3 <code>condition</code>, FE g\u1edfi <code>input_parameters</code> \u0111\u00fang schema:</li> </ul> <pre><code>{ \"class_id\": \"10A1\" }\n</code></pre> <ul> <li>Gateway s\u1ebd so s\u00e1nh <code>$request.class_id</code> vs <code>$user.class_id</code>; FE kh\u00f4ng c\u1ea7n logic ph\u1ee5.</li> </ul>"},{"location":"architecture/system-diagrams/#85-quy-trinh-them-tinh-nang-moi","title":"8.5 Quy tr\u00ecnh th\u00eam t\u00ednh n\u0103ng m\u1edbi","text":"<ol> <li>FE m\u1edf PR t\u1ea1o UI + flag <code>TODO_PERMISSION</code>.</li> <li>BE th\u00eam permission v\u00e0o <code>global_permissions_templates</code> (<code>schema_version+1</code>).</li> <li>RBAC Sync Job fan-out <code>rbac_updated.v1</code>; FE l\u1ea5y JWT m\u1edbi \u2192 ch\u1ee9c n\u0103ng hi\u1ec3n th\u1ecb.</li> <li>Th\u00eam entry m\u1edbi v\u00e0o b\u1ea3ng 8.2 trong t\u00e0i li\u1ec7u n\u00e0y.</li> </ol>"},{"location":"architecture/system-diagrams/#86-kpi-ui-authorization","title":"8.6 KPI UI Authorization","text":"Metric Target <code>ui_unauthorized_click_rate</code> &lt; 0.1 % <code>jwt_permissions_payload_size</code> \u2264 4 KB <p>K\u1ebft qu\u1ea3 \u2013 Ph\u00e2n quy\u1ec1n UI l\u1ec7 thu\u1ed9c \u0111\u00fang v\u00e0o Permission (kh\u00f4ng ph\u1ea3i Role c\u1ee9ng), cho ph\u00e9p tenant thay \u0111\u1ed5i Role m\u00e0 kh\u00f4ng ph\u1ea3i s\u1eeda Frontend.</p>"},{"location":"architecture/system-diagrams/#9-he-thong-bao-cao-phan-tich-reporting-analytics-architecture","title":"9. H\u1ec7 th\u1ed1ng B\u00e1o c\u00e1o &amp; Ph\u00e2n t\u00edch (Reporting &amp; Analytics Architecture)","text":"<p>M\u1ee5c ti\u00eau \u2013 Cung c\u1ea5p b\u00e1o c\u00e1o g\u1ea7n real-time, t\u00e1ch bi\u1ec7t d\u1eef li\u1ec7u \u0111a-tenant, cho ph\u00e9p ph\u00e2n quy\u1ec1n chi ti\u1ebft (row-level) d\u1ef1a tr\u00ean RBAC v\u00e0 <code>condition</code> c\u1ee7a permission. Ki\u1ebfn tr\u00fac tu\u00e2n th\u1ee7 <code>ADR-028 \u2013 Reporting Architecture</code>, <code>ADR-029 \u2013 Report Template Schema</code>, <code>ADR-030 \u2013 Event Schema Governance</code>.</p>"},{"location":"architecture/system-diagrams/#91-luong-du-lieu-tong-quat","title":"9.1 Lu\u1ed3ng d\u1eef li\u1ec7u t\u1ed5ng qu\u00e1t","text":"<pre><code>flowchart LR\n  SMS((\ud83d\udcda SMSMariaDB))\n  Debezium([\u2699\ufe0f Debezium CDC])\n  DataLake[(\ud83d\udcbe GCS Parquet Staging)]\n  DataFlow([\ud83d\udee0\ufe0f DataflowELT Transform])\n  BQ[\ud83d\udce6 BigQueryData Warehouse]\n  ReportSvc([\ud83d\udcca Reporting Service])\n  APIGW(\ud83d\udee1\ufe0f API Gateway)\n  FE[\ud83c\udf10 Superadmin Portal]\n\n  SMS --&gt; Debezium --&gt; DataLake --&gt; DataFlow --&gt; BQ\n  ReportSvc ==&gt; BQ\n  FE -. https .-&gt; APIGW ==&gt; ReportSvc\n</code></pre> <ul> <li>CDC Debezium stream \u2192 GCS (parquet) &lt; 1 min lag.</li> <li>Dataflow load &amp; transform \u279c BQ Raw \u2192 Staging \u2192 Mart (Kimball).</li> <li>Reporting Service ch\u1ea1y query tham s\u1ed1 ho\u00e1, th\u00eam <code>tenant_id</code> &amp; RBAC filters.</li> <li>Superadmin Portal t\u1ea3i b\u00e1o c\u00e1o qua Gateway (JWT + permission ki\u1ec3m tra).</li> </ul>"},{"location":"architecture/system-diagrams/#92-kien-truc-data-warehouse-bigquery","title":"9.2 Ki\u1ebfn tr\u00fac Data Warehouse (BigQuery)","text":"Layer V\u00ed d\u1ee5 b\u1ea3ng Partition / Cluster B\u1ea3o m\u1eadt Raw <code>abc_sms_enrolment_raw</code> <code>_PARTITIONDATE</code> IAM: read-only Staging <code>abc_sms_enrolment_stg</code> <code>_PARTITIONDATE</code> \u2014 Mart <code>fct_enrolment</code> \u00b7 <code>dim_student</code> cluster <code>tenant_id</code> Row ACL by <code>tenant_id</code> Reporting View <code>vw_financial_summary</code> \u2014 Authorized View per tenant <p>Retention: Raw 30 ng\u00e0y, Mart 5 n\u0103m (\u1ea9n danh PII theo ADR-024).</p>"},{"location":"architecture/system-diagrams/#93-rbac-row-level-security","title":"9.3 RBAC &amp; Row-Level Security","text":"C\u1ea5p truy c\u1eadp \u0110i\u1ec1u ki\u1ec7n SQL Permission y\u00eau c\u1ea7u Tenant <code>WHERE tenant_id = $tid</code> <code>report.view_financial_summary</code> Class <code>WHERE class_id = $user.class_id</code> <code>report.view_login_by_tenant</code> + condition Global Kh\u00f4ng filter <code>report.view_financial_summary</code> + role <code>admin.super</code> <p>Gateway g\u1eafn <code>tenant_id</code>, <code>roles</code>, <code>permissions</code> v\u00e0o header; Reporting Service d\u1ef1ng c\u00e2u l\u1ec7nh SQL v\u1edbi parameterized filters \u2192 tr\u00e1nh SQL-Injection.</p>"},{"location":"architecture/system-diagrams/#94-template-export","title":"9.4 Template &amp; Export","text":"<ul> <li>T\u1ea5t c\u1ea3 template JSON schema l\u01b0u <code>report_templates</code> (version-controlled).</li> <li> <p>API:</p> </li> <li> <p><code>GET /reports/{id}</code> \u2013 metadata &amp; required params.</p> </li> <li><code>POST /reports/{id}/export</code> \u2013 CSV / Parquet; header <code>Content-Disposition</code>.</li> <li>Quy\u1ec1n <code>report.manage_report_templates</code> cho ph\u00e9p admin tenant s\u1eeda template clone.</li> </ul>"},{"location":"architecture/system-diagrams/#95-giam-sat-chi-phi-hieu-suat","title":"9.5 Gi\u00e1m s\u00e1t chi ph\u00ed &amp; Hi\u1ec7u su\u1ea5t","text":"KPI M\u1ee5c ti\u00eau Alert <code>bq_query_latency_p95</code> &lt; 5 s &gt; 10 s 5\u2032 <code>bq_cost_per_tenant_day</code> +\u2264 15 % 30 d-avg Slack FinOps <code>elt_lag_minutes_p95</code> &lt; 10\u2032 &gt; 20\u2032 15\u2032"},{"location":"architecture/system-diagrams/#96-so-o-quyen-truy-cap-bao-cao","title":"9.6 S\u01a1 \u0111\u1ed3 quy\u1ec1n truy c\u1eadp b\u00e1o c\u00e1o","text":"<pre><code>stateDiagram-v2\n  [*] --&gt; RequestAPI\n  RequestAPI --&gt;|JWT valid + permission| BuildQuery\n  BuildQuery --&gt; ExecuteBQ\n  ExecuteBQ --&gt; ExportFile\n  ExportFile --&gt; [*]\n  RequestAPI --&gt;|No permission| Forbidden\n  Forbidden --&gt; [*]\n</code></pre>"},{"location":"architecture/system-diagrams/#97-roadmap-mo-rong","title":"9.7 Roadmap m\u1edf r\u1ed9ng","text":"<ol> <li>Materialized View cho b\u00e1o c\u00e1o th\u1eddi gian th\u1ef1c attendance (latency &lt; 30 s).</li> <li>Pre-computed cube (BigQuery BI Engine) cho dashboard hi\u1ec7u n\u0103ng cao.</li> <li>Tenant self-service chart builder \u2013 drag-and-drop, d\u00f9ng row ACL \u0111\u00e3 s\u1eb5n.</li> </ol> <p>K\u1ebft qu\u1ea3 \u2013 B\u00e1o c\u00e1o ph\u00e2n t\u00e1ch theo tenant, c\u00f3 th\u1ec3 tu\u1ef3 bi\u1ebfn \u0111i\u1ec1u ki\u1ec7n truy c\u1eadp (row-level), trong khi chi ph\u00ed v\u00e0 \u0111\u1ed9 tr\u1ec5 \u0111\u01b0\u1ee3c ki\u1ec3m so\u00e1t ch\u1eb7t ch\u1ebd.</p>"},{"location":"architecture/system-diagrams/#10-ai-integration-strategy","title":"10. AI Integration Strategy","text":"<p>M\u1ee5c ti\u00eau \u2013 \u1ee8ng d\u1ee5ng AI \u0111\u1ec3 n\u00e2ng cao tr\u1ea3i nghi\u1ec7m (chat-support, g\u1ee3i \u00fd h\u1ecdc t\u1eadp), t\u1ed1i \u01b0u v\u1eadn h\u00e0nh (d\u1ef1 b\u00e1o l\u1ed7i, chi ph\u00ed) v\u00e0 m\u1edf r\u1ed9ng s\u1ea3n ph\u1ea9m (ph\u00e2n t\u00edch d\u1eef li\u1ec7u h\u1ecdc t\u1eadp). Chi\u1ebfn l\u01b0\u1ee3c b\u00e1m theo 4 tr\u1ee5: (1) Use-case r\u00f5 r\u00e0ng \u2192 (2) Data foundation s\u1ea1ch \u2192 (3) Model lifecycle c\u00f3 ki\u1ec3m so\u00e1t \u2192 (4) Tu\u00e2n th\u1ee7 b\u1ea3o m\u1eadt/\u0111\u1ea1o \u0111\u1ee9c.</p>"},{"location":"architecture/system-diagrams/#101-use-case-uu-tien-2025-2026","title":"10.1 Use-case \u01afu ti\u00ean (2025-2026)","text":"Use-case M\u00f4 t\u1ea3 M\u00f4 h\u00ecnh / API AI Chat Support Chatbot h\u1ed7 tr\u1ee3 gi\u00e1o vi\u00ean &amp; ph\u1ee5 huynh (FAQ, h\u01b0\u1edbng d\u1eabn) LLM (Vertex AI PaLM 2-Text, context Knowledge-Graph) Homework Feedback G\u1ee3i \u00fd s\u1eeda c\u00e2u / gi\u1ea3i chi ti\u1ebft cho h\u1ecdc sinh LLM + Prompt-engineering + Guardrails Attendance Anomaly D\u1ef1 b\u00e1o v\u1eafng m\u1eb7t b\u1ea5t th\u01b0\u1eddng LSTM tim-series (BigQuery ML) Cost Forecast D\u1ef1 \u0111o\u00e1n chi ph\u00ed GCP/tenant th\u00e1ng t\u1edbi Prophet ARIMA Incident Triage Ph\u00e2n lo\u1ea1i log l\u1ed7i \u2192 g\u1ee3i \u00fd fix Embedding + kNN (Vector Search)"},{"location":"architecture/system-diagrams/#102-kien-truc-trien-khai","title":"10.2 Ki\u1ebfn tr\u00fac tri\u1ec3n khai","text":"<pre><code>flowchart LR\n  subgraph Core_AI [\"\ud83e\udd16 AI Core Services\"]\n    AIAPI[(AI Inference APICloud Run)]\n    VectorDB[(Vertex AI VectorStore)]\n    FeatureStore[(Feature Store)]\n  end\n\n  subgraph DataPlane\n    BQ[(BigQuery DW)]\n    PubSub((Pub/Sub events))\n  end\n\n  FE[\ud83c\udf10 Frontend / Portal] -. gRPC/REST .-&gt; AIAPI\n  BQ -- batch --&gt; FeatureStore\n  PubSub -- stream --&gt; FeatureStore\n  AIAPI -- embed --&gt; VectorDB\n  AIAPI -- fetch feature --&gt; FeatureStore\n  AIAPI -. call .-&gt; VertexLLM[[Vertex AIPaLM 2]]\n</code></pre>"},{"location":"architecture/system-diagrams/#103-model-lifecycle","title":"10.3 Model Lifecycle","text":"Giai \u0111o\u1ea1n C\u00f4ng c\u1ee5 Quy tr\u00ecnh Experiment Vertex AI Workbench + AutoML Data Scientist ch\u1ea1y notebook; metadata log ML Metadata Train Vertex AI Training Output <code>model-artifact:hash</code> k\u00e8m <code>schema_version</code> Validate CI job <code>ml-test</code> Accuracy \u2265 KPI; bias test; security scan prompt-injection Deploy Cloud Run (CPU) / GPU endpoint Blue-Green 5\u219250\u2192100 % Monitor Vertex AI Model Monitoring + Prometheus Drift, latency, cost, PII leakage alert <p>Governance: PR ph\u1ea3i k\u00e8m Model Card (YAML) \u2192 review AI Guild.</p>"},{"location":"architecture/system-diagrams/#104-bao-mat-ao-uc","title":"10.4 B\u1ea3o m\u1eadt &amp; \u0110\u1ea1o \u0111\u1ee9c","text":"<ul> <li>PII Masking tr\u01b0\u1edbc khi g\u1eedi prompt t\u1edbi LLM (<code>email</code>, <code>phone</code>, <code>student_name</code>).</li> <li>Prompt Firewall \u2013 regex + model-guard kh\u00f4ng tr\u1ea3 l\u1eddi n\u1ed9i dung c\u1ea5m (Cheating, PII).</li> <li>Opt-in: H\u1ecdc sinh &lt; 16 tu\u1ed5i y\u00eau c\u1ea7u ph\u1ee5 huynh \u0111\u1ed3ng \u00fd.</li> <li>Data Residency: Ch\u1ec9 l\u01b0u embedding \u1edf <code>us-central1</code> (GDPR SCC).</li> </ul>"},{"location":"architecture/system-diagrams/#105-kpi-giam-sat","title":"10.5 KPI &amp; Gi\u00e1m s\u00e1t","text":"Metric Target Alert <code>ai_inference_latency_p95</code> &lt; 800 ms &gt; 1200 ms 5\u2032 <code>chatbot_answer_helpful_rate</code> (thumb-up) &gt; 85 % &lt; 70 % ng\u00e0y <code>model_drift_score</code> &lt; 0.1 &gt; 0.2 tu\u1ea7n <code>cost_ai_per_1000req</code> \u2264 0.02 USD &gt; 0.03 USD ng\u00e0y"},{"location":"architecture/system-diagrams/#106-roadmap","title":"10.6 Roadmap","text":"<ol> <li>Q3-2025 \u2013 Chat Support Alpha (English \u2192 Vietnamese).</li> <li>Q4-2025 \u2013 Homework Feedback Pilot \u1edf 2 tenant Premium.</li> <li>Q1-2026 \u2013 Full Cost Forecast + Incident Triage.</li> <li>Q2-2026 \u2013 Fine-tune mini-LLM on-prem (5-7 B params) n\u1ebfu ROI \u0111\u1ea1t.</li> </ol> <p>Th\u00f4ng \u0111i\u1ec7p ch\u1ee7 \u0111\u1ea1o: AI ch\u1ec9 h\u1eefu \u00edch khi t\u00edch h\u1ee3p m\u01b0\u1ee3t v\u00e0o lu\u1ed3ng d\u1eef li\u1ec7u &amp; b\u1ea3o m\u1eadt s\u1eb5n c\u00f3; DX-VAS l\u1ea5y data quality + governance l\u00e0m tr\u1ecdng t\u00e2m tr\u01b0\u1edbc khi \u201cb\u01a1m\u201d m\u00f4 h\u00ecnh v\u00e0o s\u1ea3n ph\u1ea9m.</p> <p>\ud83d\udccc Ghi ch\u00fa:</p> <ul> <li><code>DataAccessAPI</code> l\u00e0 l\u1edbp tr\u1eebu t\u01b0\u1ee3ng (c\u00f3 th\u1ec3 d\u00f9ng \u0111\u1ec3 chu\u1ea9n b\u1ecb d\u1eef li\u1ec7u cho training ho\u1eb7c inference)</li> <li><code>MetadataRegistry</code> t\u01b0\u01a1ng \u1ee9ng v\u1edbi qu\u1ea3n tr\u1ecb schema theo <code>ADR-030</code></li> <li>M\u1ed7i AI Agent c\u00f3 m\u1ee5c ti\u00eau ri\u00eang (h\u1ed7 tr\u1ee3, t\u1ed5ng h\u1ee3p, d\u1ef1 \u0111o\u00e1n) v\u00e0 c\u00f3 th\u1ec3 t\u00e1i s\u1eed d\u1ee5ng query/template t\u1eeb Reporting Service</li> </ul> <p>\ud83d\udcd8 Ghi ch\u00fa:</p> <ul> <li>UI kh\u00f4ng n\u00ean hard-code role, m\u00e0 n\u00ean ki\u1ec3m tra theo permission c\u1ee5 th\u1ec3 (VD: <code>can_assign_role</code>, <code>can_view_tuition</code>)</li> <li>C\u00e1c permission n\u00e0y \u0111\u01b0\u1ee3c Gateway tr\u1ea3 v\u1ec1 trong JWT ho\u1eb7c refresh qua API <code>GET /me/permissions</code></li> <li>Vi\u1ec7c ki\u1ec3m tra quy\u1ec1n c\u00f3 th\u1ec3 d\u00f9ng Hook/Vuex/Redux trung t\u00e2m t\u1ea1i frontend \u0111\u1ec3 g\u1eafn c\u1edd <code>canAccess[X]</code></li> </ul> <p>\ud83d\udcce Li\u00ean quan:</p> <ul> <li>RBAC Deep Dive</li> <li>README</li> </ul>"},{"location":"dev-guide/","title":"\ud83d\udee0\ufe0f H\u01b0\u1edbng d\u1eabn Ph\u00e1t tri\u1ec3n (Developer Guide) - D\u1ef1 \u00e1n DX-VAS","text":"<p>Ch\u00e0o m\u1eebng \u0111\u1ebfn v\u1edbi d\u1ef1 \u00e1n DX-VAS!</p> <p>T\u00e0i li\u1ec7u n\u00e0y l\u00e0 \"ngu\u1ed3n ch\u00e2n l\u00fd\" d\u00e0nh cho t\u1ea5t c\u1ea3 c\u00e1c l\u1eadp tr\u00ecnh vi\u00ean khi tham gia ph\u00e1t tri\u1ec3n h\u1ec7 th\u1ed1ng. M\u1ee5c ti\u00eau c\u1ee7a b\u1ed9 h\u01b0\u1edbng d\u1eabn n\u00e0y l\u00e0 \u0111\u1ea3m b\u1ea3o ch\u00fang ta x\u00e2y d\u1ef1ng n\u00ean m\u1ed9t s\u1ea3n ph\u1ea9m c\u00f3 ch\u1ea5t l\u01b0\u1ee3ng cao, nh\u1ea5t qu\u00e1n, d\u1ec5 b\u1ea3o tr\u00ec v\u00e0 c\u00f3 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng.</p> <p>M\u1ecdi th\u00e0nh vi\u00ean, d\u00f9 l\u00e0 t\u1eeb \u0111\u1ed9i ng\u0169 DX-VAS hay t\u1eeb \u0111\u1ed1i t\u00e1c Ho\u00e0ng V\u0169, \u0111\u1ec1u ph\u1ea3i tu\u00e2n th\u1ee7 c\u00e1c quy t\u1eafc v\u00e0 h\u01b0\u1edbng d\u1eabn \u0111\u01b0\u1ee3c n\u00eau trong \u0111\u00e2y.</p> <p>\"Code gi\u1ecfi kh\u00f4ng ch\u1ec9 l\u00e0 vi\u1ebft cho m\u00e1y hi\u1ec3u, m\u00e0 c\u00f2n l\u00e0 vi\u1ebft cho nh\u1eefng ng\u01b0\u1eddi s\u1ebd k\u1ebf th\u1eeba v\u00e0 ph\u00e1t tri\u1ec3n n\u00f3 trong 5 n\u0103m t\u1edbi.\" - Stephen Le</p>"},{"location":"dev-guide/#muc-luc","title":"\ud83d\udcda M\u1ee5c l\u1ee5c","text":"<p>C\u00e2y th\u01b0 m\u1ee5c <pre><code>/docs\n|-- ... (ADR, architecture, etc.)\n|-- /dev-guide/\n|   |-- README.md\n|   |-- 01-getting-started.md\n|   |-- 02-core-principles.md\n|   |-- 03-workflow-and-process.md\n|   |-- /technical-guides/\n|   |   |-- 04-api-development.md\n|   |   |-- 05-database-and-migrations.md\n|   |   |-- 06-event-driven-development.md\n|   |   |-- 07-logging-and-tracing.md\n|   |   |-- 08-error-handling.md\n|   |   |-- 09-configuration-and-secrets.md\n|   |-- /specialized-guides/\n|   |   |-- 10-frontend-guide.md\n|   |-- /quality-and-operations/\n|   |   |-- 11-testing-guide.md\n|   |   |-- 12-security-checklist.md\n|   |   |-- 13-ci-cd-pipeline.md\n|   |   |-- 14-debugging-guide.md\n|   |   |-- 15-troubleshooting-guide.md\n|   |   |-- 16-incident-response.md\n|   |   |-- 17-release-versioning.md\n|   |-- /productivity-and-tools/\n|   |   |-- 18-local-dev-productivity.md\n|   |   |-- 19-tooling-cheatsheet.md\n|-- /process/\n|   |-- ONBOARDING.md\n|   |-- OFFBOARDING.md\n|\n|-- CONTRIBUTING.md\n|-- README.md\n...\n</code></pre></p>"},{"location":"dev-guide/#phan-1-nen-tang-quy-trinh-foundation-process","title":"Ph\u1ea7n 1: N\u1ec1n t\u1ea3ng &amp; Quy tr\u00ecnh (Foundation &amp; Process)","text":"<p>\u0110\u00e2y l\u00e0 nh\u1eefng t\u00e0i li\u1ec7u b\u1eaft bu\u1ed9c ph\u1ea3i \u0111\u1ecdc \u0111\u1ed1i v\u1edbi m\u1ecdi th\u00e0nh vi\u00ean m\u1edbi.</p> <ol> <li>01 - Getting Started: H\u01b0\u1edbng d\u1eabn c\u00e0i \u0111\u1eb7t m\u00f4i tr\u01b0\u1eddng v\u00e0 ch\u1ea1y d\u1ef1 \u00e1n.</li> <li>02 - Core Principles: C\u00e1c nguy\u00ean t\u1eafc v\u00e0ng v\u00e0 t\u01b0 duy ki\u1ebfn tr\u00fac c\u1ea7n tu\u00e2n th\u1ee7.</li> <li>03 - Workflow &amp; Process: Quy tr\u00ecnh l\u00e0m vi\u1ec7c v\u1edbi Git, Pull Request.</li> </ol>"},{"location":"dev-guide/#phan-2-huong-dan-ky-thuat-cot-loi-core-technical-guides","title":"Ph\u1ea7n 2: H\u01b0\u1edbng d\u1eabn K\u1ef9 thu\u1eadt C\u1ed1t l\u00f5i (Core Technical Guides)","text":"<p>\u0110\u00e2y l\u00e0 c\u00e1c \"b\u1ed9 lu\u1eadt\" chi ti\u1ebft cho vi\u1ec7c ph\u00e1t tri\u1ec3n backend service.</p> <ul> <li>04 - API Development: C\u00e1ch thi\u1ebft k\u1ebf v\u00e0 tri\u1ec3n khai API.</li> <li>05 - Database &amp; Migrations: Quy tr\u00ecnh l\u00e0m vi\u1ec7c v\u1edbi CSDL v\u00e0 schema migration.</li> <li>06 - Event-Driven Development: C\u00e1ch ph\u00e1t v\u00e0 ti\u00eau th\u1ee5 s\u1ef1 ki\u1ec7n qua Pub/Sub.</li> <li>07 - Logging &amp; Tracing: Quy chu\u1ea9n v\u1ec1 ghi log v\u00e0 truy v\u1ebft.</li> <li>08 - Error Handling: C\u00e1ch x\u1eed l\u00fd v\u00e0 tr\u1ea3 v\u1ec1 l\u1ed7i.</li> <li>09 - Configuration &amp; Secrets: C\u00e1ch qu\u1ea3n l\u00fd c\u1ea5u h\u00ecnh v\u00e0 bi\u1ebfn m\u00f4i tr\u01b0\u1eddng.</li> </ul>"},{"location":"dev-guide/#phan-3-huong-dan-chuyen-biet-specialized-guides","title":"Ph\u1ea7n 3: H\u01b0\u1edbng d\u1eabn Chuy\u00ean bi\u1ec7t (Specialized Guides)","text":"<p>C\u00e1c h\u01b0\u1edbng d\u1eabn d\u00e0nh cho c\u00e1c l\u0129nh v\u1ef1c ph\u00e1t tri\u1ec3n c\u1ee5 th\u1ec3.</p> <ul> <li>10 - Frontend Development Guide: C\u00e1c quy \u01b0\u1edbc ri\u00eang cho vi\u1ec7c ph\u00e1t tri\u1ec3n Frontend.</li> </ul>"},{"location":"dev-guide/#phan-4-am-bao-chat-luong-van-hanh-quality-operations","title":"Ph\u1ea7n 4: \u0110\u1ea3m b\u1ea3o Ch\u1ea5t l\u01b0\u1ee3ng &amp; V\u1eadn h\u00e0nh (Quality &amp; Operations)","text":"<p>C\u00e1c quy tr\u00ecnh v\u00e0 h\u01b0\u1edbng d\u1eabn \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o h\u1ec7 th\u1ed1ng \u1ed5n \u0111\u1ecbnh v\u00e0 \u0111\u00e1ng tin c\u1eady.</p> <ul> <li>11 - Testing Guide: Chi\u1ebfn l\u01b0\u1ee3c v\u00e0 h\u01b0\u1edbng d\u1eabn vi\u1ebft c\u00e1c lo\u1ea1i test.</li> <li>12 - Security Checklist: Danh s\u00e1ch ki\u1ec3m tra b\u1ea3o m\u1eadt cho l\u1eadp tr\u00ecnh vi\u00ean.</li> <li>13 - CI/CD Pipeline &amp; Operations: H\u01b0\u1edbng d\u1eabn t\u01b0\u01a1ng t\u00e1c v\u1edbi pipeline v\u00e0 c\u00e1c m\u00f4i tr\u01b0\u1eddng.</li> <li>14 - Debugging Guide: H\u01b0\u1edbng d\u1eabn g\u1ee1 l\u1ed7i c\u00e1c v\u1ea5n \u0111\u1ec1 \u0111\u00e3 bi\u1ebft.</li> <li>15 - Troubleshooting Guide: Ph\u01b0\u01a1ng ph\u00e1p lu\u1eadn x\u1eed l\u00fd s\u1ef1 c\u1ed1 c\u00f3 h\u1ec7 th\u1ed1ng.</li> <li>16 - Incident Response Guide: Quy tr\u00ecnh ph\u1ea3n \u1ee9ng khi c\u00f3 s\u1ef1 c\u1ed1 nghi\u00eam tr\u1ecdng.</li> <li>17 - Release &amp; Versioning Guide: Chi\u1ebfn l\u01b0\u1ee3c \u0111\u00e1nh s\u1ed1 phi\u00ean b\u1ea3n v\u00e0 qu\u1ea3n l\u00fd release.</li> </ul>"},{"location":"dev-guide/#phan-5-nang-suat-cong-cu-productivity-tools","title":"Ph\u1ea7n 5: N\u0103ng su\u1ea5t &amp; C\u00f4ng c\u1ee5 (Productivity &amp; Tools)","text":"<p>C\u00e1c t\u00e0i li\u1ec7u tham kh\u1ea3o nhanh gi\u00fap t\u0103ng t\u1ed1c \u0111\u1ed9 l\u00e0m vi\u1ec7c.</p> <ul> <li>18 - Local Dev Productivity Tips: C\u00e1c m\u1eb9o \u0111\u1ec3 t\u0103ng n\u0103ng su\u1ea5t khi ph\u00e1t tri\u1ec3n local.</li> <li>19 - Tooling Cheatsheet: T\u1ed5ng h\u1ee3p c\u00e1c l\u1ec7nh v\u00e0 c\u00f4ng c\u1ee5 th\u01b0\u1eddng d\u00f9ng.</li> </ul>"},{"location":"dev-guide/01-getting-started/","title":"01 getting started","text":""},{"location":"dev-guide/01-getting-started/#getting-started-huong-dan-cai-at-moi-truong-phat-trien","title":"Getting Started - H\u01b0\u1edbng d\u1eabn C\u00e0i \u0111\u1eb7t M\u00f4i tr\u01b0\u1eddng Ph\u00e1t tri\u1ec3n","text":""},{"location":"dev-guide/01-getting-started/#yeu-cau-cong-cu","title":"\ud83e\uddf0 Y\u00eau c\u1ea7u C\u00f4ng c\u1ee5","text":"Lo\u1ea1i c\u00f4ng c\u1ee5 Y\u00eau c\u1ea7u c\u1ee5 th\u1ec3 Ng\u00f4n ng\u1eef - Python <code>&gt;=3.11</code>- Node.js <code>&gt;=18.x</code> Qu\u1ea3n l\u00fd dependencies - <code>poetry</code> (cho Python)- <code>npm</code> ho\u1eb7c <code>yarn</code> (cho Node.js frontend) Containerization - Docker <code>&gt;=24.0</code>- Docker Compose CLI tools - <code>gcloud</code>- <code>terraform</code> Editor &amp; IDE - Khuy\u1ebfn ngh\u1ecb VS Code v\u1edbi c\u00e1c extensions:- Python, Pylance- Prettier, ESLint- Docker, YAML, GitLens"},{"location":"dev-guide/01-getting-started/#cai-at-du-an","title":"\ud83d\udee0\ufe0f C\u00e0i \u0111\u1eb7t D\u1ef1 \u00e1n","text":"<ol> <li> <p>Clone repository ch\u00ednh c\u1ee7a d\u1ef1 \u00e1n DX-VAS: <pre><code>   git clone git@github.com:vas-dev/dx-vas-platform.git #TODO: S\u1eeda l\u1ea1i git link ch\u00ednh th\u1ee9c c\u1ee7a project\n   cd dx-vas-platform\n</code></pre></p> </li> <li> <p>C\u00e0i \u0111\u1eb7t <code>pre-commit</code> \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o format/lint code tr\u01b0\u1edbc khi commit: <pre><code>   pip install pre-commit\n   pre-commit install\n</code></pre></p> </li> <li> <p>T\u1ea1o v\u00e0 c\u1ea5u h\u00ecnh file <code>.env</code> cho t\u1eebng service.    D\u1ef1a tr\u00ean c\u00e1c file <code>.env.example</code> c\u00f3 s\u1eb5n, \u0111i\u1ec1u ch\u1ec9nh theo m\u00f4i tr\u01b0\u1eddng local c\u1ee7a b\u1ea1n.    Tham kh\u1ea3o: ADR-005 - Environment Configuration</p> </li> <li> <p>Kh\u1edfi ch\u1ea1y c\u00e1c service ph\u1ee5 thu\u1ed9c b\u1eb1ng Docker Compose: <pre><code>   docker-compose up -d postgres redis\n</code></pre></p> </li> <li> <p>Ch\u1ea1y migration cho CSDL c\u1ee7a service b\u1ea1n \u0111ang l\u00e0m vi\u1ec7c (v\u00ed d\u1ee5 v\u1edbi Alembic ho\u1eb7c custom migration tool):    <pre><code>   make migrate\n</code></pre></p> </li> <li> <p>Ch\u1ea1y service \u1edf local b\u1eb1ng Poetry:    <pre><code>   cd services/user-service/master\n   poetry install\n   poetry run uvicorn app.main:app --reload\n</code></pre></p> </li> </ol>"},{"location":"dev-guide/01-getting-started/#chay-du-an-lan-au","title":"\ud83d\ude80 Ch\u1ea1y D\u1ef1 \u00e1n L\u1ea7n \u0111\u1ea7u","text":"<p>V\u00ed d\u1ee5 ch\u1ea1y <code>user-service/master</code> t\u1ea1i <code>http://localhost:8001</code></p> <ol> <li> <p>\u0110\u1ea3m b\u1ea3o Postgres \u0111ang ch\u1ea1y trong Docker:    <pre><code>   docker-compose ps\n</code></pre></p> </li> <li> <p>T\u1ea1o DB n\u1ebfu ch\u01b0a c\u00f3:    <pre><code>   make db-init\n</code></pre></p> </li> <li> <p>Truy c\u1eadp Swagger UI c\u1ee7a service:    <pre><code>   http://localhost:8001/docs\n</code></pre></p> </li> <li> <p>G\u1ecdi th\u1eed API b\u1eb1ng <code>curl</code>:    <pre><code>   curl -H \"Authorization: Bearer &lt;token&gt;\" http://localhost:8001/users/me\n</code></pre></p> </li> </ol> <p>\ud83e\udde0 Ghi ch\u00fa: B\u1ea1n c\u00f3 th\u1ec3 l\u1ea5y JWT token th\u1eed nghi\u1ec7m b\u1eb1ng m\u1ed9t trong c\u00e1c c\u00e1ch sau:</p> <ul> <li>S\u1eed d\u1ee5ng API <code>/auth/login</code> t\u1eeb <code>auth-service/master</code> v\u1edbi t\u00e0i kho\u1ea3n test (v\u00ed d\u1ee5: <code>admin@vas.edu.vn</code>)</li> <li>Ho\u1eb7c g\u1ecdi script t\u1ea1o nhanh token local (n\u1ebfu c\u00f3 make target):</li> </ul> <p><pre><code> make token USER_ID=user-001 ROLE=admin\n</code></pre> * Ho\u1eb7c decode l\u1ea1i token c\u00f3 s\u1eb5n \u0111\u1ec3 ki\u1ec3m tra payload b\u1eb1ng jwt.io</p> <p>N\u1ebfu b\u1ea1n g\u1eb7p l\u1ed7i m\u00f4i tr\u01b0\u1eddng, h\u00e3y tham kh\u1ea3o <code>dev-guide/debug-guide.md</code> ho\u1eb7c trao \u0111\u1ed5i trong Slack channel n\u1ed9i b\u1ed9.</p>"},{"location":"dev-guide/02-core-principles/","title":"\ud83c\udf1f 02. C\u00e1c Nguy\u00ean t\u1eafc V\u00e0ng khi L\u1eadp tr\u00ecnh","text":"<p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c nguy\u00ean t\u1eafc c\u1ed1t l\u00f5i m\u00e0 m\u1ecdi l\u1eadp tr\u00ecnh vi\u00ean tham gia ph\u00e1t tri\u1ec3n h\u1ec7 th\u1ed1ng DX-VAS \u0111\u1ec1u ph\u1ea3i tu\u00e2n th\u1ee7. Nh\u1eefng nguy\u00ean t\u1eafc n\u00e0y kh\u00f4ng ch\u1ec9 gi\u00fap \u0111\u1ea3m b\u1ea3o ch\u1ea5t l\u01b0\u1ee3ng code m\u00e0 c\u00f2n l\u00e0 n\u1ec1n t\u1ea3ng cho kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng, b\u1ea3o tr\u00ec v\u00e0 b\u1ea3o m\u1eadt l\u00e2u d\u00e0i c\u1ee7a h\u1ec7 th\u1ed1ng.</p>"},{"location":"dev-guide/02-core-principles/#1-design-first","title":"1. \ud83e\udde0 Design First","text":"<p>\"Kh\u00f4ng bao gi\u1edd vi\u1ebft code tr\u01b0\u1edbc khi c\u00f3 t\u00e0i li\u1ec7u thi\u1ebft k\u1ebf \u0111\u01b0\u1ee3c duy\u1ec7t.\"</p> <ul> <li>M\u1ed7i t\u00ednh n\u0103ng ho\u1eb7c module m\u1edbi \u0111\u1ec1u ph\u1ea3i b\u1eaft \u0111\u1ea7u b\u1eb1ng vi\u1ec7c vi\u1ebft <code>design.md</code>, <code>data-model.md</code>, <code>interface-contract.md</code>.</li> <li>T\u00e0i li\u1ec7u ph\u1ea3i \u0111\u01b0\u1ee3c review b\u1edfi Tech Lead ho\u1eb7c Ki\u1ebfn tr\u00fac s\u01b0 v\u00e0 l\u01b0u tr\u1eef \u0111\u00fang ch\u1ed7 trong <code>/docs/services/&lt;service-name&gt;/</code>.</li> <li>\u0110\u00e2y l\u00e0 kim ch\u1ec9 nam \u0111\u1ec3 tr\u00e1nh \u201ccode tr\u01b0\u1edbc \u2013 s\u1eeda sau\u201d.</li> </ul>"},{"location":"dev-guide/02-core-principles/#2-adr-driven","title":"2. \ud83d\udcdc ADR-Driven","text":"<p>\"M\u1ecdi quy\u1ebft \u0111\u1ecbnh c\u00f3 \u1ea3nh h\u01b0\u1edfng \u0111\u1ebfn ki\u1ebfn tr\u00fac \u0111\u1ec1u ph\u1ea3i c\u00f3 ADR t\u01b0\u01a1ng \u1ee9ng.\"</p> <ul> <li>N\u1ebfu thay \u0111\u1ed5i li\u00ean quan \u0111\u1ebfn:</li> <li>Lu\u1ed3ng d\u1eef li\u1ec7u t\u1ed5ng th\u1ec3</li> <li>API cross-service</li> <li>Schema chia s\u1ebb</li> <li>C\u00e1ch tri\u1ec3n khai CI/CD, b\u1ea3o m\u1eadt</li> <li>Th\u00ec ph\u1ea3i t\u1ea1o m\u1ed9t file ADR m\u1edbi trong <code>/docs/ADR/</code>, theo m\u1eabu chu\u1ea9n <code>adr-xxx-title.md</code>.</li> <li>Tham kh\u1ea3o: ADR-001 \u0111\u1ebfn ADR-030</li> </ul>"},{"location":"dev-guide/02-core-principles/#3-security-by-design","title":"3. \ud83d\udd10 Security by Design","text":"<p>\"B\u1ea3o m\u1eadt kh\u00f4ng ph\u1ea3i l\u00e0 t\u00ednh n\u0103ng \u2013 n\u00f3 l\u00e0 tr\u00e1ch nhi\u1ec7m.\"</p> <ul> <li>M\u1ecdi service \u0111\u1ec1u ph\u1ea3i tu\u00e2n th\u1ee7 ADR-004 - Security Policy</li> <li>B\u1eaft bu\u1ed9c validate to\u00e0n b\u1ed9 input t\u1eeb client</li> <li>Kh\u00f4ng bao gi\u1edd trust d\u1eef li\u1ec7u \u0111\u1ea7u v\u00e0o (nh\u1ea5t l\u00e0 headers, payload JSON)</li> <li>Kh\u00f4ng \u0111\u01b0\u1ee3c log PII, token, ho\u1eb7c d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m</li> </ul>"},{"location":"dev-guide/02-core-principles/#4-stateless-services","title":"4. \u2699\ufe0f Stateless Services","text":"<p>\"N\u1ebfu service c\u1ee7a b\u1ea1n c\u1ea7n l\u01b0u tr\u1ea1ng th\u00e1i, b\u1ea1n \u0111ang vi ph\u1ea1m ki\u1ebfn tr\u00fac scale-out.\"</p> <ul> <li>M\u1ecdi service backend ph\u1ea3i stateless</li> <li>C\u00e1c tr\u1ea1ng th\u00e1i (nh\u01b0 phi\u00ean \u0111\u0103ng nh\u1eadp, token, h\u00e0ng \u0111\u1ee3i x\u1eed l\u00fd\u2026) ph\u1ea3i l\u01b0u \u1edf:</li> <li>PostgreSQL</li> <li>Redis</li> <li>Pub/Sub</li> <li>\u0110i\u1ec1u n\u00e0y gi\u00fap b\u1ea1n d\u1ec5 d\u00e0ng scale horizontal v\u00e0 deploy m\u00e0 kh\u00f4ng m\u1ea5t session</li> </ul>"},{"location":"dev-guide/02-core-principles/#5-test-everything","title":"5. \ud83e\uddea Test Everything","text":"<p>\"Kh\u00f4ng test, kh\u00f4ng merge.\"</p> <ul> <li>M\u1ecdi \u0111o\u1ea1n code c\u00f3 logic nghi\u1ec7p v\u1ee5 \u0111\u1ec1u ph\u1ea3i \u0111i k\u00e8m unit test</li> <li>M\u1ecdi API endpoint \u0111\u1ec1u ph\u1ea3i c\u00f3 integration test</li> <li>Coverage cho service ph\u1ea3i &gt;= 80%</li> <li>Kh\u00f4ng c\u00f3 l\u00fd do ngo\u1ea1i l\u1ec7 \u2013 th\u1eddi gian test l\u00e0 \u0111\u1ea7u t\u01b0, kh\u00f4ng ph\u1ea3i chi ph\u00ed</li> </ul>"},{"location":"dev-guide/02-core-principles/#6-tuan-thu-hop-ong-contract-first","title":"6. \ud83e\udd1d Tu\u00e2n th\u1ee7 H\u1ee3p \u0111\u1ed3ng (Contract First)","text":"<p>\"<code>openapi.yaml</code> l\u00e0 h\u1ee3p \u0111\u1ed3ng \u2013 kh\u00f4ng \u0111\u01b0\u1ee3c thay \u0111\u1ed5i t\u00f9y ti\u1ec7n.\"</p> <ul> <li>T\u1ea5t c\u1ea3 thay \u0111\u1ed5i li\u00ean quan \u0111\u1ebfn API:</li> <li>B\u1eaft bu\u1ed9c c\u1eadp nh\u1eadt <code>openapi.yaml</code> tr\u01b0\u1edbc ti\u00ean</li> <li>Sau \u0111\u00f3 m\u1edbi b\u1eaft \u0111\u1ea7u implement</li> <li>Kh\u00f4ng \u0111\u01b0\u1ee3c merge b\u1ea5t k\u1ef3 thay \u0111\u1ed5i n\u00e0o vi ph\u1ea1m schema \u0111\u1ecbnh ngh\u0129a</li> <li>C\u1ea7n review k\u1ef9 <code>x-required-permission</code>, <code>x-audit-action</code>, <code>x-emits-event</code> cho m\u1ed7i endpoint</li> </ul> <p>\ud83d\udccc Ghi nh\u1edb: B\u1ea1n c\u00f3 th\u1ec3 tham kh\u1ea3o c\u00e1c h\u01b0\u1edbng d\u1eabn c\u1ee5 th\u1ec3 trong: - 03-workflow-and-process.md - technical-guides/01-api-development.md - technical-guides/02-database-and-migrations.md</p>"},{"location":"dev-guide/03-workflow-and-process/","title":"\ud83d\udd01 03. Quy tr\u00ecnh L\u00e0m vi\u1ec7c v\u1edbi Git, Pull Request v\u00e0 CI/CD","text":"<p>Quy tr\u00ecnh l\u00e0m vi\u1ec7c chu\u1ea9n m\u1ef1c gi\u00fap team ph\u00e1t tri\u1ec3n DX-VAS c\u1ed9ng t\u00e1c hi\u1ec7u qu\u1ea3, h\u1ea1n ch\u1ebf xung \u0111\u1ed9t, v\u00e0 t\u1ef1 \u0111\u1ed9ng h\u00f3a ki\u1ec3m tra ch\u1ea5t l\u01b0\u1ee3ng code tr\u01b0\u1edbc khi \u0111\u01b0a v\u00e0o m\u00f4i tr\u01b0\u1eddng ch\u00ednh th\u1ee9c.</p>"},{"location":"dev-guide/03-workflow-and-process/#git-branching-strategy","title":"\ud83e\udea2 Git Branching Strategy","text":"Nh\u00e1nh M\u1ee5c \u0111\u00edch <code>main</code> Nh\u00e1nh ch\u00ednh, lu\u00f4n \u1edf tr\u1ea1ng th\u00e1i c\u00f3 th\u1ec3 tri\u1ec3n khai Production. Ch\u1ec9 merge t\u1eeb <code>dev</code> sau khi ki\u1ec3m th\u1eed xong. <code>dev</code> Nh\u00e1nh ph\u00e1t tri\u1ec3n t\u1ed5ng, n\u01a1i t\u00edch h\u1ee3p c\u00e1c feature v\u00e0 t\u1ef1 \u0111\u1ed9ng deploy l\u00ean m\u00f4i tr\u01b0\u1eddng Staging. <code>feature/*</code> Nh\u00e1nh cho t\u1eebng t\u00ednh n\u0103ng m\u1edbi. \u0110\u1eb7t t\u00ean theo \u0111\u1ecbnh d\u1ea1ng: <code>feature/DX-123-add-reporting-api</code> <code>bugfix/*</code> Nh\u00e1nh x\u1eed l\u00fd l\u1ed7i tr\u00ean <code>dev</code> ho\u1eb7c <code>staging</code>. \u0110\u1ecbnh d\u1ea1ng: <code>bugfix/DX-456-fix-pagination</code> <code>hotfix/*</code> Nh\u00e1nh s\u1eeda l\u1ed7i kh\u1ea9n c\u1ea5p tr\u1ef1c ti\u1ebfp tr\u00ean <code>main</code>. \u0110\u01b0\u1ee3c merge v\u00e0 deploy nhanh. V\u00ed d\u1ee5: <code>hotfix/DX-999-fix-token-bug</code>"},{"location":"dev-guide/03-workflow-and-process/#commit-message-convention","title":"\ud83d\udcdd Commit Message Convention","text":"<p>\u00c1p d\u1ee5ng chu\u1ea9n Conventional Commits gi\u00fap:</p> <ul> <li>D\u1ec5 \u0111\u1ecdc l\u1ecbch s\u1eed commit</li> <li>T\u00edch h\u1ee3p t\u1ed1t v\u1edbi changelog t\u1ef1 \u0111\u1ed9ng, release note</li> <li>T\u1ef1 \u0111\u1ed9ng trigger pipeline ho\u1eb7c semantic versioning</li> </ul>"},{"location":"dev-guide/03-workflow-and-process/#mot-so-vi-du-chuan","title":"\ud83d\udccc M\u1ed9t s\u1ed1 v\u00ed d\u1ee5 chu\u1ea9n:","text":"Prefix M\u1ee5c \u0111\u00edch s\u1eed d\u1ee5ng <code>feat:</code> Th\u00eam m\u1edbi t\u00ednh n\u0103ng <code>fix:</code> S\u1eeda l\u1ed7i logic, bug c\u1ee5 th\u1ec3 <code>docs:</code> C\u1eadp nh\u1eadt t\u00e0i li\u1ec7u <code>style:</code> \u0110\u1ecbnh d\u1ea1ng l\u1ea1i code, kh\u00f4ng \u1ea3nh h\u01b0\u1edfng logic <code>refactor:</code> C\u1ea3i ti\u1ebfn c\u1ea5u tr\u00fac code m\u00e0 kh\u00f4ng \u0111\u1ed5i h\u00e0nh vi <code>test:</code> Th\u00eam / s\u1eeda test (unit, integration) <code>chore:</code> C\u1eadp nh\u1eadt dependency, CI, file ph\u1ee5 tr\u1ee3 <p>\ud83d\udccc V\u00ed d\u1ee5 th\u1ef1c t\u1ebf:</p> <pre><code>feat: add new endpoint for report templates\nfix: correct pagination logic in list users API\ndocs: update README with new architecture diagram\nstyle: format code with black\nrefactor: improve query performance for user lookup\ntest: add unit tests for RBAC validator\nchore: update dependencies\n</code></pre>"},{"location":"dev-guide/03-workflow-and-process/#pull-request-pr-process","title":"\ud83d\udd04 Pull Request (PR) Process","text":"<ol> <li>T\u1ea1o PR t\u1eeb nh\u00e1nh <code>feature/*</code>, <code>bugfix/*</code> ho\u1eb7c <code>hotfix/*</code> v\u00e0o <code>dev</code> (ho\u1eb7c <code>main</code> n\u1ebfu hotfix production).</li> <li> <p>\u0110i\u1ec1n \u0111\u1ea7y \u0111\u1ee7 th\u00f4ng tin theo template PR:</p> </li> <li> <p>Link t\u1edbi ticket (Jira/Trello)</p> </li> <li>M\u00f4 t\u1ea3 thay \u0111\u1ed5i</li> <li>Screenshot n\u1ebfu c\u00f3 thay \u0111\u1ed5i giao di\u1ec7n</li> <li>Checklist testing</li> <li> <p>\u0110\u1ea3m b\u1ea3o pipeline CI/CD pass to\u00e0n b\u1ed9:</p> </li> <li> <p>\u2705 <code>pre-commit</code> lint (black, isort, flake8\u2026)</p> </li> <li>\u2705 <code>pytest</code> ho\u1eb7c <code>unit test</code></li> <li>\u2705 Build docker image n\u1ebfu c\u1ea7n</li> <li>Ph\u1ea3i c\u00f3 \u00edt nh\u1ea5t 1-2 ng\u01b0\u1eddi review v\u00e0 approve, \u01b0u ti\u00ean t\u1eeb nh\u00f3m li\u00ean quan tr\u1ef1c ti\u1ebfp ho\u1eb7c team ki\u1ebfn tr\u00fac n\u1ebfu thay \u0111\u1ed5i l\u1edbn.</li> <li>Khi merge, ch\u1ecdn Squash &amp; Merge \u0111\u1ec3 gi\u1eef l\u1ecbch s\u1eed commit r\u00f5 r\u00e0ng v\u00e0 g\u1ecdn g\u00e0ng.</li> </ol>"},{"location":"dev-guide/03-workflow-and-process/#ghi-chu-cicd","title":"\ud83d\ude80 Ghi ch\u00fa CI/CD","text":"<ul> <li> <p>M\u1ed7i push/PR s\u1ebd trigger t\u1ef1 \u0111\u1ed9ng:</p> </li> <li> <p>Ki\u1ec3m tra lint + test</p> </li> <li>\u0110\u00f3ng g\u00f3i docker</li> <li>Deploy l\u00ean m\u00f4i tr\u01b0\u1eddng staging (n\u1ebfu branch l\u00e0 <code>dev</code>)</li> <li>Kh\u00f4ng \u0111\u01b0\u1ee3c merge n\u1ebfu pipeline CI fail</li> <li>\u0110\u1ec3 ki\u1ec3m tra CI config, xem th\u00eam: <code>ci-guide.md</code> (s\u1ebd c\u00f3 sau)</li> </ul>"},{"location":"dev-guide/productivity-and-tools/18-local-dev-productivity/","title":"\u2699\ufe0f 18. Local Development Productivity \u2013 T\u0103ng T\u1ed1c Ph\u00e1t Tri\u1ec3n C\u1ee5c B\u1ed9","text":"<p>T\u00e0i li\u1ec7u n\u00e0y cung c\u1ea5p c\u00e1c k\u1ef9 thu\u1eadt v\u00e0 c\u00f4ng c\u1ee5 gi\u00fap l\u1eadp tr\u00ecnh vi\u00ean t\u0103ng t\u1ed1c khi ph\u00e1t tri\u1ec3n local, gi\u1ea3m th\u1eddi gian feedback v\u00e0 c\u1ea3i thi\u1ec7n tr\u1ea3i nghi\u1ec7m vi\u1ebft code tr\u00ean d\u1ef1 \u00e1n DX-VAS.</p>"},{"location":"dev-guide/productivity-and-tools/18-local-dev-productivity/#1-auto-reload-live-dev","title":"1. \ud83d\ude80 Auto Reload &amp; Live Dev","text":"Ng\u00f4n ng\u1eef/Stack C\u00e1ch b\u1eadt auto reload Python (FastAPI) <code>uvicorn app.main:app --reload</code> ho\u1eb7c <code>make dev</code> Node.js <code>nodemon src/index.ts</code> ho\u1eb7c c\u1ea5u h\u00ecnh script npm Frontend (Vite) <code>npm run dev</code> (auto reload m\u1eb7c \u0111\u1ecbnh) <p>\u2705 Lu\u00f4n c\u1ea5u h\u00ecnh <code>--reload</code> trong local \u0111\u1ec3 ti\u1ebft ki\u1ec7m th\u1eddi gian kh\u1edfi \u0111\u1ed9ng l\u1ea1i service sau m\u1ed7i l\u1ea7n ch\u1ec9nh s\u1eeda.</p>"},{"location":"dev-guide/productivity-and-tools/18-local-dev-productivity/#2-docker-dev-mode","title":"2. \ud83d\udc33 Docker Dev Mode","text":"<ul> <li> <p>S\u1eed d\u1ee5ng volume mount \u0111\u1ec3 map source code v\u00e0o container: <pre><code>  volumes:\n    - ./app:/usr/src/app\n</code></pre></p> </li> <li> <p>T\u00e1ch Dockerfile dev v\u00e0 prod n\u1ebfu c\u1ea7n:</p> </li> <li> <p><code>Dockerfile.dev</code>: d\u00f9ng cho local (<code>pip install -e</code>, mount code)</p> </li> <li><code>Dockerfile</code>: t\u1ed1i \u01b0u cho build production</li> </ul> <p>\ud83d\udd04 G\u1ee3i \u00fd: Docker + volume s\u1ebd ch\u1eadm tr\u00ean macOS \u2192 c\u00e2n nh\u1eafc ch\u1ea1y poetry tr\u1ef1c ti\u1ebfp.</p>"},{"location":"dev-guide/productivity-and-tools/18-local-dev-productivity/#3-makefile-shortcut-cho-dev","title":"3. \ud83e\ude84 Makefile Shortcut cho Dev","text":"L\u1ec7nh nhanh M\u1ee5c \u0111\u00edch <code>make run</code> Ch\u1ea1y app local (<code>uvicorn --reload</code>) <code>make test</code> Ch\u1ea1y test nhanh <code>make migrate</code> T\u1ea1o schema DB <code>make lint</code> Format + check <code>make token</code> Sinh JWT test <code>make logs</code> Xem log container g\u1ea7n nh\u1ea5t <p>\ud83e\udde0 G\u1ee3i \u00fd: N\u1ebfu th\u1ea5y make ch\u1eadm, c\u00f3 th\u1ec3 d\u00f9ng <code>justfile</code> ho\u1eb7c <code>npm scripts</code> t\u00f9y stack.</p>"},{"location":"dev-guide/productivity-and-tools/18-local-dev-productivity/#4-tang-toc-test-local","title":"4. \ud83e\uddea T\u0103ng t\u1ed1c Test Local","text":"<ul> <li>Ch\u1ea1y test m\u1ed9t ph\u1ea7n: <code>pytest tests/unit/</code></li> <li>Cache DB: d\u00f9ng SQLite ho\u1eb7c Postgres ri\u00eang cho test</li> <li>Mock external: kh\u00f4ng g\u1ecdi th\u1eadt Pub/Sub, Redis</li> </ul> <p>D\u00f9ng <code>--maxfail=2</code> \u0111\u1ec3 fail nhanh:</p> <pre><code>pytest --maxfail=2 --disable-warnings\n</code></pre>"},{"location":"dev-guide/productivity-and-tools/18-local-dev-productivity/#5-tips-cho-vs-code","title":"5. \ud83e\udde0 Tips cho VS Code","text":"Extension M\u1ee5c \u0111\u00edch Python, Pylance Intellisense m\u1ea1nh Docker, Dev Containers Qu\u1ea3n l\u00fd container nhanh REST Client G\u1eedi request API tr\u1ef1c ti\u1ebfp EditorConfig \u0110\u1ed3ng b\u1ed9 style \u0111a ng\u00f4n ng\u1eef Error Lens Hi\u1ec3n th\u1ecb l\u1ed7i inline"},{"location":"dev-guide/productivity-and-tools/18-local-dev-productivity/#launch-config-mau-python","title":"Launch config m\u1eabu (Python):","text":"<pre><code>{\n  \"name\": \"Run FastAPI\",\n  \"type\": \"python\",\n  \"request\": \"launch\",\n  \"module\": \"uvicorn\",\n  \"args\": [\"app.main:app\", \"--reload\"],\n  \"justMyCode\": true\n}\n</code></pre>"},{"location":"dev-guide/productivity-and-tools/18-local-dev-productivity/#6-hot-reload-template-frontend","title":"6. \ud83d\udd04 Hot Reload Template / Frontend","text":"<ul> <li>V\u1edbi Jinja2 (template server-side), c\u1ea7n b\u1eadt reload engine:</li> </ul> <pre><code>templates = Jinja2Templates(directory=\"templates\", auto_reload=True)\n</code></pre> <ul> <li> <p>V\u1edbi frontend Vite:</p> </li> <li> <p>H\u1ed7 tr\u1ee3 hot-module-replacement m\u1eb7c \u0111\u1ecbnh</p> </li> <li>Khi th\u00eam file m\u1edbi: restart <code>npm run dev</code> n\u1ebfu b\u1ecb delay reload</li> </ul>"},{"location":"dev-guide/productivity-and-tools/18-local-dev-productivity/#7-don-dep-workspace","title":"7. \ud83d\udcc1 D\u1ecdn d\u1eb9p Workspace","text":"<ul> <li>Xo\u00e1 file build r\u00e1c:</li> </ul> <p><pre><code>find . -name \"__pycache__\" -exec rm -r {} +\n</code></pre> * Reset container &amp; volume:</p> <pre><code>docker-compose down -v\n</code></pre>"},{"location":"dev-guide/productivity-and-tools/18-local-dev-productivity/#8-checklist-khi-setup-may-moi","title":"8. \ud83d\udccc Checklist khi setup m\u00e1y m\u1edbi","text":"<ul> <li> C\u00e0i Docker &amp; Docker Compose</li> <li> C\u00e0i Python 3.11+ v\u00e0 Poetry</li> <li> C\u00e0i Node.js 18+ v\u00e0 Yarn/NPM</li> <li> C\u00e0i <code>pre-commit</code>, VS Code extensions</li> <li> Clone repo + <code>poetry install</code> + <code>make install</code></li> <li> Ki\u1ec3m tra <code>.env</code> v\u00e0 ch\u1ea1y <code>make run</code></li> </ul> <p>\ud83d\udca1 M\u1eb9o: Local productivity t\u1ed1t kh\u00f4ng ch\u1ec9 gi\u00fap dev code nhanh h\u01a1n, m\u00e0 c\u00f2n gi\u1ea3m l\u1ed7i production nh\u1edd feedback s\u1edbm v\u00e0 ph\u00e1t tri\u1ec3n t\u1ef1 tin h\u01a1n.</p>"},{"location":"dev-guide/productivity-and-tools/19-tooling-cheatsheet/","title":"\u26a1 19. Tooling Cheatsheet \u2013 T\u1ed5ng h\u1ee3p L\u1ec7nh v\u00e0 C\u00f4ng c\u1ee5 Th\u01b0\u1eddng D\u00f9ng","text":"<p>T\u00e0i li\u1ec7u n\u00e0y t\u1ed5ng h\u1ee3p c\u00e1c l\u1ec7nh CLI, script v\u00e0 c\u00f4ng c\u1ee5 h\u1eefu \u00edch ph\u1ee5c v\u1ee5 qu\u00e1 tr\u00ecnh ph\u00e1t tri\u1ec3n, ki\u1ec3m th\u1eed v\u00e0 v\u1eadn h\u00e0nh h\u1ec7 th\u1ed1ng DX-VAS. \u0110\u00e2y l\u00e0 \u201cs\u1ed5 tay b\u1ecf t\u00fai\u201d c\u1ee7a m\u1ecdi l\u1eadp tr\u00ecnh vi\u00ean.</p>"},{"location":"dev-guide/productivity-and-tools/19-tooling-cheatsheet/#1-python-poetry","title":"1. \ud83d\udc0d Python &amp; Poetry","text":"M\u1ee5c \u0111\u00edch L\u1ec7nh C\u00e0i \u0111\u1eb7t dependencies <code>poetry install</code> Ch\u1ea1y shell t\u01b0\u01a1ng t\u00e1c <code>poetry shell</code> Ch\u1ea1y script c\u1ee5 th\u1ec3 <code>poetry run python script.py</code> C\u00e0i g\u00f3i m\u1edbi <code>poetry add &lt;package&gt;</code> C\u00e0i g\u00f3i dev <code>poetry add --group dev &lt;package&gt;</code>"},{"location":"dev-guide/productivity-and-tools/19-tooling-cheatsheet/#2-testing","title":"2. \ud83e\uddea Testing","text":"M\u1ee5c \u0111\u00edch L\u1ec7nh Ch\u1ea1y to\u00e0n b\u1ed9 test <code>make test</code> ho\u1eb7c <code>poetry run pytest</code> Ch\u1ea1y test c\u00f3 coverage <code>poetry run pytest --cov=app tests/</code> Ch\u1ea1y test theo file <code>pytest tests/unit/test_user.py</code> Contract test b\u1eb1ng schemathesis <code>schemathesis run --base-url=http://localhost:8001 openapi.yaml</code>"},{"location":"dev-guide/productivity-and-tools/19-tooling-cheatsheet/#3-docker-docker-compose","title":"3. \ud83d\udc33 Docker &amp; Docker Compose","text":"M\u1ee5c \u0111\u00edch L\u1ec7nh Kh\u1edfi \u0111\u1ed9ng c\u00e1c service ph\u1ee5 thu\u1ed9c <code>docker-compose up -d postgres redis</code> Ki\u1ec3m tra container \u0111ang ch\u1ea1y <code>docker-compose ps</code> V\u00e0o container service <code>docker-compose exec user-service bash</code> Xem log m\u1ed9t container <code>docker-compose logs -f &lt;service&gt;</code> T\u1eaft to\u00e0n b\u1ed9 container <code>docker-compose down</code>"},{"location":"dev-guide/productivity-and-tools/19-tooling-cheatsheet/#4-gcloud-cli","title":"4. \ud83c\udf10 Gcloud CLI","text":"M\u1ee5c \u0111\u00edch L\u1ec7nh Xem log theo trace_id <code>gcloud logging read 'jsonPayload.trace_id=\"req-abc123\"' --project=dx-vas-core</code> Truy xu\u1ea5t secret <code>gcloud secrets versions access latest --secret=\"jwt-secret\"</code> Li\u1ec7t k\u00ea topic Pub/Sub <code>gcloud pubsub topics list</code> G\u1eedi event m\u1eabu \u0111\u1ebfn Pub/Sub (local) <code>make publish-sample-event</code> (tu\u1ef3 service)"},{"location":"dev-guide/productivity-and-tools/19-tooling-cheatsheet/#5-code-format-lint","title":"5. \ud83e\uddf9 Code Format &amp; Lint","text":"M\u1ee5c \u0111\u00edch L\u1ec7nh Format to\u00e0n b\u1ed9 code <code>black .</code> S\u1eafp x\u1ebfp import <code>isort .</code> Ki\u1ec3m tra style &amp; error t\u0129nh <code>flake8 .</code> Ki\u1ec3m tra YAML, Markdown, JSON <code>pre-commit run --all-files</code>"},{"location":"dev-guide/productivity-and-tools/19-tooling-cheatsheet/#6-makefile-shortcut","title":"6. \ud83d\udce6 Makefile Shortcut","text":"M\u1ee5c ti\u00eau L\u1ec7nh C\u00e0i \u0111\u1eb7t &amp; chu\u1ea9n b\u1ecb m\u00f4i tr\u01b0\u1eddng <code>make install</code> Ch\u1ea1y server <code>make run</code> Ch\u1ea1y migration DB <code>make migrate</code> Lint + format to\u00e0n b\u1ed9 <code>make lint</code> Ch\u1ea1y t\u1ea5t c\u1ea3 test <code>make test</code>"},{"location":"dev-guide/productivity-and-tools/19-tooling-cheatsheet/#7-jwt-token","title":"7. \ud83d\udd10 JWT Token","text":"M\u1ee5c \u0111\u00edch C\u00e1ch l\u00e0m Sinh token test local <code>make token USER_ID=user-123 ROLE=admin</code> Decode token D\u00e1n token v\u00e0o https://jwt.io Th\u00eam v\u00e0o curl / Postman Header: <code>Authorization: Bearer &lt;token&gt;</code>"},{"location":"dev-guide/productivity-and-tools/19-tooling-cheatsheet/#8-goi-y-extension-vs-code","title":"8. \ud83d\udcdd G\u1ee3i \u00fd Extension VS Code","text":"<ul> <li>Python, Pylance</li> <li>Docker, YAML, dotenv</li> <li>Prettier, ESLint, EditorConfig</li> <li>REST Client (test API nhanh)</li> </ul> <p>\ud83d\udccc M\u1eb9o: B\u1ea1n c\u00f3 th\u1ec3 copy ph\u1ea7n n\u00e0y ra file ri\u00eang <code>dx-cheatsheet.txt</code> \u0111\u1ec3 m\u1edf b\u1eb1ng terminal ho\u1eb7c l\u01b0u v\u00e0o Notion n\u1ed9i b\u1ed9.</p>"},{"location":"dev-guide/quality-and-operations/11-testing-guide/","title":"\ud83e\uddea 11. Testing Guide \u2013 H\u01b0\u1edbng d\u1eabn Vi\u1ebft v\u00e0 Qu\u1ea3n l\u00fd Ki\u1ec3m th\u1eed","text":"<p>T\u00e0i li\u1ec7u n\u00e0y h\u01b0\u1edbng d\u1eabn c\u00e1ch vi\u1ebft, t\u1ed5 ch\u1ee9c v\u00e0 ch\u1ea1y c\u00e1c b\u00e0i ki\u1ec3m th\u1eed (test) trong h\u1ec7 th\u1ed1ng DX-VAS theo chu\u1ea9n 5\u2b50, \u0111\u1ea3m b\u1ea3o \u0111\u1ed9 tin c\u1eady cao v\u00e0 ph\u00f2ng ng\u1eeba l\u1ed7i khi ph\u00e1t tri\u1ec3n.</p>"},{"location":"dev-guide/quality-and-operations/11-testing-guide/#1-triet-ly-kiem-thu","title":"1. \ud83e\udde0 Tri\u1ebft l\u00fd Ki\u1ec3m th\u1eed","text":"<ul> <li>M\u1ed7i thay \u0111\u1ed5i ph\u1ea3i \u0111i k\u00e8m test t\u01b0\u01a1ng \u1ee9ng.</li> <li>Kh\u00f4ng c\u00f3 ki\u1ec3m th\u1eed \u0111\u1ed3ng ngh\u0129a v\u1edbi kh\u00f4ng c\u00f3 ni\u1ec1m tin.</li> <li>Ki\u1ec3m th\u1eed kh\u00f4ng ch\u1ec9 l\u00e0 \"check code ch\u1ea1y\", m\u00e0 l\u00e0 \u0111\u1ea3m b\u1ea3o h\u00e0nh vi nghi\u1ec7p v\u1ee5.</li> <li>T\u1ef1 \u0111\u1ed9ng h\u00f3a ki\u1ec3m th\u1eed l\u00e0 y\u00eau c\u1ea7u b\u1eaft bu\u1ed9c trong CI/CD.</li> </ul> <p>Tham kh\u1ea3o: - ADR-010 - Contract Testing</p>"},{"location":"dev-guide/quality-and-operations/11-testing-guide/#2-cac-loai-kiem-thu","title":"2. \ud83e\uddea C\u00e1c lo\u1ea1i ki\u1ec3m th\u1eed","text":"Lo\u1ea1i Test M\u1ee5c ti\u00eau ch\u00ednh Framework Unit Test Ki\u1ec3m tra t\u1eebng h\u00e0m, class nh\u1ecf <code>pytest</code>, <code>unittest</code> Integration Test Ki\u1ec3m tra API th\u1ef1c s\u1ef1, DB, Pub/Sub, Redis, ... <code>pytest + FastAPI</code>, <code>Supertest</code> (Node.js) Contract Test So s\u00e1nh request/response th\u1ef1c t\u1ebf v\u1edbi OpenAPI <code>schemathesis</code>, <code>dredd</code>, <code>pact</code> E2E Test (FE) Ki\u1ec3m th\u1eed giao di\u1ec7n t\u1eeb \u0111\u1ea7u \u0111\u1ebfn cu\u1ed1i <code>Playwright</code>, <code>Cypress</code> Load Test Ki\u1ec3m tra hi\u1ec7u n\u0103ng &amp; kh\u1ea3 n\u0103ng ch\u1ecbu t\u1ea3i <code>k6</code>, <code>locust</code>"},{"location":"dev-guide/quality-and-operations/11-testing-guide/#3-cau-truc-thu-muc-test","title":"3. \ud83e\uddf1 C\u1ea5u tr\u00fac th\u01b0 m\u1ee5c Test","text":"<p>V\u00ed d\u1ee5 cho Python service:</p> <pre><code>user-service/\n\u251c\u2500\u2500 app/\n\u251c\u2500\u2500 tests/\n\u2502   \u251c\u2500\u2500 unit/\n\u2502   \u2502   \u2514\u2500\u2500 test\\_rbac.py\n\u2502   \u251c\u2500\u2500 integration/\n\u2502   \u2502   \u2514\u2500\u2500 test\\_users\\_api.py\n\u2502   \u2514\u2500\u2500 contract/\n\u2502       \u2514\u2500\u2500 test\\_openapi\\_schema.py\n</code></pre>"},{"location":"dev-guide/quality-and-operations/11-testing-guide/#4-viet-test-hieu-qua","title":"4. \ud83e\uddea Vi\u1ebft Test Hi\u1ec7u qu\u1ea3","text":"<ul> <li>M\u1ed7i unit test n\u00ean ki\u1ec3m tra 1 logic c\u1ee5 th\u1ec3</li> <li>\u0110\u1eb7t t\u00ean test r\u00f5 r\u00e0ng: <code>test_create_user_with_valid_data_should_return_201</code></li> <li>D\u00f9ng <code>fixture</code> \u0111\u1ec3 t\u1ea1o d\u1eef li\u1ec7u m\u1eabu (user, token, DB connection\u2026)</li> <li>Mock external dependency (Pub/Sub, Redis\u2026) trong unit test</li> </ul>"},{"location":"dev-guide/quality-and-operations/11-testing-guide/#5-cac-quy-tac-bat-buoc","title":"5. \ud83d\udccb C\u00e1c quy t\u1eafc b\u1eaft bu\u1ed9c","text":"Quy t\u1eafc Ghi ch\u00fa Coverage \u2265 80% \u0110\u01b0\u1ee3c ki\u1ec3m tra t\u1ef1 \u0111\u1ed9ng trong CI Kh\u00f4ng \u0111\u01b0\u1ee3c skip test khi merge D\u00f9ng <code>@pytest.mark.skip</code> ch\u1ec9 khi th\u1eadt c\u1ea7n thi\u1ebft M\u1ed7i PR c\u00f3 \u00edt nh\u1ea5t 1 test \u0111i k\u00e8m D\u00f9 l\u00e0 bugfix hay feature m\u1edbi Test ph\u1ea3i idempotent Ch\u1ea1y l\u1ea1i nhi\u1ec1u l\u1ea7n kh\u00f4ng \u0111\u01b0\u1ee3c fail ng\u1eabu nhi\u00ean"},{"location":"dev-guide/quality-and-operations/11-testing-guide/#6-chay-test","title":"6. \ud83d\ude80 Ch\u1ea1y Test","text":""},{"location":"dev-guide/quality-and-operations/11-testing-guide/#local","title":"Local:","text":"<pre><code>make test\npoetry run pytest -v --cov=app tests/\n</code></pre>"},{"location":"dev-guide/quality-and-operations/11-testing-guide/#docker-danh-cho-service-co-container-rieng","title":"Docker (d\u00e0nh cho service c\u00f3 container ri\u00eang):","text":"<pre><code>docker-compose exec user-service make test\n</code></pre>"},{"location":"dev-guide/quality-and-operations/11-testing-guide/#contract-test-voi-schemathesis","title":"Contract Test v\u1edbi Schemathesis:","text":"<pre><code>schemathesis run --base-url=http://localhost:8001 openapi.yaml\n</code></pre>"},{"location":"dev-guide/quality-and-operations/11-testing-guide/#7-nhung-ieu-khong-nen-lam","title":"7. \ud83d\uded1 Nh\u1eefng \u0111i\u1ec1u kh\u00f4ng n\u00ean l\u00e0m","text":"<ul> <li>\u274c Kh\u00f4ng vi\u1ebft test ch\u1ec9 \u0111\u1ec3 \u201cpass CI\u201d m\u00e0 kh\u00f4ng ki\u1ec3m tra g\u00ec th\u1ef1c t\u1ebf</li> <li>\u274c Kh\u00f4ng test d\u1ef1a tr\u00ean hardcoded ID t\u1eeb DB th\u1eadt</li> <li>\u274c Kh\u00f4ng g\u1ed9p nhi\u1ec1u logic kh\u00e1c nhau trong 1 test case</li> <li>\u274c Kh\u00f4ng \u0111\u1ec3 test ph\u1ee5 thu\u1ed9c v\u00e0o th\u1ee9 t\u1ef1 ch\u1ea1y</li> </ul> <p>\ud83d\udccc Ghi nh\u1edb: M\u1ed9t h\u1ec7 th\u1ed1ng kh\u00f4ng c\u00f3 ki\u1ec3m th\u1eed t\u1ef1 \u0111\u1ed9ng l\u00e0 h\u1ec7 th\u1ed1ng ch\u01b0a s\u1eb5n s\u00e0ng \u0111\u1ec3 ph\u00e1t tri\u1ec3n nghi\u00eam t\u00fac.</p>"},{"location":"dev-guide/quality-and-operations/12-security-checklist/","title":"\ud83d\udd12 12. Security Checklist \u2013 Danh s\u00e1ch Ki\u1ec3m tra B\u1ea3o m\u1eadt cho L\u1eadp tr\u00ecnh vi\u00ean","text":"<p>T\u00e0i li\u1ec7u n\u00e0y c\u1ee5 th\u1ec3 h\u00f3a ADR-004 - Security Policy th\u00e0nh m\u1ed9t danh s\u00e1ch ki\u1ec3m tra h\u00e0nh \u0111\u1ed9ng cho l\u1eadp tr\u00ecnh vi\u00ean. M\u1ee5c ti\u00eau l\u00e0 \u0111\u1ea3m b\u1ea3o m\u1ecdi commit v\u00e0 Pull Request (PR) \u0111\u1ec1u tu\u00e2n th\u1ee7 c\u00e1c nguy\u00ean t\u1eafc b\u1ea3o m\u1eadt c\u1ed1t l\u00f5i.</p>"},{"location":"dev-guide/quality-and-operations/12-security-checklist/#1-checklist-bao-mat-truoc-khi-merge-pr","title":"1. \u2705 Checklist B\u1ea3o m\u1eadt Tr\u01b0\u1edbc khi Merge PR","text":"<p>D\u1ef1a tr\u00ean OWASP Top 10:</p> M\u1ee5c ki\u1ec3m tra B\u1eaft bu\u1ed9c Ghi ch\u00fa [ ] Validate v\u00e0 sanitize to\u00e0n b\u1ed9 input t\u1eeb client \u2705 Kh\u00f4ng tin b\u1ea5t k\u1ef3 d\u1eef li\u1ec7u n\u00e0o t\u1eeb frontend [ ] Kh\u00f4ng tr\u1ea3 l\u1ed7i raw/stack trace ra client \u2705 D\u00f9ng chu\u1ea9n <code>ErrorEnvelope</code> [ ] Kh\u00f4ng log th\u00f4ng tin nh\u1ea1y c\u1ea3m (token, password...) \u2705 \u0110\u1eb7c bi\u1ec7t trong production [ ] Kh\u00f4ng hard-code secret/key/API token \u2705 D\u00f9ng bi\u1ebfn m\u00f4i tr\u01b0\u1eddng [ ] D\u1eef li\u1ec7u quan tr\u1ecdng c\u00f3 \u0111\u01b0\u1ee3c m\u00e3 h\u00f3a n\u1ebfu c\u1ea7n \u2705 VD: m\u00e3 OTP, backup token [ ] Truy c\u1eadp API \u0111\u01b0\u1ee3c ki\u1ec3m tra permission r\u00f5 r\u00e0ng \u2705 D\u00f9ng <code>x-required-permission</code> [ ] Rate-limit/Throttling \u0111\u01b0\u1ee3c thi\u1ebft l\u1eadp n\u1ebfu c\u1ea7n \u26a0\ufe0f \u0110\u1eb7c bi\u1ec7t v\u1edbi c\u00e1c endpoint nh\u1ea1y c\u1ea3m [ ] \u0110\u1ea7u ra \u0111\u01b0\u1ee3c encode \u0111\u00fang c\u00e1ch (HTML/JSON...) \u2705 Tr\u00e1nh XSS [ ] C\u1eadp nh\u1eadt th\u01b0 vi\u1ec7n ph\u1ee5 thu\u1ed9c \u0111\u1ecbnh k\u1ef3 \u26a0\ufe0f D\u00f9ng <code>npm audit</code>, <code>poetry check</code> [ ] C\u00f3 unit test v\u00e0 integration test cho c\u00e1c case edge \u2705 Bao g\u1ed3m c\u1ea3 input \u0111\u1ed9c h\u1ea1i"},{"location":"dev-guide/quality-and-operations/12-security-checklist/#2-lam-sach-va-validate-input","title":"2. \ud83d\udee1\ufe0f L\u00e0m s\u1ea1ch v\u00e0 Validate Input","text":"<ul> <li>S\u1eed d\u1ee5ng schema validation (VD: Pydantic, Joi...) cho to\u00e0n b\u1ed9 body/query/params.</li> <li>Kh\u00f4ng x\u1eed l\u00fd logic v\u1edbi d\u1eef li\u1ec7u ch\u01b0a validate.</li> <li>C\u00e1c ki\u1ec3m tra n\u00ean bao g\u1ed3m:</li> <li>Ki\u1ec3u d\u1eef li\u1ec7u, \u0111\u1ed9 d\u00e0i, regex, whitelist</li> <li>Sanitization \u0111\u1ea7u v\u00e0o: lo\u1ea1i b\u1ecf k\u00fd t\u1ef1 l\u1ea1, escape HTML</li> <li>Tr\u00e1nh SQL Injection / NoSQL Injection b\u1eb1ng c\u00e1ch:</li> <li>Kh\u00f4ng bao gi\u1edd n\u1ed1i chu\u1ed7i SQL b\u1eb1ng string format</li> <li>D\u00f9ng parameter binding trong ORM</li> </ul>"},{"location":"dev-guide/quality-and-operations/12-security-checklist/#3-quan-ly-jwt-token-o-frontend","title":"3. \ud83d\udd10 Qu\u1ea3n l\u00fd JWT Token \u1edf Frontend","text":"<ul> <li>Kh\u00f4ng bao gi\u1edd l\u01b0u token trong localStorage.</li> <li>\u01afu ti\u00ean l\u01b0u trong <code>HttpOnly Secure Cookie</code> \u0111\u1ec3 tr\u00e1nh XSS.</li> <li>N\u1ebfu bu\u1ed9c ph\u1ea3i l\u01b0u (SPA), ph\u1ea3i \u0111\u1ea3m b\u1ea3o:</li> <li>Token \u0111\u01b0\u1ee3c m\u00e3 h\u00f3a v\u00e0 prefix x\u00e1c \u0111\u1ecbnh</li> <li>Auto logout khi token h\u1ebft h\u1ea1n</li> <li>X\u00f3a s\u1ea1ch khi <code>logout</code> ho\u1eb7c tab b\u1ecb \u0111\u00f3ng</li> </ul>"},{"location":"dev-guide/quality-and-operations/12-security-checklist/#goi-y-cac-bien-phap-bao-ve","title":"G\u1ee3i \u00fd c\u00e1c bi\u1ec7n ph\u00e1p b\u1ea3o v\u1ec7:","text":"C\u01a1 ch\u1ebf M\u1ee5c \u0111\u00edch <code>SameSite=Strict</code> Ng\u0103n CSRF <code>Secure</code> Ch\u1ec9 truy\u1ec1n qua HTTPS <code>HttpOnly</code> Kh\u00f4ng cho JavaScript truy c\u1eadp Token rotation L\u00e0m m\u1edbi token \u0111\u1ecbnh k\u1ef3"},{"location":"dev-guide/quality-and-operations/12-security-checklist/#4-ma-hoa-du-lieu-trong-csdl","title":"4. \ud83d\udd0f M\u00e3 h\u00f3a D\u1eef li\u1ec7u trong CSDL","text":""},{"location":"dev-guide/quality-and-operations/12-security-checklist/#khi-nao-can","title":"Khi n\u00e0o c\u1ea7n:","text":"<ul> <li>D\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m: m\u00e3 OTP, recovery code, m\u00e3 h\u00f3a c\u1ea5u h\u00ecnh email n\u1ed9i b\u1ed9...</li> <li>D\u1eef li\u1ec7u backup ho\u1eb7c event log c\u00f3 th\u00f4ng tin c\u00e1 nh\u00e2n</li> </ul>"},{"location":"dev-guide/quality-and-operations/12-security-checklist/#cach-thuc-hien","title":"C\u00e1ch th\u1ef1c hi\u1ec7n:","text":"<ul> <li>D\u00f9ng th\u01b0 vi\u1ec7n m\u00e3 h\u00f3a \u0111\u1ed1i x\u1ee9ng AES (Python: <code>cryptography.fernet</code>, Node: <code>crypto</code>)</li> <li>L\u01b0u <code>encryption_key</code> trong Secret Manager ho\u1eb7c th\u00f4ng qua bi\u1ebfn ENV</li> <li>M\u00e3 h\u00f3a khi ghi v\u00e0o DB, gi\u1ea3i m\u00e3 khi truy v\u1ea5n</li> <li>Kh\u00f4ng n\u00ean m\u00e3 h\u00f3a to\u00e0n b\u1ed9 b\u1ea3ng \u2192 ch\u1ec9 c\u1ed9t c\u1ea7n thi\u1ebft</li> </ul> <pre><code>from cryptography.fernet import Fernet\nf = Fernet(os.environ['ENCRYPTION_KEY'])\n\nencrypted = f.encrypt(b\"123456\")\ndecrypted = f.decrypt(encrypted)\n</code></pre>"},{"location":"dev-guide/quality-and-operations/12-security-checklist/#5-logging-alert-lien-quan-toi-bao-mat","title":"5. \ud83d\udea8 Logging &amp; Alert Li\u00ean quan t\u1edbi B\u1ea3o m\u1eadt","text":"<ul> <li> <p>Log c\u00e1c h\u00e0nh vi b\u1ea5t th\u01b0\u1eddng:</p> </li> <li> <p>\u0110\u0103ng nh\u1eadp th\u1ea5t b\u1ea1i nhi\u1ec1u l\u1ea7n</p> </li> <li>Truy c\u1eadp API kh\u00f4ng \u0111\u00fang permission</li> <li>JWT b\u1ecb t\u1eeb ch\u1ed1i (h\u1ebft h\u1ea1n, gi\u1ea3 m\u1ea1o)</li> <li> <p>Thi\u1ebft l\u1eadp c\u1ea3nh b\u00e1o:</p> </li> <li> <p>G\u1eedi Slack/email n\u1ebfu c\u00f3 5xx t\u0103ng \u0111\u1ed9t bi\u1ebfn</p> </li> <li>Theo d\u00f5i access log \u0111\u1ec3 ph\u00e1t hi\u1ec7n DDoS</li> </ul>"},{"location":"dev-guide/quality-and-operations/12-security-checklist/#6-nhung-ieu-tuyet-oi-khong-uoc-lam","title":"6. \ud83d\udeab Nh\u1eefng \u0111i\u1ec1u tuy\u1ec7t \u0111\u1ed1i kh\u00f4ng \u0111\u01b0\u1ee3c l\u00e0m","text":"<ul> <li>\u274c Log <code>Authorization</code>, <code>password</code>, <code>OTP</code>, <code>JWT</code>, <code>secret</code></li> <li>\u274c B\u1ecf qua middleware RBAC ho\u1eb7c Auth cho endpoint \"t\u1ea1m th\u1eddi\"</li> <li>\u274c T\u1eaft CSRF ho\u1eb7c CORS ki\u1ec3m so\u00e1t sai c\u00e1ch</li> <li>\u274c D\u00f9ng <code>eval()</code> ho\u1eb7c t\u01b0\u01a1ng t\u1ef1 tr\u00ean d\u1eef li\u1ec7u kh\u00f4ng tin c\u1eady</li> <li>\u274c L\u01b0u m\u1eadt kh\u1ea9u ng\u01b0\u1eddi d\u00f9ng \u1edf d\u1ea1ng plain text (ph\u1ea3i hash b\u1eb1ng bcrypt/scrypt)</li> </ul> <p>\ud83d\udccc Ghi nh\u1edb: M\u1ed9t d\u00f2ng code thi\u1ebfu ki\u1ec3m tra b\u1ea3o m\u1eadt c\u00f3 th\u1ec3 ph\u00e1 v\u1ee1 to\u00e0n b\u1ed9 h\u1ec7 th\u1ed1ng. H\u00e3y lu\u00f4n checklist k\u1ef9 l\u01b0\u1ee1ng tr\u01b0\u1edbc khi nh\u1ea5n merge.</p>"},{"location":"dev-guide/quality-and-operations/13-ci-cd-pipeline/","title":"\ud83d\ude80 13. CI/CD Pipeline &amp; Environment Operations","text":"<p>T\u00e0i li\u1ec7u n\u00e0y h\u01b0\u1edbng d\u1eabn l\u1eadp tr\u00ecnh vi\u00ean c\u00e1ch t\u01b0\u01a1ng t\u00e1c hi\u1ec7u qu\u1ea3 v\u1edbi quy tr\u00ecnh CI/CD v\u00e0 c\u00e1c m\u00f4i tr\u01b0\u1eddng v\u1eadn h\u00e0nh (Staging, Production) trong h\u1ec7 th\u1ed1ng DX-VAS. M\u1ee5c ti\u00eau l\u00e0 gi\u00fap team ch\u1ee7 \u0111\u1ed9ng theo d\u00f5i, ki\u1ec3m so\u00e1t v\u00e0 ph\u1ea3n \u1ee9ng nhanh v\u1edbi s\u1ef1 c\u1ed1.</p>"},{"location":"dev-guide/quality-and-operations/13-ci-cd-pipeline/#1-tong-quan-cicd","title":"1. \ud83d\udee0\ufe0f T\u1ed5ng quan CI/CD","text":"<ul> <li>CI/CD c\u1ee7a h\u1ec7 th\u1ed1ng s\u1eed d\u1ee5ng GitHub Actions + Terraform + Google Cloud Run + GCS + Pub/Sub.</li> <li>M\u1ed7i commit l\u00ean nh\u00e1nh <code>dev</code> s\u1ebd:</li> <li>Ch\u1ea1y pipeline: lint \u2192 test \u2192 build \u2192 push container \u2192 deploy Staging</li> <li>M\u1ed7i commit l\u00ean <code>main</code> s\u1ebd:</li> <li>T\u1ea1o release \u2192 trigger deploy l\u00ean Production</li> </ul> <p>CI/CD pipeline \u0111\u01b0\u1ee3c m\u00f4 t\u1ea3 t\u1ea1i: ADR-001 - CI/CD Strategy</p>"},{"location":"dev-guide/quality-and-operations/13-ci-cd-pipeline/#2-moi-truong-nhanh-tuong-ung","title":"2. \ud83e\uddea M\u00f4i tr\u01b0\u1eddng &amp; Nh\u00e1nh T\u01b0\u01a1ng \u1ee9ng","text":"Environment Git Branch T\u1ef1 \u0111\u1ed9ng Deploy Domain URL Local N/A \u274c Th\u1ee7 c\u00f4ng http://localhost:8001 Staging <code>dev</code> \u2705 Auto https://staging.dx-vas.edu.vn Production <code>main</code> \u2705 Auto https://dx-vas.edu.vn"},{"location":"dev-guide/quality-and-operations/13-ci-cd-pipeline/#3-trigger-deploy-thu-cong-staging","title":"3. \ud83d\udea6 Trigger Deploy th\u1ee7 c\u00f4ng (Staging)","text":"<p>N\u1ebfu c\u1ea7n deploy l\u1ea1i l\u00ean m\u00f4i tr\u01b0\u1eddng Staging (d\u00f9 kh\u00f4ng c\u00f3 commit m\u1edbi):</p> <ol> <li>V\u00e0o GitHub \u2192 repo <code>vas/dx-vas</code></li> <li>Ch\u1ecdn tab Actions</li> <li>T\u00ecm workflow <code>Deploy to Staging</code></li> <li>Nh\u1ea5n Run workflow \u2192 ch\u1ecdn branch <code>dev</code> \u2192 Confirm</li> </ol>"},{"location":"dev-guide/quality-and-operations/13-ci-cd-pipeline/#4-theo-doi-tien-trinh-deploy","title":"4. \ud83d\udc40 Theo d\u00f5i Ti\u1ebfn tr\u00ecnh Deploy","text":"<ul> <li>Truy c\u1eadp tab Actions tr\u00ean GitHub \u2192 ch\u1ecdn workflow t\u01b0\u01a1ng \u1ee9ng (CI, Staging Deploy, Production Deploy).</li> <li>Click v\u00e0o t\u1eebng b\u01b0\u1edbc \u0111\u1ec3 xem log build, test, push image v\u00e0 deploy.</li> <li>Ki\u1ec3m tra service tr\u00ean GCP:</li> <li>Giao di\u1ec7n: https://console.cloud.google.com/run</li> <li>Ch\u1ecdn service \u2192 Tab Revisions \u0111\u1ec3 xem tr\u1ea1ng th\u00e1i deploy v\u00e0 traffic split.</li> </ul>"},{"location":"dev-guide/quality-and-operations/13-ci-cd-pipeline/#5-rollback-production-neu-loi","title":"5. \ud83d\udd01 Rollback Production (n\u1ebfu l\u1ed7i)","text":"<ol> <li>Truy c\u1eadp Google Cloud Console \u2192 Cloud Run</li> <li>Ch\u1ecdn service b\u1ecb l\u1ed7i \u2192 tab Revisions</li> <li>T\u00ecm b\u1ea3n build \u1ed5n \u0111\u1ecbnh tr\u01b0\u1edbc \u0111\u00f3 \u2192 Nh\u1ea5n n\u00fat Roll back to this revision</li> <li>Ki\u1ec3m tra l\u1ea1i Logs + Health check</li> </ol>"},{"location":"dev-guide/quality-and-operations/13-ci-cd-pipeline/#6-xem-logs-metrics","title":"6. \ud83d\udcc8 Xem Logs &amp; Metrics","text":""},{"location":"dev-guide/quality-and-operations/13-ci-cd-pipeline/#logs","title":"Logs:","text":"<ul> <li>V\u00e0o Google Cloud Logging</li> <li>Query m\u1eabu theo <code>service_name</code> ho\u1eb7c <code>trace_id</code>:   <code>sql   resource.type=\"cloud_run_revision\"   resource.labels.service_name=\"user-service\"   jsonPayload.trace_id=\"req-abc123\"</code></li> </ul>"},{"location":"dev-guide/quality-and-operations/13-ci-cd-pipeline/#metrics","title":"Metrics:","text":"<ul> <li>V\u00e0o Cloud Monitoring</li> <li>Dashboard t\u1ed5ng h\u1ee3p: <code>dx-vas-core</code> / <code>dx-vas-tenant-*</code></li> <li>Ho\u1eb7c v\u00e0o Grafana (n\u1ebfu \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh): <code>https://grafana.dx-vas.vn/</code></li> </ul>"},{"location":"dev-guide/quality-and-operations/13-ci-cd-pipeline/#7-xu-ly-alert-tu-he-thong","title":"7. \ud83d\udea8 X\u1eed l\u00fd Alert t\u1eeb H\u1ec7 th\u1ed1ng","text":"<ul> <li> <p>H\u1ec7 th\u1ed1ng g\u1eedi c\u1ea3nh b\u00e1o (alert) qua:</p> </li> <li> <p>Slack channel <code>#dx-vas-alerts</code></p> </li> <li>Email nh\u00f3m <code>devops@dx-vas.edu.vn</code></li> </ul>"},{"location":"dev-guide/quality-and-operations/13-ci-cd-pipeline/#khi-nhan-uoc-alert","title":"Khi nh\u1eadn \u0111\u01b0\u1ee3c alert:","text":"B\u01b0\u1edbc M\u00f4 t\u1ea3 1. X\u00e1c minh D\u1ef1a v\u00e0o message ho\u1eb7c link trace/log \u0111\u01b0\u1ee3c \u0111\u00ednh k\u00e8m 2. Ki\u1ec3m tra Logs Truy v\u1ebft b\u1eb1ng <code>trace_id</code>, <code>revision</code>, <code>timestamp</code> 3. Ki\u1ec3m tra l\u1ed7i API D\u00f9ng Postman ho\u1eb7c <code>curl</code> v\u1edbi token test 4. Rollback (n\u1ebfu c\u1ea7n) Theo m\u1ee5c 5 \u1edf tr\u00ean 5. Ghi nh\u1eadn v\u00e0o Wiki/Incident Report N\u1ebfu l\u00e0 s\u1ef1 c\u1ed1 nghi\u00eam tr\u1ecdng"},{"location":"dev-guide/quality-and-operations/13-ci-cd-pipeline/#8-checklist-cho-mot-release-on-inh","title":"8. \u2705 Checklist cho M\u1ed9t Release \u1ed4n \u0111\u1ecbnh","text":"<ul> <li> Pull Request \u0111\u00e3 \u0111\u01b0\u1ee3c review k\u1ef9 l\u01b0\u1ee1ng</li> <li> Test Coverage \u2265 80%</li> <li> \u0110\u00e3 ch\u1ea1y test local + staging OK</li> <li> Kh\u00f4ng c\u00f3 breaking change API/schema</li> <li> \u0110\u00e3 update changelog / release note</li> <li> C\u00e1c event schema \u0111\u01b0\u1ee3c sync version \u0111\u00fang</li> </ul> <p>\ud83d\udccc Ghi nh\u1edb: Dev kh\u00f4ng ch\u1ec9 l\u00e0 \"code\" \u2013 dev l\u00e0 ng\u01b0\u1eddi ch\u1ecbu tr\u00e1ch nhi\u1ec7m cho s\u1ea3n ph\u1ea9m ch\u1ea1y \u0111\u01b0\u1ee3c, \u1ed5n \u0111\u1ecbnh, v\u00e0 c\u00f3 th\u1ec3 rollback nhanh khi c\u1ea7n.</p>"},{"location":"dev-guide/quality-and-operations/14-debugging-guide/","title":"\ud83d\udc1e 14. H\u01b0\u1edbng d\u1eabn G\u1ee1 l\u1ed7i &amp; Truy v\u1ebft (Debugging &amp; Tracing Guide)","text":"<p>T\u00e0i li\u1ec7u n\u00e0y cung c\u1ea5p c\u00e1c ph\u01b0\u01a1ng ph\u00e1p, c\u00f4ng c\u1ee5 v\u00e0 k\u1ecbch b\u1ea3n th\u01b0\u1eddng g\u1eb7p \u0111\u1ec3 g\u1ee1 l\u1ed7i v\u00e0 truy v\u1ebft c\u00e1c v\u1ea5n \u0111\u1ec1 trong h\u1ec7 th\u1ed1ng DX-VAS.</p>"},{"location":"dev-guide/quality-and-operations/14-debugging-guide/#1-triet-ly-go-loi","title":"1. \ud83e\udde0 Tri\u1ebft l\u00fd G\u1ee1 l\u1ed7i","text":"<ul> <li> <p>Follow the Trace ID: <code>X-Request-ID</code> (ho\u1eb7c <code>trace_id</code> trong log) l\u00e0 ng\u01b0\u1eddi b\u1ea1n t\u1ed1t nh\u1ea5t c\u1ee7a b\u1ea1n. M\u1ecdi qu\u00e1 tr\u00ecnh g\u1ee1 l\u1ed7i n\u00ean b\u1eaft \u0111\u1ea7u t\u1eeb \u0111\u00e2y. N\u00f3 \u0111\u01b0\u1ee3c g\u00e1n t\u1ef1 \u0111\u1ed9ng t\u1ea1i API Gateway v\u00e0 truy\u1ec1n qua t\u1ea5t c\u1ea3 c\u00e1c service.</p> </li> <li> <p>Understand the Flow:   Tr\u01b0\u1edbc khi g\u1ee1 l\u1ed7i, h\u00e3y m\u1edf <code>docs/architecture/system-diagrams.md</code> \u0111\u1ec3 hi\u1ec3u r\u00f5 request c\u1ee7a b\u1ea1n \u0111\u00e3 \u0111i qua c\u00e1c service n\u00e0o.</p> </li> <li> <p>Reproduce Locally:   C\u1ed1 g\u1eafng t\u00e1i hi\u1ec7n l\u1ed7i trong m\u00f4i tr\u01b0\u1eddng local \u2013 v\u1edbi c\u00f9ng input \u2013 tr\u01b0\u1edbc khi x\u1eed l\u00fd tr\u00ean Staging ho\u1eb7c Production.</p> </li> </ul>"},{"location":"dev-guide/quality-and-operations/14-debugging-guide/#2-cong-cu-chinh","title":"2. \ud83d\udee0\ufe0f C\u00f4ng c\u1ee5 Ch\u00ednh","text":"C\u00f4ng c\u1ee5 M\u1ee5c \u0111\u00edch Google Cloud Logging Tra c\u1ee9u log t\u1eadp trung, l\u1ecdc theo <code>trace_id</code>, <code>severity</code>, <code>service</code> Google Cloud Trace (n\u1ebfu t\u00edch h\u1ee3p) Truy v\u1ebft bi\u1ec3u \u0111\u1ed3 Gantt c\u1ee7a m\u1ed9t request \u0111a service Debugger Local (VS Code) \u0110\u1eb7t breakpoint trong Python ho\u1eb7c Node.js \u0111\u1ec3 debug c\u1ee5c b\u1ed9 <code>curl</code> / Postman G\u1eedi th\u1eed API, xem chi ti\u1ebft response, header, status"},{"location":"dev-guide/quality-and-operations/14-debugging-guide/#3-quy-trinh-truy-vet-mot-request","title":"3. \ud83d\udd0d Quy tr\u00ecnh Truy v\u1ebft m\u1ed9t Request","text":"<ol> <li> <p>L\u1ea5y <code>X-Request-ID</code>:    Header n\u00e0y \u0111\u01b0\u1ee3c tr\u1ea3 v\u1ec1 trong m\u1ecdi API response. Ngo\u00e0i ra, b\u1ea1n c\u00f3 th\u1ec3 t\u00ecm trong log theo <code>request_id</code> ho\u1eb7c <code>trace_id</code>.</p> </li> <li> <p>V\u00e0o Cloud Logging:</p> </li> <li>M\u1edf https://console.cloud.google.com/logs/query</li> <li>Ch\u1ecdn \u0111\u00fang Project GCP (<code>dx-vas-core</code>, <code>dx-vas-tenant-xxx</code>, v.v.)</li> <li>D\u00e1n truy v\u1ea5n:      <pre><code>jsonPayload.trace_id=\"req-abc123\"\n</code></pre></li> <li> <p>Nh\u1ea5n \"Run Query\"</p> </li> <li> <p>\u0110\u1ecdc Log theo th\u1ee9 t\u1ef1:</p> </li> <li>B\u1eaft \u0111\u1ea7u t\u1eeb log c\u1ee7a <code>api-gateway</code></li> <li>Theo d\u00f5i c\u00e1c service backend t\u01b0\u01a1ng \u1ee9ng (auth, user, notification\u2026)</li> <li>T\u1eadp trung v\u00e0o c\u00e1c tr\u01b0\u1eddng <code>severity: \"ERROR\"</code>, <code>request_payload</code>, <code>response_payload</code>, <code>x-emits-event</code>, <code>audit_log</code></li> </ol>"},{"location":"dev-guide/quality-and-operations/14-debugging-guide/#4-cac-loi-thuong-gap-va-cach-xu-ly","title":"4. \u2757 C\u00e1c L\u1ed7i Th\u01b0\u1eddng g\u1eb7p v\u00e0 C\u00e1ch X\u1eed l\u00fd","text":""},{"location":"dev-guide/quality-and-operations/14-debugging-guide/#loi-401-unauthorized","title":"\ud83d\udd12 L\u1ed7i 401 Unauthorized","text":"<p>Nguy\u00ean nh\u00e2n: - Thi\u1ebfu <code>Authorization</code> header - Token h\u1ebft h\u1ea1n ho\u1eb7c sai</p> <p>C\u00e1ch x\u1eed l\u00fd: 1. Ki\u1ec3m tra header <code>Authorization: Bearer &lt;JWT&gt;</code> 2. D\u00e1n token v\u00e0o jwt.io \u0111\u1ec3 ki\u1ec3m tra payload (<code>exp</code>, <code>scope</code>) 3. Th\u1ef1c hi\u1ec7n l\u1ea1i lu\u1ed3ng \u0111\u0103ng nh\u1eadp qua <code>auth-service/master</code></p>"},{"location":"dev-guide/quality-and-operations/14-debugging-guide/#loi-403-forbidden","title":"\ud83d\udd12 L\u1ed7i 403 Forbidden","text":"<p>Nguy\u00ean nh\u00e2n: - User kh\u00f4ng c\u00f3 permission \u0111\u01b0\u1ee3c y\u00eau c\u1ea7u</p> <p>C\u00e1ch x\u1eed l\u00fd: 1. M\u1edf file <code>openapi.yaml</code> \u2192 t\u00ecm endpoint \u2192 xem <code>x-required-permission</code> 2. Ki\u1ec3m tra trong JWT xem user c\u00f3 permission \u0111\u00f3 kh\u00f4ng 3. Truy v\u1ea5n <code>user-service/master</code> ho\u1eb7c <code>sub</code> \u0111\u1ec3 ki\u1ec3m tra g\u00e1n <code>role \u2192 permission</code></p>"},{"location":"dev-guide/quality-and-operations/14-debugging-guide/#loi-5xx-internal-server-error","title":"\ud83d\udca5 L\u1ed7i 5xx Internal Server Error","text":"<p>Nguy\u00ean nh\u00e2n: - L\u1ed7i logic trong backend - L\u1ed7i k\u1ebft n\u1ed1i v\u1edbi DB, Redis, Pub/Sub</p> <p>C\u00e1ch x\u1eed l\u00fd: 1. Kh\u00f4ng d\u1eebng l\u1ea1i \u1edf log c\u1ee7a API Gateway! 2. D\u00f9ng <code>trace_id</code> \u0111\u1ec3 t\u00ecm log s\u00e2u h\u01a1n trong c\u00e1c service 3. T\u1eadp trung v\u00e0o log <code>severity=ERROR</code> + xem traceback c\u1ee5 th\u1ec3</p>"},{"location":"dev-guide/quality-and-operations/14-debugging-guide/#loi-moi-truong-local","title":"\ud83e\uddea L\u1ed7i M\u00f4i tr\u01b0\u1eddng Local","text":"<p>Nguy\u00ean nh\u00e2n ph\u1ed5 bi\u1ebfn: - Docker Compose ch\u01b0a kh\u1edfi \u0111\u1ed9ng - <code>.env</code> ch\u01b0a c\u1ea5u h\u00ecnh \u0111\u00fang - Ch\u01b0a ch\u1ea1y migration t\u1ea1o b\u1ea3ng</p> <p>C\u00e1ch x\u1eed l\u00fd: 1. Ki\u1ec3m tra container:    <pre><code>docker-compose ps\n</code></pre></p> <ol> <li>So s\u00e1nh <code>.env</code> v\u1edbi <code>.env.example</code></li> <li>Ch\u1ea1y migration:    <pre><code>make migrate\n</code></pre></li> </ol> <p>\ud83d\udca1 M\u1eb9o: Lu\u00f4n th\u00eam <code>X-Request-ID</code> v\u00e0o m\u1ecdi log th\u1ee7 c\u00f4ng c\u1ee7a b\u1ea1n \u2013 n\u00f3 gi\u00fap b\u1ea1n trace xuy\u00ean t\u1ea7ng, k\u1ec3 c\u1ea3 khi l\u1ed7i kh\u00f4ng x\u1ea3y ra.</p>"},{"location":"dev-guide/quality-and-operations/15-troubleshooting/","title":"\ud83e\uddef 15. Troubleshooting Guide \u2013 X\u1eed l\u00fd S\u1ef1 c\u1ed1 Nhanh","text":"<p>T\u00e0i li\u1ec7u n\u00e0y t\u1ed5ng h\u1ee3p c\u00e1c s\u1ef1 c\u1ed1 th\u01b0\u1eddng g\u1eb7p trong qu\u00e1 tr\u00ecnh ph\u00e1t tri\u1ec3n v\u00e0 v\u1eadn h\u00e0nh h\u1ec7 th\u1ed1ng DX-VAS, k\u00e8m h\u01b0\u1edbng d\u1eabn x\u1eed l\u00fd nhanh. M\u1ee5c ti\u00eau l\u00e0 gi\u00fap dev kh\u00f4ng ho\u1ea3ng lo\u1ea1n khi g\u1eb7p l\u1ed7i, v\u00e0 bi\u1ebft tra \u1edf \u0111\u00e2u, l\u00e0m g\u00ec tr\u01b0\u1edbc ti\u00ean.</p>"},{"location":"dev-guide/quality-and-operations/15-troubleshooting/#1-local-development-loi-thuong-gap","title":"1. \ud83e\uddea Local Development \u2013 L\u1ed7i th\u01b0\u1eddng g\u1eb7p","text":""},{"location":"dev-guide/quality-and-operations/15-troubleshooting/#khong-chay-uoc-service-local","title":"\u274c Kh\u00f4ng ch\u1ea1y \u0111\u01b0\u1ee3c service local","text":"Nguy\u00ean nh\u00e2n C\u00e1ch x\u1eed l\u00fd Docker ch\u01b0a kh\u1edfi \u0111\u1ed9ng ho\u1eb7c sai port <code>docker-compose up -d postgres redis</code> File <code>.env</code> ch\u01b0a t\u1ed3n t\u1ea1i ho\u1eb7c sai Copy t\u1eeb <code>.env.example</code> v\u00e0 ki\u1ec3m tra t\u1eebng bi\u1ebfn Migration ch\u01b0a ch\u1ea1y <code>make migrate</code> ho\u1eb7c <code>alembic upgrade head</code> Poetry ch\u01b0a c\u00e0i / sai virtualenv <code>poetry install</code> v\u00e0 <code>poetry shell</code>"},{"location":"dev-guide/quality-and-operations/15-troubleshooting/#goi-api-tra-ve-401-unauthorized","title":"\u274c G\u1ecdi API tr\u1ea3 v\u1ec1 401 Unauthorized","text":"Nguy\u00ean nh\u00e2n C\u00e1ch x\u1eed l\u00fd Thi\u1ebfu token ho\u1eb7c token sai \u0110\u0103ng nh\u1eadp l\u1ea1i b\u1eb1ng Postman ho\u1eb7c <code>make token</code> Token h\u1ebft h\u1ea1n / decode sai D\u00e1n token v\u00e0o jwt.io \u0111\u1ec3 ki\u1ec3m tra Backend qu\u00ean check token? Ki\u1ec3m tra middleware Auth \u0111\u00e3 b\u1eadt ch\u01b0a"},{"location":"dev-guide/quality-and-operations/15-troubleshooting/#2-api-gateway-routing-loi","title":"2. \ud83d\udef0\ufe0f API Gateway / Routing l\u1ed7i","text":""},{"location":"dev-guide/quality-and-operations/15-troubleshooting/#goi-api-gateway-nhung-bao-404","title":"\u274c G\u1ecdi API Gateway nh\u01b0ng b\u00e1o 404","text":"Nguy\u00ean nh\u00e2n C\u00e1ch x\u1eed l\u00fd Route ch\u01b0a \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong <code>proxy_config.yaml</code> Th\u00eam l\u1ea1i route v\u00e0 restart service Sai path ho\u1eb7c method So l\u1ea1i v\u1edbi OpenAPI contract"},{"location":"dev-guide/quality-and-operations/15-troubleshooting/#loi-cors-khi-goi-tu-frontend","title":"\u274c L\u1ed7i CORS khi g\u1ecdi t\u1eeb Frontend","text":"Nguy\u00ean nh\u00e2n C\u00e1ch x\u1eed l\u00fd Header <code>Origin</code> b\u1ecb ch\u1eb7n Ki\u1ec3m tra config CORS trong service Kh\u00f4ng tr\u1ea3 v\u1ec1 header <code>Access-Control-Allow-Origin</code> Th\u00eam middleware CORS \u0111\u00fang trong FastAPI ho\u1eb7c Express"},{"location":"dev-guide/quality-and-operations/15-troubleshooting/#3-pubsub-event-processing","title":"3. \ud83d\udce6 Pub/Sub &amp; Event Processing","text":""},{"location":"dev-guide/quality-and-operations/15-troubleshooting/#sub-service-khong-nhan-event","title":"\u274c Sub Service kh\u00f4ng nh\u1eadn event","text":"Nguy\u00ean nh\u00e2n C\u00e1ch x\u1eed l\u00fd Sai <code>topic</code> ho\u1eb7c kh\u00f4ng c\u00f3 <code>subscription</code> Ki\u1ec3m tra GCP Pub/Sub ho\u1eb7c config local Event kh\u00f4ng h\u1ee3p l\u1ec7 schema B\u1eadt <code>schema validation</code> trong consumer &amp; ki\u1ec3m tra logs Event b\u1ecb swallow do l\u1ed7i B\u1eadt log <code>ERROR</code>, \u0111\u1ea3m b\u1ea3o kh\u00f4ng <code>try/except</code> qu\u00e1 r\u1ed9ng"},{"location":"dev-guide/quality-and-operations/15-troubleshooting/#4-bao-mat-quyen-han","title":"4. \ud83d\udd10 B\u1ea3o m\u1eadt &amp; Quy\u1ec1n h\u1ea1n","text":""},{"location":"dev-guide/quality-and-operations/15-troubleshooting/#tra-ve-403-forbidden","title":"\u274c Tr\u1ea3 v\u1ec1 403 Forbidden","text":"Nguy\u00ean nh\u00e2n C\u00e1ch x\u1eed l\u00fd User kh\u00f4ng c\u00f3 permission c\u1ea7n thi\u1ebft So l\u1ea1i <code>x-required-permission</code> trong OpenAPI Token kh\u00f4ng ch\u1ee9a \u0111\u1ee7 role/claims Decode token v\u00e0 ki\u1ec3m tra payload Config role mapping sai Ki\u1ec3m tra DB b\u1ea3ng <code>user_roles</code> v\u00e0 <code>role_permissions</code>"},{"location":"dev-guide/quality-and-operations/15-troubleshooting/#5-google-cloud-issues","title":"5. \u2601\ufe0f Google Cloud Issues","text":""},{"location":"dev-guide/quality-and-operations/15-troubleshooting/#khong-thay-log-service","title":"\u274c Kh\u00f4ng th\u1ea5y log service","text":"Nguy\u00ean nh\u00e2n C\u00e1ch x\u1eed l\u00fd Sai project GCP Ki\u1ec3m tra t\u00ean project trong filter Kh\u00f4ng log \u0111\u00fang <code>trace_id</code> Ki\u1ec3m tra middleware c\u00f3 g\u1eafn <code>X-Request-ID</code> ch\u01b0a Service ch\u01b0a deploy \u0111\u00fang revision V\u00e0o Cloud Run \u2192 tab Revisions \u0111\u1ec3 rollback n\u1ebfu c\u1ea7n"},{"location":"dev-guide/quality-and-operations/15-troubleshooting/#6-ky-nang-xu-ly-su-co-mindset","title":"6. \ud83e\udde0 K\u1ef9 n\u0103ng x\u1eed l\u00fd s\u1ef1 c\u1ed1 (Mindset)","text":"<ul> <li>Lu\u00f4n b\u1eaft \u0111\u1ea7u t\u1eeb <code>X-Request-ID</code> \u2192 gi\u00fap trace to\u00e0n flow qua log.</li> <li>Lu\u00f4n d\u00f9ng l\u1ea1i <code>curl</code> ho\u1eb7c Postman \u0111\u1ec3 t\u00e1i hi\u1ec7n v\u1ea5n \u0111\u1ec1 t\u1eebng b\u01b0\u1edbc.</li> <li>T\u00e1ch bi\u1ec7t l\u1ed7i logic v\u00e0 l\u1ed7i h\u1ea1 t\u1ea7ng (logic: exception, h\u1ea1 t\u1ea7ng: 502/504).</li> <li>Ghi l\u1ea1i c\u00e1c s\u1ef1 c\u1ed1 nghi\u00eam tr\u1ecdng v\u00e0o Wiki n\u1ed9i b\u1ed9 \u0111\u1ec3 r\u00fat kinh nghi\u1ec7m.</li> </ul>"},{"location":"dev-guide/quality-and-operations/15-troubleshooting/#7-nguon-tham-khao-nhanh","title":"7. \ud83d\udccc Ngu\u1ed3n tham kh\u1ea3o nhanh","text":"M\u1ee5c ti\u00eau Link Theo d\u00f5i Log https://console.cloud.google.com/logs Theo d\u00f5i Pub/Sub https://console.cloud.google.com/cloudpubsub Theo d\u00f5i Cloud Run https://console.cloud.google.com/run Monitoring &amp; Alert https://console.cloud.google.com/monitoring Decode JWT https://jwt.io Th\u1eed API (local) Postman / Insomnia / REST Client <p>\ud83d\udccc Ghi nh\u1edb: Dev gi\u1ecfi kh\u00f4ng ph\u1ea3i l\u00e0 dev kh\u00f4ng g\u1eb7p l\u1ed7i, m\u00e0 l\u00e0 ng\u01b0\u1eddi bi\u1ebft t\u00ecm \u0111\u00fang log, \u0111\u00fang flow, v\u00e0 fix l\u1ed7i c\u00f3 tr\u00e1ch nhi\u1ec7m.</p>"},{"location":"dev-guide/quality-and-operations/16-incident-response/","title":"\ud83d\udea8 16. Incident Response \u2013 Quy tr\u00ecnh Ph\u1ea3n \u1ee9ng S\u1ef1 c\u1ed1","text":"<p>T\u00e0i li\u1ec7u n\u00e0y cung c\u1ea5p quy tr\u00ecnh ti\u00eau chu\u1ea9n \u0111\u1ec3 ph\u1ea3n \u1ee9ng nhanh ch\u00f3ng, c\u00f3 t\u1ed5 ch\u1ee9c v\u00e0 hi\u1ec7u qu\u1ea3 khi x\u1ea3y ra s\u1ef1 c\u1ed1 trong h\u1ec7 th\u1ed1ng DX-VAS, \u0111\u1eb7c bi\u1ec7t \u1edf m\u00f4i tr\u01b0\u1eddng Staging v\u00e0 Production.</p>"},{"location":"dev-guide/quality-and-operations/16-incident-response/#1-muc-tieu","title":"1. \ud83c\udfaf M\u1ee5c ti\u00eau","text":"<ul> <li>X\u1eed l\u00fd s\u1ef1 c\u1ed1 \u0111\u00fang ng\u01b0\u1eddi \u2013 \u0111\u00fang b\u01b0\u1edbc \u2013 \u0111\u00fang th\u1eddi \u0111i\u1ec3m.</li> <li>Gi\u1ea3m t\u1ed1i thi\u1ec3u th\u1eddi gian downtime v\u00e0 \u1ea3nh h\u01b0\u1edfng \u0111\u1ebfn ng\u01b0\u1eddi d\u00f9ng.</li> <li>Ghi l\u1ea1i b\u00e0i h\u1ecdc &amp; c\u1ea3i ti\u1ebfn quy tr\u00ecnh sau s\u1ef1 c\u1ed1.</li> </ul>"},{"location":"dev-guide/quality-and-operations/16-incident-response/#2-phan-loai-muc-o-su-co","title":"2. \u26a0\ufe0f Ph\u00e2n lo\u1ea1i M\u1ee9c \u0111\u1ed9 S\u1ef1 c\u1ed1","text":"M\u1ee9c \u0111\u1ed9 Ti\u00eau ch\u00ed V\u00ed d\u1ee5 P0 \u1ea2nh h\u01b0\u1edfng nghi\u00eam tr\u1ecdng \u0111\u1ebfn to\u00e0n h\u1ec7 th\u1ed1ng / m\u1ea5t d\u1eef li\u1ec7u / t\u00ea li\u1ec7t ch\u1ee9c n\u0103ng ch\u00ednh Kh\u00f4ng th\u1ec3 \u0111\u0103ng nh\u1eadp, ghi nh\u1eadn \u0111i\u1ec3m, ho\u1eb7c g\u1eedi th\u00f4ng b\u00e1o kh\u1ea9n P1 M\u1ed9t t\u00ednh n\u0103ng quan tr\u1ecdng kh\u00f4ng ho\u1ea1t \u0111\u1ed9ng, nh\u01b0ng c\u00f3 workaround B\u1ecb l\u1ed7i khi t\u1ea1o user, nh\u01b0ng import CSV v\u1eabn d\u00f9ng \u0111\u01b0\u1ee3c P2 L\u1ed7i nh\u1ecf, kh\u00f4ng \u1ea3nh h\u01b0\u1edfng lu\u1ed3ng ch\u00ednh Label UI hi\u1ec3n th\u1ecb sai, link 404 trong email\u2026"},{"location":"dev-guide/quality-and-operations/16-incident-response/#3-quy-trinh-xu-ly-su-co","title":"3. \ud83e\udded Quy tr\u00ecnh X\u1eed l\u00fd S\u1ef1 c\u1ed1","text":"<pre><code>graph TD\nA[Ph\u00e1t hi\u1ec7n Alert] --&gt; B[Ph\u00e2n lo\u1ea1i M\u1ee9c \u0111\u1ed9]\nB --&gt; C[X\u00e1c minh l\u1ed7i - Reproduce]\nC --&gt; D[Ki\u1ec3m tra Logs/Tracing]\nD --&gt; E1{C\u00f3 th\u1ec3 fix nhanh?}\nE1 -- Yes --&gt; F[Fix + Deploy nhanh]\nE1 -- No --&gt; G[Rollback ho\u1eb7c Toggle Feature]\nF --&gt; H[Monitor l\u1ea1i 30'] --&gt; I[Write Incident Report]\nG --&gt; H\n</code></pre>"},{"location":"dev-guide/quality-and-operations/16-incident-response/#4-cong-cu-nguon-quan-sat","title":"4. \ud83d\udee0\ufe0f C\u00f4ng c\u1ee5 &amp; Ngu\u1ed3n Quan S\u00e1t","text":"C\u00f4ng c\u1ee5 M\u1ee5c \u0111\u00edch Slack #dx-vas-alerts Nh\u1eadn c\u1ea3nh b\u00e1o real-time Google Cloud Logging Truy log theo <code>trace_id</code>, <code>service</code> Google Cloud Trace Quan s\u00e1t performance request Grafana / Cloud Monitoring Dashboards theo d\u00f5i metric h\u1ec7 th\u1ed1ng Postman / curl Ki\u1ec3m tra nhanh API &amp; token"},{"location":"dev-guide/quality-and-operations/16-incident-response/#5-rollback-phuc-hoi","title":"5. \ud83d\udd01 Rollback &amp; Ph\u1ee5c h\u1ed3i","text":""},{"location":"dev-guide/quality-and-operations/16-incident-response/#khi-nao-rollback","title":"Khi n\u00e0o rollback?","text":"<ul> <li>API tr\u1ea3 5xx h\u00e0ng lo\u1ea1t ho\u1eb7c kh\u00f4ng response</li> <li>Feature m\u1edbi g\u00e2y l\u1ed7i logic ho\u1eb7c l\u00e0m treo service</li> <li>Event b\u1ecb ph\u00e1t sai schema, g\u00e2y l\u1ed7i consumer</li> </ul>"},{"location":"dev-guide/quality-and-operations/16-incident-response/#cach-rollback","title":"C\u00e1ch rollback:","text":"<ol> <li>V\u00e0o Cloud Run \u2192 Service \u2192 Tab <code>Revisions</code></li> <li>Ch\u1ecdn b\u1ea3n \u1ed5n \u0111\u1ecbnh g\u1ea7n nh\u1ea5t \u2192 <code>Roll back to this revision</code></li> <li>Ki\u1ec3m tra l\u1ea1i logs, metrics</li> </ol>"},{"location":"dev-guide/quality-and-operations/16-incident-response/#6-mau-bao-cao-su-co-incident-report","title":"6. \ud83e\uddfe M\u1eabu B\u00e1o c\u00e1o S\u1ef1 c\u1ed1 (Incident Report)","text":"<pre><code>### \ud83c\udfaf S\u1ef1 c\u1ed1: Kh\u00f4ng g\u1eedi \u0111\u01b0\u1ee3c notification email (P1)\n- **Th\u1eddi gian:** 2025-06-07 09:30\n- **Ph\u00e1t hi\u1ec7n b\u1edfi:** Slack Alert + Feedback t\u1eeb ph\u1ee5 huynh\n- **\u1ea2nh h\u01b0\u1edfng:** 60% email g\u1eedi qua SMTP b\u1ecb treo\n- **Nguy\u00ean nh\u00e2n:** Redis b\u1ecb \u0111\u1ea7y memory \u2192 queue consumer treo\n- **H\u00e0nh \u0111\u1ed9ng:** Restart Redis + t\u0103ng max memory\n- **Th\u1eddi gian kh\u1eafc ph\u1ee5c:** 17 ph\u00fat\n- **B\u00e0i h\u1ecdc:** C\u1ea7n c\u1ea3nh b\u00e1o s\u1edbm khi Redis memory v\u01b0\u1ee3t 80%\n</code></pre>"},{"location":"dev-guide/quality-and-operations/16-incident-response/#7-thoi-quen-phan-ung-chuyen-nghiep","title":"7. \ud83e\udde0 Th\u00f3i quen ph\u1ea3n \u1ee9ng chuy\u00ean nghi\u1ec7p","text":"<ul> <li>Kh\u00f4ng blame ng\u01b0\u1eddi. L\u1ed7i l\u00e0 t\u00edn hi\u1ec7u c\u1ea3i ti\u1ebfn h\u1ec7 th\u1ed1ng.</li> <li>Ghi log m\u1ecdi h\u00e0nh \u0111\u1ed9ng kh\u00f4i ph\u1ee5c. D\u1ec5 audit &amp; h\u1ecdc h\u1ecfi.</li> <li>Lu\u00f4n post-mortem sau P0/P1. D\u00f9 \u0111\u00e3 fix, nh\u01b0ng c\u00f2n ph\u1ea3i h\u1ecdc.</li> </ul>"},{"location":"dev-guide/quality-and-operations/16-incident-response/#8-dien-tap-gia-lap-su-co","title":"8. \ud83e\uddea Di\u1ec5n t\u1eadp Gi\u1ea3 L\u1eadp S\u1ef1 C\u1ed1","text":"<ul> <li>\u0110\u1ecbnh k\u1ef3 3\u20136 th\u00e1ng, n\u00ean t\u1ed5 ch\u1ee9c c\u00e1c bu\u1ed5i \"Chaos Day\"</li> <li> <p>M\u00f4 ph\u1ecfng c\u00e1c k\u1ecbch b\u1ea3n:</p> </li> <li> <p>API Gateway down</p> </li> <li>Pub/Sub m\u1ea5t k\u1ebft n\u1ed1i</li> <li>Token Auth l\u1ed7i</li> <li>\u0110\u00e1nh gi\u00e1 ph\u1ea3n \u1ee9ng c\u1ee7a team + c\u1ea3i ti\u1ebfn playbook</li> </ul> <p>\ud83d\udccc Ghi nh\u1edb: S\u1ef1 c\u1ed1 kh\u00f4ng th\u1ec3 tr\u00e1nh \u2013 quan tr\u1ecdng l\u00e0 ch\u00fang ta chu\u1ea9n b\u1ecb t\u1ed1t, ph\u1ea3n \u1ee9ng nhanh, v\u00e0 h\u1ecdc \u0111\u01b0\u1ee3c \u0111i\u1ec1u g\u00ec sau \u0111\u00f3.</p>"},{"location":"dev-guide/quality-and-operations/17-release-versioning/","title":"\ud83e\uddfe 17. Release Versioning \u2013 Quy \u01b0\u1edbc \u0110\u00e1nh s\u1ed1 Phi\u00ean b\u1ea3n &amp; Qu\u1ea3n l\u00fd Release","text":"<p>T\u00e0i li\u1ec7u n\u00e0y h\u01b0\u1edbng d\u1eabn c\u00e1ch \u0111\u00e1nh version, ghi ch\u00fa release v\u00e0 qu\u1ea3n l\u00fd s\u1ef1 \u0111\u1ed3ng b\u1ed9 gi\u1eefa c\u00e1c th\u00e0nh ph\u1ea7n (API, Event, Container) trong h\u1ec7 th\u1ed1ng DX-VAS, nh\u1eb1m \u0111\u1ea3m b\u1ea3o m\u1ecdi thay \u0111\u1ed5i \u0111\u1ec1u r\u00f5 r\u00e0ng, c\u00f3 th\u1ec3 truy v\u1ebft v\u00e0 kh\u00f4ng ph\u00e1 v\u1ee1 backward compatibility m\u1ed9t c\u00e1ch v\u00f4 \u00fd.</p>"},{"location":"dev-guide/quality-and-operations/17-release-versioning/#1-muc-tieu","title":"1. \ud83c\udfaf M\u1ee5c ti\u00eau","text":"<ul> <li>D\u1ec5 d\u00e0ng theo d\u00f5i l\u1ecbch s\u1eed ph\u00e1t h\u00e0nh, rollback ho\u1eb7c audit sau n\u00e0y.</li> <li>\u0110\u1ed3ng b\u1ed9 gi\u1eefa c\u00e1c team Backend \u2013 Frontend \u2013 DevOps \u2013 QA.</li> <li>Tu\u00e2n th\u1ee7 chu\u1ea9n Semantic Versioning \u0111\u1ec3 ph\u00e2n bi\u1ec7t r\u00f5 t\u00ednh ch\u1ea5t thay \u0111\u1ed5i.</li> </ul>"},{"location":"dev-guide/quality-and-operations/17-release-versioning/#2-quy-tac-anh-so-phien-ban-semantic-versioning","title":"2. \ud83d\udd22 Quy t\u1eafc \u0110\u00e1nh s\u1ed1 Phi\u00ean b\u1ea3n (Semantic Versioning)","text":"<p>D\u1ea1ng chu\u1ea9n: <pre><code>v&lt;MAJOR&gt;.&lt;MINOR&gt;.&lt;PATCH&gt;\n</code></pre></p> Th\u00e0nh ph\u1ea7n \u00dd ngh\u0129a Khi n\u00e0o thay \u0111\u1ed5i <code>MAJOR</code> Thay \u0111\u1ed5i ph\u00e1 v\u1ee1 t\u01b0\u01a1ng th\u00edch (breaking change) Th\u00eam/s\u1eeda/xo\u00e1 field trong API, event, schema... <code>MINOR</code> T\u00ednh n\u0103ng m\u1edbi, t\u01b0\u01a1ng th\u00edch ng\u01b0\u1ee3c (backward-compatible) Th\u00eam API m\u1edbi, field m\u1edbi <code>PATCH</code> S\u1eeda l\u1ed7i, c\u1ea3i ti\u1ebfn nh\u1ecf kh\u00f4ng thay \u0111\u1ed5i contract Fix bug, t\u1ed1i \u01b0u hi\u1ec7u n\u0103ng <p>V\u00ed d\u1ee5: - <code>v1.0.0</code>: b\u1ea3n release \u0111\u1ea7u ti\u00ean - <code>v1.1.0</code>: th\u00eam API m\u1edbi - <code>v2.0.0</code>: xo\u00e1 field c\u0169 kh\u00f4ng d\u00f9ng n\u1eefa \u2192 breaking change</p>"},{"location":"dev-guide/quality-and-operations/17-release-versioning/#3-version-trong-container-openapi","title":"3. \ud83d\udce6 Version trong Container &amp; OpenAPI","text":"<ul> <li>M\u1ed7i Docker image ph\u1ea3i c\u00f3 2 tag:</li> <li><code>vas-user-service:v1.2.0</code></li> <li><code>vas-user-service:latest</code> (tr\u1ecf v\u1ec1 b\u1ea3n m\u1edbi nh\u1ea5t)</li> <li>OpenAPI file (<code>openapi.yaml</code>) ph\u1ea3i c\u00f3 version r\u00f5 r\u00e0ng:</li> </ul> <pre><code>info:\n  title: User Service API\n  version: 1.2.0\n</code></pre> <ul> <li>Contract test d\u00f9ng <code>openapi.version</code> \u0111\u1ec3 ki\u1ec3m tra schema \u0111\u00fang version.</li> </ul>"},{"location":"dev-guide/quality-and-operations/17-release-versioning/#4-version-cho-event-schema","title":"4. \ud83d\udce3 Version cho Event Schema","text":"<ul> <li>M\u1ed7i event ph\u1ea3i khai b\u00e1o <code>meta.version</code>:</li> </ul> <pre><code>{\n  \"event\": \"user.created\",\n  \"meta\": {\n    \"version\": \"1.0.0\",\n    \"timestamp\": \"...\"\n  },\n  \"payload\": { ... }\n}\n</code></pre> <ul> <li> <p>N\u1ebfu thay \u0111\u1ed5i schema, ph\u1ea3i bump:</p> </li> <li> <p><code>PATCH</code> n\u1ebfu th\u00eam field kh\u00f4ng \u1ea3nh h\u01b0\u1edfng consumer</p> </li> <li><code>MAJOR</code> n\u1ebfu \u0111\u1ed5i t\u00ean/xo\u00e1 field \u2192 c\u1ea7n th\u00f4ng b\u00e1o migration</li> </ul>"},{"location":"dev-guide/quality-and-operations/17-release-versioning/#5-release-note-tag-git","title":"5. \ud83d\udcdd Release Note &amp; Tag Git","text":"<ul> <li> <p>M\u1ed7i b\u1ea3n release l\u00ean Production ph\u1ea3i:</p> </li> <li> <p>T\u1ea1o Git Tag: <code>v1.3.0</code></p> </li> <li>T\u1ea1o GitHub Release Note (changelog)</li> <li>G\u1eafn link changelog v\u00e0o Wiki ho\u1eb7c Slack</li> <li>M\u1eabu changelog:</li> </ul> <pre><code>## v1.3.0 (2025-06-06)\n- \u2728 Th\u00eam API `GET /notifications/{id}`\n- \ud83d\udee0\ufe0f Fix l\u1ed7i ph\u00e2n trang b\u1ecb sai \u1edf `/users`\n- \ud83d\udd10 B\u1ecf field `password_plain` (breaking)\n</code></pre>"},{"location":"dev-guide/quality-and-operations/17-release-versioning/#6-khi-nao-can-bump-major","title":"6. \u26a0\ufe0f Khi n\u00e0o c\u1ea7n bump MAJOR?","text":"Thay \u0111\u1ed5i C\u00f3 c\u1ea7n MAJOR kh\u00f4ng? Th\u00eam field m\u1edbi v\u00e0o API response \u274c MINOR \u0110\u1ed5i t\u00ean tr\u01b0\u1eddng trong payload \u2705 MAJOR Xo\u00e1 API c\u0169 kh\u00f4ng d\u00f9ng n\u1eefa \u2705 MAJOR S\u1eeda l\u1ed7i trong x\u1eed l\u00fd logic \u274c PATCH B\u1ed5 sung enum m\u1edbi (backward-compatible) \u274c MINOR \u0110\u1ed5i ki\u1ec3u d\u1eef li\u1ec7u (string \u2192 int) \u2705 MAJOR"},{"location":"dev-guide/quality-and-operations/17-release-versioning/#7-kiem-thu-tuong-thich-backward-compatibility","title":"7. \ud83e\uddea Ki\u1ec3m th\u1eed T\u01b0\u01a1ng th\u00edch (Backward Compatibility)","text":"<ul> <li> <p>M\u1ed7i khi release:</p> </li> <li> <p>Contract test s\u1ebd so s\u00e1nh schema m\u1edbi v\u1edbi schema version tr\u01b0\u1edbc</p> </li> <li>N\u1ebfu ph\u00e1t hi\u1ec7n breaking \u2192 CI s\u1ebd c\u1ea3nh b\u00e1o v\u00e0 y\u00eau c\u1ea7u MAJOR bump</li> <li>Pub/Sub consumer ph\u1ea3i support version fallback n\u1ebfu c\u00f3 kh\u1ea3 n\u0103ng.</li> </ul>"},{"location":"dev-guide/quality-and-operations/17-release-versioning/#8-nhung-ieu-khong-nen-lam","title":"8. \ud83d\udeab Nh\u1eefng \u0111i\u1ec1u kh\u00f4ng n\u00ean l\u00e0m","text":"<ul> <li>\u274c Kh\u00f4ng tag version n\u1ebfu ch\u01b0a c\u00f3 release note r\u00f5 r\u00e0ng</li> <li>\u274c Kh\u00f4ng overwrite Docker tag <code>v1.2.0</code> \u2192 tag ph\u1ea3i b\u1ea5t bi\u1ebfn</li> <li>\u274c Kh\u00f4ng deploy b\u1ea3n <code>dev</code> v\u00e0o Production</li> <li>\u274c Kh\u00f4ng c\u1eadp nh\u1eadt OpenAPI version b\u1eb1ng tay n\u1ebfu ch\u01b0a release</li> </ul> <p>\ud83d\udccc Ghi nh\u1edb: M\u1ed9t h\u1ec7 th\u1ed1ng c\u00f3 versioning r\u00f5 r\u00e0ng s\u1ebd gi\u00fap gi\u1ea3m xung \u0111\u1ed9t gi\u1eefa c\u00e1c team, rollback d\u1ec5 d\u00e0ng v\u00e0 t\u0103ng ni\u1ec1m tin v\u1edbi kh\u00e1ch h\u00e0ng.</p>"},{"location":"dev-guide/specialized-guides/10-frontend-guide/","title":"\ud83c\udfa8 10. Frontend Development Guide \u2013 H\u01b0\u1edbng d\u1eabn Ph\u00e1t tri\u1ec3n Frontend","text":"<p>T\u00e0i li\u1ec7u n\u00e0y quy \u0111\u1ecbnh c\u00e1c ti\u00eau chu\u1ea9n v\u00e0 th\u1ef1c h\u00e0nh t\u1ed1t cho vi\u1ec7c ph\u00e1t tri\u1ec3n frontend (web app) trong h\u1ec7 th\u1ed1ng DX-VAS. M\u1ee5c ti\u00eau l\u00e0 \u0111\u1ea3m b\u1ea3o m\u1ecdi frontend th\u1ed1ng nh\u1ea5t v\u1ec1 UI/UX, b\u1ea3o m\u1eadt, hi\u1ec7u su\u1ea5t v\u00e0 d\u1ec5 b\u1ea3o tr\u00ec.</p>"},{"location":"dev-guide/specialized-guides/10-frontend-guide/#1-kien-truc-frontend","title":"1. \ud83e\uddf1 Ki\u1ebfn tr\u00fac Frontend","text":"<ul> <li>S\u1eed d\u1ee5ng React + TypeScript l\u00e0m framework ch\u00ednh.</li> <li>Qu\u1ea3n l\u00fd state b\u1eb1ng Zustand ho\u1eb7c React Query:</li> <li><code>Zustand</code>: d\u00f9ng cho state \u1ee9ng d\u1ee5ng \u0111\u01a1n gi\u1ea3n, nh\u1eb9, d\u1ec5 m\u1edf r\u1ed9ng.</li> <li><code>React Query</code>: d\u00f9ng cho state li\u00ean quan \u0111\u1ebfn remote data (API call, caching).</li> <li> <p>Kh\u00f4ng d\u00f9ng Redux tr\u1eeb khi th\u1ef1c s\u1ef1 c\u1ea7n:</p> <p>Ch\u1ec9 d\u00f9ng Redux khi \u1ee9ng d\u1ee5ng c\u00f3 state to\u00e0n c\u1ee5c ph\u1ee9c t\u1ea1p, nhi\u1ec1u lu\u1ed3ng t\u01b0\u01a1ng t\u00e1c ch\u00e9o gi\u1eefa c\u00e1c domain \u0111\u1ed9c l\u1eadp (v\u00ed d\u1ee5: dashboard \u0111\u1ed9ng v\u1edbi nhi\u1ec1u widget t\u01b0\u01a1ng t\u00e1c \u0111\u1ed3ng th\u1eddi, h\u1ec7 th\u1ed1ng drag &amp; drop nhi\u1ec1u t\u1ea7ng ph\u1ee5 thu\u1ed9c).</p> </li> <li> <p>T\u1ed5 ch\u1ee9c th\u01b0 m\u1ee5c theo domain (feature-based) \u0111\u1ec3 d\u1ec5 m\u1edf r\u1ed9ng:</p> </li> </ul> <pre><code>src/\n\u251c\u2500\u2500 features/\n\u2502   \u251c\u2500\u2500 users/\n\u2502   \u2514\u2500\u2500 auth/\n\u251c\u2500\u2500 components/\n\u251c\u2500\u2500 hooks/\n\u251c\u2500\u2500 services/\n\u2514\u2500\u2500 utils/\n</code></pre>"},{"location":"dev-guide/specialized-guides/10-frontend-guide/#2-uiux-design-system","title":"2. \ud83c\udfa8 UI/UX Design System","text":"<ul> <li>\u01afu ti\u00ean s\u1eed d\u1ee5ng th\u01b0 vi\u1ec7n shadcn/ui k\u1ebft h\u1ee3p Tailwind CSS.</li> <li>C\u00e1c component \u0111\u1ec1u ph\u1ea3i responsive (desktop/tablet/mobile).</li> <li>T\u00ean class Tailwind ng\u1eafn g\u1ecdn, c\u00f3 comment khi styling ph\u1ee9c t\u1ea1p.</li> <li>\u00c1p d\u1ee5ng thi\u1ebft k\u1ebf chu\u1ea9n theo file Figma \u0111\u00e3 duy\u1ec7t t\u1eeb UI/UX Team.</li> </ul>"},{"location":"dev-guide/specialized-guides/10-frontend-guide/#3-quan-ly-api-auth","title":"3. \ud83d\udce6 Qu\u1ea3n l\u00fd API &amp; Auth","text":"<ul> <li>S\u1eed d\u1ee5ng <code>axios</code> ho\u1eb7c <code>fetch</code> wrapper trong <code>services/axios.ts</code>.</li> <li>M\u1ecdi request ph\u1ea3i:</li> <li>T\u1ef1 \u0111\u1ed9ng \u0111\u00ednh k\u00e8m <code>Authorization: Bearer &lt;JWT&gt;</code></li> <li>T\u1ef1 \u0111\u1ed9ng g\u1eafn <code>X-Request-ID</code> (n\u1ebfu c\u00f3)</li> <li>Retry th\u00f4ng minh n\u1ebfu l\u1ed7i m\u1ea1ng (401, 429)</li> </ul> <pre><code>axiosInstance.interceptors.request.use((config) =&gt; {\n  config.headers['Authorization'] = `Bearer ${token}`;\n  config.headers['X-Request-ID'] = uuid();\n  return config;\n});\n</code></pre> <ul> <li> <p>X\u1eed l\u00fd l\u1ed7i API th\u1ed1ng nh\u1ea5t:</p> </li> <li> <p>S\u1eed d\u1ee5ng <code>axios interceptor</code> \u0111\u1ec3 chu\u1ea9n h\u00f3a x\u1eed l\u00fd l\u1ed7i theo chu\u1ea9n <code>ErrorEnvelope</code> t\u1eeb ADR-011.</p> </li> <li>Hi\u1ec3n th\u1ecb l\u1ed7i cho ng\u01b0\u1eddi d\u00f9ng b\u1eb1ng toast/modal theo lo\u1ea1i l\u1ed7i (<code>VALIDATION_ERROR</code>, <code>UNAUTHORIZED</code>, <code>FORBIDDEN</code>, ...)</li> <li>Log <code>request_id</code> v\u00e0o console \u0111\u1ec3 h\u1ed7 tr\u1ee3 trace l\u1ed7i d\u1ec5 d\u00e0ng.</li> </ul> <pre><code>axiosInstance.interceptors.response.use(\n  (res) =&gt; res,\n  (error) =&gt; {\n    const err = error.response?.data?.error;\n    const meta = error.response?.data?.meta;\n\n    if (err?.code === 'UNAUTHORIZED') {\n      toast.error('B\u1ea1n c\u1ea7n \u0111\u0103ng nh\u1eadp l\u1ea1i.');\n    } else if (err?.code === 'VALIDATION_ERROR') {\n      toast.error(err.message || 'D\u1eef li\u1ec7u kh\u00f4ng h\u1ee3p l\u1ec7');\n    } else {\n      toast.error('C\u00f3 l\u1ed7i x\u1ea3y ra. M\u00e3 truy v\u1ebft: ' + meta?.request_id);\n    }\n\n    return Promise.reject(error);\n  }\n);\n</code></pre>"},{"location":"dev-guide/specialized-guides/10-frontend-guide/#4-bao-mat-phan-quyen-rbac","title":"4. \ud83d\udd10 B\u1ea3o m\u1eadt &amp; Ph\u00e2n quy\u1ec1n (RBAC)","text":"<ul> <li>\u1ea8n/hi\u1ec7n component theo <code>permissions</code> l\u1ea5y t\u1eeb token \u0111\u00e3 decode.</li> <li>Kh\u00f4ng hi\u1ec3n th\u1ecb UI n\u1ebfu user kh\u00f4ng c\u00f3 quy\u1ec1n (thay v\u00ec disable).</li> <li>C\u00e1c route c\u1ea7n \u0111\u01b0\u1ee3c ki\u1ec3m tra <code>permission</code> tr\u01b0\u1edbc khi render layout.</li> </ul> <pre><code>if (!user.permissions.includes('user.create')) {\n  return &lt;Navigate to=\"/403\" /&gt;;\n}\n</code></pre>"},{"location":"dev-guide/specialized-guides/10-frontend-guide/#5-testing-frontend","title":"5. \ud83e\uddea Testing Frontend","text":"Lo\u1ea1i test Tool d\u00f9ng Ghi ch\u00fa Unit test <code>vitest</code>, <code>jest</code> Test component, logic nh\u1ecf Integration <code>testing-library/react</code> Test flow nhi\u1ec1u component E2E test <code>Playwright</code> ho\u1eb7c <code>Cypress</code> Ch\u1ea1y qua UI th\u1ef1c t\u1ebf"},{"location":"dev-guide/specialized-guides/10-frontend-guide/#6-format-lint-ci","title":"6. \ud83e\uddf9 Format, Lint &amp; CI","text":"<ul> <li>D\u00f9ng <code>prettier</code> cho format v\u00e0 <code>eslint</code> cho ki\u1ec3m tra quy \u01b0\u1edbc.</li> <li>C\u1ea5u h\u00ecnh n\u1eb1m trong <code>.eslintrc.js</code>, <code>.prettierrc</code>, <code>.editorconfig</code>.</li> <li>T\u1ef1 \u0111\u1ed9ng ch\u1ea1y lint khi commit:</li> </ul> <pre><code>npm run lint\nnpm run format\n</code></pre>"},{"location":"dev-guide/specialized-guides/10-frontend-guide/#7-env-config","title":"7. \u2699\ufe0f Env &amp; Config","text":"<ul> <li>\u0110\u1eb7t bi\u1ebfn m\u00f4i tr\u01b0\u1eddng trong <code>.env.local</code>, v\u00ed d\u1ee5:</li> </ul> <pre><code>VITE_API_URL=http://localhost:8001\nVITE_AUTH_DOMAIN=auth.dx-vas.edu.vn\n</code></pre> <ul> <li>Kh\u00f4ng commit file <code>.env.local</code>, ch\u1ec9 gi\u1eef <code>.env.example</code>.</li> </ul>"},{"location":"dev-guide/specialized-guides/10-frontend-guide/#8-ux-best-practices","title":"8. \ud83e\udde0 UX Best Practices","text":"<ul> <li>Hi\u1ec3n th\u1ecb spinner r\u00f5 r\u00e0ng khi \u0111ang loading d\u1eef li\u1ec7u.</li> <li>Th\u00f4ng b\u00e1o l\u1ed7i c\u1ea7n c\u1ee5 th\u1ec3, d\u1ec5 hi\u1ec3u (d\u00f9ng toast, modal).</li> <li>Tr\u00e1nh nested modal ho\u1eb7c multi-level popup.</li> <li>\u01afu ti\u00ean \u201ct\u1ed1i gi\u1ea3n \u2013 d\u1ec5 d\u00f9ng \u2013 mobile-first\u201d.</li> </ul>"},{"location":"dev-guide/specialized-guides/10-frontend-guide/#9-nhung-ieu-khong-uoc-lam","title":"9. \ud83d\uded1 Nh\u1eefng \u0111i\u1ec1u kh\u00f4ng \u0111\u01b0\u1ee3c l\u00e0m","text":"<ul> <li>\u274c Kh\u00f4ng g\u1ecdi API tr\u1ef1c ti\u1ebfp trong component \u2013 lu\u00f4n d\u00f9ng service layer.</li> <li>\u274c Kh\u00f4ng hard-code URL ho\u1eb7c ID \u2013 s\u1eed d\u1ee5ng bi\u1ebfn m\u00f4i tr\u01b0\u1eddng v\u00e0 config file.</li> <li>\u274c Kh\u00f4ng commit console.log ho\u1eb7c TODO l\u00ean <code>dev</code> ho\u1eb7c <code>main</code>.</li> <li>\u274c Kh\u00f4ng reload to\u00e0n b\u1ed9 trang tr\u1eeb khi logout ho\u1eb7c redirect b\u1eaft bu\u1ed9c.</li> </ul> <p>\ud83d\udccc Ghi nh\u1edb: Frontend kh\u00f4ng ch\u1ec9 l\u00e0 \"hi\u1ec3n th\u1ecb UI\" \u2013 \u0111\u00f3 l\u00e0 tr\u1ea3i nghi\u1ec7m ng\u01b0\u1eddi d\u00f9ng, s\u1ef1 li\u1ec1n m\u1ea1ch, v\u00e0 uy t\u00edn c\u1ee7a h\u1ec7 th\u1ed1ng DX-VAS trong m\u1eaft gi\u00e1o vi\u00ean, ph\u1ee5 huynh v\u00e0 h\u1ecdc sinh.</p>"},{"location":"dev-guide/technical-guides/04-api-development/","title":"\ud83d\udd27 04. API Development \u2013 H\u01b0\u1edbng d\u1eabn Ph\u00e1t tri\u1ec3n API","text":"<p>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 c\u00e1c quy t\u1eafc v\u00e0 quy tr\u00ecnh chu\u1ea9n \u0111\u1ec3 thi\u1ebft k\u1ebf, tri\u1ec3n khai v\u00e0 ki\u1ec3m th\u1eed API trong h\u1ec7 th\u1ed1ng DX-VAS, \u0111\u1ea3m b\u1ea3o tu\u00e2n th\u1ee7 c\u00e1c ADR v\u00e0 chu\u1ea9n 5\u2b50 \u0111\u00e3 ban h\u00e0nh.</p>"},{"location":"dev-guide/technical-guides/04-api-development/#1-thiet-ke-api-theo-nguyen-tac-contract-first","title":"1. \ud83d\udcd0 Thi\u1ebft k\u1ebf API theo nguy\u00ean t\u1eafc \"Contract First\"","text":"<ul> <li>Lu\u00f4n vi\u1ebft <code>interface-contract.md</code> v\u00e0 <code>openapi.yaml</code> tr\u01b0\u1edbc khi b\u1eaft \u0111\u1ea7u code.</li> <li>C\u00e1c th\u00e0nh ph\u1ea7n b\u1eaft bu\u1ed9c ph\u1ea3i c\u00f3 trong file OpenAPI:</li> <li><code>info</code>, <code>servers</code>, <code>tags</code>, <code>securitySchemes</code></li> <li><code>components/schemas</code> \u0111\u1ea7y \u0111\u1ee7 m\u00f4 t\u1ea3 (<code>description</code>, <code>example</code>)</li> <li><code>x-required-permission</code>, <code>x-emits-event</code>, <code>x-audit-action</code> n\u1ebfu \u00e1p d\u1ee5ng</li> <li>Tu\u00e2n th\u1ee7 ADR-011 - API Error Format v\u00e0 ADR-012 - Response Structure</li> </ul>"},{"location":"dev-guide/technical-guides/04-api-development/#2-quy-uoc-endpoint-va-path","title":"2. \ud83d\udcce Quy \u01b0\u1edbc Endpoint v\u00e0 Path","text":"<ul> <li>S\u1eed d\u1ee5ng danh t\u1eeb s\u1ed1 nhi\u1ec1u (plural nouns):   \u2705 <code>/users</code>, <code>/notifications</code>, <code>/templates</code></li> <li>C\u00e1c thao t\u00e1c \u0111\u1eb7c bi\u1ec7t n\u00ean d\u00f9ng <code>/action</code> \u1edf POST body:   \u2705 <code>POST /users/reset-password</code></li> <li>V\u1edbi resource c\u1ee5 th\u1ec3:   \u2705 <code>GET /users/{id}</code>, <code>PUT /templates/{id}</code></li> </ul> <p>Tham kh\u1ea3o: ADR-013 - Path Naming Convention</p>"},{"location":"dev-guide/technical-guides/04-api-development/#3-header-request-chuan","title":"3. \ud83e\uddfe Header &amp; Request chu\u1ea9n","text":"<ul> <li>B\u1eaft bu\u1ed9c c\u00e1c header:</li> <li><code>Authorization: Bearer &lt;JWT&gt;</code> \u2013 tr\u1eeb c\u00e1c public API</li> <li><code>X-Request-ID</code> \u2013 t\u1ef1 \u0111\u1ed9ng sinh \u1edf Gateway n\u1ebfu ch\u01b0a c\u00f3</li> <li><code>X-Tenant-ID</code> \u2013 b\u1eaft bu\u1ed9c n\u1ebfu service h\u1ed7 tr\u1ee3 multi-tenant</li> <li>V\u1edbi <code>GET</code> kh\u00f4ng bao gi\u1edd \u0111\u01b0\u1ee3c d\u00f9ng <code>requestBody</code></li> <li>Pagination: d\u00f9ng <code>page</code> v\u00e0 <code>limit</code> l\u00e0 query parameter chu\u1ea9n</li> </ul>"},{"location":"dev-guide/technical-guides/04-api-development/#4-response-chuan-loi","title":"4. \ud83d\udce4 Response chu\u1ea9n &amp; l\u1ed7i","text":"<ul> <li>T\u1ea5t c\u1ea3 response b\u1ecdc trong object c\u00f3 2 field:</li> <li><code>data</code>: k\u1ebft qu\u1ea3 ch\u00ednh</li> <li><code>meta</code>: metadata (timestamp, request_id\u2026)</li> </ul> <pre><code>{\n  \"data\": { ... },\n  \"meta\": {\n    \"request_id\": \"req-123\",\n    \"timestamp\": \"2025-06-05T10:00:00Z\"\n  }\n}\n</code></pre> <ul> <li>L\u1ed7i ph\u1ea3i d\u00f9ng chu\u1ea9n <code>ErrorEnvelope</code>:</li> </ul> <pre><code>{\n  \"error\": {\n    \"code\": \"VALIDATION_ERROR\",\n    \"message\": \"Tr\u01b0\u1eddng email kh\u00f4ng h\u1ee3p l\u1ec7\"\n  },\n  \"meta\": {\n    \"request_id\": \"req-456\",\n    \"timestamp\": \"2025-06-05T10:01:23Z\"\n  }\n}\n</code></pre>"},{"location":"dev-guide/technical-guides/04-api-development/#5-phan-quyen-rbac","title":"5. \ud83d\udd10 Ph\u00e2n quy\u1ec1n (RBAC)","text":"<ul> <li>M\u1ed7i endpoint ph\u1ea3i ch\u1ec9 \u0111\u1ecbnh r\u00f5:</li> </ul> <p><pre><code>x-required-permission: notification.template.read\n</code></pre> * Middleware s\u1ebd validate <code>permission</code> c\u1ee7a user trong JWT * N\u1ebfu endpoint ch\u1ec9 audit m\u00e0 kh\u00f4ng c\u1ea7n permission, th\u00eam <code>x-audit-action</code> nh\u01b0ng kh\u00f4ng c\u1ea7n <code>x-required-permission</code></p>"},{"location":"dev-guide/technical-guides/04-api-development/#6-su-kien-event-emission","title":"6. \ud83d\udce3 S\u1ef1 ki\u1ec7n (Event Emission)","text":"<ul> <li>N\u1ebfu API t\u1ea1o ra s\u1ef1 ki\u1ec7n, c\u1ea7n ch\u1ec9 r\u00f5:</li> </ul> <p><pre><code>x-emits-event:\n  - global_notification_requested\n</code></pre> * T\u00ean s\u1ef1 ki\u1ec7n ph\u1ea3i \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong <code>data-model.md</code> v\u00e0 mapping trong schema pub/sub * Lu\u00f4n \u0111\u1eb7t m\u00e3 <code>event_id</code>, <code>source</code>, <code>timestamp</code> trong payload s\u1ef1 ki\u1ec7n</p>"},{"location":"dev-guide/technical-guides/04-api-development/#7-kiem-thu-api","title":"7. \ud83e\uddea Ki\u1ec3m th\u1eed API","text":"<ul> <li> <p>Vi\u1ebft test cho:</p> </li> <li> <p>Logic x\u1eed l\u00fd (unit)</p> </li> <li>T\u00ednh \u0111\u00fang schema v\u00e0 response (integration)</li> <li>Ki\u1ec3m th\u1eed c\u1ea3 m\u00e3 l\u1ed7i 400/403/500</li> <li>C\u00f3 th\u1ec3 d\u00f9ng OpenAPI validator \u0111\u1ec3 ki\u1ec3m tra contract</li> <li>\u0110\u1ea3m b\u1ea3o t\u1ea5t c\u1ea3 service \u0111\u1ea1t <code>coverage &gt; 80%</code></li> </ul> <p>\ud83d\udccc T\u00e0i li\u1ec7u n\u00e0y l\u00e0 b\u1eaft bu\u1ed9c \u0111\u1ed1i v\u1edbi m\u1ecdi backend developer. M\u1ecdi API sai chu\u1ea9n s\u1ebd kh\u00f4ng \u0111\u01b0\u1ee3c merge v\u00e0o <code>dev</code>.</p>"},{"location":"dev-guide/technical-guides/05-database-and-migrations/","title":"\ud83d\udee2\ufe0f 05. Database &amp; Migrations \u2013 H\u01b0\u1edbng d\u1eabn L\u00e0m vi\u1ec7c v\u1edbi CSDL","text":"<p>T\u00e0i li\u1ec7u n\u00e0y h\u01b0\u1edbng d\u1eabn c\u00e1ch thi\u1ebft k\u1ebf, qu\u1ea3n l\u00fd v\u00e0 tri\u1ec3n khai schema CSDL trong h\u1ec7 th\u1ed1ng DX-VAS, tu\u00e2n th\u1ee7 chu\u1ea9n 5\u2b50 v\u00e0 c\u00e1c ADR li\u00ean quan \u0111\u1ebfn d\u1eef li\u1ec7u.</p>"},{"location":"dev-guide/technical-guides/05-database-and-migrations/#1-triet-ly-thiet-ke-du-lieu","title":"1. \ud83e\udde0 Tri\u1ebft l\u00fd Thi\u1ebft k\u1ebf D\u1eef li\u1ec7u","text":"<ul> <li>M\u1ecdi b\u1ea3ng ph\u1ea3i \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a r\u00f5 r\u00e0ng trong <code>data-model.md</code>, bao g\u1ed3m:</li> <li>C\u1ea5u tr\u00fac b\u1ea3ng: c\u1ed9t, ki\u1ec3u d\u1eef li\u1ec7u, r\u00e0ng bu\u1ed9c</li> <li>Quan h\u1ec7 (FK), ch\u1ec9 m\u1ee5c (index), enum m\u1edf r\u1ed9ng (n\u1ebfu c\u00f3)</li> <li>Ghi r\u00f5 lifecycle &amp; retention (n\u1ebfu c\u00f3)</li> <li>Kh\u00f4ng tr\u1ef1c ti\u1ebfp ch\u1ec9nh s\u1eeda DB b\u1eb1ng tay \u2013 m\u1ecdi thay \u0111\u1ed5i ph\u1ea3i th\u00f4ng qua migration.</li> </ul>"},{"location":"dev-guide/technical-guides/05-database-and-migrations/#2-quy-tac-at-ten-chuan-hoa","title":"2. \ud83d\udcd0 Quy t\u1eafc \u0110\u1eb7t T\u00ean &amp; Chu\u1ea9n h\u00f3a","text":"<ul> <li>B\u1ea3ng d\u00f9ng snake_case, danh t\u1eeb s\u1ed1 nhi\u1ec1u: <code>users</code>, <code>notification_logs</code></li> <li>Enum n\u00ean \u0111\u01b0\u1ee3c l\u01b0u trong b\u1ea3ng ph\u1ee5 tr\u1ee3 (<code>channel_types</code>, <code>log_statuses</code>)</li> <li>T\u00ean c\u1ed9t nh\u1ea5t qu\u00e1n: <code>created_at</code>, <code>updated_at</code>, <code>deleted_at</code>, <code>version</code></li> <li>D\u00f9ng <code>uuid</code> l\u00e0m <code>primary key</code>, kh\u00f4ng d\u00f9ng <code>serial</code></li> </ul> <p>Tham kh\u1ea3o: ADR-023 - Schema Migration Strategy</p>"},{"location":"dev-guide/technical-guides/05-database-and-migrations/#3-quan-ly-migration","title":"3. \ud83d\uddc2\ufe0f Qu\u1ea3n l\u00fd Migration","text":"<ul> <li>D\u00f9ng Alembic cho Python service ho\u1eb7c t\u01b0\u01a1ng \u0111\u01b0\u01a1ng v\u1edbi Node.js (<code>knex</code>, <code>typeorm</code>, <code>prisma</code>, ...)</li> <li>Migration ph\u1ea3i \u0111\u01b0\u1ee3c l\u01b0u trong th\u01b0 m\u1ee5c: <pre><code>services/&lt;service-name&gt;/migrations/\n</code></pre></li> <li> <p>M\u1ed7i migration n\u00ean c\u00f3 t\u00ean m\u00f4 t\u1ea3: <pre><code>20240601\\_add\\_notification\\_logs\\_table.py\n</code></pre></p> </li> <li> <p>L\u1ec7nh t\u1ea1o migration m\u1eabu (Alembic): <pre><code>poetry run alembic revision -m \"add processed_events table\"\n</code></pre></p> </li> <li> <p>L\u1ec7nh ch\u1ea1y migration:</p> </li> </ul> <pre><code>poetry run alembic upgrade head\n</code></pre>"},{"location":"dev-guide/technical-guides/05-database-and-migrations/#4-ghi-chu-khi-thiet-ke-bang","title":"4. \ud83d\udccb Ghi ch\u00fa Khi Thi\u1ebft k\u1ebf B\u1ea3ng","text":"<ul> <li>Lu\u00f4n th\u00eam <code>created_at</code>, <code>updated_at</code> v\u1edbi m\u1eb7c \u0111\u1ecbnh <code>timezone.now()</code></li> <li> <p>C\u00e1c b\u1ea3ng quan tr\u1ecdng c\u1ea7n c\u00f3:</p> </li> <li> <p><code>is_deleted</code> ho\u1eb7c <code>deleted_at</code> n\u1ebfu h\u1ed7 tr\u1ee3 soft delete</p> </li> <li><code>version</code> \u0111\u1ec3 h\u1ed7 tr\u1ee3 optimistic locking</li> <li>Th\u00eam ch\u1ec9 m\u1ee5c cho c\u00e1c tr\u01b0\u1eddng truy v\u1ea5n nhi\u1ec1u: <code>user_id</code>, <code>status</code>, <code>created_at DESC</code></li> </ul>"},{"location":"dev-guide/technical-guides/05-database-and-migrations/#5-chien-luoc-lifecycle-retention","title":"5. \ud83d\udcc9 Chi\u1ebfn l\u01b0\u1ee3c Lifecycle &amp; Retention","text":"<ul> <li>Ghi r\u00f5 th\u1eddi gian gi\u1eef li\u1ec7u (VD: <code>notification_logs</code> gi\u1eef 180 ng\u00e0y)</li> <li> <p>D\u1eef li\u1ec7u l\u00e2u ng\u00e0y c\u1ea7n d\u1ecdn d\u1eb9p b\u1eb1ng:</p> </li> <li> <p>Batch job ho\u1eb7c cron</p> </li> <li>Rule SQL: <code>DELETE WHERE created_at &lt; NOW() - interval '180 days'</code></li> <li>Tham kh\u1ea3o: ADR-024 - Data Anonymization &amp; Retention</li> </ul>"},{"location":"dev-guide/technical-guides/05-database-and-migrations/#6-khong-bao-gio","title":"6. \ud83d\udea8 Kh\u00f4ng Bao gi\u1edd","text":"<ul> <li>Kh\u00f4ng s\u1eeda schema b\u1eb1ng <code>psql</code> tr\u1ef1c ti\u1ebfp</li> <li>Kh\u00f4ng xo\u00e1 migration c\u0169 \u0111\u00e3 merge</li> <li>Kh\u00f4ng t\u1ea1o migration g\u00e2y breaking change m\u00e0 kh\u00f4ng c\u00f3 plan migration d\u1eef li\u1ec7u (backfill)</li> </ul>"},{"location":"dev-guide/technical-guides/05-database-and-migrations/#7-testing-db","title":"7. \ud83e\uddea Testing DB","text":"<ul> <li>T\u1ea1o <code>test_db</code> ri\u00eang bi\u1ec7t v\u1edbi prefix <code>test_</code></li> <li>Ch\u1ea1y migration tr\u00ean DB test trong pipeline CI</li> <li>D\u1ecdn d\u1eb9p DB sau m\u1ed7i test \u0111\u1ec3 tr\u00e1nh d\u1eef li\u1ec7u d\u01b0</li> </ul> <p>\ud83d\udccc M\u1ecdi thay \u0111\u1ed5i CSDL \u0111\u1ec1u ph\u1ea3i c\u00f3 migration, c\u1eadp nh\u1eadt <code>data-model.md</code> v\u00e0 \u0111\u01b0\u1ee3c review k\u1ef9 l\u01b0\u1ee1ng. N\u1ebfu c\u00f3 \u1ea3nh h\u01b0\u1edfng t\u1edbi schema chung (shared schema), c\u1ea7n t\u1ea1o th\u00eam ADR.</p>"},{"location":"dev-guide/technical-guides/06-event-driven-development/","title":"\ud83d\udcec 06. Event-Driven Development \u2013 H\u01b0\u1edbng d\u1eabn Ph\u00e1t tri\u1ec3n theo Ki\u1ebfn tr\u00fac S\u1ef1 ki\u1ec7n","text":"<p>T\u00e0i li\u1ec7u n\u00e0y h\u01b0\u1edbng d\u1eabn c\u00e1ch thi\u1ebft k\u1ebf, ph\u00e1t h\u00e0nh v\u00e0 x\u1eed l\u00fd s\u1ef1 ki\u1ec7n (event) trong h\u1ec7 th\u1ed1ng DX-VAS. M\u1ee5c ti\u00eau l\u00e0 \u0111\u1ea3m b\u1ea3o c\u00e1c service giao ti\u1ebfp th\u00f4ng qua Pub/Sub theo chu\u1ea9n h\u00f3a, d\u1ec5 ki\u1ec3m so\u00e1t v\u00e0 m\u1edf r\u1ed9ng.</p>"},{"location":"dev-guide/technical-guides/06-event-driven-development/#1-triet-ly-kien-truc-su-kien","title":"1. \ud83d\udcd0 Tri\u1ebft l\u00fd Ki\u1ebfn tr\u00fac S\u1ef1 ki\u1ec7n","text":"<ul> <li>S\u1ef1 ki\u1ec7n l\u00e0 giao ti\u1ebfp ch\u00ednh gi\u1eefa c\u00e1c master/sub service v\u00e0 adapters</li> <li>Lu\u00f4n ph\u1ea3i \u0111\u1ecbnh ngh\u0129a schema s\u1ef1 ki\u1ec7n tr\u01b0\u1edbc khi ph\u00e1t h\u00e0nh</li> <li>T\u00ean s\u1ef1 ki\u1ec7n c\u1ea7n ph\u1ea3n \u00e1nh ng\u1eef ngh\u0129a nghi\u1ec7p v\u1ee5, kh\u00f4ng ph\u1ee5 thu\u1ed9c implementation</li> <li>Event l\u00e0 immutable \u2013 kh\u00f4ng s\u1eeda event \u0111\u00e3 ph\u00e1t, ch\u1ec9 ph\u00e1t phi\u00ean b\u1ea3n m\u1edbi</li> </ul> <p>Tham kh\u1ea3o: - ADR-030 - Event Schema Governance - ADR-027 - Data Management Strategy</p>"},{"location":"dev-guide/technical-guides/06-event-driven-development/#2-cau-truc-mot-event","title":"2. \ud83e\uddf1 C\u1ea5u tr\u00fac M\u1ed9t Event","text":"<p>M\u1ed9t s\u1ef1 ki\u1ec7n chu\u1ea9n ph\u1ea3i c\u00f3 c\u1ea5u tr\u00fac 2 ph\u1ea7n: <code>meta</code> v\u00e0 <code>data</code>.</p> <pre><code>{\n  \"meta\": {\n    \"event_id\": \"evt-abc123\",\n    \"event_name\": \"global_notification_requested\",\n    \"source\": \"notification-service.master\",\n    \"timestamp\": \"2025-06-05T10:00:00Z\",\n    \"version\": \"v1\"\n  },\n  \"data\": {\n    \"template_id\": \"tpl-001\",\n    \"target_user_ids\": [\"user-123\", \"user-456\"],\n    \"channel\": \"email\"\n  }\n}\n</code></pre> <ul> <li><code>event_name</code>: vi\u1ebft d\u01b0\u1edbi d\u1ea1ng snake_case</li> <li><code>source</code>: \u0111\u1ecbnh danh theo service (c\u00f3 h\u1eadu t\u1ed1 <code>.master</code> ho\u1eb7c <code>.sub</code>)</li> <li><code>version</code>: lu\u00f4n c\u00f3 (\u0111\u1ec3 h\u1ed7 tr\u1ee3 versioning schema)</li> </ul>"},{"location":"dev-guide/technical-guides/06-event-driven-development/#3-phat-su-kien-publishing-events","title":"3. \ud83d\udce4 Ph\u00e1t S\u1ef1 ki\u1ec7n (Publishing Events)","text":"<ul> <li> <p>Service ph\u00e1t s\u1ef1 ki\u1ec7n c\u1ea7n:</p> </li> <li> <p>D\u00f9ng th\u01b0 vi\u1ec7n chu\u1ea9n (<code>event_publisher.py</code>, <code>pubsub_adapter.js</code>)</p> </li> <li>Log r\u00f5 <code>event_id</code>, <code>topic</code>, <code>payload</code></li> <li>S\u1ef1 ki\u1ec7n ph\u1ea3i \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a tr\u01b0\u1edbc trong <code>data-model.md</code> (ph\u1ee5 l\u1ee5c Event Emitted)</li> <li>G\u1eedi qua Pub/Sub topic t\u01b0\u01a1ng \u1ee9ng theo config m\u00f4i tr\u01b0\u1eddng</li> </ul> <p>V\u00ed d\u1ee5 trong Python:</p> <pre><code>event = {\n    \"meta\": {\n        \"event_id\": str(uuid4()),\n        \"event_name\": \"user.created\",\n        \"source\": \"user-service.master\",\n        \"timestamp\": datetime.utcnow().isoformat() + \"Z\",\n        \"version\": \"v1\"\n    },\n    \"data\": {\n        \"user_id\": \"user-123\",\n        \"email\": \"a@b.com\"\n    }\n}\npublisher.publish(\"user-events\", json.dumps(event).encode(\"utf-8\"))\n</code></pre>"},{"location":"dev-guide/technical-guides/06-event-driven-development/#4-tieu-thu-su-kien-consuming-events","title":"4. \ud83d\udce5 Ti\u00eau th\u1ee5 S\u1ef1 ki\u1ec7n (Consuming Events)","text":"<ul> <li>Sub service ho\u1eb7c Adapter ph\u1ea3i \u0111\u0103ng k\u00fd <code>subscription</code> \u0111\u00fang topic</li> <li>Validate schema tr\u01b0\u1edbc khi x\u1eed l\u00fd</li> <li>C\u00f3 logic retry khi event fail (d\u00f9ng Pub/Sub DLQ ho\u1eb7c th\u1ee7 c\u00f4ng)</li> <li>Ghi log r\u00f5 <code>event_id</code>, <code>result</code>, <code>error</code> n\u1ebfu c\u00f3</li> </ul> <p>Xem th\u00eam v\u00ed d\u1ee5 trong <code>notification-service.sub/event_handler.py</code></p>"},{"location":"dev-guide/technical-guides/06-event-driven-development/#5-quan-ly-schema-su-kien","title":"5. \ud83d\udce6 Qu\u1ea3n l\u00fd Schema S\u1ef1 ki\u1ec7n","text":"<ul> <li> <p>M\u1ed7i service ph\u1ea3i \u0111\u1ecbnh ngh\u0129a schema c\u1ee7a event m\u00e0 n\u00f3 ph\u00e1t trong:</p> </li> <li> <p><code>data-model.md</code> \u2192 Ph\u1ee5 l\u1ee5c: \"C\u00e1c S\u1ef1 ki\u1ec7n Ph\u00e1t ra\"</p> </li> <li><code>event-schema/</code> (n\u1ebfu t\u00e1ch ri\u00eang)</li> <li>\u0110\u1eb7t t\u00ean schema theo pattern:</li> </ul> <pre><code>events/&lt;domain&gt;/&lt;event_name&gt;.schema.json\n</code></pre>"},{"location":"dev-guide/technical-guides/06-event-driven-development/#6-testing-contract-validation","title":"6. \ud83e\uddea Testing &amp; Contract Validation","text":"<ul> <li>D\u00f9ng test contract gi\u1eefa service ph\u00e1t v\u00e0 ti\u00eau th\u1ee5</li> <li> <p>M\u1ecdi event test ph\u1ea3i \u0111i k\u00e8m:</p> </li> <li> <p><code>valid.json</code> \u2192 s\u1ef1 ki\u1ec7n h\u1ee3p l\u1ec7</p> </li> <li><code>invalid.json</code> \u2192 event b\u1ecb l\u1ed7i schema</li> <li>N\u1ebfu schema thay \u0111\u1ed5i \u2192 ph\u1ea3i c\u1eadp nh\u1eadt <code>version</code> trong meta</li> </ul>"},{"location":"dev-guide/technical-guides/06-event-driven-development/#7-nhung-ieu-khong-uoc-lam","title":"7. \ud83d\udeab Nh\u1eefng \u0110i\u1ec1u Kh\u00f4ng \u0111\u01b0\u1ee3c L\u00e0m","text":"<ul> <li>Kh\u00f4ng publish event ch\u01b0a \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a</li> <li>Kh\u00f4ng thay \u0111\u1ed5i c\u1ea5u tr\u00fac <code>data</code> m\u00e0 kh\u00f4ng version h\u00f3a</li> <li>Kh\u00f4ng vi\u1ebft logic x\u1eed l\u00fd event c\u00f3 side effect tr\u01b0\u1edbc khi x\u00e1c th\u1ef1c schema th\u00e0nh c\u00f4ng</li> <li>Kh\u00f4ng ghi \u0111\u00e8 <code>event_id</code> b\u1eb1ng ID t\u1eeb client</li> </ul> <p>\ud83d\udccc Ghi nh\u1edb: Event l\u00e0 x\u01b0\u01a1ng s\u1ed1ng c\u1ee7a ki\u1ebfn tr\u00fac \u0111a service \u2013 \u0111\u1eebng t\u1ea1o n\u1ee3 k\u1ef9 thu\u1eadt b\u1eb1ng c\u00e1ch x\u1eed l\u00fd s\u1ef1 ki\u1ec7n kh\u00f4ng r\u00f5 schema.</p>"},{"location":"dev-guide/technical-guides/07-logging-and-tracing/","title":"\ud83d\udcca 07. Logging &amp; Tracing \u2013 H\u01b0\u1edbng d\u1eabn Ghi Log v\u00e0 Truy v\u1ebft","text":"<p>T\u00e0i li\u1ec7u n\u00e0y cung c\u1ea5p chu\u1ea9n v\u00e0 best practices cho vi\u1ec7c ghi log v\u00e0 truy v\u1ebft (trace) trong h\u1ec7 th\u1ed1ng DX-VAS, nh\u1eb1m h\u1ed7 tr\u1ee3 debugging, monitoring v\u00e0 b\u1ea3o m\u1eadt \u1edf quy m\u00f4 l\u1edbn.</p>"},{"location":"dev-guide/technical-guides/07-logging-and-tracing/#1-muc-tieu-logging-tracing","title":"1. \ud83c\udfaf M\u1ee5c ti\u00eau Logging &amp; Tracing","text":"<ul> <li>H\u1ed7 tr\u1ee3 g\u1ee1 l\u1ed7i nhanh ch\u00f3ng (theo <code>X-Request-ID</code>)</li> <li>Cho ph\u00e9p ph\u00e2n t\u00edch h\u00e0nh vi h\u1ec7 th\u1ed1ng theo th\u1eddi gian th\u1ef1c v\u00e0 l\u1ecbch s\u1eed</li> <li>Ghi nh\u1eadn s\u1ef1 ki\u1ec7n b\u1ea3o m\u1eadt, h\u00e0nh vi b\u1ea5t th\u01b0\u1eddng</li> <li>Cung c\u1ea5p d\u1eef li\u1ec7u cho b\u00e1o c\u00e1o audit</li> </ul>"},{"location":"dev-guide/technical-guides/07-logging-and-tracing/#2-cac-quy-tac-vang","title":"2. \ud83d\udccd C\u00e1c Quy t\u1eafc V\u00e0ng","text":"<ul> <li>T\u1ea5t c\u1ea3 log ph\u1ea3i c\u00f3 <code>trace_id</code> ho\u1eb7c <code>request_id</code></li> <li>Kh\u00f4ng bao gi\u1edd log d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m (PII, m\u1eadt kh\u1ea9u, token)</li> <li>Kh\u00f4ng log \u1edf level DEBUG trong m\u00f4i tr\u01b0\u1eddng Production</li> <li>Log \u0111\u00fang context \u2013 g\u1eafn theo t\u1eebng request / task</li> </ul>"},{"location":"dev-guide/technical-guides/07-logging-and-tracing/#3-cau-truc-log-chuan","title":"3. \ud83e\udeb5 C\u1ea5u tr\u00fac Log Chu\u1ea9n","text":"<p>M\u1ed9t log chu\u1ea9n ph\u1ea3i l\u00e0 d\u1ea1ng JSON v\u00e0 ch\u1ee9a \u0111\u1ea7y \u0111\u1ee7 th\u00f4ng tin:</p> <pre><code>{\n  \"timestamp\": \"2025-06-05T10:05:23Z\",\n  \"severity\": \"INFO\",\n  \"service\": \"user-service.master\",\n  \"trace_id\": \"req-abc123\",\n  \"operation\": \"GET /users/me\",\n  \"user_id\": \"user-001\",\n  \"message\": \"Get current user success\",\n  \"extra\": {\n    \"ip\": \"127.0.0.1\"\n  }\n}\n</code></pre> <p>M\u1ed7i log ph\u1ea3i c\u00f3 \u00edt nh\u1ea5t:</p> <ul> <li><code>timestamp</code></li> <li><code>severity</code></li> <li><code>service</code> (t\u1ef1 \u0111\u1ed9ng t\u1eeb ENV)</li> <li><code>trace_id</code> ho\u1eb7c <code>X-Request-ID</code></li> <li><code>message</code></li> </ul>"},{"location":"dev-guide/technical-guides/07-logging-and-tracing/#4-tracing-va-request-correlation","title":"4. \ud83d\udce1 Tracing v\u00e0 Request Correlation","text":"<ul> <li> <p>M\u1ed7i request v\u00e0o h\u1ec7 th\u1ed1ng s\u1ebd c\u00f3 m\u1ed9t <code>X-Request-ID</code> duy nh\u1ea5t:</p> </li> <li> <p>Sinh t\u1ea1i API Gateway n\u1ebfu ch\u01b0a c\u00f3</p> </li> <li>\u0110\u01b0\u1ee3c truy\u1ec1n qua to\u00e0n b\u1ed9 c\u00e1c service qua header</li> <li> <p>C\u00e1c service b\u1eaft bu\u1ed9c ph\u1ea3i:</p> </li> <li> <p>Log <code>trace_id</code> (g\u1eafn v\u00e0o logger context ho\u1eb7c middleware)</p> </li> <li>Truy\u1ec1n <code>X-Request-ID</code> khi g\u1ecdi c\u00e1c service kh\u00e1c</li> </ul> <p>G\u1ee3i \u00fd: D\u00f9ng middleware \u0111\u1ec3 t\u1ef1 \u0111\u1ed9ng g\u1eafn trace_id v\u00e0o logger (FastAPI, Express, ...)</p>"},{"location":"dev-guide/technical-guides/07-logging-and-tracing/#5-cac-level-ghi-log","title":"5. \ud83d\udccb C\u00e1c Level Ghi Log","text":"Level M\u00f4 t\u1ea3 v\u00e0 khi n\u00e0o d\u00f9ng DEBUG Th\u00f4ng tin chi ti\u1ebft, d\u00f9ng khi dev ho\u1eb7c test local INFO Th\u00f4ng \u0111i\u1ec7p th\u00e0nh c\u00f4ng, h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng b\u00ecnh th\u01b0\u1eddng WARNING H\u00e0nh vi b\u1ea5t th\u01b0\u1eddng nh\u01b0ng kh\u00f4ng l\u1ed7i (ex: retry, missing optional field) ERROR L\u1ed7i nghi\u1ec7p v\u1ee5, logic, exception CRITICAL H\u1ec7 th\u1ed1ng m\u1ea5t k\u1ebft n\u1ed1i, m\u1ea5t d\u1eef li\u1ec7u, ho\u1eb7c l\u1ed7i kh\u00f4ng th\u1ec3 ph\u1ee5c h\u1ed3i"},{"location":"dev-guide/technical-guides/07-logging-and-tracing/#6-nhung-ieu-khong-uoc-lam","title":"6. \ud83d\uded1 Nh\u1eefng \u0110i\u1ec1u Kh\u00f4ng \u0111\u01b0\u1ee3c L\u00e0m","text":"<ul> <li>\u274c Kh\u00f4ng ghi log v\u00e0o <code>stdout</code> d\u1ea1ng text \u2013 lu\u00f4n d\u00f9ng JSON</li> <li>\u274c Kh\u00f4ng log d\u1eef li\u1ec7u ng\u01b0\u1eddi d\u00f9ng (email, s\u1ed1 \u0111i\u1ec7n tho\u1ea1i, token, OTP\u2026)</li> <li>\u274c Kh\u00f4ng swallow exception m\u00e0 kh\u00f4ng ghi <code>ERROR</code></li> <li>\u274c Kh\u00f4ng log tr\u00f9ng d\u00f2ng \u1edf nhi\u1ec1u service (tr\u00e1nh nhi\u1ec5u)</li> </ul>"},{"location":"dev-guide/technical-guides/07-logging-and-tracing/#7-kiem-thu-logging-tracing","title":"7. \ud83e\uddea Ki\u1ec3m th\u1eed Logging &amp; Tracing","text":"<ul> <li>Test b\u1eb1ng c\u00e1ch g\u1eedi request c\u00f3 <code>X-Request-ID</code> v\u00e0 tra c\u1ee9u trong Google Cloud Logging</li> <li>T\u00ecm b\u1eb1ng truy v\u1ea5n:</li> </ul> <p><pre><code>jsonPayload.trace_id=\"req-abc123\"\n</code></pre> * Log ph\u1ea3i hi\u1ec3n th\u1ecb theo flow:</p> <ul> <li>API Gateway \u2192 Auth Service \u2192 User Service \u2192 Notification \u2192 ...</li> </ul> <p>\ud83d\udccc Ghi nh\u1edb: Log l\u00e0 con m\u1eaft c\u1ee7a h\u1ec7 th\u1ed1ng trong production \u2013 n\u1ebfu b\u1ea1n kh\u00f4ng log \u0111\u1ee7 ho\u1eb7c log sai, b\u1ea1n s\u1ebd kh\u00f4ng th\u1ec3 ki\u1ec3m so\u00e1t nh\u1eefng g\u00ec \u0111ang di\u1ec5n ra.</p>"},{"location":"dev-guide/technical-guides/08-error-handling/","title":"\ud83d\udea8 08. Error Handling \u2013 H\u01b0\u1edbng d\u1eabn X\u1eed l\u00fd v\u00e0 Tr\u1ea3 l\u1ed7i Chu\u1ea9n h\u00f3a","text":"<p>T\u00e0i li\u1ec7u n\u00e0y h\u01b0\u1edbng d\u1eabn c\u00e1ch x\u1eed l\u00fd l\u1ed7i trong h\u1ec7 th\u1ed1ng DX-VAS theo chu\u1ea9n 5\u2b50, \u0111\u1ea3m b\u1ea3o m\u1ecdi API tr\u1ea3 l\u1ed7i m\u1ed9t c\u00e1ch nh\u1ea5t qu\u00e1n, r\u00f5 r\u00e0ng v\u00e0 c\u00f3 th\u1ec3 truy v\u1ebft \u0111\u01b0\u1ee3c.  </p>"},{"location":"dev-guide/technical-guides/08-error-handling/#1-triet-ly-xu-ly-loi","title":"1. \ud83e\udde0 Tri\u1ebft l\u00fd X\u1eed l\u00fd L\u1ed7i","text":"<ul> <li>T\u1ea5t c\u1ea3 l\u1ed7i \u0111\u1ec1u ph\u1ea3i c\u00f3 c\u1ea5u tr\u00fac th\u1ed1ng nh\u1ea5t v\u00e0 d\u1ec5 hi\u1ec3u v\u1edbi client.</li> <li>Kh\u00f4ng tr\u1ea3 l\u1ed7i raw ho\u1eb7c stack trace cho client \u2013 h\u00e3y map v\u1ec1 m\u00e3 l\u1ed7i c\u00f3 \u00fd ngh\u0129a nghi\u1ec7p v\u1ee5.</li> <li>Ph\u00e2n bi\u1ec7t r\u00f5 l\u1ed7i nghi\u1ec7p v\u1ee5 (<code>4xx</code>) v\u00e0 l\u1ed7i h\u1ec7 th\u1ed1ng (<code>5xx</code>).</li> <li>M\u1ed7i l\u1ed7i \u0111\u1ec1u ph\u1ea3i log <code>trace_id</code>, m\u00e3 l\u1ed7i, v\u00e0 nguy\u00ean nh\u00e2n.</li> </ul> <p>Tham kh\u1ea3o: - ADR-011 - API Error Format - ADR-012 - Response Structure</p>"},{"location":"dev-guide/technical-guides/08-error-handling/#2-cau-truc-chuan-cua-response-loi","title":"2. \ud83d\udce6 C\u1ea5u tr\u00fac Chu\u1ea9n c\u1ee7a Response L\u1ed7i","text":"<p>M\u1ecdi l\u1ed7i API ph\u1ea3i c\u00f3 d\u1ea1ng sau:</p> <pre><code>{\n  \"error\": {\n    \"code\": \"VALIDATION_ERROR\",\n    \"message\": \"Tr\u01b0\u1eddng email kh\u00f4ng h\u1ee3p l\u1ec7\"\n  },\n  \"meta\": {\n    \"request_id\": \"req-abc123\",\n    \"timestamp\": \"2025-06-05T10:00:00Z\"\n  }\n}\n</code></pre> <ul> <li><code>error.code</code>: m\u00e3 l\u1ed7i (xem ph\u1ea7n danh s\u00e1ch m\u00e3 l\u1ed7i b\u00ean d\u01b0\u1edbi)</li> <li><code>error.message</code>: m\u00f4 t\u1ea3 ng\u1eafn g\u1ecdn cho client</li> <li><code>meta</code>: b\u1eaft bu\u1ed9c c\u00f3 <code>request_id</code> v\u00e0 <code>timestamp</code></li> </ul>"},{"location":"dev-guide/technical-guides/08-error-handling/#3-danh-sach-ma-loi-chuan","title":"3. \ud83d\udcda Danh s\u00e1ch M\u00e3 L\u1ed7i Chu\u1ea9n","text":"M\u00e3 l\u1ed7i HTTP Code M\u00f4 t\u1ea3 ng\u1eafn <code>VALIDATION_ERROR</code> 400 D\u1eef li\u1ec7u \u0111\u1ea7u v\u00e0o kh\u00f4ng h\u1ee3p l\u1ec7 <code>UNAUTHORIZED</code> 401 Thi\u1ebfu ho\u1eb7c sai token <code>FORBIDDEN</code> 403 Kh\u00f4ng c\u00f3 quy\u1ec1n truy c\u1eadp <code>NOT_FOUND</code> 404 T\u00e0i nguy\u00ean kh\u00f4ng t\u1ed3n t\u1ea1i <code>CONFLICT</code> 409 Tr\u1ea1ng th\u00e1i xung \u0111\u1ed9t (VD: email \u0111\u00e3 t\u1ed3n t\u1ea1i) <code>RATE_LIMIT_EXCEEDED</code> 429 Qu\u00e1 s\u1ed1 l\u1ea7n g\u1ecdi API cho ph\u00e9p <code>INTERNAL_SERVER_ERROR</code> 500 L\u1ed7i kh\u00f4ng x\u00e1c \u0111\u1ecbnh t\u1eeb server <code>DEPENDENCY_FAILURE</code> 502 Service ph\u1ee5 tr\u1ee3 (DB, Pub/Sub...) l\u1ed7i <p>T\u00f9y v\u00e0o service, c\u00f3 th\u1ec3 m\u1edf r\u1ed9ng m\u00e3 l\u1ed7i cho nghi\u1ec7p v\u1ee5 \u0111\u1eb7c th\u00f9 (VD: <code>TEMPLATE_INVALID</code>, <code>USER_SUSPENDED</code>)</p>"},{"location":"dev-guide/technical-guides/08-error-handling/#4-huong-dan-cai-at-middleware-bat-loi","title":"4. \ud83e\uddf0 H\u01b0\u1edbng d\u1eabn C\u00e0i \u0111\u1eb7t Middleware B\u1eaft L\u1ed7i","text":"<ul> <li> <p>Backend ph\u1ea3i c\u00f3 middleware \u0111\u1ec3:</p> </li> <li> <p>Catch exception</p> </li> <li>Map v\u1ec1 c\u1ea5u tr\u00fac <code>ErrorEnvelope</code></li> <li>G\u1eafn <code>request_id</code> t\u1eeb header v\u00e0o <code>meta</code></li> <li>V\u00ed d\u1ee5 (FastAPI):</li> </ul> <pre><code>@app.exception_handler(RequestValidationError)\nasync def validation_exception_handler(request, exc):\n    return JSONResponse(\n        status_code=400,\n        content={\n            \"error\": {\n                \"code\": \"VALIDATION_ERROR\",\n                \"message\": str(exc)\n            },\n            \"meta\": {\n                \"request_id\": request.headers.get(\"X-Request-ID\"),\n                \"timestamp\": datetime.utcnow().isoformat() + \"Z\"\n            }\n        }\n    )\n</code></pre>"},{"location":"dev-guide/technical-guides/08-error-handling/#5-kiem-thu-tra-loi","title":"5. \ud83e\uddea Ki\u1ec3m th\u1eed Tr\u1ea3 L\u1ed7i","text":"<ul> <li>Test c\u00e1c case 400/401/403/404/409/500</li> <li> <p>Ki\u1ec3m tra:</p> </li> <li> <p>\u0110\u00fang <code>status code</code></p> </li> <li>\u0110\u00fang <code>error.code</code></li> <li>C\u00f3 \u0111\u1ea7y \u0111\u1ee7 <code>meta.request_id</code> v\u00e0 <code>timestamp</code></li> <li>D\u00f9ng Postman ho\u1eb7c pytest \u0111\u1ec3 vi\u1ebft test case mock input l\u1ed7i</li> </ul>"},{"location":"dev-guide/technical-guides/08-error-handling/#6-nhung-ieu-khong-uoc-lam","title":"6. \u274c Nh\u1eefng \u0110i\u1ec1u Kh\u00f4ng \u0111\u01b0\u1ee3c L\u00e0m","text":"<ul> <li>Kh\u00f4ng tr\u1ea3 l\u1ed7i <code>500 Internal Server Error</code> tr\u1eeb khi kh\u00f4ng c\u00f3 c\u00e1ch ph\u00e2n lo\u1ea1i kh\u00e1c</li> <li>Kh\u00f4ng log l\u1ed7i d\u1ea1ng raw stack trace g\u1eedi v\u1ec1 client</li> <li>Kh\u00f4ng nu\u1ed1t l\u1ed7i silently \u2013 ph\u1ea3i log t\u1ea5t c\u1ea3 <code>ERROR</code> v\u1edbi context \u0111\u1ea7y \u0111\u1ee7</li> <li>Kh\u00f4ng tr\u1ea3 th\u00f4ng b\u00e1o l\u1ed7i chung chung nh\u01b0 \u201c\u0110\u00e3 x\u1ea3y ra l\u1ed7i\u201d, \u201cSomething went wrong\u201d</li> </ul> <p>\ud83d\udccc Ghi nh\u1edb: L\u1ed7i l\u00e0 c\u00e1ch h\u1ec7 th\u1ed1ng tr\u00f2 chuy\u1ec7n v\u1edbi ng\u01b0\u1eddi d\u00f9ng \u2013 h\u00e3y n\u00f3i \u0111\u00fang, \u0111\u1ee7, v\u00e0 c\u00f3 tr\u00e1ch nhi\u1ec7m.</p>"},{"location":"dev-guide/technical-guides/09-configuration-and-secrets/","title":"\ud83d\udd10 09. Configuration &amp; Secrets \u2013 H\u01b0\u1edbng d\u1eabn Qu\u1ea3n l\u00fd C\u1ea5u h\u00ecnh v\u00e0 Th\u00f4ng tin Nh\u1ea1y c\u1ea3m","text":"<p>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 c\u00e1ch qu\u1ea3n l\u00fd bi\u1ebfn m\u00f4i tr\u01b0\u1eddng, c\u1ea5u h\u00ecnh h\u1ec7 th\u1ed1ng, v\u00e0 th\u00f4ng tin nh\u1ea1y c\u1ea3m (secrets) m\u1ed9t c\u00e1ch an to\u00e0n v\u00e0 nh\u1ea5t qu\u00e1n trong h\u1ec7 th\u1ed1ng DX-VAS, tu\u00e2n th\u1ee7 chu\u1ea9n 5\u2b50 v\u00e0 c\u00e1c ADR b\u1ea3o m\u1eadt.</p>"},{"location":"dev-guide/technical-guides/09-configuration-and-secrets/#1-nguyen-tac-chung","title":"1. \ud83c\udfaf Nguy\u00ean t\u1eafc Chung","text":"<ul> <li>Kh\u00f4ng hard-code b\u1ea5t k\u1ef3 gi\u00e1 tr\u1ecb c\u1ea5u h\u00ecnh n\u00e0o v\u00e0o m\u00e3 ngu\u1ed3n.</li> <li>M\u1ecdi bi\u1ebfn c\u1ea5u h\u00ecnh ph\u1ea3i \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong <code>.env</code> ho\u1eb7c l\u1ea5y t\u1eeb Secret Manager.</li> <li>T\u00e1ch bi\u1ec7t r\u00f5:</li> <li>C\u1ea5u h\u00ecnh c\u00f4ng khai (PORT, DEBUG, API_URL)</li> <li>Th\u00f4ng tin nh\u1ea1y c\u1ea3m (DB_PASSWORD, JWT_SECRET, GCP_CREDENTIALS)</li> <li>C\u1ea5u h\u00ecnh ph\u1ea3i c\u00f3 gi\u00e1 tr\u1ecb m\u1eb7c \u0111\u1ecbnh h\u1ee3p l\u00fd cho m\u00f4i tr\u01b0\u1eddng local.</li> </ul> <p>Tham kh\u1ea3o: - ADR-005 - Environment Configuration - ADR-003 - Secret Management</p>"},{"location":"dev-guide/technical-guides/09-configuration-and-secrets/#2-cau-truc-file-env","title":"2. \ud83d\udcc2 C\u1ea5u tr\u00fac File <code>.env</code>","text":"<p>M\u1ed7i service ph\u1ea3i c\u00f3 file <code>.env.example</code> m\u1eabu. V\u00ed d\u1ee5:</p> <pre><code># App\nAPP_ENV=local\nPORT=8001\n\n# Database\nDB_HOST=localhost\nDB_PORT=5432\nDB_NAME=user_db\nDB_USER=postgres\nDB_PASSWORD=secret\n\n# JWT\nJWT_SECRET=my-super-secret\nJWT_ALGORITHM=HS256\n\n# GCP Pub/Sub\nGCP_PROJECT_ID=dx-vas-dev\nPUBSUB_EMULATOR_HOST=localhost:8432\n</code></pre> <p>\ud83d\udd12 Kh\u00f4ng commit file <code>.env</code> th\u1ef1c t\u1ebf \u2014 ch\u1ec9 <code>.env.example</code>.</p>"},{"location":"dev-guide/technical-guides/09-configuration-and-secrets/#3-quan-ly-secrets","title":"3. \ud83d\udd10 Qu\u1ea3n l\u00fd Secrets","text":""},{"location":"dev-guide/technical-guides/09-configuration-and-secrets/#local","title":"Local","text":"<ul> <li>D\u00f9ng <code>.env</code> v\u1edbi gi\u00e1 tr\u1ecb gi\u1ea3 l\u1eadp cho ph\u00e1t tri\u1ec3n.</li> <li>V\u1edbi Python, s\u1eed d\u1ee5ng <code>python-dotenv</code> \u0111\u1ec3 load t\u1eeb <code>.env</code>.</li> </ul>"},{"location":"dev-guide/technical-guides/09-configuration-and-secrets/#staging-production","title":"Staging / Production","text":"<ul> <li>D\u00f9ng Google Secret Manager \u0111\u1ec3 l\u01b0u v\u00e0 truy xu\u1ea5t c\u00e1c bi\u1ebfn nh\u1ea1y c\u1ea3m.</li> <li>Kh\u00f4ng n\u00ean inject to\u00e0n b\u1ed9 <code>.env</code> \u2013 ch\u1ec9 l\u1ea5y gi\u00e1 tr\u1ecb c\u1ea7n d\u00f9ng t\u1ea1i runtime.</li> </ul> <p>V\u00ed d\u1ee5 v\u1edbi <code>gcloud</code>:</p> <pre><code>gcloud secrets versions access latest --secret=\"jwt-secret\"\n</code></pre>"},{"location":"dev-guide/technical-guides/09-configuration-and-secrets/#4-ten-bien-moi-truong-chuan-hoa","title":"4. \ud83d\udccc T\u00ean Bi\u1ebfn M\u00f4i Tr\u01b0\u1eddng Chu\u1ea9n h\u00f3a","text":"Prefix \u00dd ngh\u0129a V\u00ed d\u1ee5 <code>APP_</code> Th\u00f4ng tin v\u1ec1 service <code>APP_ENV</code>, <code>APP_NAME</code> <code>DB_</code> K\u1ebft n\u1ed1i CSDL <code>DB_HOST</code>, <code>DB_PASSWORD</code> <code>JWT_</code> C\u1ea5u h\u00ecnh token <code>JWT_SECRET</code>, <code>JWT_EXPIRY</code> <code>GCP_</code> T\u00edch h\u1ee3p GCP <code>GCP_PROJECT_ID</code>, <code>GCP_KEY</code> <code>REDIS_</code> Redis cache <code>REDIS_HOST</code>, <code>REDIS_DB</code>"},{"location":"dev-guide/technical-guides/09-configuration-and-secrets/#5-kiem-thu-cau-hinh","title":"5. \ud83e\uddea Ki\u1ec3m th\u1eed c\u1ea5u h\u00ecnh","text":"<ul> <li>Ch\u1ea1y service b\u1eb1ng <code>.env</code> local:</li> </ul> <p><pre><code>poetry run uvicorn app.main:app --reload\n</code></pre> * Ki\u1ec3m tra khi thi\u1ebfu bi\u1ebfn quan tr\u1ecdng \u2192 service ph\u1ea3i fail fast v\u1edbi log l\u1ed7i r\u00f5 r\u00e0ng. * T\u1ea1o unit test validate c\u1ea5u h\u00ecnh khi load app (<code>test_config.py</code>)</p>"},{"location":"dev-guide/technical-guides/09-configuration-and-secrets/#6-nhung-ieu-khong-uoc-lam","title":"6. \ud83d\uded1 Nh\u1eefng \u0110i\u1ec1u Kh\u00f4ng \u0111\u01b0\u1ee3c L\u00e0m","text":"<ul> <li>\u274c Kh\u00f4ng commit <code>.env</code> th\u1ef1c t\u1ebf l\u00ean Git</li> <li>\u274c Kh\u00f4ng log ra gi\u00e1 tr\u1ecb secret</li> <li>\u274c Kh\u00f4ng s\u1eed d\u1ee5ng gi\u00e1 tr\u1ecb m\u1eb7c \u0111\u1ecbnh nguy hi\u1ec3m (VD: <code>SECRET=123456</code>)</li> <li>\u274c Kh\u00f4ng chia s\u1ebb secret qua email, chat, Google Docs</li> </ul> <p>\ud83d\udccc Ghi nh\u1edb: Configuration l\u00e0 n\u1ec1n t\u1ea3ng cho vi\u1ec7c deploy linh ho\u1ea1t \u2013 h\u00e3y c\u1ea5u h\u00ecnh \u0111\u00fang, b\u1ea3o v\u1ec7 k\u1ef9, v\u00e0 lu\u00f4n ki\u1ec3m so\u00e1t \u0111\u01b0\u1ee3c.</p>"},{"location":"process/offboarding/","title":"\ud83d\udc4b Offboarding Guide \u2013 H\u01b0\u1edbng d\u1eabn R\u00fat kh\u1ecfi D\u1ef1 \u00e1n DX-VAS","text":"<p>T\u00e0i li\u1ec7u n\u00e0y h\u01b0\u1edbng d\u1eabn c\u00e1c b\u01b0\u1edbc c\u1ea7n th\u1ef1c hi\u1ec7n khi m\u1ed9t th\u00e0nh vi\u00ean (nh\u00e2n s\u1ef1 n\u1ed9i b\u1ed9, vendor ho\u1eb7c c\u1ed9ng t\u00e1c vi\u00ean) r\u1eddi kh\u1ecfi d\u1ef1 \u00e1n DX-VAS. M\u1ee5c ti\u00eau l\u00e0 \u0111\u1ea3m b\u1ea3o vi\u1ec7c chuy\u1ec3n giao tr\u00e1ch nhi\u1ec7m di\u1ec5n ra su\u00f4n s\u1ebb, h\u1ec7 th\u1ed1ng kh\u00f4ng b\u1ecb gi\u00e1n \u0111o\u1ea1n, v\u00e0 tri th\u1ee9c kh\u00f4ng b\u1ecb th\u1ea5t l\u1ea1c.</p>"},{"location":"process/offboarding/#1-muc-tieu-offboarding","title":"1. \ud83c\udfaf M\u1ee5c ti\u00eau Offboarding","text":"<ul> <li>B\u1ea3o v\u1ec7 an to\u00e0n h\u1ec7 th\u1ed1ng: xo\u00e1 quy\u1ec1n truy c\u1eadp \u0111\u00fang l\u00fac.</li> <li>\u0110\u1ea3m b\u1ea3o lu\u1ed3ng c\u00f4ng vi\u1ec7c kh\u00f4ng b\u1ecb gi\u00e1n \u0111o\u1ea1n.</li> <li>Ghi nh\u1eadn l\u1ea1i ki\u1ebfn th\u1ee9c (knowledge transfer) \u0111\u1ec3 ng\u01b0\u1eddi kh\u00e1c ti\u1ebfp t\u1ee5c d\u1ec5 d\u00e0ng.</li> </ul>"},{"location":"process/offboarding/#2-checklist-bat-buoc-truoc-khi-offboarding","title":"2. \ud83d\udccb Checklist B\u1eaft bu\u1ed9c tr\u01b0\u1edbc khi Offboarding","text":"Vi\u1ec7c c\u1ea7n l\u00e0m B\u1eaft bu\u1ed9c Ghi ch\u00fa [ ] Chuy\u1ec3n giao to\u00e0n b\u1ed9 c\u00f4ng vi\u1ec7c dang d\u1edf \u2705 G\u1eedi b\u1ea3n t\u00f3m t\u1eaft qua email/Slack/Wiki [ ] C\u1eadp nh\u1eadt tr\u1ea1ng th\u00e1i Jira/Trello \u2705 T\u1ea5t c\u1ea3 ticket \u0111ang assigned [ ] Review l\u1ea1i c\u00e1c Pull Request li\u00ean quan \u2705 Merge ho\u1eb7c reassigned n\u1ebfu ch\u01b0a xong [ ] C\u1eadp nh\u1eadt t\u00e0i li\u1ec7u m\u00ecnh \u0111ang ph\u1ee5 tr\u00e1ch \u2705 <code>dev-guide</code>, <code>ADR</code>, <code>README</code>\u2026 [ ] D\u1ecdn d\u1eb9p branch c\u00e1 nh\u00e2n ch\u01b0a d\u00f9ng \u2705 Xo\u00e1 branch <code>feature/xxx</code> c\u0169 [ ] Th\u1ef1c hi\u1ec7n bu\u1ed5i handover k\u1ef9 thu\u1eadt \u2705 Ghi h\u00ecnh/l\u01b0u notes n\u1ebfu c\u1ea7n [ ] Xo\u00e1 quy\u1ec1n truy c\u1eadp GitHub repo \u2705 B\u1edfi admin ho\u1eb7c DevOps [ ] Xo\u00e1 quy\u1ec1n truy c\u1eadp GCP / Slack \u2705 G\u1eedi y\u00eau c\u1ea7u t\u1edbi <code>@john_dx</code> ho\u1eb7c <code>@pm_vas</code>"},{"location":"process/offboarding/#3-template-knowledge-transfer","title":"3. \ud83e\udde0 Template Knowledge Transfer","text":"<pre><code>**T\u00ean service/ph\u00e2n h\u1ec7 b\u1ea1n \u0111ang ph\u1ee5 tr\u00e1ch:**  \n- `notification-service/master`\n\n**C\u00e1c module ch\u00ednh \u0111\u00e3 l\u00e0m:**  \n- `TemplateManager`, `NotificationDispatcher`, `WebhookChannel`\n\n**C\u00e1c issue ch\u01b0a ho\u00e0n th\u00e0nh:**  \n- `DX-487`: th\u00eam retry mechanism  \n- `DX-501`: chuy\u1ec3n c\u1ea5u h\u00ecnh channel t\u1eeb DB sang Pub/Sub cache\n\n**C\u00e1c \u0111i\u1ec3m k\u1ef9 thu\u1eadt c\u1ea7n l\u01b0u \u00fd:**  \n- Redis c\u00f3 th\u1ec3 b\u1ecb treo n\u1ebfu s\u1ed1 l\u01b0\u1ee3ng subscriber qu\u00e1 l\u1edbn  \n- Pub/Sub khi retry c\u1ea7n check `event_id` tr\u00e1nh duplicate\n\n**Ng\u01b0\u1eddi ti\u1ebfp nh\u1eadn ch\u00ednh:**  \n- `@huy_tran (vendor team Ho\u00e0ng V\u0169)`\n</code></pre>"},{"location":"process/offboarding/#4-xoa-quyen-truy-cap","title":"4. \ud83d\udd12 Xo\u00e1 Quy\u1ec1n Truy C\u1eadp","text":"<p>Y\u00eau c\u1ea7u PM/Tech Lead g\u1eedi checklist n\u00e0y cho DevOps:</p> <ul> <li> GitHub repo <code>ezdesign-vn/dx-vas</code></li> <li> GCP Project <code>dx-vas-core</code>, <code>dx-vas-tenant-*</code></li> <li> Slack <code>#dx-vas-*</code></li> <li> Google Drive (t\u00e0i li\u1ec7u n\u1ed9i b\u1ed9)</li> <li> Email nh\u00f3m (n\u1ebfu \u0111\u01b0\u1ee3c th\u00eam v\u00e0o mailing list)</li> </ul>"},{"location":"process/offboarding/#5-tai-lieu-lien-he-sau-offboarding","title":"5. \ud83e\udeaa T\u00e0i li\u1ec7u &amp; Li\u00ean h\u1ec7 Sau Offboarding","text":"<ul> <li>N\u1ebfu c\u00f3 v\u1ea5n \u0111\u1ec1 li\u00ean quan \u0111\u1ebfn code c\u0169 b\u1ea1n t\u1eebng vi\u1ebft:</li> <li>PM/Tech Lead s\u1ebd li\u00ean h\u1ec7 l\u1ea1i (n\u1ebfu c\u00f2n trong th\u1eddi gian cam k\u1ebft h\u1ed7 tr\u1ee3)</li> <li>N\u1ebfu c\u1ea7n b\u00e0n giao th\u00eam sau offboarding ch\u00ednh th\u1ee9c:</li> <li>Vui l\u00f2ng t\u1ea1o Google Doc v\u00e0 g\u1eedi qua email/slack</li> </ul>"},{"location":"process/offboarding/#6-loi-cam-on","title":"6. \ud83d\ude4f L\u1eddi C\u1ea3m \u01a0n","text":"<p>C\u1ea3m \u01a1n b\u1ea1n v\u00ec nh\u1eefng \u0111\u00f3ng g\u00f3p qu\u00fd gi\u00e1 cho DX-VAS. Ch\u00fang t\u00f4i r\u1ea5t mong s\u1ebd c\u00f3 c\u01a1 h\u1ed9i c\u1ed9ng t\u00e1c c\u00f9ng b\u1ea1n trong c\u00e1c d\u1ef1 \u00e1n t\u01b0\u01a1ng lai! \ud83d\udc99</p>"},{"location":"process/onboarding/","title":"\ud83d\udc4b Onboarding Guide \u2013 H\u01b0\u1edbng d\u1eabn Cho Th\u00e0nh vi\u00ean M\u1edbi","text":"<p>Ch\u00e0o m\u1eebng b\u1ea1n \u0111\u1ebfn v\u1edbi d\u1ef1 \u00e1n DX-VAS! T\u00e0i li\u1ec7u n\u00e0y gi\u00fap b\u1ea1n nhanh ch\u00f3ng ho\u00e0 nh\u1eadp, hi\u1ec3u h\u1ec7 th\u1ed1ng, setup m\u00f4i tr\u01b0\u1eddng, v\u00e0 b\u1eaft \u0111\u1ea7u \u0111\u00f3ng g\u00f3p hi\u1ec7u qu\u1ea3 ch\u1ec9 trong v\u00e0i ng\u00e0y \u0111\u1ea7u.</p> <p>\u201cOnboarding t\u1ed1t kh\u00f4ng ch\u1ec9 l\u00e0 setup m\u00e1y, m\u00e0 l\u00e0 gi\u00fap b\u1ea1n hi\u1ec3u h\u1ec7 th\u1ed1ng, hi\u1ec3u v\u0103n ho\u00e1 code, v\u00e0 tr\u1edf th\u00e0nh m\u1ed9t ph\u1ea7n c\u1ee7a team.\u201d \u2013 John, DX Architect</p>"},{"location":"process/onboarding/#1-checklist-tuan-au-tien","title":"1. \ud83d\udcc5 Checklist Tu\u1ea7n \u0110\u1ea7u Ti\u00ean","text":"Vi\u1ec7c c\u1ea7n l\u00e0m M\u1ee5c ti\u00eau Tr\u1ea1ng th\u00e1i [ ] Clone repo ch\u00ednh <code>dx-vas</code> B\u1eaft \u0111\u1ea7u l\u00e0m vi\u1ec7c tr\u00ean local [ ] C\u00e0i tool (Python, Node, Docker...) Setup m\u00f4i tr\u01b0\u1eddng ph\u00e1t tri\u1ec3n [ ] <code>make run</code> ch\u1ea1y \u0111\u01b0\u1ee3c 1 service Ki\u1ec3m tra m\u00f4i tr\u01b0\u1eddng ho\u1ea1t \u0111\u1ed9ng \u0111\u00fang [ ] \u0110\u1ecdc s\u01a1 \u0111\u1ed3 h\u1ec7 th\u1ed1ng t\u1ed5ng th\u1ec3 Hi\u1ec3u ki\u1ebfn tr\u00fac &amp; c\u00e1ch c\u00e1c service giao ti\u1ebfp [ ] \u0110\u1ecdc core guide (<code>dev-guide/</code>) N\u1eafm nguy\u00ean t\u1eafc ph\u00e1t tri\u1ec3n c\u1ee7a team [ ] L\u00e0m m\u1ed9t task nh\u1ecf \u0111\u1ea7u ti\u00ean L\u00e0m quen v\u1edbi workflow &amp; codebase [ ] Join Slack, Google Group Giao ti\u1ebfp n\u1ed9i b\u1ed9"},{"location":"process/onboarding/#2-cai-at-moi-truong-phat-trien","title":"2. \u2699\ufe0f C\u00e0i \u0111\u1eb7t M\u00f4i tr\u01b0\u1eddng Ph\u00e1t Tri\u1ec3n","text":"<p>Xem chi ti\u1ebft t\u1ea1i: Getting Started</p>"},{"location":"process/onboarding/#tool-yeu-cau","title":"Tool y\u00eau c\u1ea7u:","text":"<ul> <li>Python 3.11+, Poetry</li> <li>Node.js 18.x+, npm/yarn</li> <li>Docker &amp; Docker Compose</li> <li>gcloud CLI, terraform</li> <li>VS Code + extensions (Python, ESLint, Prettier...)</li> </ul>"},{"location":"process/onboarding/#3-kien-truc-tong-quan","title":"3. \ud83e\udde0 Ki\u1ebfn tr\u00fac T\u1ed5ng Quan","text":"<ul> <li>S\u01a1 \u0111\u1ed3 h\u1ec7 th\u1ed1ng: System Diagrams</li> <li>G\u1ed3m 5 nh\u00f3m th\u00e0nh ph\u1ea7n:</li> <li>Frontend apps</li> <li>Core Services (Auth, User, Notification, etc.)</li> <li>Business Adapters (CRM, LMS\u2026)</li> <li>External Services (SMTP, Zalo, etc.)</li> <li>Infrastructure (Pub/Sub, DB, Redis)</li> </ul>"},{"location":"process/onboarding/#4-nhung-file-ban-nen-bat-au-oc","title":"4. \ud83d\udcda Nh\u1eefng File B\u1ea1n N\u00ean B\u1eaft \u0111\u1ea7u \u0110\u1ecdc","text":"T\u00ean t\u00e0i li\u1ec7u M\u1ee5c \u0111\u00edch DX-VAS - T\u1ed5ng quan To\u00e0n c\u1ea3nh h\u1ec7 th\u1ed1ng Nguy\u00ean t\u1eafc ph\u00e1t tri\u1ec3n Tri\u1ebft l\u00fd k\u1ef9 thu\u1eadt &amp; coding Quy tr\u00ecnh Git, PR, CI/CD L\u00e0m vi\u1ec7c nh\u00f3m, chu\u1ea9n h\u00f3a Checklist b\u1ea3o m\u1eadt Checklist an to\u00e0n b\u1ea3o m\u1eadt H\u01b0\u1edbng d\u1eabn vi\u1ebft test \u0110\u1ea3m b\u1ea3o ch\u1ea5t l\u01b0\u1ee3ng code Guide cho Frontend N\u1ebfu b\u1ea1n l\u00e0 frontend dev Debug &amp; G\u1ee1 l\u1ed7i Ph\u00e2n t\u00edch &amp; x\u1eed l\u00fd l\u1ed7i"},{"location":"process/onboarding/#5-viec-au-tien-ban-nen-lam","title":"5. \u2705 Vi\u1ec7c \u0110\u1ea7u Ti\u00ean B\u1ea1n N\u00ean L\u00e0m","text":"<ol> <li> <p>Ch\u1ea1y th\u1eed service <code>user-service/master</code> local: <pre><code>   make run SERVICE=user-service-master\n</code></pre></p> </li> <li> <p>G\u1ecdi API th\u1eed b\u1eb1ng Postman ho\u1eb7c curl:</p> </li> </ol> <pre><code>curl -H \"Authorization: Bearer &lt;token&gt;\" http://localhost:8001/users/me\n</code></pre> <p>Xem h\u01b0\u1edbng d\u1eabn l\u1ea5y token t\u1ea1i Getting Started</p> <ol> <li> <p>T\u1ea1o PR \u0111\u1ea7u ti\u00ean:</p> </li> <li> <p>C\u00f3 th\u1ec3 l\u00e0 c\u1eadp nh\u1eadt t\u00e0i li\u1ec7u, fix typo, ho\u1eb7c th\u00eam test</p> </li> <li>Tu\u00e2n th\u1ee7 quy tr\u00ecnh PR t\u1ea1i Workflow &amp; Process</li> </ol>"},{"location":"process/onboarding/#6-kenh-ho-tro","title":"6. \ud83d\udcac K\u00eanh H\u1ed7 tr\u1ee3","text":"K\u00eanh M\u1ee5c \u0111\u00edch <code>#dx-vas-dev</code> (Slack) H\u1ecfi nhanh v\u1ec1 k\u1ef9 thu\u1eadt <code>#dx-vas-docs</code> Th\u1ea3o lu\u1eadn t\u00e0i li\u1ec7u Google Group <code>dx-vas@</code> Trao \u0111\u1ed5i to\u00e0n d\u1ef1 \u00e1n <code>@john_dx</code> Ki\u1ebfn tr\u00fac t\u1ed5ng th\u1ec3 <code>@pm_vas</code> Qu\u1ea3n l\u00fd d\u1ef1 \u00e1n"},{"location":"process/onboarding/#7-mot-so-nguyen-tac-quan-trong","title":"7. \ud83d\udd10 M\u1ed9t s\u1ed1 nguy\u00ean t\u1eafc quan tr\u1ecdng","text":"<ul> <li>Kh\u00f4ng bao gi\u1edd merge code ch\u01b0a review</li> <li>Kh\u00f4ng push v\u00e0o nh\u00e1nh <code>main</code> ho\u1eb7c <code>dev</code> tr\u1ef1c ti\u1ebfp</li> <li>Lu\u00f4n test k\u1ef9 tr\u01b0\u1edbc khi t\u1ea1o PR</li> <li>\u0110\u1ecdc v\u00e0 tu\u00e2n th\u1ee7 c\u00e1c ADR t\u1ea1i ADR Index</li> </ul> <p>\ud83d\udccc Ghi nh\u1edb: B\u1ea1n kh\u00f4ng \u0111\u01a1n \u0111\u1ed9c. H\u00e3y ch\u1ee7 \u0111\u1ed9ng h\u1ecfi \u2013 c\u00e0ng h\u1ecfi nhi\u1ec1u, h\u1ecdc c\u00e0ng nhanh. Ch\u00e0o m\u1eebng b\u1ea1n \u0111\u1ebfn v\u1edbi DX-VAS!</p>"},{"location":"requests/01.report-system.request/","title":"01.report system.request","text":""},{"location":"requests/01.report-system.request/#yeu-cau-thay-oi-change-request-he-thong-bao-cao-phan-tich-va-chuan-bi-cho-ai-dx-vas","title":"Y\u00eau C\u1ea7u Thay \u0110\u1ed5i (Change Request) - H\u1ec7 Th\u1ed1ng B\u00e1o C\u00e1o, Ph\u00e2n T\u00edch v\u00e0 Chu\u1ea9n b\u1ecb cho AI DX-VAS","text":"<p>CR-ID: DX-VAS-REPORTING-AI-INTEGRATION Version: 2.2 Ng\u00e0y t\u1ea1o: 3 th\u00e1ng 6 n\u0103m 2025 Ng\u01b0\u1eddi y\u00eau c\u1ea7u: Ban Gi\u00e1m \u0111\u1ed1c (BoD) VAS, th\u00f4ng qua [T\u00ean c\u1ee7a b\u1ea1n/vai tr\u00f2 c\u1ee7a b\u1ea1n] Ng\u01b0\u1eddi review: Bill (CTO), John (Ki\u1ebfn tr\u00fac s\u01b0) M\u1ee9c \u0111\u1ed9 \u01b0u ti\u00ean: R\u1ea5t Cao Tr\u1ea1ng th\u00e1i: \u0110\u00e3 Ph\u00ea Duy\u1ec7t</p>"},{"location":"requests/01.report-system.request/#1-mo-ta-yeu-cau-thay-oi","title":"1. M\u00f4 t\u1ea3 Y\u00eau c\u1ea7u Thay \u0111\u1ed5i","text":"<p>Y\u00eau c\u1ea7u n\u00e0y \u0111\u1ec1 xu\u1ea5t vi\u1ec7c ph\u00e1t tri\u1ec3n m\u1ed9t h\u1ec7 th\u1ed1ng b\u00e1o c\u00e1o v\u00e0 ph\u00e2n t\u00edch (Reporting System) to\u00e0n di\u1ec7n cho n\u1ec1n t\u1ea3ng dx-vas. H\u1ec7 th\u1ed1ng n\u00e0y kh\u00f4ng ch\u1ec9 \u0111\u00e1p \u1ee9ng nhu c\u1ea7u b\u00e1o c\u00e1o chi ti\u1ebft, t\u00f9y bi\u1ebfn cao, v\u00e0 tr\u1ef1c quan h\u00f3a d\u1eef li\u1ec7u cho Ban Gi\u00e1m \u0111\u1ed1c (BoD) m\u00e0 c\u00f2n ph\u1ea3i x\u00e2y d\u1ef1ng m\u1ed9t n\u1ec1n t\u1ea3ng d\u1eef li\u1ec7u v\u1eefng ch\u1eafc, ch\u1ea5t l\u01b0\u1ee3ng cao, s\u1eb5n s\u00e0ng cho vi\u1ec7c t\u00edch h\u1ee3p c\u00e1c AI Agent trong t\u01b0\u01a1ng lai nh\u1eb1m n\u00e2ng cao kh\u1ea3 n\u0103ng ph\u00e2n t\u00edch th\u00f4ng minh, d\u1ef1 \u0111o\u00e1n v\u00e0 t\u1ef1 \u0111\u1ed9ng h\u00f3a.</p> <p>C\u00e1c thay \u0111\u1ed5i ch\u00ednh bao g\u1ed3m: * Thi\u1ebft l\u1eadp m\u1ed9t Data Warehouse/Data Lake chuy\u00ean d\u1ee5ng, c\u00f3 c\u01a1 ch\u1ebf qu\u1ea3n l\u00fd schema evolution v\u00e0 versioning. * X\u00e2y d\u1ef1ng Data Pipelines (ETL/ELT) \u0111\u1ec3 thu th\u1eadp d\u1eef li\u1ec7u, h\u1ed7 tr\u1ee3 c\u1ea3 streaming (v\u1edbi event schema \u0111\u01b0\u1ee3c chu\u1ea9n h\u00f3a, c\u00f3 versioning, v\u00e0 \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd trong m\u1ed9t <code>event-catalog.md</code> ho\u1eb7c Schema Registry) v\u00e0 batch. * Ph\u00e1t tri\u1ec3n m\u1ed9t Reporting Service ri\u00eang bi\u1ec7t v\u1edbi c\u00e1c API tu\u00e2n th\u1ee7 ADR-012 (s\u1eed d\u1ee5ng <code>ReportEnvelope</code>), h\u1ed7 tr\u1ee3 truy v\u1ea5n b\u00e1o c\u00e1o (\u01b0u ti\u00ean qua predefined views/data marts ho\u1eb7c validated query templates \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o an to\u00e0n v\u00e0 hi\u1ec7u n\u0103ng), qu\u1ea3n l\u00fd m\u1eabu b\u00e1o c\u00e1o (Report Templates), v\u00e0 c\u00f3 kh\u1ea3 n\u0103ng l\u01b0u c\u1ea5u h\u00ecnh dashboard/b\u00e1o c\u00e1o c\u00e1 nh\u00e2n (\"Saved Dashboard Config\"). Ho\u1ea1t \u0111\u1ed9ng t\u1ea1o v\u00e0 xem b\u00e1o c\u00e1o c\u1ea7n \u0111\u01b0\u1ee3c audit log chi ti\u1ebft. * N\u00e2ng c\u1ea5p Superadmin Webapp v\u1edbi module b\u00e1o c\u00e1o, module qu\u1ea3n l\u00fd template b\u00e1o c\u00e1o, v\u00e0 giao di\u1ec7n ng\u01b0\u1eddi d\u00f9ng \u0111\u01b0\u1ee3c ph\u00e2n quy\u1ec1n chi ti\u1ebft (t\u00e1ch bi\u1ec7t UI xem b\u00e1o c\u00e1o v\u00e0 UI qu\u1ea3n l\u00fd template, v\u1edbi UX h\u1ed7 tr\u1ee3 progressive disclosure). * \u0110i\u1ec1u ch\u1ec9nh c\u00e1c service hi\u1ec7n c\u00f3 \u0111\u1ec3 cung c\u1ea5p d\u1eef li\u1ec7u \u0111\u1ea7y \u0111\u1ee7 (l\u00e0m r\u00f5 m\u1ee9c \u0111\u1ed9 chi ti\u1ebft, t\u1ea7n su\u1ea5t s\u1ef1 ki\u1ec7n, v\u00e0 schema c\u1ee5 th\u1ec3 cho c\u00e1c b\u1ea3ng fact/dimension trong Data Warehouse) v\u00e0 h\u1ed7 tr\u1ee3 RBAC cho b\u00e1o c\u00e1o. * C\u1eadp nh\u1eadt t\u00e0i li\u1ec7u ki\u1ebfn tr\u00fac v\u00e0 c\u00e1c Quy\u1ebft \u0111\u1ecbnh Ki\u1ebfn tr\u00fac (ADRs) li\u00ean quan, bao g\u1ed3m ADR m\u1edbi cho ki\u1ebfn tr\u00fac b\u00e1o c\u00e1o, schema report template, v\u00e0 event schema governance.</p>"},{"location":"requests/01.report-system.request/#2-ly-do-thay-oi","title":"2. L\u00fd do Thay \u0111\u1ed5i","text":"<ul> <li>\u0110\u00e1p \u1ee9ng Y\u00eau c\u1ea7u t\u1eeb BoD: Cung c\u1ea5p kh\u1ea3 n\u0103ng truy c\u1eadp c\u00e1c b\u00e1o c\u00e1o chi ti\u1ebft, t\u00f9y bi\u1ebfn, t\u1ed5ng h\u1ee3p t\u1eeb nhi\u1ec1u tenant v\u00e0 module, v\u1edbi kh\u1ea3 n\u0103ng tr\u1ef1c quan h\u00f3a d\u1eef li\u1ec7u.</li> <li>N\u00e2ng cao N\u0103ng l\u1ef1c Qu\u1ea3n tr\u1ecb v\u00e0 Ra quy\u1ebft \u0111\u1ecbnh: Trang b\u1ecb cho Superadmin c\u00f4ng c\u1ee5 m\u1ea1nh m\u1ebd \u0111\u1ec3 theo d\u00f5i, ph\u00e2n t\u00edch v\u00e0 \u0111\u01b0a ra quy\u1ebft \u0111\u1ecbnh d\u1ef1a tr\u00ean d\u1eef li\u1ec7u.</li> <li>X\u00e2y d\u1ef1ng N\u1ec1n t\u1ea3ng Chi\u1ebfn l\u01b0\u1ee3c cho AI: Chu\u1ea9n b\u1ecb h\u1ea1 t\u1ea7ng d\u1eef li\u1ec7u v\u00e0 ki\u1ebfn tr\u00fac s\u1eb5n s\u00e0ng cho vi\u1ec7c t\u00edch h\u1ee3p c\u00e1c AI Agent.</li> <li>Chu\u1ea9n h\u00f3a v\u00e0 \u0110\u1ea3m b\u1ea3o T\u00ednh nh\u1ea5t qu\u00e1n B\u00e1o c\u00e1o: Cho ph\u00e9p Superadmin t\u1ea1o \"M\u1eabu B\u00e1o c\u00e1o\" (Report Templates) \u0111\u1ec3 c\u00e1c tenant tu\u00e2n theo.</li> <li>Ki\u1ec3m so\u00e1t Truy c\u1eadp D\u1eef li\u1ec7u B\u00e1o c\u00e1o Chi ti\u1ebft: \u00c1p d\u1ee5ng c\u01a1 ch\u1ebf RBAC ch\u1eb7t ch\u1ebd.</li> </ul>"},{"location":"requests/01.report-system.request/#3-pham-vi-thay-oi","title":"3. Ph\u1ea1m vi Thay \u0111\u1ed5i","text":"<p>I. Thi\u1ebft l\u1eadp N\u1ec1n t\u1ea3ng D\u1eef li\u1ec7u cho B\u00e1o c\u00e1o v\u00e0 AI:</p> <ol> <li>Data Warehouse/Data Lake (M\u1edaI):<ul> <li>Y\u00eau c\u1ea7u: Thi\u1ebft k\u1ebf v\u00e0 tri\u1ec3n khai m\u1ed9t Data Warehouse (v\u00ed d\u1ee5: Google BigQuery) ho\u1eb7c Data Lake, t\u1ed1i \u01b0u cho OLAP.</li> <li>Schema &amp; Evolution: Thi\u1ebft k\u1ebf schema chu\u1ea9n h\u00f3a (v\u00ed d\u1ee5: <code>fact_login</code>, <code>fact_user_activity</code>, <code>dim_tenant</code>, <code>dim_user</code>, <code>dim_time</code>), c\u00f3 versioning, h\u1ed7 tr\u1ee3 backward compatibility v\u00e0 c\u01a1 ch\u1ebf qu\u1ea3n l\u00fd schema evolution r\u00f5 r\u00e0ng. Schema ph\u1ea3i \u0111\u1ee7 chi ti\u1ebft cho c\u1ea3 b\u00e1o c\u00e1o v\u00e0 AI.</li> </ul> </li> <li>Data Pipeline (ETL/ELT) (M\u1edaI):<ul> <li>Y\u00eau c\u1ea7u: X\u00e2y d\u1ef1ng c\u00e1c lu\u1ed3ng (pipelines) \u0111\u1ec3 thu th\u1eadp d\u1eef li\u1ec7u t\u1eeb c\u00e1c service ngu\u1ed3n v\u00e0o Data Warehouse.</li> <li>Ngu\u1ed3n d\u1eef li\u1ec7u: <code>User Service Master</code>, <code>User Service Sub</code>, <code>Auth Service Master</code>, v\u00e0 d\u1eef li\u1ec7u t\u1eeb c\u00e1c <code>Adapters</code> (CRM, SIS, LMS).</li> <li>C\u01a1 ch\u1ebf: H\u1ed7 tr\u1ee3 c\u1ea3 Pub/Sub event streaming (CDC, s\u1eed d\u1ee5ng event schema \u0111\u00e3 \u0111\u01b0\u1ee3c chu\u1ea9n h\u00f3a v\u00e0 c\u00f3 versioning, v\u00ed d\u1ee5: <code>vas.audit.login.v1</code>, qu\u1ea3n l\u00fd qua <code>event-catalog.md</code> ho\u1eb7c Schema Registry) v\u00e0 batch job \u0111\u1ecbnh k\u1ef3. L\u00e0m r\u00f5 m\u1ee9c \u0111\u1ed9 chi ti\u1ebft v\u00e0 t\u1ea7n su\u1ea5t s\u1ef1 ki\u1ec7n.</li> <li>Ch\u1ea5t l\u01b0\u1ee3ng d\u1eef li\u1ec7u: Pipeline c\u1ea7n c\u00f3 c\u01a1 ch\u1ebf \u0111\u1ea3m b\u1ea3o Data Quality.</li> </ul> </li> </ol> <p>II. Ph\u00e1t tri\u1ec3n Reporting Service (M\u1edaI):</p> <ol> <li>API B\u00e1o c\u00e1o Chuy\u00ean d\u1ee5ng:<ul> <li>Y\u00eau c\u1ea7u: Thi\u1ebft k\u1ebf API cho ph\u00e9p client truy v\u1ea5n d\u1eef li\u1ec7u t\u1eeb Data Warehouse.</li> <li>T\u00ednh n\u0103ng API: H\u1ed7 tr\u1ee3 tham s\u1ed1 truy v\u1ea5n linh ho\u1ea1t, tr\u1ea3 v\u1ec1 d\u1eef li\u1ec7u \u0111\u00e3 x\u1eed l\u00fd/t\u1ed5ng h\u1ee3p.</li> <li>Response: Tu\u00e2n th\u1ee7 <code>ADR-012</code> (s\u1eed d\u1ee5ng <code>ReportEnvelope</code> v\u1edbi c\u1ea5u tr\u00fac <code>{ data, meta, error: null }</code>).</li> </ul> </li> <li>API Qu\u1ea3n l\u00fd M\u1eabu B\u00e1o c\u00e1o (Report Templates):<ul> <li>Y\u00eau c\u1ea7u: API (CRUD) cho ph\u00e9p Superadmin (c\u00f3 quy\u1ec1n <code>report.manage_report_templates</code>) qu\u1ea3n l\u00fd \"M\u1eabu B\u00e1o c\u00e1o\".</li> <li>N\u1ed9i dung Template: \u0110\u1ecbnh ngh\u0129a r\u00f5 c\u1ea5u tr\u00fac, metadata (tham kh\u1ea3o <code>ADR-029</code>).</li> <li>API cho ph\u00e9p g\u00e1n/b\u1ecf g\u00e1n template cho c\u00e1c tenant.</li> </ul> </li> <li>API C\u1ea5u h\u00ecnh Dashboard/B\u00e1o c\u00e1o \u0111\u00e3 l\u01b0u (Saved Report Configurations):<ul> <li>Y\u00eau c\u1ea7u: API \u0111\u1ec3 ng\u01b0\u1eddi d\u00f9ng (c\u00f3 quy\u1ec1n) l\u01b0u v\u00e0 qu\u1ea3n l\u00fd c\u00e1c c\u1ea5u h\u00ecnh b\u00e1o c\u00e1o (\"Saved Report View\") ho\u1eb7c dashboard c\u00e1 nh\u00e2n h\u00f3a c\u1ee7a h\u1ecd. C\u1ea7n backend \u0111\u1ec3 l\u01b0u tr\u1eef c\u00e1c c\u1ea5u h\u00ecnh n\u00e0y.</li> </ul> </li> <li>Logic Nghi\u1ec7p v\u1ee5 B\u00e1o c\u00e1o v\u00e0 T\u00f9y bi\u1ebfn:<ul> <li>Y\u00eau c\u1ea7u: Ch\u1ee9a logic th\u1ef1c hi\u1ec7n truy v\u1ea5n ph\u1ee9c t\u1ea1p tr\u00ean Data Warehouse (\u01b0u ti\u00ean qua predefined views/data marts).</li> <li>Query Generation/Validation: N\u1ebfu h\u1ed7 tr\u1ee3 t\u1ea1o b\u00e1o c\u00e1o \u0111\u1ed9ng t\u1eeb UI \u1edf m\u1ee9c \u0111\u1ed9 cao, c\u1ea7n c\u00f3 l\u1edbp t\u1ea1o v\u00e0 ki\u1ec3m duy\u1ec7t truy v\u1ea5n an to\u00e0n (tr\u00e1nh SQL t\u00f9y \u00fd, c\u00f3 th\u1ec3 d\u00f9ng <code>validated query templates</code> ho\u1eb7c m\u1ed9t DSL n\u1ed9i b\u1ed9 \u0111\u01a1n gi\u1ea3n).</li> </ul> </li> <li>B\u1ea3o m\u1eadt v\u00e0 Ph\u00e2n Quy\u1ec1n cho B\u00e1o c\u00e1o (RBAC for Reports):<ul> <li>Y\u00eau c\u1ea7u: T\u00edch h\u1ee3p v\u1edbi Auth Service Master/User Service Master.</li> <li>Th\u1ef1c thi quy\u1ec1n truy c\u1eadp d\u1ef1a tr\u00ean <code>permission_code</code> c\u1ee5 th\u1ec3.</li> <li>API c\u1ee7a Reporting Service khai b\u00e1o <code>x-required-permission</code>.</li> <li>Ho\u1ea1t \u0111\u1ed9ng t\u1ea1o v\u00e0 xem b\u00e1o c\u00e1o c\u1ea7n \u0111\u01b0\u1ee3c audit log chi ti\u1ebft (theo <code>ADR-008</code>: <code>who</code>, <code>what report</code>, <code>filters used</code>, <code>duration</code>).</li> </ul> </li> </ol> <p>III. C\u1eadp nh\u1eadt Superadmin Webapp:</p> <ol> <li>Module B\u00e1o c\u00e1o v\u00e0 Ph\u00e2n t\u00edch (M\u1edaI):<ul> <li>Y\u00eau c\u1ea7u: Ph\u00e1t tri\u1ec3n UI cho ph\u00e9p ch\u1ecdn lo\u1ea1i b\u00e1o c\u00e1o, \u00e1p d\u1ee5ng b\u1ed9 l\u1ecdc \u0111\u1ed9ng, l\u1ef1a ch\u1ecdn chi\u1ec1u d\u1eef li\u1ec7u/ch\u1ec9 s\u1ed1.</li> <li>T\u00edch h\u1ee3p th\u01b0 vi\u1ec7n bi\u1ec3u \u0111\u1ed3.</li> <li>Export b\u00e1o c\u00e1o.</li> <li>T\u00ednh n\u0103ng l\u01b0u c\u1ea5u h\u00ecnh b\u00e1o c\u00e1o/dashboard c\u00e1 nh\u00e2n.</li> <li>UX/UI C\u00e2n nh\u1eafc: S\u1eed d\u1ee5ng progressive disclosure, c\u00f3 preview m\u1eabu b\u00e1o c\u00e1o, v\u00e0 c\u00f3 th\u1ec3 c\u1ea3 export scheduler.</li> </ul> </li> <li>Module Qu\u1ea3n l\u00fd M\u1eabu B\u00e1o c\u00e1o (Report Templates) (M\u1edaI):<ul> <li>Y\u00eau c\u1ea7u: Giao di\u1ec7n cho Superadmin (c\u00f3 quy\u1ec1n <code>report.manage_report_templates</code>) \u0111\u1ec3 CRUD Report Templates v\u00e0 g\u00e1n cho tenants.</li> </ul> </li> <li>T\u00edch h\u1ee3p API: G\u1ecdi \u0111\u1ebfn c\u00e1c API m\u1edbi c\u1ee7a Reporting Service.</li> <li>Hi\u1ec3n th\u1ecb d\u1ef1a tr\u00ean quy\u1ec1n: UI \u1ea9n/hi\u1ec7n c\u00e1c lo\u1ea1i b\u00e1o c\u00e1o v\u00e0 t\u00ednh n\u0103ng qu\u1ea3n l\u00fd template d\u1ef1a tr\u00ean permission c\u1ee7a ng\u01b0\u1eddi d\u00f9ng. T\u00e1ch bi\u1ec7t r\u00f5 UI cho ng\u01b0\u1eddi xem b\u00e1o c\u00e1o v\u00e0 ng\u01b0\u1eddi qu\u1ea3n l\u00fd template.</li> </ol> <p>IV. C\u1eadp nh\u1eadt c\u00e1c Service Hi\u1ec7n c\u00f3:</p> <ol> <li><code>User Service Master</code>:<ul> <li>B\u1ed5 sung c\u00e1c <code>permission_code</code> m\u1edbi li\u00ean quan \u0111\u1ebfn b\u00e1o c\u00e1o v\u00e0o <code>global_permissions_templates</code>.</li> <li>G\u00e1n c\u00e1c permission n\u00e0y cho c\u00e1c vai tr\u00f2 Superadmin ph\u00f9 h\u1ee3p.</li> <li>Ph\u00e1t ra c\u00e1c s\u1ef1 ki\u1ec7n Pub/Sub chi ti\u1ebft h\u01a1n cho CDC, \u0111\u1ea3m b\u1ea3o event schema \u0111\u01b0\u1ee3c chu\u1ea9n h\u00f3a v\u00e0 c\u00f3 versioning.</li> </ul> </li> <li><code>Auth Service Master</code>:<ul> <li>Ph\u00e1t s\u1ef1 ki\u1ec7n <code>user_login_success</code> v\u1edbi \u0111\u1ea7y \u0111\u1ee7 th\u00f4ng tin c\u1ea7n thi\u1ebft cho <code>fact_login</code>, tu\u00e2n th\u1ee7 event schema \u0111\u00e3 chu\u1ea9n h\u00f3a.</li> </ul> </li> <li><code>User Service Sub</code> v\u00e0 c\u00e1c <code>Adapters</code> (CRM, SIS, LMS):<ul> <li>\u0110\u1ea3m b\u1ea3o c\u00f3 c\u01a1 ch\u1ebf \u0111\u1ea9y d\u1eef li\u1ec7u (\u01b0u ti\u00ean qua Pub/Sub events \u0111\u00e3 \u0111\u01b0\u1ee3c chu\u1ea9n h\u00f3a schema v\u00e0 versioning) ho\u1eb7c cung c\u1ea5p API cho pipeline ETL \u0111\u1ec3 tr\u00edch xu\u1ea5t d\u1eef li\u1ec7u v\u00e0o Data Warehouse.</li> <li>\u0110\u1ea3m b\u1ea3o d\u1eef li\u1ec7u c\u00f3 c\u1ea5u tr\u00fac ph\u00f9 h\u1ee3p, nh\u1ea5t qu\u00e1n, \u0111\u1ee7 chi ti\u1ebft v\u00e0 ch\u1ea5t l\u01b0\u1ee3ng cho c\u1ea3 b\u00e1o c\u00e1o v\u00e0 AI.</li> </ul> </li> </ol> <p>V. C\u1eadp nh\u1eadt T\u00e0i li\u1ec7u Ki\u1ebfn tr\u00fac v\u00e0 ADRs:</p> <ol> <li><code>README.md</code>, <code>system-diagrams.md</code>:<ul> <li>B\u1ed5 sung Reporting Service, Data Warehouse/Data Lake, lu\u1ed3ng qu\u1ea3n l\u00fd Report Template, v\u00e0 \u0111\u1ecbnh h\u01b0\u1edbng t\u00edch h\u1ee3p AI v\u00e0o ki\u1ebfn tr\u00fac t\u1ed5ng th\u1ec3.</li> </ul> </li> <li>ADRs:<ul> <li>T\u1ea1o m\u1edbi:<ul> <li><code>ADR-028: Ki\u1ebfn tr\u00fac H\u1ec7 th\u1ed1ng B\u00e1o c\u00e1o v\u00e0 N\u1ec1n t\u1ea3ng D\u1eef li\u1ec7u</code> (bao g\u1ed3m Reporting Service, Data Warehouse/Data Lake, Data Pipeline, lu\u1ed3ng d\u1eef li\u1ec7u, chi\u1ebfn l\u01b0\u1ee3c schema evolution cho Data Warehouse, c\u00e1c schema c\u1ee5 th\u1ec3 cho <code>fact_login</code>, <code>fact_user</code>, <code>dim_tenant</code>, v\u00e0 \u0111\u1ecbnh h\u01b0\u1edbng AI-ready).</li> <li><code>ADR-029: \u0110\u1ecbnh ngh\u0129a Schema v\u00e0 Metadata cho M\u1eabu B\u00e1o c\u00e1o (Report Template)</code> (m\u00f4 t\u1ea3 chi ti\u1ebft c\u1ea5u tr\u00fac logic, c\u00e1c tham s\u1ed1, lo\u1ea1i bi\u1ec3u \u0111\u1ed3, scope c\u1ee7a m\u1ed9t Report Template, c\u00e1ch l\u01b0u <code>view definition</code> n\u1ebfu d\u00f9ng <code>validated query templates</code>).</li> <li><code>ADR-030: Chu\u1ea9n h\u00f3a Event Schema v\u00e0 Versioning cho To\u00e0n H\u1ec7 th\u1ed1ng</code> (bao g\u1ed3m c\u1ea3 <code>event-catalog.md</code> ho\u1eb7c t\u00edch h\u1ee3p Schema Registry).</li> </ul> </li> <li>C\u1eadp nh\u1eadt:<ul> <li><code>ADR-027 (Data Management Strategy)</code>: B\u1ed5 sung chi\u1ebfn l\u01b0\u1ee3c qu\u1ea3n l\u00fd d\u1eef li\u1ec7u cho Data Warehouse/Data Lake, y\u00eau c\u1ea7u v\u1ec1 ch\u1ea5t l\u01b0\u1ee3ng v\u00e0 \u0111\u1ed9 chi ti\u1ebft d\u1eef li\u1ec7u cho AI, ch\u00ednh s\u00e1ch l\u01b0u tr\u1eef (cold/hot storage), v\u00e0 Data Quality Framework.</li> <li><code>ADR-007 (RBAC Strategy)</code>: B\u1ed5 sung c\u00e1c permission v\u00e0 vai tr\u00f2 li\u00ean quan \u0111\u1ebfn b\u00e1o c\u00e1o v\u00e0 qu\u1ea3n l\u00fd template.</li> <li><code>ADR-008 (Audit Logging)</code>: B\u1ed5 sung y\u00eau c\u1ea7u ghi log audit chi ti\u1ebft cho vi\u1ec7c truy c\u1eadp b\u00e1o c\u00e1o (who, what report, filters used, duration) v\u00e0 c\u00e1c thao t\u00e1c qu\u1ea3n l\u00fd template.</li> <li><code>ADR-004 (Security Policy)</code>: Xem x\u00e9t c\u00e1c kh\u00eda c\u1ea1nh b\u1ea3o m\u1eadt khi AI Agent truy c\u1eadp d\u1eef li\u1ec7u v\u00e0 c\u00e1c r\u1ee7i ro khi cho ph\u00e9p truy v\u1ea5n \u0111\u1ed9ng.</li> <li><code>ADR-020 (Cost Observability)</code>: B\u1ed5 sung vi\u1ec7c theo d\u00f5i v\u00e0 chi\u1ebfn l\u01b0\u1ee3c qu\u1ea3n l\u00fd chi ph\u00ed cho Data Warehouse, Data Pipeline (v\u00ed d\u1ee5: cold/hot storage) v\u00e0 Reporting Service.</li> </ul> </li> </ul> </li> </ol>"},{"location":"requests/01.report-system.request/#4-tac-ong-du-kien","title":"4. T\u00e1c \u0111\u1ed9ng D\u1ef1 ki\u1ebfn","text":"<ul> <li>T\u00edch c\u1ef1c: N\u00e2ng cao \u0111\u00e1ng k\u1ec3 kh\u1ea3 n\u0103ng ra quy\u1ebft \u0111\u1ecbnh d\u1ef1a tr\u00ean d\u1eef li\u1ec7u, chu\u1ea9n h\u00f3a b\u00e1o c\u00e1o, d\u1ec5 b\u1ea3o tr\u00ec, v\u00e0 l\u00e0 n\u1ec1n t\u1ea3ng v\u1eefng ch\u1eafc cho t\u00edch h\u1ee3p AI.</li> <li>Th\u00e1ch th\u1ee9c/Chi ph\u00ed: T\u0103ng \u0111\u1ed9 ph\u1ee9c t\u1ea1p ki\u1ebfn tr\u00fac, \u0111\u00f2i h\u1ecfi k\u1ef9 n\u0103ng m\u1edbi, v\u00e0 t\u0103ng chi ph\u00ed h\u1ea1 t\u1ea7ng (c\u1ea7n qu\u1ea3n l\u00fd qua <code>ADR-020</code>).</li> </ul>"},{"location":"requests/01.report-system.request/#5-cac-ben-lien-quan","title":"5. C\u00e1c B\u00ean Li\u00ean quan","text":"<ul> <li>Ban Gi\u00e1m \u0111\u1ed1c (BoD) VAS</li> <li>\u0110\u1ed9i ng\u0169 Superadmin H\u1ec7 th\u1ed1ng</li> <li>\u0110\u1ed9i ng\u0169 Ph\u00e1t tri\u1ec3n DX-VAS (Backend, Frontend, DevOps, Data, AI)</li> <li>Vendor (n\u1ebfu c\u00f3)</li> </ul>"},{"location":"requests/01.report-system.request/#6-gia-inh-va-rang-buoc","title":"6. Gi\u1ea3 \u0111\u1ecbnh v\u00e0 R\u00e0ng bu\u1ed9c","text":"<ul> <li>C\u00f4ng ngh\u1ec7 c\u1ee5 th\u1ec3 cho Data Warehouse, Data Pipeline, v\u00e0 Reporting Service s\u1ebd \u0111\u01b0\u1ee3c quy\u1ebft \u0111\u1ecbnh trong <code>ADR-028</code>.</li> <li>Ph\u1ea1m vi c\u00e1c b\u00e1o c\u00e1o v\u00e0 template c\u1ee5 th\u1ec3 s\u1ebd \u0111\u01b0\u1ee3c l\u00e0m r\u00f5 h\u01a1n trong giai \u0111o\u1ea1n thi\u1ebft k\u1ebf chi ti\u1ebft.</li> <li>Vi\u1ec7c ph\u00e1t tri\u1ec3n c\u00e1c AI Agent c\u1ee5 th\u1ec3 n\u1eb1m ngo\u00e0i ph\u1ea1m vi CR n\u00e0y.</li> </ul>"},{"location":"requests/01.report-system.request/#7-e-xuat-ke-hoach-trien-khai-so-bo-dua-tren-goi-y-cua-john","title":"7. \u0110\u1ec1 xu\u1ea5t K\u1ebf ho\u1ea1ch Tri\u1ec3n khai S\u01a1 b\u1ed9 (D\u1ef1a tr\u00ean g\u1ee3i \u00fd c\u1ee7a John)","text":"Tu\u1ea7n H\u00e0nh \u0111\u1ed9ng c\u1ee5 th\u1ec3 1-2 Ho\u00e0n thi\u1ec7n ADR-028, ADR-029, v\u00e0 (b\u1eaft \u0111\u1ea7u) ADR-030. Ho\u00e0n thi\u1ec7n schema ban \u0111\u1ea7u cho Data Warehouse v\u00e0 c\u00e1c <code>event schema</code> ch\u00ednh. 3-4 MVP Data Pipeline t\u1eeb c\u00e1c service ngu\u1ed3n \u01b0u ti\u00ean. MVP Reporting Service API v1. 5-6 Ph\u00e1t tri\u1ec3n module Webapp c\u01a1 b\u1ea3n cho vi\u1ec7c xem b\u00e1o c\u00e1o. Ki\u1ec3m th\u1eed t\u00edch h\u1ee3p API v\u00e0 Data Pipeline. 7-8 T\u00edch h\u1ee3p ch\u1ee9c n\u0103ng qu\u1ea3n l\u00fd Report Template (MVP) v\u00e0 Saved Dashboard Config (MVP) v\u00e0o Superadmin Webapp. Ho\u00e0n thi\u1ec7n Audit Log tracking cho b\u00e1o c\u00e1o. 8+ M\u1edf r\u1ed9ng Data Pipeline cho c\u00e1c Adapters. Ph\u00e1t tri\u1ec3n c\u00e1c b\u00e1o c\u00e1o/template ph\u1ee9c t\u1ea1p h\u01a1n. Chu\u1ea9n b\u1ecb c\u00e1c \"data views\" s\u1eb5n s\u00e0ng cho AI."},{"location":"services/","title":"\ud83d\udcda Service Catalog \u2013 Thi\u1ebft k\u1ebf Ki\u1ebfn tr\u00fac theo Service","text":"<p>T\u00e0i li\u1ec7u n\u00e0y li\u1ec7t k\u00ea c\u00e1c Service ch\u00ednh trong h\u1ec7 th\u1ed1ng <code>dx-vas</code>, \u0111\u01b0\u1ee3c t\u1ed5 ch\u1ee9c theo \u0111\u1ecbnh h\u01b0\u1edbng microservices. M\u1ed7i service c\u00f3 m\u1ed9t th\u01b0 m\u1ee5c ri\u00eang ch\u1ee9a c\u00e1c t\u00e0i li\u1ec7u thi\u1ebft k\u1ebf chi ti\u1ebft.</p>"},{"location":"services/#1-cau-truc-tai-lieu-cho-moi-service","title":"1. \ud83e\uddf1 C\u1ea5u tr\u00fac T\u00e0i li\u1ec7u cho M\u1ed7i Service","text":"<p>M\u1ed7i th\u01b0 m\u1ee5c c\u1ee7a m\u1ed9t service s\u1ebd tu\u00e2n theo c\u1ea5u tr\u00fac chu\u1ea9n nh\u01b0 sau:</p> <pre><code>docs/services/&lt;service-name&gt;/\n\u251c\u2500\u2500 design.md             # \u2705 T\u00e0i li\u1ec7u Thi\u1ebft k\u1ebf T\u1ed5ng quan (Service Design Document - SDD)\n\u251c\u2500\u2500 interface-contract.md # \ud83d\udcd8 Giao di\u1ec7n API m\u00f4 t\u1ea3 b\u1eb1ng Markdown (business-level)\n\u251c\u2500\u2500 data-model.md         # \ud83d\uddc4\ufe0f M\u00f4 h\u00ecnh d\u1eef li\u1ec7u chi ti\u1ebft \u2013 m\u00f4 t\u1ea3 schema, quan h\u1ec7, ch\u1ec9 m\u1ee5c\n\u2514\u2500\u2500 openapi.yaml          # \ud83d\udce1 \u0110\u1eb7c t\u1ea3 k\u1ef9 thu\u1eadt OpenAPI (machine-readable)\n</code></pre>"},{"location":"services/#y-nghia-cua-tung-file","title":"\ud83d\udcc4 \u00dd ngh\u0129a c\u1ee7a t\u1eebng file:","text":"<ul> <li> <p><code>design.md</code>   Bao g\u1ed3m: Scope, Tr\u00e1ch nhi\u1ec7m, Flow nghi\u1ec7p v\u1ee5 ch\u00ednh, T\u01b0\u01a1ng t\u00e1c gi\u1eefa service, C\u00e1c s\u1ef1 ki\u1ec7n ph\u00e1t ra/nghe, B\u1ea3o m\u1eadt, C\u1ea5u h\u00ecnh runtime, v\u00e0 Chi\u1ebfn l\u01b0\u1ee3c test. \u0110\u00e2y l\u00e0 t\u00e0i li\u1ec7u trung t\u00e2m c\u1ee7a m\u1ed7i service.</p> </li> <li> <p><code>interface-contract.md</code>   Giao di\u1ec7n API m\u00f4 t\u1ea3 \u1edf m\u1ee9c nghi\u1ec7p v\u1ee5 (d\u1ec5 \u0111\u1ecdc cho dev/backend/frontend). D\u1ea1ng Markdown d\u1ec5 review, kh\u00f4ng ph\u1ee5 thu\u1ed9c YAML.</p> </li> <li> <p><code>data-model.md</code>   M\u00f4 t\u1ea3 c\u00e1c b\u1ea3ng, c\u1ed9t, quan h\u1ec7, constraint, index. \u0110\u01b0\u1ee3c vi\u1ebft r\u00f5 r\u00e0ng \u0111\u1ec3 ph\u1ee5c v\u1ee5 review DB, code backend, v\u00e0 migration strategy.</p> </li> <li> <p><code>openapi.yaml</code>   Chu\u1ea9n h\u00f3a API specification cho CI/CD, test t\u1ef1 \u0111\u1ed9ng, v\u00e0 dev tool (VSCode plugin, Swagger UI\u2026).</p> </li> </ul> <p>\u2705 Vi\u1ec7c tu\u00e2n th\u1ee7 c\u1ea5u tr\u00fac tr\u00ean gi\u00fap to\u00e0n b\u1ed9 t\u00e0i li\u1ec7u ki\u1ebfn tr\u00fac c\u1ee7a <code>dx-vas</code> th\u1ed1ng nh\u1ea5t, d\u1ec5 t\u00ecm, d\u1ec5 review, d\u1ec5 onboard ng\u01b0\u1eddi m\u1edbi.</p>"},{"location":"services/#2-duoi-ay-la-danh-sach-cac-service-trong-he-thong-dx-vas-uoc-sap-xep-theo-thu-tu-uu-tien-tu-cao-en-thap-phan-anh-ung-lo-trinh-trien-khai-hien-tai-va-tinh-phu-thuoc-giua-cac-thanh-phan","title":"2. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 danh s\u00e1ch c\u00e1c service trong h\u1ec7 th\u1ed1ng dx-vas, \u0111\u01b0\u1ee3c s\u1eafp x\u1ebfp theo th\u1ee9 t\u1ef1 \u01b0u ti\u00ean t\u1eeb cao \u0111\u1ebfn th\u1ea5p, ph\u1ea3n \u00e1nh \u0111\u00fang l\u1ed9 tr\u00ecnh tri\u1ec3n khai hi\u1ec7n t\u1ea1i v\u00e0 t\u00ednh ph\u1ee5 thu\u1ed9c gi\u1eefa c\u00e1c th\u00e0nh ph\u1ea7n:","text":""},{"location":"services/#danh-sach-service-theo-uu-tien","title":"\ud83d\udd1d Danh s\u00e1ch Service theo \u01afu ti\u00ean","text":"<p>On Process</p> \u01afu ti\u00ean Service M\u00f4 t\u1ea3 Tr\u1ea1ng th\u00e1i 1\ufe0f\u20e3 <code>token-service/</code> L\u00e0 tr\u00e1i tim b\u1ea3o m\u1eadt, ph\u00e1t h\u00e0nh v\u00e0 qu\u1ea3n l\u00fd v\u00f2ng \u0111\u1eddi JWT cho to\u00e0n h\u1ec7 th\u1ed1ng. \u2705 Ho\u00e0n th\u00e0nh 2\ufe0f\u20e3 <code>api-gateway/</code> C\u1ed5ng v\u00e0o duy nh\u1ea5t, \u0111\u1ecbnh tuy\u1ebfn, th\u1ef1c thi b\u1ea3o m\u1eadt (JWT, RBAC), v\u00e0 rate-limit. \u2705 Ho\u00e0n th\u00e0nh 3\ufe0f\u20e3 <code>auth-service/master/</code> X\u1eed l\u00fd x\u00e1c th\u1ef1c t\u1eadp trung qua Google OAuth2, \u0111i\u1ec1u ph\u1ed1i vi\u1ec7c c\u1ea5p token. \u2705 Ho\u00e0n th\u00e0nh 4\ufe0f\u20e3 <code>user-service/master/</code> Qu\u1ea3n l\u00fd \u0111\u1ecbnh danh ng\u01b0\u1eddi d\u00f9ng v\u00e0 template RBAC to\u00e0n c\u1ee5c, ph\u00e1t s\u1ef1 ki\u1ec7n \u0111\u1ed3ng b\u1ed9. \u2705 Ho\u00e0n th\u00e0nh 5\ufe0f\u20e3 <code>auth-service/sub/</code> X\u1eed l\u00fd x\u00e1c th\u1ef1c c\u1ee5c b\u1ed9 t\u1ea1i tenant (Local/OTP), t\u00edch h\u1ee3p v\u1edbi Auth Master. \u2705 Ho\u00e0n th\u00e0nh 6\ufe0f\u20e3 <code>user-service/sub/</code> Qu\u1ea3n l\u00fd ng\u01b0\u1eddi d\u00f9ng v\u00e0 RBAC trong ph\u1ea1m vi tenant, nh\u1eadn d\u1eef li\u1ec7u \u0111\u1ed3ng b\u1ed9 t\u1eeb Master. \u2705 Ho\u00e0n th\u00e0nh 7\ufe0f\u20e3 <code>sms-service/</code> Cung c\u1ea5p nghi\u1ec7p v\u1ee5 l\u00f5i cho tenant (CRM, SIS, LMS), thay th\u1ebf c\u00e1c adapter c\u0169. \u2b1c Ch\u01b0a b\u1eaft \u0111\u1ea7u 8\ufe0f\u20e3 <code>notification-service/master/</code> \u0110i\u1ec1u ph\u1ed1i vi\u1ec7c g\u1eedi th\u00f4ng b\u00e1o, qu\u1ea3n l\u00fd template chung v\u00e0 ph\u00e1t s\u1ef1 ki\u1ec7n fan-out. \u2705 Ho\u00e0n th\u00e0nh 9\ufe0f\u20e3 <code>notification-service/sub/</code> Nh\u1eadn s\u1ef1 ki\u1ec7n v\u00e0 th\u1ef1c thi g\u1eedi th\u00f4ng b\u00e1o (email/SMS) v\u1edbi c\u1ea5u h\u00ecnh ri\u00eang c\u1ee7a tenant. \u2705 Ho\u00e0n th\u00e0nh \ud83d\udd1f <code>reporting-service/</code> Truy v\u1ea5n Data Warehouse, sinh b\u00e1o c\u00e1o ph\u00e2n t\u00edch theo template v\u00e0 quy\u1ec1n h\u1ea1n. \u2705 Ho\u00e0n th\u00e0nh 1\ufe0f\u20e31\ufe0f\u20e3 <code>audit-logging-service/</code> Thu th\u1eadp, l\u01b0u tr\u1eef, v\u00e0 cung c\u1ea5p giao di\u1ec7n truy v\u1ea5n c\u00e1c log ki\u1ec3m to\u00e1n quan tr\u1ecdng. \u2705 Ho\u00e0n th\u00e0nh <p>V\u00ed d\u1ee5:</p>"},{"location":"services/#user-service-master","title":"\ud83e\udde0 User Service Master","text":"<ul> <li>T\u1ed5ng quan thi\u1ebft k\u1ebf (design.md)</li> <li>Giao di\u1ec7n API (interface-contract.md)</li> <li>M\u00f4 h\u00ecnh d\u1eef li\u1ec7u (data-model.md)</li> <li>OpenAPI Spec (openapi.yaml)</li> </ul>"},{"location":"services/#3-chinh-sach-at-serversurl-trong-openapi-cho-cac-service","title":"3. \ud83d\udce1 Ch\u00ednh s\u00e1ch \u0111\u1eb7t <code>servers.url</code> trong OpenAPI cho c\u00e1c Service","text":"<p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 quy \u01b0\u1edbc \u0111\u1eb7t <code>servers.url</code> cho t\u1eebng lo\u1ea1i service trong h\u1ec7 th\u1ed1ng <code>dx-vas</code>, nh\u1eb1m \u0111\u1ea3m b\u1ea3o th\u1ed1ng nh\u1ea5t versioning v\u00e0 routing.</p>"},{"location":"services/#auth-servicemaster-co-v1","title":"\ud83d\udd12 <code>auth-service/master</code> \u2013 C\u00f3 <code>/v1</code>","text":"<pre><code>servers:\n  - url: https://api.truongvietanh.edu.vn/auth-master/v1\n    description: Production server\n</code></pre> <p>\u2705 L\u00fd do:</p> <ul> <li>L\u00e0 public-facing API, g\u1ecdi tr\u1ef1c ti\u1ebfp t\u1eeb frontend.</li> <li>C\u00e1c API nh\u01b0 <code>login-via-otp</code>, <code>login-via-local</code>, <code>oauth2/callback</code> c\u00f3 th\u1ec3 thay \u0111\u1ed5i request/response theo version.</li> <li>C\u1ea7n version t\u01b0\u1eddng minh \u0111\u1ec3 h\u1ed7 tr\u1ee3 backward compatibility &amp; route control t\u1ea1i API Gateway.</li> </ul>"},{"location":"services/#token-service-khong-co-v1","title":"\ud83c\udfaf <code>token-service</code> \u2013 Kh\u00f4ng c\u00f3 <code>/v1</code>","text":"<pre><code>servers:\n  - url: https://api.truongvietanh.edu.vn/token\n    description: Production\n  - url: https://staging.truongvietanh.edu.vn/token\n    description: Staging\n</code></pre> <p>\u274c Kh\u00f4ng c\u1ea7n <code>/v1</code> trong URL path</p> <p>\u2705 L\u00fd do:</p> <ul> <li>L\u00e0 internal service, ch\u1ec9 \u0111\u01b0\u1ee3c g\u1ecdi t\u1eeb <code>auth-service</code>.</li> <li>API mang t\u00ednh RPC (<code>/issue</code>, <code>/revoke</code>, <code>/introspect</code>) v\u00e0 hi\u1ebfm khi c\u1ea7n public backward compatibility.</li> <li>Version \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd qua deployment tag (CI/CD), kh\u00f4ng c\u1ea7n expose qua path.</li> </ul>"},{"location":"services/#api-gateway-khong-co-v1-proxy-toan-bo","title":"\ud83d\udee1\ufe0f <code>api-gateway</code> \u2013 Kh\u00f4ng c\u00f3 <code>/v1</code> (proxy to\u00e0n b\u1ed9)","text":"<pre><code>servers:\n  - url: https://api.truongvietanh.edu.vn/\n    description: API Gateway\n</code></pre> <p>\u2705 L\u00fd do:</p> <ul> <li>Gateway kh\u00f4ng cung c\u1ea5p business API ri\u00eang, m\u00e0 proxy to\u00e0n b\u1ed9 sang c\u00e1c service kh\u00e1c.</li> <li>T\u1eebng service g\u1eafn version trong path c\u1ee7a ch\u00ednh n\u00f3 n\u1ebfu c\u1ea7n (<code>/auth-master/v1</code>, <code>/reporting/v2</code>,\u2026).</li> </ul>"},{"location":"services/#ghi-chu-quan-trong","title":"\ud83d\udccc Ghi ch\u00fa quan tr\u1ecdng:","text":"<ul> <li>\u2757 N\u1ebfu m\u1ed9t service ph\u1ee5c v\u1ee5 frontend ho\u1eb7c c\u00f3 kh\u1ea3 n\u0103ng thay \u0111\u1ed5i API \u2192 b\u1eaft bu\u1ed9c d\u00f9ng version trong URL (<code>/v1</code>, <code>/v2</code>,\u2026).</li> <li>\u2705 N\u1ebfu l\u00e0 internal RPC \u2192 gi\u1eef path \u0111\u01a1n gi\u1ea3n, version h\u00f3a qua CI/CD ho\u1eb7c headers.</li> </ul>"},{"location":"services/api-gateway/data-model/","title":"\ud83d\udcc3 API Gateway - Data Model","text":""},{"location":"services/api-gateway/data-model/#1-gioi-thieu","title":"1. Gi\u1edbi thi\u1ec7u","text":"<p>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 m\u00f4 h\u00ecnh d\u1eef li\u1ec7u c\u1ee7a API Gateway, m\u1ed9t core service trong h\u1ec7 sinh th\u00e1i DX-VAS \u0111\u00f3ng vai tr\u00f2 nh\u01b0 m\u1ed9t \u0111i\u1ec3m v\u00e0o t\u1eadp trung cho t\u1ea5t c\u1ea3 c\u00e1c frontend apps. Gateway th\u1ef1c hi\u1ec7n proxy \u0111\u1ecbnh tuy\u1ebfn \u0111\u1ebfn backend service t\u01b0\u01a1ng \u1ee9ng, \u0111\u1ed3ng th\u1eddi enforce RBAC, x\u00e1c th\u1ef1c JWT, ghi log v\u00e0 thu th\u1eadp metrics ph\u1ee5c v\u1ee5 observability.</p>"},{"location":"services/api-gateway/data-model/#muc-tieu-cua-mo-hinh-du-lieu","title":"\ud83c\udfaf M\u1ee5c ti\u00eau c\u1ee7a m\u00f4 h\u00ecnh d\u1eef li\u1ec7u","text":"<p>Kh\u00e1c v\u1edbi c\u00e1c service nghi\u1ec7p v\u1ee5 kh\u00e1c, API Gateway kh\u00f4ng duy tr\u00ec c\u01a1 s\u1edf d\u1eef li\u1ec7u quan h\u1ec7 ph\u1ee9c t\u1ea1p. Thay v\u00e0o \u0111\u00f3, ki\u1ebfn tr\u00fac c\u1ee7a Gateway ph\u1ee5 thu\u1ed9c g\u1ea7n nh\u01b0 ho\u00e0n to\u00e0n v\u00e0o c\u00e1c l\u1edbp cache th\u00f4ng minh, v\u1edbi th\u1eddi gian truy xu\u1ea5t si\u00eau nhanh v\u00e0 kh\u1ea3 n\u0103ng invalidate \u0111\u1ed9ng. M\u00f4 h\u00ecnh d\u1eef li\u1ec7u c\u1ee7a Gateway \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf \u0111\u1ec3:</p> <ul> <li>\u0110\u1ecbnh tuy\u1ebfn ch\u00ednh x\u00e1c request \u0111\u1ebfn backend ph\u00f9 h\u1ee3p qua <code>route_config</code></li> <li>Th\u1ef1c thi ph\u00e2n quy\u1ec1n t\u1ed1c \u0111\u1ed9 cao qua <code>rbac</code> rule \u0111\u01b0\u1ee3c cache</li> <li>Ng\u0103n ch\u1eb7n token b\u1ecb thu h\u1ed3i th\u00f4ng qua <code>revoked</code> token cache</li> <li>X\u00e1c th\u1ef1c JWT hi\u1ec7u qu\u1ea3 b\u1eb1ng c\u00e1ch cache JWKS key t\u1eeb <code>token-service</code></li> <li>T\u1ef1 \u0111\u1ed9ng l\u00e0m m\u1edbi th\u00f4ng tin khi c\u00f3 thay \u0111\u1ed5i c\u1ea5u h\u00ecnh nh\u1edd v\u00e0o TTL ho\u1eb7c Pub/Sub</li> </ul>"},{"location":"services/api-gateway/data-model/#phan-loai-state-chinh","title":"\ud83d\udce6 Ph\u00e2n lo\u1ea1i state ch\u00ednh","text":"Lo\u1ea1i d\u1eef li\u1ec7u L\u01b0u \u1edf \u0111\u00e2u? M\u1ee5c \u0111\u00edch ch\u00ednh Route config Redis (<code>routes:</code>) Tra c\u1ee9u \u0111\u1ecbnh tuy\u1ebfn \u2192 backend t\u01b0\u01a1ng \u1ee9ng Permission RBAC Redis (<code>rbac:</code>) Ki\u1ec3m tra ph\u00e2n quy\u1ec1n theo user_id + tenant_id Token revoked Redis (<code>revoked:</code>) X\u00e1c minh token \u0111\u00e3 b\u1ecb thu h\u1ed3i ch\u01b0a (JTI) JWKS Key Redis (<code>jwks:</code>) Cache public key verify JWT, gi\u1ea3m g\u1ecdi <code>token-service</code> Processed Events PostgreSQL Ghi nh\u1eadn c\u00e1c event \u0111\u00e3 x\u1eed l\u00fd \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o idempotency <p>\ud83d\udd0d Gateway c\u00f3 th\u1ec3 ho\u1ea1t \u0111\u1ed9ng g\u1ea7n nh\u01b0 to\u00e0n b\u1ed9 tr\u00ean RAM n\u1ebfu Redis cache \u0111\u1ee7 hit-rate, gi\u00fap \u0111\u1ea1t hi\u1ec7u n\u0103ng tuy\u1ebfn \u0111\u1ea7u ~10.000 RPS.</p>"},{"location":"services/api-gateway/data-model/#2-pham-vi-du-lieu-quan-ly-scope","title":"2. Ph\u1ea1m vi D\u1eef li\u1ec7u Qu\u1ea3n l\u00fd (Scope)","text":"<p>D\u1eef li\u1ec7u m\u00e0 API Gateway qu\u1ea3n l\u00fd \u0111\u01b0\u1ee3c chia th\u00e0nh hai lo\u1ea1i ch\u00ednh:</p> <ul> <li>Stateful ng\u1eafn h\u1ea1n (ephemeral cache): l\u01b0u tr\u1eef trong Redis, ch\u1ee7 y\u1ebfu ph\u1ee5c v\u1ee5 hi\u1ec7u n\u0103ng th\u1eddi gian th\u1ef1c, c\u00f3 TTL ng\u1eafn v\u00e0 c\u00f3 th\u1ec3 t\u00e1i t\u1ea1o t\u1eeb h\u1ec7 th\u1ed1ng g\u1ed1c (stateless sync).</li> <li>Stateful d\u00e0i h\u1ea1n (persistence): l\u01b0u tr\u1eef trong PostgreSQL, ch\u1ee7 y\u1ebfu ph\u1ee5c v\u1ee5 m\u1ee5c \u0111\u00edch \u0111\u1ea3m b\u1ea3o t\u00ednh \u0111\u00fang \u0111\u1eafn (idempotency, log) cho c\u00e1c k\u1ecbch b\u1ea3n async ho\u1eb7c Pub/Sub.</li> </ul>"},{"location":"services/api-gateway/data-model/#21-redis-cache-phuc-vu-hieu-nang-thoi-gian-thuc","title":"2.1. \ud83d\udd01 Redis Cache \u2013 ph\u1ee5c v\u1ee5 hi\u1ec7u n\u0103ng th\u1eddi gian th\u1ef1c","text":"Key Pattern M\u1ee5c \u0111\u00edch TTL m\u1eb7c \u0111\u1ecbnh <code>routes:{path}:{method}</code> Tra c\u1ee9u \u0111\u1ecbnh tuy\u1ebfn: route \u2192 backend service, timeout, retry 300 gi\u00e2y <code>rbac:{user_id}:{tenant}</code> Danh s\u00e1ch permission \u0111\u00e3 resolved c\u1ee7a user trong tenant 300 gi\u00e2y <code>revoked:{jti}</code> Ki\u1ec3m tra token \u0111\u00e3 b\u1ecb thu h\u1ed3i 180 gi\u00e2y <code>jwks:public_key</code> Cache public JWKS key t\u1eeb <code>token-service</code> \u0111\u1ec3 x\u00e1c th\u1ef1c JWT 600 gi\u00e2y <ul> <li>M\u1ecdi cache \u0111\u1ec1u c\u00f3 th\u1ec3 b\u1ecb invalidated b\u1edfi TTL, ho\u1eb7c ch\u1ee7 \u0111\u1ed9ng qua Pub/Sub (v\u00ed d\u1ee5: <code>rbac.updated</code>).</li> <li>Gateway s\u1ebd fallback t\u1ef1 \u0111\u1ed9ng n\u1ebfu cache miss (g\u1ecdi <code>user-sub</code>, <code>token-service</code>...).</li> </ul> <p>\ud83d\udccc M\u1ed9t s\u1ed1 field \u0111\u01b0\u1ee3c tr\u00edch xu\u1ea5t t\u1eeb JWT (nh\u01b0 <code>sub</code>, <code>tenant_id</code>, <code>login_method</code>) s\u1ebd \u0111\u01b0\u1ee3c forward qua header cho c\u00e1c backend service, nh\u01b0ng kh\u00f4ng \u0111\u01b0\u1ee3c cache ri\u00eang trong Redis t\u1ea1i Gateway. Ch\u00fang l\u00e0 k\u1ebft qu\u1ea3 c\u1ee7a qu\u00e1 tr\u00ecnh decode JWT (offline introspection) v\u00e0 ch\u1ec9 \u0111\u01b0\u1ee3c gi\u1eef t\u1ea1m trong memory per-request.</p>"},{"location":"services/api-gateway/data-model/#22-postgresql-phuc-vu-tinh-ung-an-log-ky-thuat","title":"2.2. \ud83d\uddc3\ufe0f PostgreSQL \u2013 ph\u1ee5c v\u1ee5 t\u00ednh \u0111\u00fang \u0111\u1eafn &amp; log k\u1ef9 thu\u1eadt","text":"B\u1ea3ng d\u1eef li\u1ec7u M\u1ee5c \u0111\u00edch <code>route_config</code> Qu\u1ea3n l\u00fd route rule, timeout, retry, RBAC y\u00eau c\u1ea7u cho m\u1ed7i endpoint <code>processed_events</code> L\u01b0u d\u1ea5u v\u1ebft event \u0111\u00e3 x\u1eed l\u00fd \u0111\u1ec3 ch\u1ed1ng x\u1eed l\u00fd l\u1ea1i (idempotency) <p>\ud83d\udccc C\u00e1c c\u1ea5u tr\u00fac d\u1eef li\u1ec7u trong cache lu\u00f4n \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 ho\u1eb7c t\u00e1i t\u1ea1o t\u1eeb c\u00e1c h\u1ec7 th\u1ed1ng g\u1ed1c (User Service, Token Service, Config Center\u2026). Gateway kh\u00f4ng s\u1edf h\u1eefu quy\u1ec1n quy\u1ebft \u0111\u1ecbnh cu\u1ed1i c\u00f9ng v\u1edbi d\u1eef li\u1ec7u nghi\u1ec7p v\u1ee5 \u2013 n\u00f3 ch\u1ec9 l\u00e0 c\u01a1 ch\u1ebf \u0111i\u1ec1u ph\u1ed1i t\u1ed1c \u0111\u1ed9 cao v\u00e0 \u0111\u00e1ng tin c\u1eady.</p>"},{"location":"services/api-gateway/data-model/#23-bang-tong-hop-redis-cache-cau-truc-vi-du","title":"2.3. B\u1ea3ng T\u1ed5ng H\u1ee3p Redis Cache \u2013 C\u1ea5u Tr\u00fac &amp; V\u00ed D\u1ee5","text":"<p>Redis l\u00e0 n\u01a1i l\u01b0u tr\u1eef to\u00e0n b\u1ed9 state ng\u1eafn h\u1ea1n \u0111\u1ec3 t\u0103ng hi\u1ec7u n\u0103ng x\u1eed l\u00fd tuy\u1ebfn \u0111\u1ea7u c\u1ee7a API Gateway. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 m\u00f4 t\u1ea3 chi ti\u1ebft t\u1eebng key pattern, c\u1ea5u tr\u00fac d\u1eef li\u1ec7u v\u00e0 v\u00ed d\u1ee5 minh h\u1ecda.</p>"},{"location":"services/api-gateway/data-model/#key-routespathmethod","title":"\ud83d\udd11 Key: <code>routes:{path}:{method}</code>","text":"<p>M\u1ee5c \u0111\u00edch: Tra c\u1ee9u c\u1ea5u h\u00ecnh \u0111\u1ecbnh tuy\u1ebfn c\u1ee7a route (timeout, retry, backend, permission\u2026)</p> <p>C\u1ea5u tr\u00fac JSON: <pre><code>{\n  \"backend\": \"user-service.master\",\n  \"x-required-permission\": \"user.read\",\n  \"x-condition\": {\n    \"user_id\": \"{{X-User-ID}}\"\n  },\n  \"timeout\": 3000,\n  \"retry\": 2\n}\n</code></pre></p> <p>TTL m\u1eb7c \u0111\u1ecbnh: 300 gi\u00e2y C\u01a1 ch\u1ebf c\u1eadp nh\u1eadt: Polling file <code>route_config.json</code> ho\u1eb7c l\u1eafng nghe Pub/Sub <code>route_config.updated</code></p>"},{"location":"services/api-gateway/data-model/#key-rbacuser_idtenant_id","title":"\ud83d\udd11 Key: <code>rbac:{user_id}:{tenant_id}</code>","text":"<p>M\u1ee5c \u0111\u00edch: L\u01b0u danh s\u00e1ch permission c\u1ee7a user theo tenant \u2013 \u0111\u01b0\u1ee3c resolve t\u1eeb <code>user-sub</code>.</p> <p>C\u1ea5u tr\u00fac JSON:</p> <pre><code>{\n  \"user_id\": \"u123\",\n  \"tenant_id\": \"t456\",\n  \"permissions\": [\n    \"user.read\",\n    \"user.update.self\",\n    \"report.view_summary\"\n  ],\n  \"resolved_at\": \"2025-06-10T11:33:00Z\"\n}\n</code></pre> <p>TTL m\u1eb7c \u0111\u1ecbnh: 300 gi\u00e2y C\u01a1 ch\u1ebf invalidate: TTL ho\u1eb7c l\u1eafng nghe s\u1ef1 ki\u1ec7n <code>rbac.updated</code> (Pub/Sub)</p> <p>\ud83d\udd0d Tr\u01b0\u1eddng <code>login_method</code> kh\u00f4ng n\u1eb1m trong cache RBAC m\u00e0 \u0111\u01b0\u1ee3c l\u1ea5y t\u1eeb JWT payload v\u00e0 forward qua <code>X-Login-Method</code>. Backend c\u00f3 th\u1ec3 d\u00f9ng field n\u00e0y \u0111\u1ec3 ph\u00e2n nh\u00e1nh logic, nh\u01b0ng Gateway kh\u00f4ng qu\u1ea3n l\u00fd cache ri\u00eang cho n\u00f3.</p>"},{"location":"services/api-gateway/data-model/#key-revokedjti","title":"\ud83d\udd11 Key: <code>revoked:{jti}</code>","text":"<p>M\u1ee5c \u0111\u00edch: Ki\u1ec3m tra xem token \u0111\u00e3 b\u1ecb thu h\u1ed3i ch\u01b0a. \u0110\u01b0\u1ee3c set sau khi g\u1ecdi <code>token/introspect</code> ho\u1eb7c khi ng\u01b0\u1eddi d\u00f9ng logout.</p> <p>Gi\u00e1 tr\u1ecb: <code>\"true\"</code> ho\u1eb7c <code>\"false\"</code></p> <p>V\u00ed d\u1ee5:</p> <pre><code>Key: revoked:7a99e531-2aeb-4c4d-8440-33513f5fc123\nValue: \"true\"\n</code></pre> <p>TTL m\u1eb7c \u0111\u1ecbnh: 180 gi\u00e2y C\u01a1 ch\u1ebf ghi: Ghi khi revoke ho\u1eb7c sau khi introspect token</p>"},{"location":"services/api-gateway/data-model/#key-jwkspublic_key","title":"\ud83d\udd11 Key: <code>jwks:public_key</code>","text":"<p>M\u1ee5c \u0111\u00edch: Cache JWKS t\u1eeb <code>token-service</code> \u0111\u1ec3 x\u00e1c th\u1ef1c ch\u1eef k\u00fd JWT offline.</p> <p>C\u1ea5u tr\u00fac JSON (r\u00fat g\u1ecdn):</p> <pre><code>{\n  \"keys\": [\n    {\n      \"kty\": \"RSA\",\n      \"kid\": \"key-001\",\n      \"use\": \"sig\",\n      \"alg\": \"RS256\",\n      \"n\": \"...\",\n      \"e\": \"AQAB\"\n    }\n  ],\n  \"fetched_at\": \"2025-06-10T11:40:00Z\"\n}\n</code></pre> <p>TTL m\u1eb7c \u0111\u1ecbnh: 600 gi\u00e2y C\u01a1 ch\u1ebf refresh: TTL h\u1ebft h\u1ea1n ho\u1eb7c trigger t\u1eeb <code>jwt.jwks.rotated</code></p> <p>\u2705 T\u1ea5t c\u1ea3 c\u00e1c cache Redis \u0111\u1ec1u c\u00f3 th\u1ec3 b\u1ecb flush th\u1ee7 c\u00f4ng b\u1eb1ng CLI, ho\u1eb7c t\u1ef1 \u0111\u1ed9ng h\u00f3a b\u1eb1ng cron/task theo config TTL. \u2705 M\u1ecdi Redis key n\u00ean \u0111\u01b0\u1ee3c monitor qua metrics: hit/miss ratio, TTL remaining, size.</p>"},{"location":"services/api-gateway/data-model/#3-ngoai-pham-vi-out-of-scope","title":"3. Ngo\u00e0i Ph\u1ea1m Vi (Out of Scope)","text":"<p>API Gateway kh\u00f4ng s\u1edf h\u1eefu d\u1eef li\u1ec7u nghi\u1ec7p v\u1ee5, kh\u00f4ng quy\u1ebft \u0111\u1ecbnh quy\u1ec1n truy c\u1eadp cu\u1ed1i c\u00f9ng, c\u0169ng kh\u00f4ng gi\u1eef b\u1ea5t k\u1ef3 th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng hay session n\u00e0o. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c lo\u1ea1i d\u1eef li\u1ec7u ho\u1eb7c logic kh\u00f4ng n\u1eb1m trong ph\u1ea1m vi qu\u1ea3n l\u00fd c\u1ee7a m\u00f4 h\u00ecnh d\u1eef li\u1ec7u Gateway:</p> <ul> <li> <p>\u2716\ufe0f D\u1eef li\u1ec7u ng\u01b0\u1eddi d\u00f9ng, x\u00e1c th\u1ef1c danh t\u00ednh</p> <ul> <li>Kh\u00f4ng l\u01b0u th\u00f4ng tin user (profile, role, tr\u1ea1ng th\u00e1i...)</li> <li>Kh\u00f4ng x\u1eed l\u00fd \u0111\u0103ng nh\u1eadp, c\u1ea5p token, x\u00e1c th\u1ef1c danh t\u00ednh (do <code>auth-service</code> v\u00e0 <code>token-service</code> \u0111\u1ea3m nhi\u1ec7m)</li> </ul> </li> <li> <p>\u2716\ufe0f C\u01a1 s\u1edf d\u1eef li\u1ec7u nghi\u1ec7p v\u1ee5</p> <ul> <li>Kh\u00f4ng l\u01b0u danh s\u00e1ch l\u1edbp, b\u00e0i h\u1ecdc, b\u00e1o c\u00e1o, h\u1ee3p \u0111\u1ed3ng, h\u1ecdc sinh...</li> <li>Gateway ch\u1ec9 proxy request \u0111\u1ebfn service c\u00f3 DB ri\u00eang</li> </ul> </li> <li> <p>\u2716\ufe0f Session, tr\u1ea1ng th\u00e1i ng\u01b0\u1eddi d\u00f9ng</p> <ul> <li>Gateway kh\u00f4ng qu\u1ea3n l\u00fd phi\u00ean l\u00e0m vi\u1ec7c (session) hay token store</li> <li>Kh\u00f4ng c\u00f3 b\u1ea3ng l\u01b0u session ho\u1eb7c login state</li> </ul> </li> <li> <p>\u2716\ufe0f Event log chi ti\u1ebft</p> <ul> <li>Gateway kh\u00f4ng l\u01b0u l\u1ea1i chi ti\u1ebft log request/response v\u00e0o DB</li> <li>Vi\u1ec7c audit log v\u00e0 ph\u00e2n t\u00edch h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng \u0111\u01b0\u1ee3c chuy\u1ec3n giao cho <code>audit-logging-service</code></li> </ul> </li> <li> <p>\u2716\ufe0f Logic ph\u00e2n quy\u1ec1n t\u00f9y ng\u1eef c\u1ea3nh nghi\u1ec7p v\u1ee5</p> <ul> <li>Gateway ch\u1ec9 enforce permission + <code>x-condition</code> \u0111\u00e3 \u0111\u1ecbnh ngh\u0129a trong <code>route_config</code></li> <li>C\u00e1c \u0111i\u1ec1u ki\u1ec7n nghi\u1ec7p v\u1ee5 n\u00e2ng cao (v\u00ed d\u1ee5: \u201cch\u1ec9 admin c\u1ee7a t\u1ed5 ch\u1ee9c X m\u1edbi \u0111\u01b0\u1ee3c duy\u1ec7t b\u00e1o c\u00e1o Y\u201d) s\u1ebd do backend x\u1eed l\u00fd</li> </ul> </li> </ul> <p>\u2705 \u0110i\u1ec1u n\u00e0y \u0111\u1ea3m b\u1ea3o Gateway gi\u1eef \u0111\u01b0\u1ee3c t\u00ednh ch\u1ea5t stateless v\u00e0 hi\u1ec7u n\u0103ng cao, kh\u00f4ng b\u1ecb l\u1ec7 thu\u1ed9c v\u00e0o state nghi\u1ec7p v\u1ee5 ho\u1eb7c b\u1ecb ph\u00ecnh to kh\u00f4ng ki\u1ec3m so\u00e1t.</p>"},{"location":"services/api-gateway/data-model/#4-muc-tieu-cua-tai-lieu-mo-hinh-du-lieu","title":"4. M\u1ee5c ti\u00eau c\u1ee7a T\u00e0i li\u1ec7u M\u00f4 h\u00ecnh D\u1eef li\u1ec7u","text":"<p>T\u00e0i li\u1ec7u n\u00e0y \u0111\u01b0\u1ee3c bi\u00ean so\u1ea1n nh\u1eb1m m\u00f4 t\u1ea3 \u0111\u1ea7y \u0111\u1ee7, ch\u00ednh x\u00e1c v\u00e0 d\u1ec5 hi\u1ec3u c\u00e1c c\u1ea5u tr\u00fac d\u1eef li\u1ec7u \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng b\u1edfi API Gateway \u2014 bao g\u1ed3m c\u1ea3 ph\u1ea7n \u0111\u01b0\u1ee3c l\u01b0u trong Redis (cache ng\u1eafn h\u1ea1n) v\u00e0 PostgreSQL (l\u01b0u tr\u1eef d\u00e0i h\u1ea1n, ph\u1ee5c v\u1ee5 idempotency).</p>"},{"location":"services/api-gateway/data-model/#muc-ich-chinh","title":"\ud83c\udfaf M\u1ee5c \u0111\u00edch ch\u00ednh","text":"<ul> <li>Chu\u1ea9n ho\u00e1 ki\u1ebfn th\u1ee9c k\u1ef9 thu\u1eadt cho to\u00e0n b\u1ed9 \u0111\u1ed9i ng\u0169 (backend, SRE, QA) v\u1ec1 c\u00e1ch Gateway s\u1eed d\u1ee5ng v\u00e0 t\u1ed5 ch\u1ee9c d\u1eef li\u1ec7u.</li> <li>\u0110\u1ecbnh ngh\u0129a r\u00f5 c\u1ea5u tr\u00fac c\u00e1c Redis key v\u00e0 TTL t\u01b0\u01a1ng \u1ee9ng \u0111\u1ec3 ph\u1ee5c v\u1ee5 tuning hi\u1ec7u n\u0103ng, observability, v\u00e0 scaling.</li> <li>\u0110\u1ea3m b\u1ea3o \u0111\u1ed3ng b\u1ed9 v\u1edbi thi\u1ebft k\u1ebf h\u1ec7 th\u1ed1ng (<code>design.md</code>, <code>interface-contract.md</code>, <code>openapi.yaml</code>) v\u00e0 c\u00e1c quy\u1ebft \u0111\u1ecbnh ki\u1ebfn tr\u00fac (<code>ADR-007</code>, <code>ADR-011</code>, <code>ADR-023</code>).</li> <li>L\u00e0m t\u00e0i li\u1ec7u tham kh\u1ea3o ch\u00ednh th\u1ee9c cho vi\u1ec7c x\u00e2y d\u1ef1ng c\u00e1c script monitor, alerting, flush CLI, c\u0169ng nh\u01b0 h\u01b0\u1edbng d\u1eabn SRE khi troubleshooting.</li> </ul>"},{"location":"services/api-gateway/data-model/#muc-tieu-phu-tro","title":"\ud83d\udcda M\u1ee5c ti\u00eau ph\u1ee5 tr\u1ee3","text":"<ul> <li>L\u00e0 n\u1ec1n t\u1ea3ng \u0111\u1ec3:</li> <li>Vi\u1ebft c\u00e1c test ki\u1ec3m tra consistency c\u1ee7a Redis cache</li> <li>X\u00e2y d\u1ef1ng dashboard Prometheus v\u1ec1 cache hit/miss theo lo\u1ea1i key</li> <li>Thi\u1ebft k\u1ebf h\u1ec7 th\u1ed1ng autoscaling d\u1ef1a tr\u00ean s\u1ed1 l\u01b0\u1ee3ng key active</li> </ul> <p>\ud83d\udccc \u0110\u00e2y kh\u00f4ng ph\u1ea3i l\u00e0 t\u00e0i li\u1ec7u thi\u1ebft k\u1ebf schema DB truy\u1ec1n th\u1ed1ng, m\u00e0 l\u00e0 \"S\u01a1 \u0111\u1ed3 b\u1ed9 nh\u1edb ph\u00e2n t\u00e1n\" c\u1ee7a m\u1ed9t service tuy\u1ebfn \u0111\u1ea7u \u2014 n\u01a1i m\u00e0 cache ch\u00ednh l\u00e0 trung t\u00e2m x\u1eed l\u00fd t\u1ed1c \u0111\u1ed9 cao.</p>"},{"location":"services/api-gateway/data-model/#5-erd-entity-relationship-diagram","title":"5. ERD (Entity Relationship Diagram)","text":"<p><pre><code>erDiagram\n    ROUTE_CONFIG {\n        string id PK\n        string method\n        string path\n        string backend_service\n        string required_permission\n        int timeout_ms\n        int retry_count\n    }\n\n    PROCESSED_EVENTS {\n        UUID event_id PK\n        TEXT consumer_group_name\n        TIMESTAMPTZ processed_at\n    }\n</code></pre> \ud83d\udcce Ghi ch\u00fa</p> <ul> <li> <p><code>ROUTE_CONFIG</code> m\u00f4 ph\u1ecfng m\u1ed9t b\u1ea3ng c\u1ea5u h\u00ecnh \u0111\u1ecbnh tuy\u1ebfn n\u1ed9i b\u1ed9.   Tr\u00ean th\u1ef1c t\u1ebf, c\u1ea5u h\u00ecnh route \u0111\u01b0\u1ee3c load t\u1eeb file JSON (<code>route_config.json</code>) ho\u1eb7c external source (GCS, Firestore\u2026), sau \u0111\u00f3 \u0111\u01b0\u1ee3c Gateway parse, cache v\u00e0o Redis (key <code>routes:{path}:{method}</code>) v\u00e0 s\u1eed d\u1ee5ng t\u1ea1i runtime.</p> </li> <li> <p><code>PROCESSED_EVENTS</code> l\u00e0 b\u1ea3ng v\u1eadt l\u00fd trong PostgreSQL.   D\u00f9ng \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o idempotency khi x\u1eed l\u00fd c\u00e1c s\u1ef1 ki\u1ec7n t\u1eeb Pub/Sub, \u0111\u1eb7c bi\u1ec7t v\u1edbi c\u00e1c action b\u1ea5t \u0111\u1ed3ng b\u1ed9 (async). Vi\u1ec7c l\u01b0u l\u1ea1i <code>event_id</code> theo t\u1eebng <code>consumer_group</code> gi\u00fap tr\u00e1nh x\u1eed l\u00fd tr\u00f9ng khi retry.</p> </li> <li> <p>Gateway kh\u00f4ng c\u00f3 b\u1ea3ng d\u1eef li\u1ec7u nghi\u1ec7p v\u1ee5, c\u0169ng kh\u00f4ng ch\u1ee9a foreign key ho\u1eb7c relationship ph\u1ee9c t\u1ea1p \u2014 m\u1ee5c ti\u00eau l\u00e0 truy c\u1eadp nhanh, \u0111\u1ecbnh tuy\u1ebfn \u0111\u00fang, kh\u00f4ng state d\u00e0i h\u1ea1n.</p> </li> </ul>"},{"location":"services/api-gateway/data-model/#6-chi-tiet-bang","title":"6. Chi ti\u1ebft B\u1ea3ng","text":"<p>Ph\u1ea7n n\u00e0y m\u00f4 t\u1ea3 chi ti\u1ebft c\u1ea5u tr\u00fac v\u00e0 m\u1ee5c \u0111\u00edch c\u1ee7a hai b\u1ea3ng d\u1eef li\u1ec7u ch\u00ednh m\u00e0 API Gateway s\u1eed d\u1ee5ng trong PostgreSQL: <code>route_config</code> v\u00e0 <code>processed_events</code>.</p>"},{"location":"services/api-gateway/data-model/#61-bang-route_config","title":"6.1. \ud83d\udccc B\u1ea3ng: <code>route_config</code>","text":""},{"location":"services/api-gateway/data-model/#muc-ich","title":"\ud83d\udccf M\u1ee5c \u0111\u00edch","text":"<p>L\u01b0u tr\u1eef c\u1ea5u h\u00ecnh \u0111\u1ecbnh tuy\u1ebfn \u0111\u01b0\u1ee3c Gateway t\u1ea3i v\u1ec1 t\u1eeb external config (JSON, GCS, Firestore\u2026). Ph\u1ee5c v\u1ee5 cho <code>Routing Engine</code>, <code>RBAC Policy</code>, <code>Timeout Handler</code>, v\u00e0 <code>Retry Logic</code>.</p>"},{"location":"services/api-gateway/data-model/#inh-nghia-bang","title":"\ud83e\uddfe \u0110\u1ecbnh ngh\u0129a b\u1ea3ng","text":"<pre><code>CREATE TABLE route_config (\n    id TEXT PRIMARY KEY,\n    method TEXT NOT NULL,\n    path TEXT NOT NULL,\n    backend_service TEXT NOT NULL,\n    required_permission TEXT,\n    timeout_ms INTEGER DEFAULT 3000,\n    retry_count INTEGER DEFAULT 2,\n    created_at TIMESTAMPTZ DEFAULT now() NOT NULL,\n    updated_at TIMESTAMPTZ DEFAULT now() NOT NULL\n);\n\nCREATE INDEX idx_route_path_method ON route_config(path, method);\n</code></pre>"},{"location":"services/api-gateway/data-model/#giai-thich-cot","title":"\ud83e\uddf0 Gi\u1ea3i th\u00edch c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u DL R\u00e0ng bu\u1ed9c M\u00f4 t\u1ea3 <code>id</code> TEXT PK M\u00e3 \u0111\u1ecbnh danh duy nh\u1ea5t cho route (c\u00f3 th\u1ec3 d\u00f9ng hash path+method) <code>method</code> TEXT NOT NULL HTTP method \u00e1p d\u1ee5ng: GET, POST, PUT... <code>path</code> TEXT NOT NULL Pattern URL, v\u00ed d\u1ee5: <code>/users/**</code> ho\u1eb7c <code>/auth/login</code> <code>backend_service</code> TEXT NOT NULL T\u00ean \u0111\u1ecbnh danh backend service (theo \u0111\u1ecbnh danh n\u1ed9i b\u1ed9) <code>required_permission</code> TEXT optional M\u00e3 permission y\u00eau c\u1ea7u (\u00e1p d\u1ee5ng RBAC) <code>timeout_ms</code> INTEGER DEFAULT Timeout (milliseconds) khi proxy \u0111\u1ebfn backend <code>retry_count</code> INTEGER DEFAULT S\u1ed1 l\u1ea7n retry n\u1ebfu backend kh\u00f4ng ph\u1ea3n h\u1ed3i <code>created_at</code> TIMESTAMPTZ DEFAULT NOW() Timestamp t\u1ea1o b\u1ea3n ghi <code>updated_at</code> TIMESTAMPTZ DEFAULT NOW() Timestamp c\u1eadp nh\u1eadt cu\u1ed1i c\u00f9ng"},{"location":"services/api-gateway/data-model/#62-bang-processed_events","title":"6.2. \ud83d\udd04 B\u1ea3ng: <code>processed_events</code>","text":""},{"location":"services/api-gateway/data-model/#muc-ich_1","title":"\ud83d\udccf M\u1ee5c \u0111\u00edch","text":"<p>Ghi nh\u1eadn c\u00e1c s\u1ef1 ki\u1ec7n Pub/Sub \u0111\u00e3 \u0111\u01b0\u1ee3c x\u1eed l\u00fd \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o idempotency \u2013 tr\u00e1nh x\u1eed l\u00fd l\u1eb7p trong tr\u01b0\u1eddng h\u1ee3p message b\u1ecb g\u1eedi l\u1ea1i (retry).</p>"},{"location":"services/api-gateway/data-model/#inh-nghia-bang_1","title":"\ud83e\uddfe \u0110\u1ecbnh ngh\u0129a b\u1ea3ng","text":"<pre><code>CREATE TABLE processed_events (\n    event_id UUID PRIMARY KEY,\n    consumer_group_name TEXT NOT NULL,\n    processed_at TIMESTAMPTZ DEFAULT now() NOT NULL\n);\n</code></pre>"},{"location":"services/api-gateway/data-model/#chinh-sach-ttl-don-dep","title":"\ud83e\uddf9 Ch\u00ednh s\u00e1ch TTL &amp; D\u1ecdn d\u1eb9p","text":"<ul> <li>D\u1eef li\u1ec7u trong b\u1ea3ng <code>processed_events</code> \u0111\u01b0\u1ee3c l\u01b0u t\u1ed1i \u0111a 30 ng\u00e0y.</li> <li>Batch job (cron, Airflow, pg_cron...) s\u1ebd x\u00f3a c\u00e1c b\u1ea3n ghi qu\u00e1 h\u1ea1n \u0111\u1ec3 gi\u1eef b\u1ea3ng nh\u1eb9, truy v\u1ea5n nhanh.</li> </ul>"},{"location":"services/api-gateway/data-model/#giai-thich-cot_1","title":"\ud83e\uddf0 Gi\u1ea3i th\u00edch c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u DL R\u00e0ng bu\u1ed9c M\u00f4 t\u1ea3 <code>event_id</code> UUID PK M\u00e3 duy nh\u1ea5t c\u1ee7a s\u1ef1 ki\u1ec7n t\u1eeb Pub/Sub ho\u1eb7c queue <code>consumer_group_name</code> TEXT NOT NULL T\u00ean \u0111\u1ecbnh danh consumer (theo tenant ho\u1eb7c ch\u1ee9c n\u0103ng) <code>processed_at</code> TIMESTAMPTZ DEFAULT NOW() Th\u1eddi \u0111i\u1ec3m Gateway \u0111\u00e1nh d\u1ea5u s\u1ef1 ki\u1ec7n \u0111\u00e3 x\u1eed l\u00fd <p>\u2705 C\u1ea3 hai b\u1ea3ng \u0111\u1ec1u \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf \u0111\u1ec3 ph\u1ee5c v\u1ee5 m\u1ee5c ti\u00eau t\u1ed1c \u0111\u1ed9, \u0111\u01a1n gi\u1ea3n h\u00f3a ki\u1ec3m so\u00e1t v\u00e0 h\u1ed7 tr\u1ee3 c\u00e1c batch job v\u1eadn h\u00e0nh (x\u00f3a TTL, reload config\u2026).</p>"},{"location":"services/api-gateway/data-model/#7-phu-luc","title":"7. Ph\u1ee5 l\u1ee5c","text":"<p>Ph\u1ea7n ph\u1ee5 l\u1ee5c n\u00e0y t\u1ed5ng h\u1ee3p l\u1ea1i to\u00e0n b\u1ed9 chi\u1ebfn l\u01b0\u1ee3c cache, TTL, v\u00e0 li\u00ean k\u1ebft \u0111\u1ebfn c\u00e1c t\u00e0i li\u1ec7u ki\u1ebfn tr\u00fac c\u00f3 li\u00ean quan, gi\u00fap \u0111\u1ed9i ng\u0169 ph\u00e1t tri\u1ec3n v\u00e0 v\u1eadn h\u00e0nh d\u1ec5 d\u00e0ng tra c\u1ee9u, \u0111\u1ed3ng b\u1ed9 v\u00e0 debug h\u1ec7 th\u1ed1ng Gateway.</p>"},{"location":"services/api-gateway/data-model/#71-chien-luoc-cache","title":"7.1. \ud83d\udd04 Chi\u1ebfn l\u01b0\u1ee3c Cache","text":"<p>API Gateway ho\u1ea1t \u0111\u1ed9ng theo nguy\u00ean t\u1eafc cache \u01b0u ti\u00ean \u2013 fallback khi c\u1ea7n thi\u1ebft \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o hi\u1ec7u n\u0103ng tuy\u1ebfn \u0111\u1ea7u. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 chi\u1ebfn l\u01b0\u1ee3c c\u1ee5 th\u1ec3 cho t\u1eebng lo\u1ea1i d\u1eef li\u1ec7u:</p> Cache Key Pattern TTL Ngu\u1ed3n fallback C\u01a1 ch\u1ebf invalidate <code>routes:{path}:{method}</code> 300s File <code>route_config.json</code> / GCS Reload \u0111\u1ecbnh k\u1ef3 / PubSub <code>route.updated</code> <code>rbac:{uid}:{tid}</code> 300s <code>user-sub</code> service PubSub <code>rbac.updated</code> <code>revoked:{jti}</code> 180s <code>token-service/introspect</code> Khi logout ho\u1eb7c introspect fail <code>jwks:public_key</code> 600s JWKS endpoint t\u1eeb <code>token-service</code> PubSub <code>jwt.jwks.rotated</code>"},{"location":"services/api-gateway/data-model/#72-cau-hinh-redis-e-xuat","title":"7.2. \ud83e\udde9 C\u1ea5u h\u00ecnh Redis \u0111\u1ec1 xu\u1ea5t","text":"<ul> <li>Mode: Redis cluster ho\u1eb7c Sentinel</li> <li>Eviction Policy: <code>volatile-lru</code> (\u01b0u ti\u00ean x\u00f3a key g\u1ea7n h\u1ebft TTL)</li> <li>Monitoring: Prometheus Redis Exporter: <code>cache_hit_rate</code>, <code>key_expired_total</code>, <code>memory_usage</code></li> <li>Alert: TTL xu\u1ed1ng th\u1ea5p b\u1ea5t th\u01b0\u1eddng ho\u1eb7c miss rate &gt; 5%</li> </ul>"},{"location":"services/api-gateway/data-model/#73-tai-lieu-lien-ket","title":"7.3. \ud83d\udd17 T\u00e0i li\u1ec7u li\u00ean k\u1ebft","text":"Ch\u1ee7 \u0111\u1ec1 File Thi\u1ebft k\u1ebf t\u1ed5ng th\u1ec3 h\u1ec7 th\u1ed1ng <code>docs/README.md</code> Thi\u1ebft k\u1ebf chi ti\u1ebft Gateway <code>docs/services/api-gateway/design.md</code> Giao di\u1ec7n h\u1ee3p \u0111\u1ed3ng Gateway <code>docs/services/api-gateway/interface-contract.md</code> Chu\u1ea9n h\u00f3a l\u1ed7i &amp; ph\u1ea3n h\u1ed3i <code>docs/ADR/adr-011-api-error-format.md</code>, <code>adr-012-response-structure.md</code> Ph\u00e2n quy\u1ec1n \u0111\u1ed9ng RBAC <code>docs/architecture/rbac-deep-dive.md</code> Chi\u1ebfn l\u01b0\u1ee3c JWT &amp; revoked tokens <code>docs/services/token-service/design.md</code> Qu\u1ea3n l\u00fd TTL &amp; event cache <code>docs/ADR/adr-023-schema-migration-strategy.md</code>"},{"location":"services/api-gateway/data-model/#74-ghi-chu-mo-rong","title":"7.4. \ud83d\udcdd Ghi ch\u00fa m\u1edf r\u1ed9ng","text":"<ul> <li>Redis cache KH\u00d4NG \u0111\u01b0\u1ee3c xem l\u00e0 ngu\u1ed3n d\u1eef li\u1ec7u ch\u00ednh. M\u1ecdi d\u1eef li\u1ec7u c\u00f3 th\u1ec3 b\u1ecb m\u1ea5t cache v\u00e0 s\u1ebd \u0111\u01b0\u1ee3c t\u1ef1 \u0111\u1ed9ng t\u00e1i t\u1ea1o t\u1eeb h\u1ec7 th\u1ed1ng g\u1ed1c.</li> <li>TTL ng\u1eafn + ki\u1ec3m so\u00e1t th\u00f4ng minh gi\u00fap Gateway c\u00e2n b\u1eb1ng gi\u1eefa hi\u1ec7u n\u0103ng v\u00e0 t\u00ednh \u0111\u00fang \u0111\u1eafn.</li> <li>M\u1ecdi access t\u1edbi Redis n\u00ean \u0111\u01b0\u1ee3c wrap qua RedisClient c\u00f3 trace + metric Prometheus.</li> </ul> <p>\ud83d\udccc T\u00e0i li\u1ec7u n\u00e0y s\u1ebd \u0111\u01b0\u1ee3c c\u1eadp nh\u1eadt t\u1ef1 \u0111\u1ed9ng khi c\u00f3 thay \u0111\u1ed5i t\u1eeb c\u00e1c ADR ho\u1eb7c service ph\u1ee5 thu\u1ed9c.</p>"},{"location":"services/api-gateway/design/","title":"\ud83d\udcd8 Thi\u1ebft k\u1ebf chi ti\u1ebft API Gateway","text":""},{"location":"services/api-gateway/design/#1-pham-vi-va-trach-nhiem-scope-responsibilities","title":"1. \ud83e\udded Ph\u1ea1m vi v\u00e0 Tr\u00e1ch nhi\u1ec7m (Scope &amp; Responsibilities)","text":""},{"location":"services/api-gateway/design/#muc-tieu","title":"\ud83c\udf1f M\u1ee5c ti\u00eau","text":"<p>API Gateway l\u00e0 \u0111i\u1ec3m truy c\u1eadp duy nh\u1ea5t cho t\u1ea5t c\u1ea3 frontend apps trong h\u1ec7 th\u1ed1ng DX-VAS. N\u00f3 \u0111\u00f3ng vai tr\u00f2 trung gian gi\u1eefa client v\u00e0 backend services v\u1edbi c\u00e1c tr\u00e1ch nhi\u1ec7m ch\u00ednh:</p> <ul> <li>X\u00e1c th\u1ef1c token (JWT) v\u00e0 ki\u1ec3m tra quy\u1ec1n truy c\u1eadp (RBAC) tr\u00ean t\u1eebng route.</li> <li>\u0110\u1ecbnh tuy\u1ebfn y\u00eau c\u1ea7u \u0111\u1ebfn c\u00e1c backend t\u01b0\u01a1ng \u1ee9ng d\u1ef1a tr\u00ean file c\u1ea5u h\u00ecnh.</li> <li>Chu\u1ea9n h\u00f3a ph\u1ea3n h\u1ed3i l\u1ed7i t\u1eeb backend theo chu\u1ea9n h\u1ec7 th\u1ed1ng (ADR-011).</li> <li>Ghi log, xu\u1ea5t metrics v\u00e0 trace ph\u1ee5c v\u1ee5 m\u1ee5c \u0111\u00edch observability.</li> </ul>"},{"location":"services/api-gateway/design/#cac-thuc-the-du-lieu-quan-ly","title":"\ud83d\udce6 C\u00e1c th\u1ef1c th\u1ec3 d\u1eef li\u1ec7u qu\u1ea3n l\u00fd","text":"Th\u1ef1c th\u1ec3 M\u00f4 t\u1ea3 Route Config \u0110\u1ecbnh tuy\u1ebfn endpoint \u2192 backend service, ph\u01b0\u01a1ng th\u1ee9c, quy\u1ec1n y\u00eau c\u1ea7u RBAC Rule Cache Permission c\u1ee7a user/tenant, l\u01b0u t\u1ea1m trong Redis \u0111\u1ec3 x\u1eed l\u00fd nhanh Revoked Token Cache Danh s\u00e1ch <code>jti</code> \u0111\u00e3 b\u1ecb thu h\u1ed3i, \u0111\u1ec3 x\u00e1c \u0111\u1ecbnh token kh\u00f4ng c\u00f2n h\u1ee3p l\u1ec7 JWT JWKS Cache Public key JWKS l\u1ea5y t\u1eeb Auth Service \u0111\u1ec3 x\u00e1c th\u1ef1c ch\u1eef k\u00fd JWT <p>\ud83d\udd27 File c\u1ea5u h\u00ecnh route (<code>ROUTE_CONFIG_PATH</code>) c\u00f3 \u0111\u1ecbnh d\u1ea1ng JSON, v\u00ed d\u1ee5: <pre><code>{\n  \"/users/**\": {\n    \"method\": [\"GET\", \"POST\"],\n    \"backend\": \"user-service.master\",\n    \"x-required-permission\": \"user.view\",\n    \"x-condition\": {\n      \"user_id\": \"{{X-User-ID}}\"\n    },\n    \"timeout\": 3000,\n    \"retry\": 2\n  }\n}\n</code></pre></p>"},{"location":"services/api-gateway/design/#ngoai-pham-vi-out-of-scope","title":"\ud83d\udd12 Ngo\u00e0i Ph\u1ea1m Vi (Out of Scope)","text":"<p>API Gateway kh\u00f4ng th\u1ef1c hi\u1ec7n c\u00e1c ch\u1ee9c n\u0103ng sau:</p> <ul> <li>\u274c Logic nghi\u1ec7p v\u1ee5 c\u1ee7a backend (v\u00ed d\u1ee5: x\u1eed l\u00fd d\u1eef li\u1ec7u ng\u01b0\u1eddi d\u00f9ng, b\u00e1o c\u00e1o, v.v.)</li> <li>\u274c L\u01b0u tr\u1eef d\u1eef li\u1ec7u domain (user, b\u00e0i h\u1ecdc, \u0111i\u1ec3m danh...)</li> <li>\u274c C\u1ea5p ph\u00e1t ho\u1eb7c refresh token (\u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n b\u1edfi <code>token-service</code>)</li> <li>\u274c Thay th\u1ebf h\u1ec7 th\u1ed1ng ph\u00e2n quy\u1ec1n (RBAC logic \u0111\u01b0\u1ee3c enforce d\u1ef1a tr\u00ean Redis/cache)</li> <li>\u274c Giao ti\u1ebfp tr\u1ef1c ti\u1ebfp gi\u1eefa frontend v\u00e0 backend (t\u1ea5t c\u1ea3 \u0111\u1ec1u \u0111i qua Gateway)</li> </ul>"},{"location":"services/api-gateway/design/#2-thiet-ke-api-chi-tiet-interface-contract","title":"2. \ud83c\udf10 Thi\u1ebft k\u1ebf API chi ti\u1ebft (Interface Contract)","text":"<p>API Gateway kh\u00f4ng \u0111\u1ecbnh ngh\u0129a OpenAPI ri\u00eang cho t\u1eebng route, nh\u01b0ng ph\u1ea3i th\u1ef1c hi\u1ec7n mapping v\u00e0 ki\u1ec3m so\u00e1t truy c\u1eadp theo c\u1ea5u h\u00ecnh \u0111\u1ed9ng (Route Config). C\u00e1c route n\u00e0y c\u00f3 th\u1ec3 thay \u0111\u1ed5i theo c\u1ea5u h\u00ecnh JSON b\u00ean ngo\u00e0i (\u0111\u1ed3ng b\u1ed9 t\u1eeb GCS, Firestore, ho\u1eb7c service discovery).</p>"},{"location":"services/api-gateway/design/#cac-loai-api-proxy-pho-bien","title":"\ud83d\udccc C\u00e1c lo\u1ea1i API proxy ph\u1ed5 bi\u1ebfn","text":"Method Path Pattern M\u00f4 t\u1ea3 ch\u1ee9c n\u0103ng Quy\u1ec1n y\u00eau c\u1ea7u ALL <code>/users/**</code> Proxy t\u1edbi User Service (Master/Sub) Theo <code>x-required-permission</code> trong route config ALL <code>/auth/**</code> Proxy t\u1edbi Auth Service (Master/Sub) Theo route config ALL <code>/report/**</code> Proxy t\u1edbi Reporting Service Theo y\u00eau c\u1ea7u template ALL <code>/&lt;domain&gt;/**</code> Proxy t\u1edbi service t\u01b0\u01a1ng \u1ee9ng theo config Ki\u1ec3m tra permission \u0111\u1ed9ng"},{"location":"services/api-gateway/design/#chuan-hoa-loi-tra-ve-theo-adr-011","title":"\ud83d\udd01 Chu\u1ea9n h\u00f3a l\u1ed7i tr\u1ea3 v\u1ec1 (theo ADR-011)","text":"<p>Khi backend tr\u1ea3 l\u1ed7i kh\u00f4ng \u0111\u00fang chu\u1ea9n, Gateway s\u1ebd b\u1eaft v\u00e0 bi\u1ebfn \u0111\u1ed5i th\u00e0nh c\u1ea5u tr\u00fac l\u1ed7i chu\u1ea9n c\u1ee7a to\u00e0n h\u1ec7 th\u1ed1ng:</p>"},{"location":"services/api-gateway/design/#vi-du","title":"V\u00ed d\u1ee5:","text":"<pre><code>// L\u1ed7i g\u1ed1c t\u1eeb backend\n{\n  \"message\": \"Database down\",\n  \"code\": 5021\n}\n\n// Gateway bi\u1ebfn \u0111\u1ed5i:\n{\n  \"meta\": {\n    \"code\": 502,\n    \"message\": \"BAD_GATEWAY\",\n    \"error_type\": \"upstream.backend_error\",\n    \"trace_id\": \"abc-123\",\n    \"service\": \"api-gateway\",\n    \"timestamp\": \"2025-06-10T12:34:56Z\"\n  },\n  \"error\": {\n    \"reason\": \"Database down\",\n    \"details\": null\n  }\n}\n</code></pre>"},{"location":"services/api-gateway/design/#headers-uoc-yeu-cau-forward","title":"\ud83e\udde9 Headers \u0111\u01b0\u1ee3c y\u00eau c\u1ea7u / Forward","text":"Header M\u1ee5c \u0111\u00edch <code>Authorization</code> Ch\u1ee9a JWT token ng\u01b0\u1eddi d\u00f9ng g\u1eedi l\u00ean <code>X-User-ID</code> ID ng\u01b0\u1eddi d\u00f9ng, l\u1ea5y t\u1eeb payload JWT <code>X-Tenant-ID</code> ID tenant, d\u00f9ng \u0111\u1ec3 enforce ph\u00e2n quy\u1ec1n \u0111a tenant <code>X-Trace-ID</code> D\u00f9ng \u0111\u1ec3 trace to\u00e0n h\u1ec7 th\u1ed1ng <code>X-Service</code> Backend \u0111\u01b0\u1ee3c g\u1ecdi (th\u00eam v\u00e0o log ho\u1eb7c response l\u1ed7i) <code>X-Permissions</code> (Tu\u1ef3 ch\u1ecdn) danh s\u00e1ch quy\u1ec1n \u0111\u00e3 resolved t\u1eeb cache <code>X-Login-Method</code> Ph\u01b0\u01a1ng th\u1ee9c ng\u01b0\u1eddi d\u00f9ng \u0111\u00e3 x\u00e1c th\u1ef1c: <code>oauth2</code>, <code>otp</code>, <code>password</code> <p>\u26a0\ufe0f L\u1ed7i 403 do sai permission ho\u1eb7c kh\u00f4ng tho\u1ea3 \u0111i\u1ec1u ki\u1ec7n <code>x-condition</code> c\u1ea7n ghi r\u00f5 trong <code>meta.error_type = \"rbac.permission_denied\"</code> ho\u1eb7c <code>\"rbac.condition_failed\"</code>.</p> <p>Chi ti\u1ebft: Interface Contract &amp; OpenAPI</p>"},{"location":"services/api-gateway/design/#3-mo-hinh-du-lieu-chi-tiet-data-model","title":"3. \ud83d\udcc3 M\u00f4 h\u00ecnh d\u1eef li\u1ec7u chi ti\u1ebft (Data Model)","text":"<p>API Gateway l\u00e0 m\u1ed9t service stateless, kh\u00f4ng s\u1eed d\u1ee5ng c\u01a1 s\u1edf d\u1eef li\u1ec7u quan h\u1ec7. Tuy nhi\u00ean, n\u00f3 ph\u1ee5 thu\u1ed9c v\u00e0o c\u00e1c l\u1edbp cache \u0111\u1ec3 x\u1eed l\u00fd hi\u1ec7u qu\u1ea3 v\u00e0 \u0111\u1ea3m b\u1ea3o hi\u1ec7u n\u0103ng. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 m\u00f4 h\u00ecnh d\u1eef li\u1ec7u c\u1ea5p cache v\u00e0 c\u1ea5u h\u00ecnh:</p>"},{"location":"services/api-gateway/design/#redis-cache","title":"\ud83d\udce6 Redis Cache","text":"Key Pattern M\u00f4 t\u1ea3 <code>routes:{path}:{method}</code> C\u1ea5u h\u00ecnh \u0111\u1ecbnh tuy\u1ebfn t\u01b0\u01a1ng \u1ee9ng v\u1edbi m\u1ed9t endpoint c\u1ee5 th\u1ec3 (timeout, retry, backend, permission) <code>rbac:{user_id}:{tenant_id}</code> Danh s\u00e1ch permission \u0111\u00e3 resolved cho ng\u01b0\u1eddi d\u00f9ng theo tenant <code>revoked:{jti}</code> Token \u0111\u00e3 b\u1ecb thu h\u1ed3i, d\u00f9ng \u0111\u1ec3 ki\u1ec3m tra nhanh access token <code>jwks:public_key</code> JWKS caching t\u1eeb Auth Service \u0111\u1ec3 verify token <ul> <li>TTL m\u1eb7c \u0111\u1ecbnh cho m\u1ed7i key: 300 gi\u00e2y (5 ph\u00fat) </li> <li>C\u00f3 th\u1ec3 config ri\u00eang TTL cho revoked token v\u00e0 permission \u0111\u1ec3 t\u1ed1i \u01b0u trade-off gi\u1eefa hi\u1ec7u n\u0103ng v\u00e0 \u0111\u1ed9 c\u1eadp nh\u1eadt.</li> </ul>"},{"location":"services/api-gateway/design/#cau-hinh-route-ong-route-config","title":"\ud83d\udd27 C\u1ea5u h\u00ecnh Route \u0111\u1ed9ng (Route Config)","text":"<p>\u0110\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 t\u1eeb file ngo\u00e0i (Firestore, GCS bucket\u2026) v\u1ec1 Gateway. File \u0111\u1ecbnh d\u1ea1ng JSON ch\u1ee9a to\u00e0n b\u1ed9 c\u00e1c \u0111\u1ecbnh tuy\u1ebfn v\u00e0 quy t\u1eafc permission:</p>"},{"location":"services/api-gateway/design/#vi-du_1","title":"V\u00ed d\u1ee5:","text":"<pre><code>{\n  \"/users/{id}\": {\n    \"method\": [\"PATCH\"],\n    \"backend\": \"user-service.master\",\n    \"x-required-permission\": \"user.update\",\n    \"x-condition\": {\n      \"user_id\": \"{{X-User-ID}}\"\n    }\n  }\n}\n</code></pre> <ul> <li>C\u00e1c bi\u1ebfn <code>{{...}}</code> \u0111\u01b0\u1ee3c binding runtime t\u1eeb header ho\u1eb7c payload \u0111\u1ec3 so s\u00e1nh v\u1edbi <code>x-condition</code>.</li> <li>Vi\u1ec7c binding v\u00e0 ki\u1ec3m tra logic \u0111i\u1ec1u ki\u1ec7n ph\u1ea3i th\u1ef1c hi\u1ec7n t\u1ea1i Gateway (theo chu\u1ea9n RBAC condition c\u1ee7a <code>rbac-deep-dive.md</code>).</li> </ul>"},{"location":"services/api-gateway/design/#chien-luoc-invalidation-cache","title":"\ud83d\udd04 Chi\u1ebfn l\u01b0\u1ee3c Invalidation Cache","text":"<p>\u0110\u1ec3 \u0111\u1ea3m b\u1ea3o h\u1ec7 th\u1ed1ng lu\u00f4n d\u00f9ng permission v\u00e0 route config c\u1eadp nh\u1eadt m\u1edbi nh\u1ea5t:</p> <ul> <li>Redis cache c\u00f3 TTL t\u1ef1 \u0111\u1ed9ng h\u1ebft h\u1ea1n sau 5 ph\u00fat</li> <li>Admin c\u00f3 th\u1ec3 x\u00f3a th\u1ee7 c\u00f4ng b\u1eb1ng CLI/API n\u1ed9i b\u1ed9</li> <li> <p>H\u1ed7 tr\u1ee3 Pub/Sub (khuy\u1ebfn ngh\u1ecb):</p> </li> <li> <p>Khi service <code>user-sub</code> ph\u00e1t event <code>rbac.updated</code>, Gateway l\u1eafng nghe v\u00e0 x\u00f3a <code>rbac:{user_id}:{tenant_id}</code></p> </li> <li>Event n\u00e0y \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a r\u00f5 trong ADR-030</li> </ul>"},{"location":"services/api-gateway/design/#vi-du-payload-event","title":"V\u00ed d\u1ee5 payload event:","text":"<pre><code>{\n  \"event\": \"rbac.updated\",\n  \"user_id\": \"u-123\",\n  \"tenant_id\": \"t-456\",\n  \"trace_id\": \"abc-xyz\"\n}\n</code></pre> <p>Chi ti\u1ebft s\u01a1 \u0111\u1ed3 ERD, \u0111\u1ecbnh ngh\u0129a b\u1ea3ng v\u00e0 chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed d\u1eef li\u1ec7u \u0111\u01b0\u1ee3c tr\u00ecnh b\u00e0y t\u1ea1i: \ud83d\udcc2 Data Model</p>"},{"location":"services/api-gateway/design/#4-luong-xu-ly-nghiep-vu-chinh-business-logic-flows","title":"4. \ud83d\udd04 Lu\u1ed3ng x\u1eed l\u00fd nghi\u1ec7p v\u1ee5 ch\u00ednh (Business Logic Flows)","text":"<p>API Gateway th\u1ef1c hi\u1ec7n vai tr\u00f2 trung gian gi\u1eefa frontend apps v\u00e0 c\u00e1c backend service. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c lu\u1ed3ng x\u1eed l\u00fd ch\u00ednh c\u1ea7n m\u00f4 t\u1ea3 r\u00f5 \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o tri\u1ec3n khai th\u1ed1ng nh\u1ea5t.</p>"},{"location":"services/api-gateway/design/#luong-proxy-request-api","title":"\ud83d\udea6 Lu\u1ed3ng: <code>Proxy Request API</code>","text":"<pre><code>sequenceDiagram\n  participant FE as Frontend App\n  participant GW as API Gateway\n  participant BE as Backend Service\n\n  FE-&gt;&gt;GW: G\u1eedi request k\u00e8m JWT\n  GW-&gt;&gt;GW: Ki\u1ec3m tra token (JWKS verify, revoked:{jti})\n  alt Token b\u1ecb thu h\u1ed3i (cache hit)\n    GW--&gt;&gt;FE: 401 Unauthorized\n  else Token h\u1ee3p l\u1ec7\n    GW-&gt;&gt;GW: Ki\u1ec3m tra permission (Redis rbac:{uid}:{tid})\n    alt C\u00f3 x-condition\n      GW-&gt;&gt;GW: \u0110\u00e1nh gi\u00e1 \u0111i\u1ec1u ki\u1ec7n t\u1eeb payload vs context\n      alt Kh\u00f4ng \u0111\u1ea1t \u0111i\u1ec1u ki\u1ec7n\n        GW--&gt;&gt;FE: 403 Forbidden (rbac.condition_failed)\n      else \u0110\u1ea1t \u0111i\u1ec1u ki\u1ec7n\n        GW-&gt;&gt;BE: G\u1eedi request backend\n        BE--&gt;&gt;GW: Nh\u1eadn response\n        GW--&gt;&gt;FE: Tr\u1ea3 v\u1ec1 client\n      end\n    else Kh\u00f4ng c\u00f3 x-condition\n      GW-&gt;&gt;BE: G\u1eedi request backend\n      BE--&gt;&gt;GW: Nh\u1eadn response\n      GW--&gt;&gt;FE: Tr\u1ea3 v\u1ec1 client\n    end\n  end\n</code></pre>"},{"location":"services/api-gateway/design/#luong-rbac-voi-ieu-kien-ong","title":"\ud83e\udde0 Lu\u1ed3ng: <code>RBAC v\u1edbi \u0111i\u1ec1u ki\u1ec7n \u0111\u1ed9ng</code>","text":"<ul> <li>M\u1ed9t s\u1ed1 route y\u00eau c\u1ea7u ki\u1ec3m tra \u0111i\u1ec1u ki\u1ec7n v\u00ed d\u1ee5 <code>user_id == self</code>, <code>org_id in allowed_orgs</code>.</li> <li>C\u00e1c \u0111i\u1ec1u ki\u1ec7n n\u00e0y \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong <code>x-condition</code> v\u00e0 binding runtime t\u1eeb headers/path/body.</li> </ul> <p>V\u00ed d\u1ee5 c\u1ea5u h\u00ecnh:</p> <pre><code>\"x-condition\": {\n  \"user_id\": \"{{X-User-ID}}\"\n}\n</code></pre> <p>Quy tr\u00ecnh:</p> <ol> <li>Gateway parse <code>x-condition</code> t\u1eeb route config</li> <li>Extract gi\u00e1 tr\u1ecb t\u01b0\u01a1ng \u1ee9ng t\u1eeb header/path/body</li> <li>So s\u00e1nh: n\u1ebfu kh\u00f4ng kh\u1edbp \u2192 tr\u1ea3 l\u1ed7i 403 <code>rbac.condition_failed</code></li> </ol>"},{"location":"services/api-gateway/design/#luong-cache-miss-fallback","title":"\ud83d\udce5 Lu\u1ed3ng: <code>Cache Miss \u2192 Fallback</code>","text":"<ul> <li>N\u1ebfu Redis <code>rbac:{uid}:{tid}</code> kh\u00f4ng c\u00f3, Gateway c\u00f3 th\u1ec3 fallback g\u1ecdi t\u1edbi <code>user-sub</code> \u0111\u1ec3 l\u1ea5y permission realtime (tu\u1ef3 config).</li> <li>Sau \u0111\u00f3 cache l\u1ea1i v\u1edbi TTL m\u1eb7c \u0111\u1ecbnh.</li> </ul>"},{"location":"services/api-gateway/design/#luong-route-config-reload","title":"\ud83d\udd01 Lu\u1ed3ng: <code>Route Config Reload</code>","text":"<ul> <li>C\u1ea5u h\u00ecnh route \u0111\u01b0\u1ee3c t\u1ea3i \u0111\u1ecbnh k\u1ef3 t\u1eeb GCS/Firestore ho\u1eb7c c\u1eadp nh\u1eadt theo th\u1eddi gian th\u1ef1c qua subscription.</li> <li> <p>Khi c\u00f3 thay \u0111\u1ed5i, Gateway s\u1ebd:</p> </li> <li> <p>Ghi log <code>config_change_detected</code></p> </li> <li>L\u00e0m m\u1edbi cache <code>routes:{path}:{method}</code></li> <li>(Tu\u1ef3 ch\u1ecdn) ph\u00e1t log audit v\u1ec1 thay \u0111\u1ed5i c\u1ea5u h\u00ecnh.</li> </ul>"},{"location":"services/api-gateway/design/#5-pubsub-events","title":"5. \ud83d\udce3 Pub/Sub Events","text":"<p>API Gateway l\u00e0 m\u1ed9t th\u00e0nh ph\u1ea7n kh\u00f4ng ph\u00e1t sinh s\u1ef1 ki\u1ec7n nghi\u1ec7p v\u1ee5, nh\u01b0ng c\u00f3 vai tr\u00f2 ti\u00eau th\u1ee5 (consume) ho\u1eb7c ph\u1ea3n \u1ee9ng v\u1edbi c\u00e1c s\u1ef1 ki\u1ec7n h\u1ec7 th\u1ed1ng quan tr\u1ecdng \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o t\u00ednh nh\u1ea5t qu\u00e1n v\u00e0 c\u1eadp nh\u1eadt.</p>"},{"location":"services/api-gateway/design/#su-kien-can-lang-nghe","title":"\ud83d\udfe2 S\u1ef1 ki\u1ec7n c\u1ea7n l\u1eafng nghe","text":""},{"location":"services/api-gateway/design/#1-rbacupdated","title":"1. <code>rbac.updated</code>","text":"<ul> <li>\u0110\u01b0\u1ee3c ph\u00e1t b\u1edfi: <code>user-sub</code> khi c\u00f3 thay \u0111\u1ed5i ph\u00e2n quy\u1ec1n (g\u00e1n/b\u1ecf role, permission)</li> <li>M\u1ee5c \u0111\u00edch: Xo\u00e1 cache Redis key <code>rbac:{user_id}:{tenant_id}</code> \u0111\u1ec3 c\u1eadp nh\u1eadt quy\u1ec1n truy c\u1eadp m\u1edbi</li> </ul> <pre><code>{\n  \"event\": \"rbac.updated\",\n  \"user_id\": \"u-123\",\n  \"tenant_id\": \"t-456\",\n  \"trace_id\": \"abc-xyz\"\n}\n</code></pre> <p>\ud83d\udccc Gateway c\u1ea7n tri\u1ec3n khai 1 trong 2 c\u01a1 ch\u1ebf:</p> <ul> <li>Subscriber n\u1ed9i b\u1ed9 (Redis Pub/Sub, NATS, GCP Pub/Sub\u2026)</li> <li>Webhook receiver th\u00f4ng qua Cloud Run / Function triggered t\u1eeb Pub/Sub</li> </ul>"},{"location":"services/api-gateway/design/#su-kien-ho-tro-tiem-nang-khuyen-nghi-tuong-lai","title":"\ud83d\udfe1 S\u1ef1 ki\u1ec7n h\u1ed7 tr\u1ee3 ti\u1ec1m n\u0103ng (khuy\u1ebfn ngh\u1ecb t\u01b0\u01a1ng lai)","text":""},{"location":"services/api-gateway/design/#2-route_configupdated","title":"2. <code>route_config.updated</code>","text":"<ul> <li>Khi route file trong GCS/Firestore thay \u0111\u1ed5i (th\u00f4ng qua listener ho\u1eb7c hash diff)</li> <li> <p>Gateway n\u00ean:</p> </li> <li> <p>L\u00e0m m\u1edbi cache c\u00e1c entry <code>routes:*</code></p> </li> <li>Log audit: <code>\"Route config reloaded by event\"</code></li> </ul>"},{"location":"services/api-gateway/design/#3-jwtjwksrotated","title":"3. <code>jwt.jwks.rotated</code>","text":"<ul> <li>Khi <code>token-service</code> xoay public key (key rotation), c\u1ea7n \u0111\u1ea3m b\u1ea3o JWKS cache t\u1ea1i Gateway \u0111\u01b0\u1ee3c l\u00e0m m\u1edbi</li> </ul>"},{"location":"services/api-gateway/design/#forward-trace_id-vao-context-he-thong","title":"\ud83d\udd01 Forward <code>trace_id</code> v\u00e0o context h\u1ec7 th\u1ed1ng","text":"<p>M\u1eb7c d\u00f9 Gateway kh\u00f4ng ph\u00e1t Pub/Sub event nghi\u1ec7p v\u1ee5, n\u00f3 c\u00f3 tr\u00e1ch nhi\u1ec7m truy\u1ec1n <code>trace_id</code> xuy\u00ean su\u1ed1t to\u00e0n h\u1ec7 th\u1ed1ng, bao g\u1ed3m:</p> Context H\u00e0nh vi Request \u0111\u1ebfn backend Th\u00eam header <code>X-Trace-ID</code>, <code>X-User-ID</code>, <code>X-Tenant-ID</code> Response l\u1ed7i chu\u1ea9n h\u00f3a Tr\u1ea3 trong <code>meta.trace_id</code>, <code>meta.service</code>, <code>meta.timestamp</code> Logging M\u1ecdi log c\u1ea7n \u0111\u00ednh k\u00e8m trace ID cho m\u1ee5c \u0111\u00edch truy v\u1ebft Header b\u1ed5 sung <code>X-Login-Method</code> n\u1ebfu tr\u00edch xu\u1ea5t \u0111\u01b0\u1ee3c t\u1eeb token ---"},{"location":"services/api-gateway/design/#6-bao-mat-phan-quyen","title":"6. \ud83d\udd10 B\u1ea3o m\u1eadt &amp; Ph\u00e2n quy\u1ec1n","text":"<p>API Gateway l\u00e0 tuy\u1ebfn ph\u00f2ng v\u1ec7 \u0111\u1ea7u ti\u00ean gi\u1eefa frontend v\u00e0 h\u1ec7 th\u1ed1ng backend, do \u0111\u00f3 c\u00e1c c\u01a1 ch\u1ebf x\u00e1c th\u1ef1c v\u00e0 ki\u1ec3m so\u00e1t truy c\u1eadp (RBAC) ph\u1ea3i \u0111\u01b0\u1ee3c tri\u1ec3n khai ch\u1eb7t ch\u1ebd, \u0111\u1ed3ng b\u1ed9 v\u00e0 hi\u1ec7u qu\u1ea3.</p>"},{"location":"services/api-gateway/design/#xac-thuc-jwt","title":"\ud83d\udd11 X\u00e1c th\u1ef1c JWT","text":"<ul> <li>Gateway x\u00e1c th\u1ef1c token t\u1eeb header <code>Authorization</code> (Bearer JWT)</li> <li>S\u1eed d\u1ee5ng JWKS (JSON Web Key Set) l\u1ea5y t\u1eeb <code>token-service</code> \u0111\u1ec3 verify ch\u1eef k\u00fd</li> <li>Cache JWKS trong Redis (key: <code>jwks:public_key</code>) v\u00e0 t\u1ef1 \u0111\u1ed9ng refresh theo TTL ho\u1eb7c trigger t\u1eeb <code>jwt.jwks.rotated</code> event</li> <li>Token \u0111\u01b0\u1ee3c ki\u1ec3m tra ch\u1ed1ng revoked qua Redis key <code>revoked:{jti}</code></li> </ul>"},{"location":"services/api-gateway/design/#kiem-tra-thu-hoi-revocation-check","title":"\ud83d\uded1 Ki\u1ec3m tra thu h\u1ed3i (Revocation Check)","text":"<ul> <li>N\u1ebfu <code>revoked:{jti}</code> t\u1ed3n t\u1ea1i \u2192 token kh\u00f4ng h\u1ee3p l\u1ec7 \u2192 tr\u1ea3 v\u1ec1 401 Unauthorized</li> <li>N\u1ebfu key kh\u00f4ng t\u1ed3n t\u1ea1i:</li> <li>Fallback g\u1ecdi <code>token-service/introspect</code> \u0111\u1ec3 x\u00e1c minh</li> <li>N\u1ebfu token h\u1ee3p l\u1ec7 \u2192 cache l\u1ea1i <code>revoked:{jti}=false</code> v\u1edbi TTL</li> </ul>"},{"location":"services/api-gateway/design/#kiem-soat-phan-quyen-rbac","title":"\ud83d\udd10 Ki\u1ec3m so\u00e1t ph\u00e2n quy\u1ec1n (RBAC)","text":"<ul> <li>D\u1ef1a v\u00e0o <code>x-required-permission</code> trong route config:</li> <li>Gateway l\u1ea5y danh s\u00e1ch permission t\u1eeb Redis key: <code>rbac:{user_id}:{tenant_id}</code></li> <li>N\u1ebfu kh\u00f4ng c\u00f3 \u2192 g\u1ecdi <code>user-sub</code> \u0111\u1ec3 resolve v\u00e0 cache l\u1ea1i</li> </ul>"},{"location":"services/api-gateway/design/#cau-truc-vi-du","title":"C\u1ea5u tr\u00fac v\u00ed d\u1ee5:","text":"<pre><code>{\n  \"/users/{id}\": {\n    \"method\": [\"PATCH\"],\n    \"x-required-permission\": \"user.update\",\n    \"x-condition\": {\n      \"user_id\": \"{{X-User-ID}}\"\n    }\n  }\n}\n</code></pre> <ul> <li>N\u1ebfu kh\u00f4ng c\u00f3 quy\u1ec1n \u2192 tr\u1ea3 v\u1ec1 403 Forbidden v\u1edbi <code>meta.error_type = rbac.permission_denied</code></li> </ul>"},{"location":"services/api-gateway/design/#ieu-kien-phan-quyen-rbac-condition","title":"\ud83d\udd0e \u0110i\u1ec1u ki\u1ec7n ph\u00e2n quy\u1ec1n (RBAC Condition)","text":"<ul> <li>M\u1ed9t s\u1ed1 route y\u00eau c\u1ea7u ki\u1ec3m tra \u0111i\u1ec1u ki\u1ec7n \u0111\u1ed9ng (VD: <code>user_id == self</code>)</li> <li>\u0110i\u1ec1u ki\u1ec7n \u0111\u01b0\u1ee3c binding t\u1eeb headers, path, ho\u1eb7c payload</li> <li>N\u1ebfu kh\u00f4ng \u0111\u1ea1t \u2192 tr\u1ea3 l\u1ed7i 403 v\u1edbi <code>error_type = rbac.condition_failed</code></li> </ul>"},{"location":"services/api-gateway/design/#forward-headers-quan-trong","title":"\ud83e\udde9 Forward headers quan tr\u1ecdng","text":"Header M\u1ee5c \u0111\u00edch <code>X-User-ID</code> \u0110\u1ecbnh danh ng\u01b0\u1eddi d\u00f9ng <code>X-Tenant-ID</code> Ph\u00e2n v\u00f9ng tenant <code>X-Trace-ID</code> Truy v\u1ebft request <code>X-Permissions</code> (Tu\u1ef3 ch\u1ecdn) danh s\u00e1ch quy\u1ec1n (\u0111\u00e3 resolve) <code>X-Login-Method</code> Ph\u01b0\u01a1ng th\u1ee9c ng\u01b0\u1eddi d\u00f9ng \u0111\u00e3 x\u00e1c th\u1ef1c: <code>oauth2</code>, <code>otp</code>, <code>password</code> <p>\ud83d\udca1 Header <code>X-Login-Method</code> gi\u00fap backend \u0111i\u1ec1u ch\u1ec9nh logic ho\u1eb7c giao di\u1ec7n theo lo\u1ea1i \u0111\u0103ng nh\u1eadp.</p>"},{"location":"services/api-gateway/design/#xu-ly-loi-chuan-hoa-adr-011","title":"\ud83d\udcc9 X\u1eed l\u00fd l\u1ed7i chu\u1ea9n ho\u00e1 (ADR-011)","text":"<p>T\u1ea5t c\u1ea3 l\u1ed7i x\u00e1c th\u1ef1c ho\u1eb7c ph\u00e2n quy\u1ec1n \u0111\u01b0\u1ee3c chu\u1ea9n ho\u00e1 theo <code>ErrorEnvelope</code>:</p> <pre><code>{\n  \"meta\": {\n    \"code\": 403,\n    \"message\": \"FORBIDDEN\",\n    \"error_type\": \"rbac.condition_failed\",\n    \"trace_id\": \"xyz-789\",\n    \"service\": \"api-gateway\",\n    \"timestamp\": \"2025-06-10T12:34:56Z\"\n  },\n  \"error\": {\n    \"reason\": \"Access denied due to condition mismatch\",\n    \"details\": null\n  }\n}\n</code></pre>"},{"location":"services/api-gateway/design/#7-cau-hinh-phu-thuoc","title":"7. \u2699\ufe0f C\u1ea5u h\u00ecnh &amp; Ph\u1ee5 thu\u1ed9c","text":"<p>API Gateway \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf theo nguy\u00ean t\u1eafc stateless v\u00e0 d\u1ec5 c\u1ea5u h\u00ecnh qua bi\u1ebfn m\u00f4i tr\u01b0\u1eddng, kh\u00f4ng ph\u1ee5 thu\u1ed9c tr\u1ef1c ti\u1ebfp v\u00e0o b\u1ea5t k\u1ef3 c\u01a1 s\u1edf d\u1eef li\u1ec7u n\u00e0o.</p>"},{"location":"services/api-gateway/design/#bien-moi-truong-chinh","title":"\ud83d\udd27 Bi\u1ebfn m\u00f4i tr\u01b0\u1eddng ch\u00ednh","text":"Bi\u1ebfn M\u00f4 t\u1ea3 <code>JWT_PUBLIC_JWKS_URL</code> URL JWKS t\u1eeb <code>token-service</code> \u0111\u1ec3 verify ch\u1eef k\u00fd JWT <code>REDIS_URL</code> K\u1ebft n\u1ed1i t\u1edbi Redis cache cho revoked token, RBAC rule v\u00e0 route config <code>ROUTE_CONFIG_PATH</code> \u0110\u01b0\u1eddng d\u1eabn t\u1edbi file JSON \u0111\u1ecbnh tuy\u1ebfn (GCS URL, Firestore path\u2026) <code>RBAC_ENABLED</code> B\u1eadt/t\u1eaft ph\u00e2n quy\u1ec1n RBAC \u1edf layer gateway (default: true) <code>JWKS_CACHE_TTL</code> TTL cache public key JWKS (gi\u00e2y) <code>REVOCATION_TTL</code> TTL cho cache <code>revoked:{jti}</code> <code>RBAC_CACHE_TTL</code> TTL cho cache <code>rbac:{uid}:{tid}</code>"},{"location":"services/api-gateway/design/#phu-thuoc-he-thong","title":"\ud83d\udd17 Ph\u1ee5 thu\u1ed9c h\u1ec7 th\u1ed1ng","text":"Th\u00e0nh ph\u1ea7n M\u1ee5c \u0111\u00edch s\u1eed d\u1ee5ng token-service Cung c\u1ea5p JWKS public key v\u00e0 API <code>/token/introspect</code> user-sub Cung c\u1ea5p permission th\u1ef1c t\u1ebf n\u1ebfu cache kh\u00f4ng c\u00f3 Redis L\u01b0u tr\u1eef cache: revoked token, RBAC, route config Firestore / GCS L\u01b0u tr\u1eef t\u1ec7p c\u1ea5u h\u00ecnh \u0111\u1ecbnh tuy\u1ebfn \u0111\u1ed9ng Pub/Sub L\u1eafng nghe <code>rbac.updated</code> v\u00e0 c\u00e1c s\u1ef1 ki\u1ec7n kh\u00e1c \u0111\u1ec3 invalidation cache"},{"location":"services/api-gateway/design/#71-thanh-phan-noi-bo","title":"7.1 \ud83e\udde9 Th\u00e0nh ph\u1ea7n n\u1ed9i b\u1ed9","text":"Module Ch\u1ee9c n\u0103ng ch\u00ednh <code>JWT Validation Engine</code> X\u00e1c th\u1ef1c token, ki\u1ec3m tra ch\u1eef k\u00fd v\u1edbi JWKS <code>RBAC Policy Engine</code> Ki\u1ec3m tra quy\u1ec1n, evaluate condition t\u1eeb <code>x-condition</code> <code>Route Resolver</code> Mapping path/method \u2192 backend, permission <code>Request Filter</code> G\u1eafn th\u00eam header (<code>X-Trace-ID</code>, <code>X-Tenant-ID</code>, \u2026) v\u00e0o request <code>Response Formatter</code> Bi\u1ebfn \u0111\u1ed5i l\u1ed7i t\u1eeb backend v\u1ec1 \u0111\u1ecbnh d\u1ea1ng chu\u1ea9n h\u00f3a (ADR-011) <code>Revocation Checker</code> Ki\u1ec3m tra token b\u1ecb thu h\u1ed3i (<code>revoked:{jti}</code>) <code>Cache Client</code> \u0110\u1ecdc/ghi Redis cho route, RBAC, revoked, jwks <code>PubSub Listener</code> X\u1eed l\u00fd c\u00e1c s\u1ef1 ki\u1ec7n nh\u01b0 <code>rbac.updated</code> \u0111\u1ec3 t\u1ef1 \u0111\u1ed9ng x\u00f3a cache t\u01b0\u01a1ng \u1ee9ng"},{"location":"services/api-gateway/design/#8-testing","title":"8. \ud83e\uddea Testing","text":"<p>Vi\u1ec7c ki\u1ec3m th\u1eed API Gateway c\u1ea7n bao ph\u1ee7 \u0111\u1ea7y \u0111\u1ee7 c\u00e1c lu\u1ed3ng x\u1eed l\u00fd ch\u00ednh bao g\u1ed3m x\u00e1c th\u1ef1c, ph\u00e2n quy\u1ec1n, \u0111\u1ecbnh tuy\u1ebfn, x\u1eed l\u00fd l\u1ed7i v\u00e0 observability. H\u1ec7 th\u1ed1ng c\u1ea7n c\u00f3 c\u1ea3 ki\u1ec3m th\u1eed \u0111\u01a1n v\u1ecb (unit) v\u00e0 t\u00edch h\u1ee3p (integration) \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o ch\u1ea5t l\u01b0\u1ee3ng.</p>"},{"location":"services/api-gateway/design/#unit-tests","title":"\u2705 Unit Tests","text":"Th\u00e0nh ph\u1ea7n M\u1ee5c ti\u00eau ki\u1ec3m th\u1eed Route Resolver Ki\u1ec3m tra \u00e1nh x\u1ea1 path/method \u2192 backend v\u00e0 permission JWT Validation Engine Ki\u1ec3m tra verify JWT, cache JWKS v\u00e0 x\u1eed l\u00fd key rotation RBAC Policy Engine Ki\u1ec3m tra ph\u00e2n quy\u1ec1n theo <code>x-required-permission</code>, <code>x-condition</code> Error Formatter Ki\u1ec3m tra chu\u1ea9n h\u00f3a l\u1ed7i t\u1eeb backend \u2192 <code>ErrorEnvelope</code> Revocation Checker Ki\u1ec3m tra cache <code>revoked:{jti}</code> v\u00e0 fallback sang introspect"},{"location":"services/api-gateway/design/#integration-tests","title":"\ud83d\udd01 Integration Tests","text":"K\u1ecbch b\u1ea3n M\u00f4 t\u1ea3 \u2705 Proxy th\u00e0nh c\u00f4ng Request h\u1ee3p l\u1ec7 \u2192 \u0111\u1ecbnh tuy\u1ebfn \u0111\u00fang, tr\u1ea3 v\u1ec1 response backend \u2705 Token h\u1ebft h\u1ea1n / sai ch\u1eef k\u00fd Tr\u1ea3 v\u1ec1 401 Unauthorized \u2705 Token b\u1ecb thu h\u1ed3i Cache hit <code>revoked:{jti}</code> \u2192 401 Unauthorized \u2705 Kh\u00f4ng \u0111\u1ee7 permission Tr\u1ea3 v\u1ec1 403 Forbidden v\u1edbi <code>error_type: rbac.permission_denied</code> \u2705 Kh\u00f4ng \u0111\u1ea1t \u0111i\u1ec1u ki\u1ec7n RBAC Tr\u1ea3 v\u1ec1 403 Forbidden v\u1edbi <code>error_type: rbac.condition_failed</code> \u2705 L\u1ed7i backend kh\u00f4ng chu\u1ea9n h\u00f3a Gateway t\u1ef1 \u0111\u1ed9ng map l\u1ed7i v\u1ec1 \u0111\u1ecbnh d\u1ea1ng chu\u1ea9n ADR-011 \u2705 Forward header \u0110\u1ea3m b\u1ea3o c\u00e1c header nh\u01b0 <code>X-Trace-ID</code>, <code>X-User-ID</code>, <code>X-Tenant-ID</code> \u0111\u01b0\u1ee3c chuy\u1ec3n ti\u1ebfp \u0111\u00fang \u2705 Cache miss \u2192 fallback RBAC Redis miss \u2192 g\u1ecdi <code>user-sub</code> \u0111\u1ec3 resolve quy\u1ec1n \u2192 th\u00e0nh c\u00f4ng \u2705 Invalidate cache qua Pub/Sub Nh\u1eadn s\u1ef1 ki\u1ec7n <code>rbac.updated</code> \u2192 x\u00f3a \u0111\u00fang key trong Redis"},{"location":"services/api-gateway/design/#cong-cu-e-xuat","title":"\ud83e\uddea C\u00f4ng c\u1ee5 \u0111\u1ec1 xu\u1ea5t","text":"<ul> <li>pytest, unittest (Python)</li> <li>WireMock, MockServer cho gi\u1ea3 l\u1eadp backend trong integration test</li> <li>Redis mock \u0111\u1ec3 gi\u1ea3 l\u1eadp c\u00e1c tr\u1ea1ng th\u00e1i cache (revoked, rbac)</li> <li>Postman/Newman: vi\u1ebft test end-to-end k\u00e8m k\u1ecbch b\u1ea3n l\u1ed7i</li> <li>Locust ho\u1eb7c k6: test hi\u1ec7u n\u0103ng/\u0111\u1ed9 tr\u1ec5 khi route t\u1edbi nhi\u1ec1u backend</li> </ul>"},{"location":"services/api-gateway/design/#muc-tieu-coverage","title":"\ud83d\udccc M\u1ee5c ti\u00eau coverage","text":"<ul> <li>Unit test coverage \u2265 90%</li> <li>Integration test bao ph\u1ee7 to\u00e0n b\u1ed9 lu\u1ed3ng ch\u00ednh + l\u1ed7i bi\u00ean + cache</li> </ul>"},{"location":"services/api-gateway/design/#9-observability","title":"9. \ud83d\udcc8 Observability","text":"<p>API Gateway l\u00e0 \u0111i\u1ec3m \u0111\u1ea7u ti\u00ean ti\u1ebfp nh\u1eadn m\u1ecdi request, n\u00ean kh\u1ea3 n\u0103ng quan s\u00e1t (observability) l\u00e0 b\u1eaft bu\u1ed9c \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o hi\u1ec7u su\u1ea5t, b\u1ea3o m\u1eadt v\u00e0 d\u1ec5 ch\u1ea9n \u0111o\u00e1n s\u1ef1 c\u1ed1.</p>"},{"location":"services/api-gateway/design/#metrics-e-xuat-prometheus-hoac-tuong-uong","title":"\ud83d\udcca Metrics \u0111\u1ec1 xu\u1ea5t (Prometheus ho\u1eb7c t\u01b0\u01a1ng \u0111\u01b0\u01a1ng)","text":"T\u00ean metric Lo\u1ea1i M\u00f4 t\u1ea3 <code>api_gateway_request_total</code> Counter T\u1ed5ng s\u1ed1 request nh\u1eadn v\u00e0o Gateway <code>api_gateway_request_duration_seconds</code> Histogram Th\u1eddi gian x\u1eed l\u00fd request chia theo path/backend/status_code <code>api_gateway_permission_denied_total</code> Counter S\u1ed1 l\u01b0\u1ee3ng request b\u1ecb t\u1eeb ch\u1ed1i do thi\u1ebfu permission <code>api_gateway_condition_failed_total</code> Counter S\u1ed1 l\u01b0\u1ee3ng request b\u1ecb t\u1eeb ch\u1ed1i do kh\u00f4ng \u0111\u1ea1t \u0111i\u1ec1u ki\u1ec7n <code>x-condition</code> <code>api_gateway_revoked_token_total</code> Counter S\u1ed1 token b\u1ecb t\u1eeb ch\u1ed1i do \u0111\u00e3 b\u1ecb revoke <code>api_gateway_backend_error_total</code> Counter S\u1ed1 l\u1ed7i do backend tr\u1ea3 v\u1ec1 (5xx) <p>\ud83d\udca1 N\u00ean g\u1eafn label theo: <code>path</code>, <code>method</code>, <code>tenant_id</code>, <code>backend_service</code></p>"},{"location":"services/api-gateway/design/#logging","title":"\ud83d\udcdc Logging","text":"Th\u00f4ng tin c\u1ea7n log Ghi ch\u00fa <code>trace_id</code> Sinh n\u1ebfu ch\u01b0a c\u00f3, xuy\u00ean su\u1ed1t to\u00e0n h\u1ec7 th\u1ed1ng <code>user_id</code>, <code>tenant_id</code> Tr\u00edch xu\u1ea5t t\u1eeb JWT ho\u1eb7c header <code>path</code>, <code>method</code>, <code>status_code</code> M\u1ed7i request <code>duration_ms</code> \u0110o th\u1eddi gian x\u1eed l\u00fd <code>permission_checked</code>, <code>rbac_result</code> Th\u00f4ng tin ki\u1ec3m tra quy\u1ec1n, k\u1ec3 c\u1ea3 pass/fail <code>condition_checked</code>, <code>condition_result</code> N\u1ebfu c\u00f3 <code>x-condition</code>, ghi r\u00f5 gi\u00e1 tr\u1ecb ki\u1ec3m tra v\u00e0 k\u1ebft qu\u1ea3 <code>login_method</code> - N\u1ebfu l\u1ea5y \u0111\u01b0\u1ee3c t\u1eeb token, s\u1ebd \u0111\u01b0\u1ee3c \u0111\u01b0a v\u00e0o log context (<code>X-Login-Method</code>) \u0111\u1ec3 ph\u00e2n t\u00edch h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng theo ph\u01b0\u01a1ng th\u1ee9c x\u00e1c th\u1ef1c - (v\u00ed d\u1ee5: \u0111\u00e1nh gi\u00e1 t\u1ef7 l\u1ec7 l\u1ed7i theo lo\u1ea1i \u0111\u0103ng nh\u1eadp). <p>\u26a0\ufe0f Kh\u00f4ng log access token, refresh token ho\u1eb7c th\u00f4ng tin nh\u1ea1y c\u1ea3m (theo ADR-004 Security)</p>"},{"location":"services/api-gateway/design/#tracing-opentelemetry-hoac-tuong-uong","title":"\ud83d\udcc8 Tracing (OpenTelemetry ho\u1eb7c t\u01b0\u01a1ng \u0111\u01b0\u01a1ng)","text":"<ul> <li>Gateway c\u1ea7n t\u1ea1o span g\u1ed1c (<code>root span</code>) n\u1ebfu request kh\u00f4ng c\u00f3 <code>trace_id</code></li> <li>Forward trace context qua <code>X-Trace-ID</code>, ho\u1eb7c <code>traceparent</code> n\u1ebfu d\u00f9ng W3C Trace Context</li> <li>M\u1ed7i ch\u1eb7ng nh\u01b0 <code>RBAC check</code>, <code>Revoked token lookup</code>, <code>Proxy call</code> c\u1ea7n t\u1ea1o span ri\u00eang</li> </ul>"},{"location":"services/api-gateway/design/#alerting-goi-y-rule","title":"\ud83e\uddea Alerting (g\u1ee3i \u00fd rule)","text":"T\u00ean c\u1ea3nh b\u00e1o \u0110i\u1ec1u ki\u1ec7n \u2757 Backend error rate cao <code>api_gateway_backend_error_total{job=\"gw\"}/api_gateway_request_total &gt; 5%</code> trong 5 ph\u00fat \u2757 Permission denied spike T\u0103ng \u0111\u1ed9t bi\u1ebfn trong <code>api_gateway_permission_denied_total</code> \u2757 T\u1ed1c \u0111\u1ed9 ph\u1ea3n h\u1ed3i gi\u1ea3m m\u1ea1nh P95 <code>api_gateway_request_duration_seconds</code> &gt; ng\u01b0\u1ee1ng cho ph\u00e9p \u2757 Redis kh\u00f4ng ph\u1ea3n h\u1ed3i \u0110\u1ebfm l\u1ed7i Redis connect ho\u1eb7c latency &gt; 200ms <p>T\u1ea5t c\u1ea3 observability c\u1ea7n \u0111\u01b0\u1ee3c tri\u1ec3n khai theo \u0111\u00fang chu\u1ea9n ADR-004 Security v\u00e0 ADR-012 Response Structure, \u0111\u1eb7c bi\u1ec7t l\u00e0 b\u1ea3o v\u1ec7 d\u1eef li\u1ec7u ng\u01b0\u1eddi d\u00f9ng khi log ho\u1eb7c trace.</p>"},{"location":"services/api-gateway/design/#10-reliability","title":"10. \ud83d\udd01 Reliability","text":"<p>API Gateway \u0111\u00f3ng vai tr\u00f2 trung gian cho m\u1ecdi giao ti\u1ebfp frontend \u2192 backend, n\u00ean ph\u1ea3i \u0111\u1ea3m b\u1ea3o \u0111\u1ed9 tin c\u1eady cao (high reliability) k\u1ec3 c\u1ea3 khi m\u1ed9t ph\u1ea7n h\u1ec7 th\u1ed1ng g\u1eb7p s\u1ef1 c\u1ed1. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c c\u01a1 ch\u1ebf \u0111\u1ea3m b\u1ea3o t\u00ednh s\u1eb5n s\u00e0ng v\u00e0 ph\u1ee5c h\u1ed3i.</p>"},{"location":"services/api-gateway/design/#timeout-retry","title":"\u23f1\ufe0f Timeout &amp; Retry","text":"<ul> <li>M\u1ed7i route trong c\u1ea5u h\u00ecnh c\u00f3 th\u1ec3 khai b\u00e1o <code>timeout</code> v\u00e0 <code>retry</code> ri\u00eang bi\u1ec7t.</li> <li>N\u1ebfu kh\u00f4ng khai b\u00e1o, \u00e1p d\u1ee5ng m\u1eb7c \u0111\u1ecbnh:  </li> <li><code>timeout</code>: 3000ms  </li> <li><code>retry</code>: 1 l\u1ea7n, theo c\u01a1 ch\u1ebf exponential backoff</li> </ul> <p>\u26a0\ufe0f Retry ch\u1ec9 n\u00ean \u00e1p d\u1ee5ng cho c\u00e1c method idempotent nh\u01b0 <code>GET</code>, <code>HEAD</code>, <code>OPTIONS</code>.</p>"},{"location":"services/api-gateway/design/#xu-ly-loi-backend","title":"\ud83e\uddef X\u1eed l\u00fd l\u1ed7i backend","text":"<ul> <li>Gateway t\u1ef1 \u0111\u1ed9ng b\u1eaft l\u1ed7i backend tr\u1ea3 v\u1ec1 (5xx) v\u00e0 chu\u1ea9n h\u00f3a theo <code>ADR-011</code></li> <li>Ghi log chi ti\u1ebft <code>trace_id</code>, backend service, error message</li> <li>Metric <code>api_gateway_backend_error_total</code> t\u0103ng theo t\u1eebng l\u1ed7i</li> </ul>"},{"location":"services/api-gateway/design/#isolate-tung-routebackend","title":"\ud83d\udca5 Isolate t\u1eebng route/backend","text":"<ul> <li>N\u1ebfu m\u1ed9t backend service (VD: <code>report-service</code>) g\u1eb7p l\u1ed7i li\u00ean t\u1ee5c, kh\u00f4ng \u1ea3nh h\u01b0\u1edfng t\u1edbi c\u00e1c route kh\u00e1c</li> <li>M\u1ed7i route n\u00ean ch\u1ea1y trong context \u0111\u1ed9c l\u1eadp (thread pool ho\u1eb7c async task per route)</li> </ul>"},{"location":"services/api-gateway/design/#co-che-fallback-tuy-chon-mo-rong","title":"\ud83e\uddf0 C\u01a1 ch\u1ebf fallback (tu\u1ef3 ch\u1ecdn m\u1edf r\u1ed9ng)","text":"<ul> <li>Cho ph\u00e9p ch\u1ec9 \u0111\u1ecbnh <code>fallback_backend</code> n\u1ebfu backend ch\u00ednh kh\u00f4ng ph\u1ea3n h\u1ed3i</li> <li>Ho\u1eb7c g\u1eedi th\u00f4ng b\u00e1o l\u1ed7i c\u00f3 th\u1ec3 hi\u1ec3u \u0111\u01b0\u1ee3c t\u1eeb Gateway thay v\u00ec l\u1ed7i raw 5xx</li> </ul>"},{"location":"services/api-gateway/design/#circuit-breaker-nen-tich-hop","title":"\ud83d\udea8 Circuit Breaker (n\u00ean t\u00edch h\u1ee3p)","text":"<ul> <li>Sau X l\u1ea7n l\u1ed7i li\u00ean t\u1ee5c, t\u1ea1m ng\u01b0ng g\u1ecdi backend \u0111\u00f3 trong Y gi\u00e2y</li> <li>Ghi log audit: <code>\"Circuit opened for backend: user-service.master\"</code></li> </ul> <p>C\u00f3 th\u1ec3 d\u00f9ng th\u01b0 vi\u1ec7n nh\u01b0 resilience4j, envoy rate limit, ho\u1eb7c Redis lock custom.</p>"},{"location":"services/api-gateway/design/#graceful-degradation","title":"\ud83e\uddfc Graceful Degradation","text":"<ul> <li>V\u1edbi c\u00e1c l\u1ed7i kh\u00f4ng nghi\u00eam tr\u1ecdng (v\u00ed d\u1ee5 m\u1ea5t log, m\u1ea5t trace) \u2192 kh\u00f4ng \u1ea3nh h\u01b0\u1edfng x\u1eed l\u00fd ch\u00ednh</li> <li>Log c\u1ea3nh b\u00e1o thay v\u00ec l\u1ed7i h\u1ec7 th\u1ed1ng</li> </ul>"},{"location":"services/api-gateway/design/#tu-ong-reload-cau-hinh","title":"\ud83d\udd04 T\u1ef1 \u0111\u1ed9ng reload c\u1ea5u h\u00ecnh","text":"<ul> <li>Khi t\u1ec7p route config thay \u0111\u1ed5i (qua polling ho\u1eb7c Pub/Sub), Gateway reload c\u1ea5u h\u00ecnh m\u00e0 kh\u00f4ng c\u1ea7n restart</li> <li>C\u1ea5u h\u00ecnh Redis TTL \u0111\u1ec3 tr\u00e1nh stale cache</li> </ul>"},{"location":"services/api-gateway/design/#health-check-ready-check","title":"\ud83d\udd17 Health Check &amp; Ready Check","text":"<ul> <li><code>/healthz</code> \u2013 ki\u1ec3m tra Gateway ho\u1ea1t \u0111\u1ed9ng b\u00ecnh th\u01b0\u1eddng</li> <li><code>/readyz</code> \u2013 ki\u1ec3m tra k\u1ebft n\u1ed1i Redis, t\u1ea3i route config, JWKS success</li> </ul> <p>Response v\u00ed d\u1ee5:</p> <pre><code>{\n  \"status\": \"ok\",\n  \"redis\": \"connected\",\n  \"jwks\": \"valid\",\n  \"route_config\": \"loaded\"\n}\n</code></pre>"},{"location":"services/api-gateway/design/#11-hieu-nang-scale","title":"11. \u26a1\ufe0f Hi\u1ec7u n\u0103ng &amp; Scale","text":"<p>API Gateway \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf \u0111\u1ec3 ph\u1ee5c v\u1ee5 h\u00e0ng ng\u00e0n request m\u1ed7i gi\u00e2y v\u1edbi \u0111\u1ed9 tr\u1ec5 th\u1ea5p, kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng ngang, v\u00e0 kh\u00f4ng c\u00f3 \u0111i\u1ec3m ngh\u1ebdn \u0111\u01a1n. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c chi\u1ebfn l\u01b0\u1ee3c \u0111\u1ea3m b\u1ea3o hi\u1ec7u n\u0103ng v\u00e0 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng c\u1ee7a Gateway.</p>"},{"location":"services/api-gateway/design/#kien-truc-stateless","title":"\ud83e\uddf1 Ki\u1ebfn tr\u00fac stateless","text":"<ul> <li>M\u1ecdi state (RBAC, route config, token revoked, JWKS\u2026) \u0111\u1ec1u \u0111\u01b0\u1ee3c cache qua Redis ho\u1eb7c c\u1ea5u h\u00ecnh t\u1eeb ngo\u00e0i.</li> <li>Cho ph\u00e9p scale ngang d\u1ec5 d\u00e0ng theo m\u00f4 h\u00ecnh container (Kubernetes, Cloud Run\u2026).</li> </ul>"},{"location":"services/api-gateway/design/#caching-chien-luoc","title":"\ud83d\udd01 Caching chi\u1ebfn l\u01b0\u1ee3c","text":"<ul> <li>Redis cache gi\u00fap gi\u1ea3m ph\u1ee5 thu\u1ed9c v\u00e0o <code>user-sub</code>, <code>token-service</code>, GCS/Firestore</li> <li>TTL m\u1eb7c \u0111\u1ecbnh cho m\u1ed7i lo\u1ea1i cache:</li> <li><code>rbac:{uid}:{tid}</code> \u2192 300s</li> <li><code>revoked:{jti}</code> \u2192 180s</li> <li><code>jwks:public_key</code> \u2192 600s</li> <li><code>routes:{path}:{method}</code> \u2192 300s</li> <li>C\u00f3 th\u1ec3 invalidate theo event Pub/Sub (<code>rbac.updated</code>, <code>jwt.jwks.rotated</code>)</li> </ul>"},{"location":"services/api-gateway/design/#xu-ly-rbac-tai-cho","title":"\ud83e\udde0 X\u1eed l\u00fd RBAC t\u1ea1i ch\u1ed7","text":"<ul> <li>To\u00e0n b\u1ed9 logic RBAC v\u00e0 \u0111i\u1ec1u ki\u1ec7n <code>x-condition</code> \u0111\u01b0\u1ee3c x\u1eed l\u00fd ngay t\u1ea1i Gateway \u2192 kh\u00f4ng c\u1ea7n call backend</li> <li>\u0110i\u1ec1u ki\u1ec7n \u0111\u01b0\u1ee3c \u0111\u00e1nh gi\u00e1 t\u1ea1i runtime, v\u00ed d\u1ee5: <code>\"user_id\": \"{{X-User-ID}}\"</code></li> </ul>"},{"location":"services/api-gateway/design/#load-balancing-noi-bo","title":"\ud83d\udd00 Load balancing n\u1ed9i b\u1ed9","text":"<ul> <li>V\u1edbi m\u1ed7i backend, c\u00f3 th\u1ec3 c\u1ea5u h\u00ecnh backend alias \u0111\u1ec3 Gateway ph\u00e2n t\u1ea3i gi\u1eefa nhi\u1ec1u \u0111\u1ecba ch\u1ec9 n\u1ed9i b\u1ed9</li> <li>T\u00f9y ch\u1ecdn sticky session ho\u1eb7c round-robin t\u00f9y theo nhu c\u1ea7u</li> </ul>"},{"location":"services/api-gateway/design/#toi-uu-phan-hoi-loi","title":"\ud83d\udcc9 T\u1ed1i \u01b0u ph\u1ea3n h\u1ed3i l\u1ed7i","text":"<ul> <li>Thay v\u00ec tr\u1ea3 l\u1ed7i t\u1eeb backend, Gateway chu\u1ea9n h\u00f3a l\u1ed7i ngay sau b\u01b0\u1edbc ph\u00e2n quy\u1ec1n/token fail</li> <li>Tr\u00e1nh t\u1ed1n t\u00e0i nguy\u00ean backend kh\u00f4ng c\u1ea7n thi\u1ebft</li> </ul>"},{"location":"services/api-gateway/design/#goi-y-cong-nghe-trien-khai","title":"\u26a1 G\u1ee3i \u00fd c\u00f4ng ngh\u1ec7 tri\u1ec3n khai","text":"Th\u00e0nh ph\u1ea7n G\u1ee3i \u00fd tri\u1ec3n khai Server core FastAPI, Express.js, Go Fiber\u2026 Reverse proxy (n\u1ebfu c\u1ea7n) NGINX, Envoy (tr\u01b0\u1edbc Gateway) Cache Redis cluster Trace OpenTelemetry + Tempo / Zipkin / Jaeger Metrics Prometheus + Grafana"},{"location":"services/api-gateway/design/#benchmark-muc-tieu","title":"\ud83d\udccf Benchmark m\u1ee5c ti\u00eau","text":"M\u1ee5c ti\u00eau Gi\u00e1 tr\u1ecb khuy\u1ebfn ngh\u1ecb P95 latency &lt; 100ms Throughput &gt; 1000 requests/sec tr\u00ean 1 instance nh\u1ecf Cache hit rate (RBAC + revoked) \u2265 95% Redis latency &lt; 5ms Cold start JWKS verify &lt; 300ms (trong tr\u01b0\u1eddng h\u1ee3p key cache miss)"},{"location":"services/api-gateway/design/#12-tai-lieu-lien-quan","title":"12. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Interface Contract</li> <li>Data Model</li> <li>OpenAPI Spec</li> <li>ADR-011: API Error Format</li> <li>ADR-012: Response Structure</li> <li>RBAC Deep Dive</li> </ul>"},{"location":"services/api-gateway/interface-contract/","title":"\ud83d\udcd8 API Gateway \u2013 Interface Contract","text":"<p>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 c\u00e1ch API Gateway x\u1eed l\u00fd request \u0111\u1ebfn c\u00e1c backend service trong h\u1ec7 sinh th\u00e1i DX-VAS th\u00f4ng qua c\u01a1 ch\u1ebf \u0111\u1ecbnh tuy\u1ebfn \u0111\u1ed9ng, ki\u1ec3m so\u00e1t ph\u00e2n quy\u1ec1n (RBAC), x\u00e1c th\u1ef1c JWT v\u00e0 chu\u1ea9n h\u00f3a l\u1ed7i. Gateway kh\u00f4ng ch\u1ee9a logic nghi\u1ec7p v\u1ee5 nh\u01b0ng \u0111\u00f3ng vai tr\u00f2 quan tr\u1ecdng trong vi\u1ec7c b\u1ea3o v\u1ec7, quan s\u00e1t v\u00e0 ki\u1ec3m so\u00e1t to\u00e0n b\u1ed9 lu\u1ed3ng request.</p> <p>\ud83d\udccc Ph\u1ea1m vi: - \u0110\u1ecbnh tuy\u1ebfn v\u00e0 x\u00e1c th\u1ef1c request t\u1eeb frontend \u0111\u1ebfn c\u00e1c service backend d\u1ef1a tr\u00ean route config. - Th\u1ef1c hi\u1ec7n ki\u1ec3m tra ph\u00e2n quy\u1ec1n theo permission \u0111\u00e3 \u0111\u01b0\u1ee3c resolve t\u1eeb <code>user-sub</code>. - Chu\u1ea9n h\u00f3a to\u00e0n b\u1ed9 l\u1ed7i theo <code>ADR-011</code> v\u00e0 ph\u1ea3n h\u1ed3i th\u00e0nh c\u00f4ng theo <code>ADR-012</code>.</p> <p>\ud83d\udc65 \u0110\u1ed1i t\u01b0\u1ee3ng s\u1eed d\u1ee5ng: Superadmin Webapp, Admin Webapp, Customer Portal, c\u00e1c adapter v\u00e0 automation script n\u1ed9i b\u1ed9.</p>"},{"location":"services/api-gateway/interface-contract/#1-nguyen-tac-chung-khi-su-dung-api","title":"1. \ud83d\udd27 Nguy\u00ean t\u1eafc chung khi s\u1eed d\u1ee5ng API","text":""},{"location":"services/api-gateway/interface-contract/#11-xac-thuc-va-trace","title":"1.1. X\u00e1c th\u1ef1c v\u00e0 Trace","text":"<ul> <li>M\u1ecdi request \u0111\u1ebfn Gateway (tr\u1eeb c\u00e1c route <code>public</code>) \u0111\u1ec1u y\u00eau c\u1ea7u header: <pre><code>Authorization: Bearer &lt;JWT&gt;\n</code></pre></li> <li>Gateway s\u1ebd x\u00e1c th\u1ef1c JWT th\u00f4ng qua JWKS (do <code>token-service</code> cung c\u1ea5p).</li> <li>Header <code>x-trace-id</code> l\u00e0 t\u00f9y ch\u1ecdn t\u1eeb ph\u00eda client; n\u1ebfu kh\u00f4ng c\u00f3, Gateway s\u1ebd t\u1ef1 \u0111\u1ed9ng sinh m\u1ed9t UUID v4.</li> <li>M\u1ed7i response (k\u1ec3 c\u1ea3 l\u1ed7i) s\u1ebd bao g\u1ed3m <code>meta.trace_id</code> \u0111\u1ec3 ph\u1ee5c v\u1ee5 trace to\u00e0n h\u1ec7 th\u1ed1ng.</li> </ul>"},{"location":"services/api-gateway/interface-contract/#12-header-forward-mac-inh-en-backend","title":"1.2. Header forward m\u1eb7c \u0111\u1ecbnh \u0111\u1ebfn backend","text":"<p>Gateway s\u1ebd t\u1ef1 \u0111\u1ed9ng th\u00eam c\u00e1c header sau v\u00e0o request g\u1eedi \u0111\u1ebfn backend:</p> Header M\u1ee5c \u0111\u00edch <code>X-Trace-ID</code> M\u00e3 \u0111\u1ecbnh danh trace xuy\u00ean su\u1ed1t to\u00e0n h\u1ec7 th\u1ed1ng <code>X-User-ID</code> \u0110\u1ecbnh danh ng\u01b0\u1eddi d\u00f9ng, l\u1ea5y t\u1eeb JWT claim <code>X-Tenant-ID</code> Tenant hi\u1ec7n h\u00e0nh, l\u1ea5y t\u1eeb JWT ho\u1eb7c header g\u1ed1c <code>X-Permissions</code> Danh s\u00e1ch quy\u1ec1n (n\u1ebfu c\u1ea7n), resolved t\u1eeb cache <code>X-Service</code> T\u00ean backend \u0111\u01b0\u1ee3c \u0111\u1ecbnh tuy\u1ebfn (ghi log/tracing) <code>X-Login-Method</code> Ph\u01b0\u01a1ng th\u1ee9c \u0111\u0103ng nh\u1eadp: <code>otp</code>, <code>oauth2</code>, <code>password</code> <p>\u26a0\ufe0f Backend c\u1ea7n tin t\u01b0\u1edfng c\u00e1c header n\u00e0y l\u00e0 h\u1ee3p l\u1ec7 v\u00e0 \u0111\u00e3 \u0111\u01b0\u1ee3c Gateway ki\u1ec3m tra.</p>"},{"location":"services/api-gateway/interface-contract/#13-xu-ly-loi-thong-nhat-theo-adr-011","title":"1.3. X\u1eed l\u00fd l\u1ed7i th\u1ed1ng nh\u1ea5t theo ADR-011","text":"<ul> <li>C\u00e1c l\u1ed7i t\u1eeb backend n\u1ebfu kh\u00f4ng tu\u00e2n <code>ErrorEnvelope</code> s\u1ebd \u0111\u01b0\u1ee3c Gateway chu\u1ea9n h\u00f3a l\u1ea1i.</li> <li>Gateway c\u00f3 th\u1ec3 t\u1ef1 sinh l\u1ed7i (403/401/500) n\u1ebfu th\u1ea5t b\u1ea1i trong c\u00e1c b\u01b0\u1edbc ki\u1ec3m tra token, RBAC, ho\u1eb7c \u0111i\u1ec1u ki\u1ec7n <code>x-condition</code>.</li> </ul> <p>V\u00ed d\u1ee5 response l\u1ed7i chu\u1ea9n h\u00f3a: <pre><code>{\n\"meta\": {\n  \"code\": 403,\n  \"message\": \"FORBIDDEN\",\n  \"error_type\": \"rbac.condition_failed\",\n  \"trace_id\": \"abc-123\",\n  \"service\": \"api-gateway\",\n  \"timestamp\": \"2025-06-10T12:34:56Z\"\n},\n\"error\": {\n  \"reason\": \"Access denied due to condition mismatch\",\n  \"details\": null\n}\n}\n</code></pre></p>"},{"location":"services/api-gateway/interface-contract/#14-ket-qua-thanh-cong","title":"1.4. K\u1ebft qu\u1ea3 th\u00e0nh c\u00f4ng","text":"<ul> <li>N\u1ebfu backend \u0111\u00e3 tr\u1ea3 response theo chu\u1ea9n <code>ADR-012</code>, Gateway s\u1ebd gi\u1eef nguy\u00ean.</li> <li>N\u1ebfu backend tr\u1ea3 ki\u1ec3u <code>raw</code>, Gateway v\u1eabn b\u1ecdc v\u00e0o <code>meta + data</code> \u0111\u1ec3 frontend lu\u00f4n x\u1eed l\u00fd th\u1ed1ng nh\u1ea5t.</li> </ul>"},{"location":"services/api-gateway/interface-contract/#15-luu-y-ve-phan-quyen","title":"1.5. L\u01b0u \u00fd v\u1ec1 ph\u00e2n quy\u1ec1n","text":"<ul> <li>C\u00e1c permission \u0111\u01b0\u1ee3c resolve theo Redis key <code>rbac:{user_id}:{tenant_id}</code>.</li> <li>N\u1ebfu kh\u00f4ng c\u00f3 trong cache \u2192 Gateway g\u1ecdi <code>user-sub</code> \u0111\u1ec3 l\u1ea5y quy\u1ec1n th\u1eadt.</li> <li>\u0110i\u1ec1u ki\u1ec7n <code>x-condition</code> trong route config (n\u1ebfu c\u00f3) s\u1ebd \u0111\u01b0\u1ee3c \u0111\u00e1nh gi\u00e1 t\u1ea1i th\u1eddi \u0111i\u1ec3m runtime.</li> </ul> <p>\ud83d\udccc T\u1ea5t c\u1ea3 h\u00e0nh vi li\u00ean quan \u0111\u1ebfn ph\u00e2n quy\u1ec1n \u0111\u1ec1u \u0111\u01b0\u1ee3c ghi log k\u00e8m trace_id v\u00e0 k\u1ebft qu\u1ea3 ki\u1ec3m tra.</p>"},{"location":"services/api-gateway/interface-contract/#2-api","title":"2. \ud83d\udccc API","text":"<p>API Gateway kh\u00f4ng cung c\u1ea5p c\u00e1c endpoint nghi\u1ec7p v\u1ee5 c\u1ed1 \u0111\u1ecbnh nh\u01b0 c\u00e1c service kh\u00e1c. Thay v\u00e0o \u0111\u00f3, n\u00f3 s\u1eed d\u1ee5ng c\u01a1 ch\u1ebf \u0111\u1ecbnh tuy\u1ebfn \u0111\u1ed9ng (dynamic routing) \u0111\u1ec3 chuy\u1ec3n ti\u1ebfp m\u1ecdi request t\u1eeb client \u0111\u1ebfn c\u00e1c backend service, d\u1ef1a tr\u00ean route configuration \u0111\u01b0\u1ee3c n\u1ea1p t\u1eeb file JSON ho\u1eb7c service discovery.</p>"},{"location":"services/api-gateway/interface-contract/#21-cach-hoat-ong","title":"2.1. \u2705 C\u00e1ch ho\u1ea1t \u0111\u1ed9ng","text":"<p>Khi client g\u1eedi m\u1ed9t request \u0111\u1ebfn m\u1ed9t path c\u1ee5 th\u1ec3 (v\u00ed d\u1ee5 <code>/users/{id}</code> ho\u1eb7c <code>/auth/login</code>), Gateway s\u1ebd:</p> <ol> <li>\u00c1nh x\u1ea1 path v\u00e0 method v\u1edbi c\u1ea5u h\u00ecnh \u0111\u1ecbnh tuy\u1ebfn (route config).</li> <li>X\u00e1c th\u1ef1c token JWT (n\u1ebfu kh\u00f4ng ph\u1ea3i route <code>public</code>).</li> <li>Ki\u1ec3m tra permission t\u1eeb cache RBAC ho\u1eb7c g\u1ecdi <code>user-sub</code>.</li> <li>\u0110\u00e1nh gi\u00e1 \u0111i\u1ec1u ki\u1ec7n <code>x-condition</code> (n\u1ebfu \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a).</li> <li>Chuy\u1ec3n ti\u1ebfp (proxy) request \u0111\u1ebfn backend t\u01b0\u01a1ng \u1ee9ng.</li> <li>Ghi log + trace + metrics t\u1ea1i m\u1ecdi b\u01b0\u1edbc.</li> <li>Tr\u1ea3 v\u1ec1 k\u1ebft qu\u1ea3 ho\u1eb7c l\u1ed7i \u0111\u00e3 chu\u1ea9n h\u00f3a theo ADR-011/ADR-012.</li> </ol>"},{"location":"services/api-gateway/interface-contract/#22-endpoint-duy-nhat","title":"2.2. \ud83c\udf10 Endpoint duy nh\u1ea5t","text":"<ul> <li>Gateway ch\u1ec9 expose m\u1ed9t endpoint duy nh\u1ea5t x\u1eed l\u00fd m\u1ecdi lo\u1ea1i path v\u00e0 method:</li> </ul> <pre><code>ANY /&lt;path&gt;\n</code></pre> <p>V\u00ed d\u1ee5:</p> <ul> <li><code>GET /users</code> \u2192 proxy t\u1edbi <code>user-service.master</code></li> <li><code>POST /auth/login</code> \u2192 proxy t\u1edbi <code>auth-service.master</code></li> <li><code>GET /reports/summary</code> \u2192 proxy t\u1edbi <code>report-service.master</code></li> </ul> <p>M\u1ecdi \u0111\u1ecbnh tuy\u1ebfn, permission v\u00e0 backend mapping \u0111\u01b0\u1ee3c \u0111i\u1ec1u khi\u1ec3n b\u1edfi file <code>route_config.json</code>.</p> <p>\ud83d\udd0d Chi ti\u1ebft t\u1eebng lu\u1ed3ng \u0111\u1ecbnh tuy\u1ebfn v\u00e0 \u0111i\u1ec1u ki\u1ec7n \u0111\u01b0\u1ee3c m\u00f4 t\u1ea3 trong m\u1ee5c ti\u1ebfp theo.</p>"},{"location":"services/api-gateway/interface-contract/#23-luong-xu-ly-inh-tuyen-route-evaluation-flow","title":"2.3. \ud83d\udd01 Lu\u1ed3ng x\u1eed l\u00fd \u0111\u1ecbnh tuy\u1ebfn (Route Evaluation Flow)","text":"<p>Khi m\u1ed9t request \u0111i qua API Gateway, h\u1ec7 th\u1ed1ng s\u1ebd th\u1ef1c hi\u1ec7n m\u1ed9t chu\u1ed7i c\u00e1c b\u01b0\u1edbc ki\u1ec3m tra v\u00e0 \u0111\u1ecbnh tuy\u1ebfn theo c\u1ea5u h\u00ecnh \u0111\u1ed9ng. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 lu\u1ed3ng x\u1eed l\u00fd chu\u1ea9n ho\u00e1 cho m\u1ecdi request:</p>"},{"location":"services/api-gateway/interface-contract/#cac-buoc-xu-ly","title":"\ud83e\udded C\u00e1c b\u01b0\u1edbc x\u1eed l\u00fd","text":"<ol> <li>Nh\u1eadn request</li> <li>Gateway ti\u1ebfp nh\u1eadn request t\u1eeb client t\u1ea1i path b\u1ea5t k\u1ef3.</li> <li> <p>Header <code>Authorization</code> v\u00e0 <code>x-trace-id</code> \u0111\u01b0\u1ee3c ghi nh\u1eadn (ho\u1eb7c sinh m\u1edbi n\u1ebfu thi\u1ebfu).</p> </li> <li> <p>T\u00ecm route t\u01b0\u01a1ng \u1ee9ng</p> </li> <li>D\u1ef1a tr\u00ean <code>path + method</code>, Gateway truy v\u1ea5n route t\u1eeb <code>route_config.json</code>.</li> <li> <p>N\u1ebfu kh\u00f4ng t\u00ecm th\u1ea5y c\u1ea5u h\u00ecnh ph\u00f9 h\u1ee3p \u2192 tr\u1ea3 l\u1ed7i <code>404 Not Found</code>.</p> </li> <li> <p>X\u00e1c th\u1ef1c JWT</p> </li> <li> <p>N\u1ebfu route kh\u00f4ng \u0111\u00e1nh d\u1ea5u l\u00e0 <code>public</code>, Gateway s\u1ebd x\u00e1c th\u1ef1c JWT:</p> <ul> <li>Check ch\u1eef k\u00fd b\u1eb1ng JWKS t\u1eeb <code>token-service</code></li> <li>Check token \u0111\u00e3 b\u1ecb thu h\u1ed3i qua Redis key <code>revoked:{jti}</code></li> <li>N\u1ebfu JWT h\u1ee3p l\u1ec7, Gateway tr\u00edch xu\u1ea5t c\u00e1c tr\u01b0\u1eddng quan tr\u1ecdng nh\u01b0 <code>sub</code>, <code>tenant</code>, v\u00e0 <code>login_method</code> \u0111\u1ec3 forward cho backend.</li> <li>N\u1ebfu kh\u00f4ng c\u00f3 trong cache \u2192 g\u1ecdi <code>/token/introspect</code></li> </ul> </li> <li> <p>Ph\u00e2n quy\u1ec1n RBAC</p> </li> <li>N\u1ebfu route y\u00eau c\u1ea7u permission (<code>x-required-permission</code>) \u2192 truy xu\u1ea5t permission t\u1eeb Redis <code>rbac:{user_id}:{tenant_id}</code>.</li> <li>N\u1ebfu cache miss \u2192 g\u1ecdi <code>user-sub</code> \u0111\u1ec3 resolve r\u1ed3i cache l\u1ea1i.</li> <li> <p>N\u1ebfu permission kh\u00f4ng t\u1ed3n t\u1ea1i \u2192 tr\u1ea3 <code>403 Forbidden</code> v\u1edbi <code>error_type: rbac.permission_denied</code>.</p> </li> <li> <p>\u0110\u00e1nh gi\u00e1 \u0111i\u1ec1u ki\u1ec7n RBAC</p> </li> <li> <p>N\u1ebfu route c\u00f3 <code>x-condition</code>, Gateway s\u1ebd:</p> <ul> <li>Parse \u0111i\u1ec1u ki\u1ec7n d\u1ea1ng JSON (VD: <code>{\"user_id\": \"{{X-User-ID}}\"}</code>)</li> <li>Bind runtime t\u1eeb request headers/path/body</li> <li>So s\u00e1nh \u0111i\u1ec1u ki\u1ec7n \u2192 n\u1ebfu kh\u00f4ng \u0111\u1ea1t \u2192 tr\u1ea3 l\u1ed7i <code>403 Forbidden</code> v\u1edbi <code>error_type: rbac.condition_failed</code>.</li> </ul> </li> <li> <p>G\u1eedi request \u0111\u1ebfn backend</p> </li> <li>Request \u0111\u01b0\u1ee3c proxy t\u1edbi <code>backend_service</code> \u0111\u00e3 \u0111\u1ecbnh ngh\u0129a trong route config.</li> <li> <p>Forward \u0111\u1ea7y \u0111\u1ee7 c\u00e1c headers chu\u1ea9n: <code>X-Trace-ID</code>, <code>X-User-ID</code>, <code>X-Tenant-ID</code>, <code>X-Service</code>, v.v.</p> </li> <li> <p>X\u1eed l\u00fd ph\u1ea3n h\u1ed3i</p> </li> <li>N\u1ebfu backend tr\u1ea3 l\u1ed7i kh\u00f4ng theo chu\u1ea9n ADR-011 \u2192 Gateway t\u1ef1 \u0111\u1ed9ng map l\u1ed7i l\u1ea1i \u0111\u00fang format.</li> <li> <p>M\u1ecdi response (k\u1ec3 c\u1ea3 l\u1ed7i) \u0111\u1ec1u c\u00f3 <code>meta.trace_id</code>, <code>meta.service</code>, <code>meta.timestamp</code>.</p> </li> <li> <p>Ghi log v\u00e0 metrics</p> </li> <li>Log h\u00e0nh vi RBAC (pass/fail), condition, backend response, duration.</li> <li>T\u0103ng counter Prometheus t\u01b0\u01a1ng \u1ee9ng (vd: <code>api_gateway_permission_denied_total</code>, <code>api_gateway_request_duration_seconds</code>, ...)</li> </ol> <p>\u2705 To\u00e0n b\u1ed9 chu\u1ed7i x\u1eed l\u00fd n\u00e0y \u0111\u1ea3m b\u1ea3o m\u1ecdi request \u0111i qua Gateway \u0111\u01b0\u1ee3c trace, log v\u00e0 enforce chu\u1ea9n ho\u00e1 tuy\u1ec7t \u0111\u1ed1i.</p>"},{"location":"services/api-gateway/interface-contract/#24-chi-tiet-endpoint-all","title":"2.4. \ud83d\udce5 Chi ti\u1ebft endpoint: ALL / <p>\u0110\u00e2y l\u00e0 endpoint duy nh\u1ea5t v\u00e0 m\u1eb7c \u0111\u1ecbnh c\u1ee7a API Gateway. M\u1ecdi request \u0111\u1ebfn b\u1ea5t k\u1ef3 URL n\u00e0o s\u1ebd \u0111\u01b0\u1ee3c x\u1eed l\u00fd v\u00e0 \u0111\u1ecbnh tuy\u1ebfn th\u00f4ng qua endpoint n\u00e0y, d\u1ef1a v\u00e0o file <code>route_config.json</code>.</p>","text":""},{"location":"services/api-gateway/interface-contract/#inh-dang","title":"\ud83e\udde9 \u0110\u1ecbnh d\u1ea1ng","text":"<pre><code>ALL /&lt;path&gt;\n</code></pre> <ul> <li><code>&lt;path&gt;</code>: l\u00e0 \u0111\u01b0\u1eddng d\u1eabn b\u1ea5t k\u1ef3 nh\u01b0 <code>/users</code>, <code>/auth/login</code>, <code>/reports/summary</code>, v.v.</li> <li>Method: H\u1ed7 tr\u1ee3 t\u1ea5t c\u1ea3 c\u00e1c HTTP methods (<code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code>, <code>PATCH</code>, <code>HEAD</code>, <code>OPTIONS</code>)</li> </ul>"},{"location":"services/api-gateway/interface-contract/#yeu-cau-ve-header","title":"\ud83d\udd10 Y\u00eau c\u1ea7u v\u1ec1 Header","text":"Header B\u1eaft bu\u1ed9c Ghi ch\u00fa <code>Authorization</code> C\u00f3 V\u1edbi route kh\u00f4ng ph\u1ea3i <code>public</code>; d\u1ea1ng <code>Bearer &lt;JWT&gt;</code> <code>x-trace-id</code> Kh\u00f4ng N\u1ebfu kh\u00f4ng c\u00f3, Gateway s\u1ebd sinh t\u1ef1 \u0111\u1ed9ng <code>Content-Type</code> C\u00f3 <code>application/json</code> n\u1ebfu c\u00f3 body (auto forward) \u2014 <code>X-User-ID</code>, <code>X-Tenant-ID</code>, <code>X-Service</code>, <code>X-Permissions</code> \u0111\u01b0\u1ee3c Gateway t\u1ef1 th\u00eam <code>X-Login-Method</code> Kh\u00f4ng Forward b\u1edfi Gateway n\u1ebfu c\u00f3, v\u00ed d\u1ee5: <code>otp</code>, <code>oauth2</code>"},{"location":"services/api-gateway/interface-contract/#hanh-vi-xu-ly","title":"\u2699\ufe0f H\u00e0nh vi x\u1eed l\u00fd","text":"<ol> <li>\u00c1nh x\u1ea1 path &amp; method sang c\u1ea5u h\u00ecnh trong <code>route_config.json</code></li> <li>N\u1ebfu kh\u00f4ng c\u00f3 route ph\u00f9 h\u1ee3p \u2192 404 Not Found</li> <li>X\u00e1c th\u1ef1c token JWT n\u1ebfu kh\u00f4ng ph\u1ea3i route <code>public</code></li> <li>Ki\u1ec3m tra revoked token \u2192 fallback <code>token-service/introspect</code> n\u1ebfu c\u1ea7n</li> <li>Ki\u1ec3m tra <code>x-required-permission</code> (n\u1ebfu c\u00f3)</li> <li>\u0110\u00e1nh gi\u00e1 <code>x-condition</code> (n\u1ebfu c\u00f3)</li> <li>Proxy request t\u1edbi backend service</li> <li>Chu\u1ea9n h\u00f3a response l\u1ed7i theo ADR-011 n\u1ebfu backend kh\u00f4ng tu\u00e2n</li> </ol>"},{"location":"services/api-gateway/interface-contract/#vi-du-route-config","title":"\ud83d\udce6 V\u00ed d\u1ee5 route config","text":"<pre><code>{\n  \"/users/**\": {\n    \"method\": [\"GET\", \"POST\"],\n    \"backend\": \"user-service.master\",\n    \"x-required-permission\": \"user.read\",\n    \"x-condition\": {\n      \"tenant_id\": \"{{X-Tenant-ID}}\"\n    },\n    \"timeout\": 3000,\n    \"retry\": 2\n  }\n}\n</code></pre>"},{"location":"services/api-gateway/interface-contract/#response-thanh-cong-200","title":"\ud83d\udce4 Response th\u00e0nh c\u00f4ng (200)","text":"<pre><code>{\n  \"meta\": {\n    \"code\": 200,\n    \"message\": \"SUCCESS\",\n    \"trace_id\": \"abc-123\",\n    \"service\": \"api-gateway\",\n    \"timestamp\": \"2025-06-10T12:34:56Z\"\n  },\n  \"data\": {\n    \"user_id\": \"u001\",\n    \"name\": \"Alice\"\n  }\n}\n</code></pre>"},{"location":"services/api-gateway/interface-contract/#response-loi-chuan-hoa","title":"\u274c Response l\u1ed7i chu\u1ea9n ho\u00e1","text":"<ul> <li>Token b\u1ecb thu h\u1ed3i:</li> </ul> <pre><code>{\n  \"meta\": {\n    \"code\": 401,\n    \"message\": \"UNAUTHORIZED\",\n    \"error_type\": \"auth.token_revoked\",\n    \"trace_id\": \"abc-123\",\n    \"service\": \"api-gateway\",\n    \"timestamp\": \"2025-06-10T12:34:56Z\"\n  },\n  \"error\": {\n    \"reason\": \"Token has been revoked\",\n    \"details\": null\n  }\n}\n</code></pre> <ul> <li>Kh\u00f4ng c\u00f3 quy\u1ec1n truy c\u1eadp:</li> </ul> <pre><code>{\n  \"meta\": {\n    \"code\": 403,\n    \"message\": \"FORBIDDEN\",\n    \"error_type\": \"rbac.permission_denied\",\n    \"trace_id\": \"abc-123\",\n    \"service\": \"api-gateway\",\n    \"timestamp\": \"2025-06-10T12:34:56Z\"\n  },\n  \"error\": {\n    \"reason\": \"Permission denied for route /users\",\n    \"details\": null\n  }\n}\n</code></pre> <ul> <li>Kh\u00f4ng tho\u1ea3 \u0111i\u1ec1u ki\u1ec7n:</li> </ul> <pre><code>{\n  \"meta\": {\n    \"code\": 403,\n    \"message\": \"FORBIDDEN\",\n    \"error_type\": \"rbac.condition_failed\",\n    \"trace_id\": \"abc-123\",\n    \"service\": \"api-gateway\",\n    \"timestamp\": \"2025-06-10T12:34:56Z\"\n  },\n  \"error\": {\n    \"reason\": \"Condition 'user_id == self' not satisfied\",\n    \"details\": null\n  }\n}\n</code></pre>"},{"location":"services/api-gateway/interface-contract/#ghi-chu","title":"\ud83d\udcd8 Ghi ch\u00fa","text":"<ul> <li>Response t\u1eeb backend s\u1ebd gi\u1eef nguy\u00ean n\u1ebfu backend \u0111\u00e3 d\u00f9ng \u0111\u1ecbnh d\u1ea1ng chu\u1ea9n (<code>ADR-012</code>)</li> <li>C\u00e1c l\u1ed7i kh\u00f4ng chu\u1ea9n t\u1eeb backend s\u1ebd \u0111\u01b0\u1ee3c Gateway b\u1ecdc l\u1ea1i \u0111\u00fang format</li> <li>T\u1ea5t c\u1ea3 request \u0111\u1ec1u \u0111\u01b0\u1ee3c log c\u00f9ng <code>trace_id</code>, <code>user_id</code>, <code>tenant_id</code>, <code>permission_checked</code>, v\u00e0 <code>rbac_result</code></li> </ul>"},{"location":"services/api-gateway/interface-contract/#3-phu-luc-mau-cau-hinh-route-route_configjson","title":"3. \ud83d\udccc Ph\u1ee5 l\u1ee5c: M\u1eabu c\u1ea5u h\u00ecnh route (<code>route_config.json</code>)","text":"<p>File <code>route_config.json</code> \u0111\u1ecbnh ngh\u0129a to\u00e0n b\u1ed9 h\u00e0nh vi \u0111\u1ecbnh tuy\u1ebfn v\u00e0 ki\u1ec3m so\u00e1t truy c\u1eadp c\u1ee7a API Gateway. M\u1ed7i entry t\u01b0\u01a1ng \u1ee9ng v\u1edbi m\u1ed9t pattern path v\u00e0 method c\u1ee5 th\u1ec3, cho ph\u00e9p c\u1ea5u h\u00ecnh:</p> <ul> <li>T\u00ean backend service \u0111\u00edch</li> <li>Ph\u01b0\u01a1ng th\u1ee9c HTTP h\u1ed7 tr\u1ee3</li> <li>Quy\u1ec1n y\u00eau c\u1ea7u (RBAC)</li> <li>\u0110i\u1ec1u ki\u1ec7n truy c\u1eadp (<code>x-condition</code>)</li> <li>Th\u00f4ng s\u1ed1 v\u1ec1 timeout, retry</li> <li>T\u00f9y ch\u1ecdn <code>public</code> ho\u1eb7c fallback service</li> </ul>"},{"location":"services/api-gateway/interface-contract/#31-cau-truc-chung-cua-mot-rule","title":"3.1. \ud83e\udde9 C\u1ea5u tr\u00fac chung c\u1ee7a m\u1ed9t rule <pre><code>\"/&lt;pattern&gt;\": {\n  \"method\": [\"GET\", \"POST\", ...],\n  \"backend\": \"&lt;service_name&gt;\",\n  \"x-required-permission\": \"&lt;permission_code&gt;\",\n  \"x-condition\": {\n    \"&lt;field&gt;\": \"{{X-Header}}\" | \"{{PathParam}}\" | \"{{BodyField}}\"\n  },\n  \"timeout\": 3000,\n  \"retry\": 2,\n  \"public\": false,\n  \"fallback_backend\": \"&lt;optional_service&gt;\"\n}\n</code></pre>","text":""},{"location":"services/api-gateway/interface-contract/#32-vi-du-1-route-co-ban-co-kiem-tra-quyen","title":"3.2. \ud83d\udcd8 V\u00ed d\u1ee5 1: Route c\u01a1 b\u1ea3n c\u00f3 ki\u1ec3m tra quy\u1ec1n <pre><code>\"/users/**\": {\n  \"method\": [\"GET\", \"POST\"],\n  \"backend\": \"user-service.master\",\n  \"x-required-permission\": \"user.read\",\n  \"timeout\": 3000,\n  \"retry\": 2\n}\n</code></pre>","text":""},{"location":"services/api-gateway/interface-contract/#33-vi-du-2-route-yeu-cau-xac-minh-ieu-kien-runtime","title":"3.3. \ud83d\udcd8 V\u00ed d\u1ee5 2: Route y\u00eau c\u1ea7u x\u00e1c minh \u0111i\u1ec1u ki\u1ec7n runtime <pre><code>\"/users/{id}\": {\n  \"method\": [\"PATCH\"],\n  \"backend\": \"user-service.master\",\n  \"x-required-permission\": \"user.update\",\n  \"x-condition\": {\n    \"user_id\": \"{{X-User-ID}}\",\n    \"login_method\": \"otp\"\n  }\n}\n</code></pre> <p>\u2705 N\u1ebfu <code>X-User-ID</code> kh\u00e1c v\u1edbi <code>user_id</code> trong request \u2192 tr\u1ea3 l\u1ed7i <code>rbac.condition_failed</code></p>","text":""},{"location":"services/api-gateway/interface-contract/#34-vi-du-3-route-cong-khai-khong-yeu-cau-jwt","title":"3.4. \ud83d\udcd8 V\u00ed d\u1ee5 3: Route c\u00f4ng khai kh\u00f4ng y\u00eau c\u1ea7u JWT <pre><code>\"/auth/login\": {\n  \"method\": [\"POST\"],\n  \"backend\": \"auth-service.master\",\n  \"public\": true\n}\n</code></pre>","text":""},{"location":"services/api-gateway/interface-contract/#35-vi-du-4-route-co-fallback-khi-backend-chinh-bi-loi","title":"3.5. \ud83d\udcd8 V\u00ed d\u1ee5 4: Route c\u00f3 fallback khi backend ch\u00ednh b\u1ecb l\u1ed7i <pre><code>\"/reports/summary\": {\n  \"method\": [\"GET\"],\n  \"backend\": \"report-service.master\",\n  \"fallback_backend\": \"report-service.cache\",\n  \"timeout\": 2000,\n  \"retry\": 1\n}\n</code></pre> <p>N\u1ebfu backend ch\u00ednh kh\u00f4ng ph\u1ea3n h\u1ed3i \u2192 th\u1eed l\u1ea1i v\u1edbi <code>report-service.cache</code></p>","text":""},{"location":"services/api-gateway/interface-contract/#36-nguyen-tac-trien-khai","title":"3.6. \ud83d\udee0\ufe0f Nguy\u00ean t\u1eafc tri\u1ec3n khai <ul> <li>Wildcard <code>**</code> \u0111\u01b0\u1ee3c h\u1ed7 tr\u1ee3 \u0111\u1ec3 \u0111\u1ecbnh ngh\u0129a route t\u1ed5ng qu\u00e1t.</li> <li> <p>C\u00e1c bi\u1ebfn <code>{{...}}</code> trong <code>x-condition</code> s\u1ebd \u0111\u01b0\u1ee3c binding t\u1ef1 \u0111\u1ed9ng t\u1eeb:</p> </li> <li> <p><code>X-Header</code> \u2192 header c\u00f3 t\u00ean t\u01b0\u01a1ng \u1ee9ng</p> </li> <li><code>PathParam</code> \u2192 bi\u1ebfn trong path (VD: <code>/users/{id}</code>)</li> <li><code>BodyField</code> \u2192 tr\u01b0\u1eddng JSON trong body (v\u1edbi <code>Content-Type: application/json</code>)</li> </ul>   <p>\ud83d\udccc File n\u00e0y c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 t\u1eeb GCS, Firestore ho\u1eb7c service discovery v\u00e0 \u0111\u01b0\u1ee3c cache t\u1ea1i Gateway theo TTL m\u1eb7c \u0111\u1ecbnh.</p>","text":""},{"location":"services/api-gateway/interface-contract/#4-bang-permission-lien-quan","title":"4. \ud83d\udcce B\u1ea3ng Permission li\u00ean quan","text":"<p>B\u1ea3ng d\u01b0\u1edbi \u0111\u00e2y t\u1ed5ng h\u1ee3p m\u1ed9t s\u1ed1 permission ph\u1ed5 bi\u1ebfn m\u00e0 API Gateway s\u1eed d\u1ee5ng \u0111\u1ec3 ki\u1ec3m so\u00e1t truy c\u1eadp th\u00f4ng qua tr\u01b0\u1eddng <code>x-required-permission</code> trong <code>route_config.json</code>. C\u00e1c permission n\u00e0y \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a v\u00e0 qu\u1ea3n l\u00fd b\u1edfi User Service Master, sau \u0111\u00f3 \u0111\u1ed3ng b\u1ed9 \u0111\u1ecbnh k\u1ef3 ho\u1eb7c cache t\u1ea1i Gateway.</p>"},{"location":"services/api-gateway/interface-contract/#41-cau-truc-permission","title":"4.1. \ud83d\udccb C\u1ea5u tr\u00fac permission <p>M\u1ed7i permission c\u00f3 d\u1ea1ng <code>resource.action</code>, theo c\u00fa ph\u00e1p: ```</p> <p>&lt;\u0111\u1ed1i t\u01b0\u1ee3ng&gt;.\\ <p>````</p> <p>V\u00ed d\u1ee5: - <code>user.read</code> \u2013 Xem th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng - <code>report.view_summary</code> \u2013 Xem b\u00e1o c\u00e1o t\u1ed5ng h\u1ee3p - <code>user.update.self</code> \u2013 C\u1eadp nh\u1eadt th\u00f4ng tin ch\u00ednh m\u00ecnh (RBAC condition)</p>","text":""},{"location":"services/api-gateway/interface-contract/#42-danh-sach-permission-mau","title":"4.2. \ud83d\udccc Danh s\u00e1ch permission m\u1eabu    <code>permission_code</code> M\u00f4 t\u1ea3 quy\u1ec1n \u00c1p d\u1ee5ng cho route     <code>user.read</code> Xem th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng <code>GET /users/**</code>   <code>user.create</code> T\u1ea1o ng\u01b0\u1eddi d\u00f9ng m\u1edbi <code>POST /users</code>   <code>user.update</code> S\u1eeda th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng <code>PATCH /users/{id}</code>   <code>user.delete</code> Xo\u00e1 ng\u01b0\u1eddi d\u00f9ng <code>DELETE /users/{id}</code>   <code>user.update.self</code> S\u1eeda th\u00f4ng tin c\u1ee7a ch\u00ednh m\u00ecnh <code>PATCH /users/{id}</code> k\u00e8m <code>x-condition</code>   <code>auth.manage</code> Thay \u0111\u1ed5i c\u1ea5u h\u00ecnh x\u00e1c th\u1ef1c <code>/auth/**</code>   <code>report.view_summary</code> Truy v\u1ea5n b\u00e1o c\u00e1o t\u1ed5ng quan <code>GET /reports/summary</code>   <code>report.export_detail</code> T\u1ea3i b\u00e1o c\u00e1o chi ti\u1ebft <code>GET /reports/export</code>","text":""},{"location":"services/api-gateway/interface-contract/#43-rbac-condition-permission","title":"4.3. \ud83d\udd10 RBAC Condition Permission <p>M\u1ed9t s\u1ed1 quy\u1ec1n \u0111\u01b0\u1ee3c khai b\u00e1o k\u00e8m \u0111i\u1ec1u ki\u1ec7n runtime (x-condition). Gateway s\u1ebd enforce c\u00e1c \u0111i\u1ec1u ki\u1ec7n n\u00e0y t\u1ea1i th\u1eddi \u0111i\u1ec3m x\u1eed l\u00fd request.</p> <p>V\u00ed d\u1ee5: ```json \"x-required-permission\": \"user.update.self\", \"x-condition\": {   \"user_id\": \"{{X-User-ID}}\" } ````</p>  <p>N\u1ebfu \u0111i\u1ec1u ki\u1ec7n kh\u00f4ng th\u1ecfa \u2192 Gateway tr\u1ea3 <code>403 Forbidden</code> v\u1edbi <code>error_type: rbac.condition_failed</code></p>","text":""},{"location":"services/api-gateway/interface-contract/#44-quan-ly-cap-nhat","title":"4.4. \ud83d\udcce Qu\u1ea3n l\u00fd &amp; c\u1eadp nh\u1eadt <ul> <li>Gateway kh\u00f4ng t\u1ef1 \u0111\u1ecbnh ngh\u0129a permission</li> <li>T\u1ea5t c\u1ea3 permission \u0111\u01b0\u1ee3c resolve t\u1eeb <code>user-sub</code> th\u00f4ng qua Redis ho\u1eb7c HTTP fallback</li> <li>TTL m\u1eb7c \u0111\u1ecbnh c\u1ee7a cache permission: <code>300s</code></li> <li>C\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c invalidate qua s\u1ef1 ki\u1ec7n <code>rbac.updated</code> (xem chi ti\u1ebft trong thi\u1ebft k\u1ebf <code>design.md</code>)</li> </ul>","text":""},{"location":"services/api-gateway/interface-contract/#5-tai-lieu-lien-ket","title":"5. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean k\u1ebft","text":"<ul> <li>Data Model</li> <li>OpenAPI Spec</li> <li>Design</li> <li><code>adr-011-api-error-format.md</code></li> <li><code>adr-012-response-structure.md</code></li> <li><code>adr-007-rbac.md</code></li> </ul>"},{"location":"services/audit-logging-service/data-model/","title":"\ud83d\uddc3\ufe0f Audit Logging Service - Data Model","text":"<p>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 chi ti\u1ebft m\u00f4 h\u00ecnh d\u1eef li\u1ec7u c\u1ee7a Audit Logging Service \u2013 m\u1ed9t service c\u1ed1t l\u00f5i trong h\u1ec7 th\u1ed1ng <code>dx-vas</code>, ho\u1ea1t \u0111\u1ed9ng theo ki\u1ebfn tr\u00fac event-driven + REST hybrid, \u0111a tenant.</p> <p>Audit Logging Service ch\u1ecbu tr\u00e1ch nhi\u1ec7m qu\u1ea3n l\u00fd c\u00e1c lo\u1ea1i d\u1eef li\u1ec7u ch\u00ednh sau: - B\u1ea3n ghi h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng (<code>audit_logs</code>) - S\u1ef1 ki\u1ec7n \u0111\u00e3 x\u1eed l\u00fd (<code>processed_events</code>) \u2013 ph\u1ee5c v\u1ee5 ki\u1ec3m so\u00e1t idempotency - C\u00e1c b\u1ea3ng ENUM m\u1edf r\u1ed9ng (tr\u1ea1ng th\u00e1i, lo\u1ea1i t\u00e0i nguy\u00ean, v.v.)</p>"},{"location":"services/audit-logging-service/data-model/#1-pham-vi-du-lieu-quan-ly-scope","title":"1. Ph\u1ea1m vi D\u1eef li\u1ec7u Qu\u1ea3n l\u00fd (Scope)","text":"<p>Audit Logging Service bao g\u1ed3m vi\u1ec7c qu\u1ea3n l\u00fd: - B\u1ea3n ghi h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng ho\u1eb7c h\u1ec7 th\u1ed1ng t\u1eeb c\u00e1c ngu\u1ed3n event ho\u1eb7c HTTP n\u1ed9i b\u1ed9 - Metadata li\u00ean quan nh\u01b0 <code>trace_id</code>, <code>actor_user_id</code>, <code>resource_type</code>, <code>action</code>, <code>input_parameters</code> - C\u00e1c b\u1ea3ng ph\u1ee5 \u0111\u1ec3 h\u1ed7 tr\u1ee3 l\u01b0u d\u1ea5u <code>event_id</code> \u0111\u00e3 x\u1eed l\u00fd (Pub/Sub) - Masking d\u1eef li\u1ec7u \u0111\u1ea7u v\u00e0o theo quy\u1ec1n h\u1ea1n</p>"},{"location":"services/audit-logging-service/data-model/#2-ngoai-pham-vi-out-of-scope","title":"2. Ngo\u00e0i Ph\u1ea1m Vi (Out of Scope)","text":"<p>Audit Logging Service kh\u00f4ng ch\u1ecbu tr\u00e1ch nhi\u1ec7m qu\u1ea3n l\u00fd: - \u274c Log h\u1ec7 th\u1ed1ng \u1ee9ng d\u1ee5ng (debug/error logs) - \u274c Qu\u1ea3n l\u00fd ng\u01b0\u1eddi d\u00f9ng, vai tr\u00f2 (user/role/permission) - \u274c Tr\u1ef1c ti\u1ebfp alerting (ch\u1ec9 ph\u1ee5c v\u1ee5 observability downstream) - \u274c Ph\u00e2n t\u00edch d\u1eef li\u1ec7u (do h\u1ec7 th\u1ed1ng downstream x\u1eed l\u00fd)</p>"},{"location":"services/audit-logging-service/data-model/#3-muc-tieu-cua-tai-lieu-mo-hinh-du-lieu","title":"3. M\u1ee5c ti\u00eau c\u1ee7a T\u00e0i li\u1ec7u M\u00f4 h\u00ecnh D\u1eef li\u1ec7u","text":"<ul> <li>Tr\u00ecnh b\u00e0y c\u1ea5u tr\u00fac c\u00e1c b\u1ea3ng d\u1eef li\u1ec7u c\u1ed1t l\u00f5i (<code>audit_logs</code>, <code>processed_events</code>)</li> <li>M\u00f4 t\u1ea3 kh\u00f3a ch\u00ednh/ph\u1ee5, ch\u1ec9 m\u1ee5c, ENUM</li> <li>Tu\u00e2n th\u1ee7 c\u00e1c nguy\u00ean t\u1eafc v\u00e0 r\u00e0ng bu\u1ed9c \u0111\u00e3 \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong c\u00e1c ADR li\u00ean quan:</li> <li>RBAC: ADR-007</li> <li>Retention &amp; anonymization: ADR-024</li> <li>Ch\u00ednh s\u00e1ch kh\u00f4ng x\u00f3a v\u1eadt l\u00fd: ADR-026</li> <li>Qu\u1ea3n l\u00fd schema s\u1ef1 ki\u1ec7n: ADR-030</li> <li>Cung c\u1ea5p c\u01a1 s\u1edf d\u1eef li\u1ec7u cho vi\u1ec7c thi\u1ebft k\u1ebf OpenAPI, c\u1ea5u h\u00ecnh migration, auditing, observability, v\u00e0 tracing</li> <li>Ph\u1ee5c v\u1ee5 ki\u1ec3m th\u1eed d\u1eef li\u1ec7u v\u00e0 tracing</li> </ul>"},{"location":"services/audit-logging-service/data-model/#4-so-o-erd","title":"4. S\u01a1 \u0111\u1ed3 ERD","text":""},{"location":"services/audit-logging-service/data-model/#41-so-o-tong-the","title":"4.1. S\u01a1 \u0111\u1ed3 t\u1ed5ng th\u1ec3","text":"<pre><code>erDiagram\n  audit_logs {\n    UUID id PK\n    TEXT tenant_id\n    TEXT trace_id\n    TEXT actor_user_id\n    TEXT action\n    TEXT source_service\n    TEXT resource_id\n    TEXT resource_type\n    TEXT status\n    JSONB input_parameters\n    TEXT ip_address\n    TEXT user_agent\n    TIMESTAMPTZ created_at\n  }\n\n  processed_events {\n    UUID event_id PK\n    TEXT consumer_group_name\n    TIMESTAMPTZ processed_at\n  }\n</code></pre>"},{"location":"services/audit-logging-service/data-model/#42-ghi-chu-mo-hinh","title":"4.2. Ghi ch\u00fa m\u00f4 h\u00ecnh","text":""},{"location":"services/audit-logging-service/data-model/#audit_logs","title":"\ud83d\udd39 <code>audit_logs</code>","text":"<ul> <li>L\u00e0 b\u1ea3ng ch\u00ednh c\u1ee7a h\u1ec7 th\u1ed1ng, ch\u1ee9a to\u00e0n b\u1ed9 b\u1ea3n ghi h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng v\u00e0 h\u1ec7 th\u1ed1ng.</li> <li> <p>D\u1eef li\u1ec7u \u0111\u01b0\u1ee3c ghi nh\u1eadn qua hai ngu\u1ed3n:</p> </li> <li> <p>API n\u1ed9i b\u1ed9 (<code>POST /audit-log</code>)</p> </li> <li>Consumer Pub/Sub (<code>audit.events.v1</code>)</li> <li>D\u1eef li\u1ec7u \u0111\u01b0\u1ee3c partition theo <code>created_at</code>, ph\u1ee5c v\u1ee5 m\u1ee5c \u0111\u00edch retention (xem ADR-024).</li> <li>Tr\u01b0\u1eddng <code>input_parameters</code>, <code>ip_address</code>, <code>user_agent</code> c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c mask \u0111\u1ed9ng theo role.</li> </ul>"},{"location":"services/audit-logging-service/data-model/#processed_events","title":"\ud83d\udd39 <code>processed_events</code>","text":"<ul> <li>D\u00f9ng \u0111\u1ec3 ghi nh\u1eadn c\u00e1c s\u1ef1 ki\u1ec7n \u0111\u00e3 x\u1eed l\u00fd t\u1eeb Pub/Sub, gi\u00fap \u0111\u1ea3m b\u1ea3o idempotency v\u00e0 tr\u00e1nh ghi log tr\u00f9ng.</li> <li><code>event_id</code> l\u00e0 UUID duy nh\u1ea5t ph\u00e1t sinh b\u1edfi producer, l\u1ea5y t\u1eeb metadata c\u1ee7a event schema (tu\u00e2n theo ADR-030).</li> <li><code>consumer_group_name</code> l\u00e0 t\u00ean nh\u00f3m consumer \u0111\u1ecbnh danh cho t\u1eebng instance ho\u1eb7c m\u00f4i tr\u01b0\u1eddng.</li> <li>Kh\u00f4ng c\u00f3 quan h\u1ec7 kh\u00f3a ngo\u1ea1i v\u1eadt l\u00fd \u0111\u1ebfn <code>audit_logs</code> do m\u1ed7i event c\u00f3 th\u1ec3 ghi nhi\u1ec1u log ho\u1eb7c kh\u00f4ng ghi g\u00ec (b\u1ecb reject do validate schema sai).</li> </ul>"},{"location":"services/audit-logging-service/data-model/#43-tuong-quan-thuc-te-voi-he-thong","title":"4.3. T\u01b0\u01a1ng quan th\u1ef1c t\u1ebf v\u1edbi h\u1ec7 th\u1ed1ng","text":"Th\u00e0nh ph\u1ea7n Vai tr\u00f2 li\u00ean quan \u0111\u1ebfn d\u1eef li\u1ec7u API Gateway G\u1eedi log HTTP qua <code>POST /audit-log</code>, t\u1ea1o <code>audit_logs</code> Pub/Sub Consumer Ghi log t\u1eeb event \u2192 <code>audit_logs</code>, \u0111\u1ed3ng th\u1eddi ghi <code>processed_events</code> BigQuery H\u1ec7 qu\u1ea3n tr\u1ecb l\u01b0u tr\u1eef ch\u00ednh, d\u00f9ng cho truy v\u1ea5n v\u00e0 ph\u00e2n t\u00edch Firestore (optional) L\u01b0u log t\u1ea1m th\u1eddi, ph\u1ee5c v\u1ee5 c\u00e1c dashboard nh\u1ecf ho\u1eb7c backup Admin WebApp Truy v\u1ea5n d\u1eef li\u1ec7u t\u1eeb b\u1ea3ng <code>audit_logs</code> qua API Reporting Service \u0110\u1ecdc <code>audit_logs</code> theo <code>trace_id</code> \u0111\u1ec3 sinh b\u00e1o c\u00e1o b\u1ea3o m\u1eadt <p>\ud83d\udccc L\u01b0u \u00fd: N\u1ebfu trong t\u01b0\u01a1ng lai tri\u1ec3n khai t\u00ednh n\u0103ng ph\u00e1t s\u1ef1 ki\u1ec7n th\u1ee9 c\u1ea5p (<code>vas.audit.persisted.v1</code>), log ID t\u1eeb <code>audit_logs</code> s\u1ebd l\u00e0 th\u00e0nh ph\u1ea7n ch\u00ednh c\u1ee7a payload, nh\u01b0ng kh\u00f4ng t\u1ea1o r\u00e0ng bu\u1ed9c kh\u00f3a ngo\u1ea1i v\u1eadt l\u00fd.</p>"},{"location":"services/audit-logging-service/data-model/#5-chi-tiet-tung-bang","title":"5. Chi ti\u1ebft T\u1eebng B\u1ea3ng","text":""},{"location":"services/audit-logging-service/data-model/#51-bang-audit_logs","title":"5.1. \ud83d\udccc B\u1ea3ng: <code>audit_logs</code>","text":""},{"location":"services/audit-logging-service/data-model/#muc-ich","title":"\ud83e\uddfe M\u1ee5c \u0111\u00edch","text":"<p>L\u01b0u tr\u1eef c\u00e1c h\u00e0nh vi (audit log) ph\u00e1t sinh t\u1eeb ng\u01b0\u1eddi d\u00f9ng ho\u1eb7c h\u1ec7 th\u1ed1ng nh\u1eb1m ph\u1ee5c v\u1ee5 c\u00e1c m\u1ee5c ti\u00eau:</p> <ul> <li>Truy v\u1ebft ho\u1ea1t \u0111\u1ed9ng ng\u01b0\u1eddi d\u00f9ng &amp; h\u1ec7 th\u1ed1ng</li> <li>Ph\u1ee5c v\u1ee5 ki\u1ec3m to\u00e1n n\u1ed9i b\u1ed9 v\u00e0 b\u00ean ngo\u00e0i</li> <li>K\u1ebft n\u1ed1i v\u1edbi b\u00e1o c\u00e1o b\u1ea3o m\u1eadt, c\u1ea3nh b\u00e1o h\u00e0nh vi b\u1ea5t th\u01b0\u1eddng</li> <li>H\u1ed7 tr\u1ee3 h\u1ec7 th\u1ed1ng quan s\u00e1t (observability), th\u1ed1ng k\u00ea v\u00e0 AI ph\u00e2n t\u00edch</li> </ul> <p>B\u1ea3ng n\u00e0y l\u00e0 trung t\u00e2m c\u1ee7a Audit Logging Service, ti\u1ebfp nh\u1eadn d\u1eef li\u1ec7u t\u1eeb 2 ngu\u1ed3n:</p> <ul> <li>HTTP API (<code>POST /audit-log</code>)</li> <li>Consumer Pub/Sub (<code>audit.events.v1</code>)</li> </ul>"},{"location":"services/audit-logging-service/data-model/#cau-truc-sql","title":"\ud83e\uddec C\u1ea5u tr\u00fac SQL","text":"<pre><code>CREATE TABLE audit_logs (\n    id UUID PRIMARY KEY,\n    tenant_id TEXT NOT NULL,\n    trace_id TEXT,\n    actor_user_id TEXT,\n    action TEXT NOT NULL,\n    source_service TEXT NOT NULL,\n    resource_id TEXT,\n    resource_type TEXT NOT NULL,\n    status TEXT CHECK (status IN ('success', 'failure', 'warning')) NOT NULL,\n    input_parameters JSONB,\n    ip_address TEXT,\n    user_agent TEXT,\n    created_at TIMESTAMPTZ DEFAULT now() NOT NULL\n);\n</code></pre>"},{"location":"services/audit-logging-service/data-model/#giai-thich-cac-cot","title":"\ud83d\udccb Gi\u1ea3i th\u00edch c\u00e1c c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u R\u00e0ng bu\u1ed9c M\u00f4 t\u1ea3 <code>id</code> UUID PRIMARY KEY M\u00e3 \u0111\u1ecbnh danh duy nh\u1ea5t cho b\u1ea3n ghi log <code>tenant_id</code> TEXT NOT NULL Tenant t\u1ea1o ra h\u00e0nh vi (RBAC \u0111\u01b0\u1ee3c ki\u1ec3m theo tr\u01b0\u1eddng n\u00e0y) <code>trace_id</code> TEXT ID truy v\u1ebft to\u00e0n h\u1ec7 th\u1ed1ng (c\u00f3 th\u1ec3 tr\u00f9ng gi\u1eefa nhi\u1ec1u log) <code>actor_user_id</code> TEXT User ID g\u00e2y ra h\u00e0nh vi (n\u1ebfu c\u00f3) <code>action</code> TEXT NOT NULL M\u00e3 h\u00e0nh \u0111\u1ed9ng (e.g. <code>user.login.success</code>) <code>source_service</code> TEXT NOT NULL T\u00ean service ph\u00e1t sinh h\u00e0nh \u0111\u1ed9ng (e.g. <code>user-service</code>, <code>auth-service</code>) <code>resource_id</code> TEXT ID \u0111\u1ed1i t\u01b0\u1ee3ng b\u1ecb t\u00e1c \u0111\u1ed9ng (e.g. <code>u_123</code>, <code>t_123</code>) <code>resource_type</code> TEXT NOT NULL Lo\u1ea1i \u0111\u1ed1i t\u01b0\u1ee3ng b\u1ecb t\u00e1c \u0111\u1ed9ng (e.g. <code>user</code>, <code>tenant</code>) <code>status</code> TEXT CHECK ENUM Tr\u1ea1ng th\u00e1i k\u1ebft qu\u1ea3 (<code>success</code>, <code>failure</code>, <code>warning</code>) <code>input_parameters</code> JSONB Payload ban \u0111\u1ea7u, c\u00f3 th\u1ec3 b\u1ecb mask theo role <code>ip_address</code> TEXT IP c\u1ee7a actor (n\u1ebfu c\u00f3) <code>user_agent</code> TEXT User Agent c\u1ee7a actor <code>created_at</code> TIMESTAMPTZ DEFAULT now() Th\u1eddi \u0111i\u1ec3m ghi nh\u1eadn h\u00e0nh vi"},{"location":"services/audit-logging-service/data-model/#masking-ong-theo-quyen-truy-cap","title":"\ud83d\udd10 Masking \u0111\u1ed9ng theo quy\u1ec1n truy c\u1eadp","text":"<p>C\u00e1c tr\u01b0\u1eddng sau c\u00f3 th\u1ec3 b\u1ecb \u1ea9n \u0111i t\u00f9y theo vai tr\u00f2 ng\u01b0\u1eddi xem (<code>RBAC + masking</code>):</p> <ul> <li><code>input_parameters</code></li> <li><code>ip_address</code></li> <li><code>user_agent</code></li> </ul> <p>Chi ti\u1ebft v\u1ec1 masking \u0111\u01b0\u1ee3c m\u00f4 t\u1ea3 trong <code>design.md &gt; #6 B\u1ea3o m\u1eadt</code>.</p>"},{"location":"services/audit-logging-service/data-model/#luong-du-lieu-ghi-log","title":"\ud83d\udd01 Lu\u1ed3ng d\u1eef li\u1ec7u ghi log","text":"<pre><code>HTTP /audit-log\n      \u2514\u2500\u2500&gt; Validate + Mask\n            \u2514\u2500\u2500&gt; INSERT INTO audit_logs\n\nPub/Sub Consumer\n      \u2514\u2500\u2500&gt; Validate + Mask\n            \u2514\u2500\u2500&gt; INSERT INTO audit_logs\n</code></pre>"},{"location":"services/audit-logging-service/data-model/#goi-y-kiem-thu","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"T\u00ecnh hu\u1ed1ng K\u1ebft qu\u1ea3 mong \u0111\u1ee3i Ghi log t\u1eeb HTTP Log l\u01b0u \u0111\u00fang tenant, \u0111\u00fang actor Ghi log t\u1eeb Pub/Sub C\u00f3 b\u1ea3n ghi log, status h\u1ee3p l\u1ec7 User kh\u00f4ng c\u00f3 quy\u1ec1n cao \u2192 xem log b\u1ecb mask <code>input_parameters</code> tr\u1ea3 v\u1ec1 <code>\"masked\"</code> D\u1eef li\u1ec7u thi\u1ebfu field b\u1eaft bu\u1ed9c B\u1ecb reject tr\u01b0\u1edbc khi insert Ghi log nhi\u1ec1u tenant kh\u00e1c nhau Partition \u0111\u00fang <code>tenant_id</code>, truy v\u1ea5n t\u00e1ch bi\u1ec7t Truy v\u1ea5n <code>trace_id</code> \u2192 nhi\u1ec1u log li\u00ean quan OK, h\u1ed7 tr\u1ee3 truy xu\u1ea5t trace full flow"},{"location":"services/audit-logging-service/data-model/#ghi-chu-ac-biet","title":"\ud83e\udde0 Ghi ch\u00fa \u0111\u1eb7c bi\u1ec7t","text":"<ul> <li>Kh\u00f4ng n\u00ean \u0111\u1eb7t FK t\u1edbi <code>users</code>, <code>tenants</code>, <code>roles</code> \u2192 tr\u00e1nh coupling schema ch\u1eb7t.</li> <li>N\u00ean c\u00f3 policy partition theo <code>created_at</code> (BigQuery / Postgres partition by time).</li> <li>C\u00f3 th\u1ec3 th\u00eam c\u1ed9t <code>source</code> n\u1ebfu c\u1ea7n ph\u00e2n bi\u1ec7t log t\u1eeb <code>http</code>, <code>pubsub</code>, <code>batch</code>, v.v.</li> </ul>"},{"location":"services/audit-logging-service/data-model/#e-xuat-index","title":"\ud83d\udcca \u0110\u1ec1 xu\u1ea5t Index","text":"<pre><code>CREATE INDEX idx_audit_logs_trace_id ON audit_logs(trace_id);\nCREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);\nCREATE INDEX idx_audit_logs_actor ON audit_logs(actor_user_id);\n</code></pre> <p>\ud83d\udccc \u0110\u00e2y l\u00e0 b\u1ea3ng duy nh\u1ea5t \u0111\u01b0\u1ee3c expose qua <code>GET /audit-log</code>, <code>GET /audit-log/{id}</code> trong OpenAPI.</p>"},{"location":"services/audit-logging-service/data-model/#52-bang-processed_events","title":"5.2. \ud83d\udccc B\u1ea3ng: <code>processed_events</code>","text":""},{"location":"services/audit-logging-service/data-model/#muc-ich_1","title":"\ud83e\uddfe M\u1ee5c \u0111\u00edch","text":"<p>Ghi nh\u1eadn danh s\u00e1ch c\u00e1c s\u1ef1 ki\u1ec7n \u0111\u00e3 x\u1eed l\u00fd t\u1eeb Pub/Sub nh\u1eb1m:</p> <ul> <li>\u0110\u1ea3m b\u1ea3o idempotency: m\u1ed9t s\u1ef1 ki\u1ec7n ch\u1ec9 \u0111\u01b0\u1ee3c x\u1eed l\u00fd \u0111\u00fang m\u1ed9t l\u1ea7n.</li> <li>Gi\u00fap debug lu\u1ed3ng x\u1eed l\u00fd event: bi\u1ebft event n\u00e0o \u0111\u00e3 \u0111\u01b0\u1ee3c x\u1eed l\u00fd, event n\u00e0o ch\u01b0a.</li> <li>Ph\u1ee5c v\u1ee5 audit n\u1ed9i b\u1ed9 v\u00e0 ph\u00e2n t\u00edch downtime/retry khi c\u1ea7n.</li> </ul>"},{"location":"services/audit-logging-service/data-model/#cau-truc","title":"\ud83e\uddec C\u1ea5u tr\u00fac","text":"<pre><code>CREATE TABLE processed_events (\n    event_id UUID PRIMARY KEY,\n    consumer_group_name TEXT NOT NULL,\n    processed_at TIMESTAMPTZ DEFAULT now() NOT NULL\n);\n</code></pre>"},{"location":"services/audit-logging-service/data-model/#mo-ta-cac-cot","title":"\ud83e\uddfe M\u00f4 t\u1ea3 c\u00e1c c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u R\u00e0ng bu\u1ed9c M\u00f4 t\u1ea3 <code>event_id</code> UUID PRIMARY KEY ID s\u1ef1 ki\u1ec7n nh\u1eadn t\u1eeb metadata (<code>event_metadata.event_id</code>) <code>consumer_group_name</code> TEXT NOT NULL T\u00ean consumer (theo service + env) gi\u00fap ph\u00e2n bi\u1ec7t source <code>processed_at</code> TIMESTAMPTZ DEFAULT now() Th\u1eddi \u0111i\u1ec3m ALS x\u1eed l\u00fd th\u00e0nh c\u00f4ng s\u1ef1 ki\u1ec7n (ghi log ho\u1eb7c b\u1ecf qua c\u00f3 l\u00fd do)"},{"location":"services/audit-logging-service/data-model/#chinh-sach-bao-mat-xoa","title":"\ud83d\udd10 Ch\u00ednh s\u00e1ch b\u1ea3o m\u1eadt &amp; x\u00f3a","text":"<ul> <li>B\u1ea3ng ch\u1ec9 ghi \u2013 kh\u00f4ng c\u00f3 API public, kh\u00f4ng expose qua REST.</li> <li>Truy c\u1eadp ch\u1ec9 d\u00e0nh cho internal operator ho\u1eb7c background task.</li> <li>D\u1eef li\u1ec7u c\u00f3 th\u1ec3 b\u1ecb xo\u00e1 theo retention 90 ng\u00e0y, ho\u1eb7c xo\u00e1 th\u1ee7 c\u00f4ng n\u1ebfu <code>event_id</code> kh\u00f4ng c\u00f2n d\u00f9ng \u0111\u1ec3 \u0111\u1ed1i chi\u1ebfu trace.</li> </ul>"},{"location":"services/audit-logging-service/data-model/#luong-hoat-ong","title":"\ud83d\udd01 Lu\u1ed3ng ho\u1ea1t \u0111\u1ed9ng","text":"<pre><code>Pub/Sub \u2192 Consumer \u2192 Validate \u2192 Ghi log v\u00e0o `audit_logs` \u2192 Ghi event_id v\u00e0o `processed_events`\n</code></pre>"},{"location":"services/audit-logging-service/data-model/#goi-y-kiem-thu_1","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"T\u00ecnh hu\u1ed1ng K\u1ebft qu\u1ea3 mong \u0111\u1ee3i Consumer x\u1eed l\u00fd event h\u1ee3p l\u1ec7 C\u00f3 b\u1ea3n ghi <code>event_id</code> trong b\u1ea3ng Consumer x\u1eed l\u00fd l\u1ea1i c\u00f9ng <code>event_id</code> (duplicate) B\u1ecb b\u1ecf qua \u2013 idempotent, kh\u00f4ng x\u1eed l\u00fd l\u1ea1i G\u1eedi s\u1ef1 ki\u1ec7n gi\u1ea3 <code>event_id</code> nh\u01b0ng schema sai Kh\u00f4ng t\u1ea1o <code>processed_events</code>, log l\u1ed7i n\u1ed9i b\u1ed9 B\u1ea3ng kh\u00f4ng c\u00f3 index Truy v\u1ea5n ch\u1eadm \u2013 n\u00ean c\u00f3 index \u1edf <code>processed_at</code> (n\u1ebfu ph\u00e2n t\u00edch theo th\u1eddi gian)"},{"location":"services/audit-logging-service/data-model/#e-xuat-index_1","title":"\u2699\ufe0f \u0110\u1ec1 xu\u1ea5t Index","text":"<pre><code>CREATE INDEX idx_processed_events_time ON processed_events(processed_at DESC);\n</code></pre>"},{"location":"services/audit-logging-service/data-model/#ghi-chu-ac-biet_1","title":"\ud83d\udcce Ghi ch\u00fa \u0111\u1eb7c bi\u1ec7t","text":"<ul> <li> <p>Kh\u00f4ng c\u00f3 quan h\u1ec7 FK v\u1edbi <code>audit_logs</code> v\u00ec m\u1ed9t s\u1ef1 ki\u1ec7n c\u00f3 th\u1ec3:</p> </li> <li> <p>Kh\u00f4ng t\u1ea1o log (do b\u1ecb reject ho\u1eb7c ch\u1ec9 ping)</p> </li> <li>T\u1ea1o nhi\u1ec1u log c\u00f9ng l\u00fac (vd: batch import)</li> <li>Ph\u1ea7n <code>consumer_group_name</code> n\u00ean chu\u1ea9n h\u00f3a theo format:</li> </ul> <pre><code>als-sub.&lt;env&gt;.&lt;region&gt;\n</code></pre> <p>V\u00ed d\u1ee5: <code>als-sub.prod.ap-southeast1</code></p>"},{"location":"services/audit-logging-service/data-model/#6-indexes-constraints","title":"6. Indexes &amp; Constraints","text":"<p>C\u00e1c ch\u1ec9 m\u1ee5c (indexes) v\u00e0 r\u00e0ng bu\u1ed9c (constraints) \u0111\u00f3ng vai tr\u00f2 then ch\u1ed1t trong vi\u1ec7c \u0111\u1ea3m b\u1ea3o:</p> <ul> <li>T\u1ed1c \u0111\u1ed9 truy v\u1ea5n nhanh ch\u00f3ng theo nhi\u1ec1u chi\u1ec1u (<code>trace_id</code>, <code>actor_user_id</code>, <code>tenant_id</code>, <code>created_at</code>)</li> <li>T\u00ednh to\u00e0n v\u1eb9n d\u1eef li\u1ec7u</li> <li>H\u1ea1n ch\u1ebf tr\u00f9ng l\u1eb7p ho\u1eb7c sai \u0111\u1ecbnh d\u1ea1ng</li> </ul>"},{"location":"services/audit-logging-service/data-model/#61-bang-audit_logs","title":"6.1. B\u1ea3ng: <code>audit_logs</code>","text":""},{"location":"services/audit-logging-service/data-model/#cac-chi-muc-chinh-indexes","title":"\ud83d\udd0e C\u00e1c ch\u1ec9 m\u1ee5c ch\u00ednh (Indexes)","text":"Index Name C\u1ed9t M\u1ee5c \u0111\u00edch ch\u00ednh <code>idx_audit_logs_trace_id</code> <code>trace_id</code> Truy v\u1ebft theo lu\u1ed3ng t\u01b0\u01a1ng t\u00e1c <code>idx_audit_logs_created_at</code> <code>created_at DESC</code> Truy v\u1ea5n th\u1eddi gian g\u1ea7n nh\u1ea5t (ph\u00e2n trang) <code>idx_audit_logs_actor_user_id</code> <code>actor_user_id</code> Truy xu\u1ea5t log theo ng\u01b0\u1eddi d\u00f9ng c\u1ee5 th\u1ec3 <code>idx_audit_logs_tenant_id</code> <code>tenant_id</code> Ph\u00e2n l\u1eadp d\u1eef li\u1ec7u theo tenant (RBAC filter) <code>idx_audit_logs_action_resource</code> <code>(action, resource_type)</code> Truy v\u1ea5n theo lo\u1ea1i h\u00e0nh vi v\u00e0 \u0111\u1ed1i t\u01b0\u1ee3ng <p>\ud83d\udca1 N\u1ebfu s\u1eed d\u1ee5ng BigQuery: n\u00ean ph\u00e2n v\u00f9ng (<code>partition</code>) theo <code>DATE(created_at)</code> v\u00e0 t\u1ea1o <code>cluster</code> theo <code>tenant_id, trace_id</code>.</p>"},{"location":"services/audit-logging-service/data-model/#rang-buoc-du-lieu-constraints","title":"\ud83d\udee1\ufe0f R\u00e0ng bu\u1ed9c d\u1eef li\u1ec7u (Constraints)","text":"T\u00ean Constraint C\u1ed9t / Ki\u1ec3u \u00dd ngh\u0129a <code>pk_audit_logs</code> <code>id</code> (PK) M\u1ed7i b\u1ea3n ghi log l\u00e0 duy nh\u1ea5t <code>ck_audit_logs_status_enum</code> <code>status</code> Ch\u1ec9 cho ph\u00e9p: <code>success</code>, <code>failure</code>, <code>warning</code> <code>nn_audit_logs_tenant_id</code> <code>tenant_id</code> B\u1eaft bu\u1ed9c c\u00f3 tenant <code>nn_audit_logs_action</code> <code>action</code> B\u1eaft bu\u1ed9c ghi r\u00f5 h\u00e0nh \u0111\u1ed9ng <code>nn_audit_logs_resource_type</code> <code>resource_type</code> B\u1eaft bu\u1ed9c c\u00f3 lo\u1ea1i \u0111\u1ed1i t\u01b0\u1ee3ng li\u00ean quan <code>df_created_at_now</code> <code>created_at</code> M\u1eb7c \u0111\u1ecbnh l\u00e0 <code>now()</code> n\u1ebfu kh\u00f4ng \u0111\u01b0\u1ee3c truy\u1ec1n t\u1eeb producer"},{"location":"services/audit-logging-service/data-model/#62-bang-processed_events","title":"6.2. B\u1ea3ng: <code>processed_events</code>","text":""},{"location":"services/audit-logging-service/data-model/#index","title":"\ud83d\udd0e Index","text":"Index Name C\u1ed9t M\u1ee5c \u0111\u00edch <code>idx_processed_events_time</code> <code>processed_at DESC</code> Truy v\u1ea5n s\u1ef1 ki\u1ec7n m\u1edbi nh\u1ea5t (PK m\u1eb7c \u0111\u1ecbnh) <code>event_id</code> \u0110\u1ea3m b\u1ea3o duy nh\u1ea5t \u2013 h\u1ed7 tr\u1ee3 idempotency"},{"location":"services/audit-logging-service/data-model/#rang-buoc","title":"\ud83d\udee1\ufe0f R\u00e0ng bu\u1ed9c","text":"T\u00ean Constraint C\u1ed9t / Ki\u1ec3u \u00dd ngh\u0129a <code>pk_processed_events</code> <code>event_id</code> Ch\u1ed1ng x\u1eed l\u00fd l\u1eb7p t\u1eeb c\u00f9ng 1 s\u1ef1 ki\u1ec7n <code>nn_processed_consumer_group</code> <code>consumer_group_name</code> B\u1eaft bu\u1ed9c ghi r\u00f5 t\u00ean consumer x\u1eed l\u00fd"},{"location":"services/audit-logging-service/data-model/#goi-y-nang-cao","title":"\ud83d\udd27 G\u1ee3i \u00fd n\u00e2ng cao","text":"<ul> <li>\u2705 S\u1eed d\u1ee5ng <code>covering index</code> n\u1ebfu h\u1ec7 th\u1ed1ng h\u1ed7 tr\u1ee3 (e.g. PostgreSQL 12+)</li> <li>\u2705 Trong m\u00f4i tr\u01b0\u1eddng c\u00f3 h\u00e0ng tri\u1ec7u b\u1ea3n ghi m\u1ed7i ng\u00e0y: c\u00e2n nh\u1eafc t\u1ea1o view ph\u00e2n v\u00f9ng theo tenant \u0111\u1ec3 d\u1ec5 audit/debug</li> <li>\u26a0\ufe0f Kh\u00f4ng t\u1ea1o index tr\u00ean <code>input_parameters</code> (JSONB) n\u1ebfu kh\u00f4ng d\u00f9ng truy v\u1ea5n filter ph\u1ee9c t\u1ea1p \u2192 t\u1ed1n chi ph\u00ed</li> </ul> <p>\ud83d\udccc To\u00e0n b\u1ed9 index v\u00e0 constraint \u0111\u1ec1u ph\u1ea3i \u0111\u01b0\u1ee3c m\u00f4 t\u1ea3 r\u00f5 trong migration script, k\u00e8m unit test n\u1ebfu thao t\u00e1c schema ph\u1ee9c t\u1ea1p (tu\u00e2n theo <code>ADR-023 Schema Migration Strategy</code>)</p>"},{"location":"services/audit-logging-service/data-model/#7-chinh-sach-luu-tru-xoa","title":"7. Ch\u00ednh s\u00e1ch L\u01b0u tr\u1eef &amp; X\u00f3a","text":"<p>Ch\u00ednh s\u00e1ch n\u00e0y nh\u1eb1m \u0111\u1ea3m b\u1ea3o d\u1eef li\u1ec7u trong b\u1ea3ng <code>audit_logs</code> v\u00e0 <code>processed_events</code> \u0111\u01b0\u1ee3c l\u01b0u tr\u1eef \u0111\u00fang th\u1eddi gian c\u1ea7n thi\u1ebft, tu\u00e2n th\u1ee7 c\u00e1c ti\u00eau chu\u1ea9n b\u1ea3o m\u1eadt v\u00e0 ph\u00e1p l\u00fd (compliance), \u0111\u1ed3ng th\u1eddi t\u1ed1i \u01b0u chi ph\u00ed v\u1eadn h\u00e0nh.</p>"},{"location":"services/audit-logging-service/data-model/#71-thoi-gian-luu-tru-retention-period","title":"7.1. \u23f3 Th\u1eddi gian l\u01b0u tr\u1eef (Retention Period)","text":"B\u1ea3ng M\u1eb7c \u0111\u1ecbnh Retention Ghi ch\u00fa <code>audit_logs</code> 365 ng\u00e0y D\u1eef li\u1ec7u h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng v\u00e0 h\u1ec7 th\u1ed1ng <code>processed_events</code> 90 ng\u00e0y Ch\u1ec9 d\u00f9ng \u0111\u1ec3 idempotency v\u00e0 tracking k\u1ef9 thu\u1eadt <p>\ud83d\udccc C\u00e1c m\u1ed1c th\u1eddi gian c\u00f3 th\u1ec3 \u0111i\u1ec1u ch\u1ec9nh c\u1ea5u h\u00ecnh theo tenant ho\u1eb7c m\u00f4i tr\u01b0\u1eddng (staging vs production)</p>"},{"location":"services/audit-logging-service/data-model/#72-chien-luoc-xoa-du-lieu-deletion-strategy","title":"7.2. \ud83e\uddf9 Chi\u1ebfn l\u01b0\u1ee3c X\u00f3a D\u1eef li\u1ec7u (Deletion Strategy)","text":"<p>Theo ADR-026, h\u1ec7 th\u1ed1ng kh\u00f4ng s\u1eed d\u1ee5ng hard-delete m\u1eb7c \u0111\u1ecbnh v\u1edbi d\u1eef li\u1ec7u c\u00f3 th\u1ec3 li\u00ean quan \u0111\u1ebfn auditing ho\u1eb7c forensic analysis. Do \u0111\u00f3:</p>"},{"location":"services/audit-logging-service/data-model/#bang-audit_logs","title":"\ud83d\udd38 B\u1ea3ng <code>audit_logs</code>:","text":"<ul> <li>Kh\u00f4ng x\u00f3a b\u1ea3n ghi b\u1eb1ng <code>DELETE</code> v\u1eadt l\u00fd.</li> <li>S\u1eed d\u1ee5ng chi\u1ebfn l\u01b0\u1ee3c partition expiration (BigQuery) ho\u1eb7c batch archival (Firestore/Postgres).</li> <li>Khi \u0111\u1ebfn h\u1ea1n retention:</li> <li>D\u1eef li\u1ec7u c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c:<ul> <li>Chuy\u1ec3n sang BigQuery Cold Storage ho\u1eb7c Data Lake</li> <li>X\u00f3a m\u1ec1m th\u00f4ng qua <code>archived_at</code> timestamp (n\u1ebfu c\u1ea7n)</li> </ul> </li> <li>M\u1ed9t s\u1ed1 tr\u01b0\u1eddng h\u1ee3p tu\u00e2n th\u1ee7 \u0111\u1eb7c bi\u1ec7t (e.g. y\u00eau c\u1ea7u c\u1ee7a ph\u1ee5 huynh/h\u1ecdc sinh theo lu\u1eadt) c\u00f3 th\u1ec3 k\u00edch ho\u1ea1t pipeline data anonymization theo ADR-024.</li> </ul>"},{"location":"services/audit-logging-service/data-model/#bang-processed_events","title":"\ud83d\udd38 B\u1ea3ng <code>processed_events</code>:","text":"<ul> <li>C\u00f3 th\u1ec3 x\u00f3a v\u1eadt l\u00fd ho\u00e0n to\u00e0n sau <code>processed_at + 90 ng\u00e0y</code> v\u00ec kh\u00f4ng \u1ea3nh h\u01b0\u1edfng \u0111\u1ebfn compliance.</li> </ul>"},{"location":"services/audit-logging-service/data-model/#73-chinh-sach-anonymization-an-danh-du-lieu","title":"7.3. \ud83d\udd10 Ch\u00ednh s\u00e1ch Anonymization (\u1ea8n danh d\u1eef li\u1ec7u)","text":"<p>\u00c1p d\u1ee5ng theo ADR-024:</p> <ul> <li>V\u1edbi c\u00e1c field nh\u1ea1y c\u1ea3m trong <code>audit_logs</code>:</li> <li><code>input_parameters</code></li> <li><code>ip_address</code></li> <li><code>user_agent</code></li> </ul> <p>C\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c mask \u0111\u1ed9ng theo vai tr\u00f2 ng\u01b0\u1eddi d\u00f9ng (RBAC) khi truy v\u1ea5n, ho\u1eb7c anonymize to\u00e0n b\u1ed9 sau th\u1eddi gian retention:</p> Ph\u01b0\u01a1ng \u00e1n Khi n\u00e0o \u00e1p d\u1ee5ng C\u01a1 ch\u1ebf th\u1ef1c thi Masking Khi query API Th\u1ef1c hi\u1ec7n trong service layer (<code>design.md &gt; #6</code>) Anonymize Sau 12 th\u00e1ng (config) Batch job ch\u1ea1y h\u1eb1ng tu\u1ea7n x\u00f3a n\u1ed9i dung field <p>\ud83d\udd0e Audit log kh\u00f4ng bao gi\u1edd ghi <code>password</code>, <code>OTP</code>, <code>JWT</code>, ho\u1eb7c c\u00e1c credential nh\u1ea1y c\u1ea3m \u2013 \u0111\u01b0\u1ee3c lo\u1ea1i b\u1ecf ngay t\u1eeb b\u01b0\u1edbc validate \u0111\u1ea7u v\u00e0o.</p>"},{"location":"services/audit-logging-service/data-model/#74-du-lieu-tam-thoi","title":"7.4. \u2708\ufe0f D\u1eef li\u1ec7u t\u1ea1m th\u1eddi","text":"<ul> <li>C\u00e1c d\u1eef li\u1ec7u debug/log c\u00f3 TTL &lt; 7 ng\u00e0y (e.g. draft logs, schema error) \u0111\u01b0\u1ee3c l\u01b0u trong Firestore ho\u1eb7c memory store, v\u00e0 t\u1ef1 x\u00f3a theo TTL.</li> <li>Kh\u00f4ng \u0111i v\u00e0o audit_logs ch\u00ednh.</li> </ul>"},{"location":"services/audit-logging-service/data-model/#75-kiem-thu-quan-sat-retention","title":"7.5. \ud83e\uddea Ki\u1ec3m th\u1eed &amp; Quan s\u00e1t Retention","text":"<ul> <li>Vi\u1ebft job gi\u1ea3 l\u1eadp log \u0111\u00e3 qu\u00e1 h\u1ea1n \u2192 ki\u1ec3m tra c\u00f3 b\u1ecb x\u00f3a ho\u1eb7c anonymize \u0111\u00fang</li> <li>Vi\u1ebft c\u00e2u truy v\u1ea5n validate: <pre><code>  SELECT COUNT(*) FROM audit_logs WHERE created_at &lt; now() - INTERVAL '1 year';\n</code></pre></li> </ul> <p>Log v\u1ec1 h\u00e0nh vi anonymization n\u00ean \u0111\u01b0\u1ee3c ghi l\u1ea1i v\u1edbi action = audit.anonymized</p>"},{"location":"services/audit-logging-service/data-model/#8-phan-quyen-truy-cap-du-lieu","title":"8. Ph\u00e2n quy\u1ec1n Truy c\u1eadp D\u1eef li\u1ec7u","text":"<p>D\u1eef li\u1ec7u trong b\u1ea3ng <code>audit_logs</code> ch\u1ee9a nhi\u1ec1u tr\u01b0\u1eddng nh\u1ea1y c\u1ea3m li\u00ean quan \u0111\u1ebfn h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng, IP truy c\u1eadp, th\u00f4ng tin h\u00e0nh \u0111\u1ed9ng... Do \u0111\u00f3, h\u1ec7 th\u1ed1ng \u00e1p d\u1ee5ng ch\u00ednh s\u00e1ch ph\u00e2n quy\u1ec1n ch\u1eb7t ch\u1ebd theo m\u00f4 h\u00ecnh RBAC \u0111a t\u1ea7ng (xem <code>ADR-007</code>).</p>"},{"location":"services/audit-logging-service/data-model/#81-pham-vi-truy-cap-theo-vai-tro-role-based-access","title":"8.1. Ph\u1ea1m vi truy c\u1eadp theo vai tr\u00f2 (Role-based Access)","text":"Vai tr\u00f2 (<code>role</code>) Truy c\u1eadp log tenant kh\u00e1c Nh\u1eadn d\u1eef li\u1ec7u kh\u00f4ng b\u1ecb mask Truy v\u1ea5n n\u00e2ng cao (<code>trace_id</code>, <code>resource_type</code>) <code>superadmin</code> \u2705 \u2705 \u2705 <code>tenant_admin</code> \u274c \u2705 \u2705 <code>tenant_auditor</code> \u274c \u274c (1) \u2705 <code>teacher</code>, <code>staff</code> \u274c \u274c \u274c (gi\u1edbi h\u1ea1n theo actor_user_id) <p>(1) C\u00e1c role th\u1ea5p h\u01a1n <code>tenant_admin</code> ch\u1ec9 th\u1ea5y c\u00e1c tr\u01b0\u1eddng \u0111\u00e3 \u0111\u01b0\u1ee3c mask \u0111\u1ed9ng (e.g. <code>input_parameters: \"masked\"</code>)</p>"},{"location":"services/audit-logging-service/data-model/#82-masking-ong-du-lieu","title":"8.2. Masking \u0111\u1ed9ng d\u1eef li\u1ec7u","text":"<p>C\u00e1c tr\u01b0\u1eddng sau s\u1ebd \u0111\u01b0\u1ee3c che khu\u1ea5t (mask) n\u1ebfu user kh\u00f4ng c\u00f3 quy\u1ec1n cao:</p> Tr\u01b0\u1eddng b\u1ecb mask Khi n\u00e0o \u00e1p d\u1ee5ng <code>input_parameters</code> N\u1ebfu kh\u00f4ng c\u00f3 <code>view_sensitive_payload</code> <code>ip_address</code> N\u1ebfu kh\u00f4ng c\u00f3 <code>view_ip</code> <code>user_agent</code> N\u1ebfu kh\u00f4ng c\u00f3 <code>view_device_info</code> <p>V\u00ed d\u1ee5 sau ph\u1ea3n \u00e1nh k\u1ebft qu\u1ea3 truy v\u1ea5n \u0111\u1ed1i v\u1edbi 2 vai tr\u00f2 kh\u00e1c nhau:</p> <pre><code>// Truy c\u1eadp v\u1edbi quy\u1ec1n th\u1ea5p\n{\n  \"input_parameters\": \"masked\",\n  \"ip_address\": \"masked\",\n  \"user_agent\": \"masked\"\n}\n\n// Truy c\u1eadp v\u1edbi quy\u1ec1n cao\n{\n  \"input_parameters\": {\n    \"email\": \"john@example.com\",\n    \"name\": \"John\"\n  },\n  \"ip_address\": \"192.168.1.2\",\n  \"user_agent\": \"Mozilla/5.0\"\n}\n</code></pre>"},{"location":"services/audit-logging-service/data-model/#83-ieu-kien-rang-buoc-theo-tenant","title":"8.3. \u0110i\u1ec1u ki\u1ec7n r\u00e0ng bu\u1ed9c theo Tenant","text":"<p>M\u1ecdi truy v\u1ea5n t\u1eeb client \u0111\u1ec1u ph\u1ea3i c\u00f3 header <code>X-Tenant-ID</code>. \u0110i\u1ec1u ki\u1ec7n b\u1eaft bu\u1ed9c:</p> <pre><code>{ \"tenant_id\": \"{{X-Tenant-ID}}\" }\n</code></pre> <p>Qu\u1ea3n tr\u1ecb vi\u00ean c\u1ea5p tenant ch\u1ec9 \u0111\u01b0\u1ee3c th\u1ea5y log trong ph\u1ea1m vi tenant c\u1ee7a m\u00ecnh.</p>"},{"location":"services/audit-logging-service/data-model/#84-scope-bat-buoc-trong-jwt","title":"8.4. Scope b\u1eaft bu\u1ed9c trong JWT","text":"API Scope y\u00eau c\u1ea7u <code>GET /audit-log</code> <code>audit.read.log</code> <code>GET /audit-log/{id}</code> <code>audit.read.log</code> <code>POST /audit-log</code> <code>audit.write</code> (internal only) <p>\u26a0\ufe0f Kh\u00f4ng bao gi\u1edd c\u1ea5p <code>audit.write</code> cho \u1ee9ng d\u1ee5ng ng\u01b0\u1eddi d\u00f9ng (frontend/mobile).</p>"},{"location":"services/audit-logging-service/data-model/#85-policy-trien-khai-tren-api-gateway","title":"8.5. Policy tri\u1ec3n khai tr\u00ean API Gateway","text":"Th\u00e0nh ph\u1ea7n Policy Gateway filter Ki\u1ec3m tra <code>scope</code>, <code>tenant_id</code> Middleware ALS Check RBAC theo role Query Layer (DB) G\u1eafn filter theo <code>tenant_id</code>, mask n\u1ebfu c\u1ea7n"},{"location":"services/audit-logging-service/data-model/#9-mo-rong-trong-tuong-lai","title":"9. M\u1edf r\u1ed9ng trong T\u01b0\u01a1ng Lai","text":"<p>Audit Logging Service (ALS) \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf theo nguy\u00ean t\u1eafc modular &amp; event-driven, s\u1eb5n s\u00e0ng m\u1edf r\u1ed9ng trong c\u00e1c giai \u0111o\u1ea1n sau n\u00e0y. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c h\u01b0\u1edbng m\u1edf r\u1ed9ng quan tr\u1ecdng \u0111\u00e3 \u0111\u01b0\u1ee3c x\u00e1c \u0111\u1ecbnh:</p>"},{"location":"services/audit-logging-service/data-model/#91-phat-su-kien-thu-cap-vasauditpersistedv1","title":"9.1. \ud83d\ude80 Ph\u00e1t s\u1ef1 ki\u1ec7n th\u1ee9 c\u1ea5p <code>vas.audit.persisted.v1</code>","text":"<ul> <li>Cho ph\u00e9p ALS ph\u00e1t Pub/Sub event m\u1ed7i khi m\u1ed9t b\u1ea3n ghi log \u0111\u01b0\u1ee3c l\u01b0u th\u00e0nh c\u00f4ng.</li> <li>H\u1eefu \u00edch cho:</li> <li>Downstream processing (ETL \u2192 Data Lake, Data Mart)</li> <li>Ph\u00e2n t\u00edch AI behavior</li> <li>Realtime monitoring (nh\u01b0 suspicious behavior)</li> <li>Tr\u1ea1ng th\u00e1i hi\u1ec7n t\u1ea1i: \u0110\u00e3 thi\u1ebft k\u1ebf schema &amp; flow (xem <code>design.md &gt; 5.3</code>)   \ud83d\udd12 Ch\u01b0a b\u1eadt m\u1eb7c \u0111\u1ecbnh \u2013 c\u1ea7n b\u1eadt <code>emit_audit_event_enabled = true</code> theo m\u00f4i tr\u01b0\u1eddng</li> </ul> <p>Xem th\u00eam: ADR-030 - Event Schema Governance</p>"},{"location":"services/audit-logging-service/data-model/#92-tu-ong-phat-hien-hanh-vi-bat-thuong-anomaly-detection","title":"9.2. \ud83e\udde0 T\u1ef1 \u0111\u1ed9ng ph\u00e1t hi\u1ec7n h\u00e0nh vi b\u1ea5t th\u01b0\u1eddng (Anomaly Detection)","text":"<ul> <li>K\u1ebft h\u1ee3p ALS v\u1edbi AI pipeline \u0111\u1ec3 ph\u00e1t hi\u1ec7n:</li> <li>Truy c\u1eadp b\u1ea5t th\u01b0\u1eddng v\u00e0o d\u1eef li\u1ec7u h\u1ecdc sinh</li> <li>H\u00e0nh vi \u0111\u0103ng nh\u1eadp tr\u00e1i ph\u00e9p ho\u1eb7c brute-force</li> <li>Y\u00eau c\u1ea7u: t\u00edch h\u1ee3p ALS log v\u1edbi Data Lake + h\u1ec7 th\u1ed1ng c\u1ea3nh b\u00e1o (ADR-021)</li> </ul>"},{"location":"services/audit-logging-service/data-model/#93-ho-tro-nhieu-backend-luu-tru","title":"9.3. \ud83d\udce6 H\u1ed7 tr\u1ee3 nhi\u1ec1u backend l\u01b0u tr\u1eef","text":"Storage Tr\u1ea1ng th\u00e1i hi\u1ec7n t\u1ea1i Ghi ch\u00fa BigQuery \u2705 Production Ph\u00e2n t\u00edch &amp; truy v\u1ea5n Firestore \ud83c\udd7e Optional D\u00f9ng cho dashboard nh\u1ecf, backup PostgreSQL/Clickhouse \ud83d\udd1c Giai \u0111o\u1ea1n sau Ph\u00f9 h\u1ee3p self-hosted ho\u1eb7c latency th\u1ea5p"},{"location":"services/audit-logging-service/data-model/#94-truy-van-nang-cao-cho-bao-cao","title":"9.4. \ud83e\uddfe Truy v\u1ea5n n\u00e2ng cao cho b\u00e1o c\u00e1o","text":"<ul> <li>H\u1ed7 tr\u1ee3 c\u00e1c API n\u00e2ng cao theo truy v\u1ea5n:</li> <li><code>GET /audit-log/by-trace/{trace_id}</code></li> <li><code>GET /audit-log/stats?group_by=action</code></li> <li>Ph\u1ee5c v\u1ee5 tr\u1ef1c ti\u1ebfp cho b\u00e1o c\u00e1o b\u1ea3o m\u1eadt (<code>Reporting Service</code>) v\u00e0 dashboard.</li> </ul>"},{"location":"services/audit-logging-service/data-model/#95-retry-co-che-tieu-thu-pubsub","title":"9.5. \ud83d\udd01 Retry c\u01a1 ch\u1ebf ti\u00eau th\u1ee5 Pub/Sub","text":"<ul> <li>Hi\u1ec7n t\u1ea1i: ALS b\u1ecf qua c\u00e1c event kh\u00f4ng valid schema</li> <li>T\u01b0\u01a1ng lai:</li> <li>L\u01b0u c\u00e1c event l\u1ed7i v\u00e0o h\u00e0ng ch\u1edd t\u1ea1m th\u1eddi</li> <li>Cho ph\u00e9p debug &amp; replay event l\u1ed7i</li> <li>T\u00edch h\u1ee3p v\u1edbi alerting system (Grafana Alert, Slack webhook...)</li> </ul>"},{"location":"services/audit-logging-service/data-model/#96-kiem-toan-cac-truy-van-nhay-cam","title":"9.6. \ud83d\udd12 Ki\u1ec3m to\u00e1n c\u00e1c truy v\u1ea5n nh\u1ea1y c\u1ea3m","text":"<ul> <li>Ghi l\u1ea1i c\u1ea3 h\u00e0nh vi truy v\u1ea5n log (ai truy c\u1eadp log g\u00ec, khi n\u00e0o) nh\u01b0 m\u1ed9t d\u1ea1ng \u201cmeta-audit\u201d</li> <li>Cho ph\u00e9p truy v\u1ea5n theo <code>trace_id</code> c\u1ee7a truy v\u1ea5n</li> <li>C\u1ea7n tri\u1ec3n khai song song trong Admin WebApp &amp; ALS</li> </ul>"},{"location":"services/audit-logging-service/data-model/#97-admin-dashboard-mini","title":"9.7. \ud83d\udee0 Admin Dashboard Mini","text":"<ul> <li>T\u1ea1o 1 dashboard n\u1ed9i b\u1ed9 g\u1ecdn nh\u1eb9 \u0111\u1ec3:</li> <li>Xem log g\u1ea7n nh\u1ea5t theo trace/user</li> <li>Ki\u1ec3m tra s\u1ef1 ki\u1ec7n n\u00e0o \u0111\u00e3 \u0111\u01b0\u1ee3c ghi v\u00e0o ALS</li> <li>Xem tr\u1ea1ng th\u00e1i masking theo vai tr\u00f2</li> <li>C\u00f3 th\u1ec3 d\u00f9ng Firestore + Firebase Hosting + Tailwind CSS</li> </ul> <p>\ud83d\udccc C\u00e1c h\u01b0\u1edbng m\u1edf r\u1ed9ng tr\u00ean \u0111\u1ec1u n\u1eb1m trong t\u1ea7m ki\u1ec3m so\u00e1t hi\u1ec7n t\u1ea1i nh\u1edd thi\u1ebft k\u1ebf tu\u00e2n th\u1ee7 ADR, modular, v\u00e0 c\u00f3 th\u1ec3 b\u1eadt/t\u1eaft theo m\u00f4i tr\u01b0\u1eddng b\u1eb1ng <code>feature flag</code>.</p> <p>\ud83d\udcce G\u1ee3i \u00fd chi ti\u1ebft cho tri\u1ec3n khai sau n\u00e0y: xem design.md &gt; 11. Ki\u1ebfn tr\u00fac Service</p>"},{"location":"services/audit-logging-service/data-model/#10-enums","title":"10. ENUMs","text":"<p>Danh s\u00e1ch c\u00e1c gi\u00e1 tr\u1ecb li\u1ec7t k\u00ea (<code>enum</code>) \u0111\u01b0\u1ee3c chu\u1ea9n h\u00f3a \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o t\u00ednh nh\u1ea5t qu\u00e1n xuy\u00ean su\u1ed1t h\u1ec7 th\u1ed1ng. T\u1ea5t c\u1ea3 gi\u00e1 tr\u1ecb enum \u0111\u1ec1u n\u00ean \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd t\u1eadp trung trong schema v\u00e0 OpenAPI, c\u00f3 th\u1ec3 d\u00f9ng cho codegen v\u00e0 t\u1ef1 \u0111\u1ed9ng ki\u1ec3m tra t\u00ednh h\u1ee3p l\u1ec7.</p>"},{"location":"services/audit-logging-service/data-model/#101-truong-status","title":"10.1. \ud83d\udccc Tr\u01b0\u1eddng <code>status</code>","text":"Gi\u00e1 tr\u1ecb M\u00f4 t\u1ea3 <code>success</code> H\u00e0nh \u0111\u1ed9ng ho\u00e0n t\u1ea5t th\u00e0nh c\u00f4ng <code>failure</code> H\u00e0nh \u0111\u1ed9ng b\u1ecb l\u1ed7i ho\u1eb7c kh\u00f4ng ho\u00e0n t\u1ea5t <code>warning</code> Th\u00e0nh c\u00f4ng m\u1ed9t ph\u1ea7n, ho\u1eb7c c\u00f3 \u0111i\u1ec1u ki\u1ec7n c\u1ea3nh b\u00e1o (e.g. timeout, retry)"},{"location":"services/audit-logging-service/data-model/#102-truong-resource_type","title":"10.2. \ud83d\udccc Tr\u01b0\u1eddng <code>resource_type</code>","text":"Gi\u00e1 tr\u1ecb M\u00f4 t\u1ea3 <code>user</code> Ng\u01b0\u1eddi d\u00f9ng ho\u1eb7c t\u00e0i kho\u1ea3n <code>tenant</code> Tenant / tr\u01b0\u1eddng / \u0111\u01a1n v\u1ecb <code>role</code> Vai tr\u00f2 trong RBAC <code>permission</code> Quy\u1ec1n \u0111\u01b0\u1ee3c g\u00e1n ho\u1eb7c thu h\u1ed3i <code>token</code> JWT ho\u1eb7c OAuth token <code>report</code> B\u00e1o c\u00e1o sinh ra t\u1eeb Reporting Service <code>notification</code> Th\u00f4ng b\u00e1o \u0111\u01b0\u1ee3c g\u1eedi qua Notification Service <code>system</code> C\u00e1c t\u00e1c v\u1ee5 h\u1ec7 th\u1ed1ng kh\u00f4ng thu\u1ed9c th\u1ef1c th\u1ec3 c\u1ee5 th\u1ec3 <p>\ud83d\udcce Danh s\u00e1ch n\u00e0y c\u00f3 th\u1ec3 m\u1edf r\u1ed9ng nh\u01b0ng c\u1ea7n c\u1eadp nh\u1eadt \u0111\u1ed3ng b\u1ed9 OpenAPI v\u00e0 schema BQ</p>"},{"location":"services/audit-logging-service/data-model/#103-truong-action","title":"10.3. \ud83d\udccc Tr\u01b0\u1eddng <code>action</code>","text":"<p>H\u1ec7 th\u1ed1ng kh\u00f4ng gi\u1edbi h\u1ea1n c\u1ed1 \u0111\u1ecbnh <code>action</code>, nh\u01b0ng c\u00f3 th\u1ec3 g\u1ee3i \u00fd c\u00e1c gi\u00e1 tr\u1ecb ph\u1ed5 bi\u1ebfn d\u00f9ng \u0111\u1ec3 th\u1ed1ng k\u00ea v\u00e0 sinh b\u00e1o c\u00e1o:</p> Gi\u00e1 tr\u1ecb m\u1eabu M\u00f4 t\u1ea3 <code>user.login.success</code> \u0110\u0103ng nh\u1eadp th\u00e0nh c\u00f4ng <code>user.login.failed</code> \u0110\u0103ng nh\u1eadp th\u1ea5t b\u1ea1i <code>user.created</code> T\u1ea1o ng\u01b0\u1eddi d\u00f9ng <code>user.updated</code> C\u1eadp nh\u1eadt th\u00f4ng tin <code>user.deleted</code> X\u00f3a ng\u01b0\u1eddi d\u00f9ng <code>role.assigned</code> G\u00e1n role cho ng\u01b0\u1eddi d\u00f9ng <code>token.exchanged</code> \u0110\u1ed5i token qua refresh <code>report.viewed</code> Xem b\u00e1o c\u00e1o <code>notification.sent</code> G\u1eedi th\u00f4ng b\u00e1o th\u00e0nh c\u00f4ng <code>notification.failed</code> G\u1eedi th\u00f4ng b\u00e1o th\u1ea5t b\u1ea1i <code>audit.anonymized</code> Log \u0111\u00e3 \u0111\u01b0\u1ee3c \u1ea9n danh h\u00f3a (batch masking)"},{"location":"services/audit-logging-service/data-model/#ghi-chu-ve-quan-ly-enums","title":"\ud83d\udd0e Ghi ch\u00fa v\u1ec1 qu\u1ea3n l\u00fd ENUMs","text":"<ul> <li>V\u1edbi c\u00e1c enum c\u00f3 ph\u1ea1m vi gi\u1edbi h\u1ea1n v\u00e0 d\u00f9ng filter (nh\u01b0 <code>status</code>, <code>resource_type</code>), n\u00ean l\u01b0u trong schema v\u00e0 OpenAPI.</li> <li>V\u1edbi c\u00e1c gi\u00e1 tr\u1ecb m\u1edf r\u1ed9ng linh ho\u1ea1t nh\u01b0 <code>action</code>, n\u00ean qu\u1ea3n l\u00fd theo <code>dictionary</code> n\u1ed9i b\u1ed9 \u0111\u1ec3 h\u1ed7 tr\u1ee3 ph\u00e2n t\u00edch v\u00e0 b\u00e1o c\u00e1o.</li> <li>C\u00e1c enum c\u1ea7n m\u00f4 t\u1ea3 k\u1ef9 c\u00e0ng trong <code>event schema</code> n\u1ebfu \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng l\u00e0m field trong Pub/Sub event.</li> </ul>"},{"location":"services/audit-logging-service/data-model/#11-lien-ket-tai-lieu","title":"11. \ud83d\udcda Li\u00ean k\u1ebft T\u00e0i li\u1ec7u","text":"<ul> <li>Interface Contract</li> <li>OpenAPI Spec</li> <li>Design</li> <li><code>adr-023-schema-migration-strategy</code></li> <li><code>adr-024-data-anonymization-retention</code></li> <li><code>adr-026-hard-delete-policy</code></li> <li><code>adr-030-event-schema-governance</code></li> </ul>"},{"location":"services/audit-logging-service/design/","title":"\ud83d\udcd8 Thi\u1ebft k\u1ebf chi ti\u1ebft Audit Logging Service","text":""},{"location":"services/audit-logging-service/design/#1-pham-vi-va-trach-nhiem-scope-responsibilities","title":"1. \ud83e\udded Ph\u1ea1m vi v\u00e0 Tr\u00e1ch nhi\u1ec7m (Scope &amp; Responsibilities)","text":""},{"location":"services/audit-logging-service/design/#11-muc-tieu","title":"1.1. \ud83c\udfaf M\u1ee5c ti\u00eau","text":"<p>Audit Logging Service (ALS) l\u00e0 m\u1ed9t core service thu\u1ed9c nh\u00f3m Platform Stack, ch\u1ecbu tr\u00e1ch nhi\u1ec7m ghi nh\u1eadn to\u00e0n b\u1ed9 h\u00e0nh vi c\u00f3 \u1ea3nh h\u01b0\u1edfng \u0111\u1ebfn tr\u1ea1ng th\u00e1i h\u1ec7 th\u1ed1ng, bao g\u1ed3m:</p> <ul> <li>C\u00e1c thay \u0111\u1ed5i d\u1eef li\u1ec7u quan tr\u1ecdng (create/update/delete)</li> <li>C\u00e1c h\u00e0nh \u0111\u1ed9ng nh\u1ea1y c\u1ea3m (\u0111\u0103ng nh\u1eadp, ph\u00e2n quy\u1ec1n, thanh to\u00e1n, xu\u1ea5t d\u1eef li\u1ec7u)</li> <li>C\u00e1c thao t\u00e1c qu\u1ea3n tr\u1ecb (c\u1ea5u h\u00ecnh h\u1ec7 th\u1ed1ng, ph\u00ea duy\u1ec7t y\u00eau c\u1ea7u, \u0111\u0103ng k\u00fd tenant m\u1edbi)</li> <li>T\u01b0\u01a1ng t\u00e1c c\u1ee7a ng\u01b0\u1eddi d\u00f9ng th\u00f4ng qua c\u00e1c API c\u00f3 side-effect</li> </ul> <p>ALS \u0111\u00f3ng vai tr\u00f2 nh\u01b0 \u201ch\u1ed9p \u0111en\u201d (blackbox) c\u1ee7a h\u1ec7 th\u1ed1ng, gi\u00fap truy v\u1ebft v\u00e0 \u0111i\u1ec1u tra c\u00e1c s\u1ef1 c\u1ed1, \u0111\u1ea3m b\u1ea3o tu\u00e2n th\u1ee7 ch\u00ednh s\u00e1ch b\u1ea3o m\u1eadt, v\u00e0 l\u00e0 n\u1ec1n t\u1ea3ng quan tr\u1ecdng cho ph\u00e2n t\u00edch h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng ho\u1eb7c \u0111i\u1ec1u tra vi ph\u1ea1m.</p>"},{"location":"services/audit-logging-service/design/#12-trach-nhiem-chinh","title":"1.2. \ud83d\udccc Tr\u00e1ch nhi\u1ec7m ch\u00ednh","text":"Nh\u00f3m ch\u1ee9c n\u0103ng M\u00f4 t\u1ea3 Ingest log Nh\u1eadn log t\u1eeb c\u00e1c service kh\u00e1c qua HTTP ho\u1eb7c Pub/Sub, x\u00e1c th\u1ef1c ngu\u1ed3n v\u00e0 \u0111\u1ecbnh d\u1ea1ng Chu\u1ea9n ho\u00e1 &amp; b\u1ea3o v\u1ec7 d\u1eef li\u1ec7u Tu\u00e2n th\u1ee7 <code>ADR-008</code> v\u1ec1 \u0111\u1ecbnh d\u1ea1ng log v\u00e0 <code>ADR-024</code> v\u1ec1 \u1ea9n danh h\u00f3a d\u1eef li\u1ec7u PII L\u01b0u tr\u1eef d\u00e0i h\u1ea1n Ghi d\u1eef li\u1ec7u v\u00e0o BigQuery ho\u1eb7c Firestore theo schema chu\u1ea9n, c\u00f3 partition theo th\u1eddi gian v\u00e0 tenant H\u1ed7 tr\u1ee3 truy v\u1ea5n Cung c\u1ea5p API \u0111\u1ec3 tra c\u1ee9u audit log theo ti\u00eau ch\u00ed: th\u1eddi gian, h\u00e0nh \u0111\u1ed9ng, ng\u01b0\u1eddi d\u00f9ng, tenant\u2026 T\u01b0\u01a1ng th\u00edch \u0111a tenant M\u1ed7i b\u1ea3n ghi log g\u1eafn <code>tenant_id</code> r\u00f5 r\u00e0ng, \u0111\u1ea3m b\u1ea3o ph\u00e2n quy\u1ec1n truy c\u1eadp \u1edf c\u1ea5p tenant Quan s\u00e1t &amp; ph\u00e2n t\u00edch Cung c\u1ea5p metric, tracing, alerting theo <code>ADR-021</code> \u0111\u1ec3 gi\u00e1m s\u00e1t ch\u1ea5t l\u01b0\u1ee3ng ghi log \u0110\u1ea3m b\u1ea3o compliance H\u1ed7 tr\u1ee3 th\u1eddi gian l\u01b0u tr\u1eef (retention), masking PII, export ph\u1ee5c v\u1ee5 audit n\u1ed9i b\u1ed9 ho\u1eb7c b\u00ean ngo\u00e0i"},{"location":"services/audit-logging-service/design/#13-ngoai-pham-vi-out-of-scope","title":"1.3. \u274c Ngo\u00e0i ph\u1ea1m vi (Out of Scope)","text":"<ul> <li>Kh\u00f4ng l\u01b0u log h\u1ec7 th\u1ed1ng nh\u01b0 stdout/stderr ho\u1eb7c log \u1ee9ng d\u1ee5ng th\u00f4ng th\u01b0\u1eddng</li> <li>Kh\u00f4ng thay th\u1ebf h\u1ec7 th\u1ed1ng monitoring nh\u01b0 Stackdriver, Prometheus</li> <li>Kh\u00f4ng th\u1ef1c hi\u1ec7n alerting, auto-block hay trigger x\u1eed l\u00fd t\u1eeb log \u2013 c\u00e1c h\u1ec7 th\u1ed1ng kh\u00e1c c\u00f3 th\u1ec3 ph\u00e2n t\u00edch log \u0111\u1ec3 th\u1ef1c hi\u1ec7n h\u00e0nh \u0111\u1ed9ng</li> </ul>"},{"location":"services/audit-logging-service/design/#14-nguoi-dung-va-client","title":"1.4. \ud83d\udc65 Ng\u01b0\u1eddi d\u00f9ng v\u00e0 client","text":"Vai tr\u00f2 M\u1ee5c \u0111\u00edch s\u1eed d\u1ee5ng Core Services (Auth, User, API Gateway, Notification...) G\u1eedi audit log khi c\u00f3 h\u00e0nh \u0111\u1ed9ng quan tr\u1ecdng DevOps / Security Team Tra c\u1ee9u h\u00e0nh vi b\u1ea5t th\u01b0\u1eddng, \u0111i\u1ec1u tra s\u1ef1 c\u1ed1 b\u1ea3o m\u1eadt Tenant Admin Truy v\u1ea5n log trong ph\u1ea1m vi tenant \u0111\u1ec3 ki\u1ec3m tra h\u00e0nh \u0111\u1ed9ng ng\u01b0\u1eddi d\u00f9ng Auditor (n\u1ed9i b\u1ed9 ho\u1eb7c b\u00ean th\u1ee9 ba) T\u1ea3i export log ph\u1ee5c v\u1ee5 ki\u1ec3m to\u00e1n \u0111\u1ecbnh k\u1ef3"},{"location":"services/audit-logging-service/design/#2-kien-truc-noi-bo-internal-architecture","title":"2. \ud83e\uddf1 Ki\u1ebfn tr\u00fac n\u1ed9i b\u1ed9 (Internal Architecture)","text":""},{"location":"services/audit-logging-service/design/#21-tong-quan","title":"2.1. \ud83e\udde0 T\u1ed5ng quan","text":"<p>Audit Logging Service (ALS) \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf theo m\u00f4 h\u00ecnh stateless microservice, v\u1eadn h\u00e0nh trong Core Stack c\u1ee7a h\u1ec7 th\u1ed1ng <code>dx-vas</code>. Service n\u00e0y ti\u1ebfp nh\u1eadn log th\u00f4ng qua c\u1ea3 hai c\u01a1 ch\u1ebf: HTTP API v\u00e0 Pub/Sub, x\u1eed l\u00fd v\u00e0 ghi nh\u1eadn log v\u00e0o h\u1ec7 th\u1ed1ng l\u01b0u tr\u1eef trung t\u00e2m, \u0111\u1ed3ng th\u1eddi cung c\u1ea5p API \u0111\u1ec3 truy v\u1ea5n log theo tenant v\u00e0 \u0111i\u1ec1u ki\u1ec7n l\u1ecdc.</p>"},{"location":"services/audit-logging-service/design/#22-cac-thanh-phan-chinh","title":"2.2. \ud83c\udfd7\ufe0f C\u00e1c th\u00e0nh ph\u1ea7n ch\u00ednh","text":"Th\u00e0nh ph\u1ea7n M\u00f4 t\u1ea3 Ingestion API HTTP endpoint n\u1ed9i b\u1ed9 d\u00f9ng \u0111\u1ec3 c\u00e1c service g\u1ecdi tr\u1ef1c ti\u1ebfp g\u1eedi log. X\u00e1c th\u1ef1c b\u1eb1ng JWT, ki\u1ec3m tra <code>x-tenant-id</code>, \u00e1p d\u1ee5ng RBAC (n\u1ebfu c\u1ea7n) Pub/Sub Consumer L\u1eafng nghe topic <code>audit.events.v1</code> (chu\u1ea9n ho\u00e1 theo <code>ADR-030</code>). D\u00f9ng \u0111\u1ec3 x\u1eed l\u00fd log ph\u00e1t ra d\u01b0\u1edbi d\u1ea1ng s\u1ef1 ki\u1ec7n t\u1eeb c\u00e1c service kh\u00e1c Parser &amp; Validator Ki\u1ec3m tra schema c\u1ee7a audit event (theo <code>ADR-008</code>), l\u1ecdc c\u00e1c tr\u01b0\u1eddng kh\u00f4ng h\u1ee3p l\u1ec7, ki\u1ec3m tra backward compatibility n\u1ebfu c\u1ea7n PII Masker \u00c1p d\u1ee5ng ch\u00ednh s\u00e1ch \u1ea9n danh ho\u00e1 tr\u01b0\u1edbc khi l\u01b0u log (xem <code>ADR-024</code>). C\u00f3 th\u1ec3 c\u1ea5u h\u00ecnh b\u1eadt/t\u1eaft masking theo m\u00f4i tr\u01b0\u1eddng Storage Layer Ghi log v\u00e0o BigQuery (m\u1eb7c \u0111\u1ecbnh). C\u00f3 th\u1ec3 c\u1ea5u h\u00ecnh l\u01b0u v\u00e0o Firestore ho\u1eb7c Cold Storage cho log l\u00e2u n\u0103m Query API Cung c\u1ea5p REST API \u0111\u1ec3 truy v\u1ea5n log theo <code>tenant_id</code>, <code>actor_user_id</code>, <code>resource</code>, <code>action</code>, <code>date_range</code>, <code>trace_id</code>... Retention Cron T\u1ef1 \u0111\u1ed9ng x\u00f3a log theo ch\u00ednh s\u00e1ch th\u1eddi gian l\u01b0u tr\u1eef (<code>retention_days</code>) c\u1ea5u h\u00ecnh trong bi\u1ebfn m\u00f4i tr\u01b0\u1eddng ho\u1eb7c metadata Observability Hooks T\u00edch h\u1ee3p logging, metrics (Prometheus), tracing (OpenTelemetry) v\u00e0 alerting (Stackdriver Alerting) theo <code>ADR-021</code>"},{"location":"services/audit-logging-service/design/#23-flow-xu-ly-tong-quat","title":"2.3. \ud83d\udd01 Flow x\u1eed l\u00fd t\u1ed5ng qu\u00e1t","text":"<pre><code>flowchart TD\n    subgraph Ingestion\n        A1[HTTP Request]\n        A2[Pub/Sub Message]\n    end\n    A1 --&gt; P[Parse &amp; Validate]\n    A2 --&gt; P\n    P --&gt; M[Mask Sensitive Fields (ADR-024)]\n    M --&gt; S[Store to BigQuery]\n    S --&gt; E[Emit audit_log_persisted.v1]\n</code></pre>"},{"location":"services/audit-logging-service/design/#24-bao-mat-noi-bo","title":"2.4. \ud83d\udd12 B\u1ea3o m\u1eadt n\u1ed9i b\u1ed9","text":"<ul> <li>M\u1ecdi HTTP request ph\u1ea3i \u0111i qua API Gateway, c\u00f3 x\u00e1c th\u1ef1c JWT v\u00e0 <code>x-tenant-id</code></li> <li>Consumer Pub/Sub ch\u1ec9 nh\u1eadn t\u1eeb topic <code>audit.events.v1</code> \u0111\u00e3 \u0111\u0103ng k\u00fd theo \u0111\u00fang schema (x\u00e1c minh t\u1eeb <code>event-registry</code>)</li> <li>T\u1ea5t c\u1ea3 log \u0111\u01b0\u1ee3c g\u1eafn <code>tenant_id</code>, kh\u00f4ng bao gi\u1edd c\u00f3 log \u201cchung\u201d kh\u00f4ng \u0111\u1ecbnh danh tenant</li> <li>Truy c\u1eadp log ch\u1ec9 cho ph\u00e9p ng\u01b0\u1eddi d\u00f9ng ho\u1eb7c service c\u00f3 quy\u1ec1n <code>audit.read</code></li> </ul>"},{"location":"services/audit-logging-service/design/#25-trien-khai-va-mo-rong","title":"2.5. \u2699\ufe0f Tri\u1ec3n khai v\u00e0 M\u1edf r\u1ed9ng","text":"<ul> <li>Service tri\u1ec3n khai tr\u00ean Google Cloud Run, autoscale theo load</li> <li>M\u1ed7i b\u1ea3n ghi log l\u01b0u k\u00e8m <code>trace_id</code>, h\u1ed7 tr\u1ee3 li\u00ean k\u1ebft v\u1edbi observability to\u00e0n h\u1ec7 th\u1ed1ng</li> <li>Trong t\u01b0\u01a1ng lai c\u00f3 th\u1ec3 h\u1ed7 tr\u1ee3 dual storage (BigQuery realtime + Firestore archive)</li> </ul>"},{"location":"services/audit-logging-service/design/#26-lien-ket-adr-va-kien-truc","title":"2.6. \ud83d\udccc Li\u00ean k\u1ebft ADR v\u00e0 Ki\u1ebfn tr\u00fac","text":"Th\u00e0nh ph\u1ea7n ADR li\u00ean quan Ingestion API ADR-008, ADR-006 Pub/Sub Consumer ADR-030, ADR-008 Masking ADR-024 Storage ADR-027, ADR-020 Tracing &amp; Metrics ADR-021 Retention Policy ADR-026 <p>Chi ti\u1ebft: Interface Contract &amp; OpenAPI</p>"},{"location":"services/audit-logging-service/design/#3-mo-hinh-du-lieu-data-model","title":"3. \ud83e\udde9 M\u00f4 h\u00ecnh D\u1eef li\u1ec7u (Data Model)","text":"<p>Audit Logging Service s\u1eed d\u1ee5ng m\u00f4 h\u00ecnh d\u1eef li\u1ec7u d\u1ea1ng append-only, l\u01b0u tr\u1eef m\u1ed7i h\u00e0nh \u0111\u1ed9ng (event) th\u00e0nh m\u1ed9t b\u1ea3n ghi kh\u00f4ng s\u1eeda \u0111\u1ed5i. D\u1eef li\u1ec7u \u0111\u01b0\u1ee3c l\u01b0u trong BigQuery (m\u1eb7c \u0111\u1ecbnh) ho\u1eb7c c\u00f3 th\u1ec3 c\u1ea5u h\u00ecnh l\u01b0u tr\u1eef song song \u1edf Firestore cho m\u1ee5c \u0111\u00edch truy xu\u1ea5t nhanh theo ID.</p>"},{"location":"services/audit-logging-service/design/#31-bang-chinh-audit_logs","title":"3.1. \ud83d\udccc B\u1ea3ng ch\u00ednh: <code>audit_logs</code>","text":""},{"location":"services/audit-logging-service/design/#muc-ich","title":"\ud83d\udd16 M\u1ee5c \u0111\u00edch","text":"<p>L\u01b0u tr\u1eef to\u00e0n b\u1ed9 h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng ho\u1eb7c h\u1ec7 th\u1ed1ng c\u00f3 t\u00e1c \u0111\u1ed9ng \u0111\u1ebfn tr\u1ea1ng th\u00e1i ho\u1eb7c c\u1ea5u h\u00ecnh h\u1ec7 th\u1ed1ng, \u0111\u01b0\u1ee3c ghi nh\u1eadn theo chu\u1ea9n schema s\u1ef1 ki\u1ec7n <code>*.audit.v1</code>.</p>"},{"location":"services/audit-logging-service/design/#cau-truc-bang","title":"\ud83d\udcd0 C\u1ea5u tr\u00fac b\u1ea3ng","text":"Tr\u01b0\u1eddng Ki\u1ec3u d\u1eef li\u1ec7u M\u00f4 t\u1ea3 <code>id</code> <code>STRING</code> ID duy nh\u1ea5t c\u1ee7a b\u1ea3n ghi (UUID v4) <code>tenant_id</code> <code>STRING</code> Tenant n\u01a1i h\u00e0nh \u0111\u1ed9ng x\u1ea3y ra <code>actor_user_id</code> <code>STRING</code> ID ng\u01b0\u1eddi th\u1ef1c hi\u1ec7n h\u00e0nh \u0111\u1ed9ng (c\u00f3 th\u1ec3 l\u00e0 system ho\u1eb7c service) <code>resource_type</code> <code>STRING</code> Lo\u1ea1i \u0111\u1ed1i t\u01b0\u1ee3ng b\u1ecb t\u00e1c \u0111\u1ed9ng (e.g. <code>user</code>, <code>template</code>, <code>config</code>) <code>resource_id</code> <code>STRING</code> ID \u0111\u1ed1i t\u01b0\u1ee3ng b\u1ecb t\u00e1c \u0111\u1ed9ng <code>action</code> <code>STRING</code> Lo\u1ea1i h\u00e0nh \u0111\u1ed9ng (<code>create</code>, <code>update</code>, <code>delete</code>, <code>login</code>, etc.) <code>action_scope</code> <code>STRING</code> Ph\u1ea1m vi h\u00e0nh \u0111\u1ed9ng (<code>global</code>, <code>tenant</code>, <code>internal</code>) <code>timestamp</code> <code>TIMESTAMP</code> Th\u1eddi \u0111i\u1ec3m x\u1ea3y ra h\u00e0nh \u0111\u1ed9ng (UTC) <code>trace_id</code> <code>STRING</code> M\u00e3 trace to\u00e0n c\u1ee5c \u0111\u1ec3 li\u00ean k\u1ebft log gi\u1eefa c\u00e1c service <code>ip_address</code> <code>STRING</code> IP c\u1ee7a ng\u01b0\u1eddi th\u1ef1c hi\u1ec7n (c\u00f3 th\u1ec3 \u0111\u00e3 mask) <code>user_agent</code> <code>STRING</code> Tr\u00ecnh duy\u1ec7t ho\u1eb7c c\u00f4ng c\u1ee5 th\u1ef1c hi\u1ec7n h\u00e0nh \u0111\u1ed9ng <code>payload_before</code> <code>JSON</code> Tr\u1ea1ng th\u00e1i \u0111\u1ed1i t\u01b0\u1ee3ng tr\u01b0\u1edbc khi thay \u0111\u1ed5i (n\u1ebfu c\u00f3) <code>payload_after</code> <code>JSON</code> Tr\u1ea1ng th\u00e1i \u0111\u1ed1i t\u01b0\u1ee3ng sau khi thay \u0111\u1ed5i (n\u1ebfu c\u00f3) <code>input_parameters</code> <code>JSON</code> Tham s\u1ed1 \u0111\u1ea7u v\u00e0o c\u1ee7a API t\u1ea1i th\u1eddi \u0111i\u1ec3m h\u00e0nh \u0111\u1ed9ng <code>duration_ms</code> <code>INTEGER</code> Th\u1eddi gian th\u1ef1c hi\u1ec7n h\u00e0nh \u0111\u1ed9ng (n\u1ebfu c\u00f3 th\u1ec3 \u0111o) <code>source_service</code> <code>STRING</code> T\u00ean service ph\u00e1t sinh h\u00e0nh \u0111\u1ed9ng (e.g. <code>user-service</code>, <code>auth-service</code>) <code>event_version</code> <code>STRING</code> Phi\u00ean b\u1ea3n schema s\u1ef1 ki\u1ec7n (e.g. <code>v1</code>, <code>v2</code>) <code>is_masked</code> <code>BOOLEAN</code> C\u1edd cho bi\u1ebft tr\u01b0\u1eddng nh\u1ea1y c\u1ea3m \u0111\u00e3 \u0111\u01b0\u1ee3c \u1ea9n danh h\u00f3a ch\u01b0a"},{"location":"services/audit-logging-service/design/#32-quy-tac-bao-mat-masking-du-lieu","title":"3.2. \ud83d\udd12 Quy t\u1eafc B\u1ea3o m\u1eadt &amp; Masking D\u1eef li\u1ec7u","text":"<p>Tu\u00e2n th\u1ee7 <code>ADR-024 - Data Anonymization &amp; Retention</code>: - Tr\u01b0\u1eddng <code>ip_address</code> \u2192 \u0111\u01b0\u1ee3c r\u00fat g\u1ecdn <code>/24</code> ho\u1eb7c SHA256 khi c\u1ea7n. - Tr\u01b0\u1eddng <code>input_parameters</code>, <code>payload_*</code> \u2192 l\u1ecdc theo whitelist field ho\u1eb7c pattern-based masking. - Tr\u01b0\u1eddng <code>actor_user_id</code> c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c thay b\u1eb1ng d\u1ea1ng alias (e.g. <code>u_x7f8d123</code>) n\u1ebfu xu\u1ea5t ra public logs.</p>"},{"location":"services/audit-logging-service/design/#33-chinh-sach-luu-tru-va-phan-vung-bigquery","title":"3.3. \u23f3 Ch\u00ednh s\u00e1ch l\u01b0u tr\u1eef v\u00e0 ph\u00e2n v\u00f9ng (BigQuery)","text":"Thu\u1ed9c t\u00ednh Gi\u00e1 tr\u1ecb Partition Theo <code>timestamp</code> Clustering <code>tenant_id</code>, <code>source_service</code> Retention m\u1eb7c \u0111\u1ecbnh 365 ng\u00e0y (c\u1ea5u h\u00ecnh qua env) Policy x\u00f3a Tu\u00e2n theo <code>ADR-026 - Hard Delete Policy</code> v\u00e0 <code>ADR-027 - Data Management Strategy</code>"},{"location":"services/audit-logging-service/design/#34-cac-chi-muc-va-truy-van-ien-hinh","title":"3.4. \ud83d\udd0d C\u00e1c ch\u1ec9 m\u1ee5c v\u00e0 truy v\u1ea5n \u0111i\u1ec3n h\u00ecnh","text":"Use case Field filter Truy v\u1ebft h\u00e0nh \u0111\u1ed9ng c\u1ee7a ng\u01b0\u1eddi d\u00f9ng <code>actor_user_id</code>, <code>tenant_id</code>, <code>timestamp</code> Ki\u1ec3m tra thay \u0111\u1ed5i config h\u1ec7 th\u1ed1ng <code>resource_type = 'config'</code> Xem to\u00e0n b\u1ed9 h\u00e0nh \u0111\u1ed9ng t\u1eeb m\u1ed9t service <code>source_service</code>, <code>trace_id</code> Truy xu\u1ea5t theo trace cho incident <code>trace_id</code> <p>\ud83d\udc49 Chi ti\u1ebft s\u01a1 \u0111\u1ed3 ERD, \u0111\u1ecbnh ngh\u0129a b\u1ea3ng v\u00e0 chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed d\u1eef li\u1ec7u \u0111\u01b0\u1ee3c tr\u00ecnh b\u00e0y t\u1ea1i: \ud83d\udcc2 Data Model</p>"},{"location":"services/audit-logging-service/design/#4-luong-nghiep-vu-chinh-main-flow","title":"4. \ud83d\udd04 Lu\u1ed3ng nghi\u1ec7p v\u1ee5 ch\u00ednh (Main Flow)","text":"<p>Audit Logging Service (ALS) h\u1ed7 tr\u1ee3 hai lu\u1ed3ng ch\u00ednh \u0111\u1ec3 ghi nh\u1eadn log m\u1ed9t c\u00e1ch to\u00e0n di\u1ec7n v\u00e0 linh ho\u1ea1t: (1) qua Pub/Sub theo c\u01a1 ch\u1ebf s\u1ef1 ki\u1ec7n b\u1ea5t \u0111\u1ed3ng b\u1ed9, v\u00e0 (2) qua HTTP API d\u00e0nh cho c\u00e1c tr\u01b0\u1eddng h\u1ee3p c\u1ea7n ghi log t\u1ee9c th\u1eddi ho\u1eb7c n\u1ed9i b\u1ed9. D\u1eef li\u1ec7u sau khi nh\u1eadn \u0111\u01b0\u1ee3c s\u1ebd \u0111\u01b0\u1ee3c chu\u1ea9n ho\u00e1, x\u1eed l\u00fd b\u1ea3o m\u1eadt v\u00e0 l\u01b0u tr\u1eef an to\u00e0n.</p>"},{"location":"services/audit-logging-service/design/#41-luong-1-nhan-su-kien-log-qua-pubsub-auditeventsv1","title":"4.1. \ud83d\udd01 Lu\u1ed3ng 1: Nh\u1eadn s\u1ef1 ki\u1ec7n log qua Pub/Sub (<code>audit.events.v1</code>)","text":"<p>Lu\u1ed3ng ph\u1ed5 bi\u1ebfn v\u00e0 \u0111\u01b0\u1ee3c khuy\u1ebfn ngh\u1ecb cho c\u00e1c core service ph\u00e1t h\u00e0nh log h\u00e0nh vi d\u01b0\u1edbi d\u1ea1ng s\u1ef1 ki\u1ec7n chu\u1ea9n h\u00f3a.</p> <pre><code>sequenceDiagram\n  participant ServiceX as Core Service (e.g. user-service)\n  participant PubSub as Pub/Sub Topic\n  participant ALS as Audit Logging Service\n  participant DB as BigQuery Storage\n\n  ServiceX-&gt;&gt;PubSub: Publish `audit.*.v1` JSON\n  PubSub--&gt;&gt;ALS: Consume &amp; parse event\n  ALS-&gt;&gt;ALS: Validate schema (ADR-008) + Mask sensitive fields (ADR-024)\n  ALS-&gt;&gt;DB: Persist log entry\n  ALS--&gt;&gt;PubSub: Emit `audit_log_persisted.v1`\n</code></pre> <p>\u0110\u1eb7c \u0111i\u1ec3m:</p> <ul> <li>Kh\u00f4ng blocking service ph\u00e1t.</li> <li>\u0110\u1ea3m b\u1ea3o loosely-coupled v\u00e0 resilient.</li> <li>B\u1eaft bu\u1ed9c tu\u00e2n theo schema trong <code>event-registry/</code>.</li> </ul>"},{"location":"services/audit-logging-service/design/#42-luong-2-ghi-log-truc-tiep-qua-http-api-chi-noi-bo","title":"4.2. \ud83d\udd01 Lu\u1ed3ng 2: Ghi log tr\u1ef1c ti\u1ebfp qua HTTP API (ch\u1ec9 n\u1ed9i b\u1ed9)","text":"<p>D\u00e0nh cho c\u00e1c service kh\u00f4ng t\u00edch h\u1ee3p Pub/Sub ho\u1eb7c mu\u1ed1n ghi log trong c\u00f9ng transaction.</p> <pre><code>sequenceDiagram\n  participant ServiceY as Internal Service\n  participant Gateway as API Gateway\n  participant ALS as Audit Logging Service\n  participant DB as BigQuery\n\n  ServiceY-&gt;&gt;Gateway: POST /audit-log (JWT + X-Tenant-ID)\n  Gateway-&gt;&gt;ALS: Forward request\n  ALS-&gt;&gt;ALS: Validate + Mask + Attach trace_id\n  ALS-&gt;&gt;DB: Store log\n  ALS--&gt;&gt;ServiceY: 204 No Content\n</code></pre> <p>\u0110\u1eb7c \u0111i\u1ec3m:</p> <ul> <li>Y\u00eau c\u1ea7u JWT h\u1ee3p l\u1ec7 v\u1edbi scope <code>audit.write</code>.</li> <li>D\u00e0nh cho log n\u1ed9i b\u1ed9 ho\u1eb7c dev tool (e.g. RBAC editor, import tools).</li> <li>C\u00f3 th\u1ec3 b\u1eadt/t\u1eaft per-environment qua config.</li> </ul>"},{"location":"services/audit-logging-service/design/#43-luong-3-truy-van-audit-log-tu-webapp-hoac-devops","title":"4.3. \ud83e\udde0 Lu\u1ed3ng 3: Truy v\u1ea5n Audit Log t\u1eeb WebApp ho\u1eb7c DevOps","text":"<p>Cho ph\u00e9p ng\u01b0\u1eddi d\u00f9ng c\u00f3 vai tr\u00f2 ph\u00f9 h\u1ee3p truy xu\u1ea5t log trong ph\u1ea1m vi tenant \u0111\u1ec3 ki\u1ec3m tra h\u00e0nh vi.</p> <pre><code>sequenceDiagram\n  participant Admin as Tenant Admin\n  participant WebApp as Superadmin UI\n  participant Gateway as API Gateway\n  participant ALS as Audit Logging Service\n  participant DB as BigQuery\n\n  Admin-&gt;&gt;WebApp: Ch\u1ecdn th\u1eddi gian, h\u00e0nh \u0111\u1ed9ng, user\n  WebApp-&gt;&gt;Gateway: GET /audit-log?filters... (JWT + Tenant)\n  Gateway-&gt;&gt;ALS: Forward request\n  ALS-&gt;&gt;DB: Query log with tenant + filters\n  ALS--&gt;&gt;WebApp: Paginated Result\n</code></pre> <p>\u0110\u1eb7c \u0111i\u1ec3m:</p> <ul> <li>Y\u00eau c\u1ea7u scope <code>audit.read</code> + ki\u1ec3m tra tenant ID.</li> <li>K\u1ebft qu\u1ea3 \u0111\u01b0\u1ee3c tr\u1ea3 d\u01b0\u1edbi d\u1ea1ng <code>AuditLogEnvelope</code> (tu\u00e2n theo <code>ADR-012</code>).</li> </ul>"},{"location":"services/audit-logging-service/design/#44-cac-hanh-ong-pho-bien-uoc-log","title":"4.4. \ud83e\udde9 C\u00e1c h\u00e0nh \u0111\u1ed9ng ph\u1ed5 bi\u1ebfn \u0111\u01b0\u1ee3c log","text":"H\u00e0nh \u0111\u1ed9ng M\u00f4 t\u1ea3 Ngu\u1ed3n <code>user.created</code> Ng\u01b0\u1eddi d\u00f9ng m\u1edbi \u0111\u01b0\u1ee3c t\u1ea1o user-service <code>user.login.success</code> \u0110\u0103ng nh\u1eadp th\u00e0nh c\u00f4ng auth-service <code>role.updated</code> Thay \u0111\u1ed5i role ho\u1eb7c permission user-service <code>template.deleted</code> Xo\u00e1 m\u1eabu b\u00e1o c\u00e1o / c\u1ea5u h\u00ecnh reporting-service <code>notification.sent</code> G\u1eedi email/SMS th\u00e0nh c\u00f4ng notification-service <code>tenant.created</code> T\u1ea1o m\u1edbi tenant sms-service"},{"location":"services/audit-logging-service/design/#5-tuong-tac-voi-cac-service-khac-luong-su-kien","title":"5. \ud83d\udce3 T\u01b0\u01a1ng t\u00e1c v\u1edbi c\u00e1c Service kh\u00e1c &amp; Lu\u1ed3ng s\u1ef1 ki\u1ec7n","text":"<p>Audit Logging Service (ALS) ho\u1ea1t \u0111\u1ed9ng nh\u01b0 m\u1ed9t d\u1ecbch v\u1ee5 th\u1ee5 \u0111\u1ed9ng (passive listener), ch\u1ee7 y\u1ebfu ti\u00eau th\u1ee5 s\u1ef1 ki\u1ec7n ho\u1eb7c nh\u1eadn l\u1ec7nh ghi log t\u1eeb c\u00e1c core service kh\u00e1c.</p> <p>M\u1eb7c \u0111\u1ecbnh, ALS kh\u00f4ng ph\u00e1t sinh s\u1ef1 ki\u1ec7n th\u1ee9 c\u1ea5p, tuy nhi\u00ean trong c\u00e1c m\u00f4i tr\u01b0\u1eddng ph\u00e2n t\u00edch ho\u1eb7c t\u00edch h\u1ee3p n\u00e2ng cao, n\u00f3 c\u00f3 th\u1ec3 ph\u00e1t s\u1ef1 ki\u1ec7n <code>audit_log_persisted.v1</code> t\u1edbi c\u00e1c topic n\u1ed9i b\u1ed9 \u0111\u1ec3 ph\u1ee5c v\u1ee5 h\u1ec7 th\u1ed1ng downstream (e.g. th\u1ed1ng k\u00ea realtime, x\u1eed l\u00fd batch).</p> <p>\ud83e\udded M\u1ecdi t\u01b0\u01a1ng t\u00e1c ch\u00ednh v\u1eabn l\u00e0 one-way ingestion t\u1eeb b\u00ean ngo\u00e0i \u2192 ALS \u2192 BigQuery/Firestore.</p>"},{"location":"services/audit-logging-service/design/#51-tuong-tac-ong-bo-http","title":"5.1. \ud83d\udd01 T\u01b0\u01a1ng t\u00e1c \u0111\u1ed3ng b\u1ed9 (HTTP)","text":""},{"location":"services/audit-logging-service/design/#ingestion-noi-bo","title":"\u2705 Ingestion n\u1ed9i b\u1ed9","text":"<ul> <li>C\u00e1c service c\u00f3 th\u1ec3 g\u1ecdi tr\u1ef1c ti\u1ebfp endpoint <code>POST /audit-log</code> (n\u1ed9i b\u1ed9) khi mu\u1ed1n ghi log ngay l\u1eadp t\u1ee9c, \u0111i k\u00e8m trace ID.</li> <li>C\u01a1 ch\u1ebf n\u00e0y th\u01b0\u1eddng d\u00f9ng cho c\u00e1c admin tool, h\u1ec7 th\u1ed1ng batch import, ho\u1eb7c khi kh\u00f4ng t\u00edch h\u1ee3p Pub/Sub.</li> </ul> Service G\u1ecdi Endpoint Ghi ch\u00fa <code>user-service</code> <code>POST /audit-log</code> Khi c\u1eadp nh\u1eadt role, x\u00f3a user <code>auth-service/sub</code> <code>POST /audit-log</code> Ghi nh\u1eadn \u0111\u0103ng nh\u1eadp qua OTP <code>reporting-service</code> <code>POST /audit-log</code> Ghi nh\u1eadn h\u00e0nh vi truy xu\u1ea5t b\u00e1o c\u00e1o"},{"location":"services/audit-logging-service/design/#bao-mat-http","title":"\ud83d\udd10 B\u1ea3o m\u1eadt HTTP","text":"<ul> <li>T\u1ea5t c\u1ea3 request ph\u1ea3i \u0111i qua API Gateway.</li> <li>Y\u00eau c\u1ea7u JWT ch\u1ee9a scope <code>audit.write</code>.</li> <li>Ki\u1ec3m tra <code>x-tenant-id</code> v\u00e0 RBAC (n\u1ebfu c\u1ea7n).</li> </ul>"},{"location":"services/audit-logging-service/design/#52-lang-nghe-su-kien-pubsub","title":"5.2. \ud83d\udce5 L\u1eafng nghe s\u1ef1 ki\u1ec7n (Pub/Sub)","text":"<p>ALS l\u00e0 consumer ch\u00ednh c\u1ee7a topic <code>audit.events.v1</code> tr\u00ean Pub/Sub.</p> Topic Schema M\u00f4 t\u1ea3 <code>audit.events.v1</code> <code>vas.&lt;domain&gt;.&lt;event&gt;.v1</code> C\u00e1c s\u1ef1 ki\u1ec7n h\u00e0nh \u0111\u1ed9ng do c\u00e1c service ph\u00e1t h\u00e0nh"},{"location":"services/audit-logging-service/design/#vi-du-su-kien-tiep-nhan","title":"V\u00ed d\u1ee5 s\u1ef1 ki\u1ec7n ti\u1ebfp nh\u1eadn:","text":"<pre><code>{\n  \"event\": \"vas.user.updated.v1\",\n  \"tenant_id\": \"t_1234\",\n  \"trace_id\": \"abc-xyz\",\n  \"actor_user_id\": \"u_789\",\n  \"resource_type\": \"user\",\n  \"resource_id\": \"u_456\",\n  \"action\": \"update\",\n  \"payload_before\": {...},\n  \"payload_after\": {...},\n  ...\n}\n</code></pre>"},{"location":"services/audit-logging-service/design/#service-phat-su-kien-audit","title":"Service ph\u00e1t s\u1ef1 ki\u1ec7n audit:","text":"Service Ngu\u1ed3n S\u1ef1 ki\u1ec7n ti\u00eau bi\u1ec3u <code>user-service</code> <code>vas.user.created.v1</code>, <code>vas.role.updated.v1</code> <code>auth-service/master</code> <code>vas.auth.login_success.v1</code> <code>notification-service/sub</code> <code>vas.notification.sent.v1</code> <code>reporting-service</code> <code>vas.report.query_executed.v1</code> <code>api-gateway</code> <code>vas.api.request.audit.v1</code> (n\u1ebfu b\u1eadt logging to\u00e0n c\u1ee5c)"},{"location":"services/audit-logging-service/design/#53-phat-su-kien-thu-cap-tuy-chon","title":"5.3. \ud83d\udce4 Ph\u00e1t s\u1ef1 ki\u1ec7n th\u1ee9 c\u1ea5p (t\u00f9y ch\u1ecdn)","text":"<p>Audit Logging Service c\u00f3 th\u1ec3 ph\u00e1t s\u1ef1 ki\u1ec7n <code>vas.audit.persisted.v1</code> sau khi m\u1ed9t b\u1ea3n ghi log \u0111\u01b0\u1ee3c l\u01b0u th\u00e0nh c\u00f4ng, nh\u1eb1m ph\u1ee5c v\u1ee5 c\u00e1c h\u1ec7 th\u1ed1ng downstream nh\u01b0:</p> <ul> <li>ETL pipeline ho\u1eb7c AI analytics</li> <li>Alerting / Data Lake indexing</li> <li>Realtime security event bus</li> </ul> <p>\ud83d\udd12 T\u00ednh n\u0103ng n\u00e0y hi\u1ec7n \u0111ang \u0111\u01b0\u1ee3c t\u1eaft trong production. Ph\u00e1t s\u1ef1 ki\u1ec7n \u0111\u01b0\u1ee3c \u0111i\u1ec1u khi\u1ec3n b\u1edfi c\u1ea5u h\u00ecnh:</p> <pre><code>emit_audit_event_enabled: false\naudit_event_topic: audit.log.persisted.v1\n</code></pre> <p>Vi\u1ec7c ph\u00e1t s\u1ef1 ki\u1ec7n kh\u00f4ng \u1ea3nh h\u01b0\u1edfng lu\u1ed3ng x\u1eed l\u00fd ch\u00ednh, kh\u00f4ng y\u00eau c\u1ea7u ACK t\u1eeb ph\u00eda downstream, v\u00e0 ch\u1ec9 th\u1ef1c hi\u1ec7n n\u1ebfu c\u1ea5u h\u00ecnh b\u1eadt.</p>"},{"location":"services/audit-logging-service/design/#vi-du-payload","title":"\ud83d\udce6 V\u00ed d\u1ee5 payload:","text":"<pre><code>{\n  \"event\": \"vas.audit.persisted.v1\",\n  \"id\": \"log_abc123\",\n  \"tenant_id\": \"vas-sch-01\",\n  \"timestamp\": \"2025-06-14T08:00:00Z\",\n  \"source_service\": \"user-service\",\n  \"action\": \"delete\"\n}\n</code></pre>"},{"location":"services/audit-logging-service/design/#6-bao-mat-phan-quyen","title":"6. \ud83d\udd10 B\u1ea3o m\u1eadt &amp; Ph\u00e2n quy\u1ec1n","text":"<p>Audit Logging Service x\u1eed l\u00fd d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m v\u00e0 quan tr\u1ecdng, n\u00ean ph\u1ea3i tu\u00e2n th\u1ee7 nghi\u00eam ng\u1eb7t c\u00e1c chi\u1ebfn l\u01b0\u1ee3c x\u00e1c th\u1ef1c, ph\u00e2n quy\u1ec1n v\u00e0 b\u1ea3o v\u1ec7 d\u1eef li\u1ec7u theo to\u00e0n h\u1ec7 th\u1ed1ng. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c l\u1edbp b\u1ea3o m\u1eadt ch\u00ednh:</p>"},{"location":"services/audit-logging-service/design/#61-xac-thuc-authentication","title":"6.1. \ud83d\udd11 X\u00e1c th\u1ef1c (Authentication)","text":"<ul> <li>T\u1ea5t c\u1ea3 c\u00e1c endpoint c\u1ee7a ALS \u0111\u1ec1u y\u00eau c\u1ea7u x\u00e1c th\u1ef1c JWT h\u1ee3p l\u1ec7.</li> <li>Token ph\u1ea3i \u0111\u01b0\u1ee3c ph\u00e1t h\u00e0nh b\u1edfi h\u1ec7 th\u1ed1ng <code>auth-service</code> (master ho\u1eb7c sub), tu\u00e2n th\u1ee7 <code>ADR-006</code>.</li> <li>Token b\u1eaft bu\u1ed9c ch\u1ee9a c\u00e1c claims:</li> <li><code>sub</code>: \u0111\u1ecbnh danh ng\u01b0\u1eddi d\u00f9ng/service</li> <li><code>aud</code>: <code>api.truongvietanh.edu.vn</code></li> <li><code>x-tenant-id</code>: ID c\u1ee7a tenant \u0111ang thao t\u00e1c</li> <li>\u0110\u1ed1i v\u1edbi Pub/Sub consumer, x\u00e1c th\u1ef1c \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n qua IAM binding gi\u1eefa ALS v\u00e0 Pub/Sub service account.</li> </ul>"},{"location":"services/audit-logging-service/design/#62-phan-quyen-authorization-rbac","title":"6.2. \ud83e\udded Ph\u00e2n quy\u1ec1n (Authorization \u2013 RBAC)","text":"<p>Audit Logging Service th\u1ef1c thi RBAC \u1edf 2 m\u1ee9c:</p>"},{"location":"services/audit-logging-service/design/#khi-ghi-log-write","title":"\ud83d\udce5 Khi ghi log (write)","text":"<ul> <li>Pub/Sub: ch\u1ec9 x\u1eed l\u00fd log \u0111\u1ebfn t\u1eeb topic <code>audit.events.v1</code> \u0111\u00e3 \u0111\u0103ng k\u00fd, kh\u00f4ng y\u00eau c\u1ea7u RBAC.</li> <li>HTTP API: y\u00eau c\u1ea7u scope <code>audit.write</code>. Ch\u1ec9 d\u00e0nh cho call n\u1ed9i b\u1ed9 (c\u00f3 ki\u1ec3m tra <code>x-internal-request: true</code>).</li> </ul>"},{"location":"services/audit-logging-service/design/#khi-truy-van-log-read","title":"\ud83d\udce4 Khi truy v\u1ea5n log (read)","text":"<ul> <li>B\u1eaft bu\u1ed9c c\u00f3 scope <code>audit.read</code>.</li> <li>Th\u1ef1c hi\u1ec7n ph\u00e2n quy\u1ec1n theo template RBAC nh\u01b0 sau:</li> </ul> Resource Action \u0110i\u1ec1u ki\u1ec7n b\u1eaft bu\u1ed9c <code>audit_log_entry</code> <code>read</code> <code>tenant_id == {{X-Tenant-ID}}</code> <ul> <li>C\u00e1c field trong log nh\u01b0 <code>actor_user_id</code>, <code>payload_*</code>, <code>input_parameters</code> s\u1ebd \u0111\u01b0\u1ee3c mask \u0111\u1ed9ng n\u1ebfu ng\u01b0\u1eddi g\u1ecdi kh\u00f4ng c\u00f3 quy\u1ec1n cao (e.g. kh\u00f4ng ph\u1ea3i Superadmin ho\u1eb7c TenantAdmin).</li> </ul>"},{"location":"services/audit-logging-service/design/#63-bao-ve-du-lieu-data-protection","title":"6.3. \ud83d\udd12 B\u1ea3o v\u1ec7 d\u1eef li\u1ec7u (Data Protection)","text":"<ul> <li>M\u1ecdi b\u1ea3n ghi log \u0111\u1ec1u \u0111\u01b0\u1ee3c m\u00e3 ho\u00e1 \u1edf tr\u1ea1ng th\u00e1i l\u01b0u tr\u1eef:</li> <li>BigQuery: s\u1eed d\u1ee5ng encryption m\u1eb7c \u0111\u1ecbnh ho\u1eb7c CMEK theo <code>ADR-005</code></li> <li>Firestore (n\u1ebfu d\u00f9ng): t\u1ef1 \u0111\u1ed9ng m\u00e3 ho\u00e1 theo GCP</li> <li>D\u1eef li\u1ec7u truy\u1ec1n qua HTTP \u0111\u1ec1u s\u1eed d\u1ee5ng HTTPS (TLS 1.3)</li> <li>Tr\u01b0\u1eddng nh\u1ea1y c\u1ea3m (PII) nh\u01b0 <code>ip_address</code>, <code>user_agent</code>, <code>payload_*</code> \u0111\u1ec1u \u0111\u01b0\u1ee3c x\u1eed l\u00fd theo <code>ADR-024</code>:</li> <li>Mask c\u1ed1 \u0111\u1ecbnh ho\u1eb7c b\u1eb1ng SHA256</li> <li>X\u00e1c \u0111\u1ecbnh field c\u1ea7n \u1ea9n b\u1eb1ng c\u1ea5u h\u00ecnh ho\u1eb7c pattern</li> </ul>"},{"location":"services/audit-logging-service/design/#64-giam-sat-va-bao-ve-runtime","title":"6.4. \ud83d\udea8 Gi\u00e1m s\u00e1t v\u00e0 b\u1ea3o v\u1ec7 runtime","text":"<ul> <li>T\u00edch h\u1ee3p OpenTelemetry \u0111\u1ec3 trace to\u00e0n b\u1ed9 request \u2192 ghi log \u2192 l\u01b0u tr\u1eef</li> <li>Ghi log m\u1ecdi request b\u1ecb t\u1eeb ch\u1ed1i truy c\u1eadp ho\u1eb7c vi ph\u1ea1m quy\u1ec1n</li> <li>C\u00f3 c\u1ea3nh b\u00e1o n\u1ebfu ph\u00e1t hi\u1ec7n truy v\u1ea5n v\u01b0\u1ee3t gi\u1edbi h\u1ea1n tenant, sai scope ho\u1eb7c l\u1eb7p l\u1ea1i b\u1ea5t th\u01b0\u1eddng</li> </ul>"},{"location":"services/audit-logging-service/design/#7-cau-hinh-trien-khai-configuration-deployment","title":"7. \u2699\ufe0f C\u1ea5u h\u00ecnh &amp; Tri\u1ec3n khai (Configuration &amp; Deployment)","text":"<p>Audit Logging Service (ALS) \u0111\u01b0\u1ee3c tri\u1ec3n khai nh\u01b0 m\u1ed9t d\u1ecbch v\u1ee5 \u0111\u1ed9c l\u1eadp trong Core Stack c\u1ee7a h\u1ec7 th\u1ed1ng <code>dx-vas</code>. M\u1ee5c ti\u00eau l\u00e0 \u0111\u1ea3m b\u1ea3o kh\u1ea3 n\u0103ng ho\u1ea1t \u0111\u1ed9ng \u1ed5n \u0111\u1ecbnh, t\u00e1ch bi\u1ec7t tenant, b\u1ea3o m\u1eadt cao v\u00e0 d\u1ec5 d\u00e0ng m\u1edf r\u1ed9ng khi l\u01b0\u1ee3ng log t\u0103ng.</p>"},{"location":"services/audit-logging-service/design/#71-mo-hinh-trien-khai","title":"7.1. \ud83e\uddf1 M\u00f4 h\u00ecnh tri\u1ec3n khai","text":"<ul> <li>N\u1ec1n t\u1ea3ng: Google Cloud Run</li> <li>M\u00f4i tr\u01b0\u1eddng: <code>staging</code>, <code>production</code>, <code>sandbox</code> (tu\u00e2n th\u1ee7 <code>ADR-017</code>)</li> <li>V\u00f9ng tri\u1ec3n khai: <code>asia-southeast1</code> (m\u1eb7c \u0111\u1ecbnh), c\u00f3 th\u1ec3 m\u1edf r\u1ed9ng multi-region</li> <li>IAM binding: ch\u1ec9 cho ph\u00e9p service account t\u1eeb <code>core</code> services g\u1ecdi API ho\u1eb7c push Pub/Sub</li> </ul>"},{"location":"services/audit-logging-service/design/#72-bien-moi-truong-chinh-tuan-theo-adr-005","title":"7.2. \u2699\ufe0f Bi\u1ebfn m\u00f4i tr\u01b0\u1eddng ch\u00ednh (Tu\u00e2n theo ADR-005)","text":"T\u00ean bi\u1ebfn M\u00f4 t\u1ea3 V\u00ed d\u1ee5 <code>LOG_RETENTION_DAYS</code> S\u1ed1 ng\u00e0y l\u01b0u log tr\u01b0\u1edbc khi xo\u00e1 (n\u1ebfu b\u1eadt auto-delete) <code>365</code> <code>AUDIT_STORAGE_BACKEND</code> L\u1ef1a ch\u1ecdn backend l\u01b0u log (<code>bigquery</code> / <code>firestore</code>) <code>bigquery</code> <code>ENABLE_PII_MASKING</code> B\u1eadt/T\u1eaft ch\u1ee9c n\u0103ng \u1ea9n danh d\u1eef li\u1ec7u \u0111\u1ea7u v\u00e0o <code>true</code> <code>PUBSUB_SUBSCRIPTION_ID</code> ID subscription c\u1ee7a <code>audit.events.v1</code> <code>audit-events-sub</code> <code>PROJECT_ID</code> GCP project code ch\u1ee9a BigQuery dataset <code>vas-core</code>"},{"location":"services/audit-logging-service/design/#73-trien-khai-cicd-tuan-thu-adr-001-adr-014","title":"7.3. \ud83d\ude80 Tri\u1ec3n khai CI/CD (Tu\u00e2n th\u1ee7 ADR-001 &amp; ADR-014)","text":"<ul> <li>M\u1ed7i l\u1ea7n commit v\u00e0o nh\u00e1nh <code>main</code> s\u1ebd trigger pipeline build v\u00e0 deploy (zero-downtime).</li> <li>S\u1eed d\u1ee5ng <code>canary deployment</code> cho m\u00f4i tr\u01b0\u1eddng <code>staging</code>.</li> <li>Smoke test ki\u1ec3m tra sau khi tri\u1ec3n khai: g\u1eedi audit log m\u1eabu, ki\u1ec3m tra kh\u1ea3 n\u0103ng l\u01b0u v\u00e0 truy v\u1ea5n.</li> </ul>"},{"location":"services/audit-logging-service/design/#74-chien-luoc-autoscaling-adr-016","title":"7.4. \ud83d\udcc8 Chi\u1ebfn l\u01b0\u1ee3c Autoscaling (ADR-016)","text":"<ul> <li>Min instances: <code>1</code> (\u0111\u1ea3m b\u1ea3o cold start th\u1ea5p)</li> <li>Max instances: <code>10</code> (c\u1ea5u h\u00ecnh ban \u0111\u1ea7u, c\u00f3 th\u1ec3 m\u1edf r\u1ed9ng)</li> <li>Scaling policy: theo QPS ho\u1eb7c CPU threshold &gt; 60%</li> <li>Pub/Sub consumer c\u00f3 th\u1ec3 t\u00e1ch container ri\u00eang n\u1ebfu c\u1ea7n scale \u0111\u1ed9c l\u1eadp</li> </ul>"},{"location":"services/audit-logging-service/design/#75-luu-tru-quan-ly-du-lieu-adr-027","title":"7.5. \ud83d\udce6 L\u01b0u tr\u1eef &amp; Qu\u1ea3n l\u00fd d\u1eef li\u1ec7u (ADR-027)","text":"<ul> <li>Primary storage: BigQuery, ph\u00e2n v\u00f9ng theo <code>timestamp</code>, clustering theo <code>tenant_id</code></li> <li>Backup / Archive: c\u00f3 th\u1ec3 b\u1eadt l\u01b0u song song sang Firestore ho\u1eb7c GCS coldline bucket</li> <li>Retention: ch\u1ea1y cron job h\u00e0ng ng\u00e0y \u0111\u1ec3 xo\u00e1 log c\u0169 v\u01b0\u1ee3t <code>LOG_RETENTION_DAYS</code></li> </ul>"},{"location":"services/audit-logging-service/design/#76-chinh-sach-xoa-du-lieu-hard-delete","title":"7.6. \ud83d\udccc Ch\u00ednh s\u00e1ch xo\u00e1 d\u1eef li\u1ec7u (Hard Delete)","text":"<p>Tu\u00e2n th\u1ee7 <code>ADR-026</code>, ALS s\u1eed d\u1ee5ng ch\u00ednh s\u00e1ch: - Hard delete d\u1eef li\u1ec7u khi v\u01b0\u1ee3t th\u1eddi gian retention - Xo\u00e1 theo batch nh\u1ecf, ghi log m\u1ed7i l\u1ea7n x\u00f3a - Kh\u00f4ng h\u1ed7 tr\u1ee3 xo\u00e1 selective th\u1ee7 c\u00f4ng (tr\u1eeb khi c\u00f3 y\u00eau c\u1ea7u audit n\u1ed9i b\u1ed9 v\u1edbi policy ri\u00eang)</p>"},{"location":"services/audit-logging-service/design/#77-cau-hinh-lien-quan-en-phat-su-kien","title":"7.7. C\u1ea5u h\u00ecnh li\u00ean quan \u0111\u1ebfn ph\u00e1t s\u1ef1 ki\u1ec7n","text":"<pre><code># config.yaml\n\nemit_audit_event_enabled: false         # B\u1eadt ph\u00e1t event th\u1ee9 c\u1ea5p `audit_log_persisted.v1`\naudit_event_topic: audit.log.persisted.v1  # T\u00ean topic ph\u00e1t s\u1ef1 ki\u1ec7n\n</code></pre> <p>\ud83d\udccc L\u01b0u \u00fd: T\u00ednh n\u0103ng ph\u00e1t s\u1ef1 ki\u1ec7n th\u1ee9 c\u1ea5p hi\u1ec7n ch\u01b0a \u0111\u01b0\u1ee3c b\u1eadt trong m\u00f4i tr\u01b0\u1eddng production.   Ch\u1ec9 n\u00ean k\u00edch ho\u1ea1t khi \u0111\u00e3 c\u00f3 h\u1ec7 th\u1ed1ng downstream ti\u1ebfp nh\u1eadn v\u00e0 ki\u1ec3m so\u00e1t volume event ph\u00e1t sinh.</p>"},{"location":"services/audit-logging-service/design/#8-chien-luoc-kiem-thu-testing-strategy","title":"8. \ud83e\uddea Chi\u1ebfn l\u01b0\u1ee3c Ki\u1ec3m th\u1eed (Testing Strategy)","text":"<p>Audit Logging Service \u0111\u00f3ng vai tr\u00f2 trung t\u00e2m trong vi\u1ec7c ghi nh\u1eadn v\u00e0 b\u1ea3o v\u1ec7 h\u00e0nh vi c\u1ee7a h\u1ec7 th\u1ed1ng. Do \u0111\u00f3, chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed ph\u1ea3i \u0111\u1ea3m b\u1ea3o t\u00ednh \u0111\u00fang \u0111\u1eafn, an to\u00e0n, v\u00e0 tin c\u1eady c\u1ee7a m\u1ed7i b\u1ea3n ghi audit, trong m\u1ecdi \u0111i\u1ec1u ki\u1ec7n t\u1ea3i v\u00e0 m\u00f4i tr\u01b0\u1eddng v\u1eadn h\u00e0nh.</p>"},{"location":"services/audit-logging-service/design/#81-unit-tests","title":"8.1. \u2705 Unit Tests","text":"Th\u00e0nh ph\u1ea7n N\u1ed9i dung ki\u1ec3m th\u1eed Schema Validator Ki\u1ec3m tra t\u00ednh h\u1ee3p l\u1ec7 c\u1ee7a payload theo <code>ADR-008</code> PII Masker X\u00e1c minh d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m \u0111\u01b0\u1ee3c \u1ea9n \u0111\u00fang c\u00e1ch Query Filter Builder Ki\u1ec3m tra logic l\u1ecdc theo <code>actor_id</code>, <code>tenant_id</code>, <code>trace_id</code>, etc. JWT Claims Parser Ki\u1ec3m tra c\u00e1c tr\u01b0\u1eddng <code>sub</code>, <code>aud</code>, <code>tenant_id</code> \u0111\u01b0\u1ee3c tr\u00edch xu\u1ea5t ch\u00ednh x\u00e1c <p>\u2705 Y\u00eau c\u1ea7u \u0111\u1ed9 bao ph\u1ee7 test \u2265 90% cho core logic (<code>mask</code>, <code>validate</code>, <code>store</code>).</p>"},{"location":"services/audit-logging-service/design/#82-integration-tests","title":"8.2. \ud83d\udd01 Integration Tests","text":"Lu\u1ed3ng Ki\u1ec3m th\u1eed G\u1eedi log HTTP \u2192 l\u01b0u G\u1eedi request ghi log, x\u00e1c minh log t\u1ed3n t\u1ea1i trong BigQuery Nh\u1eadn log t\u1eeb Pub/Sub \u2192 l\u01b0u G\u1eedi message test v\u00e0o topic <code>audit.events.v1</code>, x\u00e1c minh l\u01b0u th\u00e0nh c\u00f4ng Truy v\u1ea5n log G\u1ecdi <code>GET /audit-log</code>, ki\u1ec3m tra ph\u00e2n trang, l\u1ecdc, v\u00e0 RBAC Truy c\u1eadp sai scope G\u1eedi request t\u1eeb ng\u01b0\u1eddi d\u00f9ng kh\u00f4ng c\u00f3 quy\u1ec1n, ki\u1ec3m tra l\u1ed7i 403"},{"location":"services/audit-logging-service/design/#83-contract-testing-adr-010","title":"8.3. \ud83e\udd1d Contract Testing (ADR-010)","text":"Th\u00e0nh ph\u1ea7n M\u00f4 t\u1ea3 HTTP API Ki\u1ec3m tra b\u1eb1ng Pactflow \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o h\u1ee3p \u0111\u1ed3ng gi\u1eefa ALS v\u00e0 c\u00e1c client (e.g. reporting-service, admin UI) kh\u00f4ng b\u1ecb ph\u00e1 v\u1ee1 Pub/Sub Schema D\u00f9ng JSON Schema Registry ho\u1eb7c Spectral \u0111\u1ec3 x\u00e1c th\u1ef1c c\u1ea5u tr\u00fac <code>audit.*.v1</code> theo <code>ADR-030</code> <p>\u2705 M\u1ed7i consumer service s\u1ebd c\u00f3 b\u1ea3n h\u1ee3p \u0111\u1ed3ng ri\u00eang \u0111\u1ec3 m\u00f4 ph\u1ecfng d\u1eef li\u1ec7u g\u1eedi v\u00e0 assert k\u1ebft qu\u1ea3 mong \u0111\u1ee3i.</p>"},{"location":"services/audit-logging-service/design/#84-load-testing-resilience","title":"8.4. \ud83d\udcca Load Testing &amp; Resilience","text":"<ul> <li>D\u00f9ng Locust ho\u1eb7c k6 \u0111\u1ec3 ki\u1ec3m tra:</li> <li>Kh\u1ea3 n\u0103ng x\u1eed l\u00fd 1000\u201310000 log/gi\u00e2y (qua HTTP + Pub/Sub)</li> <li>\u0110\u1ed9 tr\u1ec5 trung b\u00ecnh v\u00e0 P95/P99 d\u01b0\u1edbi 300ms</li> <li>Kh\u1ea3 n\u0103ng scale theo policy Cloud Run (<code>ADR-016</code>)</li> <li>M\u00f4 ph\u1ecfng l\u1ed7i BigQuery t\u1ea1m th\u1eddi \u0111\u1ec3 ki\u1ec3m tra fallback ho\u1eb7c retry logic</li> </ul>"},{"location":"services/audit-logging-service/design/#85-security-testing","title":"8.5. \ud83d\udd10 Security Testing","text":"<ul> <li>Fuzz test tr\u01b0\u1eddng <code>payload_*</code> \u0111\u1ec3 ki\u1ec3m tra l\u1ed7 h\u1ed5ng x\u1eed l\u00fd JSON</li> <li>Ki\u1ec3m tra b\u1ea3o v\u1ec7 field <code>tenant_id</code>, kh\u00f4ng \u0111\u1ec3 user truy c\u1eadp ch\u00e9o tenant</li> <li>Ki\u1ec3m tra injection ho\u1eb7c bypass th\u00f4ng qua tr\u01b0\u1eddng <code>user_agent</code>, <code>trace_id</code></li> </ul>"},{"location":"services/audit-logging-service/design/#86-regression-testing-ci-automation","title":"8.6. \ud83d\udd01 Regression Testing &amp; CI Automation","text":"<ul> <li>T\u00edch h\u1ee3p to\u00e0n b\u1ed9 test suite v\u00e0o pipeline GitHub Actions</li> <li>M\u1ed7i PR b\u1eaft bu\u1ed9c pass to\u00e0n b\u1ed9 test tr\u01b0\u1edbc khi deploy staging</li> <li>Truy v\u1ebft l\u1ed7i v\u00e0 coverage v\u1edbi badge trong README repo</li> </ul>"},{"location":"services/audit-logging-service/design/#9-observability-monitoring","title":"9. \ud83d\udd0d Observability &amp; Monitoring","text":"<p>Audit Logging Service (ALS) l\u00e0 th\u00e0nh ph\u1ea7n tr\u1ecdng y\u1ebfu v\u1ec1 b\u1ea3o m\u1eadt v\u00e0 truy v\u1ebft, do \u0111\u00f3 ph\u1ea3i c\u00f3 kh\u1ea3 n\u0103ng quan s\u00e1t v\u00e0 gi\u00e1m s\u00e1t to\u00e0n di\u1ec7n \u1edf c\u1ea5p \u0111\u1ed9 h\u1ec7 th\u1ed1ng, \u1ee9ng d\u1ee5ng v\u00e0 h\u00e0nh vi d\u1eef li\u1ec7u. Thi\u1ebft k\u1ebf observability c\u1ee7a ALS tu\u00e2n th\u1ee7 <code>ADR-021</code> v\u00e0 \u0111\u01b0\u1ee3c tri\u1ec3n khai theo 4 l\u1edbp: logging, metrics, tracing v\u00e0 alerting.</p>"},{"location":"services/audit-logging-service/design/#91-logging-nhat-ky-dich-vu","title":"9.1. \ud83d\udcc4 Logging (Nh\u1eadt k\u00fd d\u1ecbch v\u1ee5)","text":"<ul> <li>To\u00e0n b\u1ed9 log h\u1ec7 th\u1ed1ng v\u00e0 \u1ee9ng d\u1ee5ng \u0111\u1ec1u \u0111\u01b0\u1ee3c ghi \u1edf \u0111\u1ecbnh d\u1ea1ng structured JSON.</li> <li>C\u00e1c tr\u01b0\u1eddng b\u1eaft bu\u1ed9c trong m\u1ed7i d\u00f2ng log:</li> <li><code>timestamp</code>, <code>trace_id</code>, <code>tenant_id</code>, <code>actor_user_id</code>, <code>action</code>, <code>status</code>, <code>duration_ms</code></li> <li>C\u00e1c t\u00ecnh hu\u1ed1ng log:</li> <li>Log ti\u1ebfp nh\u1eadn th\u00e0nh c\u00f4ng s\u1ef1 ki\u1ec7n audit</li> <li>Log t\u1eeb ch\u1ed1i do vi ph\u1ea1m RBAC ho\u1eb7c thi\u1ebfu JWT</li> <li>Log l\u1ed7i ghi d\u1eef li\u1ec7u xu\u1ed1ng BigQuery</li> <li>Log masking tr\u01b0\u1eddng PII (k\u00e8m c\u00e1c tr\u01b0\u1eddng \u0111\u00e3 b\u1ecb mask)</li> </ul> <p>\u2705 T\u1ea5t c\u1ea3 log \u0111\u01b0\u1ee3c g\u1eedi v\u1ec1 Cloud Logging (Stackdriver) v\u00e0 c\u00f3 th\u1ec3 xu\u1ea5t sang BigQuery \u0111\u1ec3 ph\u00e2n t\u00edch s\u00e2u.</p>"},{"location":"services/audit-logging-service/design/#92-metrics-giam-sat-hieu-nang-so-luong","title":"9.2. \ud83d\udcc8 Metrics (Gi\u00e1m s\u00e1t hi\u1ec7u n\u0103ng &amp; s\u1ed1 l\u01b0\u1ee3ng)","text":"<p>Audit Logging Service xu\u1ea5t c\u00e1c ch\u1ec9 s\u1ed1 Prometheus ti\u00eau chu\u1ea9n \u0111\u1ec3 theo d\u00f5i hi\u1ec7u n\u0103ng v\u00e0 \u0111\u1ed9 \u1ed5n \u0111\u1ecbnh:</p> T\u00ean metric Nh\u00e3n M\u00f4 t\u1ea3 <code>auditlog_ingest_total</code> <code>source</code>, <code>status</code> S\u1ed1 l\u01b0\u1ee3ng log ti\u1ebfp nh\u1eadn theo ngu\u1ed3n v\u00e0 tr\u1ea1ng th\u00e1i <code>auditlog_ingest_failed_total</code> <code>error_type</code> S\u1ed1 log ti\u1ebfp nh\u1eadn th\u1ea5t b\u1ea1i (e.g. schema_invalid, rbac_denied) <code>auditlog_latency_ms</code> <code>operation</code>, <code>status</code> Th\u1eddi gian x\u1eed l\u00fd ghi log v\u00e0 truy v\u1ea5n log <code>auditlog_query_count</code> <code>tenant_id</code>, <code>actor_user_id</code> S\u1ed1 l\u01b0\u1ee3t truy v\u1ea5n log qua API <code>auditlog_mask_applied_total</code> <code>field</code> S\u1ed1 l\u1ea7n \u00e1p d\u1ee5ng masking cho m\u1ed7i field nh\u1ea1y c\u1ea3m <p>\u2705 Metrics \u0111\u01b0\u1ee3c scrape \u0111\u1ecbnh k\u1ef3 v\u00e0 hi\u1ec3n th\u1ecb qua Grafana dashboard chuy\u00ean bi\u1ec7t cho audit-log.</p>"},{"location":"services/audit-logging-service/design/#93-tracing-theo-doi-hanh-trinh-request","title":"9.3. \ud83d\udd0d Tracing (Theo d\u00f5i h\u00e0nh tr\u00ecnh request)","text":"<ul> <li>ALS t\u00edch h\u1ee3p OpenTelemetry \u0111\u1ec3 trace to\u00e0n b\u1ed9 h\u00e0nh tr\u00ecnh t\u1eeb khi nh\u1eadn request \u0111\u1ebfn khi ghi log th\u00e0nh c\u00f4ng.</li> <li>M\u1ed7i request ph\u1ea3i c\u00f3 <code>trace_id</code>, v\u00e0 trace \u0111\u01b0\u1ee3c g\u1eedi \u0111\u1ebfn backend nh\u01b0 Cloud Trace ho\u1eb7c Jaeger.</li> <li>C\u00e1c span ch\u00ednh:</li> <li><code>receive_event</code></li> <li><code>validate_and_mask</code></li> <li><code>write_to_storage</code></li> <li><code>emit_persisted_event</code></li> <li><code>serve_query_result</code></li> </ul> <p>\u2705 D\u1ec5 d\u00e0ng truy v\u1ebft c\u00e1c bottleneck khi h\u1ec7 th\u1ed1ng scale l\u1edbn ho\u1eb7c khi c\u00f3 log ghi ch\u1eadm.</p>"},{"location":"services/audit-logging-service/design/#94-alerting-canh-bao-tu-ong","title":"9.4. \ud83d\udea8 Alerting (C\u1ea3nh b\u00e1o t\u1ef1 \u0111\u1ed9ng)","text":"<p>\u0110\u1ecbnh ngh\u0129a c\u1ea3nh b\u00e1o ch\u1ee7 \u0111\u1ed9ng \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o ALS v\u1eadn h\u00e0nh \u1ed5n \u0111\u1ecbnh v\u00e0 ph\u00e1t hi\u1ec7n s\u1edbm s\u1ef1 c\u1ed1:</p> C\u1ea3nh b\u00e1o \u0110i\u1ec1u ki\u1ec7n M\u1ee9c \u0111\u1ed9 L\u1ed7i ingest t\u0103ng b\u1ea5t th\u01b0\u1eddng <code>auditlog_ingest_failed_total &gt; 100</code> trong 5 ph\u00fat \u26a0\ufe0f Warning Latency t\u0103ng cao <code>auditlog_latency_ms{operation=\"write\"}</code> P95 &gt; 500ms \ud83d\udd25 Critical Kh\u00f4ng c\u00f3 log n\u00e0o trong 10 ph\u00fat <code>auditlog_ingest_total</code> = 0 \u2757 Warning Masking failed Kh\u00f4ng c\u00f3 metric <code>auditlog_mask_applied_total</code> &gt; 0 trong 1h \ud83d\udea8 Security <p>\u2705 C\u1ea3nh b\u00e1o \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh qua Cloud Monitoring Alerting ho\u1eb7c Prometheus + Alertmanager t\u00f9y m\u00f4i tr\u01b0\u1eddng.</p>"},{"location":"services/audit-logging-service/design/#10-o-tin-cay-phuc-hoi-reliability-resilience","title":"10. \ud83d\ude80 \u0110\u1ed9 tin c\u1eady &amp; Ph\u1ee5c h\u1ed3i (Reliability &amp; Resilience)","text":"<p>Audit Logging Service (ALS) \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf v\u1edbi m\u1ee5c ti\u00eau kh\u00f4ng \u0111\u00e1nh m\u1ea5t b\u1ea3n ghi n\u00e0o, ngay c\u1ea3 trong \u0111i\u1ec1u ki\u1ec7n m\u1ea1ng kh\u00f4ng \u1ed5n \u0111\u1ecbnh, l\u1ed7i h\u1ec7 th\u1ed1ng t\u1ea1m th\u1eddi, ho\u1eb7c t\u1ea3i cao b\u1ea5t ng\u1edd. Kh\u1ea3 n\u0103ng ph\u1ee5c h\u1ed3i v\u00e0 t\u1ef1 \u0111\u1ed9ng \u0111\u1ea3m b\u1ea3o t\u00ednh to\u00e0n v\u1eb9n d\u1eef li\u1ec7u l\u00e0 \u01b0u ti\u00ean h\u00e0ng \u0111\u1ea7u.</p>"},{"location":"services/audit-logging-service/design/#101-co-che-retry-thong-minh","title":"10.1. \ud83d\udd01 C\u01a1 ch\u1ebf Retry th\u00f4ng minh","text":"Lu\u1ed3ng C\u01a1 ch\u1ebf Retry HTTP Ingestion N\u1ebfu ghi BigQuery th\u1ea5t b\u1ea1i (e.g. l\u1ed7i m\u1ea1ng, quota), retry t\u1ed1i \u0111a 3 l\u1ea7n v\u1edbi backoff Pub/Sub Consumer S\u1eed d\u1ee5ng ack deadline m\u1edf r\u1ed9ng, v\u00e0 ch\u1ec9 ack khi ghi log th\u00e0nh c\u00f4ng. N\u1ebfu th\u1ea5t b\u1ea1i \u2192 t\u1ef1 \u0111\u1ed9ng redeliver sau 10s Emit s\u1ef1 ki\u1ec7n <code>audit_log_persisted.v1</code> G\u1eedi l\u1ea1i n\u1ebfu th\u1ea5t b\u1ea1i t\u1ea1m th\u1eddi, log warning n\u1ebfu fail v\u0129nh vi\u1ec5n <p>\u2705 \u0110\u1ea3m b\u1ea3o kh\u00f4ng m\u1ea5t log do l\u1ed7i t\u1ea1m th\u1eddi v\u00e0 kh\u00f4ng double-count nh\u1edd <code>id</code> duy nh\u1ea5t.</p>"},{"location":"services/audit-logging-service/design/#102-bao-ve-idempotency-chong-log-trung","title":"10.2. \ud83e\uddfe B\u1ea3o v\u1ec7 idempotency (ch\u1ed1ng log tr\u00f9ng)","text":"<ul> <li>M\u1ed7i log mang <code>id</code> duy nh\u1ea5t (UUID v4 ho\u1eb7c hash(trace_id + action))</li> <li>Khi ghi xu\u1ed1ng BigQuery/Firestore, ALS ki\u1ec3m tra t\u1ed3n t\u1ea1i <code>id</code> tr\u01b0\u1edbc khi ghi</li> <li>C\u01a1 ch\u1ebf n\u00e0y \u0111\u1ea3m b\u1ea3o:</li> <li>Tr\u00e1nh tr\u00f9ng log do retry</li> <li>Cho ph\u00e9p c\u00e1c client <code>at-least-once</code> m\u00e0 kh\u00f4ng \u1ea3nh h\u01b0\u1edfng t\u1edbi t\u00ednh to\u00e0n v\u1eb9n d\u1eef li\u1ec7u</li> </ul>"},{"location":"services/audit-logging-service/design/#103-phuc-hoi-sau-loi-he-thong","title":"10.3. \ud83e\udde0 Ph\u1ee5c h\u1ed3i sau l\u1ed7i h\u1ec7 th\u1ed1ng","text":"<ul> <li>T\u1ea5t c\u1ea3 Pub/Sub consumer \u0111\u1ec1u stateless, c\u00f3 th\u1ec3 restart kh\u00f4ng m\u1ea5t offset</li> <li>BigQuery v\u00e0 Firestore l\u00e0 managed storage v\u1edbi \u0111\u1ea3m b\u1ea3o HA/DR b\u1edfi GCP</li> <li>Trong tr\u01b0\u1eddng h\u1ee3p m\u1ea5t k\u1ebft n\u1ed1i BigQuery:</li> <li>T\u1ea1m th\u1eddi ghi v\u00e0o h\u00e0ng \u0111\u1ee3i n\u1ed9i b\u1ed9 (memory ring buffer ho\u1eb7c Firestore cache)</li> <li>Log warning \u2192 g\u1eedi alert \u2192 retry sau</li> </ul>"},{"location":"services/audit-logging-service/design/#104-kiem-thu-resilience","title":"10.4. \ud83e\uddea Ki\u1ec3m th\u1eed resilience","text":"K\u1ecbch b\u1ea3n M\u00f4 ph\u1ecfng ki\u1ec3m th\u1eed BigQuery timeout C\u1eaft m\u1ea1ng t\u1edbi BigQuery trong 30s Pub/Sub redelivery G\u1eedi duplicate event trong Pub/Sub Client retry G\u1eedi 5 request ghi log gi\u1ed1ng nhau trong 1 gi\u00e2y Process crash Kill container gi\u1eefa ch\u1eebng khi \u0111ang ghi log High load burst G\u1eedi 50k log trong 1 ph\u00fat, quan s\u00e1t P99 latency"},{"location":"services/audit-logging-service/design/#11-kien-truc-service-service-architecture-overview","title":"11. \ud83e\udde9 Ki\u1ebfn tr\u00fac Service (Service Architecture Overview)","text":"<p>Audit Logging Service (ALS) \u0111\u01b0\u1ee3c tri\u1ec3n khai d\u01b0\u1edbi d\u1ea1ng stateless microservice v\u00e0 l\u00e0 m\u1ed9t th\u00e0nh ph\u1ea7n \u0111\u1ed9c l\u1eadp trong <code>core stack</code> c\u1ee7a h\u1ec7 th\u1ed1ng <code>dx-vas</code>. Service n\u00e0y v\u1eadn h\u00e0nh theo m\u00f4 h\u00ecnh event-driven k\u1ebft h\u1ee3p REST, h\u1ed7 tr\u1ee3 ghi nh\u1eadn log \u0111a ngu\u1ed3n, \u0111a h\u00ecnh th\u1ee9c v\u00e0 \u0111\u1ea3m b\u1ea3o to\u00e0n v\u1eb9n trong m\u00f4i tr\u01b0\u1eddng multi-tenant.</p>"},{"location":"services/audit-logging-service/design/#111-so-o-kien-truc-tong-the","title":"11.1. \ud83d\uddbc S\u01a1 \u0111\u1ed3 Ki\u1ebfn tr\u00fac T\u1ed5ng th\u1ec3","text":"<pre><code>flowchart TD\n    subgraph Platform[Platform Core]\n      GW[API Gateway]\n    end\n\n    subgraph ExternalSources[External Sources]\n      UI[Admin WebApp]\n    end\n\n    subgraph CoreServices[Core Services]\n      US(UserService)\n      AS(AuthService)\n      RS(ReportingService)\n      NS(NotificationService)\n    end\n\n    subgraph ALS[\"Audit Logging Service\"]\n      ALSAPI[HTTP Ingestion API]\n      ALSPS[Pub/Sub Consumer]\n      MASK[PII Masker]\n      STORE[Storage EngineBigQuery/Firestore]\n      QUERY[Query API]\n      METRIC[Metrics Exporter]\n      TRACER[OpenTelemetry Agent]\n    end\n\n    subgraph Infra\n      PUBSUB[\"Topic: audit.events.v1\"]\n      BIGQUERY[\"BigQuery Dataset\"]\n      FIRESTORE[\"Firestore (Optional)\"]\n      PROM[Prometheus/Grafana]\n      TRACE[Cloud Trace / Jaeger]\n    end\n\n    %% Ingestion Paths\n    UI --&gt;|G\u1eedi request| GW\n    GW --&gt;|POST /audit-log| ALSAPI\n    CoreServices --&gt;|Emit audit.*.v1| PUBSUB\n    PUBSUB --&gt; ALSPS\n    ALSAPI --&gt; MASK\n    ALSPS --&gt; MASK\n    MASK --&gt; STORE\n\n    %% Storage\n    STORE --&gt; BIGQUERY\n    STORE --&gt; FIRESTORE\n\n    %% Observability\n    ALS --&gt; METRIC --&gt; PROM\n    ALS --&gt; TRACER --&gt; TRACE\n\n    %% Query\n    UI --&gt;|GET /audit-log| GW\n    GW --&gt; QUERY\n    QUERY --&gt; BIGQUERY\n</code></pre>"},{"location":"services/audit-logging-service/design/#112-ghi-chu-kien-truc","title":"11.2. \ud83d\udccc Ghi ch\u00fa Ki\u1ebfn tr\u00fac","text":"Th\u00e0nh ph\u1ea7n Vai tr\u00f2 HTTP Ingestion API Nh\u1eadn log t\u1eeb c\u00e1c service n\u1ed9i b\u1ed9 kh\u00f4ng d\u00f9ng Pub/Sub Pub/Sub Consumer X\u1eed l\u00fd s\u1ef1 ki\u1ec7n <code>audit.events.v1</code> ph\u00e1t t\u1eeb core services PII Masker \u00c1p d\u1ee5ng ch\u00ednh s\u00e1ch masking (ADR-024) tr\u01b0\u1edbc khi l\u01b0u Storage Engine Ghi log v\u00e0o BigQuery (m\u1eb7c \u0111\u1ecbnh) ho\u1eb7c Firestore Query API Cho ph\u00e9p Admin, DevOps truy v\u1ea5n log \u0111a \u0111i\u1ec1u ki\u1ec7n Observability K\u1ebft n\u1ed1i OpenTelemetry + Prometheus theo <code>ADR-021</code>"},{"location":"services/audit-logging-service/design/#113-trien-khai-dang-tach-lop","title":"11.3. \ud83c\udf10 Tri\u1ec3n khai d\u1ea1ng t\u00e1ch l\u1edbp","text":"<p>\u0110\u1ec3 t\u1ed1i \u01b0u ho\u00e1 hi\u1ec7u su\u1ea5t v\u00e0 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng, c\u00e1c th\u00e0nh ph\u1ea7n c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c t\u00e1ch ri\u00eang:</p> Module Tri\u1ec3n khai ri\u00eang? Ghi ch\u00fa HTTP API &amp; Query API \u2705 C\u00f9ng m\u1ed9t container Pub/Sub Consumer \u2705 C\u00f3 th\u1ec3 scale \u0111\u1ed9c l\u1eadp khi l\u01b0\u1ee3ng log t\u0103ng Storage Adapter \u26d4 Kh\u00f4ng c\u1ea7n t\u00e1ch (g\u1ecdi sync t\u1eeb masker) Metrics + Tracer \u26d4 D\u00f9ng sidecar ho\u1eb7c th\u01b0 vi\u1ec7n nh\u00fang"},{"location":"services/audit-logging-service/design/#12-tai-lieu-lien-quan","title":"12. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Interface Contract</li> <li>Data Model</li> <li>OpenAPI Spec</li> <li>Design</li> <li>ADR-001 CI/CD Pipeline: Quy tr\u00ecnh build, test v\u00e0 deploy d\u1ecbch v\u1ee5 ALS theo pipeline t\u1ef1 \u0111\u1ed9ng.</li> <li>ADR-003 Secrets Management: Quy tr\u00ecnh l\u01b0u tr\u1eef &amp; xoay kh\u00f3a b\u00ed m\u1eadt an to\u00e0n, \u00e1p d\u1ee5ng cho JWT signing v\u00e0 GCP credentials.</li> <li>ADR-004 Security Policy: Ch\u00ednh s\u00e1ch b\u1ea3o m\u1eadt t\u1ed5ng th\u1ec3 cho h\u1ec7 th\u1ed1ng dx-vas.</li> <li>ADR-005 Environment Config: C\u1ea5u h\u00ecnh m\u00f4i tr\u01b0\u1eddng v\u00e0 danh s\u00e1ch bi\u1ebfn m\u00f4i tr\u01b0\u1eddng c\u1ea7n thi\u1ebft cho ALS.</li> <li>ADR-006 Auth Strategy: C\u00e1ch x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng v\u00e0 service t\u01b0\u01a1ng t\u00e1c v\u1edbi Audit Logging API.</li> <li>ADR-007 RBAC Strategy: C\u01a1 ch\u1ebf ki\u1ec3m so\u00e1t quy\u1ec1n truy v\u1ea5n log theo tenant v\u00e0 vai tr\u00f2.</li> <li>ADR-008 Audit Logging: \u0110\u1ecbnh ngh\u0129a \u0111\u1ecbnh d\u1ea1ng b\u1ea3n ghi, trace ID v\u00e0 h\u00e0nh vi logging chu\u1ea9n.</li> <li>ADR-010 Contract Testing: H\u01b0\u1edbng d\u1eabn ki\u1ec3m th\u1eed h\u1ee3p \u0111\u1ed3ng API v\u00e0 Pub/Sub gi\u1eefa ALS v\u00e0 c\u00e1c client.</li> <li>ADR-014 Zero Downtime Deployment: C\u01a1 ch\u1ebf tri\u1ec3n khai kh\u00f4ng gi\u00e1n \u0111o\u1ea1n cho c\u00e1c thay \u0111\u1ed5i d\u1ecbch v\u1ee5 audit.</li> <li>ADR-015 Deployment Strategy: Chi\u1ebfn l\u01b0\u1ee3c rollout, canary v\u00e0 rollback \u00e1p d\u1ee5ng cho ALS.</li> <li>ADR-016 Auto Scaling: C\u1ea5u h\u00ecnh autoscale Cloud Run d\u1ef1a tr\u00ean QPS v\u00e0 CPU threshold.</li> <li>ADR-017 Environment Deployment Boundary: Ph\u00e2n t\u00e1ch m\u00f4i tr\u01b0\u1eddng audit gi\u1eefa staging/production.</li> <li>ADR-021 External Observability: Chi\u1ebfn l\u01b0\u1ee3c quan s\u00e1t h\u1ec7 th\u1ed1ng audit t\u1eeb b\u00ean ngo\u00e0i.</li> <li>ADR-024 Data Anonymization &amp; Retention: Masking PII v\u00e0 ch\u00ednh s\u00e1ch retention d\u1eef li\u1ec7u audit.</li> <li>ADR-026 Hard Delete Policy: Ch\u00ednh s\u00e1ch x\u00f3a v\u0129nh vi\u1ec5n d\u1eef li\u1ec7u log sau th\u1eddi gian l\u01b0u tr\u1eef.</li> <li>ADR-027 Data Management Strategy: Qu\u1ea3n l\u00fd v\u00f2ng \u0111\u1eddi d\u1eef li\u1ec7u log, ph\u00e2n v\u00f9ng v\u00e0 clustering.</li> <li>ADR-030 Event Schema Governance: Qu\u1ea3n l\u00fd schema s\u1ef1 ki\u1ec7n <code>audit.events.v1</code> cho Pub/Sub.</li> </ul>"},{"location":"services/audit-logging-service/interface-contract/","title":"\ud83d\udcd8 Audit Logging Service \u2013 Interface Contract","text":""},{"location":"services/audit-logging-service/interface-contract/#1-pham-vi-va-trach-nhiem","title":"1. \ud83d\udccc Ph\u1ea1m vi v\u00e0 Tr\u00e1ch nhi\u1ec7m","text":"<p>Audit Logging Service (ALS) l\u00e0 m\u1ed9t th\u00e0nh ph\u1ea7n n\u1eb1m trong t\u1ea7ng Core Services c\u1ee7a h\u1ec7 th\u1ed1ng dx-vas, c\u00f3 tr\u00e1ch nhi\u1ec7m:</p> <ul> <li>Thu th\u1eadp audit log t\u1eeb c\u00e1c ngu\u1ed3n n\u1ed9i b\u1ed9 th\u00f4ng qua 2 c\u01a1 ch\u1ebf:</li> <li>Giao ti\u1ebfp event-driven qua Pub/Sub (<code>audit.events.v1</code>)</li> <li>Giao ti\u1ebfp synchronous HTTP API d\u00e0nh cho c\u00e1c service kh\u00f4ng h\u1ed7 tr\u1ee3 emit event</li> <li>\u00c1p d\u1ee5ng ch\u00ednh s\u00e1ch b\u1ea3o m\u1eadt v\u00e0 masking tr\u01b0\u1edbc khi l\u01b0u log, nh\u1eb1m \u0111\u1ea3m b\u1ea3o th\u00f4ng tin nh\u1ea1y c\u1ea3m kh\u00f4ng b\u1ecb l\u1ed9 (tu\u00e2n theo <code>ADR-024</code>)</li> <li>L\u01b0u tr\u1eef b\u1ec1n v\u1eefng c\u00e1c b\u1ea3n ghi log v\u00e0o kho d\u1eef li\u1ec7u trung t\u00e2m (BigQuery ho\u1eb7c Firestore), ph\u1ee5c v\u1ee5 truy v\u1ea5n v\u00e0 ki\u1ec3m to\u00e1n</li> <li>Cung c\u1ea5p REST API ph\u00e2n quy\u1ec1n cho ph\u00e9p truy v\u1ea5n l\u1ecbch s\u1eed h\u00e0nh \u0111\u1ed9ng theo <code>tenant</code>, <code>user</code>, <code>trace</code>, ho\u1eb7c <code>resource</code></li> <li>H\u1ed7 tr\u1ee3 tracing xuy\u00ean su\u1ed1t h\u1ec7 th\u1ed1ng b\u1eb1ng c\u00e1ch li\u00ean k\u1ebft log v\u1edbi <code>trace_id</code> ph\u00e1t sinh t\u1eeb gateway ho\u1eb7c frontend</li> </ul>"},{"location":"services/audit-logging-service/interface-contract/#11-als-khong-am-nhan-cac-nhiem-vu-sau","title":"1.1. \u2705 ALS kh\u00f4ng \u0111\u1ea3m nh\u1eadn c\u00e1c nhi\u1ec7m v\u1ee5 sau:","text":"<ul> <li>Kh\u00f4ng ghi nh\u1eadn application logs (debug/error logs) \u2013 vi\u1ec7c n\u00e0y thu\u1ed9c tr\u00e1ch nhi\u1ec7m c\u1ee7a runtime environment.</li> <li>Kh\u00f4ng l\u01b0u tr\u1eef metrics ho\u1eb7c performance logs \u2013 c\u00e1c ch\u1ec9 s\u1ed1 n\u00e0y do Prometheus/Grafana x\u1eed l\u00fd.</li> <li>Kh\u00f4ng hi\u1ec3n th\u1ecb giao di\u1ec7n ng\u01b0\u1eddi d\u00f9ng \u2013 log \u0111\u01b0\u1ee3c hi\u1ec3n th\u1ecb qua Admin WebApp ho\u1eb7c c\u00e1c dashboard kh\u00e1c.</li> <li>Kh\u00f4ng ph\u1ee5c v\u1ee5 m\u1ee5c \u0111\u00edch alerting tr\u1ef1c ti\u1ebfp \u2013 nh\u01b0ng c\u00f3 th\u1ec3 t\u00edch h\u1ee3p gi\u00e1n ti\u1ebfp qua Observability Platform (<code>ADR-021</code>).</li> </ul>"},{"location":"services/audit-logging-service/interface-contract/#12-moi-lien-he-chinh","title":"1.2. \ud83e\udded M\u1ed1i li\u00ean h\u1ec7 ch\u00ednh","text":"H\u1ec7 th\u1ed1ng M\u1ee5c \u0111\u00edch t\u01b0\u01a1ng t\u00e1c API Gateway G\u1eedi log qua HTTP Ingestion API (c\u00e1c h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng qua web) Auth Service Ph\u00e1t event <code>auth.login.success</code>, <code>token.exchanged</code>, <code>otp.verified</code> User Service Ghi nh\u1eadn c\u00e1c h\u00e0nh \u0111\u1ed9ng t\u1ea1o, c\u1eadp nh\u1eadt ng\u01b0\u1eddi d\u00f9ng Admin WebApp Truy v\u1ea5n log th\u00f4ng qua API <code>/audit-log</code> Reporting Service Truy v\u1ea5n log theo <code>trace_id</code> \u0111\u1ec3 t\u1ea1o b\u00e1o c\u00e1o b\u1ea3o m\u1eadt Notification Service G\u1eedi event khi g\u1eedi/th\u1ea5t b\u1ea1i notification (<code>notification.sent</code>, <code>failed</code>)"},{"location":"services/audit-logging-service/interface-contract/#2-api-audit-log","title":"2. \ud83d\udccc API: <code>/audit-log</code>","text":"<p>C\u00e1c API cho ph\u00e9p truy v\u1ea5n c\u00e1c b\u1ea3n ghi h\u00e0nh vi \u0111\u00e3 l\u01b0u tr\u1eef trong h\u1ec7 th\u1ed1ng. T\u1ea5t c\u1ea3 c\u00e1c API y\u00eau c\u1ea7u x\u00e1c th\u1ef1c JWT, ki\u1ec3m tra quy\u1ec1n RBAC v\u00e0 r\u00e0ng bu\u1ed9c theo tenant (<code>X-Tenant-ID</code>).</p>"},{"location":"services/audit-logging-service/interface-contract/#21-get-audit-log","title":"2.1. <code>GET /audit-log</code>","text":"<p>Truy v\u1ea5n danh s\u00e1ch b\u1ea3n ghi audit log, v\u1edbi kh\u1ea3 n\u0103ng l\u1ecdc theo nhi\u1ec1u ti\u00eau ch\u00ed (user, action, th\u1eddi gian...) v\u00e0 ph\u00e2n trang.</p>"},{"location":"services/audit-logging-service/interface-contract/#request","title":"\ud83d\udce5 Request","text":"<ul> <li>Headers:</li> <li><code>Authorization: Bearer &lt;JWT&gt;</code></li> <li> <p><code>X-Tenant-ID: string</code> \u2013 Tenant hi\u1ec7n t\u1ea1i</p> </li> <li> <p>Query Parameters:</p> </li> <li><code>actor_user_id</code>: string \u2013 l\u1ecdc theo ng\u01b0\u1eddi th\u1ef1c hi\u1ec7n h\u00e0nh \u0111\u1ed9ng</li> <li><code>trace_id</code>: string \u2013 l\u1ecdc theo trace</li> <li><code>action</code>: string \u2013 l\u1ecdc theo h\u00e0nh \u0111\u1ed9ng</li> <li><code>resource_type</code>: string \u2013 lo\u1ea1i t\u00e0i nguy\u00ean li\u00ean quan (<code>user</code>, <code>tenant</code>, etc.)</li> <li><code>status</code>: <code>success</code> | <code>failure</code> | <code>warning</code></li> <li><code>from_time</code>, <code>to_time</code>: ISO 8601 timestamp</li> <li><code>page</code>, <code>page_size</code>: ph\u00e2n trang</li> </ul>"},{"location":"services/audit-logging-service/interface-contract/#response","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"data\": [\n    {\n      \"id\": \"log-abc123\",\n      \"tenant_id\": \"vas-sch-01\",\n      \"trace_id\": \"trace-xyz\",\n      \"actor_user_id\": \"user-01\",\n      \"action\": \"user.login.success\",\n      \"resource_type\": \"user\",\n      \"status\": \"success\",\n      \"created_at\": \"2025-06-14T12:00:00Z\"\n    }\n  ],\n  \"meta\": {\n    \"pagination\": {\n      \"page\": 1,\n      \"page_size\": 20,\n      \"total\": 125\n    },\n    \"request_id\": \"req-789\",\n    \"timestamp\": \"2025-06-14T12:00:01Z\"\n  },\n  \"error\": null\n}\n</code></pre>"},{"location":"services/audit-logging-service/interface-contract/#phan-quyen-ieu-kien","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"<ul> <li>Y\u00eau c\u1ea7u scope: <code>audit.read.log</code></li> <li>RBAC enforced theo condition:</li> </ul> <p><pre><code>{ \"tenant_id\": \"{{X-Tenant-ID}}\" }\n</code></pre> * Masking \u0111\u1ed9ng theo role: c\u00e1c tr\u01b0\u1eddng nh\u1ea1y c\u1ea3m nh\u01b0 <code>input_parameters</code>, <code>ip_address</code>, <code>user_agent</code> s\u1ebd b\u1ecb che n\u1ebfu kh\u00f4ng c\u00f3 quy\u1ec1n cao (e.g. <code>tenant_admin</code>)</p>"},{"location":"services/audit-logging-service/interface-contract/#su-kien-phat-ra","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li>Kh\u00f4ng c\u00f3</li> </ul>"},{"location":"services/audit-logging-service/interface-contract/#ma-loi-co-the-tra-ve","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"Code M\u00f4 t\u1ea3 <code>common.unauthorized</code> Kh\u00f4ng g\u1eedi JWT ho\u1eb7c JWT kh\u00f4ng h\u1ee3p l\u1ec7 <code>common.forbidden</code> Kh\u00f4ng c\u00f3 quy\u1ec1n <code>audit.read.log</code> ho\u1eb7c sai tenant <code>common.validation_failed</code> Tham s\u1ed1 query kh\u00f4ng h\u1ee3p l\u1ec7 (e.g. sai datetime) <code>common.internal_error</code> L\u1ed7i truy v\u1ea5n BigQuery ho\u1eb7c h\u1ec7 th\u1ed1ng gi\u00e1n \u0111o\u1ea1n"},{"location":"services/audit-logging-service/interface-contract/#goi-y-kiem-thu","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>G\u1eedi truy v\u1ea5n h\u1ee3p l\u1ec7 \u2192 nh\u1eadn log \u0111\u00fang v\u00e0 c\u00f3 ph\u00e2n trang</li> <li>G\u1eedi truy v\u1ea5n thi\u1ebfu <code>Authorization</code> \u2192 nh\u1eadn l\u1ed7i <code>common.unauthorized</code></li> <li>G\u1eedi truy v\u1ea5n sai \u0111\u1ecbnh d\u1ea1ng <code>from_time</code> \u2192 l\u1ed7i <code>common.validation_failed</code></li> <li>D\u00f9ng token \u0111\u00fang scope nh\u01b0ng sai tenant \u2192 kh\u00f4ng th\u1ea5y log ho\u1eb7c l\u1ed7i <code>common.forbidden</code></li> <li>G\u1eedi truy v\u1ea5n khi backend l\u1ed7i BigQuery \u2192 nh\u1eadn <code>common.internal_error</code></li> </ul>"},{"location":"services/audit-logging-service/interface-contract/#22-get-audit-logid","title":"2.2. <code>GET /audit-log/{id}</code>","text":"<p>L\u1ea5y chi ti\u1ebft m\u1ed9t b\u1ea3n ghi log c\u1ee5 th\u1ec3 theo ID log.</p>"},{"location":"services/audit-logging-service/interface-contract/#request_1","title":"\ud83d\udce5 Request","text":"<ul> <li> <p>Path parameter:</p> </li> <li> <p><code>id</code>: string \u2013 UUID c\u1ee7a b\u1ea3n ghi log</p> </li> <li> <p>Headers:</p> </li> <li> <p><code>Authorization: Bearer &lt;JWT&gt;</code></p> </li> <li><code>X-Tenant-ID: string</code></li> </ul>"},{"location":"services/audit-logging-service/interface-contract/#response_1","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"data\": {\n    \"id\": \"log-abc123\",\n    \"tenant_id\": \"vas-sch-01\",\n    \"trace_id\": \"trace-xyz\",\n    \"actor_user_id\": \"user-01\",\n    \"action\": \"user.login.success\",\n    \"resource_type\": \"user\",\n    \"status\": \"success\",\n    \"input_parameters\": {\n      \"email\": \"masked\",\n      \"name\": \"masked\"\n    },\n    \"ip_address\": \"masked\",\n    \"user_agent\": \"masked\",\n    \"created_at\": \"2025-06-14T12:00:00Z\"\n  },\n  \"meta\": {\n    \"request_id\": \"req-456\",\n    \"timestamp\": \"2025-06-14T12:00:01Z\"\n  },\n  \"error\": null\n}\n</code></pre>"},{"location":"services/audit-logging-service/interface-contract/#phan-quyen-ieu-kien_1","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"<ul> <li>Scope b\u1eaft bu\u1ed9c: <code>audit.read.log</code></li> <li>\u0110i\u1ec1u ki\u1ec7n RBAC:</li> </ul> <p><pre><code>{ \"tenant_id\": \"{{X-Tenant-ID}}\" }\n</code></pre> * Masking \u0111\u1ed9ng \u00e1p d\u1ee5ng nh\u01b0 tr\u00ean</p>"},{"location":"services/audit-logging-service/interface-contract/#su-kien-phat-ra_1","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li>Kh\u00f4ng c\u00f3</li> </ul>"},{"location":"services/audit-logging-service/interface-contract/#ma-loi-co-the-tra-ve_1","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"Code M\u00f4 t\u1ea3 <code>common.unauthorized</code> Kh\u00f4ng c\u00f3 ho\u1eb7c JWT kh\u00f4ng h\u1ee3p l\u1ec7 <code>common.forbidden</code> Kh\u00f4ng \u0111\u01b0\u1ee3c truy c\u1eadp log kh\u00f4ng thu\u1ed9c tenant <code>common.not_found</code> Log kh\u00f4ng t\u1ed3n t\u1ea1i ho\u1eb7c kh\u00f4ng thu\u1ed9c quy\u1ec1n xem <code>common.internal_error</code> L\u1ed7i h\u1ec7 th\u1ed1ng khi truy xu\u1ea5t d\u1eef li\u1ec7u"},{"location":"services/audit-logging-service/interface-contract/#goi-y-kiem-thu_1","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>L\u1ea5y log h\u1ee3p l\u1ec7 v\u1edbi \u0111\u00fang tenant v\u00e0 quy\u1ec1n \u2192 th\u1ea5y log \u0111\u1ea7y \u0111\u1ee7</li> <li>L\u1ea5y log thu\u1ed9c tenant kh\u00e1c \u2192 l\u1ed7i <code>common.forbidden</code> ho\u1eb7c <code>common.not_found</code></li> <li>L\u1ea5y log v\u1edbi user kh\u00f4ng \u0111\u1ee7 quy\u1ec1n \u2192 b\u1ecb che <code>input_parameters</code></li> <li>L\u1ea5y log kh\u00f4ng t\u1ed3n t\u1ea1i \u2192 l\u1ed7i <code>common.not_found</code></li> <li>G\u00e2y l\u1ed7i backend (e.g. t\u1ea1m ng\u01b0ng BigQuery) \u2192 l\u1ed7i <code>common.internal_error</code></li> </ul>"},{"location":"services/audit-logging-service/interface-contract/#chu-thich-inh-dang-response-loi","title":"\ud83d\udccc Ch\u00fa th\u00edch \u0110\u1ecbnh d\u1ea1ng Response &amp; L\u1ed7i","text":"<p>T\u1ea5t c\u1ea3 API tu\u00e2n th\u1ee7 \u0111\u1ecbnh d\u1ea1ng chu\u1ea9n h\u00f3a c\u1ee7a h\u1ec7 th\u1ed1ng (xem ADR-012 v\u00e0 ADR-011).</p>"},{"location":"services/audit-logging-service/interface-contract/#thanh-cong-200-ok-204-no-content","title":"\u2705 Th\u00e0nh c\u00f4ng (200 OK / 204 No Content)","text":"<pre><code>{\n  \"data\": { ... },\n  \"meta\": {\n    \"request_id\": \"req-xyz\",\n    \"timestamp\": \"2025-06-14T12:00:00Z\"\n  },\n  \"error\": null\n}\n</code></pre>"},{"location":"services/audit-logging-service/interface-contract/#loi-4xx5xx","title":"\u274c L\u1ed7i (4xx/5xx)","text":"<pre><code>{\n  \"data\": null,\n  \"meta\": {\n    \"request_id\": \"req-xyz\",\n    \"timestamp\": \"2025-06-14T12:00:00Z\"\n  },\n  \"error\": {\n    \"code\": \"FORBIDDEN\",\n    \"message\": \"B\u1ea1n kh\u00f4ng c\u00f3 quy\u1ec1n xem log n\u00e0y.\",\n    \"details\": null\n  }\n}\n</code></pre>"},{"location":"services/audit-logging-service/interface-contract/#3-giao-tiep-pubsub","title":"3. \ud83d\udce5 Giao ti\u1ebfp Pub/Sub","text":"<p>Audit Logging Service h\u1ed7 tr\u1ee3 giao ti\u1ebfp s\u1ef1 ki\u1ec7n qua Pub/Sub v\u1edbi hai vai tr\u00f2:</p>"},{"location":"services/audit-logging-service/interface-contract/#31-ingestion-tu-topic-auditeventsv1","title":"3.1. \ud83d\udce5 Ingestion t\u1eeb topic <code>audit.events.v1</code>","text":"<p>ALS l\u00e0 consumer ch\u00ednh th\u1ee9c c\u1ee7a topic Pub/Sub:</p> <pre><code>projects/dx-vas/topics/audit.events.v1\n</code></pre> <p>C\u00e1c service trong h\u1ec7 th\u1ed1ng s\u1ebd ph\u00e1t c\u00e1c s\u1ef1 ki\u1ec7n h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng, b\u1ea3o m\u1eadt, truy c\u1eadp t\u00e0i nguy\u00ean... l\u00ean topic n\u00e0y thay v\u00ec g\u1ecdi HTTP API n\u1ed9i b\u1ed9.</p>"},{"location":"services/audit-logging-service/interface-contract/#inh-danh-su-kien","title":"\u2705 \u0110\u1ecbnh danh s\u1ef1 ki\u1ec7n","text":"<p>T\u00ean s\u1ef1 ki\u1ec7n tu\u00e2n theo quy \u01b0\u1edbc:</p> <pre><code>vas.&lt;domain&gt;.&lt;event&gt;.v&lt;version&gt;\n</code></pre> <p>V\u00ed d\u1ee5: - <code>vas.auth.login_success.v1</code> - <code>vas.user.updated.v1</code> - <code>vas.notification.sent.v1</code></p>"},{"location":"services/audit-logging-service/interface-contract/#inh-dang-payload-vi-du","title":"\ud83d\udcc4 \u0110\u1ecbnh d\u1ea1ng payload (v\u00ed d\u1ee5)","text":"<pre><code>{\n  \"event\": \"vas.user.updated.v1\",\n  \"tenant_id\": \"vas-sch-01\",\n  \"trace_id\": \"abc-xyz-123\",\n  \"actor_user_id\": \"u_456\",\n  \"resource_type\": \"user\",\n  \"resource_id\": \"u_123\",\n  \"action\": \"update\",\n  \"status\": \"success\",\n  \"payload_before\": { ... },\n  \"payload_after\": { ... },\n  \"source_service\": \"user-service\",\n  \"timestamp\": \"2025-06-14T12:00:00Z\"\n}\n</code></pre>"},{"location":"services/audit-logging-service/interface-contract/#iam-cho-subscriber","title":"\ud83d\udd10 IAM cho subscriber","text":"<p>ALS s\u1eed d\u1ee5ng service account:</p> <pre><code>als@dx-vas.iam.gserviceaccount.com\n</code></pre> <p>C\u1ea7n \u0111\u01b0\u1ee3c c\u1ea5p quy\u1ec1n <code>roles/pubsub.subscriber</code> cho topic <code>audit.events.v1</code>. Vi\u1ec7c binding IAM ph\u1ea3i \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh r\u00f5 r\u00e0ng cho t\u1eebng m\u00f4i tr\u01b0\u1eddng (staging/production).</p> <ul> <li>\u26a0\ufe0f ALS ch\u1ec9 x\u1eed l\u00fd event c\u00f3 schema h\u1ee3p l\u1ec7 \u0111\u00e3 \u0111\u0103ng k\u00fd theo ADR-030</li> <li>\u26a0\ufe0f Kh\u00f4ng c\u1ea5p cho user-facing client</li> </ul>"},{"location":"services/audit-logging-service/interface-contract/#32-phat-su-kien-thu-cap-optional","title":"3.2. \ud83d\udce4 Ph\u00e1t s\u1ef1 ki\u1ec7n th\u1ee9 c\u1ea5p (optional)","text":"<p>\u26a0\ufe0f T\u00ednh n\u0103ng n\u00e0y \u0111ang T\u1eaeT m\u1eb7c \u0111\u1ecbnh trong production. Ch\u1ec9 b\u1eadt n\u1ebfu h\u1ec7 th\u1ed1ng downstream c\u1ea7n theo d\u00f5i t\u00edn hi\u1ec7u log ghi th\u00e0nh c\u00f4ng.</p> <p>Audit Logging Service h\u1ed7 tr\u1ee3 ph\u00e1t s\u1ef1 ki\u1ec7n th\u1ee9 c\u1ea5p <code>vas.audit.persisted.v1</code> khi m\u1ed9t b\u1ea3n ghi \u0111\u01b0\u1ee3c l\u01b0u v\u00e0o BigQuery/Firestore.</p> <p>M\u1ee5c \u0111\u00edch:</p> <ul> <li>\u0110\u1ed3ng b\u1ed9 ETL pipeline</li> <li>Trigger engine ph\u00e2n t\u00edch h\u00e0nh vi</li> <li>H\u1ec7 th\u1ed1ng downstream c\u1ea7n x\u00e1c nh\u1eadn vi\u1ec7c ghi log ho\u00e0n t\u1ea5t</li> </ul>"},{"location":"services/audit-logging-service/interface-contract/#cau-hinh-battat","title":"\u2699\ufe0f C\u1ea5u h\u00ecnh b\u1eadt/t\u1eaft","text":"<pre><code>emit_audit_event_enabled: false\naudit_event_topic: vas.audit.persisted.v1\n</code></pre>"},{"location":"services/audit-logging-service/interface-contract/#cau-truc-su-kien","title":"\ud83d\udcc4 C\u1ea5u tr\u00fac s\u1ef1 ki\u1ec7n","text":"<pre><code>{\n  \"event\": \"vas.audit.persisted.v1\",\n  \"id\": \"log-abc123\",\n  \"tenant_id\": \"vas-sch-01\",\n  \"timestamp\": \"2025-06-14T12:00:00Z\",\n  \"source_service\": \"user-service\",\n  \"action\": \"delete\"\n}\n</code></pre>"},{"location":"services/audit-logging-service/interface-contract/#luu-y","title":"\ud83d\udd12 L\u01b0u \u00fd","text":"<ul> <li>Kh\u00f4ng c\u00f3 consumer b\u1eaft bu\u1ed9c. Ch\u1ec9 ph\u00e1t khi c\u1ea5u h\u00ecnh <code>emit_audit_event_enabled: true</code></li> <li>Kh\u00f4ng \u0111\u1ea3m b\u1ea3o delivery \u2014 kh\u00f4ng retry n\u1ebfu downstream kh\u00f4ng subscribe \u0111\u00fang</li> </ul>"},{"location":"services/audit-logging-service/interface-contract/#4-phu-luc","title":"4. \ud83d\udcce Ph\u1ee5 l\u1ee5c","text":""},{"location":"services/audit-logging-service/interface-contract/#41-cac-enum-su-dung-trong-audit-logging-service","title":"4.1. \ud83d\udcce C\u00e1c ENUM s\u1eed d\u1ee5ng trong Audit Logging Service","text":"T\u00ean tr\u01b0\u1eddng Gi\u00e1 tr\u1ecb h\u1ee3p l\u1ec7 M\u00f4 t\u1ea3 <code>status</code> <code>success</code>, <code>failure</code>, <code>warning</code> Tr\u1ea1ng th\u00e1i k\u1ebft qu\u1ea3 c\u1ee7a h\u00e0nh \u0111\u1ed9ng ghi log <code>resource_type</code> <code>user</code>, <code>tenant</code>, <code>role</code>, <code>permission</code>, <code>token</code>, <code>report</code>, <code>notification</code>, <code>config</code>, <code>system</code> Lo\u1ea1i t\u00e0i nguy\u00ean li\u00ean quan \u0111\u1ebfn h\u00e0nh \u0111\u1ed9ng \u0111\u01b0\u1ee3c ghi nh\u1eadn <code>action</code> <code>create</code>, <code>read</code>, <code>update</code>, <code>delete</code>, <code>assign</code>, <code>login</code>, <code>logout</code>, <code>verify</code>, <code>exchange</code>, <code>send</code>, <code>generate</code> H\u00e0nh vi \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n b\u1edfi actor <code>source_service</code> <code>user-service</code>, <code>auth-service/master</code>, <code>auth-service/sub</code>, <code>notification-service</code>, <code>reporting-service</code>, <code>api-gateway</code>, <code>admin-webapp</code>, <code>external-adapter</code>, <code>system-task</code> T\u00ean service kh\u1edfi ph\u00e1t h\u00e0nh \u0111\u1ed9ng (\u0111\u01b0\u1ee3c d\u00f9ng trong Pub/Sub &amp; trace) <code>log_channel</code> (n\u1ed9i b\u1ed9) <code>http</code>, <code>pubsub</code> K\u00eanh ghi nh\u1eadn log \u2013 d\u00f9ng \u0111\u1ec3 ph\u00e2n bi\u1ec7t lu\u1ed3ng trigger <p>\ud83d\udccc Ghi ch\u00fa:</p> <ul> <li>Enum <code>action</code> \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 v\u1edbi ADR-008 \u2013 Audit Format</li> <li>Enum <code>source_service</code> ph\u1ea3i kh\u1edbp v\u1edbi gi\u00e1 tr\u1ecb th\u1ef1c t\u1ebf <code>service_name</code> trong trace &amp; event emitter</li> <li>C\u00e1c enum n\u00e0y \u0111\u01b0\u1ee3c d\u00f9ng trong query param, schema Pub/Sub v\u00e0 b\u1ea3ng log</li> </ul>"},{"location":"services/audit-logging-service/interface-contract/#42-bang-permission-code-cho-audit-logging-service","title":"4.2. \ud83d\udcce B\u1ea3ng Permission Code cho Audit Logging Service","text":"<code>permission_code</code> M\u00f4 t\u1ea3 API s\u1eed d\u1ee5ng <code>action</code> <code>resource</code> <code>default_condition</code> <code>audit.read.log</code> \u0110\u1ecdc danh s\u00e1ch ho\u1eb7c chi ti\u1ebft log h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng <code>GET /audit-log</code>, <code>GET /audit-log/{id}</code> <code>read</code> <code>log</code> <code>{ \"tenant_id\": \"{{X-Tenant-ID}}\" }</code> <code>audit.write</code> Ghi log (n\u1ed9i b\u1ed9, qua HTTP ho\u1eb7c Pub/Sub) <code>POST /audit-log</code> (n\u1ed9i b\u1ed9), Pub/Sub listener <code>create</code> <code>log</code> <code>internal only, scope-based allowed</code>"},{"location":"services/audit-logging-service/interface-contract/#giai-thich","title":"\ud83c\udfaf Gi\u1ea3i th\u00edch:","text":"<ul> <li><code>audit.read.log</code>:</li> <li>\u00c1p d\u1ee5ng cho t\u1ea5t c\u1ea3 h\u00e0nh vi truy v\u1ea5n log.</li> <li>Ki\u1ec3m so\u00e1t theo tenant hi\u1ec7n t\u1ea1i (<code>X-Tenant-ID</code>).</li> <li> <p>H\u1ec7 th\u1ed1ng h\u1ed7 tr\u1ee3 masking \u0111\u1ed9ng v\u1edbi c\u00e1c tr\u01b0\u1eddng nh\u1ea1y c\u1ea3m nh\u01b0 <code>input_parameters</code>, <code>ip_address</code>, <code>user_agent</code> n\u1ebfu ng\u01b0\u1eddi d\u00f9ng kh\u00f4ng c\u00f3 vai tr\u00f2 \u0111\u1ee7 cao (e.g. kh\u00f4ng ph\u1ea3i <code>tenant_admin</code>).</p> </li> <li> <p><code>audit.write</code>:</p> </li> <li>Kh\u00f4ng c\u1ea5p cho ng\u01b0\u1eddi d\u00f9ng cu\u1ed1i \u2013 ch\u1ec9 s\u1eed d\u1ee5ng n\u1ed9i b\u1ed9 service \u2192 c\u1ea7n x\u00e1c th\u1ef1c b\u1eb1ng JWT + scope <code>audit.write</code>.</li> <li>C\u00e1c h\u1ec7 th\u1ed1ng nh\u01b0 <code>user-service</code>, <code>auth-service</code>, <code>api-gateway</code> c\u00f3 th\u1ec3 g\u1ecdi <code>POST /audit-log</code> ho\u1eb7c emit Pub/Sub event khi x\u1ea3y ra h\u00e0nh vi c\u1ea7n ghi nh\u1eadn.</li> </ul>"},{"location":"services/audit-logging-service/interface-contract/#43-tai-lieu-lien-quan","title":"4.3. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan","text":"T\u00e0i li\u1ec7u M\u00f4 t\u1ea3 design.md Thi\u1ebft k\u1ebf t\u1ed5ng th\u1ec3 c\u1ee7a Audit Logging Service, bao g\u1ed3m ki\u1ebfn tr\u00fac, m\u00f4 h\u00ecnh d\u1eef li\u1ec7u v\u00e0 lu\u1ed3ng nghi\u1ec7p v\u1ee5 data-model.md \u0110\u1ecbnh ngh\u0129a chi ti\u1ebft c\u1ea5u tr\u00fac b\u1ea3ng log, \u0111\u1ecbnh d\u1ea1ng l\u01b0u tr\u1eef v\u00e0 masking ADR-008 - Audit Format \u0110\u1ecbnh d\u1ea1ng schema log chu\u1ea9n cho to\u00e0n h\u1ec7 th\u1ed1ng ADR-030 - Event Schema Governance Quy t\u1eafc \u0111\u1ecbnh danh, versioning v\u00e0 qu\u1ea3n l\u00fd schema s\u1ef1 ki\u1ec7n rbac-deep-dive.md Ph\u00e2n t\u00edch s\u00e2u v\u1ec1 RBAC, permission <code>audit.read.log</code> v\u00e0 masking theo role ADR-024 - Data Anonymization &amp; Retention Chi\u1ebfn l\u01b0\u1ee3c \u1ea9n danh v\u00e0 x\u00f3a d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m trong log ADR-012 - Response Structure \u0110\u1ecbnh d\u1ea1ng ph\u1ea3n h\u1ed3i chu\u1ea9n c\u1ee7a to\u00e0n h\u1ec7 th\u1ed1ng ADR-011 - Error Format C\u1ea5u tr\u00fac l\u1ed7i chu\u1ea9n (error envelope) d\u00f9ng trong t\u1ea5t c\u1ea3 API"},{"location":"services/auth-service/master/data-model/","title":"\ud83d\udd10 Auth Service Master - Data Model","text":"<p>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 chi ti\u1ebft m\u00f4 h\u00ecnh d\u1eef li\u1ec7u c\u1ee7a Auth Service Master.</p> <p>Service n\u00e0y l\u00e0 m\u1ed9t th\u00e0nh ph\u1ea7n \u0111i\u1ec1u ph\u1ed1i x\u00e1c th\u1ef1c trung t\u00e2m trong h\u1ec7 th\u1ed1ng <code>dx-vas</code>, ho\u1ea1t \u0111\u1ed9ng theo ki\u1ebfn tr\u00fac request-response v\u00e0 h\u1ed7 tr\u1ee3 multi-tenant.</p> <p>Auth Service Master ch\u1ecbu tr\u00e1ch nhi\u1ec7m qu\u1ea3n l\u00fd c\u00e1c lo\u1ea1i d\u1eef li\u1ec7u ch\u00ednh sau: - C\u1ea5u h\u00ecnh nh\u00e0 cung c\u1ea5p x\u00e1c th\u1ef1c OAuth2 (<code>auth_provider_configs</code>) - \u0110\u0103ng nh\u1eadp OTP (<code>auth_otp_logs</code>) - Nh\u1eadt k\u00fd x\u00e1c th\u1ef1c th\u00e0nh c\u00f4ng/th\u1ea5t b\u1ea1i (<code>auth_login_audits</code>)</p>"},{"location":"services/auth-service/master/data-model/#1-pham-vi-du-lieu-quan-ly-scope","title":"1. \ud83c\udfaf Ph\u1ea1m vi D\u1eef li\u1ec7u Qu\u1ea3n l\u00fd (Scope)","text":"<p>Auth Service Master kh\u00f4ng l\u01b0u tr\u1eef token ho\u1eb7c session c\u1ee7a ng\u01b0\u1eddi d\u00f9ng. T\u1ea5t c\u1ea3 c\u00e1c d\u1eef li\u1ec7u li\u00ean quan \u0111\u1ebfn v\u00f2ng \u0111\u1eddi token \u0111\u01b0\u1ee3c \u1ee7y quy\u1ec1n cho <code>token-service</code>.</p> <p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c nh\u00f3m d\u1eef li\u1ec7u c\u00f3 trong ph\u1ea1m vi qu\u1ea3n l\u00fd c\u1ee7a Auth Service Master:</p> Nh\u00f3m d\u1eef li\u1ec7u M\u00f4 t\u1ea3 ng\u1eafn <code>auth_provider_configs</code> C\u1ea5u h\u00ecnh OAuth2 cho t\u1eebng tenant (Google client ID/secret\u2026) <code>auth_otp_logs</code> L\u1ecbch s\u1eed g\u1eedi OTP (phone/email), h\u1ed7 tr\u1ee3 audit &amp; ch\u1ed1ng spam <code>auth_login_audits</code> Ghi l\u1ea1i log \u0111\u0103ng nh\u1eadp th\u00e0nh c\u00f4ng/th\u1ea5t b\u1ea1i v\u00e0 ph\u01b0\u01a1ng th\u1ee9c"},{"location":"services/auth-service/master/data-model/#ngoai-pham-vi","title":"\u274c Ngo\u00e0i ph\u1ea1m vi","text":"Nh\u00f3m d\u1eef li\u1ec7u Ghi ch\u00fa <code>auth_sessions</code> \u27a4 \u0110\u01b0\u1ee3c qu\u1ea3n l\u00fd b\u1edfi <code>token-service</code> <code>jwks_cache</code>, <code>revoked_jti</code> \u27a4 \u0110\u01b0\u1ee3c cache &amp; x\u1eed l\u00fd t\u1ea1i <code>token-service</code>, kh\u00f4ng n\u1eb1m \u1edf \u0111\u00e2y <code>route_config</code>, <code>rbac</code> \u27a4 Thu\u1ed9c ph\u1ea1m vi c\u1ee7a <code>api-gateway</code>"},{"location":"services/auth-service/master/data-model/#2-cau-truc-bang-du-lieu","title":"2. \ud83e\uddf1 C\u1ea5u tr\u00fac b\u1ea3ng d\u1eef li\u1ec7u","text":""},{"location":"services/auth-service/master/data-model/#21-auth_provider_configs","title":"2.1. <code>auth_provider_configs</code>","text":"<p>C\u1ea5u h\u00ecnh OAuth2 cho t\u1eebng tenant. Cho ph\u00e9p Auth Service Master \u0111i\u1ec1u h\u01b0\u1edbng ng\u01b0\u1eddi d\u00f9ng \u0111\u1ebfn \u0111\u00fang nh\u00e0 cung c\u1ea5p v\u00e0 ki\u1ec3m tra t\u00ednh h\u1ee3p l\u1ec7 c\u1ee7a th\u00f4ng tin tr\u1ea3 v\u1ec1.</p> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c Ghi ch\u00fa <code>tenant_id</code> UUID \u2705 Kh\u00f3a ch\u00ednh (k\u1ebft h\u1ee3p v\u1edbi <code>provider_name</code>) <code>provider_name</code> TEXT \u2705 <code>google</code>, <code>apple</code>, ... <code>client_id</code> TEXT \u2705 OAuth2 Client ID <code>client_secret</code> TEXT \u2705 \u0110\u01b0\u1ee3c m\u00e3 h\u00f3a b\u1eb1ng secret backend <code>redirect_uri</code> TEXT \u2705 URI \u0111\u01b0\u1ee3c redirect t\u1eeb nh\u00e0 cung c\u1ea5p <code>scopes</code> TEXT[] \u274c C\u00e1c scope m\u1eb7c \u0111\u1ecbnh, v\u00ed d\u1ee5: <code>[\"email\", \"openid\"]</code> <code>is_active</code> BOOLEAN \u2705 Cho ph\u00e9p s\u1eed d\u1ee5ng hay kh\u00f4ng <code>created_at</code> TIMESTAMPTZ \u2705 <code>updated_at</code> TIMESTAMPTZ \u2705"},{"location":"services/auth-service/master/data-model/#22-auth_otp_logs","title":"2.2. <code>auth_otp_logs</code>","text":"<p>L\u01b0u th\u00f4ng tin c\u00e1c l\u1ea7n g\u1eedi OTP \u0111\u1ec3 ph\u1ee5c v\u1ee5 ch\u1ed1ng spam, audit v\u00e0 th\u1ed1ng k\u00ea.</p> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c Ghi ch\u00fa <code>id</code> UUID \u2705 Kh\u00f3a ch\u00ednh <code>tenant_id</code> UUID \u2705 Tenant g\u1eedi OTP <code>identifier</code> TEXT \u2705 S\u1ed1 \u0111i\u1ec7n tho\u1ea1i ho\u1eb7c email <code>otp_type</code> TEXT \u2705 <code>phone</code> ho\u1eb7c <code>email</code> <code>sent_at</code> TIMESTAMPTZ \u2705 Th\u1eddi \u0111i\u1ec3m g\u1eedi <code>via_channel</code> TEXT \u2705 <code>sms</code>, <code>email</code>, ho\u1eb7c c\u00e1c k\u00eanh n\u1ed9i b\u1ed9 kh\u00e1c <code>status</code> TEXT \u2705 <code>success</code>, <code>failed</code>, <code>rate_limited</code>... <code>meta</code> JSONB \u274c D\u1eef li\u1ec7u ph\u1ee5 nh\u01b0 IP, user agent"},{"location":"services/auth-service/master/data-model/#23-auth_login_audits","title":"2.3. <code>auth_login_audits</code>","text":"<p>Ghi l\u1ea1i c\u00e1c phi\u00ean \u0111\u0103ng nh\u1eadp th\u00e0nh c\u00f4ng/th\u1ea5t b\u1ea1i, ph\u1ee5c v\u1ee5 truy v\u1ebft, th\u1ed1ng k\u00ea v\u00e0 b\u1ea3o m\u1eadt.</p> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c Ghi ch\u00fa <code>id</code> UUID \u2705 Kh\u00f3a ch\u00ednh <code>tenant_id</code> UUID \u2705 <code>user_id</code> UUID \u2705 ID ng\u01b0\u1eddi d\u00f9ng (n\u1ebfu c\u00f3) <code>identifier</code> TEXT \u2705 Email/S\u0110T/username \u0111\u0103ng nh\u1eadp <code>login_method</code> TEXT \u2705 <code>google</code>, <code>otp</code>, <code>local</code> <code>status</code> TEXT \u2705 <code>success</code> ho\u1eb7c <code>failed</code> <code>client_ip</code> TEXT \u2705 IP ng\u01b0\u1eddi d\u00f9ng <code>user_agent</code> TEXT \u2705 Tr\u00ecnh duy\u1ec7t ho\u1eb7c app <code>trace_id</code> UUID \u2705 M\u00e3 trace ID gi\u00fap li\u00ean k\u1ebft v\u1edbi h\u1ec7 th\u1ed1ng kh\u00e1c <code>created_at</code> TIMESTAMPTZ \u2705 Th\u1eddi \u0111i\u1ec3m \u0111\u0103ng nh\u1eadp"},{"location":"services/auth-service/master/data-model/#3-erd-so-o-minh-hoa","title":"3. \ud83e\uddec ERD &amp; s\u01a1 \u0111\u1ed3 minh h\u1ecda","text":"<p>S\u01a1 \u0111\u1ed3 d\u01b0\u1edbi \u0111\u00e2y th\u1ec3 hi\u1ec7n m\u00f4 h\u00ecnh d\u1eef li\u1ec7u logic c\u1ee7a Auth Service Master, nh\u1ea5n m\u1ea1nh c\u00e1c b\u1ea3ng quan tr\u1ecdng nh\u01b0 <code>auth_provider_configs</code>, <code>auth_otp_logs</code> v\u00e0 <code>auth_login_audits</code>.</p> <pre><code>erDiagram\n    AUTH_PROVIDER_CONFIGS {\n        UUID tenant_id PK\n        TEXT provider_name PK\n        TEXT client_id\n        TEXT client_secret\n        TEXT redirect_uri\n        TEXT[] scopes\n        BOOLEAN is_active\n        TIMESTAMPTZ created_at\n        TIMESTAMPTZ updated_at\n    }\n\n    AUTH_OTP_LOGS {\n        UUID id PK\n        UUID tenant_id\n        TEXT identifier\n        TEXT otp_type\n        TIMESTAMPTZ sent_at\n        TEXT via_channel\n        TEXT status\n        JSONB meta\n    }\n\n    AUTH_LOGIN_AUDITS {\n        UUID id PK\n        UUID tenant_id\n        UUID user_id\n        TEXT identifier\n        TEXT login_method\n        TEXT status\n        TEXT client_ip\n        TEXT user_agent\n        UUID trace_id\n        TIMESTAMPTZ created_at\n    }\n\n    AUTH_OTP_LOGS ||--|| AUTH_PROVIDER_CONFIGS : belongs_to\n    AUTH_LOGIN_AUDITS ||--|| AUTH_PROVIDER_CONFIGS : belongs_to\n</code></pre> <p>\ud83d\udccc Ghi ch\u00fa:</p> <ul> <li>M\u1eb7c d\u00f9 c\u00e1c b\u1ea3ng kh\u00f4ng c\u00f3 li\u00ean k\u1ebft foreign key c\u1ee9ng trong c\u01a1 s\u1edf d\u1eef li\u1ec7u (do t\u00ednh \u0111a tenant), s\u01a1 \u0111\u1ed3 tr\u00ean gi\u00fap tr\u1ef1c quan h\u00f3a lu\u1ed3ng d\u1eef li\u1ec7u v\u00e0 m\u1ed1i quan h\u1ec7 logic.</li> <li><code>tenant_id</code> l\u00e0 kh\u00f3a ph\u00e2n v\u00f9ng (partition key) trong to\u00e0n b\u1ed9 h\u1ec7 th\u1ed1ng dx-vas.</li> <li><code>user_id</code> \u0111\u01b0\u1ee3c li\u00ean k\u1ebft ng\u1ea7m v\u1edbi <code>user-service</code> \u2013 kh\u00f4ng c\u00f3 foreign key tr\u1ef1c ti\u1ebfp nh\u01b0ng mang \u00fd ngh\u0129a tham chi\u1ebfu ngo\u00e0i.</li> </ul>"},{"location":"services/auth-service/master/data-model/#4-vi-du-du-lieu-case-su-dung","title":"4. \ud83d\udce6 V\u00ed d\u1ee5 d\u1eef li\u1ec7u &amp; Case s\u1eed d\u1ee5ng","text":"<p>Ph\u1ea7n n\u00e0y cung c\u1ea5p m\u1ed9t s\u1ed1 v\u00ed d\u1ee5 th\u1ef1c t\u1ebf v\u1ec1 d\u1eef li\u1ec7u trong c\u00e1c b\u1ea3ng ch\u00ednh v\u00e0 c\u00e1ch h\u1ec7 th\u1ed1ng s\u1eed d\u1ee5ng ch\u00fang \u0111\u1ec3 th\u1ef1c hi\u1ec7n c\u00e1c nghi\u1ec7p v\u1ee5 x\u00e1c th\u1ef1c.</p>"},{"location":"services/auth-service/master/data-model/#41-vi-du-auth_provider_configs","title":"4.1. V\u00ed d\u1ee5: <code>auth_provider_configs</code>","text":"<pre><code>{\n  \"tenant_id\": \"8a4d6e1f-9007-4f7d-bd9a-12e470e1a123\",\n  \"provider_name\": \"google\",\n  \"client_id\": \"1007630212910-xyz.apps.googleusercontent.com\",\n  \"client_secret\": \"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\",\n  \"redirect_uri\": \"https://auth.truongvietanh.edu.vn/oauth2/callback\",\n  \"scopes\": [\"openid\", \"email\", \"profile\"],\n  \"is_active\": true,\n  \"created_at\": \"2024-10-01T09:00:00Z\",\n  \"updated_at\": \"2025-06-01T10:00:00Z\"\n}\n</code></pre> <p>\ud83d\udccc Use case: Khi ng\u01b0\u1eddi d\u00f9ng nh\u1ea5n \u201c\u0110\u0103ng nh\u1eadp b\u1eb1ng Google\u201d, service truy xu\u1ea5t c\u1ea5u h\u00ecnh n\u00e0y theo <code>tenant_id</code> \u0111\u1ec3 t\u1ea1o link \u1ee7y quy\u1ec1n (<code>Google OAuth2 auth URL</code>).</p>"},{"location":"services/auth-service/master/data-model/#42-vi-du-auth_otp_logs","title":"4.2. V\u00ed d\u1ee5: <code>auth_otp_logs</code>","text":"<pre><code>{\n  \"id\": \"8d86d9fe-4c25-4268-9560-289e2648fc99\",\n  \"tenant_id\": \"8a4d6e1f-9007-4f7d-bd9a-12e470e1a123\",\n  \"identifier\": \"+84981112233\",\n  \"otp_type\": \"phone\",\n  \"sent_at\": \"2025-06-10T14:32:20Z\",\n  \"via_channel\": \"sms\",\n  \"status\": \"success\",\n  \"meta\": {\n    \"client_ip\": \"172.16.0.10\",\n    \"user_agent\": \"Mozilla/5.0\"\n  }\n}\n</code></pre> <p>\ud83d\udccc Use case: Gi\u00fap theo d\u00f5i l\u1ecbch s\u1eed g\u1eedi OTP v\u00e0 ki\u1ec3m so\u00e1t rate limit d\u1ef1a theo <code>identifier</code>, <code>ip</code>, <code>user_agent</code>.</p>"},{"location":"services/auth-service/master/data-model/#43-vi-du-auth_login_audits","title":"4.3. V\u00ed d\u1ee5: <code>auth_login_audits</code>","text":"<pre><code>{\n  \"id\": \"f38e38f5-10ab-4db5-980f-8c13b6c888a4\",\n  \"tenant_id\": \"8a4d6e1f-9007-4f7d-bd9a-12e470e1a123\",\n  \"user_id\": \"1f409245-cf1a-4a0d-bcf0-91c7e4cbbd41\",\n  \"identifier\": \"ngocminh@vietanh.edu.vn\",\n  \"login_method\": \"local\",\n  \"status\": \"success\",\n  \"client_ip\": \"172.16.0.10\",\n  \"user_agent\": \"Mozilla/5.0\",\n  \"trace_id\": \"3a34de72-0ba3-4e1d-9c0d-bbfb3bbd5e0b\",\n  \"created_at\": \"2025-06-10T15:10:42Z\"\n}\n</code></pre> <p>\ud83d\udccc Use case: H\u1ec7 th\u1ed1ng ph\u00e2n t\u00edch log \u0111\u0103ng nh\u1eadp \u0111\u1ec3 ph\u00e1t hi\u1ec7n h\u00e0nh vi b\u1ea5t th\u01b0\u1eddng, ki\u1ec3m to\u00e1n b\u1ea3o m\u1eadt v\u00e0 h\u1ed7 tr\u1ee3 \u0111i\u1ec1u tra khi c\u00f3 s\u1ef1 c\u1ed1.</p>"},{"location":"services/auth-service/master/data-model/#5-chi-tiet-cac-bang","title":"5. \ud83d\udcda Chi ti\u1ebft c\u00e1c b\u1ea3ng","text":"<p>Th\u00f4ng tin chi ti\u1ebft cho t\u1eebng b\u1ea3ng d\u1eef li\u1ec7u ch\u00ednh bao g\u1ed3m m\u00f4 t\u1ea3 c\u1ed9t, ch\u1ec9 m\u1ee5c (index), TTL, c\u00e1c c\u01a1 ch\u1ebf audit v\u00e0 ghi ch\u00fa v\u1ec1 kh\u1ea3 n\u0103ng migrate:</p>"},{"location":"services/auth-service/master/data-model/#51-auth_provider_configs","title":"5.1. <code>auth_provider_configs</code>","text":"<pre><code>CREATE TABLE auth_provider_configs (\n    tenant_id UUID NOT NULL,\n    provider_name TEXT NOT NULL,\n    client_id TEXT NOT NULL,\n    client_secret TEXT NOT NULL,\n    redirect_uri TEXT NOT NULL,\n    scopes TEXT[],\n    is_active BOOLEAN NOT NULL DEFAULT TRUE,\n    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n    PRIMARY KEY (tenant_id, provider_name)\n);\n</code></pre> C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u Index? Ghi ch\u00fa <code>tenant_id</code> UUID \u2705 Ph\u00e2n v\u00f9ng d\u1eef li\u1ec7u theo tenant (Partition Key) <code>provider_name</code> TEXT \u2705 C\u1eb7p (<code>tenant_id</code>, <code>provider_name</code>) l\u00e0 PK <code>client_id</code> TEXT Kh\u00f4ng index <code>client_secret</code> TEXT M\u00e3 h\u00f3a khi l\u01b0u <code>redirect_uri</code> TEXT URI duy nh\u1ea5t cho t\u1eebng tenant/provider <code>scopes</code> TEXT[] Array c\u00e1c scope m\u1eb7c \u0111\u1ecbnh <code>is_active</code> BOOLEAN \u2705 \u0110\u01b0\u1ee3c d\u00f9ng trong l\u1ecdc nhanh <code>created_at</code> TIMESTAMPTZ - <code>updated_at</code> TIMESTAMPTZ - <p>TTL: Kh\u00f4ng \u00e1p d\u1ee5ng Audit: Ghi l\u1ea1i s\u1ef1 ki\u1ec7n c\u1eadp nh\u1eadt qua log n\u1ed9i b\u1ed9 ho\u1eb7c g\u1eedi <code>config.updated</code> (tu\u1ef3 setup) Migration Notes: C\u1ea5u tr\u00fac \u1ed5n \u0111\u1ecbnh, kh\u00f4ng n\u00ean \u0111\u1ed5i t\u00ean c\u1ed9t; n\u1ebfu thay \u0111\u1ed5i provider ph\u1ea3i xo\u00e1 to\u00e0n b\u1ed9 v\u00e0 insert l\u1ea1i.</p>"},{"location":"services/auth-service/master/data-model/#52-auth_otp_logs","title":"5.2. <code>auth_otp_logs</code>","text":"<pre><code>CREATE TABLE auth_otp_logs (\n    id UUID PRIMARY KEY,\n    tenant_id UUID NOT NULL,\n    identifier TEXT NOT NULL,\n    otp_type TEXT NOT NULL CHECK (otp_type IN ('phone', 'email')),\n    sent_at TIMESTAMPTZ NOT NULL,\n    via_channel TEXT NOT NULL,\n    status TEXT NOT NULL CHECK (status IN ('success', 'failed', 'rate_limited')),\n    meta JSONB\n);\n</code></pre> C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u Index? Ghi ch\u00fa <code>id</code> UUID \u2705 PK <code>tenant_id</code> UUID \u2705 Index ph\u1ee5 tr\u1ee3 ph\u00e2n t\u00edch \u0111a tenant <code>identifier</code> TEXT \u2705 S\u0110T ho\u1eb7c email <code>otp_type</code> TEXT <code>phone</code> ho\u1eb7c <code>email</code> <code>sent_at</code> TIMESTAMPTZ \u2705 Truy v\u1ea5n g\u1ea7n th\u1eddi gian th\u1ef1c <code>via_channel</code> TEXT <code>sms</code>, <code>email</code>, etc. <code>status</code> TEXT <code>success</code>, <code>failed</code>, etc. <code>meta</code> JSONB IP, user agent... <p>TTL: C\u00f3 th\u1ec3 \u00e1p d\u1ee5ng TTL 7\u201330 ng\u00e0y v\u1edbi c\u00e1c b\u1ea3n ghi c\u0169 Audit: T\u1ef1 \u0111\u1ed9ng sinh log OTP m\u1ed7i l\u1ea7n g\u1eedi Migration Notes: C\u00f3 th\u1ec3 truncate b\u1ea3ng \u0111\u1ecbnh k\u1ef3 n\u1ebfu \u0111\u00e3 d\u00f9ng TTL ho\u1eb7c archive sang cold storage</p>"},{"location":"services/auth-service/master/data-model/#53-auth_login_audits","title":"5.3. <code>auth_login_audits</code>","text":"<pre><code>CREATE TABLE auth_login_audits (\n    id UUID PRIMARY KEY,\n    tenant_id UUID NOT NULL,\n    user_id UUID,\n    identifier TEXT NOT NULL,\n    login_method TEXT NOT NULL CHECK (login_method IN ('google', 'otp', 'local')),\n    status TEXT NOT NULL CHECK (status IN ('success', 'failed')),\n    client_ip TEXT,\n    user_agent TEXT,\n    trace_id UUID NOT NULL,\n    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n</code></pre> C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u Index? Ghi ch\u00fa <code>id</code> UUID \u2705 PK <code>tenant_id</code> UUID \u2705 - <code>user_id</code> UUID \u2705 C\u00f3 th\u1ec3 null n\u1ebfu ch\u01b0a li\u00ean k\u1ebft \u0111\u01b0\u1ee3c <code>identifier</code> TEXT \u2705 Email/S\u0110T/username <code>login_method</code> TEXT \u2705 <code>google</code>, <code>otp</code>, <code>local</code> <code>status</code> TEXT <code>success</code>, <code>failed</code> <code>client_ip</code> TEXT Ghi l\u1ea1i \u0111\u1ec3 trace/ban IP <code>user_agent</code> TEXT - <code>trace_id</code> UUID \u2705 Li\u00ean k\u1ebft v\u1edbi log to\u00e0n h\u1ec7 th\u1ed1ng <code>created_at</code> TIMESTAMPTZ \u2705 Truy v\u1ea5n theo th\u1eddi gian \u0111\u0103ng nh\u1eadp <p>TTL: Kh\u00f4ng d\u00f9ng TTL \u2013 log c\u1ea7n l\u01b0u l\u00e2u d\u00e0i Audit: Ch\u00ednh b\u1ea3n ghi n\u00e0y l\u00e0 audit log Migration Notes: N\u1ebfu c\u1ea7n m\u1edf r\u1ed9ng schema, ch\u1ec9 n\u00ean th\u00eam c\u1ed9t nullable. Kh\u00f4ng n\u00ean thay \u0111\u1ed5i t\u00ean c\u1ed9t.</p>"},{"location":"services/auth-service/master/data-model/#6-phu-luc-tom-tat-index-enum-kiem-thu","title":"6. \ud83d\udcce Ph\u1ee5 l\u1ee5c (T\u00f3m t\u1eaft Index, ENUM, Ki\u1ec3m th\u1eed)","text":""},{"location":"services/auth-service/master/data-model/#61-chi-muc-index-summary","title":"6.1. \ud83d\udd0e Ch\u1ec9 m\u1ee5c (Index Summary)","text":"B\u1ea3ng Tr\u01b0\u1eddng \u0111\u01b0\u1ee3c \u0111\u00e1nh index Lo\u1ea1i <code>auth_provider_configs</code> (<code>tenant_id</code>, <code>provider_name</code>), <code>is_active</code> PK, BTREE <code>auth_otp_logs</code> <code>identifier</code>, <code>tenant_id</code>, <code>sent_at</code> BTREE <code>auth_login_audits</code> <code>user_id</code>, <code>tenant_id</code>, <code>identifier</code>, <code>trace_id</code>, <code>created_at</code> BTREE"},{"location":"services/auth-service/master/data-model/#62-enums-su-dung","title":"6.2. \ud83d\udcc9 ENUMs s\u1eed d\u1ee5ng","text":"<p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c tr\u01b0\u1eddng c\u00f3 gi\u00e1 tr\u1ecb d\u1ea1ng ENUM \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng trong h\u1ec7 th\u1ed1ng. Vi\u1ec7c chu\u1ea9n h\u00f3a c\u00e1c gi\u00e1 tr\u1ecb n\u00e0y gi\u00fap t\u0103ng t\u00ednh nh\u1ea5t qu\u00e1n khi truy v\u1ea5n, th\u1ed1ng k\u00ea v\u00e0 ph\u00e2n t\u00edch log.</p> Tr\u01b0\u1eddng B\u1ea3ng s\u1eed d\u1ee5ng Enum Gi\u00e1 tr\u1ecb h\u1ee3p l\u1ec7 Ghi ch\u00fa b\u1ed5 sung <code>otp_type</code> <code>auth_otp_logs</code> <code>phone</code>, <code>email</code> Cho bi\u1ebft lo\u1ea1i OTP g\u1eedi qua s\u1ed1 \u0111i\u1ec7n tho\u1ea1i ho\u1eb7c email <code>via_channel</code> <code>auth_otp_logs</code> <code>sms</code>, <code>email</code>, <code>internal</code>, <code>zalo</code> K\u00eanh g\u1eedi th\u1ef1c t\u1ebf \u2013 c\u00f3 th\u1ec3 m\u1edf r\u1ed9ng th\u00eam <code>status</code> <code>auth_otp_logs</code>, <code>auth_login_audits</code> <code>success</code>, <code>failed</code>, <code>rate_limited</code>, <code>expired</code>, <code>invalid</code> M\u00f4 t\u1ea3 k\u1ebft qu\u1ea3 g\u1eedi OTP ho\u1eb7c k\u1ebft qu\u1ea3 \u0111\u0103ng nh\u1eadp <code>login_method</code> <code>auth_login_audits</code> <code>google</code>, <code>otp</code>, <code>local</code> Chu\u1ea9n h\u00f3a \u0111\u1ec3 \u0111\u1ed3ng b\u1ed9 v\u1edbi <code>grant_type</code>, <code>X-Login-Method</code> <p>\ud83d\udccc L\u01b0u \u00fd:</p> <ul> <li>C\u00e1c gi\u00e1 tr\u1ecb ENUM tr\u00ean s\u1ebd \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 h\u00f3a v\u1edbi c\u00e1c h\u1ec7 th\u1ed1ng li\u00ean quan nh\u01b0 <code>token-service</code>, <code>api-gateway</code>, v\u00e0 <code>frontend</code>.</li> <li>N\u00ean d\u00f9ng gi\u00e1 tr\u1ecb vi\u1ebft th\u01b0\u1eddng (<code>snake_case</code> n\u1ebfu c\u1ea7n) \u0111\u1ec3 tr\u00e1nh sai s\u00f3t khi ph\u00e2n t\u00edch log v\u00e0 hi\u1ec3n th\u1ecb.</li> </ul>"},{"location":"services/auth-service/master/data-model/#63-chien-luoc-kiem-thu","title":"6.3. \u2705 Chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed","text":"<p>Chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed d\u1eef li\u1ec7u cho <code>auth-service/master</code> c\u1ea7n \u0111\u1ea3m b\u1ea3o: - C\u00e1c b\u1ea3ng ghi nh\u1eadn \u0111\u00fang s\u1ef1 ki\u1ec7n theo t\u1eebng lu\u1ed3ng x\u00e1c th\u1ef1c. - Truy v\u1ea5n d\u1eef li\u1ec7u ho\u1ea1t \u0111\u1ed9ng \u1ed5n \u0111\u1ecbnh theo th\u1eddi gian v\u00e0 tenant. - Ph\u00e1t hi\u1ec7n c\u00e1c h\u00e0nh vi b\u1ea5t th\u01b0\u1eddng qua log v\u00e0 metadata.</p>"},{"location":"services/auth-service/master/data-model/#kiem-thu-luong-otp","title":"\ud83d\udd0d Ki\u1ec3m th\u1eed lu\u1ed3ng OTP","text":"T\u00ecnh hu\u1ed1ng ki\u1ec3m th\u1eed B\u1ea3ng li\u00ean quan M\u1ee5c ti\u00eau G\u1eedi OTP li\u00ean t\u1ee5c <code>auth_otp_logs</code> \u0110\u1ea3m b\u1ea3o ghi log \u0111\u1ee7 c\u00e1c l\u1ea7n g\u1eedi (spam detection) G\u1eedi OTP qua email <code>auth_otp_logs</code> Ki\u1ec3m tra <code>via_channel = email</code>, <code>otp_type = email</code> G\u1eedi OTP b\u1ecb ch\u1eb7n do rate limit <code>auth_otp_logs</code> X\u00e1c nh\u1eadn <code>status = rate_limited</code> OTP g\u1eedi th\u00e0nh c\u00f4ng nh\u01b0ng user kh\u00f4ng \u0111\u0103ng nh\u1eadp <code>auth_otp_logs</code>, <code>auth_login_audits</code> Ki\u1ec3m tra kh\u00f4ng c\u00f3 <code>login.success</code> t\u01b0\u01a1ng \u1ee9ng"},{"location":"services/auth-service/master/data-model/#kiem-thu-ang-nhap","title":"\ud83d\udd10 Ki\u1ec3m th\u1eed \u0111\u0103ng nh\u1eadp","text":"T\u00ecnh hu\u1ed1ng ki\u1ec3m th\u1eed B\u1ea3ng li\u00ean quan M\u1ee5c ti\u00eau \u0110\u0103ng nh\u1eadp b\u1eb1ng Google th\u00e0nh c\u00f4ng <code>auth_login_audits</code> Ki\u1ec3m tra <code>login_method = google</code>, <code>status = success</code> \u0110\u0103ng nh\u1eadp OTP th\u1ea5t b\u1ea1i <code>auth_login_audits</code> Ki\u1ec3m tra ghi log v\u1edbi <code>status = failed</code>, <code>trace_id</code> \u0111\u00fang \u0110\u0103ng nh\u1eadp local th\u00e0nh c\u00f4ng <code>auth_login_audits</code> Ghi \u0111\u00fang <code>login_method = local</code>, c\u00f3 <code>user_id</code>"},{"location":"services/auth-service/master/data-model/#kiem-thu-cau-hinh-oauth2","title":"\ud83d\udd0e Ki\u1ec3m th\u1eed c\u1ea5u h\u00ecnh OAuth2","text":"T\u00ecnh hu\u1ed1ng ki\u1ec3m th\u1eed B\u1ea3ng li\u00ean quan M\u1ee5c ti\u00eau Truy xu\u1ea5t config kh\u00f4ng t\u1ed3n t\u1ea1i <code>auth_provider_configs</code> \u0110\u1ea3m b\u1ea3o h\u1ec7 th\u1ed1ng tr\u1ea3 l\u1ed7i r\u00f5 r\u00e0ng C\u1eadp nh\u1eadt redirect_uri kh\u00f4ng h\u1ee3p l\u1ec7 <code>auth_provider_configs</code> Ki\u1ec3m tra reject \u1edf t\u1ea7ng service ho\u1eb7c migration <p>\ud83d\udccc Khuy\u1ebfn ngh\u1ecb CI/CD: - D\u00f9ng fixture gi\u1ea3 l\u1eadp d\u1eef li\u1ec7u OTP v\u00e0 login logs \u0111\u1ec3 ki\u1ec3m th\u1eed li\u00ean t\u1ee5c trong staging. - \u00c1p d\u1ee5ng ki\u1ec3m th\u1eed snapshot \u0111\u1ec3 so s\u00e1nh c\u1ea5u tr\u00fac b\u1ea3ng kh\u00f4ng b\u1ecb thay \u0111\u1ed5i ngo\u00e0i \u00fd mu\u1ed1n. - Theo d\u00f5i s\u1ef1 ph\u00e2n b\u1ed1 gi\u00e1 tr\u1ecb c\u1ee7a c\u00e1c tr\u01b0\u1eddng ENUM \u0111\u1ec3 ph\u00e1t hi\u1ec7n sai l\u1ec7ch (data drift).</p>"},{"location":"services/auth-service/master/data-model/#64-lien-ket-tai-lieu-he-thong","title":"6.4. \ud83d\udd17 Li\u00ean k\u1ebft t\u00e0i li\u1ec7u h\u1ec7 th\u1ed1ng","text":"<p>\u2705 \u0110\u00e3 tham chi\u1ebfu t\u1eeb:</p> <ul> <li>Thi\u1ebft k\u1ebf t\u1ed5ng quan (<code>design.md</code>)</li> <li>H\u1ee3p \u0111\u1ed3ng Giao di\u1ec7n API (<code>interface-contract.md</code>)</li> <li>\u0110\u1eb7c t\u1ea3 OpenAPI (<code>openapi.yaml</code>)</li> </ul> <p>\u2705 Tu\u00e2n th\u1ee7 c\u00e1c ADR li\u00ean quan</p> <ul> <li>ADR-011 - API Error Format</li> <li>ADR-012 - Response Envelope Structure</li> <li>ADR-023 - Database Migration Strategy</li> <li>ADR-024 - Data Retention Policy</li> <li>ADR-026 - Hard Delete Strategy</li> </ul>"},{"location":"services/auth-service/master/design/","title":"\ud83d\udcd8 Thi\u1ebft k\u1ebf chi ti\u1ebft auth-service/master","text":""},{"location":"services/auth-service/master/design/#1-pham-vi-trach-nhiem","title":"1. \ud83e\udded Ph\u1ea1m vi &amp; Tr\u00e1ch nhi\u1ec7m","text":""},{"location":"services/auth-service/master/design/#11-muc-ich","title":"1.1. \ud83c\udfaf M\u1ee5c \u0111\u00edch","text":"<p><code>auth-service/master</code> \u0111\u00f3ng vai tr\u00f2 l\u00e0 \"Nh\u00e0 \u0110i\u1ec1u Ph\u1ed1i X\u00e1c Th\u1ef1c\" (Authentication Orchestrator) trong h\u1ec7 sinh th\u00e1i DX-VAS. N\u00f3 ch\u1ecbu tr\u00e1ch nhi\u1ec7m x\u00e1c minh danh t\u00ednh ng\u01b0\u1eddi d\u00f9ng qua c\u00e1c ph\u01b0\u01a1ng th\u1ee9c \u0111\u01b0\u1ee3c h\u1ed7 tr\u1ee3 (Google OAuth2, OTP, Local) v\u00e0 \u0111i\u1ec1u ph\u1ed1i c\u00e1c th\u00e0nh ph\u1ea7n li\u00ean quan \u0111\u1ec3 ho\u00e0n t\u1ea5t qu\u00e1 tr\u00ecnh \u0111\u0103ng nh\u1eadp.</p>"},{"location":"services/auth-service/master/design/#12-nam-trong-pham-vi","title":"1.2. \u2705 N\u1eb1m trong ph\u1ea1m vi","text":"<ul> <li>X\u00e1c th\u1ef1c danh t\u00ednh ng\u01b0\u1eddi d\u00f9ng qua c\u00e1c ph\u01b0\u01a1ng th\u1ee9c \u0111\u01b0\u1ee3c h\u1ed7 tr\u1ee3:</li> <li>\u2705 Google OAuth2</li> <li>\u2705 OTP (One-Time Password)</li> <li>\u2705 Local (username/password)</li> <li>L\u1ea5y th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng (email, name, avatar, user_id...) t\u1eeb Google v\u00e0 \u0111\u1ed3ng b\u1ed9 v\u1edbi <code>user-service</code>.</li> <li>G\u1eedi y\u00eau c\u1ea7u sinh token t\u1edbi <code>token-service</code> th\u00f4ng qua API <code>POST /v1/token/issue</code>.</li> <li>L\u01b0u audit log \u0111\u0103ng nh\u1eadp qua <code>audit-service</code>.</li> <li>Tr\u1ea3 l\u1ea1i ph\u1ea3n h\u1ed3i chu\u1ea9n h\u00f3a (<code>SuccessEnvelope</code>, <code>ErrorEnvelope</code>) cho frontend ho\u1eb7c API Gateway.</li> </ul>"},{"location":"services/auth-service/master/design/#13-ngoai-pham-vi","title":"1.3. \ud83d\udeab Ngo\u00e0i ph\u1ea1m vi","text":"<ul> <li>\u274c Kh\u00f4ng t\u1ef1 t\u1ea1o JWT token (\u1ee7y quy\u1ec1n cho <code>token-service</code>).</li> <li>\u274c Kh\u00f4ng l\u01b0u tr\u1eef session/token.</li> <li>\u274c Kh\u00f4ng qu\u1ea3n l\u00fd RBAC hay introspect permission.</li> <li>\u274c Kh\u00f4ng x\u1eed l\u00fd logic li\u00ean quan \u0111\u1ebfn magic link, OTP, ho\u1eb7c x\u00e1c th\u1ef1c 2 b\u01b0\u1edbc (2FA).</li> </ul>"},{"location":"services/auth-service/master/design/#14-nguoi-su-dung-chinh","title":"1.4. \ud83d\udc65 Ng\u01b0\u1eddi s\u1eed d\u1ee5ng ch\u00ednh","text":"<ul> <li>Frontend client (qua OAuth2 redirect flow)</li> <li>API Gateway (g\u1ecdi <code>/me</code>, <code>/verify</code>)</li> <li>token-service (\u0111\u01b0\u1ee3c g\u1ecdi t\u1edbi t\u1eeb \u0111\u00e2y)</li> <li>user-service (\u0111\u01b0\u1ee3c truy v\u1ea5n ho\u1eb7c ghi \u0111\u00e8 user n\u1ebfu ch\u01b0a t\u1ed3n t\u1ea1i)</li> </ul>"},{"location":"services/auth-service/master/design/#2-thiet-ke-api-chi-tiet","title":"2. \ud83c\udf10 Thi\u1ebft k\u1ebf API chi ti\u1ebft","text":""},{"location":"services/auth-service/master/design/#21-nhom-oauth2-authentication","title":"2.1. \ud83d\udd10 Nh\u00f3m: OAuth2 Authentication","text":"Ph\u01b0\u01a1ng th\u1ee9c Endpoint M\u00f4 t\u1ea3 ng\u1eafn Auth Permission Ghi ch\u00fa GET /oauth2/login B\u1eaft \u0111\u1ea7u lu\u1ed3ng x\u00e1c th\u1ef1c v\u1edbi Google OAuth2 \u274c \u274c Redirect \u0111\u1ebfn Google GET /oauth2/callback Nh\u1eadn m\u00e3 <code>code</code> t\u1eeb Google, x\u1eed l\u00fd l\u1ea5y access token \u274c \u274c Internal callback endpoint POST /auth/exchange X\u1eed l\u00fd lu\u1ed3ng login ho\u00e0n ch\u1ec9nh v\u00e0 c\u1ea5p JWT token \u274c \u274c G\u1ecdi Google, \u0111\u1ed3ng b\u1ed9 user, g\u1ecdi <code>token-service</code> POST /auth/otp G\u1eedi m\u00e3 OTP \u0111\u1ebfn s\u1ed1 \u0111i\u1ec7n tho\u1ea1i/email \u274c \u274c Cho ph\u00e9p public truy c\u1eadp POST /auth/verify-otp X\u00e1c minh m\u00e3 OTP v\u00e0 c\u1ea5p token n\u1ebfu h\u1ee3p l\u1ec7 \u274c \u274c G\u1ecdi <code>token-service</code> sau x\u00e1c th\u1ef1c POST /auth/login \u0110\u0103ng nh\u1eadp b\u1eb1ng username/password \u274c \u274c G\u1ecdi <code>user-service</code> x\u00e1c minh, sau \u0111\u00f3 g\u1ecdi <code>token-service</code> <p>\ud83d\udd04 Trong lu\u1ed3ng <code>POST /auth/exchange</code>, sau khi x\u00e1c th\u1ef1c th\u00e0nh c\u00f4ng t\u1eeb Google: 1. G\u1ecdi <code>user-service</code> \u0111\u1ec3 tra c\u1ee9u/\u0111\u1ed3ng b\u1ed9 user. 2. G\u1ecdi <code>token-service</code> \u0111\u1ec3 ph\u00e1t h\u00e0nh access &amp; refresh token.</p>"},{"location":"services/auth-service/master/design/#22-nhom-user-identity","title":"2.2. \ud83d\ude4b Nh\u00f3m: User Identity","text":"Ph\u01b0\u01a1ng th\u1ee9c Endpoint M\u00f4 t\u1ea3 ng\u1eafn Auth Permission Ghi ch\u00fa GET /me L\u1ea5y th\u00f4ng tin user hi\u1ec7n t\u1ea1i (t\u1eeb access token) \u2705 <code>user.read.self</code> Tr\u00edch xu\u1ea5t t\u1eeb token POST /verify X\u00e1c th\u1ef1c ch\u1eef k\u00fd v\u00e0 n\u1ed9i dung c\u1ee7a access token \u2705 <code>auth.verify.token</code> D\u00e0nh cho API Gateway"},{"location":"services/auth-service/master/design/#23-nhom-internal-testing","title":"2.3. \ud83e\uddea Nh\u00f3m: Internal &amp; Testing","text":"Ph\u01b0\u01a1ng th\u1ee9c Endpoint M\u00f4 t\u1ea3 ng\u1eafn Auth Permission Ghi ch\u00fa POST /dev/mimic Gi\u1ea3 l\u1eadp user login (d\u00e0nh cho dev only) \u274c <code>auth.mimic.dev</code> Ch\u1ec9 b\u1eadt \u1edf <code>debug_mode</code> GET /oauth2/debug In ra th\u00f4ng tin access token t\u1eeb Google \u274c <code>auth.oauth.debug</code> Internal"},{"location":"services/auth-service/master/design/#24-ghi-chu-chung","title":"2.4. \ud83d\udccc Ghi ch\u00fa chung","text":"<ul> <li>C\u00e1c API ch\u00ednh \u0111\u1ec1u tu\u00e2n theo chu\u1ea9n <code>SuccessEnvelope</code> v\u00e0 <code>ErrorEnvelope</code> nh\u01b0 m\u00f4 t\u1ea3 trong <code>ADR-011</code>, <code>ADR-012</code>.</li> <li>Vi\u1ec7c sinh token kh\u00f4ng n\u1eb1m trong auth-service \u2013 thay v\u00e0o \u0111\u00f3, API <code>/auth/exchange</code> s\u1ebd g\u1ecdi <code>token-service</code> \u0111\u1ec3 l\u1ea5y JWT v\u00e0 <code>session_id</code>.</li> <li>C\u00e1c API <code>/me</code> v\u00e0 <code>/verify</code> ph\u1ee5c v\u1ee5 frontend v\u00e0 Gateway ki\u1ec3m tra token.</li> </ul> <p>Chi ti\u1ebft: Interface Contract &amp; OpenAPI</p> <p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 ph\u1ea7n \u0111\u00e3 vi\u1ebft l\u1ea1i cho m\u1ee5c <code>## 3. \ud83d\udcc3 M\u00f4 h\u00ecnh d\u1eef li\u1ec7u</code> trong <code>auth-service/master/design.md</code>, ph\u1ea3n \u00e1nh \u0111\u00fang vai tr\u00f2 \"\u0111i\u1ec1u ph\u1ed1i x\u00e1c th\u1ef1c\", v\u00e0 tu\u00e2n th\u1ee7 ch\u1ec9 th\u1ecb l\u00e0 kh\u00f4ng m\u00f4 t\u1ea3 session/token n\u1ed9i b\u1ed9, v\u00ec ph\u1ea7n \u0111\u00f3 thu\u1ed9c <code>token-service</code>.</p>"},{"location":"services/auth-service/master/design/#3-mo-hinh-du-lieu","title":"3. \ud83d\udcc3 M\u00f4 h\u00ecnh d\u1eef li\u1ec7u","text":""},{"location":"services/auth-service/master/design/#31-bang-auth_provider_config","title":"3.1. B\u1ea3ng <code>auth_provider_config</code>","text":"<p>\u0110\u00e2y l\u00e0 b\u1ea3ng duy nh\u1ea5t <code>auth-service/master</code> th\u1ef1c s\u1ef1 qu\u1ea3n l\u00fd trong DB n\u1ed9i b\u1ed9. N\u00f3 l\u01b0u th\u00f4ng tin c\u1ea5u h\u00ecnh OAuth2 theo t\u1eebng tenant, cho ph\u00e9p h\u1ec7 th\u1ed1ng m\u1edf r\u1ed9ng h\u1ed7 tr\u1ee3 nhi\u1ec1u nh\u00e0 cung c\u1ea5p x\u00e1c th\u1ef1c trong t\u01b0\u01a1ng lai.</p> Tr\u01b0\u1eddng Ki\u1ec3u d\u1eef li\u1ec7u Ghi ch\u00fa <code>id</code> UUID Kh\u00f3a ch\u00ednh <code>tenant_id</code> TEXT M\u00e3 tenant li\u00ean k\u1ebft <code>provider</code> TEXT Hi\u1ec7n t\u1ea1i l\u00e0 <code>\"google\"</code> <code>client_id</code> TEXT Google OAuth2 Client ID <code>client_secret</code> TEXT Google OAuth2 Secret (m\u00e3 h\u00f3a) <code>redirect_uri</code> TEXT Redirect URI kh\u1edbp v\u1edbi Google config <code>scopes</code> TEXT[] M\u1ea3ng scopes y\u00eau c\u1ea7u t\u1eeb Google <code>is_active</code> BOOLEAN Provider n\u00e0y c\u00f3 \u0111ang \u0111\u01b0\u1ee3c k\u00edch ho\u1ea1t kh\u00f4ng <code>created_at</code> TIMESTAMPTZ M\u1eb7c \u0111\u1ecbnh <code>now()</code> <code>updated_at</code> TIMESTAMPTZ T\u1ef1 \u0111\u1ed9ng c\u1eadp nh\u1eadt <p>\ud83d\udee1 M\u1ecdi access_token c\u1ee7a Google s\u1ebd ch\u1ec9 \u0111\u01b0\u1ee3c l\u1ea5y n\u1ebfu provider \u0111\u00f3 <code>is_active</code>.</p>"},{"location":"services/auth-service/master/design/#32-payload-goi-token-service","title":"3.2. Payload g\u1ecdi <code>token-service</code>","text":"<p>Khi x\u00e1c th\u1ef1c th\u00e0nh c\u00f4ng v\u00e0 c\u1ea7n ph\u00e1t h\u00e0nh token, <code>auth-service/master</code> s\u1ebd g\u1eedi payload sau \u0111\u1ebfn <code>token-service</code> qua API <code>POST /v1/token/issue</code>:</p> <pre><code>{\n  \"user_id\": \"u123\",\n  \"tenant_id\": \"vas-primary\",\n  \"email\": \"user@example.com\",\n  \"name\": \"Nguy\u1ec5n V\u0103n A\",\n  \"avatar\": \"https://example.com/avatar.png\",\n  \"grant_type\": \"google\",\n  \"client_ip\": \"1.2.3.4\",\n  \"user_agent\": \"Chrome/117\"\n}\n</code></pre> <p>\ud83d\udccc \u0110\u00e2y l\u00e0 payload chu\u1ea9n h\u00f3a gi\u1eefa c\u00e1c d\u1ecbch v\u1ee5. <code>token-service</code> s\u1ebd x\u1eed l\u00fd logic RBAC, sinh JWT, l\u01b0u session v\u00e0 tr\u1ea3 l\u1ea1i <code>access_token</code>, <code>refresh_token</code>, <code>expires_in</code>, <code>session_id</code>.</p> <ul> <li><code>grant_type</code>: l\u00e0 ph\u01b0\u01a1ng th\u1ee9c x\u00e1c th\u1ef1c ban \u0111\u1ea7u c\u1ee7a ng\u01b0\u1eddi d\u00f9ng. M\u1ed9t trong:</li> <li><code>google</code></li> <li><code>otp</code></li> <li><code>local</code></li> </ul>"},{"location":"services/auth-service/master/design/#33-audit-logging","title":"3.3. Audit Logging","text":"<p>M\u1ecdi l\u1ea7n login th\u00e0nh c\u00f4ng s\u1ebd g\u1eedi event t\u1edbi <code>audit-service</code>:</p> <pre><code>{\n  \"event\": \"auth.login.success\",\n  \"user_id\": \"u123\",\n  \"tenant_id\": \"vas-primary\",\n  \"method\": \"google_oauth2\",\n  \"timestamp\": \"2025-06-10T12:00:00Z\"\n}\n</code></pre> <p>\ud83d\udccc L\u01b0u \u00fd: Auth Service kh\u00f4ng ch\u1ee9a b\u1ea3ng <code>users</code>, kh\u00f4ng l\u01b0u token, kh\u00f4ng truy c\u1eadp tr\u1ef1c ti\u1ebfp Redis. C\u00e1c d\u1eef li\u1ec7u \u0111\u00f3 thu\u1ed9c tr\u00e1ch nhi\u1ec7m c\u1ee7a <code>user-service</code> v\u00e0 <code>token-service</code>.</p> <p>\ud83d\udc49 Chi ti\u1ebft s\u01a1 \u0111\u1ed3 ERD, \u0111\u1ecbnh ngh\u0129a b\u1ea3ng v\u00e0 chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed d\u1eef li\u1ec7u \u0111\u01b0\u1ee3c tr\u00ecnh b\u00e0y t\u1ea1i: \ud83d\udcc2 Data Model</p> <p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 n\u1ed9i dung chi ti\u1ebft cho m\u1ee5c <code>## 4. \ud83d\udd04 Lu\u1ed3ng x\u1eed l\u00fd nghi\u1ec7p v\u1ee5 ch\u00ednh</code> c\u1ee7a <code>auth-service/master/design.md</code>, \u0111\u01b0\u1ee3c vi\u1ebft l\u1ea1i theo m\u00f4 h\u00ecnh \u0111i\u1ec1u ph\u1ed1i x\u00e1c th\u1ef1c hi\u1ec7n t\u1ea1i.</p>"},{"location":"services/auth-service/master/design/#4-luong-xu-ly-nghiep-vu-chinh","title":"4. \ud83d\udd04 Lu\u1ed3ng x\u1eed l\u00fd nghi\u1ec7p v\u1ee5 ch\u00ednh","text":""},{"location":"services/auth-service/master/design/#41-muc-tieu","title":"4.1. \ud83c\udfaf M\u1ee5c ti\u00eau","text":"<p>Lu\u1ed3ng x\u1eed l\u00fd t\u1eadp trung v\u00e0o vi\u1ec7c x\u00e1c th\u1ef1c danh t\u00ednh ng\u01b0\u1eddi d\u00f9ng qua Google OAuth2 v\u00e0 \u0111i\u1ec1u ph\u1ed1i c\u00e1c d\u1ecbch v\u1ee5 li\u00ean quan \u0111\u1ec3: - \u0110\u1ed3ng b\u1ed9 th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng v\u00e0o <code>user-service</code> - Ph\u00e1t h\u00e0nh token th\u00f4ng qua <code>token-service</code> - G\u1eedi log s\u1ef1 ki\u1ec7n x\u00e1c th\u1ef1c t\u1edbi <code>audit-service</code></p>"},{"location":"services/auth-service/master/design/#42-luong-google-oauth2-login-token-issue","title":"4.2. \ud83d\udd01 Lu\u1ed3ng: Google OAuth2 Login &amp; Token Issue","text":"<pre><code>sequenceDiagram\n    participant Client\n    participant AuthService\n    participant Google\n    participant UserService\n    participant TokenService\n    participant AuditService\n\n    Client-&gt;&gt;AuthService: GET /oauth2/login\n    AuthService-&gt;&gt;Google: Redirect \u0111\u1ebfn Google OAuth2\n\n    Google-&gt;&gt;Client: Redirect callback + ?code\n    Client-&gt;&gt;AuthService: GET /oauth2/callback?code=...\n\n    AuthService-&gt;&gt;Google: Trao \u0111\u1ed5i access_token\n    Google--&gt;&gt;AuthService: Tr\u1ea3 userinfo\n\n    AuthService-&gt;&gt;UserService: POST /v1/users/global/sync\n    UserService--&gt;&gt;AuthService: user_id\n\n    AuthService-&gt;&gt;TokenService: POST /v1/token/issue\n    TokenService--&gt;&gt;AuthService: access_token, refresh_token, session_id\n\n    AuthService-&gt;&gt;AuditService: POST /v1/audit/event (auth.login.success)\n\n    AuthService--&gt;&gt;Client: 200 OK + SuccessEnvelope\n</code></pre> <p>\ud83d\udc49 C\u00e1c lu\u1ed3ng x\u00e1c th\u1ef1c kh\u00e1c nh\u01b0 <code>OTP</code>, <code>Local login</code> c\u0169ng tu\u00e2n theo quy tr\u00ecnh t\u01b0\u01a1ng t\u1ef1: X\u00e1c minh \u2192 \u0111\u1ed3ng b\u1ed9 user \u2192 g\u1ecdi <code>token-service</code> \u2192 g\u1eedi audit log.</p>"},{"location":"services/auth-service/master/design/#43-dien-giai-chi-tiet","title":"4.3. \ud83e\udde0 Di\u1ec5n gi\u1ea3i chi ti\u1ebft","text":"<ol> <li> <p>B\u1eaft \u0111\u1ea7u OAuth2:    <code>Client</code> g\u1ecdi <code>GET /oauth2/login</code> \u2192 redirect \u0111\u1ebfn Google.</p> </li> <li> <p>Nh\u1eadn m\u00e3 x\u00e1c th\u1ef1c:    Google redirect v\u1ec1 <code>/oauth2/callback?code=...</code> <code>AuthService</code> d\u00f9ng <code>code</code> \u0111\u1ec3 l\u1ea5y access_token v\u00e0 userinfo.</p> </li> <li> <p>\u0110\u1ed3ng b\u1ed9 th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng:    G\u1eedi th\u00f4ng tin Google profile \u0111\u1ebfn <code>user-service</code> \u0111\u1ec3 t\u00ecm ho\u1eb7c t\u1ea1o user (<code>/v1/users/global/sync</code>).</p> </li> <li> <p>Y\u00eau c\u1ea7u ph\u00e1t h\u00e0nh token:    G\u1eedi <code>user_id</code>, <code>tenant_id</code>, v\u00e0 metadata \u0111\u1ebfn <code>token-service</code> \u0111\u1ec3 sinh token.</p> </li> <li> <p>Ghi log audit:    G\u1eedi event <code>auth.login.success</code> k\u00e8m <code>user_id</code>, <code>method</code>, <code>tenant_id</code>.</p> </li> <li> <p>Tr\u1ea3 k\u1ebft qu\u1ea3 cho client:    Ph\u1ea3n h\u1ed3i g\u1ed3m <code>access_token</code>, <code>refresh_token</code>, <code>expires_in</code>, <code>session_id</code> trong <code>SuccessEnvelope</code>.</p> </li> </ol>"},{"location":"services/auth-service/master/design/#44-luu-y-ac-biet","title":"4.4. \u26a0\ufe0f L\u01b0u \u00fd \u0111\u1eb7c bi\u1ec7t","text":"<ul> <li>Lu\u1ed3ng n\u00e0y kh\u00f4ng s\u1eed d\u1ee5ng cookie session, ch\u1ec9 ho\u1ea1t \u0111\u1ed9ng b\u1eb1ng JWT.</li> <li>T\u1ea5t c\u1ea3 token v\u00e0 session \u0111\u1ec1u \u0111\u01b0\u1ee3c ph\u00e1t h\u00e0nh v\u00e0 qu\u1ea3n l\u00fd b\u1edfi <code>token-service</code>.</li> <li><code>auth-service/master</code> \u0111\u00f3ng vai tr\u00f2 \u0111i\u1ec1u ph\u1ed1i th\u00f4ng minh, kh\u00f4ng gi\u1eef state.</li> </ul>"},{"location":"services/auth-service/master/design/#5-tuong-tac-giua-cac-service","title":"5. \ud83d\udce3 T\u01b0\u01a1ng t\u00e1c gi\u1eefa c\u00e1c service","text":"<p><code>auth-service/master</code> kh\u00f4ng ho\u1ea1t \u0111\u1ed9ng \u0111\u1ed9c l\u1eadp, m\u00e0 l\u00e0 m\u1ed9t trung t\u00e2m \u0111i\u1ec1u ph\u1ed1i c\u00e1c t\u01b0\u01a1ng t\u00e1c x\u00e1c th\u1ef1c v\u1edbi c\u00e1c d\u1ecbch v\u1ee5 l\u00f5i c\u1ee7a h\u1ec7 th\u1ed1ng DX-VAS.</p>"},{"location":"services/auth-service/master/design/#51-google-oauth2-provider","title":"\ud83d\udd17 5.1. <code>Google OAuth2 Provider</code>","text":"<ul> <li>D\u00f9ng \u0111\u1ec3 x\u00e1c th\u1ef1c danh t\u00ednh ng\u01b0\u1eddi d\u00f9ng b\u1eb1ng OAuth2 Authorization Code Flow.</li> <li>Giao ti\u1ebfp th\u00f4ng qua 2 b\u01b0\u1edbc:</li> <li>Redirect \u0111\u1ebfn URL x\u00e1c th\u1ef1c c\u1ee7a Google (<code>/oauth2/login</code>)</li> <li>G\u1ecdi Google API \u0111\u1ec3 l\u1ea5y access token v\u00e0 th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng (<code>/oauth2/callback</code>)</li> </ul>"},{"location":"services/auth-service/master/design/#52-user-service","title":"\ud83d\udd17 5.2. <code>user-service</code>","text":"API Vai tr\u00f2 <code>POST /v1/users/global/sync</code> T\u00ecm ho\u1eb7c t\u1ea1o ng\u01b0\u1eddi d\u00f9ng t\u1eeb th\u00f4ng tin Google profile. Tr\u1ea3 v\u1ec1 <code>user_id</code>, <code>tenant_id</code> <ul> <li>\u0110\u00e2y l\u00e0 b\u01b0\u1edbc \u0111\u1ea3m b\u1ea3o m\u1ecdi ng\u01b0\u1eddi d\u00f9ng \u0111\u1ec1u c\u00f3 b\u1ea3n ghi \u0111\u1ea7y \u0111\u1ee7 trong h\u1ec7 th\u1ed1ng.</li> <li>Thao t\u00e1c n\u00e0y l\u00e0 idempotent \u2013 c\u00f3 th\u1ec3 g\u1ecdi nhi\u1ec1u l\u1ea7n m\u00e0 kh\u00f4ng sinh b\u1ea3n ghi tr\u00f9ng.</li> </ul>"},{"location":"services/auth-service/master/design/#tat-ca-cac-phuong-thuc-xac-thuc-oauth2-otp-local-eu-goi-user-service-e-tim-hoac-tao-user","title":"&gt; \ud83d\udd01 T\u1ea5t c\u1ea3 c\u00e1c ph\u01b0\u01a1ng th\u1ee9c x\u00e1c th\u1ef1c (OAuth2, OTP, Local) \u0111\u1ec1u g\u1ecdi <code>user-service</code> \u0111\u1ec3 t\u00ecm ho\u1eb7c t\u1ea1o user.","text":""},{"location":"services/auth-service/master/design/#53-token-service","title":"\ud83d\udd17 5.3. <code>token-service</code>","text":"API Vai tr\u00f2 <code>POST /v1/token/issue</code> Ph\u00e1t h\u00e0nh JWT token (access + refresh) v\u00e0 session_id. <ul> <li>Nh\u1eadn v\u00e0o: <code>user_id</code>, <code>tenant_id</code>, <code>client_ip</code>, <code>user_agent</code>, <code>grant_type</code>.</li> <li>Tr\u1ea3 ra: <code>access_token</code>, <code>refresh_token</code>, <code>session_id</code>, <code>expires_in</code>.</li> </ul> <p>\u2705 Token ch\u1ec9 \u0111\u01b0\u1ee3c sinh n\u1ebfu x\u00e1c th\u1ef1c danh t\u00ednh th\u00e0nh c\u00f4ng v\u00e0 c\u00f3 <code>user_id</code> h\u1ee3p l\u1ec7.</p>"},{"location":"services/auth-service/master/design/#54-audit-service","title":"\ud83d\udd17 5.4. <code>audit-service</code>","text":"API Vai tr\u00f2 <code>POST /v1/audit/event</code> Ghi nh\u1eadn s\u1ef1 ki\u1ec7n x\u00e1c th\u1ef1c: <code>auth.login.success</code>, <code>auth.login.failed</code>... <ul> <li>G\u1eedi k\u00e8m: <code>user_id</code>, <code>tenant_id</code>, <code>timestamp</code>, <code>grant_type</code>, <code>client_ip</code>.</li> </ul>"},{"location":"services/auth-service/master/design/#55-api-gateway","title":"\ud83d\udd17 5.5. <code>api-gateway</code>","text":"API g\u1ecdi t\u1edbi M\u1ee5c \u0111\u00edch <code>GET /me</code> L\u1ea5y th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng hi\u1ec7n t\u1ea1i <code>POST /verify</code> Ki\u1ec3m tra t\u00ednh h\u1ee3p l\u1ec7 v\u00e0 ch\u1eef k\u00fd c\u1ee7a JWT <ul> <li>Hai API n\u00e0y gi\u00fap Gateway introspect token m\u1ed9t c\u00e1ch nh\u1eb9, kh\u00f4ng c\u1ea7n decode ho\u1eb7c g\u1ecdi \u0111\u1ebfn <code>token-service</code>.</li> </ul> <p>\ud83d\udccc T\u00f3m l\u1ea1i, auth-service/master: - Kh\u00f4ng gi\u1eef tr\u1ea1ng th\u00e1i, nh\u01b0ng \u0111i\u1ec1u ph\u1ed1i tr\u1ea1ng th\u00e1i qua c\u00e1c service kh\u00e1c. - L\u00e0 \u0111i\u1ec3m giao ti\u1ebfp ch\u00ednh gi\u1eefa th\u1ebf gi\u1edbi ngo\u00e0i (Google) v\u00e0 h\u1ec7 th\u1ed1ng n\u1ed9i b\u1ed9.</p>"},{"location":"services/auth-service/master/design/#6-bao-mat-phan-quyen","title":"6. \ud83d\udd10 B\u1ea3o m\u1eadt &amp; Ph\u00e2n quy\u1ec1n","text":""},{"location":"services/auth-service/master/design/#61-co-che-bao-mat-tong-the","title":"\ud83d\udd10 6.1. C\u01a1 ch\u1ebf b\u1ea3o m\u1eadt t\u1ed5ng th\u1ec3","text":"<p><code>auth-service/master</code> \u00e1p d\u1ee5ng m\u00f4 h\u00ecnh b\u1ea3o m\u1eadt theo chu\u1ea9n zero-trust:</p> <ul> <li>\u2705 OAuth2 redirect flow: s\u1eed d\u1ee5ng Google l\u00e0m Identity Provider.</li> <li>\u2705 JWT-based authentication: m\u1ecdi truy c\u1eadp t\u1eeb frontend ho\u1eb7c gateway \u0111\u1ec1u d\u00f9ng <code>Authorization: Bearer</code>.</li> <li>\u2705 HTTPS-only: m\u1ecdi endpoint \u0111\u1ec1u \u0111\u01b0\u1ee3c truy c\u1eadp qua HTTPS, k\u1ec3 c\u1ea3 redirect v\u00e0 callback.</li> <li>\u2705 Kh\u00f4ng gi\u1eef state ng\u01b0\u1eddi d\u00f9ng: kh\u00f4ng d\u00f9ng session ho\u1eb7c cookie \u2013 m\u1ecdi th\u00f4ng tin x\u00e1c th\u1ef1c \u0111\u01b0\u1ee3c ki\u1ec3m ch\u1ee9ng qua JWT.</li> </ul>"},{"location":"services/auth-service/master/design/#62-kiem-soat-truy-cap-phan-quyen","title":"\ud83e\udde9 6.2. Ki\u1ec3m so\u00e1t truy c\u1eadp &amp; Ph\u00e2n quy\u1ec1n","text":"Endpoint Y\u00eau c\u1ea7u Auth Permission y\u00eau c\u1ea7u Ghi ch\u00fa <code>/oauth2/*</code> \u274c \u274c Cho ph\u00e9p public truy c\u1eadp <code>/auth/exchange</code> \u274c \u274c Lu\u1ed3ng c\u1ea5p token \u0111\u01b0\u1ee3c b\u1ea3o v\u1ec7 b\u1eb1ng OAuth2 code <code>/me</code> \u2705 <code>user.read.self</code> Ph\u00e2n quy\u1ec1n n\u1ed9i t\u1ea1i trong token <code>/verify</code> \u2705 <code>auth.verify.token</code> Ch\u1ec9 g\u1ecdi \u0111\u01b0\u1ee3c n\u1ebfu token h\u1ee3p l\u1ec7 <code>/dev/mimic</code> \u274c (n\u1ebfu debug mode) <code>auth.mimic.dev</code> Ch\u1ec9 b\u1eadt trong m\u00f4i tr\u01b0\u1eddng dev <code>/auth/login</code> \u274c \u274c Local login <code>/auth/otp</code> \u274c \u274c G\u1eedi m\u00e3 OTP <code>/auth/verify-otp</code> \u274c \u274c X\u00e1c minh OTP <p>\u2705 T\u1ea5t c\u1ea3 ph\u00e2n quy\u1ec1n \u0111\u1ed9ng \u0111\u1ec1u \u0111\u01b0\u1ee3c ki\u1ec3m so\u00e1t \u1edf c\u1ea5p <code>api-gateway</code>. Auth service kh\u00f4ng c\u1ea7n t\u1ef1 tra quy\u1ec1n.</p>"},{"location":"services/auth-service/master/design/#63-header-kiem-soat-trace","title":"\ud83e\uddfe 6.3. Header ki\u1ec3m so\u00e1t &amp; Trace","text":"<p>Auth service x\u1eed l\u00fd v\u00e0 forward c\u00e1c header sau:</p> Header Vai tr\u00f2 <code>Authorization</code> Bearer token \u0111\u1ec3 x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng <code>X-Tenant-ID</code> M\u00e3 tenant \u0111\u01b0\u1ee3c tr\u00edch xu\u1ea5t t\u1eeb token <code>X-Trace-ID</code> D\u00f9ng \u0111\u1ec3 trace to\u00e0n b\u1ed9 lu\u1ed3ng x\u1eed l\u00fd <code>X-User-ID</code> Inject v\u00e0o response (\u1edf <code>/me</code>, <code>/verify</code>) <code>X-Login-Method</code> Ph\u01b0\u01a1ng th\u1ee9c \u0111\u0103ng nh\u1eadp (<code>google</code>, <code>otp</code>, <code>local</code>) \u2013 \u0111\u01b0\u1ee3c decode t\u1eeb JWT, h\u1ed7 tr\u1ee3 logging &amp; conditional logic ph\u00eda backend"},{"location":"services/auth-service/master/design/#64-chinh-sach-jwt","title":"\ud83d\udcdc 6.4. Ch\u00ednh s\u00e1ch JWT","text":"<ul> <li>issuer (<code>iss</code>): <code>https://auth.truongvietanh.edu.vn</code></li> <li>audience (<code>aud</code>): <code>dx-vas</code></li> <li>scope: ch\u01b0a s\u1eed d\u1ee5ng, c\u00f3 th\u1ec3 m\u1edf r\u1ed9ng</li> <li>exp: \u0111\u01b0\u1ee3c thi\u1ebft l\u1eadp b\u1edfi <code>token-service</code>, kh\u00f4ng can thi\u1ec7p</li> <li>signature: s\u1eed d\u1ee5ng HS256 ho\u1eb7c RS256, c\u1ea5u h\u00ecnh t\u1ea1i <code>token-service</code></li> </ul>"},{"location":"services/auth-service/master/design/#65-bien-phap-chong-gia-mao","title":"\u26a0\ufe0f 6.5. Bi\u1ec7n ph\u00e1p ch\u1ed1ng gi\u1ea3 m\u1ea1o","text":"<ul> <li>Kh\u00f4ng ch\u1ea5p nh\u1eadn b\u1ea5t k\u1ef3 request c\u00f3 <code>code</code> ho\u1eb7c <code>token</code> t\u1eeb Google n\u1ebfu kh\u00f4ng \u0111\u01b0\u1ee3c x\u00e1c th\u1ef1c tr\u1ef1c ti\u1ebfp qua callback URL h\u1ee3p l\u1ec7.</li> <li>Callback URL ph\u1ea3i match 100% <code>redirect_uri</code> \u0111\u00e3 \u0111\u0103ng k\u00fd trong b\u1ea3ng <code>auth_provider_config</code>.</li> <li>T\u1ef1 \u0111\u1ed9ng ki\u1ec3m tra <code>nonce</code> n\u1ebfu tri\u1ec3n khai OIDC.</li> </ul> <p>\u2705 B\u1ea3o m\u1eadt h\u1ec7 th\u1ed1ng kh\u00f4ng n\u1eb1m \u1edf auth-service ri\u00eang l\u1ebb, m\u00e0 \u1edf s\u1ef1 ph\u1ed1i h\u1ee3p chu\u1ea9n h\u00f3a gi\u1eefa auth-service, token-service v\u00e0 api-gateway.</p>"},{"location":"services/auth-service/master/design/#7-cau-hinh-phu-thuoc","title":"7. \u2699\ufe0f C\u1ea5u h\u00ecnh &amp; Ph\u1ee5 thu\u1ed9c","text":""},{"location":"services/auth-service/master/design/#71-cau-hinh-moi-truong-environment-variables","title":"\ud83d\udd27 7.1. C\u1ea5u h\u00ecnh m\u00f4i tr\u01b0\u1eddng (Environment Variables)","text":"Bi\u1ebfn M\u00f4 t\u1ea3 V\u00ed d\u1ee5 <code>ENV</code> M\u00f4i tr\u01b0\u1eddng v\u1eadn h\u00e0nh <code>production</code> / <code>staging</code> / <code>dev</code> <code>PORT</code> C\u1ed5ng service l\u1eafng nghe <code>8080</code> <code>OAUTH_CLIENT_ID</code> Google OAuth2 client ID <code>abc123.apps.googleusercontent.com</code> <code>OAUTH_CLIENT_SECRET</code> Google OAuth2 client secret (m\u00e3 h\u00f3a) <code>secretXYZ</code> <code>OAUTH_REDIRECT_URI</code> Redirect URI sau khi x\u00e1c th\u1ef1c Google <code>https://auth.truongvietanh.edu.vn/oauth2/callback</code> <code>AUDIT_SERVICE_URL</code> Endpoint \u0111\u1ec3 g\u1eedi log t\u1edbi <code>audit-service</code> <code>http://audit-service/v1/audit/event</code> <code>USER_SERVICE_URL</code> Endpoint \u0111\u1ec3 \u0111\u1ed3ng b\u1ed9 user <code>http://user-service/v1/users/global/sync</code> <code>TOKEN_SERVICE_URL</code> Endpoint \u0111\u1ec3 y\u00eau c\u1ea7u c\u1ea5p token <code>http://token-service/v1/token/issue</code> <code>DEBUG_MODE</code> B\u1eadt c\u00e1c API d\u00e0nh cho m\u00f4i tr\u01b0\u1eddng ph\u00e1t tri\u1ec3n <code>true</code> / <code>false</code>"},{"location":"services/auth-service/master/design/#72-phu-thuoc-he-thong","title":"\ud83d\udce6 7.2. Ph\u1ee5 thu\u1ed9c h\u1ec7 th\u1ed1ng","text":"Th\u00e0nh ph\u1ea7n Vai tr\u00f2 ch\u00ednh Ghi ch\u00fa <code>Google OAuth2</code> X\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng OAuth2 flow <code>user-service</code> Tra c\u1ee9u/\u0111\u1ed3ng b\u1ed9 user \u0110\u1ed3ng b\u1ed9 user_id theo email <code>token-service</code> C\u1ea5p token &amp; qu\u1ea3n l\u00fd session Service n\u00e0y gi\u1eef tr\u1ea1ng th\u00e1i <code>audit-service</code> Ghi nh\u1eadn log x\u00e1c th\u1ef1c G\u1eedi s\u1ef1 ki\u1ec7n \u0111\u0103ng nh\u1eadp, debug"},{"location":"services/auth-service/master/design/#73-khong-phu-thuoc","title":"\ud83e\uddf1 7.3. Kh\u00f4ng ph\u1ee5 thu\u1ed9c","text":"<p>Auth Service kh\u00f4ng ph\u1ee5 thu\u1ed9c v\u00e0o:</p> <ul> <li>Database quan h\u1ec7 cho logic x\u00e1c th\u1ef1c (ch\u1ec9 d\u00f9ng 1 b\u1ea3ng <code>auth_provider_config</code>)</li> <li>Redis (session v\u00e0 revoked token l\u01b0u \u1edf <code>token-service</code>)</li> <li>C\u00e1c c\u00f4ng c\u1ee5 2FA, CAPTCHA (ch\u01b0a t\u00edch h\u1ee3p)</li> </ul>"},{"location":"services/auth-service/master/design/#74-tich-hop-trien-khai-devops","title":"\u2601\ufe0f 7.4. T\u00edch h\u1ee3p tri\u1ec3n khai (DevOps)","text":"Th\u00e0nh ph\u1ea7n Ghi ch\u00fa Dockerfile C\u00f3 s\u1eb5n, d\u00f9ng Python + Uvicorn Helm chart T\u00f9y ch\u1ecdn, d\u00f9ng \u0111\u1ec3 tri\u1ec3n khai trong Kubernetes Liveness Probe <code>/healthz</code> Logging \u0110\u1ecbnh d\u1ea1ng JSON theo chu\u1ea9n chung Metrics <code>/metrics</code> n\u1ebfu b\u1eadt Prometheus exporter <p>\ud83d\udccc T\u1ea5t c\u1ea3 c\u1ea5u h\u00ecnh nh\u1ea1y c\u1ea3m n\u00ean \u0111\u01b0\u1ee3c inject th\u00f4ng qua Secret Manager ho\u1eb7c m\u00f4i tr\u01b0\u1eddng CI/CD (GitHub Actions, GitLab, v.v.).</p>"},{"location":"services/auth-service/master/design/#8-testing","title":"8. \ud83e\uddea Testing","text":"<p>Vi\u1ec7c ki\u1ec3m th\u1eed <code>auth-service/master</code> c\u1ea7n \u0111\u1ea3m b\u1ea3o 3 ti\u00eau ch\u00ed: 1. X\u00e1c th\u1ef1c OAuth2 \u0111\u00fang chu\u1ea9n 2. T\u00edch h\u1ee3p \u0111\u00fang v\u1edbi <code>user-service</code>, <code>token-service</code> 3. Tr\u1ea3 l\u1ed7i \u0111\u00fang chu\u1ea9n <code>ErrorEnvelope</code>, \u0111\u00fang <code>trace_id</code></p>"},{"location":"services/auth-service/master/design/#81-unit-test","title":"\u2705 8.1. Unit Test","text":"Th\u00e0nh ph\u1ea7n M\u1ee5c ti\u00eau ki\u1ec3m th\u1eed OAuth2 flow redirect Ki\u1ec3m tra URL redirect Google \u0111\u00fang c\u1ea5u h\u00ecnh Callback exchange M\u00e3 h\u00f3a/decode <code>code</code>, mock Google API Payload g\u1eedi user-service \u0110\u00fang \u0111\u1ecbnh d\u1ea1ng, ch\u1ee9a \u0111\u1ee7 field Payload g\u1eedi token-service Chu\u1ea9n h\u00f3a theo contract Response formatter Bao b\u1ecdc <code>SuccessEnvelope</code>, <code>ErrorEnvelope</code> Logging &amp; Trace Log <code>trace_id</code>, g\u1ecdi \u0111\u00fang logger <ul> <li>S\u1eed d\u1ee5ng: <code>pytest</code>, <code>pytest-mock</code></li> <li>Coverage khuy\u1ebfn ngh\u1ecb: \u2265 90% core logic</li> </ul>"},{"location":"services/auth-service/master/design/#82-integration-test","title":"\ud83e\uddea 8.2. Integration Test","text":"T\u00ecnh hu\u1ed1ng Ki\u1ec3m th\u1eed t\u00edch h\u1ee3p v\u1edbi Login Google th\u00e0nh c\u00f4ng mock Google + user-service + token-service Login th\u1ea5t b\u1ea1i (token kh\u00f4ng h\u1ee3p l\u1ec7) <code>400 Bad Request</code> Token-service tr\u1ea3 l\u1ed7i \u0110\u1ea3m b\u1ea3o l\u1ed7i \u0111\u01b0\u1ee3c wrap \u0111\u00fang format user-service timeout Tr\u1ea3 l\u1ed7i <code>503 Service Unavailable</code> <ul> <li>C\u00f3 th\u1ec3 mock b\u1eb1ng <code>httpx.MockTransport</code>, <code>requests-mock</code>, ho\u1eb7c <code>wiremock</code> cho local.</li> </ul>"},{"location":"services/auth-service/master/design/#83-end-to-end-test-e2e","title":"\ud83c\udf10 8.3. End-to-End Test (E2E)","text":"M\u00f4i tr\u01b0\u1eddng Test scenario Staging Full OAuth2 login with real Google credentials CI Pipeline Run v\u1edbi service mock ho\u1eb7c stub containers Debug mode Test <code>/dev/mimic</code> tr\u1ea3 token gi\u1ea3 l\u1eadp <ul> <li>Khuy\u1ebfn kh\u00edch d\u00f9ng tool nh\u01b0 <code>Playwright</code>, <code>Postman</code>, ho\u1eb7c <code>k6</code> \u0111\u1ec3 test t\u1ef1 \u0111\u1ed9ng.</li> </ul>"},{"location":"services/auth-service/master/design/#84-bo-test-ac-biet","title":"\ud83d\udccb 8.4. B\u1ed9 test \u0111\u1eb7c bi\u1ec7t","text":"API Test <code>/verify</code> Tr\u1ea3 l\u1ed7i \u0111\u00fang n\u1ebfu token sai ch\u1eef k\u00fd, ho\u1eb7c expired <code>/me</code> Tr\u1ea3 \u0111\u00fang th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng t\u1eeb token payload <code>/auth/exchange</code> Response ch\u1ee9a \u0111\u1ee7 <code>access_token</code>, <code>session_id</code>, <code>expires_in</code>"},{"location":"services/auth-service/master/design/#85-cicd-check","title":"\ud83d\udce6 8.5. CI/CD Check","text":"<ul> <li>\u2705 Format chu\u1ea9n h\u00f3a theo <code>black</code>, <code>flake8</code></li> <li>\u2705 Test ch\u1ea1y qua <code>pytest</code> v\u1edbi coverage</li> <li>\u2705 Swagger linter: <code>spectral lint openapi.yaml</code></li> </ul>"},{"location":"services/auth-service/master/design/#9-observability","title":"9. \ud83d\udcc8 Observability","text":"<p><code>auth-service/master</code> \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf \u0111\u1ec3 d\u1ec5 d\u00e0ng gi\u00e1m s\u00e1t, debug v\u00e0 truy v\u1ebft l\u1ed7i, \u0111\u1ea3m b\u1ea3o c\u00f3 th\u1ec3 quan s\u00e1t to\u00e0n b\u1ed9 lu\u1ed3ng x\u00e1c th\u1ef1c t\u1eeb \u0111\u1ea7u \u0111\u1ebfn cu\u1ed1i trong m\u00f4i tr\u01b0\u1eddng production.</p>"},{"location":"services/auth-service/master/design/#91-logging","title":"\ud83d\udccd 9.1. Logging","text":"Th\u00e0nh ph\u1ea7n Ghi ch\u00fa Format JSON log chu\u1ea9n h\u00f3a B\u1eaft bu\u1ed9c <code>trace_id</code>, <code>tenant_id</code>, <code>user_id</code>, <code>grant_type</code> Level <code>INFO</code> cho flow, <code>ERROR</code> cho exception Logger S\u1eed d\u1ee5ng <code>structlog</code> ho\u1eb7c <code>loguru</code> \u0111\u1ec3 c\u00f3 c\u1ea5u tr\u00fac log t\u1ed1t <p>M\u1ed7i request \u0111\u1ec1u g\u1eafn <code>trace_id</code> (t\u1eeb header ho\u1eb7c sinh m\u1edbi) v\u00e0 ghi log theo lu\u1ed3ng.</p>"},{"location":"services/auth-service/master/design/#92-metrics-prometheus","title":"\ud83d\udcca 9.2. Metrics (Prometheus)","text":"Metric M\u00f4 t\u1ea3 <code>auth_requests_total</code> T\u1ed5ng s\u1ed1 request v\u00e0o <code>auth-service</code> (label theo <code>endpoint</code>, <code>status_code</code>) <code>auth_login_success_total</code> S\u1ed1 l\u1ea7n login th\u00e0nh c\u00f4ng <code>auth_login_failed_total</code> S\u1ed1 l\u1ea7n login th\u1ea5t b\u1ea1i <code>auth_google_latency_seconds</code> \u0110o th\u1eddi gian ph\u1ea3n h\u1ed3i c\u1ee7a Google OAuth2 <code>auth_token_issue_latency_seconds</code> Latency khi g\u1ecdi <code>token-service</code> <p>C\u00f3 th\u1ec3 export metrics qua <code>/metrics</code> (tu\u1ef3 ch\u1ecdn b\u1eadt qua config <code>ENABLE_METRICS=true</code>).</p>"},{"location":"services/auth-service/master/design/#93-audit-logging","title":"\ud83d\udcdd 9.3. Audit Logging","text":"Event G\u1eedi t\u1edbi <code>audit-service</code> <code>auth.login.success</code> Khi login th\u00e0nh c\u00f4ng (k\u00e8m user_id, tenant_id, ip) <code>auth.login.failed</code> Khi login th\u1ea5t b\u1ea1i (l\u00fd do: google_error, user_sync_failed\u2026) <code>auth.token.issue_error</code> Khi g\u1ecdi <code>token-service</code> th\u1ea5t b\u1ea1i <code>auth.login.otp.success</code> Khi OTP login th\u00e0nh c\u00f4ng <code>auth.login.local.success</code> Khi Local login th\u00e0nh c\u00f4ng <code>auth.login.otp.failed</code> Khi OTP kh\u00f4ng \u0111\u00fang ho\u1eb7c h\u1ebft h\u1ea1n <code>auth.login.local.failed</code> Khi username/password sai <p>Audit log gi\u00fap \u0111i\u1ec1u tra post-mortem, ph\u00e2n t\u00edch h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng v\u00e0 tu\u00e2n th\u1ee7.</p>"},{"location":"services/auth-service/master/design/#94-trace-opentelemetry","title":"\ud83d\udcc8 9.4. Trace (OpenTelemetry)","text":"Tr\u1ea1ng th\u00e1i Ghi ch\u00fa \u2705 H\u1ed7 tr\u1ee3 <code>X-Trace-ID</code> xuy\u00ean su\u1ed1t c\u00e1c service \u2705 T\u00edch h\u1ee3p <code>OTEL_EXPORTER_OTLP_ENDPOINT</code> \u0111\u1ec3 g\u1eedi trace ra h\u1ec7 th\u1ed1ng ngo\u00e0i (tempo/jaeger) \u2705 Tag custom: <code>grant_type</code>, <code>user_email</code>, <code>provider</code>, <code>step=google_exchange/token_issue</code> <p>Trace gi\u00fap h\u00ecnh dung \u0111\u01b0\u1ee3c to\u00e0n b\u1ed9 pipeline login: t\u1eeb Google \u2192 user \u2192 token \u2192 audit</p>"},{"location":"services/auth-service/master/design/#95-alert-rule-goi-y","title":"\ud83d\udd0e 9.5. Alert Rule g\u1ee3i \u00fd","text":"Rule M\u00f4 t\u1ea3 <code>login_success_rate &lt; 80% trong 5 ph\u00fat</code> C\u1ea3nh b\u00e1o login b\u1ea5t th\u01b0\u1eddng <code>auth_google_latency_seconds &gt; 2s</code> Google ch\u1eadm <code>auth_token_issue_latency_seconds &gt; 1s</code> Token-service ch\u1eadm ho\u1eb7c l\u1ed7i <p>\ud83d\udccc T\u1ea5t c\u1ea3 c\u00e1c log, metrics v\u00e0 trace c\u1ea7n ph\u1ea3i \u0111\u01b0\u1ee3c g\u1eafn <code>trace_id</code> \u0111\u1ec3 correlate \u0111a chi\u1ec1u.</p>"},{"location":"services/auth-service/master/design/#10-reliability","title":"10. \ud83d\udd01 Reliability","text":"<p><code>auth-service/master</code> \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf v\u1edbi tri\u1ebft l\u00fd stateless + fail-fast, nh\u1eb1m \u0111\u1ea3m b\u1ea3o kh\u1ea3 n\u0103ng ph\u1ee5c h\u1ed3i cao trong m\u1ecdi t\u00ecnh hu\u1ed1ng x\u00e1c th\u1ef1c:</p>"},{"location":"services/auth-service/master/design/#101-stateless-by-design","title":"\ud83d\udca1 10.1. Stateless by Design","text":"<ul> <li>Kh\u00f4ng l\u01b0u token, session hay user state.</li> <li>M\u1ecdi tr\u1ea1ng th\u00e1i \u0111\u01b0\u1ee3c delegate t\u1edbi <code>token-service</code>, <code>user-service</code>.</li> <li>C\u00f3 th\u1ec3 scale ngang (<code>horizontal scaling</code>) d\u1ec5 d\u00e0ng.</li> </ul>"},{"location":"services/auth-service/master/design/#102-co-che-retry-timeout","title":"\ud83d\udd04 10.2. C\u01a1 ch\u1ebf Retry &amp; Timeout","text":"\u0110\u1ed1i t\u01b0\u1ee3ng Timeout Retry Ghi ch\u00fa Google OAuth2 5s \u274c Ch\u1ec9 retry th\u1ee7 c\u00f4ng t\u1eeb ph\u00eda client user-service 3s \u2705 (1 l\u1ea7n) Retry soft tr\u00ean l\u1ed7i 5xx ho\u1eb7c timeout token-service 3s \u2705 (1 l\u1ea7n) Retry n\u1ebfu <code>ECONNREFUSED</code> ho\u1eb7c timeout audit-service 2s \u274c (fire-and-forget) Log l\u1ed7i n\u1ebfu g\u1eedi th\u1ea5t b\u1ea1i, kh\u00f4ng \u1ea3nh h\u01b0\u1edfng user flow <p>\u2757 M\u1ecdi retry \u0111\u1ec1u ph\u1ea3i g\u1eafn <code>trace_id</code> \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o idempotency v\u00e0 debug ch\u00ednh x\u00e1c.</p>"},{"location":"services/auth-service/master/design/#103-fail-fast-strategy","title":"\ud83e\uddf1 10.3. Fail-Fast Strategy","text":"<ul> <li>N\u1ebfu b\u1ea5t k\u1ef3 service backend n\u00e0o tr\u1ea3 v\u1ec1 l\u1ed7i kh\u00f4ng recover \u0111\u01b0\u1ee3c (Google, token, user), Auth Service s\u1ebd tr\u1ea3 l\u1ed7i ngay l\u1eadp t\u1ee9c k\u00e8m <code>ErrorEnvelope</code>.</li> <li>Tr\u00e1nh \u201ch\u1ea5p h\u1ed1i\u201d nhi\u1ec1u t\u1ea7ng \u2013 m\u1ecdi failure \u0111\u1ec1u r\u00f5 r\u00e0ng.</li> </ul>"},{"location":"services/auth-service/master/design/#104-graceful-fallback","title":"\u26d1 10.4. Graceful Fallback","text":"<ul> <li>N\u1ebfu <code>audit-service</code> kh\u00f4ng kh\u1ea3 d\u1ee5ng \u2192 ghi log <code>audit_event_failed</code> \u0111\u1ec3 retry sau (async ho\u1eb7c batch).</li> <li>N\u1ebfu <code>user-service</code> m\u1ea5t k\u1ebft n\u1ed1i \u2192 tr\u1ea3 l\u1ed7i r\u00f5 r\u00e0ng <code>user.sync.failed</code> v\u1edbi chi ti\u1ebft trong <code>error.details</code>.</li> </ul>"},{"location":"services/auth-service/master/design/#105-circuit-breaker-tuy-chon","title":"\ud83d\udee1 10.5. Circuit Breaker (T\u00f9y ch\u1ecdn)","text":"<ul> <li>C\u00f3 th\u1ec3 b\u1eadt <code>circuit-breaker</code> b\u1eb1ng <code>fastapi_circuitbreaker</code> ho\u1eb7c <code>pybreaker</code> cho t\u1eebng service critical.</li> <li>V\u00ed d\u1ee5: n\u1ebfu <code>token-service</code> th\u1ea5t b\u1ea1i &gt; 5 l\u1ea7n li\u00ean t\u1ee5c trong 30s \u2192 t\u1ea1m th\u1eddi ng\u1eaft lu\u1ed3ng login \u0111\u1ec3 gi\u1ea3m t\u1ea3i.</li> </ul>"},{"location":"services/auth-service/master/design/#106-chaos-testing-khuyen-nghi","title":"\ud83e\uddea 10.6. Chaos Testing (khuy\u1ebfn ngh\u1ecb)","text":"K\u1ecbch b\u1ea3n M\u1ee5c ti\u00eau M\u00f4 ph\u1ecfng Google timeout Ki\u1ec3m tra kh\u1ea3 n\u0103ng fallback v\u00e0 logging \u0110\u1ee9t k\u1ebft n\u1ed1i t\u1edbi user-service Ki\u1ec3m tra l\u1ed7i c\u00f3 r\u00f5 r\u00e0ng kh\u00f4ng Tr\u1ea3 l\u1ed7i gi\u1ea3 t\u1eeb token-service Ki\u1ec3m tra retry v\u00e0 message ch\u00ednh x\u00e1c"},{"location":"services/auth-service/master/design/#107-sla-goi-y","title":"\ud83e\uddee 10.7. SLA g\u1ee3i \u00fd","text":"API SLA <code>/auth/exchange</code> \u2265 99.95% <code>/me</code>, <code>/verify</code> \u2265 99.99% <p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 n\u1ed9i dung chi ti\u1ebft cho m\u1ee5c <code>## 11. \u26a1\ufe0f Hi\u1ec7u n\u0103ng &amp; Scale</code> trong <code>auth-service/master/design.md</code>, t\u1eadp trung v\u00e0o \u0111\u1eb7c th\u00f9 x\u1eed l\u00fd nhanh, stateless v\u00e0 kh\u1ea3 n\u0103ng scale ngang d\u1ec5 d\u00e0ng:</p>"},{"location":"services/auth-service/master/design/#11-hieu-nang-scale","title":"11. \u26a1\ufe0f Hi\u1ec7u n\u0103ng &amp; Scale","text":"<p><code>auth-service/master</code> l\u00e0 m\u1ed9t trong nh\u1eefng d\u1ecbch v\u1ee5 nh\u1ea1y c\u1ea3m nh\u1ea5t v\u1ec1 hi\u1ec7u n\u0103ng do: - Tham gia tr\u1ef1c ti\u1ebfp v\u00e0o lu\u1ed3ng \u0111\u0103ng nh\u1eadp - G\u1ecdi nhi\u1ec1u d\u1ecbch v\u1ee5 backend (Google, user, token, audit) - Ph\u1ea3i ph\u1ea3n h\u1ed3i g\u1ea7n nh\u01b0 real-time</p>"},{"location":"services/auth-service/master/design/#111-ac-iem-hieu-nang","title":"\ud83d\ude80 11.1. \u0110\u1eb7c \u0111i\u1ec3m hi\u1ec7u n\u0103ng","text":"Thu\u1ed9c t\u00ednh Ghi ch\u00fa Stateless Kh\u00f4ng l\u01b0u session, cache hay user context I/O bound H\u1ea7u h\u1ebft th\u1eddi gian l\u00e0 ch\u1edd HTTP response t\u1eeb b\u00ean ngo\u00e0i CPU-light Ch\u1ee7 y\u1ebfu x\u1eed l\u00fd JSON, kh\u00f4ng c\u1ea7n CPU m\u1ea1nh Memory-light Kh\u00f4ng gi\u1eef nhi\u1ec1u context/lifecycle d\u00e0i <p>\u0110\u00e2y l\u00e0 service l\u00fd t\u01b0\u1edfng \u0111\u1ec3 scale theo chi\u1ec1u ngang (horizontal scaling).</p>"},{"location":"services/auth-service/master/design/#112-uoc-luong-hieu-nang","title":"\ud83e\uddee 11.2. \u01af\u1edbc l\u01b0\u1ee3ng hi\u1ec7u n\u0103ng","text":"Lo\u1ea1i request Th\u1eddi gian x\u1eed l\u00fd \u01b0\u1edbc t\u00ednh <code>/auth/exchange</code> (full login) ~400\u2013600ms <code>/me</code>, <code>/verify</code> ~5\u201320ms (decode token + enrich + log) <code>/oauth2/callback</code> ~200ms (Google + prepare payload) <p>Trong m\u00f4i tr\u01b0\u1eddng production, th\u1eddi gian x\u1eed l\u00fd 99 percentile n\u00ean d\u01b0\u1edbi 800ms cho full login.</p>"},{"location":"services/auth-service/master/design/#113-benchmark-co-ban-tham-khao","title":"\ud83d\udccf 11.3. Benchmark c\u01a1 b\u1ea3n (tham kh\u1ea3o)","text":"<pre><code>500 concurrent requests\n1000 RPS t\u1ed5ng\n99.5% success rate\nAverage latency: ~650ms\nMemory usage: ~60MB / instance\n</code></pre>"},{"location":"services/auth-service/master/design/#114-chien-luoc-scale","title":"\ud83d\udcc8 11.4. Chi\u1ebfn l\u01b0\u1ee3c scale","text":"K\u1ef9 thu\u1eadt M\u00f4 t\u1ea3 Auto-scaling theo CPU ho\u1eb7c RPS Khuy\u1ebfn ngh\u1ecb scale t\u1eeb 2 \u2192 6 instance Zero-downtime deploy S\u1eed d\u1ee5ng rolling update trong Kubernetes Multi-zone deployment D\u00f9ng multi-AZ trong GKE / EKS \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o HA Readiness probe \u0110\u1ea3m b\u1ea3o ch\u1ec9 route traffic khi service \u0111\u00e3 warm-up (Google client ready)"},{"location":"services/auth-service/master/design/#115-toi-uu-cu-the","title":"\ud83d\udcc9 11.5. T\u1ed1i \u01b0u c\u1ee5 th\u1ec3","text":"M\u1ee5c ti\u00eau Bi\u1ec7n ph\u00e1p Gi\u1ea3m \u0111\u1ed9 tr\u1ec5 Google Cache metadata Google OAuth2 discovery Gi\u1ea3m t\u1ea3i <code>token-service</code> Ch\u1ec9 g\u1ecdi khi user + tenant h\u1ee3p l\u1ec7 (pre-validation) Gi\u1ea3m cost audit G\u1eedi async ho\u1eb7c batch log login T\u1ed1i \u01b0u <code>/me</code>, <code>/verify</code> T\u00e1ch ri\u00eang route nh\u1eb9 kh\u00f4ng ph\u1ee5 thu\u1ed9c d\u1ecbch v\u1ee5 ngo\u00e0i <p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 ph\u1ea7n <code>## 12. \ud83e\udde9 Tri\u1ec3n khai &amp; Migration</code> d\u00e0nh cho <code>auth-service/master/design.md</code>, t\u1eadp trung v\u00e0o quy tr\u00ecnh tri\u1ec3n khai an to\u00e0n, kh\u00f4ng downtime v\u00e0 h\u1ed7 tr\u1ee3 n\u00e2ng c\u1ea5p c\u1ea5u h\u00ecnh OAuth2 theo tenant.</p>"},{"location":"services/auth-service/master/design/#12-trien-khai-migration","title":"12. \ud83e\udde9 Tri\u1ec3n khai &amp; Migration","text":""},{"location":"services/auth-service/master/design/#121-chien-luoc-trien-khai","title":"\ud83d\ude80 12.1. Chi\u1ebfn l\u01b0\u1ee3c tri\u1ec3n khai","text":"<p><code>auth-service/master</code> \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf \u0111\u1ec3: - D\u1ec5 d\u00e0ng tri\u1ec3n khai theo m\u00f4 h\u00ecnh microservice - T\u00e1ch bi\u1ec7t r\u00f5 m\u00f4i tr\u01b0\u1eddng (<code>staging</code>, <code>production</code>) - H\u1ea1n ch\u1ebf downtime b\u1eb1ng rolling update</p>"},{"location":"services/auth-service/master/design/#cach-trien-khai-tieu-chuan","title":"\ud83d\udce6 C\u00e1ch tri\u1ec3n khai ti\u00eau chu\u1ea9n:","text":"Th\u00e0nh ph\u1ea7n C\u00f4ng ngh\u1ec7 \u0111\u1ec1 xu\u1ea5t Containerization Docker Orchestrator Kubernetes (GKE / EKS / self-hosted) CI/CD GitHub Actions / GitLab CI Config Environment variables + Secret Manager Routing Ingress Gateway / API Gateway"},{"location":"services/auth-service/master/design/#122-zero-downtime-strategy","title":"\u26f3 12.2. Zero Downtime Strategy","text":"K\u1ef9 thu\u1eadt Ghi ch\u00fa <code>readinessProbe</code> Tr\u1ea3 <code>200 OK</code> khi OAuth2 config \u0111\u00e3 load xong <code>livenessProbe</code> <code>/healthz</code> \u0111\u1ec3 ki\u1ec3m tra v\u00f2ng l\u1eb7p x\u1eed l\u00fd Rolling Update Thay th\u1ebf t\u1eebng instance 1 c\u00e1ch an to\u00e0n Sessionless Kh\u00f4ng m\u1ea5t context khi instance b\u1ecb restart"},{"location":"services/auth-service/master/design/#123-migration-strategy-du-lieu-cau-hinh","title":"\ud83d\udd04 12.3. Migration Strategy (D\u1eef li\u1ec7u &amp; C\u1ea5u h\u00ecnh)","text":""},{"location":"services/auth-service/master/design/#bang-auth_provider_config","title":"\u2705 B\u1ea3ng <code>auth_provider_config</code>:","text":"<ul> <li>C\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c kh\u1edfi t\u1ea1o qua script SQL ho\u1eb7c Alembic.</li> <li>H\u1ed7 tr\u1ee3 nhi\u1ec1u tenant: m\u1ed7i tenant c\u00f3 c\u1ea5u h\u00ecnh OAuth ri\u00eang.</li> </ul> <pre><code>CREATE TABLE auth_provider_config (\n    id UUID PRIMARY KEY,\n    tenant_id TEXT NOT NULL,\n    provider TEXT DEFAULT 'google',\n    client_id TEXT NOT NULL,\n    client_secret TEXT NOT NULL,\n    redirect_uri TEXT NOT NULL,\n    scopes TEXT[] DEFAULT ARRAY['email', 'profile'],\n    is_active BOOLEAN DEFAULT TRUE,\n    created_at TIMESTAMPTZ DEFAULT now(),\n    updated_at TIMESTAMPTZ DEFAULT now()\n);\n</code></pre>"},{"location":"services/auth-service/master/design/#goi-y-migration-buoc-au","title":"\ud83d\udccc G\u1ee3i \u00fd Migration b\u01b0\u1edbc \u0111\u1ea7u:","text":"<ol> <li>T\u1ea1o record m\u1eb7c \u0111\u1ecbnh cho tenant <code>vas-primary</code> t\u1eeb file <code>seeds/init_google_oauth.sql</code></li> <li>Load config OAuth t\u1eeb b\u1ea3ng khi service start</li> <li>D\u00f9ng cache n\u1ed9i b\u1ed9 \u0111\u1ec3 gi\u1ea3m truy v\u1ea5n DB (TTL 5 ph\u00fat)</li> </ol>"},{"location":"services/auth-service/master/design/#124-chuan-bi-cho-production","title":"\ud83e\uddea 12.4. Chu\u1ea9n b\u1ecb cho production","text":"H\u1ea1ng m\u1ee5c Tr\u1ea1ng th\u00e1i Google OAuth Client \u0111\u00e3 \u0111\u0103ng k\u00fd? \u2705 <code>redirect_uri</code> c\u00f3 kh\u1edbp v\u1edbi config? \u2705 Config OAuth \u0111\u01b0\u1ee3c m\u00e3 h\u00f3a an to\u00e0n? \u2705 (qua Secret Manager) C\u00f3 ki\u1ec3m th\u1eed <code>/auth/exchange</code> th\u1eadt? \u2705 staging Truy v\u1ebft \u0111\u1ea7y \u0111\u1ee7 (<code>trace_id</code>, <code>audit-service</code>)? \u2705"},{"location":"services/auth-service/master/design/#13-tai-lieu-lien-quan","title":"13. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Interface Contract</li> <li>Data Model</li> <li>OpenAPI Spec</li> <li>ADR-006 - Auth Strategy</li> <li>ADR-012 - Response Structure</li> <li>ADR-011 - API Error Format</li> </ul>"},{"location":"services/auth-service/master/interface-contract/","title":"\ud83d\udcd8 Auth Service Master \u2013 Interface Contract","text":""},{"location":"services/auth-service/master/interface-contract/#1-nguyen-tac-chung-khi-su-dung-api","title":"1. \ud83d\udd27 Nguy\u00ean t\u1eafc chung khi s\u1eed d\u1ee5ng API","text":"<p>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 c\u00e1c API \u0111\u01b0\u1ee3c cung c\u1ea5p b\u1edfi <code>auth-service/master</code>, n\u01a1i ch\u1ecbu tr\u00e1ch nhi\u1ec7m \u0111i\u1ec1u ph\u1ed1i lu\u1ed3ng x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng th\u00f4ng qua Google OAuth2.</p>"},{"location":"services/auth-service/master/interface-contract/#11-vai-tro-cua-auth-servicemaster","title":"1.1. \ud83e\udded Vai tr\u00f2 c\u1ee7a auth-service/master","text":"<p>Auth service kh\u00f4ng c\u00f2n t\u1ef1 sinh token hay gi\u1eef tr\u1ea1ng th\u00e1i phi\u00ean \u0111\u0103ng nh\u1eadp. Thay v\u00e0o \u0111\u00f3, n\u00f3:</p> <ul> <li>Kh\u1edfi t\u1ea1o lu\u1ed3ng x\u00e1c th\u1ef1c Google</li> <li>Nh\u1eadn <code>code</code> t\u1eeb Google callback</li> <li>\u0110\u1ed3ng b\u1ed9 ng\u01b0\u1eddi d\u00f9ng v\u00e0o <code>user-service</code></li> <li>Y\u00eau c\u1ea7u <code>token-service</code> ph\u00e1t h\u00e0nh JWT</li> <li>Ghi nh\u1eadn audit log s\u1ef1 ki\u1ec7n \u0111\u0103ng nh\u1eadp</li> </ul>"},{"location":"services/auth-service/master/interface-contract/#12-co-che-xac-thuc","title":"1.2. \ud83d\udd10 C\u01a1 ch\u1ebf x\u00e1c th\u1ef1c","text":"<p>H\u1ea7u h\u1ebft c\u00e1c API \u1edf \u0111\u00e2y l\u00e0 public ho\u1eb7c \u0111\u01b0\u1ee3c g\u1ecdi trong lu\u1ed3ng redirect. M\u1ed9t s\u1ed1 API nh\u01b0 <code>/me</code>, <code>/verify</code> y\u00eau c\u1ea7u header:</p> <pre><code>Authorization: Bearer \\&lt;access\\_token&gt;\n</code></pre> <p>Token ph\u1ea3i \u0111\u01b0\u1ee3c ph\u00e1t h\u00e0nh t\u1eeb <code>token-service</code>, c\u00f3 ch\u1eef k\u00fd h\u1ee3p l\u1ec7 v\u00e0 c\u00f2n hi\u1ec7u l\u1ef1c.</p>"},{"location":"services/auth-service/master/interface-contract/#13-header-chuan-hoa","title":"1.3. \ud83d\udcce Header chu\u1ea9n h\u00f3a","text":"Header M\u00f4 t\u1ea3 <code>Authorization</code> D\u1ea1ng <code>Bearer &lt;access_token&gt;</code> <code>X-Tenant-ID</code> M\u00e3 tenant, tr\u00edch xu\u1ea5t t\u1eeb token ho\u1eb7c th\u00eam v\u00e0o (n\u1ebfu c\u1ea7n) <code>X-Trace-ID</code> UUID \u0111\u1ec3 theo d\u00f5i to\u00e0n b\u1ed9 lu\u1ed3ng x\u1eed l\u00fd <p>M\u1ecdi ph\u1ea3n h\u1ed3i \u0111\u1ec1u g\u1eafn <code>trace_id</code> v\u00e0o response \u0111\u1ec3 ph\u1ee5c v\u1ee5 logging &amp; debug.</p>"},{"location":"services/auth-service/master/interface-contract/#14-response-chuan-hoa","title":"1.4. \ud83d\udce6 Response chu\u1ea9n h\u00f3a","text":"<ul> <li>T\u1ea5t c\u1ea3 response th\u00e0nh c\u00f4ng tu\u00e2n theo \u0111\u1ecbnh d\u1ea1ng:</li> </ul> <pre><code>{\n  \"data\": { ... },\n  \"meta\": {\n    \"trace_id\": \"abc-123\",\n    \"timestamp\": \"2025-06-10T12:00:00Z\"\n  }\n}\n</code></pre> <ul> <li>M\u1ecdi l\u1ed7i \u0111\u1ec1u theo <code>ErrorEnvelope</code> chu\u1ea9n h\u00f3a, v\u00ed d\u1ee5:</li> </ul> <pre><code>{\n  \"error\": {\n    \"code\": \"auth.invalid_oauth_code\",\n    \"message\": \"M\u00e3 x\u00e1c th\u1ef1c kh\u00f4ng h\u1ee3p l\u1ec7 ho\u1eb7c \u0111\u00e3 h\u1ebft h\u1ea1n\",\n    \"details\": []\n  },\n  \"meta\": {\n    \"trace_id\": \"abc-123\",\n    \"timestamp\": \"2025-06-10T12:00:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/auth-service/master/interface-contract/#15-namespace-ma-loi","title":"1.5. \ud83d\udcce Namespace m\u00e3 l\u1ed7i","text":"<p>M\u1ecdi m\u00e3 l\u1ed7i \u0111\u1ec1u tu\u00e2n theo c\u1ea5u tr\u00fac:</p> <pre><code>auth.&lt;error_type&gt;\n</code></pre> <p>V\u00ed d\u1ee5:</p> <ul> <li><code>auth.invalid_oauth_code</code></li> <li><code>auth.token_issue_failed</code></li> <li><code>auth.unauthorized</code></li> </ul>"},{"location":"services/auth-service/master/interface-contract/#2-api","title":"2. \ud83d\udccc API","text":"<p>Auth Service cung c\u1ea5p t\u1eadp h\u1ee3p c\u00e1c API c\u00f4ng khai gi\u00fap frontend ho\u1eb7c gateway kh\u1edfi t\u1ea1o v\u00e0 ho\u00e0n t\u1ea5t lu\u1ed3ng x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng th\u00f4ng qua Google OAuth2. Ngo\u00e0i ra, n\u00f3 c\u00f2n cung c\u1ea5p c\u00e1c endpoint \u0111\u1ec3 introspect token (<code>/verify</code>) v\u00e0 l\u1ea5y th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng hi\u1ec7n t\u1ea1i (<code>/me</code>).</p>"},{"location":"services/auth-service/master/interface-contract/#21-nhom-api-chinh","title":"2.1. \ud83e\udde9 Nh\u00f3m API ch\u00ednh","text":"Nh\u00f3m M\u00f4 t\u1ea3 OAuth2 \u0110i\u1ec1u ph\u1ed1i x\u00e1c th\u1ef1c Google: <code>/oauth2/login</code>, <code>/oauth2/callback</code> Token Exchange Trao \u0111\u1ed5i m\u00e3 x\u00e1c th\u1ef1c l\u1ea5y JWT: <code>/auth/exchange</code> User Info L\u1ea5y th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng hi\u1ec7n t\u1ea1i: <code>/me</code> Token Verify Ki\u1ec3m tra t\u00ednh h\u1ee3p l\u1ec7 c\u1ee7a access token: <code>/verify</code> Provider Metadata C\u1ea5u h\u00ecnh provider: <code>/providers</code> Dev Mode (tu\u1ef3 ch\u1ecdn) Endpoint gi\u1ea3 l\u1eadp (<code>/dev/mimic</code>) d\u00e0nh cho m\u00f4i tr\u01b0\u1eddng ph\u00e1t tri\u1ec3n OTP Login \u0110\u0103ng nh\u1eadp b\u1eb1ng m\u00e3 OTP: <code>/auth/otp</code>, <code>/auth/verify-otp</code> Local Login \u0110\u0103ng nh\u1eadp b\u1eb1ng username/password: <code>/auth/login</code>"},{"location":"services/auth-service/master/interface-contract/#22-luu-y-tich-hop","title":"2.2. \u26a0\ufe0f L\u01b0u \u00fd t\u00edch h\u1ee3p","text":"<ul> <li>\u0110\u1ec3 \u0111\u0103ng nh\u1eadp Google OAuth2, client ph\u1ea3i redirect ng\u01b0\u1eddi d\u00f9ng \u0111\u1ebfn <code>/oauth2/login</code> v\u00e0 l\u1eafng nghe ph\u1ea3n h\u1ed3i \u1edf <code>/oauth2/callback</code>.</li> <li>API <code>/auth/exchange</code> s\u1ebd ph\u00e1t h\u00e0nh token th\u00f4ng qua <code>token-service</code>, kh\u00f4ng \u0111\u01b0\u1ee3c g\u1ecdi tr\u1ef1c ti\u1ebfp \u1edf client.</li> <li>API <code>/me</code> v\u00e0 <code>/verify</code> n\u00ean \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng th\u00f4ng qua <code>api-gateway</code>, kh\u00f4ng expose public.</li> </ul>"},{"location":"services/auth-service/master/interface-contract/#23-luong-oauth2-login-flow","title":"2.3. \ud83d\udd01 Lu\u1ed3ng: OAuth2 Login Flow","text":"<p>Lu\u1ed3ng \u0111\u0103ng nh\u1eadp Google OAuth2 bao g\u1ed3m 3 b\u01b0\u1edbc ch\u00ednh:</p>"},{"location":"services/auth-service/master/interface-contract/#1-redirect-nguoi-dung-en-google","title":"1. Redirect ng\u01b0\u1eddi d\u00f9ng \u0111\u1ebfn Google","text":"<pre><code>GET /oauth2/login\n</code></pre> M\u00f4 t\u1ea3 T\u1ea1o URL chuy\u1ec3n h\u01b0\u1edbng ng\u01b0\u1eddi d\u00f9ng \u0111\u1ebfn trang \u0111\u0103ng nh\u1eadp c\u1ee7a Google Auth y\u00eau c\u1ea7u \u274c Kh\u00f4ng Headers <code>X-Tenant-ID</code> (n\u1ebfu h\u1ec7 th\u1ed1ng \u0111a tenant) Ph\u1ea3n h\u1ed3i Redirect 302 \u2192 <code>https://accounts.google.com/o/oauth2/v2/auth?...</code> Audit event Kh\u00f4ng <p>\u2705 Endpoint n\u00e0y x\u00e2y d\u1ef1ng URL ch\u1ee9a client_id, scope, redirect_uri theo config trong <code>auth_provider_config</code>.</p>"},{"location":"services/auth-service/master/interface-contract/#2-google-redirect-ve-callback","title":"2. Google Redirect v\u1ec1 Callback","text":"<pre><code>GET /oauth2/callback?code=XXXX&amp;state=...\n</code></pre> M\u00f4 t\u1ea3 Nh\u1eadn <code>code</code> t\u1eeb Google v\u00e0 b\u1eaft \u0111\u1ea7u lu\u1ed3ng trao \u0111\u1ed5i token Auth y\u00eau c\u1ea7u \u274c Kh\u00f4ng Query Params <code>code</code>, <code>state</code> Headers <code>X-Tenant-ID</code>, <code>X-Trace-ID</code> Response Redirect v\u1ec1 <code>frontend_url?code=EXCH_CODE&amp;state=...</code> Audit <code>auth.login.success</code> ho\u1eb7c <code>auth.login.failed</code> <p>\u2705 N\u1ebfu th\u00e0nh c\u00f4ng, tr\u1ea3 v\u1ec1 m\u00e3 <code>exchange_code</code> t\u1ea1m th\u1eddi, client d\u00f9ng m\u00e3 n\u00e0y \u0111\u1ec3 g\u1ecdi <code>/auth/exchange</code>.</p>"},{"location":"services/auth-service/master/interface-contract/#3-oi-exchange_code-lay-jwt","title":"3. \u0110\u1ed5i exchange_code l\u1ea5y JWT","text":"<pre><code>POST /auth/exchange\n</code></pre> M\u00f4 t\u1ea3 Frontend d\u00f9ng exchange_code \u0111\u1ec3 nh\u1eadn token t\u1eeb h\u1ec7 th\u1ed1ng Auth y\u00eau c\u1ea7u \u274c Kh\u00f4ng Body <pre><code>{\n  \"exchange_code\": \"abc123\",\n  \"client_ip\": \"123.123.123.123\",\n  \"user_agent\": \"Chrome/120\"\n}\n</code></pre> <p>| Response |</p> <pre><code>{\n  \"data\": {\n    \"access_token\": \"jwt...\",\n    \"refresh_token\": \"jwt...\",\n    \"expires_in\": 3600,\n    \"session_id\": \"uuid\"\n  },\n  \"meta\": { ... }\n}\n</code></pre> <p>| Audit | <code>auth.token.issued</code> (ghi qua audit-service) |</p> <p>\ud83d\udccc Auth Service s\u1ebd g\u1ecdi n\u1ed9i b\u1ed9:</p> <ul> <li><code>POST /v1/users/global/sync</code> (user-service)</li> <li><code>POST /v1/token/issue</code> (token-service)</li> </ul>"},{"location":"services/auth-service/master/interface-contract/#luu-y-bao-mat","title":"\ud83e\udde9 L\u01b0u \u00fd b\u1ea3o m\u1eadt","text":"<ul> <li><code>exchange_code</code> c\u00f3 TTL ng\u1eafn (5 ph\u00fat), d\u00f9ng m\u1ed9t l\u1ea7n duy nh\u1ea5t</li> <li>N\u1ebfu code h\u1ebft h\u1ea1n \u2192 tr\u1ea3 <code>auth.exchange_code_expired</code></li> <li>N\u1ebfu Google tr\u1ea3 l\u1ed7i \u2192 tr\u1ea3 <code>auth.invalid_oauth_code</code></li> </ul>"},{"location":"services/auth-service/master/interface-contract/#24-post-authotp-gui-ma-otp","title":"2.4. \ud83d\udd10 POST /auth/otp \u2013 G\u1eedi m\u00e3 OTP","text":"<p>G\u1eedi m\u00e3 OTP (One-Time Password) t\u1edbi s\u1ed1 \u0111i\u1ec7n tho\u1ea1i ho\u1eb7c \u0111\u1ecba ch\u1ec9 email c\u1ee7a ng\u01b0\u1eddi d\u00f9ng \u0111\u1ec3 b\u1eaft \u0111\u1ea7u qu\u00e1 tr\u00ecnh x\u00e1c th\u1ef1c.</p> Thu\u1ed9c nh\u00f3m API OTP Login"},{"location":"services/auth-service/master/interface-contract/#request","title":"\ud83d\udce5 Request","text":"<ul> <li>URL: <code>/auth/otp</code></li> <li>Ph\u01b0\u01a1ng th\u1ee9c: <code>POST</code></li> <li>Auth y\u00eau c\u1ea7u: \u274c Kh\u00f4ng y\u00eau c\u1ea7u access token</li> <li>Headers y\u00eau c\u1ea7u:</li> <li><code>X-Tenant-ID</code>: M\u00e3 \u0111\u1ecbnh danh tenant (b\u1eaft bu\u1ed9c)</li> <li><code>X-Request-ID</code> (khuy\u1ebfn ngh\u1ecb)</li> </ul>"},{"location":"services/auth-service/master/interface-contract/#request-body","title":"\ud83d\udd38 Request Body","text":"<pre><code>{\n  \"identifier\": \"0934567890\",\n  \"type\": \"phone\"\n}\n</code></pre> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>identifier</code> string \u2705 S\u1ed1 \u0111i\u1ec7n tho\u1ea1i ho\u1eb7c email c\u1ea7n g\u1eedi m\u00e3 OTP <code>type</code> enum \u2705 <code>\"phone\"</code> ho\u1eb7c <code>\"email\"</code>"},{"location":"services/auth-service/master/interface-contract/#response","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"data\": \"OTP has been sent\",\n  \"meta\": {\n    \"trace_id\": \"79f2f5ba-3fc7-4c1f-9c6a-843d0caa15bb\",\n    \"timestamp\": \"2025-06-10T14:33:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/auth-service/master/interface-contract/#cac-loi-co-the-gap","title":"\u2757\ufe0fC\u00e1c l\u1ed7i c\u00f3 th\u1ec3 g\u1eb7p","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 <code>auth.otp.invalid_type</code> Tr\u01b0\u1eddng <code>type</code> kh\u00f4ng h\u1ee3p l\u1ec7 <code>auth.otp.rate_limited</code> G\u1eedi qu\u00e1 nhi\u1ec1u OTP trong th\u1eddi gian ng\u1eafn"},{"location":"services/auth-service/master/interface-contract/#audit-log","title":"\ud83e\udded Audit Log","text":"Event Khi n\u00e0o ghi log <code>auth.otp.requested</code> Khi OTP \u0111\u01b0\u1ee3c g\u1eedi th\u00e0nh c\u00f4ng ho\u1eb7c b\u1ecb rate-limit"},{"location":"services/auth-service/master/interface-contract/#ghi-chu-bao-mat","title":"\ud83d\udd10 Ghi ch\u00fa b\u1ea3o m\u1eadt","text":"<ul> <li>C\u00f3 gi\u1edbi h\u1ea1n s\u1ed1 l\u1ea7n g\u1eedi OTP theo IP &amp; identifier \u0111\u1ec3 ch\u1ed1ng spam.</li> <li>OTP s\u1ebd \u0111\u01b0\u1ee3c l\u01b0u tr\u1eef t\u1ea1m th\u1eddi tr\u00ean Redis v\u1edbi TTL ng\u1eafn (vd: 5 ph\u00fat).</li> <li>N\u1ebfu type = <code>email</code>, h\u1ec7 th\u1ed1ng s\u1ebd d\u00f9ng <code>notification-service</code> \u0111\u1ec3 g\u1eedi email ch\u1ee9a m\u00e3 OTP.</li> </ul>"},{"location":"services/auth-service/master/interface-contract/#25-post-authverify-otp-xac-minh-ma-otp","title":"2.5. \ud83d\udd10 POST /auth/verify-otp \u2013 X\u00e1c minh m\u00e3 OTP","text":"<p>X\u00e1c minh m\u00e3 OTP do ng\u01b0\u1eddi d\u00f9ng nh\u1eadp. N\u1ebfu h\u1ee3p l\u1ec7, h\u1ec7 th\u1ed1ng s\u1ebd: 1. X\u00e1c th\u1ef1c identifier. 2. G\u1ecdi <code>user-service</code> \u0111\u1ec3 t\u00ecm ho\u1eb7c t\u1ea1o ng\u01b0\u1eddi d\u00f9ng. 3. G\u1ecdi <code>token-service</code> \u0111\u1ec3 ph\u00e1t h\u00e0nh token.</p> Thu\u1ed9c nh\u00f3m API OTP Login"},{"location":"services/auth-service/master/interface-contract/#request_1","title":"\ud83d\udce5 Request","text":"<ul> <li>URL: <code>/auth/verify-otp</code></li> <li>Ph\u01b0\u01a1ng th\u1ee9c: <code>POST</code></li> <li>Auth y\u00eau c\u1ea7u: \u274c Kh\u00f4ng y\u00eau c\u1ea7u access token</li> <li>Headers y\u00eau c\u1ea7u:</li> <li><code>X-Tenant-ID</code>: M\u00e3 \u0111\u1ecbnh danh tenant (b\u1eaft bu\u1ed9c)</li> <li><code>X-Request-ID</code> (khuy\u1ebfn ngh\u1ecb)</li> <li><code>User-Agent</code>, <code>X-Forwarded-For</code> (\u0111\u1ec3 ghi audit, ph\u00e2n t\u00edch)</li> </ul>"},{"location":"services/auth-service/master/interface-contract/#request-body_1","title":"\ud83d\udd38 Request Body","text":"<pre><code>{\n  \"identifier\": \"0934567890\",\n  \"otp_code\": \"123456\",\n  \"client_ip\": \"192.168.1.10\",\n  \"user_agent\": \"Mozilla/5.0\"\n}\n</code></pre> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>identifier</code> string \u2705 S\u1ed1 \u0111i\u1ec7n tho\u1ea1i ho\u1eb7c email <code>otp_code</code> string \u2705 M\u00e3 OTP ng\u01b0\u1eddi d\u00f9ng nh\u1eadp <code>client_ip</code> string \u2705 \u0110\u1ecba ch\u1ec9 IP client <code>user_agent</code> string \u2705 User agent c\u1ee7a tr\u00ecnh duy\u1ec7t/app"},{"location":"services/auth-service/master/interface-contract/#response_1","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"data\": {\n    \"access_token\": \"&lt;JWT&gt;\",\n    \"refresh_token\": \"&lt;JWT&gt;\",\n    \"expires_in\": 3600,\n    \"token_type\": \"bearer\"\n  },\n  \"meta\": {\n    \"trace_id\": \"cfe18234-fcc9-4432-a09e-84c12395cabc\",\n    \"timestamp\": \"2025-06-10T15:01:23Z\",\n    \"additional\": {\n      \"login_method\": \"otp\"\n    }\n  }\n}\n</code></pre>"},{"location":"services/auth-service/master/interface-contract/#cac-loi-co-the-gap_1","title":"\u2757\ufe0fC\u00e1c l\u1ed7i c\u00f3 th\u1ec3 g\u1eb7p","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 <code>auth.otp_invalid</code> M\u00e3 OTP kh\u00f4ng \u0111\u00fang ho\u1eb7c \u0111\u00e3 h\u1ebft h\u1ea1n <code>auth.otp_expired</code> M\u00e3 OTP \u0111\u00e3 h\u1ebft h\u1ea1n <code>auth.otp_attempts_exceeded</code> V\u01b0\u1ee3t qu\u00e1 s\u1ed1 l\u1ea7n th\u1eed OTP cho ph\u00e9p <code>user.not_found</code> Kh\u00f4ng t\u00ecm th\u1ea5y ng\u01b0\u1eddi d\u00f9ng t\u01b0\u01a1ng \u1ee9ng <code>token.issue_failed</code> G\u1ecdi <code>token-service</code> th\u1ea5t b\u1ea1i"},{"location":"services/auth-service/master/interface-contract/#audit-log_1","title":"\ud83e\udded Audit Log","text":"Event Khi n\u00e0o ghi log <code>auth.login.otp.success</code> Khi x\u00e1c minh OTP th\u00e0nh c\u00f4ng v\u00e0 c\u1ea5p token <code>auth.login.otp.failed</code> Khi OTP sai, h\u1ebft h\u1ea1n ho\u1eb7c h\u1ebft l\u01b0\u1ee3t th\u1eed"},{"location":"services/auth-service/master/interface-contract/#ghi-chu-bao-mat_1","title":"\ud83d\udd10 Ghi ch\u00fa b\u1ea3o m\u1eadt","text":"<ul> <li>M\u1ed7i OTP ch\u1ec9 \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng m\u1ed9t l\u1ea7n.</li> <li>S\u1ed1 l\u1ea7n th\u1eed sai b\u1ecb gi\u1edbi h\u1ea1n (th\u01b0\u1eddng 5 l\u1ea7n / 10 ph\u00fat).</li> <li>T\u1ea5t c\u1ea3 c\u00e1c h\u00e0nh vi sai \u0111\u1ec1u \u0111\u01b0\u1ee3c ghi v\u00e0o audit \u0111\u1ec3 ph\u00e2n t\u00edch b\u1ea5t th\u01b0\u1eddng.</li> <li><code>client_ip</code> v\u00e0 <code>user_agent</code> \u0111\u01b0\u1ee3c forward sang <code>token-service</code> v\u00e0 ghi l\u1ea1i trace/audit.</li> </ul>"},{"location":"services/auth-service/master/interface-contract/#26-post-authlogin-ang-nhap-bang-usernamepassword","title":"2.6. \ud83d\udd10 POST /auth/login \u2013 \u0110\u0103ng nh\u1eadp b\u1eb1ng Username/Password","text":"<p>X\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng b\u1eb1ng t\u00e0i kho\u1ea3n n\u1ed9i b\u1ed9 (username &amp; password). Sau khi x\u00e1c minh: 1. \u0110\u1ed3ng b\u1ed9 ng\u01b0\u1eddi d\u00f9ng t\u1eeb <code>user-service</code>. 2. G\u1ecdi <code>token-service</code> \u0111\u1ec3 ph\u00e1t h\u00e0nh access token &amp; refresh token.</p> Thu\u1ed9c nh\u00f3m API Local Login"},{"location":"services/auth-service/master/interface-contract/#request_2","title":"\ud83d\udce5 Request","text":"<ul> <li>URL: <code>/auth/login</code></li> <li>Ph\u01b0\u01a1ng th\u1ee9c: <code>POST</code></li> <li>Auth y\u00eau c\u1ea7u: \u274c Kh\u00f4ng y\u00eau c\u1ea7u access token</li> <li>Headers y\u00eau c\u1ea7u:</li> <li><code>X-Tenant-ID</code>: M\u00e3 \u0111\u1ecbnh danh tenant (b\u1eaft bu\u1ed9c)</li> <li><code>X-Request-ID</code> (khuy\u1ebfn ngh\u1ecb)</li> <li><code>User-Agent</code>, <code>X-Forwarded-For</code> (\u0111\u1ec3 audit)</li> </ul>"},{"location":"services/auth-service/master/interface-contract/#request-body_2","title":"\ud83d\udd38 Request Body","text":"<pre><code>{\n  \"username\": \"ngocminh\",\n  \"password\": \"hunter2\",\n  \"client_ip\": \"192.168.1.10\",\n  \"user_agent\": \"Mozilla/5.0\"\n}\n</code></pre> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>username</code> string \u2705 T\u00ean \u0111\u0103ng nh\u1eadp n\u1ed9i b\u1ed9 <code>password</code> string \u2705 M\u1eadt kh\u1ea9u ng\u01b0\u1eddi d\u00f9ng <code>client_ip</code> string \u2705 IP client <code>user_agent</code> string \u2705 Chu\u1ed7i user agent"},{"location":"services/auth-service/master/interface-contract/#response_2","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"data\": {\n    \"access_token\": \"&lt;JWT&gt;\",\n    \"refresh_token\": \"&lt;JWT&gt;\",\n    \"expires_in\": 3600,\n    \"token_type\": \"bearer\"\n  },\n  \"meta\": {\n    \"trace_id\": \"fb81d9e8-2740-4d92-8fa2-c7b17b5a328a\",\n    \"timestamp\": \"2025-06-10T15:33:11Z\",\n    \"additional\": {\n      \"login_method\": \"local\"\n    }\n  }\n}\n</code></pre>"},{"location":"services/auth-service/master/interface-contract/#cac-loi-co-the-gap_2","title":"\u2757\ufe0fC\u00e1c l\u1ed7i c\u00f3 th\u1ec3 g\u1eb7p","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 <code>auth.local_login_failed</code> Sai username ho\u1eb7c password <code>user.not_found</code> Kh\u00f4ng t\u00ecm th\u1ea5y ng\u01b0\u1eddi d\u00f9ng t\u01b0\u01a1ng \u1ee9ng <code>token.issue_failed</code> G\u1ecdi <code>token-service</code> th\u1ea5t b\u1ea1i"},{"location":"services/auth-service/master/interface-contract/#audit-log_2","title":"\ud83e\udded Audit Log","text":"Event Khi n\u00e0o ghi log <code>auth.login.local.success</code> \u0110\u0103ng nh\u1eadp th\u00e0nh c\u00f4ng <code>auth.login.local.failed</code> Sai th\u00f4ng tin \u0111\u0103ng nh\u1eadp"},{"location":"services/auth-service/master/interface-contract/#ghi-chu-bao-mat_2","title":"\ud83d\udd10 Ghi ch\u00fa b\u1ea3o m\u1eadt","text":"<ul> <li>Password \u0111\u01b0\u1ee3c m\u00e3 h\u00f3a v\u00e0 so s\u00e1nh b\u1eb1ng thu\u1eadt to\u00e1n an to\u00e0n (bcrypt/scrypt).</li> <li>S\u1ed1 l\u1ea7n login sai b\u1ecb gi\u1edbi h\u1ea1n \u0111\u1ec3 ng\u0103n brute force.</li> <li>Kh\u00f4ng ph\u1ea3n h\u1ed3i l\u00fd do c\u1ee5 th\u1ec3 khi \u0111\u0103ng nh\u1eadp th\u1ea5t b\u1ea1i (\u0111\u1ec3 tr\u00e1nh d\u00f2 th\u00f4ng tin).</li> <li>Sau \u0111\u0103ng nh\u1eadp, <code>X-Login-Method: local</code> s\u1ebd \u0111\u01b0\u1ee3c forward sang c\u00e1c service.</li> </ul>"},{"location":"services/auth-service/master/interface-contract/#27-lay-thong-tin-nguoi-dung-hien-tai","title":"2.7. \ud83d\udc64 L\u1ea5y th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng hi\u1ec7n t\u1ea1i","text":"<pre><code>GET /me\n</code></pre> M\u00f4 t\u1ea3 Tr\u00edch xu\u1ea5t th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng t\u1eeb access token Auth y\u00eau c\u1ea7u \u2705 <code>Authorization: Bearer &lt;access_token&gt;</code> Headers b\u1eaft bu\u1ed9c <code>Authorization</code>, <code>X-Tenant-ID</code>, <code>X-Trace-ID</code> Ph\u00e2n quy\u1ec1n <code>user.read.self</code> (\u0111\u00e3 g\u1eafn s\u1eb5n trong token) Response <pre><code>{\n  \"data\": {\n    \"user_id\": \"5f12e5...\",\n    \"email\": \"abc@gmail.com\",\n    \"name\": \"Nguy\u1ec5n V\u0103n A\",\n    \"avatar_url\": \"https://...\",\n    \"tenant_id\": \"vas-primary\",\n    \"roles\": [\"teacher\"],\n    \"permissions\": [\"user.read.self\", \"class.view\"]\n  },\n  \"meta\": {\n    \"trace_id\": \"...\",\n    \"timestamp\": \"...\"\n  }\n}\n</code></pre> <p>| Audit | Kh\u00f4ng c\u1ea7n ghi log (truy v\u1ea5n thu\u1ea7n) |</p>"},{"location":"services/auth-service/master/interface-contract/#luu-y-ky-thuat","title":"\u26a0\ufe0f L\u01b0u \u00fd k\u1ef9 thu\u1eadt","text":"<ul> <li>Token ph\u1ea3i c\u00f2n hi\u1ec7u l\u1ef1c v\u00e0 c\u00f3 ch\u1eef k\u00fd h\u1ee3p l\u1ec7 t\u1eeb <code>token-service</code></li> <li>Auth Service kh\u00f4ng g\u1ecdi l\u1ea1i user-service, m\u00e0 ch\u1ec9 decode token v\u00e0 enrich t\u1eeb payload</li> <li>C\u00e1c field nh\u01b0 <code>roles</code>, <code>permissions</code> \u0111\u01b0\u1ee3c tr\u00edch t\u1eeb claim <code>\"x-rbac\"</code> ho\u1eb7c <code>\"custom\"</code> t\u00f9y h\u1ec7 th\u1ed1ng</li> </ul>"},{"location":"services/auth-service/master/interface-contract/#tinh-huong-kiem-thu","title":"\ud83e\uddea T\u00ecnh hu\u1ed1ng ki\u1ec3m th\u1eed","text":"T\u00ecnh hu\u1ed1ng K\u1ef3 v\u1ecdng Token h\u1ee3p l\u1ec7 Tr\u1ea3 th\u00f4ng tin user \u0111\u1ea7y \u0111\u1ee7 Token h\u1ebft h\u1ea1n <code>401 Unauthorized</code> v\u1edbi m\u00e3 l\u1ed7i <code>auth.token_expired</code> Token sai tenant <code>403 Forbidden</code> v\u1edbi m\u00e3 <code>auth.invalid_tenant</code> Thi\u1ebfu trace_id Sinh ng\u1eabu nhi\u00ean v\u00e0 log c\u1ea3nh b\u00e1o"},{"location":"services/auth-service/master/interface-contract/#28-kiem-tra-tinh-hop-le-cua-token","title":"2.8. \ud83d\udee1 Ki\u1ec3m tra t\u00ednh h\u1ee3p l\u1ec7 c\u1ee7a token","text":"<pre><code>GET /verify\n</code></pre> M\u00f4 t\u1ea3 Ki\u1ec3m tra access token c\u00f3 h\u1ee3p l\u1ec7 kh\u00f4ng (ch\u1eef k\u00fd, h\u1ebft h\u1ea1n, issuer\u2026) Auth y\u00eau c\u1ea7u \u2705 <code>Authorization: Bearer &lt;access_token&gt;</code> Headers b\u1eaft bu\u1ed9c <code>Authorization</code>, <code>X-Tenant-ID</code>, <code>X-Trace-ID</code> Ph\u00e2n quy\u1ec1n <code>auth.verify.token</code> (\u0111\u00e3 c\u00f3 s\u1eb5n trong token) Response <pre><code>{\n  \"data\": {\n    \"valid\": true,\n    \"user_id\": \"abc123\",\n    \"tenant_id\": \"vas-primary\",\n    \"issued_at\": \"2025-06-10T12:00:00Z\",\n    \"expires_at\": \"2025-06-10T13:00:00Z\",\n    \"roles\": [\"admin\"],\n    \"permissions\": [\"rbac.manage\"]\n  },\n  \"meta\": { ... }\n}\n</code></pre> <p>| Audit | Kh\u00f4ng c\u1ea7n ghi log |</p>"},{"location":"services/auth-service/master/interface-contract/#luong-xu-ly","title":"\u2705 Lu\u1ed3ng x\u1eed l\u00fd","text":"<ol> <li>Parse access token t\u1eeb header <code>Authorization</code></li> <li> <p>Ki\u1ec3m tra:</p> </li> <li> <p>Ch\u1eef k\u00fd c\u00f3 h\u1ee3p l\u1ec7?</p> </li> <li>Th\u1eddi gian <code>exp</code>, <code>nbf</code>, <code>iat</code></li> <li>Issuer &amp; audience c\u00f3 \u0111\u00fang kh\u00f4ng?</li> <li>Revoked status (<code>jti</code>) \u2192 g\u1ecdi <code>token-service</code> n\u1ebfu c\u1ea7n (t\u00f9y m\u00f4i tr\u01b0\u1eddng)</li> <li>Tr\u00edch xu\u1ea5t th\u00f4ng tin user &amp; tenant \u2192 tr\u1ea3 v\u1ec1</li> </ol>"},{"location":"services/auth-service/master/interface-contract/#ma-loi-co-the-gap","title":"\u26a0\ufe0f M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 g\u1eb7p","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 <code>auth.token_invalid</code> Token b\u1ecb s\u1eeda, sai ch\u1eef k\u00fd <code>auth.token_expired</code> Token h\u1ebft h\u1ea1n <code>auth.token_revoked</code> Token \u0111\u00e3 b\u1ecb thu h\u1ed3i (jti n\u1eb1m trong danh s\u00e1ch revoke) <code>auth.invalid_tenant</code> Token kh\u00f4ng kh\u1edbp v\u1edbi <code>X-Tenant-ID</code> y\u00eau c\u1ea7u"},{"location":"services/auth-service/master/interface-contract/#tinh-huong-kiem-thu_1","title":"\ud83e\uddea T\u00ecnh hu\u1ed1ng ki\u1ec3m th\u1eed","text":"T\u00ecnh hu\u1ed1ng K\u1ebft qu\u1ea3 Token h\u1ee3p l\u1ec7 Tr\u1ea3 <code>valid: true</code> v\u00e0 th\u00f4ng tin user Token expired Tr\u1ea3 <code>valid: false</code>, m\u00e3 l\u1ed7i <code>auth.token_expired</code> Token b\u1ecb s\u1eeda Tr\u1ea3 <code>401 Unauthorized</code>, m\u00e3 l\u1ed7i <code>auth.token_invalid</code> <p>\ud83d\udccc Endpoint n\u00e0y \u0111\u01b0\u1ee3c d\u00f9ng ph\u1ed5 bi\u1ebfn b\u1edfi <code>api-gateway</code> \u0111\u1ec3 validate token tr\u01b0\u1edbc khi forward request v\u00e0o backend.</p>"},{"location":"services/auth-service/master/interface-contract/#29-lay-danh-sach-nha-cung-cap-xac-thuc","title":"2.9. \ud83e\udded L\u1ea5y danh s\u00e1ch nh\u00e0 cung c\u1ea5p x\u00e1c th\u1ef1c","text":"<pre><code>GET /providers\n</code></pre> M\u00f4 t\u1ea3 Tr\u1ea3 v\u1ec1 metadata c\u00e1c <code>auth_provider_config</code> \u0111ang ho\u1ea1t \u0111\u1ed9ng cho tenant hi\u1ec7n t\u1ea1i Auth y\u00eau c\u1ea7u \u274c Kh\u00f4ng Headers <code>X-Tenant-ID</code>, <code>X-Trace-ID</code> Ph\u00e2n quy\u1ec1n Public Response <pre><code>{\n  \"data\": [\n    {\n      \"provider\": \"google\",\n      \"client_id\": \"abc.apps.googleusercontent.com\",\n      \"redirect_uri\": \"https://auth.truongvietanh.edu.vn/oauth2/callback\",\n      \"scopes\": [\"email\", \"profile\"],\n      \"is_active\": true\n    }\n  ],\n  \"meta\": { ... }\n}\n</code></pre> <p>| Audit | Kh\u00f4ng ghi log |</p>"},{"location":"services/auth-service/master/interface-contract/#muc-ich-su-dung","title":"\ud83c\udfaf M\u1ee5c \u0111\u00edch s\u1eed d\u1ee5ng","text":"<ul> <li>Cho ph\u00e9p frontend render \u0111\u00fang n\u00fat \"\u0110\u0103ng nh\u1eadp v\u1edbi Google\" v\u1edbi <code>client_id</code>, <code>redirect_uri</code> t\u01b0\u01a1ng \u1ee9ng</li> <li>Gi\u00fap qu\u1ea3n tr\u1ecb vi\u00ean x\u00e1c minh c\u1ea5u h\u00ecnh OAuth2 hi\u1ec7n t\u1ea1i qua Swagger / Postman</li> </ul>"},{"location":"services/auth-service/master/interface-contract/#luu-y","title":"\u26a0\ufe0f L\u01b0u \u00fd","text":"<ul> <li>M\u1ed7i tenant c\u00f3 th\u1ec3 c\u00f3 nhi\u1ec1u provider (hi\u1ec7n t\u1ea1i ch\u1ec9 h\u1ed7 tr\u1ee3 <code>google</code>)</li> <li>Kh\u00f4ng tr\u1ea3 v\u1ec1 <code>client_secret</code> ho\u1eb7c th\u00f4ng tin nh\u1ea1y c\u1ea3m kh\u00e1c</li> <li>N\u1ebfu <code>X-Tenant-ID</code> kh\u00f4ng h\u1ee3p l\u1ec7 \u2192 tr\u1ea3 l\u1ed7i <code>auth.invalid_tenant</code></li> </ul>"},{"location":"services/auth-service/master/interface-contract/#tinh-huong-kiem-thu_2","title":"\ud83e\uddea T\u00ecnh hu\u1ed1ng ki\u1ec3m th\u1eed","text":"Tr\u01b0\u1eddng h\u1ee3p K\u1ef3 v\u1ecdng Tenant c\u00f3 Google provider Tr\u1ea3 metadata \u0111\u00fang, kh\u00f4ng leak secret Tenant kh\u00f4ng t\u1ed3n t\u1ea1i Tr\u1ea3 l\u1ed7i <code>auth.invalid_tenant</code> G\u1ecdi thi\u1ebfu <code>X-Tenant-ID</code> Tr\u1ea3 l\u1ed7i <code>400 Bad Request</code> ho\u1eb7c <code>403 Forbidden</code> t\u00f9y policy"},{"location":"services/auth-service/master/interface-contract/#3-phu-luc-header-trace-error-code","title":"3. \ud83d\udee0 Ph\u1ee5 l\u1ee5c: Header, Trace &amp; Error Code","text":""},{"location":"services/auth-service/master/interface-contract/#31-header-chuan","title":"3.1. \ud83d\udd17 Header chu\u1ea9n","text":"Header B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>Authorization</code> \u2705 n\u1ebfu API y\u00eau c\u1ea7u login D\u1ea1ng <code>Bearer &lt;access_token&gt;</code> <code>X-Tenant-ID</code> \u2705 v\u1edbi m\u1ecdi request \u0111a tenant M\u00e3 \u0111\u1ecbnh danh tenant hi\u1ec7n h\u00e0nh <code>X-Trace-ID</code> \u2705 UUID duy nh\u1ea5t cho m\u1ed7i request, ph\u1ee5c v\u1ee5 logging &amp; tracing <code>User-Agent</code> \u274c (Khuy\u1ebfn ngh\u1ecb) D\u00f9ng \u0111\u1ec3 ph\u00e2n t\u00edch client &amp; audit <code>X-Forwarded-For</code> \u274c (Tu\u1ef3 ch\u1ecdn) IP th\u1ef1c c\u1ee7a ng\u01b0\u1eddi d\u00f9ng, h\u1ed7 tr\u1ee3 geo/audit <code>X-Login-Method</code> \u274c Forwarded b\u1edfi Gateway, ph\u1ea3n \u00e1nh ph\u01b0\u01a1ng th\u1ee9c login ban \u0111\u1ea7u (<code>google</code>, <code>otp</code>, <code>local</code>) <p>M\u1ecdi request \u0111\u1ec1u n\u00ean g\u1eafn <code>X-Trace-ID</code> (n\u1ebfu kh\u00f4ng c\u00f3, h\u1ec7 th\u1ed1ng s\u1ebd t\u1ef1 sinh v\u00e0 ghi log c\u1ea3nh b\u00e1o).</p>"},{"location":"services/auth-service/master/interface-contract/#32-cau-truc-trace_id","title":"3.2. \ud83e\uddea C\u1ea5u tr\u00fac <code>trace_id</code>","text":"<ul> <li>D\u1ea1ng: UUID v4</li> <li>S\u1eed d\u1ee5ng xuy\u00ean su\u1ed1t c\u00e1c log d\u00f2ng, audit, metric, v\u00e0 c\u1ea3 response body:</li> </ul> <pre><code>{\n  \"meta\": {\n    \"trace_id\": \"7f7b441c-943b-4a68-bf4f-5c3a5e312be5\",\n    \"timestamp\": \"2025-06-10T15:35:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/auth-service/master/interface-contract/#33-namespace-ma-loi","title":"3.3. \u2757\ufe0f Namespace m\u00e3 l\u1ed7i","text":"<p>M\u1ecdi l\u1ed7i \u0111\u1ec1u tu\u00e2n theo \u0111\u1ecbnh d\u1ea1ng <code>auth.&lt;namespace&gt;</code>, v\u00ed d\u1ee5:</p> M\u00e3 l\u1ed7i \u00dd ngh\u0129a <code>auth.invalid_oauth_code</code> Google tr\u1ea3 v\u1ec1 code kh\u00f4ng h\u1ee3p l\u1ec7 ho\u1eb7c \u0111\u00e3 h\u1ebft h\u1ea1n <code>auth.exchange_code_expired</code> M\u00e3 trao \u0111\u1ed5i qu\u00e1 h\u1ea1n ho\u1eb7c \u0111\u00e3 s\u1eed d\u1ee5ng <code>auth.token_issue_failed</code> Kh\u00f4ng th\u1ec3 ph\u00e1t h\u00e0nh token t\u1eeb <code>token-service</code> <code>auth.token_expired</code> Access token h\u1ebft h\u1ea1n <code>auth.token_invalid</code> Token sai \u0111\u1ecbnh d\u1ea1ng ho\u1eb7c kh\u00f4ng c\u00f3 ch\u1eef k\u00fd \u0111\u00fang <code>auth.invalid_tenant</code> Tenant kh\u00f4ng t\u1ed3n t\u1ea1i ho\u1eb7c b\u1ecb v\u00f4 hi\u1ec7u <code>auth.missing_authorization</code> Thi\u1ebfu header <code>Authorization</code> <code>auth.login.failed</code> \u0110\u0103ng nh\u1eadp th\u1ea5t b\u1ea1i (l\u00fd do s\u1ebd ghi trong <code>details</code>) <code>auth.otp_invalid</code> M\u00e3 OTP kh\u00f4ng \u0111\u00fang ho\u1eb7c \u0111\u00e3 h\u1ebft h\u1ea1n <code>auth.local_login_failed</code> Sai username ho\u1eb7c password"},{"location":"services/auth-service/master/interface-contract/#34-mau-phan-hoi-loi","title":"3.4. \ud83d\udccb M\u1eabu ph\u1ea3n h\u1ed3i l\u1ed7i","text":"<pre><code>{\n  \"error\": {\n    \"code\": \"auth.token_invalid\",\n    \"message\": \"Token kh\u00f4ng h\u1ee3p l\u1ec7 ho\u1eb7c \u0111\u00e3 b\u1ecb s\u1eeda \u0111\u1ed5i\",\n    \"details\": []\n  },\n  \"meta\": {\n    \"trace_id\": \"c3d2...\",\n    \"timestamp\": \"2025-06-10T15:44:00Z\"\n  }\n}\n</code></pre> <p>L\u1ed7i s\u1ebd lu\u00f4n k\u00e8m <code>trace_id</code> \u0111\u1ec3 truy v\u1ebft trong logs v\u00e0 audit-service.</p>"},{"location":"services/auth-service/master/interface-contract/#35-enums-dung-trong-auth-service","title":"3.5. \ud83d\udcc9 ENUMs D\u00f9ng trong Auth Service","text":"T\u00ean ENUM Gi\u00e1 tr\u1ecb h\u1ee3p l\u1ec7 M\u00f4 t\u1ea3 <code>auth_provider</code> <code>google</code>, <code>otp</code>, <code>local</code> Ph\u01b0\u01a1ng th\u1ee9c x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng <code>otp_type</code> <code>phone</code>, <code>email</code> K\u00eanh g\u1eedi m\u00e3 OTP <code>grant_type</code> <code>google</code>, <code>otp</code>, <code>local</code> Ph\u01b0\u01a1ng th\u1ee9c x\u00e1c th\u1ef1c truy\u1ec1n v\u00e0o <code>token-service</code> <code>login_status</code> <code>success</code>, <code>failed</code> Tr\u1ea1ng th\u00e1i login (ghi trong audit log) <code>token_type</code> <code>bearer</code> Lo\u1ea1i token \u0111\u01b0\u1ee3c c\u1ea5p <code>error_namespace</code> <code>auth</code>, <code>user</code>, <code>token</code> Namespace c\u1ee7a m\u00e3 l\u1ed7i \u2013 ph\u1ee5c v\u1ee5 chu\u1ea9n h\u00f3a ErrorEnvelope <p>\ud83d\udccc Ghi ch\u00fa:</p> <ul> <li>C\u00e1c gi\u00e1 tr\u1ecb enum ph\u1ea3i \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 xuy\u00ean su\u1ed1t trong OpenAPI Spec, trong <code>token-service</code>, v\u00e0 c\u1ea3 trong c\u00e1c d\u1ecbch v\u1ee5 s\u1eed d\u1ee5ng log/audit.</li> <li>C\u00e1c field nh\u01b0 <code>login_method</code>, <code>auth_provider</code>, <code>grant_type</code> \u0111\u1ec1u s\u1ebd \u0111\u01b0\u1ee3c forward th\u00f4ng qua JWT claims ho\u1eb7c header (<code>X-Login-Method</code>) \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o trace &amp; audit \u0111\u1ea7y \u0111\u1ee7.</li> </ul>"},{"location":"services/auth-service/master/interface-contract/#36-permission-code","title":"3.6. \ud83d\udccb Permission Code","text":"<p>C\u00e1c permission d\u01b0\u1edbi \u0111\u00e2y \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng \u0111\u1ec3 ki\u1ec3m so\u00e1t truy c\u1eadp c\u00e1c API c\u1ee7a <code>auth-service/master</code> trong m\u00f4i tr\u01b0\u1eddng n\u1ed9i b\u1ed9 ho\u1eb7c d\u00e0nh cho admin. C\u00e1c API login ch\u00ednh nh\u01b0 <code>/auth/login</code>, <code>/auth/verify-otp</code>, <code>/oauth2/callback</code> l\u00e0 public n\u00ean kh\u00f4ng y\u00eau c\u1ea7u permission.</p> M\u00e3 Permission M\u00f4 t\u1ea3 \u00c1p d\u1ee5ng cho API <code>auth.otp.send</code> Cho ph\u00e9p g\u1eedi m\u00e3 OTP <code>POST /auth/otp</code> (n\u1ebfu c\u1ea7n gi\u1edbi h\u1ea1n qua API Gateway) <code>auth.user.login_via_local</code> Cho ph\u00e9p \u0111\u0103ng nh\u1eadp b\u1eb1ng t\u00e0i kho\u1ea3n n\u1ed9i b\u1ed9 <code>POST /auth/login</code> <code>auth.user.login_via_otp</code> Cho ph\u00e9p \u0111\u0103ng nh\u1eadp b\u1eb1ng OTP <code>POST /auth/verify-otp</code> <code>auth.user.login_via_oauth2</code> Cho ph\u00e9p login qua Google OAuth2 <code>GET /oauth2/callback</code> <code>auth.provider.admin.read</code> Xem danh s\u00e1ch nh\u00e0 cung c\u1ea5p OAuth2 c\u1ea5u h\u00ecnh <code>GET /providers</code> <code>auth.provider.admin.sync</code> \u0110\u1ed3ng b\u1ed9 config OAuth2 v\u1edbi <code>user-service</code> <code>POST /oauth2/callback</code> ho\u1eb7c webhook n\u1ed9i b\u1ed9 <p>\ud83d\udccc Ghi ch\u00fa: - Trong m\u00f4i tr\u01b0\u1eddng production, c\u00e1c API login ph\u1ed5 bi\u1ebfn kh\u00f4ng n\u00ean y\u00eau c\u1ea7u RBAC, nh\u01b0ng v\u1eabn n\u00ean khai b\u00e1o permission code \u0111\u1ec3 th\u1ed1ng nh\u1ea5t log/audit. - V\u1edbi c\u00e1c m\u00f4i tr\u01b0\u1eddng nh\u1ea1y c\u1ea3m ho\u1eb7c c\u1ea7n b\u1ea3o v\u1ec7 k\u1ef9 h\u01a1n (nh\u01b0 API test ho\u1eb7c endpoint c\u1ea5u h\u00ecnh), c\u1ea7n g\u00e1n permission t\u01b0\u01a1ng \u1ee9ng t\u1ea1i Gateway.</p>"},{"location":"services/auth-service/master/interface-contract/#37-http-status-codes-dung-chung","title":"3.7. \ud83d\udcdf HTTP Status Codes d\u00f9ng chung","text":"<p>B\u1ea3ng sau m\u00f4 t\u1ea3 c\u00e1c m\u00e3 tr\u1ea1ng th\u00e1i HTTP \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng th\u1ed1ng nh\u1ea5t trong to\u00e0n b\u1ed9 <code>auth-service/master</code>. Vi\u1ec7c chu\u1ea9n h\u00f3a n\u00e0y \u0111\u1ea3m b\u1ea3o kh\u1ea3 n\u0103ng d\u1ef1 \u0111o\u00e1n h\u00e0nh vi v\u00e0 d\u1ec5 t\u00edch h\u1ee3p v\u1edbi frontend/client.</p> M\u00e3 \u00dd ngh\u0129a ng\u1eef ngh\u0129a (semantics) \u00c1p d\u1ee5ng trong tr\u01b0\u1eddng h\u1ee3p <code>200 OK</code> Y\u00eau c\u1ea7u th\u00e0nh c\u00f4ng T\u1ea5t c\u1ea3 c\u00e1c API tr\u1ea3 k\u1ebft qu\u1ea3 h\u1ee3p l\u1ec7 <code>201 Created</code> T\u1ea1o m\u1edbi th\u00e0nh c\u00f4ng Kh\u00f4ng d\u00f9ng trong auth-service (kh\u00f4ng c\u00f3 create entity) <code>400 Bad Request</code> D\u1eef li\u1ec7u \u0111\u1ea7u v\u00e0o kh\u00f4ng h\u1ee3p l\u1ec7 Thi\u1ebfu field, sai format, enum kh\u00f4ng \u0111\u00fang, v.v. <code>401 Unauthorized</code> Thi\u1ebfu ho\u1eb7c sai th\u00f4ng tin x\u00e1c th\u1ef1c Token kh\u00f4ng h\u1ee3p l\u1ec7, OTP sai, password sai <code>403 Forbidden</code> Ng\u01b0\u1eddi d\u00f9ng kh\u00f4ng c\u00f3 quy\u1ec1n truy c\u1eadp Khi JWT h\u1ee3p l\u1ec7 nh\u01b0ng kh\u00f4ng c\u00f3 permission c\u1ea7n thi\u1ebft <code>404 Not Found</code> Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i nguy\u00ean Kh\u00f4ng t\u00ecm th\u1ea5y ng\u01b0\u1eddi d\u00f9ng t\u01b0\u01a1ng \u1ee9ng <code>409 Conflict</code> Xung \u0111\u1ed9t d\u1eef li\u1ec7u logic (Hi\u1ebfm d\u00f9ng trong auth-service) <code>429 Too Many Requests</code> Qu\u00e1 nhi\u1ec1u request trong th\u1eddi gian ng\u1eafn G\u1eedi OTP li\u00ean t\u1ee5c, v\u01b0\u1ee3t gi\u1edbi h\u1ea1n login <code>500 Internal Server Error</code> L\u1ed7i kh\u00f4ng x\u00e1c \u0111\u1ecbnh ph\u00eda server G\u1ecdi <code>user-service</code>, <code>token-service</code> th\u1ea5t b\u1ea1i kh\u00f4ng mong \u0111\u1ee3i <code>503 Service Unavailable</code> Service t\u1ea1m th\u1eddi kh\u00f4ng ho\u1ea1t \u0111\u1ed9ng Khi auth-service b\u1ecb qu\u00e1 t\u1ea3i ho\u1eb7c \u0111ang b\u1ea3o tr\u00ec <p>\ud83d\udccc Ghi ch\u00fa: - T\u1ea5t c\u1ea3 c\u00e1c l\u1ed7i \u0111\u1ec1u \u0111\u01b0\u1ee3c b\u1ecdc theo chu\u1ea9n <code>ErrorEnvelope</code>, v\u1edbi <code>code</code>, <code>message</code>, v\u00e0 <code>details</code>. - Trace ID \u0111\u01b0\u1ee3c \u0111\u00ednh k\u00e8m trong <code>meta.trace_id</code> \u0111\u1ec3 ph\u1ee5c v\u1ee5 truy v\u1ebft (observability). - Frontend n\u00ean x\u1eed l\u00fd theo logic m\u00e3 l\u1ed7i (namespace + code), kh\u00f4ng ph\u1ee5 thu\u1ed9c tuy\u1ec7t \u0111\u1ed1i v\u00e0o HTTP status.</p>"},{"location":"services/auth-service/master/interface-contract/#38-tai-lieu-tham-chieu","title":"3.8. \ud83d\udd16 T\u00e0i li\u1ec7u tham chi\u1ebfu:","text":"<ul> <li>Data Model</li> <li>OpenAPI Spec</li> <li>Design</li> <li><code>ADR-012</code></li> <li><code>ADR-011</code></li> </ul>"},{"location":"services/auth-service/sub/data-model/","title":"\ud83d\uddc3\ufe0f Auth Service Sub - Data Model v2.0","text":""},{"location":"services/auth-service/sub/data-model/#1-muc-tieu-pham-vi","title":"1. \ud83d\udcd8 M\u1ee5c ti\u00eau &amp; Ph\u1ea1m vi","text":"<p>T\u00e0i li\u1ec7u n\u00e0y \u0111\u1ecbnh ngh\u0129a m\u00f4 h\u00ecnh d\u1eef li\u1ec7u cho <code>auth-service/sub</code>, m\u1ed9t service x\u00e1c th\u1ef1c per-tenant trong h\u1ec7 th\u1ed1ng <code>dx-vas</code>. Vi\u1ec7c thi\u1ebft k\u1ebf m\u00f4 h\u00ecnh d\u1eef li\u1ec7u chu\u1ea9n x\u00e1c l\u00e0 n\u1ec1n t\u1ea3ng \u0111\u1ec3:</p> <ul> <li>\u0110\u1ea3m b\u1ea3o t\u00ednh to\u00e0n v\u1eb9n, b\u1ea3o m\u1eadt v\u00e0 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng c\u1ee7a d\u1eef li\u1ec7u x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng</li> <li>Ph\u1ee5c v\u1ee5 c\u00e1c thao t\u00e1c x\u00e1c th\u1ef1c OTP, Local Login, qu\u1ea3n l\u00fd phi\u00ean \u0111\u0103ng nh\u1eadp, v\u00e0 thu h\u1ed3i token</li> <li>Ghi nh\u1eadn metadata c\u1ea7n thi\u1ebft cho audit log, b\u1ea3o v\u1ec7 h\u1ec7 th\u1ed1ng kh\u1ecfi gian l\u1eadn</li> <li>\u0110\u1ea3m b\u1ea3o kh\u1ea3 n\u0103ng truy v\u1ebft (traceability) v\u00e0 ph\u00e2n quy\u1ec1n truy c\u1eadp theo ch\u00ednh s\u00e1ch RBAC</li> </ul>"},{"location":"services/auth-service/sub/data-model/#muc-tieu-cu-the","title":"\ud83c\udfaf M\u1ee5c ti\u00eau c\u1ee5 th\u1ec3","text":"<ul> <li>Thi\u1ebft k\u1ebf b\u1ea3ng d\u1eef li\u1ec7u <code>auth_sessions</code> chu\u1ea9n h\u00f3a, ph\u1ea3n \u00e1nh \u0111\u1ea7y \u0111\u1ee7 v\u00f2ng \u0111\u1eddi m\u1ed9t phi\u00ean \u0111\u0103ng nh\u1eadp</li> <li>\u0110\u1ecbnh ngh\u0129a c\u1ea5u tr\u00fac cache <code>revoked_tokens</code> tr\u00ean Redis d\u00f9ng \u0111\u1ec3 thu h\u1ed3i token ch\u1ee7 \u0111\u1ed9ng</li> <li>Chu\u1ea9n h\u00f3a metadata g\u1eafn v\u1edbi session bao g\u1ed3m <code>ip_address</code>, <code>user_agent</code>, <code>device_type</code>, <code>location</code></li> <li>Ph\u00e2n lo\u1ea1i v\u00e0 m\u00f4 t\u1ea3 c\u00e1c gi\u00e1 tr\u1ecb ENUM quan tr\u1ecdng trong logic x\u00e1c th\u1ef1c (<code>auth_method</code>, <code>device_type</code>, v.v.)</li> <li>Thi\u1ebft l\u1eadp chi\u1ebfn l\u01b0\u1ee3c Retention &amp; Anonymization nh\u1ea5t qu\u00e1n v\u1edbi to\u00e0n h\u1ec7 th\u1ed1ng</li> <li>H\u1ed7 tr\u1ee3 ki\u1ec3m th\u1eed v\u00e0 migration schema d\u1ec5 d\u00e0ng tr\u00ean m\u00f4i tr\u01b0\u1eddng multi-tenant</li> </ul>"},{"location":"services/auth-service/sub/data-model/#pham-vi-du-lieu-uoc-quan-ly","title":"\ud83d\udce6 Ph\u1ea1m vi d\u1eef li\u1ec7u \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd","text":"Lo\u1ea1i d\u1eef li\u1ec7u M\u00f4 t\u1ea3 auth_sessions Ghi nh\u1eadn m\u1ed7i phi\u00ean \u0111\u0103ng nh\u1eadp th\u00e0nh c\u00f4ng c\u1ee7a user revoked_tokens L\u01b0u token b\u1ecb thu h\u1ed3i ch\u1ee7 \u0111\u1ed9ng ho\u1eb7c h\u1ebft hi\u1ec7u l\u1ef1c (Redis) Session metadata Th\u00f4ng tin m\u00f4i tr\u01b0\u1eddng x\u00e1c th\u1ef1c: IP, thi\u1ebft b\u1ecb, tr\u00ecnh duy\u1ec7t Login method Ph\u00e2n bi\u1ec7t gi\u1eefa OTP / Local login Tr\u1ea1ng th\u00e1i phi\u00ean \u0110\u01b0\u1ee3c duy tr\u00ec \u0111\u1ec3 ph\u1ee5c v\u1ee5 giao di\u1ec7n qu\u1ea3n tr\u1ecb ho\u1eb7c ph\u00e2n t\u00edch"},{"location":"services/auth-service/sub/data-model/#ngoai-pham-vi-out-of-scope","title":"\ud83d\udeab Ngo\u00e0i ph\u1ea1m vi (Out of Scope)","text":"Th\u00e0nh ph\u1ea7n Ghi ch\u00fa OAuth2 / Social login (Google) \u0110\u01b0\u1ee3c x\u1eed l\u00fd b\u1edfi <code>auth-service/master</code> theo <code>adr-006</code> Th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng (user profile) \u0110\u01b0\u1ee3c qu\u1ea3n l\u00fd t\u1ea1i <code>user-service</code> Ki\u1ec3m tra RBAC / quy\u1ec1n truy c\u1eadp \u0110\u01b0\u1ee3c th\u1ef1c hi\u1ec7n t\u1ea1i <code>api-gateway</code> v\u00e0 <code>rbac-cache</code> Refresh token storage Kh\u00f4ng l\u01b0u refresh token, ch\u1ec9 x\u1eed l\u00fd revoke qua <code>token-service</code>"},{"location":"services/auth-service/sub/data-model/#lien-he-kien-truc-tong-the","title":"\ud83e\udded Li\u00ean h\u1ec7 ki\u1ebfn tr\u00fac t\u1ed5ng th\u1ec3","text":"<p>M\u00f4 h\u00ecnh d\u1eef li\u1ec7u \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf \u0111\u1ec3 v\u1eadn h\u00e0nh t\u1ed1t trong ki\u1ebfn tr\u00fac: - Multi-tenant per-instance (m\u1ed7i tenant c\u00f3 DB ri\u00eang ho\u1eb7c schema ri\u00eang) - Stateless microservice (t\u1ea5t c\u1ea3 tr\u1ea1ng th\u00e1i x\u00e1c th\u1ef1c \u0111\u01b0\u1ee3c externalized) - Token-based auth (kh\u00f4ng l\u01b0u tr\u1ea1ng th\u00e1i user \u0111\u0103ng nh\u1eadp trong RAM) - RBAC externalized (qu\u1ea3n l\u00fd quy\u1ec1n ngo\u00e0i auth-service/sub)</p>"},{"location":"services/auth-service/sub/data-model/#2-tong-quan-du-lieu-moi-quan-he","title":"2. \ud83e\udde9 T\u1ed5ng Quan D\u1eef Li\u1ec7u &amp; M\u1ed1i Quan H\u1ec7","text":"<p>M\u00f4 h\u00ecnh d\u1eef li\u1ec7u c\u1ee7a <code>auth-service/sub</code> \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf t\u1ed1i gi\u1ea3n v\u00e0 hi\u1ec7u qu\u1ea3, t\u1eadp trung v\u00e0o vi\u1ec7c qu\u1ea3n l\u00fd v\u00f2ng \u0111\u1eddi phi\u00ean \u0111\u0103ng nh\u1eadp v\u00e0 vi\u1ec7c thu h\u1ed3i token, \u0111\u1ed3ng th\u1eddi ghi nh\u1eadn \u0111\u1ea7y \u0111\u1ee7 metadata ph\u1ee5c v\u1ee5 cho audit, ph\u00e2n t\u00edch b\u1ea3o m\u1eadt v\u00e0 gi\u00e1m s\u00e1t h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng.</p>"},{"location":"services/auth-service/sub/data-model/#21-so-o-erd-entity-relationship-diagram","title":"2.1. S\u01a1 \u0111\u1ed3 ERD (Entity Relationship Diagram)","text":"<pre><code>erDiagram\n\n  AUTH_SESSIONS {\n    UUID id PK\n    UUID user_id\n    TEXT auth_method\n    TEXT device_type\n    TEXT ip_address\n    TEXT user_agent\n    TEXT location\n    TEXT session_status\n    TIMESTAMP created_at\n    TIMESTAMP expired_at\n    TIMESTAMP revoked_at\n    TEXT revoked_reason\n    UUID tenant_id\n  }\n\n  REVOKED_TOKENS {\n    TEXT jti PK\n    UUID session_id FK\n    UUID user_id\n    TIMESTAMP revoked_at\n    TEXT reason\n    UUID tenant_id\n  }\n\n  AUTH_SESSIONS ||--o{ REVOKED_TOKENS : has\n</code></pre>"},{"location":"services/auth-service/sub/data-model/#22-giai-thich-moi-quan-he","title":"2.2. Gi\u1ea3i th\u00edch m\u1ed1i quan h\u1ec7","text":"Quan h\u1ec7 Lo\u1ea1i M\u00f4 t\u1ea3 <code>auth_sessions</code> \u2192 <code>revoked_tokens</code> 1:N M\u1ed7i phi\u00ean c\u00f3 th\u1ec3 c\u00f3 nhi\u1ec1u token b\u1ecb thu h\u1ed3i li\u00ean quan (vd. refresh token, access token th\u1ee9 c\u1ea5p) <code>user_id</code>, <code>tenant_id</code> Ch\u1ec9 \u0111\u1ecbnh ng\u01b0\u1eddi d\u00f9ng v\u00e0 tenant t\u01b0\u01a1ng \u1ee9ng v\u1edbi phi\u00ean <code>session_id</code> \u0110\u01b0\u1ee3c s\u1eed d\u1ee5ng \u0111\u1ec3 li\u00ean k\u1ebft ng\u01b0\u1ee3c t\u1eeb cache ho\u1eb7c revoke record \u0111\u1ebfn phi\u00ean \u0111\u0103ng nh\u1eadp g\u1ed1c <p>\u2705 M\u1ecdi b\u1ea3ng \u0111\u1ec1u c\u00f3 kh\u00f3a ch\u00ednh r\u00f5 r\u00e0ng, h\u1ed7 tr\u1ee3 ph\u00e2n v\u00f9ng theo <code>tenant_id</code> n\u1ebfu c\u1ea7n.</p>"},{"location":"services/auth-service/sub/data-model/#23-ky-hieu-conventions","title":"2.3. K\u00fd hi\u1ec7u &amp; conventions","text":"<ul> <li>UUID: To\u00e0n b\u1ed9 c\u00e1c kho\u00e1 ch\u00ednh v\u00e0 li\u00ean k\u1ebft \u0111\u1ec1u d\u00f9ng UUID \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o t\u00ednh to\u00e0n c\u1ee5c v\u00e0 d\u1ec5 trace.</li> <li>snake_case: D\u00f9ng th\u1ed1ng nh\u1ea5t cho t\u00ean c\u1ed9t.</li> <li>tenant_id: C\u00f3 m\u1eb7t \u1edf m\u1ecdi b\u1ea3ng \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o kh\u1ea3 n\u0103ng l\u1ecdc, truy xu\u1ea5t v\u00e0 b\u1ea3o v\u1ec7 tenant isolation.</li> <li>Timestamp: Lu\u00f4n d\u00f9ng timezone-aware timestamp (<code>TIMESTAMPTZ</code> n\u1ebfu PostgreSQL).</li> <li>Tr\u1ea1ng th\u00e1i logic (nh\u01b0 <code>revoked_at</code>, <code>revoked_reason</code>, <code>session_status</code>) d\u00f9ng nullable field thay v\u00ec boolean flag \u2014 \u0111\u1ea3m b\u1ea3o m\u1edf r\u1ed9ng v\u1ec1 sau.</li> </ul>"},{"location":"services/auth-service/sub/data-model/#ghi-chu-thiet-ke","title":"\ud83e\udde0 Ghi ch\u00fa thi\u1ebft k\u1ebf","text":"<ul> <li>Kh\u00f4ng c\u00f3 b\u1ea3ng <code>users</code> trong service n\u00e0y \u2013 m\u1ecdi th\u00f4ng tin user \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 t\u1eeb <code>user-service</code>.</li> <li>Cache <code>revoked_tokens</code> tr\u00ean Redis c\u00f3 th\u1ec3 ph\u1ea3n \u00e1nh m\u1ed9t ph\u1ea7n d\u1eef li\u1ec7u t\u1eeb DB \u0111\u1ec3 t\u1ed1i \u01b0u tra c\u1ee9u runtime.</li> <li>Session metadata c\u00f3 th\u1ec3 ph\u1ee5c v\u1ee5 cho audit log, tracking \u0111\u0103ng nh\u1eadp b\u1ea5t th\u01b0\u1eddng, ho\u1eb7c security scoring.</li> </ul>"},{"location":"services/auth-service/sub/data-model/#3-bang-auth_sessions","title":"3. \ud83d\udccc B\u1ea3ng <code>auth_sessions</code>","text":"<p>B\u1ea3ng <code>auth_sessions</code> ghi l\u1ea1i m\u1ecdi phi\u00ean \u0111\u0103ng nh\u1eadp th\u00e0nh c\u00f4ng c\u1ee7a ng\u01b0\u1eddi d\u00f9ng (qua OTP ho\u1eb7c Local login), l\u00e0 c\u01a1 s\u1edf cho vi\u1ec7c qu\u1ea3n l\u00fd v\u00f2ng \u0111\u1eddi x\u00e1c th\u1ef1c, ph\u1ee5c v\u1ee5 ki\u1ec3m tra b\u1ea3o m\u1eadt, th\u1ed1ng k\u00ea h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng v\u00e0 ki\u1ec3m so\u00e1t thu h\u1ed3i token.</p>"},{"location":"services/auth-service/sub/data-model/#31-muc-ich","title":"3.1. \ud83e\uddfe M\u1ee5c \u0111\u00edch","text":"<ul> <li>L\u01b0u v\u1ebft m\u1ed7i l\u1ea7n \u0111\u0103ng nh\u1eadp th\u00e0nh c\u00f4ng</li> <li>G\u1eafn metadata li\u00ean quan \u0111\u1ebfn m\u00f4i tr\u01b0\u1eddng \u0111\u0103ng nh\u1eadp</li> <li>Li\u00ean k\u1ebft v\u1edbi <code>revoked_tokens</code> \u0111\u1ec3 h\u1ed7 tr\u1ee3 revoke c\u00f3 m\u1ee5c ti\u00eau</li> <li>Ph\u1ee5c v\u1ee5 th\u1ed1ng k\u00ea \u0111\u0103ng nh\u1eadp v\u00e0 c\u1ea3nh b\u00e1o b\u1ea3o m\u1eadt</li> <li>L\u00e0 ngu\u1ed3n d\u1eef li\u1ec7u ch\u00ednh cho h\u1ec7 th\u1ed1ng audit logging &amp; observability</li> </ul>"},{"location":"services/auth-service/sub/data-model/#32-cau-truc-sql-postgresql","title":"3.2. \ud83d\udcdc C\u1ea5u tr\u00fac SQL (PostgreSQL)","text":"<pre><code>CREATE TABLE auth_sessions (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID NOT NULL,\n  tenant_id UUID NOT NULL,\n  auth_method TEXT NOT NULL CHECK (auth_method IN ('otp', 'local')),\n  session_status TEXT DEFAULT 'active', -- optional UI status\n  ip_address TEXT,\n  user_agent TEXT,\n  device_type TEXT,\n  location TEXT,\n  created_at TIMESTAMPTZ DEFAULT now(),\n  expired_at TIMESTAMPTZ,\n  revoked_at TIMESTAMPTZ,\n  revoked_reason TEXT\n);\n</code></pre>"},{"location":"services/auth-service/sub/data-model/#33-mo-ta-cac-cot","title":"3.3. \ud83d\udccb M\u00f4 t\u1ea3 c\u00e1c c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u M\u00f4 t\u1ea3 <code>id</code> UUID ID phi\u00ean \u0111\u0103ng nh\u1eadp <code>user_id</code> UUID ID ng\u01b0\u1eddi d\u00f9ng \u0111\u0103ng nh\u1eadp <code>tenant_id</code> UUID Tenant s\u1edf h\u1eefu phi\u00ean n\u00e0y <code>auth_method</code> TEXT <code>otp</code> ho\u1eb7c <code>local</code> <code>session_status</code> TEXT Optional UI tag (<code>active</code>, <code>revoked</code>, <code>expired</code>, etc.) <code>ip_address</code> TEXT \u0110\u1ecba ch\u1ec9 IP t\u1eeb frontend/backend <code>user_agent</code> TEXT Tr\u00ecnh duy\u1ec7t/thi\u1ebft b\u1ecb truy c\u1eadp <code>device_type</code> TEXT Ph\u00e2n lo\u1ea1i thi\u1ebft b\u1ecb: <code>web</code>, <code>mobile</code>, <code>kiosk</code> <code>location</code> TEXT \u01af\u1edbc l\u01b0\u1ee3ng \u0111\u1ecba l\u00fd n\u1ebfu c\u00f3 (t\u1eeb IP) <code>created_at</code> TIMESTAMPTZ Th\u1eddi \u0111i\u1ec3m login th\u00e0nh c\u00f4ng <code>expired_at</code> TIMESTAMPTZ D\u1ef1 ki\u1ebfn th\u1eddi \u0111i\u1ec3m token h\u1ebft h\u1ea1n <code>revoked_at</code> TIMESTAMPTZ N\u1ebfu b\u1ecb thu h\u1ed3i th\u1ee7 c\u00f4ng ho\u1eb7c logout <code>revoked_reason</code> TEXT L\u00fd do b\u1ecb thu h\u1ed3i (n\u1ebfu c\u00f3)"},{"location":"services/auth-service/sub/data-model/#34-rbac-bao-mat-theo-cot","title":"3.4. \ud83d\udd10 RBAC &amp; B\u1ea3o m\u1eadt theo c\u1ed9t","text":"<ul> <li>Ch\u1ec9 ch\u00ednh user (<code>self</code>) ho\u1eb7c admin n\u1ed9i b\u1ed9 c\u00f3 quy\u1ec1n \u0111\u1ecdc</li> <li>C\u1ed9t <code>ip_address</code>, <code>user_agent</code>, <code>location</code> \u0111\u01b0\u1ee3c \u0111\u00e1nh d\u1ea5u l\u00e0 d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m theo <code>adr-024</code></li> <li>T\u1ea5t c\u1ea3 truy c\u1eadp \u0111\u1ecdc ph\u1ea3i \u0111i qua l\u1edbp ki\u1ec3m tra <code>x-condition</code> d\u1ef1a tr\u00ean <code>user_id</code> ho\u1eb7c <code>tenant_id</code></li> </ul>"},{"location":"services/auth-service/sub/data-model/#35-index-constraint","title":"3.5. \u26a1 Index &amp; Constraint","text":"T\u00ean Ki\u1ec3u M\u1ee5c \u0111\u00edch <code>idx_auth_sessions_user</code> B-tree Truy xu\u1ea5t nhanh theo <code>user_id</code> <code>idx_auth_sessions_tenant_created</code> B-tree Truy xu\u1ea5t theo <code>tenant_id</code> v\u00e0 <code>created_at</code> <code>check_auth_method</code> CHECK R\u00e0ng bu\u1ed9c <code>otp</code> ho\u1eb7c <code>local</code> <code>check_not_future_created_at</code> CHECK <code>created_at</code> kh\u00f4ng \u0111\u01b0\u1ee3c l\u1edbn h\u01a1n <code>now()</code>"},{"location":"services/auth-service/sub/data-model/#36-vi-du-ban-ghi","title":"3.6. \ud83d\udca1 V\u00ed d\u1ee5 b\u1ea3n ghi","text":"<pre><code>{\n  \"id\": \"f2b9c6ae-4b78-4d99-b4ea-25db9c91a95c\",\n  \"user_id\": \"7b6d3f56-25b9-42cf-9c29-631f6fd43a90\",\n  \"tenant_id\": \"school-abc\",\n  \"auth_method\": \"otp\",\n  \"ip_address\": \"118.70.84.12\",\n  \"user_agent\": \"Mozilla/5.0 (iPhone; CPU iPhone OS 14_6)\",\n  \"device_type\": \"mobile\",\n  \"location\": \"Ho Chi Minh, VN\",\n  \"created_at\": \"2025-06-13T10:32:20Z\",\n  \"expired_at\": \"2025-06-13T12:32:20Z\",\n  \"session_status\": \"active\"\n}\n</code></pre> <p>\ud83d\udccc Ghi ch\u00fa:</p> <ul> <li>Tr\u01b0\u1eddng <code>expired_at</code> th\u01b0\u1eddng \u0111\u01b0\u1ee3c x\u00e1c \u0111\u1ecbnh b\u1edfi JWT TTL + policy</li> <li>Tr\u01b0\u1eddng <code>revoked_at</code> c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c g\u1eafn khi user logout ho\u1eb7c b\u1ecb revoke th\u1ee7 c\u00f4ng qua API</li> <li>Tr\u01b0\u1eddng <code>location</code> l\u00e0 tu\u1ef3 ch\u1ecdn (nullable), th\u01b0\u1eddng \u0111\u01b0\u1ee3c x\u00e1c \u0111\u1ecbnh t\u1eeb IP ph\u00eda frontend g\u1eedi v\u1ec1</li> </ul>"},{"location":"services/auth-service/sub/data-model/#4-cache-revoked_tokens-redis","title":"4. \ud83d\udccc Cache <code>revoked_tokens</code> (Redis)","text":"<p>H\u1ec7 th\u1ed1ng s\u1eed d\u1ee5ng Redis nh\u01b0 m\u1ed9t b\u1ed9 nh\u1edb \u0111\u1ec7m ph\u00e2n t\u00e1n \u0111\u1ec3 l\u01b0u th\u00f4ng tin c\u00e1c token \u0111\u00e3 b\u1ecb thu h\u1ed3i (revoked), gi\u00fap <code>api-gateway</code> v\u00e0 c\u00e1c service li\u00ean quan ki\u1ec3m tra nhanh t\u00ednh h\u1ee3p l\u1ec7 c\u1ee7a token khi nh\u1eadn request.</p>"},{"location":"services/auth-service/sub/data-model/#41-muc-ich","title":"4.1. \ud83e\uddfe M\u1ee5c \u0111\u00edch","text":"<ul> <li>Truy v\u1ea5n nhanh token c\u00f3 b\u1ecb thu h\u1ed3i hay kh\u00f4ng m\u00e0 kh\u00f4ng c\u1ea7n truy c\u1eadp DB</li> <li>H\u1ed7 tr\u1ee3 ng\u01b0\u1eddi d\u00f9ng logout ch\u1ee7 \u0111\u1ed9ng tr\u00ean m\u1ecdi thi\u1ebft b\u1ecb</li> <li>H\u1ea1n ch\u1ebf token reuse ho\u1eb7c abuse khi x\u1ea3y ra m\u1ea5t m\u00e1t thi\u1ebft b\u1ecb</li> </ul>"},{"location":"services/auth-service/sub/data-model/#42-cau-truc-redis-key-value","title":"4.2. \ud83e\udde9 C\u1ea5u tr\u00fac Redis Key-Value","text":"Th\u00e0nh ph\u1ea7n M\u00f4 t\u1ea3 Key <code>revoked:&lt;jti&gt;</code> (VD: <code>revoked:1f2e3d4c</code>) Value (JSON) Metadata v\u1ec1 l\u00fd do v\u00e0 th\u1eddi \u0111i\u1ec3m b\u1ecb thu h\u1ed3i TTL B\u1eb1ng ho\u1eb7c l\u1edbn h\u01a1n TTL t\u1ed1i \u0111a c\u1ee7a token t\u01b0\u01a1ng \u1ee9ng <p>\ud83d\udccc V\u00ed d\u1ee5 gi\u00e1 tr\u1ecb Redis:</p> <pre><code>{\n  \"revoked_at\": \"2025-06-13T10:40:00Z\",\n  \"reason\": \"user_logout\",\n  \"session_id\": \"f2b9c6ae-4b78-4d99-b4ea-25db9c91a95c\",\n  \"user_id\": \"7b6d3f56-25b9-42cf-9c29-631f6fd43a90\"\n}\n</code></pre>"},{"location":"services/auth-service/sub/data-model/#43-ttl-va-chinh-sach-don-dep","title":"4.3. \u267b\ufe0f TTL v\u00e0 ch\u00ednh s\u00e1ch d\u1ecdn d\u1eb9p","text":"<ul> <li>M\u1ed7i token \u0111\u01b0\u1ee3c l\u01b0u k\u00e8m <code>TTL = expiration_time - now</code></li> <li>Token \u0111\u00e3 h\u1ebft h\u1ea1n s\u1ebd t\u1ef1 \u0111\u1ed9ng b\u1ecb Redis xo\u00e1</li> <li>Kh\u00f4ng c\u1ea7n migration hay cleanup \u0111\u1ecbnh k\u1ef3</li> </ul> <p>\ud83d\udccc N\u1ebfu d\u00f9ng <code>Sliding TTL</code> ho\u1eb7c <code>Refresh token rotation</code>, ph\u1ea3i b\u1ea3o \u0111\u1ea3m TTL \u0111\u1ee7 d\u00e0i \u0111\u1ec3 bao ph\u1ee7 th\u1eddi gian ki\u1ec3m tra replay.</p>"},{"location":"services/auth-service/sub/data-model/#44-tuong-tac-trong-lifecycle","title":"4.4. \ud83d\udd01 T\u01b0\u01a1ng t\u00e1c trong lifecycle","text":"H\u00e0nh \u0111\u1ed9ng K\u1ebft qu\u1ea3 tr\u00ean Redis Logout th\u00e0nh c\u00f4ng Ghi <code>revoked:&lt;jti&gt;</code> k\u00e8m l\u00fd do Token b\u1ecb force revoke (Admin) Ghi <code>revoked:&lt;jti&gt;</code> t\u1eeb background job Refresh token b\u1ecb d\u00f9ng l\u1ea1i Ghi <code>revoked:&lt;jti&gt;</code> + c\u1ea3nh b\u00e1o audit Login m\u1edbi Kh\u00f4ng ghi g\u00ec v\u00e0o Redis (token h\u1ee3p l\u1ec7) <p>T\u1ea5t c\u1ea3 service consumer (gateway, audit, CRM adapter\u2026) ph\u1ea3i check revoked cache tr\u01b0\u1edbc khi x\u1eed l\u00fd logic n\u1ebfu th\u1ea5y token h\u1ee3p l\u1ec7 v\u1ec1 m\u1eb7t signature.</p>"},{"location":"services/auth-service/sub/data-model/#45-luu-y-trien-khai","title":"4.5. \ud83d\udea8 L\u01b0u \u00fd tri\u1ec3n khai","text":"<ul> <li>Redis ph\u1ea3i \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh HA, persistence v\u00e0 TTL-aware eviction policy</li> <li>Th\u1ef1c hi\u1ec7n b\u1eb1ng Redis Cluster n\u1ebfu c\u00f3 h\u01a1n 50k tenant/token active</li> <li>M\u1ecdi key \u0111\u1ec1u ph\u1ea3i \u0111\u01b0\u1ee3c prefix <code>revoked:</code> \u0111\u1ec3 ph\u00e2n bi\u1ec7t namespace r\u00f5 r\u00e0ng</li> <li>Redis s\u1eed d\u1ee5ng db-index ri\u00eang n\u1ebfu chia cho nhi\u1ec1u d\u1ecbch v\u1ee5</li> <li>Kh\u00f4ng d\u00f9ng \u0111\u1ec3 backup token \u2013 ch\u1ec9 \u0111\u1ec3 ki\u1ec3m tra t\u00ednh h\u1ee3p l\u1ec7 t\u1ee9c th\u1eddi</li> </ul> <p>\ud83d\udccc Ghi ch\u00fa b\u1ea3o m\u1eadt:</p> <ul> <li>Th\u00f4ng tin l\u01b0u trong Redis kh\u00f4ng ch\u1ee9a JWT g\u1ed1c</li> <li>D\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m nh\u01b0 <code>session_id</code> c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c \u1ea9n ho\u1eb7c m\u00e3 h\u00f3a n\u1ebfu chia s\u1ebb multi-tenant cluster</li> <li>Redis ph\u1ea3i n\u1eb1m sau firewall ho\u1eb7c private subnet trong h\u1ea1 t\u1ea7ng cloud</li> </ul>"},{"location":"services/auth-service/sub/data-model/#5-session-metadata","title":"5. \ud83e\udde9 Session Metadata","text":"<p>M\u1ed7i phi\u00ean \u0111\u0103ng nh\u1eadp (<code>auth_session</code>) \u0111\u01b0\u1ee3c g\u1eafn k\u00e8m metadata ph\u1ea3n \u00e1nh ng\u1eef c\u1ea3nh truy c\u1eadp c\u1ee7a ng\u01b0\u1eddi d\u00f9ng. Nh\u1eefng d\u1eef li\u1ec7u n\u00e0y gi\u00fap t\u0103ng c\u01b0\u1eddng b\u1ea3o m\u1eadt, h\u1ed7 tr\u1ee3 ph\u00e2n t\u00edch h\u00e0nh vi, v\u00e0 ph\u1ee5c v\u1ee5 cho c\u00e1c h\u1ec7 th\u1ed1ng quan s\u00e1t (observability) &amp; ki\u1ec3m to\u00e1n (audit).</p>"},{"location":"services/auth-service/sub/data-model/#51-danh-sach-cac-truong-metadata","title":"5.1. \ud83d\udccb Danh s\u00e1ch c\u00e1c tr\u01b0\u1eddng metadata","text":"Tr\u01b0\u1eddng Ki\u1ec3u M\u00f4 t\u1ea3 <code>ip_address</code> TEXT \u0110\u1ecba ch\u1ec9 IP g\u1ed1c c\u1ee7a client (c\u00f3 th\u1ec3 l\u1ea5y t\u1eeb header <code>X-Forwarded-For</code>) <code>user_agent</code> TEXT Chu\u1ed7i tr\u00ecnh duy\u1ec7t g\u1eedi k\u00e8m request <code>device_type</code> TEXT Ph\u00e2n lo\u1ea1i thi\u1ebft b\u1ecb: <code>web</code>, <code>mobile</code>, <code>kiosk</code>, <code>tablet</code>\u2026 <code>location</code> TEXT \u01af\u1edbc l\u01b0\u1ee3ng \u0111\u1ecba l\u00fd (city/country) t\u1eeb IP (n\u1ebfu c\u00f3) <code>login_context</code> JSONB (optional) Ghi ch\u00fa m\u1edf r\u1ed9ng nh\u01b0: app version, referral, login reason, MFA step"},{"location":"services/auth-service/sub/data-model/#52-nguon-goc-du-lieu","title":"5.2. \ud83e\udde0 Ngu\u1ed3n g\u1ed1c d\u1eef li\u1ec7u","text":"<ul> <li>C\u00e1c tr\u01b0\u1eddng n\u00e0y \u0111\u01b0\u1ee3c thu th\u1eadp t\u1eeb frontend ho\u1eb7c middleware t\u1ea1i gateway</li> <li>Sau \u0111\u00f3 \u0111\u00ednh k\u00e8m v\u00e0o payload g\u1eedi \u0111\u1ebfn <code>auth-service/sub</code> trong qu\u00e1 tr\u00ecnh login</li> <li>\u0110\u01b0\u1ee3c ghi tr\u1ef1c ti\u1ebfp v\u00e0o b\u1ea3ng <code>auth_sessions</code> ho\u1eb7c l\u01b0u k\u00e8m audit log</li> </ul>"},{"location":"services/auth-service/sub/data-model/#53-bao-mat-xu-ly-du-lieu-nhay-cam","title":"5.3. \ud83d\udee1 B\u1ea3o m\u1eadt &amp; x\u1eed l\u00fd d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m","text":"D\u1eef li\u1ec7u \u0110\u1ed9 nh\u1ea1y H\u01b0\u1edbng x\u1eed l\u00fd <code>ip_address</code>, <code>location</code> Cao C\u00f3 th\u1ec3 \u1ea9n \u0111i khi g\u1eedi \u0111\u1ebfn audit log (theo <code>adr-024</code>) <code>user_agent</code> Trung b\u00ecnh Tr\u00edch xu\u1ea5t th\u00f4ng tin ch\u00ednh (OS, tr\u00ecnh duy\u1ec7t) n\u1ebfu c\u1ea7n <code>login_context</code> Tu\u1ef3 thu\u1ed9c C\u1ea7n x\u00e1c \u0111\u1ecbnh c\u1ee5 th\u1ec3 schema &amp; x\u1ebfp h\u1ea1ng \u0111\u1ed9 nh\u1ea1y <p>M\u1ecdi metadata \u0111\u1ec1u ph\u1ea3i tu\u00e2n theo chi\u1ebfn l\u01b0\u1ee3c anonymization ho\u1eb7c masking khi l\u01b0u l\u00e2u d\u00e0i ho\u1eb7c g\u1eedi sang h\u1ec7 th\u1ed1ng ngo\u00e0i.</p>"},{"location":"services/auth-service/sub/data-model/#54-su-dung-trong-he-thong","title":"5.4. \ud83d\udcc8 S\u1eed d\u1ee5ng trong h\u1ec7 th\u1ed1ng","text":"<ul> <li>\u0110\u01b0\u1ee3c g\u1eafn v\u00e0o m\u1ed7i b\u1ea3n ghi <code>auth_sessions</code></li> <li>G\u1eedi l\u00ean Pub/Sub khi ph\u00e1t sinh s\u1ef1 ki\u1ec7n <code>auth.token.issued</code> ho\u1eb7c <code>auth.token.revoked</code></li> <li>L\u00e0m ch\u1ec9 s\u1ed1 ch\u00ednh trong dashboard theo d\u00f5i \u0111\u0103ng nh\u1eadp (Prometheus/Grafana)</li> <li>S\u1eed d\u1ee5ng \u0111\u1ec3 ph\u00e1t hi\u1ec7n \u0111\u0103ng nh\u1eadp b\u1ea5t th\u01b0\u1eddng, login t\u1eeb qu\u1ed1c gia b\u1ea5t th\u01b0\u1eddng, thi\u1ebft b\u1ecb l\u1ea1</li> </ul>"},{"location":"services/auth-service/sub/data-model/#55-goi-y-mo-rong-tuong-lai","title":"5.5. \ud83d\udca1 G\u1ee3i \u00fd m\u1edf r\u1ed9ng t\u01b0\u01a1ng lai","text":"<ul> <li>Tr\u00edch xu\u1ea5t fingerprint ho\u1eb7c session hash \u0111\u1ec3 x\u00e1c \u0111\u1ecbnh danh t\u00ednh thi\u1ebft b\u1ecb</li> <li>Li\u00ean k\u1ebft v\u1edbi alert system khi \u0111\u0103ng nh\u1eadp t\u1eeb IP blacklist ho\u1eb7c b\u1ecb nghi ng\u1edd</li> </ul> <pre><code>{\n  \"user_agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64)\",\n  \"ip_address\": \"203.113.135.42\",\n  \"device_type\": \"web\",\n  \"location\": \"Ha Noi, VN\",\n  \"login_context\": {\n    \"app_version\": \"1.2.3\",\n    \"mfa_completed\": true\n  }\n}\n</code></pre> <p>\u2705 Vi\u1ec7c l\u01b0u metadata ch\u00ednh x\u00e1c v\u00e0 b\u1ea3o v\u1ec7 \u0111\u00fang m\u1ee9c s\u1ebd gi\u00fap h\u1ec7 th\u1ed1ng <code>auth-service/sub</code> v\u1eeba an to\u00e0n, v\u1eeba gi\u00e0u kh\u1ea3 n\u0103ng quan s\u00e1t m\u00e0 kh\u00f4ng vi ph\u1ea1m quy\u1ec1n ri\u00eang t\u01b0 ng\u01b0\u1eddi d\u00f9ng.</p>"},{"location":"services/auth-service/sub/data-model/#6-enums-constants","title":"6. \ud83e\uddfe ENUMs &amp; Constants","text":"<p>C\u00e1c gi\u00e1 tr\u1ecb ENUM gi\u00fap chu\u1ea9n h\u00f3a v\u00e0 gi\u1edbi h\u1ea1n ph\u1ea1m vi \u0111\u1ea7u v\u00e0o h\u1ee3p l\u1ec7 trong qu\u00e1 tr\u00ecnh x\u00e1c th\u1ef1c, \u0111\u1ed3ng th\u1eddi h\u1ed7 tr\u1ee3 hi\u1ec3n th\u1ecb tr\u1ea1ng th\u00e1i r\u00f5 r\u00e0ng trong h\u1ec7 th\u1ed1ng qu\u1ea3n tr\u1ecb ho\u1eb7c giao di\u1ec7n frontend.</p>"},{"location":"services/auth-service/sub/data-model/#61-auth_method","title":"6.1. \ud83d\udccc <code>auth_method</code>","text":"<p>X\u00e1c \u0111\u1ecbnh ph\u01b0\u01a1ng th\u1ee9c x\u00e1c th\u1ef1c m\u00e0 ng\u01b0\u1eddi d\u00f9ng s\u1eed d\u1ee5ng \u0111\u1ec3 \u0111\u0103ng nh\u1eadp.</p> Gi\u00e1 tr\u1ecb \u00dd ngh\u0129a <code>otp</code> X\u00e1c th\u1ef1c qua m\u00e3 OTP g\u1eedi SMS/email <code>local</code> X\u00e1c th\u1ef1c b\u1eb1ng username/password n\u1ed9i b\u1ed9 <p>\ud83d\udccc S\u1eed d\u1ee5ng trong: b\u1ea3ng <code>auth_sessions</code>, OpenAPI schema <code>LoginRequest</code>.</p>"},{"location":"services/auth-service/sub/data-model/#62-device_type","title":"6.2. \ud83d\udccc <code>device_type</code>","text":"<p>Ph\u00e2n lo\u1ea1i thi\u1ebft b\u1ecb t\u1eeb frontend gi\u00fap ph\u00e2n t\u00edch h\u00e0nh vi v\u00e0 ph\u00e1t hi\u1ec7n \u0111\u0103ng nh\u1eadp b\u1ea5t th\u01b0\u1eddng.</p> Gi\u00e1 tr\u1ecb \u00dd ngh\u0129a <code>web</code> Tr\u00ecnh duy\u1ec7t desktop ho\u1eb7c tr\u00ecnh duy\u1ec7t mobile <code>mobile</code> \u1ee8ng d\u1ee5ng mobile native <code>tablet</code> Thi\u1ebft b\u1ecb tablet (iPad, Android tablet\u2026) <code>kiosk</code> Thi\u1ebft b\u1ecb truy c\u1eadp c\u1ed1 \u0111\u1ecbnh (m\u00e1y \u0111i\u1ec3m danh\u2026) <code>unknown</code> Kh\u00f4ng x\u00e1c \u0111\u1ecbnh \u0111\u01b0\u1ee3c <p>\ud83d\udccc S\u1eed d\u1ee5ng trong: <code>auth_sessions.device_type</code></p>"},{"location":"services/auth-service/sub/data-model/#63-session_status","title":"6.3. \ud83d\udccc <code>session_status</code>","text":"<p>D\u00f9ng n\u1ed9i b\u1ed9 \u0111\u1ec3 hi\u1ec3n th\u1ecb tr\u1ea1ng th\u00e1i phi\u00ean \u0111\u0103ng nh\u1eadp trong giao di\u1ec7n admin.</p> Gi\u00e1 tr\u1ecb \u00dd ngh\u0129a <code>active</code> Phi\u00ean \u0111ang ho\u1ea1t \u0111\u1ed9ng b\u00ecnh th\u01b0\u1eddng <code>revoked</code> \u0110\u00e3 b\u1ecb thu h\u1ed3i th\u1ee7 c\u00f4ng <code>expired</code> H\u1ebft h\u1ea1n t\u1ef1 \u0111\u1ed9ng <code>locked</code> B\u1ecb kh\u00f3a b\u1edfi qu\u1ea3n tr\u1ecb vi\u00ean ho\u1eb7c h\u1ec7 th\u1ed1ng <p>\ud83d\udccc Kh\u00f4ng \u1ea3nh h\u01b0\u1edfng t\u1edbi x\u00e1c th\u1ef1c token \u2013 token validity \u0111\u01b0\u1ee3c ki\u1ec3m tra ri\u00eang.</p>"},{"location":"services/auth-service/sub/data-model/#64-errorcode","title":"6.4. \ud83d\udccc <code>error.code</code>","text":"<p>Theo chu\u1ea9n <code>adr-011</code>, m\u1ecdi response l\u1ed7i \u0111\u1ec1u bao g\u1ed3m <code>error.code</code> d\u1ea1ng \u0111\u1ecbnh danh ng\u1eafn, gi\u00fap frontend ho\u1eb7c h\u1ec7 th\u1ed1ng qu\u1ea3n tr\u1ecb hi\u1ec3n th\u1ecb v\u00e0 x\u1eed l\u00fd d\u1ec5 d\u00e0ng h\u01a1n.</p> Code M\u00f4 t\u1ea3 HTTP <code>auth.invalid_credentials</code> Sai t\u00ean \u0111\u0103ng nh\u1eadp ho\u1eb7c m\u1eadt kh\u1ea9u 401 <code>auth.otp.expired</code> M\u00e3 OTP \u0111\u00e3 h\u1ebft h\u1ea1n 400 <code>auth.otp.invalid</code> M\u00e3 OTP kh\u00f4ng ch\u00ednh x\u00e1c 400 <code>auth.session.revoked</code> Phi\u00ean \u0111\u00e3 b\u1ecb thu h\u1ed3i 403 <code>auth.token.reuse_detected</code> Refresh token b\u1ecb s\u1eed d\u1ee5ng l\u1ea1i 401 <code>auth.rate_limited</code> G\u1eedi OTP qu\u00e1 nhi\u1ec1u l\u1ea7n 429 <p>\ud83d\udccc T\u1ea5t c\u1ea3 m\u00e3 l\u1ed7i ph\u1ea3i n\u1eb1m trong danh s\u00e1ch \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a tr\u01b0\u1edbc (xem th\u00eam <code>error-codes.md</code>).</p>"},{"location":"services/auth-service/sub/data-model/#goi-y-mo-rong","title":"\ud83e\udde9 G\u1ee3i \u00fd m\u1edf r\u1ed9ng","text":"<ul> <li>C\u00e1c enum n\u00ean \u0111\u01b0\u1ee3c central h\u00f3a trong file <code>schemas/constants.py</code> (Python), <code>constants.ts</code> (TypeScript), ho\u1eb7c \u0111\u1eb7t trong schema validator (OpenAPI/JSON Schema)</li> <li>H\u1ed7 tr\u1ee3 t\u1ef1 \u0111\u1ed9ng sinh document v\u00e0 ki\u1ec3m th\u1eed d\u1ef1a tr\u00ean enum list (contract testing)</li> </ul>"},{"location":"services/auth-service/sub/data-model/#7-data-access-control-rbac","title":"7. \ud83d\udd10 Data Access Control (RBAC)","text":"<p>T\u1ea5t c\u1ea3 d\u1eef li\u1ec7u trong <code>auth-service/sub</code> \u0111\u1ec1u \u0111\u01b0\u1ee3c b\u1ea3o v\u1ec7 b\u1edfi c\u01a1 ch\u1ebf Role-Based Access Control (RBAC) \u0111\u1ed9ng, v\u1edbi \u0111i\u1ec1u ki\u1ec7n (<code>x-condition</code>) \u0111\u01b0\u1ee3c ki\u1ec3m tra t\u1ea1i <code>api-gateway</code> ho\u1eb7c middleware RBAC tr\u01b0\u1edbc khi request \u0111\u1ebfn \u0111\u01b0\u1ee3c service.</p>"},{"location":"services/auth-service/sub/data-model/#71-chinh-sach-rbac-ap-dung","title":"7.1. \ud83e\udde9 Ch\u00ednh s\u00e1ch RBAC \u00e1p d\u1ee5ng","text":"H\u00e0nh \u0111\u1ed9ng Permission Ghi ch\u00fa Xem phi\u00ean c\u1ee7a ch\u00ednh m\u00ecnh <code>session.read:self</code> Cho ph\u00e9p user xem l\u1ecbch s\u1eed login c\u1ee7a ch\u00ednh h\u1ecd Admin xem to\u00e0n b\u1ed9 session <code>session.read:any</code> D\u00e0nh cho qu\u1ea3n tr\u1ecb vi\u00ean n\u1ed9i b\u1ed9 (per-tenant) Thu h\u1ed3i phi\u00ean <code>session.revoke:any</code> Th\u01b0\u1eddng d\u00f9ng cho giao di\u1ec7n qu\u1ea3n l\u00fd ho\u1eb7c b\u1ea3o m\u1eadt Li\u1ec7t k\u00ea phi\u00ean theo user <code>session.list:any</code> L\u1ecdc theo <code>user_id</code> \u2013 c\u1ea7n admin quy\u1ec1n cao h\u01a1n"},{"location":"services/auth-service/sub/data-model/#72-kiem-tra-ieu-kien-x-condition","title":"7.2. \ud83d\udccc Ki\u1ec3m tra \u0111i\u1ec1u ki\u1ec7n (<code>x-condition</code>)","text":"<p>Vi\u1ec7c c\u1ea5p quy\u1ec1n kh\u00f4ng ch\u1ec9 ph\u1ee5 thu\u1ed9c v\u00e0o permission string m\u00e0 c\u00f2n ph\u1ee5 thu\u1ed9c v\u00e0o \u0111i\u1ec1u ki\u1ec7n k\u00e8m theo nh\u01b0 sau:</p> Tr\u01b0\u1eddng \u00dd ngh\u0129a V\u00ed d\u1ee5 <code>user_id = {{current_user.id}}</code> Ch\u1ec9 xem \u0111\u01b0\u1ee3c d\u1eef li\u1ec7u c\u1ee7a ch\u00ednh m\u00ecnh <code>session.read:self</code> <code>tenant_id = {{X-Tenant-ID}}</code> Gi\u1edbi h\u1ea1n trong tenant hi\u1ec7n h\u00e0nh \u00c1p d\u1ee5ng cho m\u1ecdi quy\u1ec1n admin <code>ip_address LIKE \"10.%\"</code> (Advanced) Filter theo v\u00f9ng m\u1ea1ng n\u1ed9i b\u1ed9 Kh\u00f4ng \u00e1p d\u1ee5ng m\u1eb7c \u0111\u1ecbnh <p>\ud83d\udccc C\u00e1c <code>x-condition</code> \u0111\u01b0\u1ee3c m\u00f4 t\u1ea3 r\u00f5 trong <code>interface-contract.md</code> \u1edf ph\u1ea7n <code>x-condition</code> v\u00e0 \u0111\u01b0\u1ee3c enforced t\u1ea1i <code>api-gateway</code>.</p>"},{"location":"services/auth-service/sub/data-model/#73-ap-dung-vao-mo-hinh-du-lieu","title":"7.3. \ud83d\udd12 \u00c1p d\u1ee5ng v\u00e0o m\u00f4 h\u00ecnh d\u1eef li\u1ec7u","text":"B\u1ea3ng Quy\u1ec1n \u0111\u1ecdc Quy\u1ec1n ghi Tr\u01b0\u1eddng nh\u1ea1y c\u1ea3m <code>auth_sessions</code> <code>session.read</code> Kh\u00f4ng cho s\u1eeda <code>ip_address</code>, <code>user_agent</code>, <code>location</code> <code>revoked_tokens</code> (cache) Kh\u00f4ng cho \u0111\u1ecdc Ch\u1ec9 <code>auth-sub</code> c\u00f3 th\u1ec3 ghi <code>session_id</code>, <code>reason</code> <p>T\u1ea5t c\u1ea3 truy c\u1eadp tr\u1ef1c ti\u1ebfp v\u00e0o b\u1ea3ng c\u1ea7n \u0111i qua l\u1edbp RBAC filter (ho\u1eb7c \u0111\u01b0\u1ee3c ki\u1ec3m tra tr\u01b0\u1edbc \u1edf gateway).</p>"},{"location":"services/auth-service/sub/data-model/#74-best-practices","title":"7.4. \ud83e\udde0 Best Practices","text":"<ul> <li>Kh\u00f4ng tr\u1ea3 session ng\u01b0\u1eddi kh\u00e1c k\u1ec3 c\u1ea3 admin n\u1ebfu ch\u01b0a ki\u1ec3m RBAC k\u1ef9</li> <li>D\u00f9ng <code>x-condition</code> tr\u00ean c\u1ea3 tenant v\u00e0 user scope \u0111\u1ec3 gi\u1ea3m r\u1ee7i ro r\u00f2 r\u1ec9 ch\u00e9o tenant</li> <li>M\u1ecdi s\u1ef1 ki\u1ec7n \u0111\u1ecdc/ghi nh\u1ea1y c\u1ea3m n\u00ean \u0111\u01b0\u1ee3c ghi v\u00e0o audit log k\u00e8m <code>actor_id</code>, <code>trace_id</code></li> </ul> <p>\ud83d\udccc V\u00ed d\u1ee5:</p> <pre><code>\"x-permissions\": [\"session.read:self\"],\n\"x-condition\": {\n  \"user_id\": \"{{current_user.id}}\",\n  \"tenant_id\": \"{{X-Tenant-ID}}\"\n}\n</code></pre> <p>\u2705 H\u1ec7 th\u1ed1ng RBAC \u0111\u1ed9ng nh\u01b0 v\u1eady \u0111\u1ea3m b\u1ea3o kh\u1ea3 n\u0103ng ki\u1ec3m so\u00e1t tinh vi nh\u01b0ng v\u1eabn linh ho\u1ea1t \u0111\u1ec3 m\u1edf r\u1ed9ng, \u0111\u1eb7c bi\u1ec7t quan tr\u1ecdng trong h\u1ec7 th\u1ed1ng multi-tenant nh\u01b0 <code>dx-vas</code>.</p>"},{"location":"services/auth-service/sub/data-model/#8-data-lifecycle-retention-policy","title":"8. \ud83d\udd52 Data Lifecycle &amp; Retention Policy","text":"<p>M\u1ecdi d\u1eef li\u1ec7u li\u00ean quan \u0111\u1ebfn x\u00e1c th\u1ef1c trong <code>auth-service/sub</code> \u0111\u1ec1u \u0111\u01b0\u1ee3c g\u1eafn li\u1ec1n v\u1edbi v\u00f2ng \u0111\u1eddi x\u00e1c \u0111\u1ecbnh r\u00f5 r\u00e0ng v\u00e0 ch\u00ednh s\u00e1ch x\u1eed l\u00fd d\u1eef li\u1ec7u sau khi h\u1ebft h\u1ea1n. \u0110i\u1ec1u n\u00e0y \u0111\u1ea3m b\u1ea3o h\u1ec7 th\u1ed1ng v\u1eeba tu\u00e2n th\u1ee7 c\u00e1c quy \u0111\u1ecbnh b\u1ea3o m\u1eadt (nh\u01b0 GDPR), v\u1eeba t\u1ed1i \u01b0u chi ph\u00ed l\u01b0u tr\u1eef v\u00e0 hi\u1ec7u n\u0103ng.</p>"},{"location":"services/auth-service/sub/data-model/#81-retention-policy-theo-loai-du-lieu","title":"8.1. \u267b\ufe0f Retention Policy theo lo\u1ea1i d\u1eef li\u1ec7u","text":"Lo\u1ea1i d\u1eef li\u1ec7u B\u1ea3ng TTL \u0111\u1ec1 xu\u1ea5t H\u00e0nh \u0111\u1ed9ng sau TTL Phi\u00ean \u0111\u0103ng nh\u1eadp (<code>auth_sessions</code>) PostgreSQL 180 ng\u00e0y \u1ea8n ho\u1eb7c x\u00f3a d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m (<code>anonymize</code>) Token thu h\u1ed3i (<code>revoked_tokens</code>) Redis TTL = th\u1eddi gian s\u1ed1ng token T\u1ef1 \u0111\u1ed9ng xo\u00e1 khi h\u1ebft TTL Audit Log (<code>auth.token.*</code>) Pub/Sub / log \u2265 365 ng\u00e0y L\u01b0u tr\u1eef d\u00e0i h\u1ea1n theo c\u1ea5u h\u00ecnh h\u1ec7 th\u1ed1ng <p>\ud83d\udccc L\u01b0u \u00fd: TTL th\u1ef1c t\u1ebf c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh theo tenant-level policy ho\u1eb7c quy \u0111\u1ecbnh h\u1ec7 th\u1ed1ng.</p>"},{"location":"services/auth-service/sub/data-model/#82-anonymization-theo-adr-024","title":"8.2. \ud83d\udd10 Anonymization theo <code>adr-024</code>","text":"<p>D\u1eef li\u1ec7u sau khi h\u1ebft TTL s\u1ebd \u0111\u01b0\u1ee3c \u1ea9n m\u1ed9t ph\u1ea7n (mask) ho\u1eb7c \u1ea9n to\u00e0n b\u1ed9 nh\u01b0 sau:</p> Tr\u01b0\u1eddng Chi\u1ebfn l\u01b0\u1ee3c anonymize <code>ip_address</code> Xo\u00e1 ho\u1eb7c hash m\u1ed9t chi\u1ec1u (<code>anonymize(ip)</code>) <code>user_agent</code> Xo\u00e1 ho\u1eb7c r\u00fat g\u1ecdn (<code>browser:Chrome</code>, <code>device:Mobile</code>) <code>location</code> Xo\u00e1 ho\u1eb7c gi\u1ea3m \u0111\u1ed9 ch\u00ednh x\u00e1c (ch\u1ec9 gi\u1eef country code) <code>revoked_reason</code> Optional: c\u00f3 th\u1ec3 gi\u1eef ho\u1eb7c c\u1eaft b\u1ecf tu\u1ef3 c\u1ea5u h\u00ecnh <p>\ud83d\udccc M\u1ed9t job n\u1ec1n (<code>retention_worker</code>) s\u1ebd th\u1ef1c hi\u1ec7n xo\u00e1 ho\u1eb7c l\u00e0m m\u1edd \u0111\u1ecbnh k\u1ef3.</p>"},{"location":"services/auth-service/sub/data-model/#83-chinh-sach-xoa-cung-hard-delete","title":"8.3. \ud83d\udd25 Ch\u00ednh s\u00e1ch x\u00f3a c\u1ee9ng (Hard Delete)","text":"<p>Theo <code>adr-026</code>, h\u1ec7 th\u1ed1ng kh\u00f4ng cho ph\u00e9p x\u00f3a b\u1ea3n ghi session th\u1ee7 c\u00f4ng t\u1eeb API. Xo\u00e1 c\u1ee9ng ch\u1ec9 \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n:</p> <ul> <li>T\u1ef1 \u0111\u1ed9ng khi \u0111\u1ea1t TTL</li> <li>Qua job batch \u0111\u1ecbnh k\u1ef3 c\u00f3 ki\u1ec3m so\u00e1t (background cron job)</li> <li>Kh\u00f4ng cho ph\u00e9p x\u00f3a b\u1ea3n ghi ri\u00eang l\u1ebb t\u1eeb ph\u00eda ng\u01b0\u1eddi d\u00f9ng</li> </ul>"},{"location":"services/auth-service/sub/data-model/#84-goi-y-van-hanh","title":"8.4. \ud83e\udde0 G\u1ee3i \u00fd v\u1eadn h\u00e0nh","text":"<ul> <li>N\u00ean l\u01b0u phi\u00ean b\u1ea3n \u0111\u00e3 anonymize l\u00e2u h\u01a1n (v\u00ed d\u1ee5: gi\u1eef 12 th\u00e1ng thay v\u00ec 6 n\u1ebfu \u0111\u00e3 xo\u00e1 nh\u1ea1y c\u1ea3m)</li> <li>Cho ph\u00e9p admin xem d\u1eef li\u1ec7u anonymized \u0111\u1ec3 ph\u1ee5c v\u1ee5 ph\u00e2n t\u00edch, th\u1ed1ng k\u00ea</li> <li>V\u1edbi tenant VIP c\u00f3 y\u00eau c\u1ea7u l\u01b0u l\u00e2u h\u01a1n, c\u00f3 th\u1ec3 c\u1ea5u h\u00ecnh TTL ri\u00eang (c\u1ea7n m\u1edf r\u1ed9ng job)</li> </ul>"},{"location":"services/auth-service/sub/data-model/#85-vi-du-bieu-o-lifecycle","title":"8.5. V\u00ed d\u1ee5 bi\u1ec3u \u0111\u1ed3 lifecycle","text":"<pre><code>graph LR\n  login[Phi\u00ean \u0111\u0103ng nh\u1eadp th\u00e0nh c\u00f4ng] --&gt; alive[Trong 180 ng\u00e0y]\n  alive --&gt; anonymized[\u0110\u01b0\u1ee3c l\u00e0m m\u1edd d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m]\n  anonymized --&gt; expired[Xo\u00e1 kh\u1ecfi DB sau 12 th\u00e1ng]\n</code></pre> <p>\u2705 Ch\u00ednh s\u00e1ch v\u00f2ng \u0111\u1eddi r\u00f5 r\u00e0ng gi\u00fap h\u1ec7 th\u1ed1ng v\u1eeba ti\u1ebft ki\u1ec7m t\u00e0i nguy\u00ean, v\u1eeba \u0111\u1ea3m b\u1ea3o quy\u1ec1n ri\u00eang t\u01b0 v\u00e0 ki\u1ec3m so\u00e1t d\u1eef li\u1ec7u t\u1ed1t theo ti\u00eau chu\u1ea9n cao nh\u1ea5t.</p>"},{"location":"services/auth-service/sub/data-model/#9-migration-schema-evolution","title":"9. \ud83d\udd01 Migration &amp; Schema Evolution","text":"<p>Vi\u1ec7c ph\u00e1t tri\u1ec3n l\u00e2u d\u00e0i c\u1ee7a <code>auth-service/sub</code> y\u00eau c\u1ea7u kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng v\u00e0 c\u1eadp nh\u1eadt schema d\u1eef li\u1ec7u m\u1ed9t c\u00e1ch an to\u00e0n, kh\u00f4ng gi\u00e1n \u0111o\u1ea1n, v\u00e0 t\u01b0\u01a1ng th\u00edch v\u1edbi c\u00e1c tenant \u0111ang ho\u1ea1t \u0111\u1ed9ng. T\u00e0i li\u1ec7u n\u00e0y \u0111\u1ecbnh ngh\u0129a chi\u1ebfn l\u01b0\u1ee3c migration nh\u1ea5t qu\u00e1n theo ADR-023.</p>"},{"location":"services/auth-service/sub/data-model/#91-tuan-theo-mo-hinh-3-phase-migration","title":"9.1. \ud83d\udcd8 Tu\u00e2n theo m\u00f4 h\u00ecnh 3-phase migration","text":"<p>M\u1ecdi thay \u0111\u1ed5i v\u1ec1 schema (th\u00eam/s\u1eeda/x\u00f3a c\u1ed9t, index\u2026) ph\u1ea3i tu\u00e2n th\u1ee7 m\u00f4 h\u00ecnh migration an to\u00e0n:</p> Giai \u0111o\u1ea1n M\u00f4 t\u1ea3 Ghi ch\u00fa Phase 1: Expand Th\u00eam c\u1ed9t m\u1edbi (nullable), th\u00eam b\u1ea3ng, th\u00eam index Kh\u00f4ng \u1ea3nh h\u01b0\u1edfng production Phase 2: Migrate Vi\u1ebft d\u1eef li\u1ec7u c\u0169 sang format m\u1edbi, update logic backend Ph\u1ea3i gi\u1eef song song format c\u0169 &amp; m\u1edbi Phase 3: Contract X\u00f3a c\u1ed9t/b\u1ea3ng/index c\u0169 sau khi kh\u00f4ng c\u00f2n s\u1eed d\u1ee5ng Lu\u00f4n c\u00f3 buffer \u00edt nh\u1ea5t 1-2 tu\u1ea7n <p>\ud83d\udccc Kh\u00f4ng bao gi\u1edd combine DROP &amp; ADD trong c\u00f9ng m\u1ed9t migration n\u1ebfu \u0111ang ch\u1ea1y tr\u00ean nhi\u1ec1u tenant.</p>"},{"location":"services/auth-service/sub/data-model/#92-cong-cu-best-practices","title":"9.2. \ud83e\uddf1 C\u00f4ng c\u1ee5 &amp; best practices","text":"Y\u1ebfu t\u1ed1 Khuy\u1ebfn ngh\u1ecb Migration tool S\u1eed d\u1ee5ng Alembic (Python) ho\u1eb7c Liquibase (SQL) Version h\u00f3a M\u1ed7i schema change g\u1eafn version ri\u00eang (<code>v2.1_add_revoked_reason</code>) Tenant isolation Migration ph\u1ea3i ch\u1ea1y ri\u00eang cho t\u1eebng tenant Idempotent M\u1ecdi script c\u00f3 th\u1ec3 ch\u1ea1y l\u1ea1i m\u00e0 kh\u00f4ng g\u00e2y l\u1ed7i"},{"location":"services/auth-service/sub/data-model/#93-kiem-thu-migration","title":"9.3. \ud83d\udea7 Ki\u1ec3m th\u1eed migration","text":"<p>M\u1ed7i thay \u0111\u1ed5i ph\u1ea3i k\u00e8m checklist ki\u1ec3m th\u1eed:</p> <ul> <li>\u2705 Unit test v\u1edbi schema m\u1edbi</li> <li>\u2705 Ch\u1ea1y migration test tr\u00ean sandbox v\u1edbi d\u1eef li\u1ec7u th\u1eadt (m\u1ed9t s\u1ed1 tenant)</li> <li>\u2705 Snapshot schema tr\u01b0\u1edbc &amp; sau \u0111\u1ec3 ki\u1ec3m tra diff</li> <li>\u2705 So kh\u1edbp rollback (n\u1ebfu c\u00f3) ho\u1eb7c backup tr\u01b0\u1edbc khi deploy</li> </ul> <p>\ud83d\udccc C\u00e1c test n\u00ean \u0111\u01b0\u1ee3c m\u00f4 t\u1ea3 c\u1ee5 th\u1ec3 t\u1ea1i <code>docs/tests/db-migration/</code></p>"},{"location":"services/auth-service/sub/data-model/#94-multi-tenant-considerations","title":"9.4. \ud83d\udee0 Multi-Tenant Considerations","text":"T\u00ecnh hu\u1ed1ng C\u00e1ch x\u1eed l\u00fd Tenant m\u1edbi t\u1ea1o \u00c1p d\u1ee5ng schema m\u1edbi ngay l\u1eadp t\u1ee9c Tenant \u0111ang active D\u00f9ng background worker migration ch\u1ea1y d\u1ea7n L\u1ed7i khi migrate Rollback t\u1eebng tenant, kh\u00f4ng rollback to\u00e0n h\u1ec7 th\u1ed1ng"},{"location":"services/auth-service/sub/data-model/#95-goi-y-mo-rong","title":"9.5. \ud83e\udde0 G\u1ee3i \u00fd m\u1edf r\u1ed9ng","text":"<ul> <li>\u00c1p d\u1ee5ng flag <code>db_version</code> theo tenant \u0111\u1ec3 ki\u1ec3m so\u00e1t tr\u1ea1ng th\u00e1i migration</li> <li>X\u00e2y d\u1ef1ng dashboard theo d\u00f5i migration status per tenant</li> <li>D\u00f9ng canary tenant \u0111\u1ec3 test tr\u01b0\u1edbc v\u1edbi schema m\u1edbi</li> </ul> <p>\u2705 V\u1edbi chi\u1ebfn l\u01b0\u1ee3c migration b\u00e0i b\u1ea3n nh\u01b0 tr\u00ean, h\u1ec7 th\u1ed1ng <code>auth-service/sub</code> c\u00f3 th\u1ec3 m\u1edf r\u1ed9ng v\u00e0 n\u00e2ng c\u1ea5p li\u00ean t\u1ee5c m\u00e0 kh\u00f4ng g\u00e2y downtime hay m\u1ea5t d\u1eef li\u1ec7u \u2013 \u0111\u00fang \u0111\u1ecbnh h\u01b0\u1edbng zero-downtime c\u1ee7a to\u00e0n ki\u1ebfn tr\u00fac <code>dx-vas</code>.</p>"},{"location":"services/auth-service/sub/data-model/#10-kiem-thu-lien-quan-du-lieu","title":"10. \u2705 Ki\u1ec3m th\u1eed li\u00ean quan d\u1eef li\u1ec7u","text":"<p>Vi\u1ec7c ki\u1ec3m th\u1eed to\u00e0n di\u1ec7n m\u00f4 h\u00ecnh d\u1eef li\u1ec7u l\u00e0 y\u1ebfu t\u1ed1 b\u1eaft bu\u1ed9c \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o \u0111\u1ed9 \u1ed5n \u0111\u1ecbnh, t\u00ednh \u0111\u00fang \u0111\u1eafn v\u00e0 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng c\u1ee7a <code>auth-service/sub</code>. M\u1ee5c ti\u00eau l\u00e0 \u0111\u1ea3m b\u1ea3o m\u1ecdi thay \u0111\u1ed5i \u0111\u1ec1u \u0111\u01b0\u1ee3c ki\u1ec3m so\u00e1t v\u00e0 ph\u1ea3n \u00e1nh ch\u00ednh x\u00e1c qua c\u1ea3 schema, API v\u00e0 h\u00e0nh vi runtime.</p>"},{"location":"services/auth-service/sub/data-model/#101-unit-tests-database-layer","title":"10.1. \ud83e\uddea Unit Tests (Database Layer)","text":"Th\u00e0nh ph\u1ea7n Ki\u1ec3m th\u1eed Models (<code>auth_sessions</code>) T\u1ea1o, \u0111\u1ecdc, l\u1ecdc, s\u1eafp x\u1ebfp, c\u1eadp nh\u1eadt tr\u1ea1ng th\u00e1i Constraints Vi ph\u1ea1m <code>CHECK</code>, <code>NOT NULL</code>, <code>FK</code> ph\u1ea3i raise l\u1ed7i \u0111\u00fang Enum Ch\u1ec9 nh\u1eadn gi\u00e1 tr\u1ecb n\u1eb1m trong danh s\u00e1ch h\u1ee3p l\u1ec7 Index hi\u1ec7u qu\u1ea3 Ki\u1ec3m th\u1eed t\u1ed1c \u0111\u1ed9 truy v\u1ea5n theo <code>user_id</code>, <code>tenant_id</code>"},{"location":"services/auth-service/sub/data-model/#102-integration-tests-service-logic-db","title":"10.2. \ud83d\udd01 Integration Tests (Service Logic + DB)","text":"Lu\u1ed3ng nghi\u1ec7p v\u1ee5 Ki\u1ec3m th\u1eed \u0110\u0103ng nh\u1eadp th\u00e0nh c\u00f4ng T\u1ea1o <code>auth_session</code>, g\u00e1n metadata \u0111\u00fang Logout C\u1eadp nh\u1eadt <code>revoked_at</code>, ghi v\u00e0o Redis \u0111\u00fang TTL Token reuse Ghi log revoke, ki\u1ec3m tra Redis key <code>revoked:&lt;jti&gt;</code> Audit log G\u1eedi \u0111\u00fang s\u1ef1 ki\u1ec7n <code>auth.token.issued</code>, <code>auth.token.revoked</code> k\u00e8m metadata <p>\ud83d\udccc C\u1ea7n c\u00f3 pre-seeded data test tr\u00ean DB test ri\u00eang bi\u1ec7t cho c\u00e1c tenant gi\u1ea3 l\u1eadp.</p>"},{"location":"services/auth-service/sub/data-model/#103-security-access-control-tests","title":"10.3. \ud83d\udd10 Security &amp; Access Control Tests","text":"Ki\u1ec3m th\u1eed M\u1ee5c ti\u00eau <code>session.read:self</code> vs <code>any</code> \u0110\u1ea3m b\u1ea3o kh\u00f4ng l\u1ed9 d\u1eef li\u1ec7u tenant kh\u00e1c Bypass RBAC G\u1eedi request thi\u1ebfu <code>x-condition</code> \u2192 b\u1ecb t\u1eeb ch\u1ed1i Data masking Test endpoint khi tr\u1ea3 v\u1ec1 session b\u1ecb <code>anonymize</code> Rate limit OTP Test ghi log session kh\u00f4ng b\u1ecb abuse / log qu\u00e1 nhi\u1ec1u"},{"location":"services/auth-service/sub/data-model/#104-contract-testing-schema-api","title":"10.4. \ud83e\uddfe Contract Testing (Schema &amp; API)","text":"<p>Theo <code>adr-010</code>, to\u00e0n b\u1ed9 schema v\u00e0 API ph\u1ea3i \u0111\u01b0\u1ee3c ki\u1ec3m th\u1eed b\u1eb1ng:</p> <ul> <li>\u2705 JSON Schema validation (OpenAPI \u2192 Test Generator)</li> <li>\u2705 <code>revoked_tokens</code> format \u0111\u00fang key prefix &amp; value</li> <li>\u2705 C\u00e1c response lu\u00f4n theo chu\u1ea9n <code>ErrorEnvelope</code>, <code>ResponseMeta</code></li> </ul> <p>\ud83d\udccc Test s\u1eed d\u1ee5ng tool nh\u01b0 <code>Dredd</code>, <code>Schemathesis</code>, ho\u1eb7c t\u00edch h\u1ee3p Postman/Newman n\u1ebfu c\u1ea7n.</p>"},{"location":"services/auth-service/sub/data-model/#105-migration-data-retention-tests","title":"10.5. \ud83e\uddea Migration &amp; Data Retention Tests","text":"Ki\u1ec3m th\u1eed M\u00f4 t\u1ea3 Migration <code>auth_sessions</code> Schema m\u1edbi kh\u00f4ng \u1ea3nh h\u01b0\u1edfng d\u1eef li\u1ec7u c\u0169 TTL Redis Redis xo\u00e1 <code>revoked:&lt;jti&gt;</code> \u0111\u00fang th\u1eddi \u0111i\u1ec3m Anonymize job Mask <code>ip</code>, <code>location</code>, <code>user_agent</code> sau TTL Rollback safe Backup + restore n\u1ebfu migration l\u1ed7i \u1edf 1 tenant <p>\u2705 T\u1ea5t c\u1ea3 c\u00e1c test \u0111\u1ec1u ph\u1ea3i \u0111\u01b0\u1ee3c t\u00edch h\u1ee3p CI/CD (GitHub Actions ho\u1eb7c GitLab CI), ch\u1ea1y t\u1ef1 \u0111\u1ed9ng theo PR v\u00e0 giai \u0111o\u1ea1n release, gi\u00fap \u0111\u1ea3m b\u1ea3o kh\u00f4ng ai c\u00f3 th\u1ec3 merge m\u00e0 kh\u00f4ng qua ki\u1ec3m th\u1eed d\u1eef li\u1ec7u \u0111\u1ea7y \u0111\u1ee7.</p>"},{"location":"services/auth-service/sub/data-model/#11-tai-lieu-lien-quan","title":"11. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Interface Contract</li> <li>OpenAPI Spec</li> <li>Design</li> <li>ADR-004 - Security</li> <li>ADR-012 - Response Structure</li> <li>ADR-030 - Event Schema Governance</li> </ul>"},{"location":"services/auth-service/sub/design/","title":"\ud83d\udcd8 Thi\u1ebft k\u1ebf chi ti\u1ebft Auth Service - Sub","text":""},{"location":"services/auth-service/sub/design/#1-pham-vi-va-trach-nhiem","title":"1. \ud83e\udded Ph\u1ea1m vi v\u00e0 Tr\u00e1ch nhi\u1ec7m","text":"<p><code>auth-service/sub</code> l\u00e0 d\u1ecbch v\u1ee5 x\u00e1c th\u1ef1c \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf theo m\u00f4 h\u00ecnh per-tenant deployment, ph\u1ee5c v\u1ee5 ri\u00eang bi\u1ec7t cho t\u1eebng tenant (tr\u01b0\u1eddng h\u1ecdc) trong h\u1ec7 th\u1ed1ng <code>dx-vas</code>. M\u1ed7i tenant c\u00f3 m\u1ed9t instance ri\u00eang, \u0111\u1ed9c l\u1eadp v\u1ec1 c\u01a1 s\u1edf d\u1eef li\u1ec7u, c\u1ea5u h\u00ecnh, v\u00e0 lifecycle v\u1eadn h\u00e0nh.</p> <p>D\u1ecbch v\u1ee5 n\u00e0y \u0111\u1ea3m nhi\u1ec7m x\u00e1c th\u1ef1c \u0111\u1ea7u v\u00e0o cho ng\u01b0\u1eddi d\u00f9ng cu\u1ed1i (student, teacher, employee) thu\u1ed9c tenant t\u01b0\u01a1ng \u1ee9ng, th\u00f4ng qua c\u00e1c ph\u01b0\u01a1ng th\u1ee9c OTP v\u00e0 Local Login.</p>"},{"location":"services/auth-service/sub/design/#chuc-nang-chinh","title":"\u2705 Ch\u1ee9c n\u0103ng ch\u00ednh","text":"Nh\u00f3m ch\u1ee9c n\u0103ng M\u00f4 t\u1ea3 X\u00e1c th\u1ef1c OTP G\u1eedi v\u00e0 x\u00e1c minh m\u00e3 OTP qua SMS/email X\u00e1c th\u1ef1c Local \u0110\u0103ng nh\u1eadp b\u1eb1ng username/password \u0111\u00e3 m\u00e3 h\u00f3a Kh\u1edfi t\u1ea1o phi\u00ean G\u1ecdi <code>token-service</code> \u0111\u1ec3 c\u1ea5p JWT; l\u01b0u <code>auth_sessions</code> Logout G\u1ecdi <code>token-service</code> thu h\u1ed3i token; c\u1eadp nh\u1eadt Redis \u0110\u1ed3ng b\u1ed9 user N\u1ebfu user ch\u01b0a t\u1ed3n t\u1ea1i sau x\u00e1c th\u1ef1c, g\u1eedi y\u00eau c\u1ea7u sync \u0111\u1ebfn <code>user-service</code> Audit log G\u1eedi log h\u00e0nh vi x\u00e1c th\u1ef1c (success/failure) \u0111\u1ebfn <code>audit-logging-service</code> Ph\u00e1t s\u1ef1 ki\u1ec7n G\u1eedi s\u1ef1 ki\u1ec7n <code>auth.token.issued</code>, <code>auth.token.revoked</code>, <code>auth.login.failed</code>, <code>user.sync.triggered</code> l\u00ean Pub/Sub G\u1eafn session metadata Tr\u00edch xu\u1ea5t IP, thi\u1ebft b\u1ecb, user-agent \u0111\u1ec3 ph\u1ee5c v\u1ee5 b\u1ea3o m\u1eadt v\u00e0 gi\u00e1m s\u00e1t"},{"location":"services/auth-service/sub/design/#khong-thuoc-pham-vi","title":"\ud83d\udeab Kh\u00f4ng thu\u1ed9c ph\u1ea1m vi","text":"M\u1ee5c Ghi ch\u00fa X\u00e1c th\u1ef1c Google OAuth2 Th\u1ef1c hi\u1ec7n t\u1ea1i <code>auth-service/master</code> theo <code>adr-006-auth-strategy.md</code> Qu\u1ea3n l\u00fd ng\u01b0\u1eddi d\u00f9ng \u0110\u01b0\u1ee3c x\u1eed l\u00fd b\u1edfi <code>user-service</code> C\u1ea5p ph\u00e1t token tr\u1ef1c ti\u1ebfp Chuy\u1ec3n giao cho <code>token-service</code> \u0111\u1ec3 qu\u1ea3n l\u00fd t\u1eadp trung RBAC &amp; Ph\u00e2n quy\u1ec1n Ki\u1ec3m tra t\u1ea1i <code>api-gateway</code>, kh\u00f4ng th\u1ef1c hi\u1ec7n trong <code>auth-service/sub</code> X\u1eed l\u00fd li\u00ean-tenant Kh\u00f4ng h\u1ed7 tr\u1ee3 login ch\u00e9o tenant; m\u1ed7i instance ch\u1ec9 ph\u1ee5c v\u1ee5 m\u1ed9t tenant duy nh\u1ea5t"},{"location":"services/auth-service/sub/design/#vai-tro-trong-kien-truc-tong-the","title":"\ud83e\udde9 Vai tr\u00f2 trong ki\u1ebfn tr\u00fac t\u1ed5ng th\u1ec3","text":"<pre><code>flowchart TD\n    FE[Frontend]\n    GW[API Gateway]\n    AS[Auth Service Sub]\n    TS[Token Service]\n    US[User Service]\n    AUD[Audit Logging]\n\n    FE --&gt; GW\n    GW --&gt; AS\n    AS --&gt; TS\n    AS --&gt; US\n    AS --&gt; AUD\n</code></pre> <ul> <li><code>api-gateway</code> \u0111\u1ecbnh tuy\u1ebfn request login \u0111\u1ebfn <code>auth-service/sub</code> d\u1ef1a tr\u00ean header <code>X-Tenant-ID</code></li> <li><code>auth-service/sub</code> x\u00e1c th\u1ef1c th\u00f4ng tin, g\u1ecdi <code>token-service</code>, g\u1eedi s\u1ef1 ki\u1ec7n audit, \u0111\u1ed3ng b\u1ed9 user n\u1ebfu c\u1ea7n</li> <li>M\u1ecdi token, permission, RBAC \u0111\u1ec1u \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd b\u00ean ngo\u00e0i <code>auth-service/sub</code>, \u0111\u1ea3m b\u1ea3o service gi\u1eef vai tr\u00f2 nh\u1eb9, t\u1eadp trung, c\u00f3 th\u1ec3 scale \u0111\u1ed9c l\u1eadp</li> </ul>"},{"location":"services/auth-service/sub/design/#tom-tat-vai-tro","title":"\ud83e\uddea T\u00f3m t\u1eaft vai tr\u00f2","text":"Kh\u00eda c\u1ea1nh Tr\u00e1ch nhi\u1ec7m Authentication \u2705 OTP + Local Authorization \u274c (th\u1ef1c hi\u1ec7n t\u1ea1i gateway) Token lifecycle \ud83d\udd01 G\u1ecdi <code>token-service</code> Session tracking \u2705 L\u01b0u <code>auth_sessions</code> Logging &amp; audit \u2705 G\u1eedi log chi ti\u1ebft Tenant isolation \u2705 M\u1ed7i instance \u0111\u1ed9c l\u1eadp theo tenant Observability \u2705 G\u1eafn <code>trace_id</code>, <code>session_metadata</code> \u0111\u1ea7y \u0111\u1ee7 <p>\ud83d\udca1 <code>auth-service/sub</code> kh\u00f4ng x\u1eed l\u00fd x\u00e1c th\u1ef1c li\u00ean tenant (nh\u01b0 admin login t\u1eeb h\u1ec7 th\u1ed1ng kh\u00e1c); c\u00e1c lu\u1ed3ng \u0111\u00f3 \u0111\u01b0\u1ee3c \u0111\u1ecbnh tuy\u1ebfn \u0111\u1ebfn <code>auth-service/master</code>.</p>"},{"location":"services/auth-service/sub/design/#2-thiet-ke-api-chi-tiet-interface-contract","title":"2. \ud83c\udf10 Thi\u1ebft k\u1ebf API chi ti\u1ebft (Interface Contract)","text":"<p><code>Auth Service (Sub)</code> cung c\u1ea5p c\u00e1c API x\u00e1c th\u1ef1c OTP v\u00e0 Local login, \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a r\u00f5 r\u00e0ng trong <code>interface-contract.md</code>. C\u00e1c API tu\u00e2n th\u1ee7 chu\u1ea9n thi\u1ebft k\u1ebf chung to\u00e0n h\u1ec7 th\u1ed1ng:</p> <ul> <li>C\u1ea5u tr\u00fac response theo <code>SuccessEnvelope</code> / <code>ErrorEnvelope</code> (ADR-012, ADR-011)</li> <li>C\u00f3 tr\u01b0\u1eddng <code>meta</code> \u0111i k\u00e8m m\u1ecdi response</li> <li>\u0110\u01b0\u1ee3c b\u1ea3o v\u1ec7 b\u1eb1ng RBAC v\u00e0 \u0111i\u1ec1u ki\u1ec7n \u0111\u1ed9ng <code>x-condition</code> (ADR-007)</li> <li>Truy v\u1ebft theo <code>X-Trace-ID</code>, audit qua <code>audit-logging-service</code></li> </ul>"},{"location":"services/auth-service/sub/design/#danh-sach-endpoint-chinh","title":"\ud83d\udd10 Danh s\u00e1ch endpoint ch\u00ednh","text":"<p>Auth Service - Sub cung c\u1ea5p 4 endpoint ch\u00ednh ph\u1ee5c v\u1ee5 x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng v\u00e0 qu\u1ea3n l\u00fd phi\u00ean \u0111\u0103ng nh\u1eadp. Thi\u1ebft k\u1ebf tu\u00e2n th\u1ee7 chu\u1ea9n OpenAPI v\u00e0 th\u1ed1ng nh\u1ea5t v\u1edbi c\u00e1c t\u00e0i li\u1ec7u interface-contract v\u00e0 m\u00f4 h\u00ecnh d\u1eef li\u1ec7u.</p> API Endpoint Ph\u01b0\u01a1ng th\u1ee9c M\u00f4 t\u1ea3 Ph\u00e2n quy\u1ec1n Ghi ch\u00fa <code>POST /auth/login</code> <code>POST</code> X\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng qua OTP ho\u1eb7c t\u00e0i kho\u1ea3n n\u1ed9i b\u1ed9 <code>auth.login</code> G\u1ed9p chung x\u1eed l\u00fd login OTP v\u00e0 Local <code>POST /auth/logout</code> <code>POST</code> Thu h\u1ed3i token hi\u1ec7n t\u1ea1i (self logout) <code>auth.logout</code> Thu h\u1ed3i session v\u00e0 \u0111\u00e1nh d\u1ea5u token revoked <code>GET /auth/sessions</code> <code>GET</code> Li\u1ec7t k\u00ea c\u00e1c phi\u00ean \u0111\u0103ng nh\u1eadp <code>session.read:any</code> H\u1ed7 tr\u1ee3 l\u1ecdc theo <code>user_id</code>, <code>status</code>, ph\u00e2n trang <code>POST /auth/sessions/{id}/revoke</code> <code>POST</code> Thu h\u1ed3i m\u1ed9t phi\u00ean \u0111\u0103ng nh\u1eadp c\u1ee5 th\u1ec3 <code>session.revoke:any</code> D\u00e0nh cho admin thu h\u1ed3i session b\u1ea5t k\u1ef3 <p>\ud83d\udccc L\u01b0u \u00fd:</p> <ul> <li>API <code>/auth/login</code> s\u1eed d\u1ee5ng <code>oneOf</code> \u0111\u1ec3 ph\u00e2n bi\u1ec7t gi\u1eefa OTP v\u00e0 Local login th\u00f4ng qua <code>login_type</code>, kh\u00f4ng t\u00e1ch th\u00e0nh c\u00e1c route ri\u00eang nh\u01b0 <code>/auth/otp/request</code> hay <code>/auth/local</code>.</li> <li>T\u1ea5t c\u1ea3 c\u00e1c API \u0111\u1ec1u s\u1eed d\u1ee5ng <code>X-Tenant-ID</code> trong <code>x-condition</code> \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o ph\u00e2n v\u00f9ng tenant.</li> <li>Header <code>Authorization: Bearer &lt;token&gt;</code> \u00e1p d\u1ee5ng cho c\u00e1c API b\u1ea3o v\u1ec7, tr\u1eeb <code>POST /auth/login</code>.</li> </ul>"},{"location":"services/auth-service/sub/design/#cau-truc-requestresponse","title":"\ud83d\udce6 C\u1ea5u tr\u00fac request/response","text":""},{"location":"services/auth-service/sub/design/#request-schema","title":"\u2705 Request Schema","text":"<ul> <li> <p><code>LoginRequest</code>: <code>oneOf</code> 2 lo\u1ea1i:</p> </li> <li> <p><code>LoginRequestOTP</code>: <code>{ login_type: otp, phone_number, otp_code }</code></p> </li> <li><code>LoginRequestLocal</code>: <code>{ login_type: local, username, password (writeOnly) }</code></li> <li><code>LogoutRequest</code>: <code>{ reason: string }</code> (tu\u1ef3 ch\u1ecdn)</li> </ul>"},{"location":"services/auth-service/sub/design/#response-schema","title":"\u2705 Response Schema","text":"<ul> <li><code>TokenEnvelope</code>: <code>{ access_token, refresh_token, expires_in, session_id, token_type }</code></li> <li><code>SessionOut</code>: <code>{ session_id, user_id, auth_method, created_at, revoked_at, device_type, ip_address, location, user_agent, status }</code></li> <li><code>PaginatedSessions</code>: <code>{ meta: ResponseMeta, data: [SessionOut] }</code></li> <li><code>ErrorEnvelope</code>: <code>{ error: { code, message, data }, meta: ResponseMeta }</code></li> <li><code>ResponseMeta</code>: <code>{ request_id, timestamp, pagination? }</code></li> </ul>"},{"location":"services/auth-service/sub/design/#ma-loi-chuan","title":"\ud83c\udfaf M\u00e3 l\u1ed7i chu\u1ea9n","text":"HTTP M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 400 <code>auth.invalid_payload</code> Payload kh\u00f4ng h\u1ee3p l\u1ec7 401 <code>auth.invalid_credentials</code> Sai OTP ho\u1eb7c m\u1eadt kh\u1ea9u 403 <code>auth.forbidden</code> Kh\u00f4ng \u0111\u1ee7 quy\u1ec1n 404 <code>session.not_found</code> Kh\u00f4ng t\u00ecm th\u1ea5y session 200 \u2013 Response d\u1ea1ng <code>TokenEnvelope</code>, <code>SuccessBoolean</code>, <code>PaginatedSessions</code> <p>\ud83d\udccc T\u1ea5t c\u1ea3 schema v\u00e0 m\u00e3 l\u1ed7i \u0111\u1ec1u tu\u00e2n th\u1ee7 \u0111\u1ecbnh ngh\u0129a trong <code>components/schemas</code> v\u00e0 <code>components/responses</code> c\u1ee7a <code>openapi.yaml</code>, \u0111\u1ed3ng th\u1eddi th\u1ed1ng nh\u1ea5t v\u1edbi <code>data-model.md</code>.</p>"},{"location":"services/auth-service/sub/design/#truyen-thong-tin-session-session_metadata","title":"\ud83e\udde0 Truy\u1ec1n th\u00f4ng tin session (<code>session_metadata</code>)","text":"<p>M\u1ed7i l\u1ea7n x\u00e1c th\u1ef1c th\u00e0nh c\u00f4ng, d\u1ecbch v\u1ee5 s\u1ebd thu th\u1eadp metadata li\u00ean quan \u0111\u1ebfn phi\u00ean \u0111\u0103ng nh\u1eadp v\u00e0 g\u1eedi k\u00e8m trong y\u00eau c\u1ea7u \u0111\u1ebfn <code>token-service</code>:</p> <pre><code>{\n  \"user_id\": \"abc123\",\n  \"login_method\": \"otp\",\n  \"session_metadata\": {\n    \"ip\": \"192.168.1.1\",\n    \"user_agent\": \"Mozilla/5.0\",\n    \"device\": \"Android; Pixel 6\"\n  }\n}\n</code></pre> <p>Th\u00f4ng tin n\u00e0y s\u1ebd \u0111\u01b0\u1ee3c ghi l\u1ea1i t\u1ea1i b\u1ea3ng <code>auth_sessions</code> v\u00e0 hi\u1ec3n th\u1ecb trong h\u1ec7 th\u1ed1ng qu\u1ea3n tr\u1ecb.</p>"},{"location":"services/auth-service/sub/design/#luu-y-trien-khai","title":"\ud83d\udccc L\u01b0u \u00fd tri\u1ec3n khai","text":"<ul> <li>T\u1ea5t c\u1ea3 API \u0111\u1ec1u \u0111\u1ecbnh danh tenant th\u00f4ng qua header <code>X-Tenant-ID</code></li> <li>RBAC \u0111\u01b0\u1ee3c ki\u1ec3m tra b\u1edfi <code>api-gateway</code>, kh\u00f4ng ph\u1ea3i trong <code>auth-service/sub</code></li> <li>C\u00e1c API kh\u00f4ng y\u00eau c\u1ea7u x\u00e1c th\u1ef1c \u0111\u1ea7u v\u00e0o (v\u00ec l\u00e0 entrypoint c\u1ee7a login) nh\u01b0ng \u0111\u01b0\u1ee3c ki\u1ec3m so\u00e1t qua <code>rate-limit</code>, <code>captcha</code>, <code>otp max-attempt</code></li> <li>C\u00f3 th\u1ec3 test API th\u00f4ng qua Swagger UI t\u00edch h\u1ee3p n\u1ed9i b\u1ed9 (<code>/docs/</code>)</li> </ul> <p>\ud83d\udc49 Xem chi ti\u1ebft: Interface Contract.md \u2013 OpenAPI</p>"},{"location":"services/auth-service/sub/design/#3-mo-hinh-du-lieu-chi-tiet","title":"3. \ud83d\uddc3\ufe0f M\u00f4 h\u00ecnh d\u1eef li\u1ec7u chi ti\u1ebft","text":"<p><code>Auth Service (Sub)</code> kh\u00f4ng l\u01b0u tr\u1eef th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng hay token, nh\u01b0ng v\u1eabn duy tr\u00ec m\u1ed9t s\u1ed1 d\u1eef li\u1ec7u li\u00ean quan \u0111\u1ebfn phi\u00ean \u0111\u0103ng nh\u1eadp v\u00e0 h\u1ed7 tr\u1ee3 x\u00e1c th\u1ef1c.</p>"},{"location":"services/auth-service/sub/design/#bang-auth_sessions-postgresql","title":"\ud83d\udd10 B\u1ea3ng <code>auth_sessions</code> (PostgreSQL)","text":"<p>L\u01b0u th\u00f4ng tin phi\u00ean \u0111\u0103ng nh\u1eadp sau m\u1ed7i l\u1ea7n x\u00e1c th\u1ef1c th\u00e0nh c\u00f4ng. D\u1eef li\u1ec7u n\u00e0y ph\u1ee5c v\u1ee5 m\u1ee5c \u0111\u00edch ki\u1ec3m to\u00e1n, ph\u00e2n t\u00edch h\u00e0nh vi v\u00e0 h\u1ed7 tr\u1ee3 thu h\u1ed3i phi\u00ean (logout).</p> Tr\u01b0\u1eddng Ki\u1ec3u d\u1eef li\u1ec7u M\u00f4 t\u1ea3 <code>session_id</code> <code>uuid</code> \u0110\u1ecbnh danh duy nh\u1ea5t c\u1ee7a phi\u00ean <code>user_id</code> <code>uuid</code> ID ng\u01b0\u1eddi d\u00f9ng \u0111\u00e3 x\u00e1c th\u1ef1c <code>login_method</code> <code>enum('otp', 'local')</code> Ph\u01b0\u01a1ng th\u1ee9c x\u00e1c th\u1ef1c <code>session_metadata</code> <code>jsonb</code> Th\u00f4ng tin metadata nh\u01b0 IP, user-agent, thi\u1ebft b\u1ecb <code>created_at</code> <code>timestamp</code> Th\u1eddi \u0111i\u1ec3m phi\u00ean \u0111\u01b0\u1ee3c t\u1ea1o <code>revoked_at</code> <code>timestamp</code> | <code>null</code> N\u1ebfu phi\u00ean b\u1ecb logout ho\u1eb7c thu h\u1ed3i <code>tenant_id</code> <code>text</code> \u0110\u1ecbnh danh tenant, l\u1ea5y t\u1eeb <code>X-Tenant-ID</code> <p>\ud83d\udccc Tr\u01b0\u1eddng <code>session_metadata</code> th\u01b0\u1eddng ch\u1ee9a: <pre><code>{\n  \"ip\": \"192.168.1.1\",\n  \"user_agent\": \"Mozilla/5.0\",\n  \"device\": \"Android; Pixel 6\",\n  \"location\": \"HCMC\"\n}\n</code></pre></p>"},{"location":"services/auth-service/sub/design/#cache-revoked_tokens-redis","title":"\ud83e\uddca Cache <code>revoked_tokens</code> (Redis)","text":"<p>\u0110\u1ec3 \u0111\u1ea3m b\u1ea3o hi\u1ec7u qu\u1ea3 khi x\u00e1c th\u1ef1c JWT t\u1ea1i <code>api-gateway</code>, Auth Service Sub h\u1ed7 tr\u1ee3 ghi token b\u1ecb thu h\u1ed3i v\u00e0o Redis (d\u00f9ng chung cluster Redis c\u1ee7a h\u1ec7 th\u1ed1ng).</p> <ul> <li>Key format: <code>revoked:{token_id}</code></li> <li>TTL: b\u1eb1ng th\u1eddi h\u1ea1n c\u00f2n l\u1ea1i c\u1ee7a JWT</li> <li>Gi\u00e1 tr\u1ecb: JSON g\u1ed3m <code>revoked_at</code>, <code>user_id</code>, <code>reason</code></li> </ul> <p>V\u00ed d\u1ee5: <pre><code>revoked:3fa85f64-5717-4562-b3fc-2c963f66afa6\n\u2192\n{\n  \"revoked_at\": \"2025-06-13T10:03:00Z\",\n  \"user_id\": \"abc123\",\n  \"reason\": \"manual_logout\"\n}\n</code></pre></p>"},{"location":"services/auth-service/sub/design/#event-log-pubsub","title":"\ud83d\udd04 Event Log (Pub/Sub)","text":"<p>M\u1ed7i s\u1ef1 ki\u1ec7n x\u00e1c th\u1ef1c \u0111\u1ec1u \u0111\u01b0\u1ee3c ph\u00e1t \u0111i theo chu\u1ea9n schema <code>adr-030</code>, ph\u1ee5c v\u1ee5 h\u1ec7 th\u1ed1ng <code>audit-log</code> v\u00e0 c\u00e1c adapter b\u00ean ngo\u00e0i.</p> S\u1ef1 ki\u1ec7n M\u00f4 t\u1ea3 <code>auth.token.issued</code> Sau khi x\u00e1c th\u1ef1c th\u00e0nh c\u00f4ng <code>auth.token.revoked</code> Khi logout ho\u1eb7c thu h\u1ed3i <code>auth.login.failed</code> Th\u1ea5t b\u1ea1i khi x\u00e1c th\u1ef1c OTP ho\u1eb7c local <code>user.sync.triggered</code> Khi c\u1ea7n t\u1ea1o m\u1edbi user trong l\u1ea7n login \u0111\u1ea7u ti\u00ean"},{"location":"services/auth-service/sub/design/#ghi-chu","title":"\u2728 Ghi ch\u00fa","text":"<ul> <li>D\u1eef li\u1ec7u \u0111\u01b0\u1ee3c partition theo <code>tenant_id</code> \u0111\u1ec3 ph\u1ee5c v\u1ee5 tri\u1ec3n khai \u0111a tenant hi\u1ec7u qu\u1ea3</li> <li>Ch\u1ec9 l\u01b0u session sau khi token \u0111\u01b0\u1ee3c c\u1ea5p t\u1eeb <code>token-service</code></li> <li>Kh\u00f4ng l\u01b0u token plaintext \u2014 ch\u1ec9 l\u01b0u metadata v\u00e0 mapping session</li> </ul> <p>Xem th\u00eam c\u00e1c chi ti\u1ebft k\u1ef9 thu\u1eadt nh\u01b0 indexing, constraints, ENUMs, retention policy v\u00e0 chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed d\u1eef li\u1ec7u t\u1ea1i Data Model</p>"},{"location":"services/auth-service/sub/design/#4-luong-xu-ly-nghiep-vu-chinh","title":"4. \ud83d\udd04 Lu\u1ed3ng x\u1eed l\u00fd nghi\u1ec7p v\u1ee5 ch\u00ednh","text":"<p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 m\u00f4 t\u1ea3 chi ti\u1ebft c\u00e1c lu\u1ed3ng x\u1eed l\u00fd ch\u00ednh c\u1ee7a <code>auth-service/sub</code>, bao g\u1ed3m: \u0111\u0103ng nh\u1eadp b\u1eb1ng OTP, \u0111\u0103ng nh\u1eadp Local, logout v\u00e0 \u0111\u1ed3ng b\u1ed9 ng\u01b0\u1eddi d\u00f9ng. T\u1ea5t c\u1ea3 \u0111\u1ec1u di\u1ec5n ra trong ng\u1eef c\u1ea3nh c\u1ee7a t\u1eebng tenant (per-tenant).</p>"},{"location":"services/auth-service/sub/design/#luong-1-ang-nhap-bang-otp","title":"\ud83d\udd10 Lu\u1ed3ng 1: \u0110\u0103ng nh\u1eadp b\u1eb1ng OTP","text":"<pre><code>sequenceDiagram\n    participant FE as Frontend\n    participant GW as API Gateway\n    participant AS as Auth Sub\n    participant TS as Token Service\n    participant US as User Service\n    participant AL as Audit Logging\n\n    FE-&gt;&gt;GW: POST /auth/otp/verify\n    GW-&gt;&gt;AS: Forward request + headers\n    AS-&gt;&gt;AS: Ki\u1ec3m tra m\u00e3 OTP h\u1ee3p l\u1ec7\n    AS-&gt;&gt;TS: G\u1eedi y\u00eau c\u1ea7u c\u1ea5p token + session_metadata\n    TS--&gt;&gt;AS: Tr\u1ea3 v\u1ec1 access_token + refresh_token\n    AS-&gt;&gt;US: G\u1eedi y\u00eau c\u1ea7u \u0111\u1ed3ng b\u1ed9 user (n\u1ebfu ch\u01b0a c\u00f3)\n    AS-&gt;&gt;AL: G\u1eedi s\u1ef1 ki\u1ec7n `auth.token.issued`\n    AS--&gt;&gt;GW: Tr\u1ea3 JWT cho FE\n</code></pre> <p>\ud83d\udcdd Ghi ch\u00fa: - N\u1ebfu OTP sai \u2192 tr\u1ea3 l\u1ed7i <code>auth.otp.invalid</code> (namespace <code>auth</code>, theo <code>ErrorEnvelope</code>) - N\u1ebfu ch\u01b0a c\u00f3 user \u2192 g\u1eedi y\u00eau c\u1ea7u POST <code>user.sync</code> t\u1edbi <code>user-service</code> (async) - Session \u0111\u01b0\u1ee3c ghi l\u1ea1i t\u1ea1i b\u1ea3ng <code>auth_sessions</code> sau khi nh\u1eadn token</p>"},{"location":"services/auth-service/sub/design/#luong-2-ang-nhap-local-usernamepassword","title":"\ud83d\udc64 Lu\u1ed3ng 2: \u0110\u0103ng nh\u1eadp Local (username/password)","text":"<ul> <li>T\u01b0\u01a1ng t\u1ef1 lu\u1ed3ng OTP, nh\u01b0ng thay ki\u1ec3m tra OTP b\u1eb1ng x\u00e1c th\u1ef1c credential: <pre><code>- Ki\u1ec3m tra username/password\n- G\u1ecdi token-service\n- Ghi session\n- Audit log\n- \u0110\u1ed3ng b\u1ed9 user n\u1ebfu ch\u01b0a t\u1ed3n t\u1ea1i\n</code></pre></li> </ul> <p>\ud83d\udccc Y\u00eau c\u1ea7u d\u00f9ng chu\u1ea9n bcrypt cho password hash; kh\u00f4ng l\u01b0u plaintext ho\u1eb7c so s\u00e1nh tr\u1ef1c ti\u1ebfp.</p>"},{"location":"services/auth-service/sub/design/#luong-3-logout-thu-hoi-phien","title":"\ud83d\udd01 Lu\u1ed3ng 3: Logout (Thu h\u1ed3i phi\u00ean)","text":"<pre><code>sequenceDiagram\n    participant FE\n    participant GW\n    participant AS\n    participant TS\n    participant AL\n\n    FE-&gt;&gt;GW: POST /auth/logout (k\u00e8m JWT)\n    GW-&gt;&gt;AS: Forward token\n    AS-&gt;&gt;TS: G\u1ecdi token-service thu h\u1ed3i token\n    AS-&gt;&gt;AL: Ghi s\u1ef1 ki\u1ec7n `auth.token.revoked`\n    AS--&gt;&gt;GW: Tr\u1ea3 success envelope\n</code></pre> <p>Ghi ch\u00fa: - Token b\u1ecb thu h\u1ed3i s\u1ebd \u0111\u01b0\u1ee3c \u0111\u1ea9y v\u00e0o Redis (<code>revoked_tokens</code>) v\u1edbi TTL t\u01b0\u01a1ng \u1ee9ng - D\u1eef li\u1ec7u thu h\u1ed3i c\u00f3 th\u1ec3 d\u00f9ng \u0111\u1ec3 ki\u1ec3m tra ch\u00e9o \u1edf <code>api-gateway</code></p>"},{"location":"services/auth-service/sub/design/#luong-4-ong-bo-user","title":"\ud83d\udd04 Lu\u1ed3ng 4: \u0110\u1ed3ng b\u1ed9 user","text":"<ul> <li>N\u1ebfu token \u0111\u01b0\u1ee3c c\u1ea5p h\u1ee3p l\u1ec7 nh\u01b0ng <code>user_id</code> ch\u01b0a c\u00f3 trong tenant DB, <code>auth-service/sub</code> s\u1ebd:</li> <li>G\u1eedi request \u0111\u1ed3ng b\u1ed9 async t\u1edbi <code>user-service</code></li> <li>Ghi log <code>user.sync.triggered</code></li> <li>Cho ph\u00e9p ho\u00e0n t\u1ea5t phi\u00ean x\u00e1c th\u1ef1c, kh\u00f4ng ch\u1eb7n ng\u01b0\u1eddi d\u00f9ng</li> </ul>"},{"location":"services/auth-service/sub/design/#mo-hinh-phan-tang","title":"\u2705 M\u00f4 h\u00ecnh ph\u00e2n t\u1ea7ng","text":"T\u1ea7ng Vai tr\u00f2 <code>api-gateway</code> Ki\u1ec3m tra JWT + RBAC, forward request \u0111\u1ebfn <code>auth-service/sub</code> <code>auth-service/sub</code> Ki\u1ec3m tra th\u00f4ng tin x\u00e1c th\u1ef1c &amp; x\u1eed l\u00fd login/logout <code>token-service</code> C\u1ea5p ph\u00e1t / thu h\u1ed3i JWT <code>user-service</code> \u0110\u1ed3ng b\u1ed9 ho\u1eb7c t\u1ea1o user n\u1ebfu ch\u01b0a t\u1ed3n t\u1ea1i <code>audit-log</code> Ghi l\u1ea1i t\u1ea5t c\u1ea3 s\u1ef1 ki\u1ec7n x\u00e1c th\u1ef1c <p>\ud83d\udc49 C\u00e1c lu\u1ed3ng n\u00e0y tu\u00e2n th\u1ee7 nguy\u00ean t\u1eafc stateless, c\u00f3 th\u1ec3 m\u1edf r\u1ed9ng theo t\u1eebng tenant, v\u00e0 d\u1ec5 d\u00e0ng theo d\u00f5i qua audit log + trace ID t\u1eeb <code>api-gateway</code>.</p>"},{"location":"services/auth-service/sub/design/#5-tuong-tac-voi-cac-service-khac-luong-su-kien","title":"5. \ud83d\udce3 T\u01b0\u01a1ng t\u00e1c v\u1edbi c\u00e1c Service kh\u00e1c &amp; Lu\u1ed3ng s\u1ef1 ki\u1ec7n","text":"<p><code>auth-service/sub</code> kh\u00f4ng ho\u1ea1t \u0111\u1ed9ng \u0111\u1ed9c l\u1eadp m\u00e0 t\u01b0\u01a1ng t\u00e1c ch\u1eb7t ch\u1ebd v\u1edbi c\u00e1c th\u00e0nh ph\u1ea7n kh\u00e1c trong h\u1ec7 th\u1ed1ng th\u00f4ng qua API n\u1ed9i b\u1ed9 v\u00e0 c\u01a1 ch\u1ebf s\u1ef1 ki\u1ec7n b\u1ea5t \u0111\u1ed3ng b\u1ed9 (Pub/Sub). M\u1ee5c ti\u00eau l\u00e0 \u0111\u1ea3m b\u1ea3o x\u00e1c th\u1ef1c an to\u00e0n, th\u1ed1ng nh\u1ea5t token lifecycle, v\u00e0 ghi nh\u1eadn \u0111\u1ea7y \u0111\u1ee7 d\u1ea5u v\u1ebft ph\u1ee5c v\u1ee5 ki\u1ec3m to\u00e1n &amp; ph\u00e2n t\u00edch.</p>"},{"location":"services/auth-service/sub/design/#giao-tiep-noi-bo-internal-api-calls","title":"\ud83d\udd17 Giao ti\u1ebfp n\u1ed9i b\u1ed9 (Internal API Calls)","text":"\u0110\u00edch \u0111\u1ebfn API M\u1ee5c \u0111\u00edch <code>token-service</code> <code>POST /token/issue</code>, <code>POST /token/revoke</code> Y\u00eau c\u1ea7u c\u1ea5p v\u00e0 thu h\u1ed3i JWT <code>user-service</code> <code>POST /users/sync</code> \u0110\u1ed3ng b\u1ed9 user khi x\u00e1c th\u1ef1c l\u1ea7n \u0111\u1ea7u <code>audit-logging-service</code> <code>POST /events/audit</code> Ghi nh\u1eadn s\u1ef1 ki\u1ec7n x\u00e1c th\u1ef1c <code>notification-service</code> <code>POST /otp/send</code> G\u1eedi m\u00e3 OTP qua SMS/email <p>\ud83d\udccc T\u1ea5t c\u1ea3 c\u00e1c call \u0111\u1ec1u c\u00f3 g\u1eafn <code>X-Tenant-ID</code>, <code>X-Trace-ID</code>, v\u00e0 truy\u1ec1n metadata nh\u01b0 IP, thi\u1ebft b\u1ecb, ph\u01b0\u01a1ng th\u1ee9c login.</p>"},{"location":"services/auth-service/sub/design/#luong-su-kien-bat-ong-bo-pubsub","title":"\ud83d\udce3 Lu\u1ed3ng s\u1ef1 ki\u1ec7n b\u1ea5t \u0111\u1ed3ng b\u1ed9 (Pub/Sub)","text":"<p>Sau m\u1ed7i h\u00e0nh \u0111\u1ed9ng x\u00e1c th\u1ef1c quan tr\u1ecdng, <code>auth-service/sub</code> ph\u00e1t s\u1ef1 ki\u1ec7n \u0111\u1ebfn h\u1ec7 th\u1ed1ng Pub/Sub c\u1ee7a tenant t\u01b0\u01a1ng \u1ee9ng.</p>"},{"location":"services/auth-service/sub/design/#danh-sach-su-kien-phat-hanh","title":"\ud83d\udd04 Danh s\u00e1ch s\u1ef1 ki\u1ec7n ph\u00e1t h\u00e0nh","text":"S\u1ef1 ki\u1ec7n Khi n\u00e0o ph\u00e1t? Payload <code>auth.token.issued</code> Sau khi x\u00e1c th\u1ef1c th\u00e0nh c\u00f4ng v\u00e0 nh\u1eadn JWT t\u1eeb token-service G\u1ed3m <code>user_id</code>, <code>login_method</code>, <code>session_id</code>, <code>tenant_id</code> <code>auth.token.revoked</code> Khi logout ho\u1eb7c thu h\u1ed3i token G\u1ed3m <code>token_id</code>, <code>revoked_by</code>, <code>reason</code> <code>auth.login.failed</code> Khi x\u00e1c th\u1ef1c th\u1ea5t b\u1ea1i do OTP/credential kh\u00f4ng \u0111\u00fang G\u1ed3m <code>login_method</code>, <code>reason</code>, <code>user_input</code>, <code>ip</code> <code>user.sync.triggered</code> Khi x\u00e1c th\u1ef1c th\u00e0nh c\u00f4ng nh\u01b0ng user ch\u01b0a t\u1ed3n t\u1ea1i G\u1ed3m <code>external_user_id</code>, <code>login_method</code>, <code>tenant_id</code>"},{"location":"services/auth-service/sub/design/#vi-du-payload-authtokenissued","title":"\ud83d\udccb V\u00ed d\u1ee5 payload <code>auth.token.issued</code>","text":"<pre><code>{\n  \"event\": \"auth.token.issued\",\n  \"timestamp\": \"2025-06-13T10:00:00Z\",\n  \"tenant_id\": \"school-abc\",\n  \"session_id\": \"abc123\",\n  \"user_id\": \"user-001\",\n  \"login_method\": \"otp\",\n  \"session_metadata\": {\n    \"ip\": \"192.168.1.1\",\n    \"user_agent\": \"Mozilla/5.0\",\n    \"device\": \"iPhone 12\"\n  }\n}\n</code></pre>"},{"location":"services/auth-service/sub/design/#nguyen-tac-thiet-ke-tich-hop","title":"\ud83c\udfaf Nguy\u00ean t\u1eafc thi\u1ebft k\u1ebf t\u00edch h\u1ee3p","text":"<ul> <li>T\u1ea5t c\u1ea3 c\u00e1c s\u1ef1 ki\u1ec7n tu\u00e2n theo schema chu\u1ea9n \u0111\u1ecbnh ngh\u0129a trong <code>adr-030-event-schema-governance.md</code></li> <li>Kh\u00f4ng c\u00f3 d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m (m\u1eadt kh\u1ea9u, OTP) \u0111\u01b0\u1ee3c truy\u1ec1n trong payload</li> <li>M\u1ed7i s\u1ef1 ki\u1ec7n \u0111\u1ec1u ch\u1ee9a <code>tenant_id</code> v\u00e0 <code>trace_id</code> \u0111\u1ec3 ph\u1ee5c v\u1ee5 vi\u1ec7c theo d\u00f5i ch\u00e9o h\u1ec7 th\u1ed1ng</li> <li>C\u00e1c h\u1ec7 th\u1ed1ng ti\u00eau th\u1ee5 s\u1ef1 ki\u1ec7n (CRM, LMS, Dashboard) s\u1ebd d\u1ef1a v\u00e0o c\u00e1c s\u1ef1 ki\u1ec7n n\u00e0y \u0111\u1ec3 trigger h\u00e0nh vi ph\u00f9 h\u1ee3p (v\u00ed d\u1ee5: t\u1ea1o h\u1ecdc sinh m\u1edbi sau login)</li> </ul> <p>\ud83d\udc49 Vi\u1ec7c tri\u1ec3n khai Pub/Sub l\u00e0 b\u1eaft bu\u1ed9c \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o h\u1ec7 th\u1ed1ng c\u00f3 kh\u1ea3 n\u0103ng observability to\u00e0n di\u1ec7n, scale \u0111\u1ed9c l\u1eadp v\u00e0 d\u1ec5 d\u00e0ng t\u00edch h\u1ee3p v\u1edbi c\u00e1c module kinh doanh kh\u00e1c.</p>"},{"location":"services/auth-service/sub/design/#6-bao-mat-phan-quyen","title":"6. \ud83d\udd10 B\u1ea3o m\u1eadt &amp; Ph\u00e2n quy\u1ec1n","text":"<p><code>auth-service/sub</code> l\u00e0 entrypoint x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng cu\u1ed1i (student, teacher, employee) trong t\u1eebng tenant. M\u1eb7c d\u00f9 b\u1ea3n th\u00e2n d\u1ecbch v\u1ee5 kh\u00f4ng tr\u1ef1c ti\u1ebfp ki\u1ec3m tra ph\u00e2n quy\u1ec1n, n\u00f3 v\u1eabn tu\u00e2n th\u1ee7 nghi\u00eam ng\u1eb7t c\u00e1c y\u00eau c\u1ea7u b\u1ea3o m\u1eadt v\u00e0 ph\u1ed1i h\u1ee3p ch\u1eb7t ch\u1ebd v\u1edbi t\u1ea7ng <code>api-gateway</code> \u0111\u1ec3 th\u1ef1c thi RBAC &amp; c\u00e1c ch\u00ednh s\u00e1ch b\u1ea3o v\u1ec7 h\u1ec7 th\u1ed1ng.</p>"},{"location":"services/auth-service/sub/design/#co-che-bao-mat-chinh","title":"\ud83d\udd10 C\u01a1 ch\u1ebf b\u1ea3o m\u1eadt ch\u00ednh","text":"Bi\u1ec7n ph\u00e1p M\u1ee5c ti\u00eau Th\u1ef1c hi\u1ec7n t\u1ea1i \u0111\u00e2u? X\u00e1c th\u1ef1c OTP / Local login \u0110\u1ea3m b\u1ea3o danh t\u00ednh ng\u01b0\u1eddi d\u00f9ng <code>auth-service/sub</code> G\u1eafn trace_id &amp; audit Theo d\u00f5i truy v\u1ebft x\u00e1c th\u1ef1c <code>api-gateway</code>, <code>auth-service/sub</code>, <code>audit-log</code> Ph\u00e2n quy\u1ec1n \u0111\u1ed9ng (RBAC + x-condition) Ch\u1eb7n truy c\u1eadp tr\u00e1i ph\u00e9p v\u00e0o t\u00e0i nguy\u00ean <code>api-gateway</code> JWT Validation Ki\u1ec3m tra token ng\u01b0\u1eddi d\u00f9ng <code>api-gateway</code> Token Revocation Thu h\u1ed3i token khi logout <code>token-service</code> + Redis revoked cache Rate limit + OTP throttle Ch\u1ed1ng brute-force, spam OTP Gateway + internal OTP limiter Header Signature (n\u1ed9i b\u1ed9) B\u1ea3o v\u1ec7 API n\u1ed9i b\u1ed9 kh\u1ecfi gi\u1ea3 m\u1ea1o <code>HMAC</code> ho\u1eb7c <code>mTLS</code> tu\u1ef3 m\u00f4i tr\u01b0\u1eddng"},{"location":"services/auth-service/sub/design/#phan-quyen-va-rbac-ap-dung-gian-tiep","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n v\u00e0 RBAC (\u00e1p d\u1ee5ng gi\u00e1n ti\u1ebfp)","text":"<p>M\u1eb7c d\u00f9 <code>auth-service/sub</code> kh\u00f4ng t\u1ef1 ph\u00e2n quy\u1ec1n, n\u00f3 c\u00f3 tr\u00e1ch nhi\u1ec7m g\u1eafn permission code v\u00e0 <code>x-condition</code> ph\u00f9 h\u1ee3p \u0111\u1ec3 <code>api-gateway</code> ki\u1ec3m tra tr\u01b0\u1edbc khi g\u1ecdi.</p> <ul> <li>M\u1ed7i endpoint \u0111\u01b0\u1ee3c annotate b\u1edfi:</li> <li><code>x-required-permission</code>: M\u00e3 quy\u1ec1n logic (vd: <code>auth.otp.verify</code>)</li> <li><code>x-condition</code>: \u0110i\u1ec1u ki\u1ec7n \u0111\u1ed9ng d\u1ef1a tr\u00ean request (<code>tenant_id</code>, <code>login_method</code>, ...)</li> </ul> <pre><code>/auth/otp/verify:\n  post:\n    summary: X\u00e1c th\u1ef1c OTP\n    x-required-permission: auth.otp.verify\n    x-condition:\n      tenant_id: \"{{X-Tenant-ID}}\"\n      login_method: \"otp\"\n</code></pre> <p>C\u00e1c gi\u00e1 tr\u1ecb <code>x-condition</code> n\u00e0y s\u1ebd \u0111\u01b0\u1ee3c <code>api-gateway</code> s\u1eed d\u1ee5ng \u0111\u1ec3 tra b\u1ea3ng role-permission trong Redis v\u00e0 quy\u1ebft \u0111\u1ecbnh c\u00f3 forward hay kh\u00f4ng.</p>"},{"location":"services/auth-service/sub/design/#token-session-lifecycle","title":"\ud83d\udd12 Token &amp; session lifecycle","text":"V\u1ea5n \u0111\u1ec1 C\u00e1ch x\u1eed l\u00fd Token b\u1ecb thu h\u1ed3i Ghi v\u00e0o Redis <code>revoked:{token_id}</code> v\u00e0 TTL b\u1eb1ng th\u1eddi gian c\u00f2n l\u1ea1i Token \u0111\u01b0\u1ee3c c\u1ea5p G\u1eedi s\u1ef1 ki\u1ec7n <code>auth.token.issued</code>, l\u01b0u session v\u00e0o <code>auth_sessions</code> Logout G\u1ecdi <code>token-service/revoke</code>, ph\u00e1t <code>auth.token.revoked</code> L\u1ed7i x\u00e1c th\u1ef1c Ghi s\u1ef1 ki\u1ec7n <code>auth.login.failed</code>, kh\u00f4ng tr\u1ea3 chi ti\u1ebft l\u1ed7i k\u1ef9 thu\u1eadt \u0111\u1ec3 tr\u00e1nh d\u00f2 th\u00f4ng tin"},{"location":"services/auth-service/sub/design/#chinh-sach-bao-ve-api","title":"\ud83e\uddef Ch\u00ednh s\u00e1ch b\u1ea3o v\u1ec7 API","text":"T\u1ea7ng C\u01a1 ch\u1ebf <code>api-gateway</code> Rate limit theo IP, CAPTCHA (n\u1ebfu c\u1ea7n), ki\u1ec3m tra JWT <code>auth-service/sub</code> Gi\u1edbi h\u1ea1n OTP attempt theo IP/user/device, b\u1ea3o v\u1ec7 replay <code>Redis</code> TTL cho OTP + revoked token \u0111\u1ec3 gi\u1ea3m r\u00f2 r\u1ec9 th\u00f4ng tin <p>\ud83d\udc49 Trong m\u00f4i tr\u01b0\u1eddng production, n\u00ean s\u1eed d\u1ee5ng <code>mTLS</code> ho\u1eb7c <code>HMAC signature</code> \u0111\u1ec3 x\u00e1c th\u1ef1c gi\u1eefa c\u00e1c service n\u1ed9i b\u1ed9 (auth-service/sub \u2192 token-service, user-service...).</p> <p>Ngo\u00e0i ra, c\u1ea7n li\u00ean t\u1ee5c monitor c\u00e1c s\u1ef1 ki\u1ec7n b\u1ea5t th\u01b0\u1eddng nh\u01b0: - OTP g\u1eedi qu\u00e1 m\u1ee9c - login_failed t\u0103ng \u0111\u1ed9t bi\u1ebfn - user ch\u01b0a t\u1ed3n t\u1ea1i sau login \u2192 d\u1ea5u hi\u1ec7u t\u1ea5n c\u00f4ng th\u0103m d\u00f2</p>"},{"location":"services/auth-service/sub/design/#7-cau-hinh-phu-thuoc","title":"7. \u2699\ufe0f C\u1ea5u h\u00ecnh &amp; Ph\u1ee5 thu\u1ed9c","text":"<p><code>auth-service/sub</code> \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf theo m\u00f4 h\u00ecnh per-tenant deployment, m\u1ed7i tenant ch\u1ea1y m\u1ed9t instance \u0111\u1ed9c l\u1eadp v\u1edbi c\u1ea5u h\u00ecnh ri\u00eang bi\u1ec7t, \u0111\u1ea3m b\u1ea3o c\u00f4 l\u1eadp d\u1eef li\u1ec7u, kh\u1ea3 n\u0103ng t\u00f9y ch\u1ec9nh linh ho\u1ea1t v\u00e0 d\u1ec5 m\u1edf r\u1ed9ng. D\u1ecbch v\u1ee5 ho\u1ea1t \u0111\u1ed9ng theo ki\u1ebfn tr\u00fac stateless v\u00e0 ph\u1ee5 thu\u1ed9c v\u00e0o m\u1ed9t s\u1ed1 d\u1ecbch v\u1ee5 l\u00f5i trong h\u1ec7 sinh th\u00e1i.</p>"},{"location":"services/auth-service/sub/design/#cau-hinh-moi-truong-env","title":"\ud83d\udd27 C\u1ea5u h\u00ecnh m\u00f4i tr\u01b0\u1eddng (ENV)","text":"Bi\u1ebfn m\u00f4i tr\u01b0\u1eddng M\u00f4 t\u1ea3 V\u00ed d\u1ee5 <code>TENANT_ID</code> \u0110\u1ecbnh danh tenant t\u01b0\u01a1ng \u1ee9ng <code>school-abc</code> <code>OTP_PROVIDER</code> Lo\u1ea1i g\u1eedi OTP (<code>email</code>, <code>sms</code>) <code>sms</code> <code>OTP_TTL_SECONDS</code> Th\u1eddi gian s\u1ed1ng c\u1ee7a OTP <code>300</code> <code>REDIS_URL</code> Redis \u0111\u1ec3 l\u01b0u revoked token, OTP attempt <code>redis://...</code> <code>TOKEN_SERVICE_URL</code> Endpoint n\u1ed9i b\u1ed9 token-service <code>http://token-service/api/...</code> <code>USER_SERVICE_URL</code> Endpoint \u0111\u1ed3ng b\u1ed9 user <code>http://user-service/api/...</code> <code>AUDIT_SERVICE_URL</code> G\u1eedi log x\u00e1c th\u1ef1c <code>http://audit-log/api/...</code> <code>JWT_ISSUER</code> Issuer d\u00f9ng \u0111\u1ec3 \u0111\u1ed1i chi\u1ebfu v\u1edbi token-service <code>dx.vas.vn</code> <code>LOG_LEVEL</code> M\u1ee9c \u0111\u1ed9 log (<code>info</code>, <code>debug</code>, <code>error</code>) <code>info</code> <p>T\u1ea5t c\u1ea3 bi\u1ebfn m\u00f4i tr\u01b0\u1eddng ph\u1ea3i \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd qua <code>ConfigMap</code> v\u00e0 <code>Secret</code> (Xem <code>adr-005</code> v\u00e0 <code>adr-003</code>).</p>"},{"location":"services/auth-service/sub/design/#secrets-bat-buoc","title":"\ud83d\udd10 Secrets b\u1eaft bu\u1ed9c","text":"Secret M\u00f4 t\u1ea3 <code>JWT_SIGNING_SECRET</code> D\u00f9ng \u0111\u1ec3 x\u00e1c minh JWT tr\u1ea3 v\u1ec1 t\u1eeb <code>token-service</code> <code>REDIS_PASSWORD</code> M\u1eadt kh\u1ea9u Redis (n\u1ebfu d\u00f9ng password mode) <code>OTP_PROVIDER_KEY</code> API key g\u1eedi OTP n\u1ebfu d\u00f9ng b\u00ean th\u1ee9 ba <p>Secrets \u0111\u01b0\u1ee3c mount qua <code>Kubernetes Secret</code> ho\u1eb7c <code>Vault Agent Sidecar</code>, tuy\u1ec7t \u0111\u1ed1i kh\u00f4ng commit v\u00e0o m\u00e3 ngu\u1ed3n.</p>"},{"location":"services/auth-service/sub/design/#phu-thuoc-vao-cac-dich-vu-khac","title":"\ud83e\udde9 Ph\u1ee5 thu\u1ed9c v\u00e0o c\u00e1c d\u1ecbch v\u1ee5 kh\u00e1c","text":"D\u1ecbch v\u1ee5 M\u1ee5c \u0111\u00edch Giao ti\u1ebfp <code>token-service</code> C\u1ea5p v\u00e0 thu h\u1ed3i JWT HTTP n\u1ed9i b\u1ed9, c\u00f3 HMAC k\u00fd header <code>user-service</code> \u0110\u1ed3ng b\u1ed9 user HTTP n\u1ed9i b\u1ed9 <code>notification-service</code> G\u1eedi OTP HTTP n\u1ed9i b\u1ed9 <code>audit-logging-service</code> Ghi log x\u00e1c th\u1ef1c Pub/Sub ho\u1eb7c HTTP <code>Redis</code> L\u01b0u OTP, revoked token, limiter Redis cluster ri\u00eang theo tenant <code>PostgreSQL</code> L\u01b0u b\u1ea3ng <code>auth_sessions</code> C\u01a1 s\u1edf d\u1eef li\u1ec7u ri\u00eang c\u1ee7a tenant <p>T\u1ea5t c\u1ea3 service \u0111\u1ec1u d\u00f9ng chung h\u1ec7 th\u1ed1ng <code>service discovery</code> n\u1ed9i b\u1ed9 th\u00f4ng qua t\u00ean DNS Kubernetes.</p>"},{"location":"services/auth-service/sub/design/#tach-biet-cau-hinh-theo-tenant","title":"\ud83d\uddc2 T\u00e1ch bi\u1ec7t c\u1ea5u h\u00ecnh theo tenant","text":"<p>C\u1ea5u h\u00ecnh c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd qua c\u00e1c kh\u1ed1i <code>values.yaml</code> ri\u00eang bi\u1ec7t trong Helm Chart ho\u1eb7c file <code>.env</code> theo folder:</p> <pre><code>env/\n\u251c\u2500\u2500 school-abc/\n\u2502   \u251c\u2500\u2500 .env\n\u2502   \u2514\u2500\u2500 secrets.env\n\u251c\u2500\u2500 school-xyz/\n\u2502   \u251c\u2500\u2500 .env\n\u2502   \u2514\u2500\u2500 secrets.env\n</code></pre>"},{"location":"services/auth-service/sub/design/#cac-rang-buoc","title":"\u26a0\ufe0f C\u00e1c r\u00e0ng bu\u1ed9c","text":"<ul> <li>Kh\u00f4ng \u0111\u01b0\u1ee3c hard-code endpoint ho\u1eb7c secret trong m\u00e3 ngu\u1ed3n</li> <li>M\u1ecdi th\u00f4ng tin nh\u1ea1y c\u1ea3m \u0111\u1ec1u c\u1ea7n \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd theo <code>adr-003-secrets.md</code></li> <li>N\u1ebfu tri\u1ec3n khai multi-tenant tr\u00ean c\u00f9ng 1 instance (kh\u00f4ng khuy\u1ebfn kh\u00edch), c\u1ea7n d\u00f9ng <code>X-Tenant-ID</code> \u0111\u1ec3 \u0111\u1ecbnh tuy\u1ebfn v\u00e0 ph\u00e2n v\u00f9ng session \u2014 tuy nhi\u00ean \u0111i\u1ec1u n\u00e0y l\u00e0m t\u0103ng \u0111\u1ed9 ph\u1ee9c t\u1ea1p b\u1ea3o m\u1eadt v\u00e0 quan s\u00e1t</li> </ul> <p>\ud83d\udc49 \u0110\u1ea3m b\u1ea3o m\u1ecdi c\u1ea5u h\u00ecnh \u0111\u1ec1u c\u00f3 ki\u1ec3m tra t\u00ednh h\u1ee3p l\u1ec7 khi service kh\u1edfi \u0111\u1ed9ng, s\u1eed d\u1ee5ng th\u01b0 vi\u1ec7n c\u1ea5u h\u00ecnh chu\u1ea9n (VD: <code>pydantic.BaseSettings</code>, <code>dynaconf</code>, <code>dotenv</code>, v.v.)</p>"},{"location":"services/auth-service/sub/design/#8-chien-luoc-kiem-thu","title":"8. \ud83e\uddea Chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed","text":"<p><code>auth-service/sub</code> \u0111\u00f3ng vai tr\u00f2 c\u1ed1t l\u00f5i trong qu\u00e1 tr\u00ecnh x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng \u0111\u1ea7u v\u00e0o h\u1ec7 th\u1ed1ng. Do \u0111\u00f3, c\u1ea7n tri\u1ec3n khai chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed to\u00e0n di\u1ec7n t\u1eeb \u0111\u01a1n v\u1ecb (unit) \u0111\u1ebfn t\u00edch h\u1ee3p h\u1ec7 th\u1ed1ng (E2E), bao g\u1ed3m c\u1ea3 ki\u1ec3m th\u1eed h\u1ee3p \u0111\u1ed3ng v\u1edbi c\u00e1c service li\u00ean k\u1ebft nh\u01b0 <code>token-service</code>, <code>user-service</code>, <code>notification-service</code>.</p>"},{"location":"services/auth-service/sub/design/#81-unit-tests","title":"\ud83d\udd2c 8.1. Unit Tests","text":"Ph\u1ea1m vi M\u00f4 t\u1ea3 C\u00f4ng c\u1ee5 OTP validation Ki\u1ec3m tra logic OTP h\u1ee3p l\u1ec7 / h\u1ebft h\u1ea1n / sai m\u00e3 / v\u01b0\u1ee3t gi\u1edbi h\u1ea1n <code>pytest</code> Local login Ki\u1ec3m tra hash password, x\u00e1c th\u1ef1c th\u00e0nh c\u00f4ng/th\u1ea5t b\u1ea1i <code>pytest</code>, <code>bcrypt</code> Token request builder Ki\u1ec3m tra payload g\u1eedi sang <code>token-service</code> <code>pytest</code>, mock HTTP Audit logger G\u1eedi \u0111\u00fang event + metadata <code>pytest</code>, <code>mock pubsub</code> Metadata extractor T\u1eeb IP, user-agent header Unit test thu\u1ea7n <p>\u2705 To\u00e0n b\u1ed9 unit test \u0111\u01b0\u1ee3c ch\u1ea1y \u0111\u1ed9c l\u1eadp v\u1edbi c\u00e1c service kh\u00e1c.</p>"},{"location":"services/auth-service/sub/design/#82-contract-tests","title":"\ud83d\udd17 8.2. Contract Tests","text":"<p>Tu\u00e2n th\u1ee7 theo <code>adr-010</code>, t\u1ea5t c\u1ea3 c\u00e1c HTTP call outbound \u0111\u1ec1u c\u00f3 h\u1ee3p \u0111\u1ed3ng r\u00f5 r\u00e0ng v\u00e0 \u0111\u01b0\u1ee3c ki\u1ec3m th\u1eed contract \u0111\u1ecbnh k\u1ef3.</p> Service Ph\u01b0\u01a1ng ph\u00e1p Tool <code>token-service</code> Ki\u1ec3m tra JSON schema c\u1ee7a <code>/token/issue</code>, <code>/token/revoke</code> <code>pact</code>, <code>schemathesis</code> <code>user-service</code> Contract: <code>POST /users/sync</code> <code>pact</code> <code>notification-service</code> Contract: <code>POST /otp/send</code> <code>pact</code> <code>audit-service</code> Ki\u1ec3m tra event schema <code>auth.token.issued</code>, <code>auth.token.revoked</code> JSON Schema validation <p>\ud83d\udd12 C\u00e1c contract test \u0111\u01b0\u1ee3c trigger t\u1ef1 \u0111\u1ed9ng trong CI m\u1ed7i khi c\u00f3 thay \u0111\u1ed5i API li\u00ean quan.</p>"},{"location":"services/auth-service/sub/design/#83-integration-tests","title":"\ud83e\uddea 8.3. Integration Tests","text":"<p>M\u00f4 ph\u1ecfng to\u00e0n b\u1ed9 flow x\u00e1c th\u1ef1c gi\u1eefa c\u00e1c service.</p> K\u1ecbch b\u1ea3n M\u00f4 t\u1ea3 \u0110\u0103ng nh\u1eadp OTP h\u1ee3p l\u1ec7 T\u1ea1o OTP \u2192 g\u1eedi \u2192 x\u00e1c th\u1ef1c \u2192 nh\u1eadn JWT \u2192 sync user \u0110\u0103ng nh\u1eadp OTP sai m\u00e3 Th\u1eed m\u00e3 sai nhi\u1ec1u l\u1ea7n \u2192 b\u1ecb ch\u1eb7n \u0110\u0103ng nh\u1eadp Local G\u1eedi username/password \u0111\u00fang v\u00e0 sai Logout G\u1eedi refresh token \u2192 thu h\u1ed3i token \u2192 ki\u1ec3m tra Redis revoked \u0110\u1ed3ng b\u1ed9 user Khi user ch\u01b0a t\u1ed3n t\u1ea1i \u2192 trigger event sync <p>\ud83d\udce6 D\u00f9ng docker-compose ho\u1eb7c test container mock \u0111\u1ec3 ch\u1ea1y test m\u00f4i tr\u01b0\u1eddng staging.</p>"},{"location":"services/auth-service/sub/design/#84-e2e-tests-qua-api-gateway","title":"\ud83c\udf10 8.4. E2E Tests (qua API Gateway)","text":"<ul> <li>G\u1eedi request t\u1eeb frontend gi\u1ea3 l\u1eadp qua <code>api-gateway</code></li> <li>Test rate-limit, RBAC, header <code>X-Tenant-ID</code>, trace ID</li> <li>Ki\u1ec3m tra to\u00e0n chu\u1ed7i: login \u2192 get token \u2192 logout \u2192 revoked check</li> </ul> <p>\ud83d\udca1 C\u00e1c E2E test quan tr\u1ecdng nh\u1ea5t s\u1ebd \u0111\u01b0\u1ee3c \u0111\u01b0a v\u00e0o <code>smoke test suite</code> khi rollout m\u1ed7i tenant m\u1edbi.</p>"},{"location":"services/auth-service/sub/design/#85-coverage-cicd","title":"\ud83d\udcc8 8.5. Coverage &amp; CI/CD","text":"<ul> <li>Y\u00eau c\u1ea7u coverage &gt; 90% cho domain logic</li> <li>C\u00f3 c\u00e1c t\u1ec7p test \u0111\u1ed9c l\u1eadp theo t\u1eebng t\u1ea7ng: <code>tests/unit/</code>, <code>tests/integration/</code>, <code>tests/contracts/</code></li> <li>C\u00e1c test \u0111\u01b0\u1ee3c ch\u1ea1y tr\u00ean pipeline GitLab CI ho\u1eb7c GitHub Actions, c\u00f3 ki\u1ec3m tra rollback n\u1ebfu fail</li> </ul>"},{"location":"services/auth-service/sub/design/#tong-hop-muc-tieu-kiem-thu","title":"\ud83e\udde9 T\u1ed5ng h\u1ee3p m\u1ee5c ti\u00eau ki\u1ec3m th\u1eed","text":"M\u1ee5c ti\u00eau C\u00f3 ki\u1ec3m th\u1eed? T\u00ednh \u0111\u00fang \u0111\u1eafn (correctness) \u2705 Kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng \u2705 qua test song song tenant \u0110\u1ed9c l\u1eadp tenant \u2705 test per-tenant config Ph\u00e1t hi\u1ec7n l\u1ed7i giao ti\u1ebfp \u2705 qua contract tests Quan s\u00e1t h\u00e0nh vi b\u1ea5t th\u01b0\u1eddng \u2705 th\u00f4ng qua log &amp; mock audit"},{"location":"services/auth-service/sub/design/#9-quan-sat-giam-sat","title":"9. \ud83d\udcc8 Quan s\u00e1t &amp; Gi\u00e1m s\u00e1t","text":"<p><code>auth-service/sub</code> l\u00e0 entrypoint x\u00e1c th\u1ef1c quan tr\u1ecdng, c\u1ea7n \u0111\u01b0\u1ee3c quan s\u00e1t v\u00e0 gi\u00e1m s\u00e1t to\u00e0n di\u1ec7n \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o \u0111\u1ed9 tin c\u1eady, b\u1ea3o m\u1eadt v\u00e0 hi\u1ec7u su\u1ea5t. Chi\u1ebfn l\u01b0\u1ee3c observability c\u1ee7a service tu\u00e2n th\u1ee7 tri\u1ebft l\u00fd \u201c4 tr\u1ee5 c\u1ed9t\u201d:</p> <ul> <li>Logging (Ghi log chu\u1ea9n v\u00e0 c\u00f3 c\u1ea5u tr\u00fac)</li> <li>Metrics (\u0110o l\u01b0\u1eddng \u0111\u1ecbnh l\u01b0\u1ee3ng, d\u00f9ng cho c\u1ea3nh b\u00e1o)</li> <li>Tracing (Theo d\u00f5i chu\u1ed7i request xuy\u00ean service)</li> <li>Audit Logging (L\u01b0u d\u1ea5u v\u1ebft h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng)</li> </ul>"},{"location":"services/auth-service/sub/design/#91-logging-structured-log","title":"\ud83e\udeb5 9.1. Logging (Structured Log)","text":"<ul> <li>M\u1ecdi log ph\u1ea3i \u1edf \u0111\u1ecbnh d\u1ea1ng JSON \u0111\u1ec3 c\u00f3 th\u1ec3 ph\u00e2n t\u00edch t\u1eadp trung</li> <li>Log ph\u1ea3i bao g\u1ed3m \u00edt nh\u1ea5t c\u00e1c tr\u01b0\u1eddng sau:</li> </ul> <pre><code>{\n  \"timestamp\": \"2025-06-13T10:00:00Z\",\n  \"level\": \"INFO\",\n  \"tenant_id\": \"school-abc\",\n  \"trace_id\": \"abc123\",\n  \"module\": \"otp_login\",\n  \"message\": \"OTP verified successfully\",\n  \"user_id\": \"user-xyz\"\n}\n</code></pre> <p>\ud83d\udccd D\u00f9ng <code>loguru</code>, <code>structlog</code> ho\u1eb7c t\u01b0\u01a1ng \u0111\u01b0\u01a1ng, log t\u1eadp trung qua <code>Fluent Bit \u2192 Loki / ELK</code>.</p>"},{"location":"services/auth-service/sub/design/#92-metrics-prometheus","title":"\ud83d\udcca 9.2. Metrics (Prometheus)","text":"<p>D\u1ecbch v\u1ee5 expose <code>/metrics</code> theo chu\u1ea9n Prometheus, g\u1ed3m c\u00e1c metric ch\u00ednh:</p> T\u00ean Metric M\u00f4 t\u1ea3 Nh\u00e3n k\u00e8m theo <code>auth_login_total</code> T\u1ed5ng s\u1ed1 l\u01b0\u1ee3t login (OTP + Local) <code>tenant_id</code>, <code>method</code>, <code>status</code> <code>otp_sent_total</code> S\u1ed1 l\u01b0\u1ee3ng OTP g\u1eedi \u0111i <code>channel=email/sms</code>, <code>tenant_id</code> <code>session_created_total</code> Phi\u00ean \u0111\u0103ng nh\u1eadp th\u00e0nh c\u00f4ng <code>tenant_id</code>, <code>method</code> <code>login_failed_total</code> Login th\u1ea5t b\u1ea1i <code>reason</code>, <code>tenant_id</code> <code>external_call_latency_seconds</code> Th\u1eddi gian g\u1ecdi c\u00e1c service kh\u00e1c <code>target=token/user/audit</code> <p>\ud83d\udea8 C\u1ea3nh b\u00e1o \u0111i k\u00e8m (Alert Rules): - T\u0103ng \u0111\u1ed9t bi\u1ebfn <code>login_failed_total</code> - S\u1ed1 OTP g\u1eedi v\u01b0\u1ee3t ng\u01b0\u1ee1ng trong th\u1eddi gian ng\u1eafn - Token issue latency v\u01b0\u1ee3t SLA (&gt;300ms)</p>"},{"location":"services/auth-service/sub/design/#93-tracing-distributed-trace","title":"\ud83d\udd0d 9.3. Tracing (Distributed Trace)","text":"<ul> <li>T\u00edch h\u1ee3p OpenTelemetry \u0111\u1ec3 trace to\u00e0n b\u1ed9 chu\u1ed7i login</li> <li>M\u1ed7i request \u0111\u1ec1u \u0111\u00ednh k\u00e8m:</li> <li><code>X-Trace-ID</code>: UUID to\u00e0n chu\u1ed7i</li> <li><code>X-Span-ID</code>: ID ri\u00eang cho m\u1ed7i d\u1ecbch v\u1ee5</li> <li>Trace g\u1eedi v\u1ec1 h\u1ec7 th\u1ed1ng nh\u01b0 <code>Jaeger</code>, <code>Tempo</code>, <code>Honeycomb</code></li> </ul> <p>V\u00ed d\u1ee5 trace: <pre><code>FE \u2192 Gateway \u2192 AuthSub \u2192 TokenService \u2192 UserService \u2192 AuditLog\n</code></pre></p>"},{"location":"services/auth-service/sub/design/#94-audit-logging","title":"\ud83d\udcda 9.4. Audit Logging","text":"<p>Tu\u00e2n theo <code>adr-008</code>, m\u1ecdi h\u00e0nh vi x\u00e1c th\u1ef1c \u0111\u1ec1u ghi log v\u00e0o h\u1ec7 th\u1ed1ng <code>audit-logging-service</code>.</p> S\u1ef1 ki\u1ec7n audit Khi n\u00e0o ghi? Tr\u01b0\u1eddng b\u1eaft bu\u1ed9c <code>auth.token.issued</code> Khi login th\u00e0nh c\u00f4ng <code>user_id</code>, <code>login_method</code>, <code>ip</code>, <code>device</code>, <code>trace_id</code> <code>auth.token.revoked</code> Khi logout <code>session_id</code>, <code>revoked_by</code>, <code>reason</code> <code>auth.login.failed</code> Khi login sai <code>reason</code>, <code>tenant_id</code>, <code>trace_id</code> <p>\u26a0\ufe0f Audit log c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c xu\u1ea5t sang file ri\u00eang bi\u1ec7t ho\u1eb7c stream qua Pub/Sub t\u00f9y theo thi\u1ebft l\u1eadp tenant.</p>"},{"location":"services/auth-service/sub/design/#95-observability-by-tenant","title":"\ud83e\uddea 9.5. Observability by tenant","text":"<ul> <li>M\u1ed7i tenant c\u00f3 th\u1ec3 c\u00f3 dashboard Prometheus/Grafana ri\u00eang</li> <li>M\u1ecdi alert rule \u0111\u1ec1u g\u1eafn <code>tenant_id</code> \u0111\u1ec3 t\u00e1ch bi\u1ec7t k\u00eanh c\u1ea3nh b\u00e1o</li> <li>C\u00e1c dashboard g\u1ed3m:</li> <li>T\u1ec9 l\u1ec7 th\u00e0nh c\u00f4ng OTP/Login</li> <li>S\u1ed1 l\u01b0\u1ee3ng login theo ng\u00e0y</li> <li>Th\u1eddi gian trung b\u00ecnh c\u1ea5p token</li> </ul> <p>\ud83d\udc49 \u0110\u1ea3m b\u1ea3o observability kh\u00f4ng ch\u1ec9 ph\u1ee5c v\u1ee5 v\u1eadn h\u00e0nh, m\u00e0 c\u00f2n l\u00e0 m\u1ed9t ph\u1ea7n quan tr\u1ecdng \u0111\u1ec3 \u0111\u00e1nh gi\u00e1 b\u1ea3o m\u1eadt v\u00e0 ch\u1ea5t l\u01b0\u1ee3ng tr\u1ea3i nghi\u1ec7m ng\u01b0\u1eddi d\u00f9ng.</p>"},{"location":"services/auth-service/sub/design/#10-o-tin-cay-phuc-hoi","title":"10. \ud83d\ude80 \u0110\u1ed9 tin c\u1eady &amp; Ph\u1ee5c h\u1ed3i","text":"<p><code>auth-service/sub</code> \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf \u0111\u1ec3 \u0111\u1ea1t \u0111\u1ed9 tin c\u1eady cao trong m\u00f4i tr\u01b0\u1eddng multi-tenant, \u0111\u1ea3m b\u1ea3o d\u1ecbch v\u1ee5 lu\u00f4n s\u1eb5n s\u00e0ng ph\u1ee5c v\u1ee5 ng\u01b0\u1eddi d\u00f9ng \u0111\u1ea7u cu\u1ed1i nh\u01b0 h\u1ecdc sinh, gi\u00e1o vi\u00ean v\u00e0 nh\u00e2n vi\u00ean trong c\u00e1c tr\u01b0\u1eddng th\u00e0nh vi\u00ean c\u1ee7a h\u1ec7 th\u1ed1ng VAS.</p>"},{"location":"services/auth-service/sub/design/#101-stateless-va-scale-ngang","title":"\ud83e\uddf1 10.1. Stateless v\u00e0 Scale ngang","text":"<ul> <li>D\u1ecbch v\u1ee5 ho\u00e0n to\u00e0n stateless \u2013 m\u1ecdi tr\u1ea1ng th\u00e1i ng\u01b0\u1eddi d\u00f9ng (token, session) \u0111\u01b0\u1ee3c l\u01b0u t\u1ea1i Redis ho\u1eb7c PostgreSQL</li> <li>H\u1ed7 tr\u1ee3 horizontal scaling th\u00f4ng qua autoscaler (HPA), ph\u00f9 h\u1ee3p v\u1edbi m\u00f4 h\u00ecnh burst load nh\u01b0 \u0111\u0103ng nh\u1eadp gi\u1edd cao \u0111i\u1ec3m</li> </ul>"},{"location":"services/auth-service/sub/design/#102-retry-idempotency","title":"\u267b\ufe0f 10.2. Retry &amp; Idempotency","text":"T\u00e1c v\u1ee5 C\u01a1 ch\u1ebf ph\u1ee5c h\u1ed3i G\u1ecdi <code>token-service</code> T\u1ef1 \u0111\u1ed9ng retry 3 l\u1ea7n (backoff: 200ms \u2192 500ms) G\u1eedi audit log Retry qua h\u00e0ng ch\u1edd n\u1ed9i b\u1ed9 (async background task) \u0110\u1ed3ng b\u1ed9 user G\u1eedi 1 l\u1ea7n, n\u1ebfu l\u1ed7i ghi v\u00e0o dead-letter queue \u0111\u1ec3 x\u1eed l\u00fd sau G\u1eedi OTP N\u1ebfu l\u1ed7i nh\u00e0 cung c\u1ea5p, cho retry t\u1ed1i \u0111a 2 l\u1ea7n qua k\u00eanh kh\u00e1c <p>\ud83e\uddea C\u00e1c API g\u1ecdi outbound ph\u1ea3i idempotent, \u0111\u1eb7c bi\u1ec7t l\u00e0 <code>user.sync</code>, <code>token.issue</code>, \u0111\u1ea3m b\u1ea3o kh\u00f4ng t\u1ea1o session tr\u00f9ng n\u1ebfu frontend resend request.</p>"},{"location":"services/auth-service/sub/design/#103-gioi-han-loi-co-lap-tenant","title":"\ud83d\udca5 10.3. Gi\u1edbi h\u1ea1n l\u1ed7i &amp; c\u00f4 l\u1eadp tenant","text":"<ul> <li>N\u1ebfu m\u1ed9t tenant g\u1eb7p l\u1ed7i (v\u00ed d\u1ee5 c\u1ea5u h\u00ecnh sai Redis), ch\u1ec9 tenant \u0111\u00f3 b\u1ecb \u1ea3nh h\u01b0\u1edfng \u2192 kh\u00f4ng lan sang tenant kh\u00e1c</li> <li>M\u1ed7i tenant ch\u1ea1y instance ri\u00eang ho\u1eb7c ph\u00e2n v\u00f9ng theo namespace</li> </ul>"},{"location":"services/auth-service/sub/design/#104-circuit-breaker-timeout","title":"\ud83d\udee0 10.4. Circuit Breaker &amp; Timeout","text":"<ul> <li>Circuit breaker b\u1eadt n\u1ebfu t\u1ef7 l\u1ec7 l\u1ed7i v\u01b0\u1ee3t 20% trong 1 ph\u00fat cho t\u1eebng external service</li> <li>Timeout ti\u00eau chu\u1ea9n:</li> <li><code>token-service</code>: 3s</li> <li><code>user-service</code>: 2s</li> <li><code>notification-service</code>: 2s</li> <li>N\u1ebfu qu\u00e1 timeout \u2192 ghi log v\u00e0 tr\u1ea3 l\u1ed7i chu\u1ea9n <code>auth.external_timeout</code> (ErrorEnvelope)</li> </ul>"},{"location":"services/auth-service/sub/design/#105-slaslo","title":"\u23f1 10.5. SLA/SLO","text":"Lo\u1ea1i M\u1ee9c cam k\u1ebft SLA uptime \u2265 99.95%/th\u00e1ng Token issue latency (p95) \u2264 300ms OTP delivery time (p95) \u2264 5s Login success rate \u2265 98% (v\u1edbi OTP \u0111\u00fang) <p>C\u00e1c ch\u1ec9 s\u1ed1 n\u00e0y \u0111\u01b0\u1ee3c monitor qua Prometheus, v\u00e0 b\u00e1o c\u00e1o theo tenant.</p>"},{"location":"services/auth-service/sub/design/#106-rollback-zero-downtime","title":"\ud83d\udea8 10.6. Rollback &amp; Zero Downtime","text":"<ul> <li>Tu\u00e2n th\u1ee7 <code>adr-014</code>: s\u1eed d\u1ee5ng rolling update, kh\u00f4ng x\u00f3a container c\u0169 cho \u0111\u1ebfn khi container m\u1edbi s\u1eb5n s\u00e0ng</li> <li>S\u1eed d\u1ee5ng <code>readinessProbe</code>, <code>livenessProbe</code> \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o ch\u1ec9 ph\u1ee5c v\u1ee5 request khi s\u1eb5n s\u00e0ng</li> <li>N\u1ebfu phi\u00ean b\u1ea3n m\u1edbi b\u1ecb l\u1ed7i:</li> <li>Rollback t\u1ef1 \u0111\u1ed9ng trong 30s</li> <li>Alert cho DevOps n\u1ebfu 3 l\u1ea7n rollout li\u00ean ti\u1ebfp th\u1ea5t b\u1ea1i</li> </ul>"},{"location":"services/auth-service/sub/design/#107-recovery-tu-loi-nghiem-trong","title":"\ud83e\uddef 10.7. Recovery t\u1eeb l\u1ed7i nghi\u00eam tr\u1ecdng","text":"T\u00ecnh hu\u1ed1ng Ph\u1ee5c h\u1ed3i Redis cache down D\u1ecbch v\u1ee5 v\u1eabn ho\u1ea1t \u0111\u1ed9ng nh\u01b0ng kh\u00f4ng ki\u1ec3m tra revoked token; b\u00e1o \u0111\u1ed9ng c\u1ea3nh b\u00e1o PostgreSQL downtime Kh\u00f4ng th\u1ec3 ghi session \u2192 v\u1eabn c\u1ea5p JWT \u2192 \u0111\u1ed3ng b\u1ed9 l\u1ea1i khi DB tr\u1edf l\u1ea1i G\u1ecdi audit-service fail L\u01b0u log c\u1ee5c b\u1ed9 \u0111\u1ec3 g\u1eedi l\u1ea1i sau Token-service kh\u00f4ng ph\u1ea3n h\u1ed3i Tr\u1ea3 l\u1ed7i <code>token.issuer_unavailable</code>, hi\u1ec3n th\u1ecb UI retry cho ng\u01b0\u1eddi d\u00f9ng <p>\u2705 T\u00f3m l\u1ea1i, <code>auth-service/sub</code> \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf \u0111\u1ec3 ch\u1ecbu l\u1ed7i, kh\u00f4i ph\u1ee5c t\u1ef1 \u0111\u1ed9ng, c\u00f4 l\u1eadp tenant v\u00e0 \u0111\u1ea3m b\u1ea3o ho\u1ea1t \u0111\u1ed9ng li\u00ean t\u1ee5c trong \u0111i\u1ec1u ki\u1ec7n th\u1ef1c t\u1ebf nhi\u1ec1u bi\u1ebfn \u0111\u1ed9ng.</p>"},{"location":"services/auth-service/sub/design/#11-hieu-nang-kha-nang-mo-rong","title":"11. \u26a1\ufe0f Hi\u1ec7u n\u0103ng &amp; Kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng","text":"<p><code>auth-service/sub</code> \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf v\u1edbi m\u1ee5c ti\u00eau hi\u1ec7u n\u0103ng cao, \u0111\u1ed9 tr\u1ec5 th\u1ea5p v\u00e0 c\u00f3 th\u1ec3 scale \u0111\u1ed9c l\u1eadp theo t\u1eebng tenant. D\u1ecbch v\u1ee5 ho\u1ea1t \u0111\u1ed9ng ho\u00e0n to\u00e0n stateless, t\u1eadn d\u1ee5ng caching, pub/sub v\u00e0 c\u1ea5u tr\u00fac microservice \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o kh\u1ea3 n\u0103ng ph\u1ee5c v\u1ee5 \u0111\u1ed3ng th\u1eddi h\u00e0ng ng\u00e0n phi\u00ean \u0111\u0103ng nh\u1eadp m\u1ed7i ph\u00fat.</p>"},{"location":"services/auth-service/sub/design/#kien-truc-hieu-nang-cao","title":"\u2699\ufe0f Ki\u1ebfn tr\u00fac hi\u1ec7u n\u0103ng cao","text":"Th\u00e0nh ph\u1ea7n T\u1ed1i \u01b0u hi\u1ec7u n\u0103ng Stateless design Cho ph\u00e9p scale ngang d\u1ec5 d\u00e0ng qua HPA Redis cache L\u01b0u OTP, token revoked, limiter \u2192 gi\u1ea3m t\u1ea3i DB Background task G\u1eedi log, audit, sync user th\u1ef1c hi\u1ec7n b\u1ea5t \u0111\u1ed3ng b\u1ed9 Timeout &amp; Circuit Breaker Gi\u1ea3m t\u1eafc ngh\u1ebdn do dependency ngo\u1ea1i vi Kh\u00f4ng \u0111\u1ed3ng b\u1ed9 ho\u00e1 user blocking X\u00e1c th\u1ef1c kh\u00f4ng b\u1ecb ch\u1eb7n khi ch\u01b0a c\u00f3 user (sync async)"},{"location":"services/auth-service/sub/design/#kha-nang-mo-rong-theo-tenant","title":"\ud83d\ude80 Kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng theo tenant","text":"<ul> <li>M\u1ed7i tenant \u0111\u01b0\u1ee3c deploy theo instance ho\u1eb7c namespace ri\u00eang</li> <li>C\u00f3 th\u1ec3 \u0111i\u1ec1u ch\u1ec9nh autoscale, resource limit theo nhu c\u1ea7u t\u1eebng tenant</li> <li>T\u00e1ch queue Pub/Sub v\u00e0 cache Redis ri\u00eang \u2192 tr\u00e1nh \u201cnoisy neighbor\u201d</li> </ul> <pre><code>graph TD\n  Tenant1(AuthSub1) --&gt;|Redis1| RedisCluster\n  Tenant2(AuthSub2) --&gt;|Redis2| RedisCluster\n  Tenant3(AuthSub3) --&gt;|Redis3| RedisCluster\n</code></pre> <p>\ud83d\udccc C\u00f3 th\u1ec3 gom nhi\u1ec1u tenant c\u00f3 traffic th\u1ea5p v\u00e0o m\u1ed9t c\u1ee5m n\u1ebfu c\u1ea7n t\u1ed1i \u01b0u t\u00e0i nguy\u00ean, nh\u01b0ng ph\u1ea3i b\u1ea3o \u0111\u1ea3m <code>tenant_id</code> \u0111\u01b0\u1ee3c c\u00e1ch ly logic.</p>"},{"location":"services/auth-service/sub/design/#cac-chi-so-theo-doi-hieu-nang","title":"\ud83d\udcc8 C\u00e1c ch\u1ec9 s\u1ed1 theo d\u00f5i hi\u1ec7u n\u0103ng","text":"Metric Ng\u01b0\u1ee1ng \u0111\u1ec1 xu\u1ea5t (p95) <code>otp_delivery_duration_seconds</code> \u2264 5s <code>token_issue_duration_seconds</code> \u2264 300ms <code>session_write_duration_seconds</code> \u2264 200ms <code>auth_login_total</code> \u2265 2000 req/minute (burst) <p>T\u1ea5t c\u1ea3 c\u00e1c ch\u1ec9 s\u1ed1 \u0111\u01b0\u1ee3c theo d\u00f5i qua Prometheus v\u00e0 dashboard ri\u00eang cho t\u1eebng tenant.</p>"},{"location":"services/auth-service/sub/design/#gioi-han-va-bao-ve","title":"\u26d3 Gi\u1edbi h\u1ea1n v\u00e0 b\u1ea3o v\u1ec7","text":"C\u01a1 ch\u1ebf M\u1ee5c ti\u00eau Rate-limit theo IP / user Tr\u00e1nh brute-force OTP resend throttle Gi\u1ea3m spam qua notification service Retry + backoff Tr\u00e1nh overloading backend (token/user service) Liveness &amp; readiness probe \u0110\u1ea3m b\u1ea3o ch\u1ec9 nh\u1eadn request khi s\u1eb5n s\u00e0ng"},{"location":"services/auth-service/sub/design/#benchmark-e-xuat","title":"\ud83e\uddea Benchmark \u0111\u1ec1 xu\u1ea5t","text":"K\u1ecbch b\u1ea3n M\u00f4i tr\u01b0\u1eddng test K\u1ebft qu\u1ea3 1,000 OTP requests/min 2 pods, Redis local 97% request \u2264 500ms 500 concurrent login PostgreSQL shard per tenant 99.9% success Redis m\u1ea5t k\u1ebft n\u1ed1i Fallback ghi log, audit async Kh\u00f4ng m\u1ea5t session"},{"location":"services/auth-service/sub/design/#inh-huong-toi-uu-tiep-theo","title":"\ud83e\udde9 \u0110\u1ecbnh h\u01b0\u1edbng t\u1ed1i \u01b0u ti\u1ebfp theo","text":"<ul> <li>D\u00f9ng JWT v\u1edbi short TTL + sliding session \u0111\u1ec3 gi\u1ea3m revoked lookup</li> <li>Caching result c\u1ee7a OTP validate \u0111\u1ec3 gi\u1ea3m DB hit n\u1ebfu resend</li> <li>Gom lu\u1ed3ng audit log th\u00e0nh batch \u0111\u1ec3 g\u1eedi hi\u1ec7u qu\u1ea3 h\u01a1n</li> </ul> <p>\u2705 T\u1ed5ng k\u1ebft: <code>auth-service/sub</code> c\u00f3 th\u1ec3 m\u1edf r\u1ed9ng linh ho\u1ea1t theo tenant, \u0111\u1ea3m b\u1ea3o ph\u1ee5c v\u1ee5 t\u1ed1t c\u00e1c h\u1ec7 th\u1ed1ng tr\u01b0\u1eddng l\u1edbn nh\u1ecf v\u1edbi chi ph\u00ed h\u1ea1 t\u1ea7ng t\u1ed1i \u01b0u, \u0111\u1ed9 tr\u1ec5 th\u1ea5p v\u00e0 \u0111\u1ed9 s\u1eb5n s\u00e0ng cao.</p>"},{"location":"services/auth-service/sub/design/#12-ke-hoach-trien-khai-migration","title":"12. \ud83d\udee0 K\u1ebf ho\u1ea1ch Tri\u1ec3n khai &amp; Migration","text":"<p>Vi\u1ec7c tri\u1ec3n khai <code>auth-service/sub</code> tu\u00e2n theo chi\u1ebfn l\u01b0\u1ee3c tri\u1ec3n khai theo tenant \u0111\u1ed9c l\u1eadp, k\u1ebft h\u1ee3p versioning linh ho\u1ea1t v\u00e0 kh\u1ea3 n\u0103ng migration an to\u00e0n nh\u1eb1m \u0111\u1ea3m b\u1ea3o zero downtime v\u00e0 kh\u00f4ng \u1ea3nh h\u01b0\u1edfng d\u1eef li\u1ec7u x\u00e1c th\u1ef1c.</p>"},{"location":"services/auth-service/sub/design/#chien-luoc-trien-khai","title":"\ud83d\ude80 Chi\u1ebfn l\u01b0\u1ee3c tri\u1ec3n khai","text":"\u0110\u1eb7c \u0111i\u1ec3m C\u00e1ch tri\u1ec3n khai Per-tenant deployment M\u1ed7i tenant \u0111\u01b0\u1ee3c deploy d\u01b0\u1edbi namespace ri\u00eang ho\u1eb7c chart release ri\u00eang Rolling update \u00c1p d\u1ee5ng tr\u00ean t\u1eebng tenant \u0111\u1ec3 gi\u1ea3m r\u1ee7i ro \u1ea3nh h\u01b0\u1edfng di\u1ec7n r\u1ed9ng Blue/Green ho\u1eb7c Canary (tu\u1ef3 tenant l\u1edbn) \u0110\u1eb7c bi\u1ec7t v\u1edbi tr\u01b0\u1eddng l\u1edbn c\u00f3 h\u01a1n 5,000 ng\u01b0\u1eddi d\u00f9ng Helm chart D\u00f9ng Helm v\u1edbi gi\u00e1 tr\u1ecb ri\u00eang theo tenant (<code>values/tenant-name.yaml</code>) Auto-scaling b\u1eadt sau deploy th\u00e0nh c\u00f4ng Tr\u00e1nh scale s\u1edbm g\u00e2y t\u1ea1o pod ch\u01b0a s\u1eb5n s\u00e0ng <pre><code>helm upgrade --install auth-sub-school-abc ./charts/auth-sub -f values/school-abc.yaml\n</code></pre>"},{"location":"services/auth-service/sub/design/#chinh-sach-versioning-theo-tenant","title":"\ud83e\udde9 Ch\u00ednh s\u00e1ch versioning theo tenant","text":"<p>Tu\u00e2n th\u1ee7 <code>adr-025</code>, m\u1ed7i tenant c\u00f3 th\u1ec3 s\u1eed d\u1ee5ng phi\u00ean b\u1ea3n service kh\u00e1c nhau, \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd theo semver:</p> Tenant Version L\u00fd do kh\u00e1c bi\u1ec7t <code>school-abc</code> v1.2.0 S\u1eed d\u1ee5ng t\u00ednh n\u0103ng multi-factor <code>school-xyz</code> v1.1.5 D\u1eebng \u1edf phi\u00ean b\u1ea3n \u1ed5n \u0111\u1ecbnh <code>school-test</code> v1.3.0-beta Tri\u1ec3n khai th\u1eed nghi\u1ec7m t\u00ednh n\u0103ng m\u1edbi <p>C\u00e1c version \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd qua Helm tag + image tag, \u0111\u01b0\u1ee3c ki\u1ec3m tra t\u1ef1 \u0111\u1ed9ng tr\u01b0\u1edbc khi c\u1eadp nh\u1eadt di\u1ec7n r\u1ed9ng.</p>"},{"location":"services/auth-service/sub/design/#ke-hoach-migration-schema","title":"\ud83d\udd01 K\u1ebf ho\u1ea1ch migration schema","text":"Th\u00e0nh ph\u1ea7n C\u01a1 ch\u1ebf migration <code>auth_sessions</code> table Flyway / Alembic / Prisma <code>revoked_tokens</code> cache Kh\u00f4ng c\u1ea7n migration, TTL t\u1ef1 qu\u1ea3n l\u00fd <code>OTP config</code> D\u00f9ng gi\u00e1 tr\u1ecb m\u1eb7c \u0111\u1ecbnh n\u1ebfu ch\u01b0a c\u00f3 <code>Secrets</code> Inject qua Vault ho\u1eb7c Kubernetes Secret, kh\u00f4ng c\u1ea7n thay \u0111\u1ed5i <p>Tu\u00e2n th\u1ee7 <code>adr-023</code>, m\u1ecdi migration \u0111\u1ec1u ph\u1ea3i: - C\u00f3 version ki\u1ec3m so\u00e1t - C\u00f3 backup snapshot tr\u01b0\u1edbc khi apply - C\u00f3 rollback script \u0111i k\u00e8m</p>"},{"location":"services/auth-service/sub/design/#phuc-hoi-neu-deployment-loi","title":"\u26d1 Ph\u1ee5c h\u1ed3i n\u1ebfu deployment l\u1ed7i","text":"Giai \u0111o\u1ea1n Bi\u1ec7n ph\u00e1p ph\u1ee5c h\u1ed3i Sau apply Helm l\u1ed7i Rollback chart <code>helm rollback</code> DB migration l\u1ed7i Rollback schema b\u1eb1ng snapshot Token-service ho\u1eb7c Redis kh\u00f4ng s\u1eb5n s\u00e0ng Kh\u00f4ng kh\u1edfi ch\u1ea1y pod (fail readiness probe)"},{"location":"services/auth-service/sub/design/#checklist-trien-khai-tenant-moi","title":"\ud83d\udccb Checklist tri\u1ec3n khai tenant m\u1edbi","text":"<ol> <li>T\u1ea1o file c\u1ea5u h\u00ecnh <code>values/tenant-id.yaml</code></li> <li>T\u1ea1o secret Vault ho\u1eb7c Kubernetes t\u01b0\u01a1ng \u1ee9ng</li> <li>Kh\u1edfi t\u1ea1o DB v\u1edbi <code>auth_sessions</code> table</li> <li>Apply Helm chart</li> <li>Ki\u1ec3m th\u1eed login flow (OTP &amp; Local)</li> <li>K\u00edch ho\u1ea1t autoscaler n\u1ebfu load th\u1ef1c t\u1ebf cao</li> <li>Gi\u00e1m s\u00e1t metrics &amp; alert trong 24h \u0111\u1ea7u</li> <li>B\u00e0n giao cho qu\u1ea3n tr\u1ecb vi\u00ean tenant</li> </ol>"},{"location":"services/auth-service/sub/design/#mo-phong-deploy-mass-multi-tenant","title":"\ud83e\uddea M\u00f4 ph\u1ecfng deploy mass multi-tenant","text":"<ul> <li>K\u1ecbch b\u1ea3n: deploy 50 tenants song song</li> <li>M\u1ed7i tenant deploy m\u1ea5t ~8s</li> <li>T\u1ed5ng th\u1eddi gian rollout &lt; 7 ph\u00fat</li> <li>Kh\u00f4ng c\u00f3 downtime \u1edf c\u00e1c tenant \u0111ang ho\u1ea1t \u0111\u1ed9ng</li> </ul> <p>\u2705 K\u1ebft lu\u1eadn: <code>auth-service/sub</code> h\u1ed7 tr\u1ee3 tri\u1ec3n khai linh ho\u1ea1t, c\u00f4 l\u1eadp r\u1ee7i ro, rollback d\u1ec5 d\u00e0ng, v\u00e0 m\u1edf r\u1ed9ng t\u1eebng tenant theo nhu c\u1ea7u th\u1ef1c t\u1ebf.</p>"},{"location":"services/auth-service/sub/design/#13-kien-truc-service","title":"13. \ud83e\udde9 Ki\u1ebfn tr\u00fac Service","text":"<p><code>auth-service/sub</code> \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf theo m\u00f4 h\u00ecnh microservice hi\u1ec7n \u0111\u1ea1i, ho\u00e0n to\u00e0n stateless, t\u1ed1i \u01b0u cho tri\u1ec3n khai \u0111a tenant v\u00e0 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng \u0111\u1ed9c l\u1eadp theo t\u1eebng tenant.</p>"},{"location":"services/auth-service/sub/design/#kien-truc-noi-tai-internal-architecture","title":"\ud83c\udfd7 Ki\u1ebfn tr\u00fac n\u1ed9i t\u1ea1i (Internal Architecture)","text":"<pre><code>graph LR\n  GW[API Gateway] --&gt; SRV(Auth Service Sub)\n  SRV --&gt; OTP[OTP Module]\n  SRV --&gt; LOCAL[Local Login Module]\n  SRV --&gt; TS[Token Service]\n  SRV --&gt; US[User Service]\n  SRV --&gt; AUD[Audit Logging]\n  SRV --&gt; REDIS[Redis Cache]\n  SRV --&gt; PG[PostgreSQLauth_sessions]\n</code></pre>"},{"location":"services/auth-service/sub/design/#cac-thanh-phan-chinh","title":"\ud83e\udde9 C\u00e1c th\u00e0nh ph\u1ea7n ch\u00ednh","text":"Th\u00e0nh ph\u1ea7n Vai tr\u00f2 <code>OTP Module</code> X\u00e1c minh OTP, gi\u1edbi h\u1ea1n s\u1ed1 l\u1ea7n, tracking resend <code>Local Login Module</code> Ki\u1ec3m tra username/password b\u1eb1ng bcrypt <code>Session Tracker</code> Ghi l\u1ea1i phi\u00ean \u0111\u0103ng nh\u1eadp v\u00e0o DB <code>Token Proxy</code> G\u1ecdi <code>token-service</code> \u0111\u1ec3 issue/revoke token <code>User Sync Agent</code> Trigger sync n\u1ebfu user ch\u01b0a t\u1ed3n t\u1ea1i <code>Audit Logger</code> G\u1eedi s\u1ef1 ki\u1ec7n \u0111\u0103ng nh\u1eadp v\u00e0o Pub/Sub ho\u1eb7c audit-log <code>Redis Adapter</code> L\u01b0u OTP, revoked token, rate-limit counter"},{"location":"services/auth-service/sub/design/#kien-truc-trien-khai-deployment-architecture","title":"\ud83e\uddf1 Ki\u1ebfn tr\u00fac tri\u1ec3n khai (Deployment Architecture)","text":"<pre><code>flowchart TD\n  subgraph Tenant A\n    A1[auth-service/sub:v1.2.0]\n    A2[Postgres A]\n    A3[Redis A]\n  end\n\n  subgraph Tenant B\n    B1[auth-service/sub:v1.1.5]\n    B2[Postgres B]\n    B3[Redis B]\n  end\n\n  GW[API Gateway] --&gt;|X-Tenant-ID: A| A1\n  GW --&gt;|X-Tenant-ID: B| B1\n</code></pre> <ul> <li>M\u1ed7i tenant c\u00f3 th\u1ec3 ch\u1ea1y m\u1ed9t phi\u00ean b\u1ea3n kh\u00e1c nhau</li> <li>Redis v\u00e0 Postgres c\u00f3 th\u1ec3 t\u00e1ch ri\u00eang ho\u1eb7c d\u00f9ng c\u00f9ng Redis cluster ph\u00e2n v\u00f9ng theo <code>tenant_id</code></li> <li>T\u1ea5t c\u1ea3 giao ti\u1ebfp ra b\u00ean ngo\u00e0i \u0111\u1ec1u d\u00f9ng n\u1ed9i b\u1ed9 (<code>cluster.local</code>) v\u00e0 b\u1ea3o v\u1ec7 b\u1eb1ng HMAC ho\u1eb7c mTLS</li> </ul>"},{"location":"services/auth-service/sub/design/#quy-tac-thiet-ke","title":"\ud83e\udde0 Quy t\u1eafc thi\u1ebft k\u1ebf","text":"Nguy\u00ean t\u1eafc \u00c1p d\u1ee5ng Separation of Concern X\u00e1c th\u1ef1c logic t\u00e1ch kh\u1ecfi token issuance Single Responsibility Kh\u00f4ng ki\u1ec3m tra RBAC, kh\u00f4ng l\u01b0u user detail Observability First G\u1eafn trace_id, audit m\u1ecdi h\u00e0nh vi Per-tenant Isolation C\u1ea5u h\u00ecnh, secret, DB t\u00e1ch bi\u1ec7t Zero Downtime Ready readinessProbe, rolling update chu\u1ea9n ADR-014"},{"location":"services/auth-service/sub/design/#thu-muc-ma-nguon-goi-y","title":"\ud83d\udce6 Th\u01b0 m\u1ee5c m\u00e3 ngu\u1ed3n (g\u1ee3i \u00fd)","text":"<pre><code>auth-service-sub/\n\u251c\u2500\u2500 main.py\n\u251c\u2500\u2500 config/          # Load c\u1ea5u h\u00ecnh theo tenant\n\u251c\u2500\u2500 routes/          # OTP, local login, logout\n\u251c\u2500\u2500 services/        # Giao ti\u1ebfp token, user, audit\n\u251c\u2500\u2500 models/          # DB model cho auth_sessions\n\u251c\u2500\u2500 schemas/         # Request/response schema\n\u251c\u2500\u2500 utils/           # Helper extract metadata, hashing\n\u251c\u2500\u2500 tests/\n\u2502   \u251c\u2500\u2500 unit/\n\u2502   \u251c\u2500\u2500 integration/\n\u2502   \u2514\u2500\u2500 contract/\n</code></pre> <p>\u2705 K\u1ebft lu\u1eadn: Ki\u1ebfn tr\u00fac c\u1ee7a <code>auth-service/sub</code> \u0111\u01b0\u1ee3c t\u1ed1i \u01b0u \u0111\u1ec3 v\u1eadn h\u00e0nh tin c\u1eady, t\u00e1ch bi\u1ec7t r\u1ee7i ro, d\u1ec5 quan s\u00e1t v\u00e0 scale hi\u1ec7u qu\u1ea3 tr\u00ean m\u00f4i tr\u01b0\u1eddng multi-tenant.</p>"},{"location":"services/auth-service/sub/design/#14-tai-lieu-lien-quan","title":"14. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Interface Contract</li> <li>Data Model</li> <li>OpenAPI Spec</li> <li>ADR-006 - Auth Strategy</li> <li>ADR-007 - RBAC</li> <li>rbac-deep-dive.md</li> </ul>"},{"location":"services/auth-service/sub/interface-contract/","title":"\ud83d\udcd8 Auth Service Sub \u2013 Interface Contract","text":""},{"location":"services/auth-service/sub/interface-contract/#1-muc-tieu-pham-vi-tai-lieu","title":"1. \ud83c\udfaf M\u1ee5c ti\u00eau &amp; Ph\u1ea1m vi t\u00e0i li\u1ec7u","text":"<p>T\u00e0i li\u1ec7u n\u00e0y \u0111\u1ecbnh ngh\u0129a r\u00f5 c\u00e1c h\u1ee3p \u0111\u1ed3ng giao ti\u1ebfp (interface contract) c\u1ee7a <code>auth-service/sub</code> \u2013 m\u1ed9t service ch\u1ecbu tr\u00e1ch nhi\u1ec7m x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng theo t\u1eebng tenant, bao g\u1ed3m:</p> <ul> <li>\u0110\u0103ng nh\u1eadp qua OTP ho\u1eb7c t\u00e0i kho\u1ea3n n\u1ed9i b\u1ed9 (Local login)</li> <li>Qu\u1ea3n l\u00fd v\u00f2ng \u0111\u1eddi phi\u00ean \u0111\u0103ng nh\u1eadp (<code>auth_sessions</code>)</li> <li>Thu h\u1ed3i phi\u00ean ho\u1eb7c token \u0111\u00e3 c\u1ea5p</li> <li>Cung c\u1ea5p metadata v\u00e0 audit cho c\u00e1c service kh\u00e1c</li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#muc-tieu-chinh","title":"\ud83c\udfaf M\u1ee5c ti\u00eau ch\u00ednh","text":"<ul> <li>L\u00e0 c\u01a1 s\u1edf ch\u00ednh th\u1ee9c cho vi\u1ec7c tri\u1ec3n khai backend v\u00e0 frontend t\u00edch h\u1ee3p</li> <li>Chu\u1ea9n ho\u00e1 request/response theo OpenAPI</li> <li>\u00c1p d\u1ee5ng c\u00e1c quy t\u1eafc ph\u00e2n quy\u1ec1n v\u00e0 b\u1ea3o m\u1eadt theo chu\u1ea9n <code>RBAC \u0111\u1ed9ng</code></li> <li>L\u00e0m c\u01a1 s\u1edf cho contract testing, CI/CD v\u00e0 monitoring</li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#cac-api-uoc-inh-nghia-tai-ay","title":"\ud83d\udce6 C\u00e1c API \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a t\u1ea1i \u0111\u00e2y","text":"Nh\u00f3m ch\u1ee9c n\u0103ng M\u00f4 t\u1ea3 <code>POST /auth/login</code> \u0110\u0103ng nh\u1eadp ng\u01b0\u1eddi d\u00f9ng (OTP / Local) <code>POST /auth/logout</code> \u0110\u0103ng xu\u1ea5t v\u00e0 thu h\u1ed3i token <code>GET /auth/sessions</code> Truy v\u1ea5n l\u1ecbch s\u1eed phi\u00ean \u0111\u0103ng nh\u1eadp <code>POST /auth/sessions/{id}/revoke</code> Thu h\u1ed3i m\u1ed9t phi\u00ean c\u1ee5 th\u1ec3"},{"location":"services/auth-service/sub/interface-contract/#ngoai-pham-vi-out-of-scope","title":"\ud83d\udeab Ngo\u00e0i ph\u1ea1m vi (Out of Scope)","text":"<p>C\u00e1c ch\u1ee9c n\u0103ng sau kh\u00f4ng n\u1eb1m trong t\u00e0i li\u1ec7u n\u00e0y v\u00e0 \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a \u1edf n\u01a1i kh\u00e1c:</p> Ch\u1ee9c n\u0103ng N\u01a1i \u0111\u1ecbnh ngh\u0129a X\u00e1c th\u1ef1c Google (OAuth2) <code>auth-service/master</code> C\u1ea5p ph\u00e1t JWT token <code>token-service</code> Ki\u1ec3m tra RBAC \u0111\u1ed9ng <code>api-gateway</code> Qu\u1ea3n l\u00fd ng\u01b0\u1eddi d\u00f9ng <code>user-service</code>"},{"location":"services/auth-service/sub/interface-contract/#inh-huong-kien-truc","title":"\ud83e\udded \u0110\u1ecbnh h\u01b0\u1edbng ki\u1ebfn tr\u00fac","text":"<p>T\u00e0i li\u1ec7u n\u00e0y \u0111\u01b0\u1ee3c x\u00e2y d\u1ef1ng d\u1ef1a tr\u00ean nguy\u00ean l\u00fd:</p> <ul> <li>Stateless Service: m\u1ecdi tr\u1ea1ng th\u00e1i phi\u00ean \u0111\u1ec1u externalized</li> <li>Multi-tenant per-instance: m\u1ecdi request b\u1eaft bu\u1ed9c \u0111i k\u00e8m <code>X-Tenant-ID</code></li> <li>RBAC Externalized: m\u1ecdi permission v\u00e0 \u0111i\u1ec1u ki\u1ec7n truy c\u1eadp \u0111\u01b0\u1ee3c x\u1eed l\u00fd t\u1ea1i gateway ho\u1eb7c middleware</li> <li>Auditability: m\u1ecdi h\u00e0nh vi ph\u00e1t sinh \u0111\u1ec1u g\u1eedi s\u1ef1 ki\u1ec7n \u0111\u1ec3 trace v\u00e0 gi\u00e1m s\u00e1t</li> </ul> <p>\ud83d\udccc M\u1ecdi API trong t\u00e0i li\u1ec7u \u0111\u1ec1u \u0111\u1ed3ng b\u1ed9 100% v\u1edbi file OpenAPI (<code>openapi.yaml</code>) c\u1ee7a <code>auth-service/sub</code>.</p>"},{"location":"services/auth-service/sub/interface-contract/#2-chinh-sach-bao-mat-phan-quyen","title":"2. \ud83d\udd10 Ch\u00ednh s\u00e1ch B\u1ea3o m\u1eadt &amp; Ph\u00e2n quy\u1ec1n","text":"<p>To\u00e0n b\u1ed9 c\u00e1c endpoint trong <code>auth-service/sub</code> y\u00eau c\u1ea7u x\u00e1c th\u1ef1c v\u00e0 ph\u00e2n quy\u1ec1n ch\u1eb7t ch\u1ebd d\u1ef1a tr\u00ean:</p> <ul> <li>JWT token \u0111\u01b0\u1ee3c c\u1ea5p t\u1eeb <code>token-service</code></li> <li>X-Tenant-ID \u0111\u1ec3 \u0111\u1ecbnh danh tenant hi\u1ec7n h\u00e0nh</li> <li>Permission \u0111\u1ed9ng (RBAC) \u0111\u1ec3 gi\u1edbi h\u1ea1n quy\u1ec1n truy c\u1eadp theo vai tr\u00f2 v\u00e0 ng\u1eef c\u1ea3nh</li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#21-security-scheme","title":"2.1. \ud83d\udee1 Security Scheme","text":"Th\u00e0nh ph\u1ea7n B\u1eaft bu\u1ed9c Ghi ch\u00fa <code>Authorization</code> header \u2705 D\u1ea1ng Bearer JWT <code>X-Tenant-ID</code> header \u2705 M\u1ecdi request \u0111\u1ec1u ph\u1ea3i x\u00e1c \u0111\u1ecbnh tenant JWT payload \u2705 Ch\u1ee9a <code>user_id</code>, <code>roles</code>, <code>tenant_id</code>\u2026 theo chu\u1ea9n h\u1ec7 th\u1ed1ng <p>\u26a0\ufe0f Token ph\u1ea3i \u0111\u01b0\u1ee3c c\u1ea5p h\u1ee3p l\u1ec7 t\u1eeb <code>token-service</code>, k\u00fd b\u1eb1ng kh\u00f3a <code>RS256</code>.</p>"},{"location":"services/auth-service/sub/interface-contract/#22-co-che-kiem-soat-phan-quyen","title":"2.2. \ud83e\udde9 C\u01a1 ch\u1ebf ki\u1ec3m so\u00e1t ph\u00e2n quy\u1ec1n","text":"<p>H\u1ec7 th\u1ed1ng RBAC theo m\u00f4 h\u00ecnh <code>permission + condition</code>, \u0111\u01b0\u1ee3c x\u1eed l\u00fd ngo\u00e0i service (t\u1ea1i <code>api-gateway</code> ho\u1eb7c middleware) v\u00e0 \u0111\u01b0\u1ee3c ki\u1ec3m tra l\u1ea1i trong audit/logic n\u1ebfu c\u1ea7n.</p>"},{"location":"services/auth-service/sub/interface-contract/#vi-du","title":"V\u00ed d\u1ee5:","text":"<pre><code>\"x-permissions\": [\"session.read:self\"],\n\"x-condition\": {\n  \"user_id\": \"{{current_user.id}}\",\n  \"tenant_id\": \"{{X-Tenant-ID}}\"\n}\n</code></pre>"},{"location":"services/auth-service/sub/interface-contract/#23-bang-mapping-permission","title":"2.3. \ud83d\udccb B\u1ea3ng mapping permission","text":"Endpoint Permission x-condition <code>POST /auth/login</code> <code>auth.login</code> <code>{ \"tenant_id\": \"{{X-Tenant-ID}}\" }</code> <code>POST /auth/logout</code> <code>auth.logout</code> <code>{ \"tenant_id\": \"{{X-Tenant-ID}}\" }</code> <code>GET /auth/sessions</code> <code>session.read:self</code> | <code>session.read:any</code> <code>{ \"user_id\": ..., \"tenant_id\": ... }</code> <code>POST /auth/sessions/{id}/revoke</code> <code>session.revoke:any</code> <code>{ \"tenant_id\": ... }</code> <p>N\u1ebfu user kh\u00f4ng tho\u1ea3 <code>x-condition</code>, h\u1ec7 th\u1ed1ng s\u1ebd tr\u1ea3 l\u1ed7i <code>403 Forbidden</code>.</p>"},{"location":"services/auth-service/sub/interface-contract/#24-bao-ve-du-lieu-nhay-cam","title":"2.4. \ud83d\udd10 B\u1ea3o v\u1ec7 d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m","text":"<ul> <li>C\u00e1c tr\u01b0\u1eddng nh\u01b0 <code>ip_address</code>, <code>user_agent</code>, <code>location</code> trong session ch\u1ec9 tr\u1ea3 v\u1ec1 n\u1ebfu c\u00f3 quy\u1ec1n <code>session.read:any</code></li> <li>V\u1edbi quy\u1ec1n <code>session.read:self</code>, m\u1ed9t s\u1ed1 tr\u01b0\u1eddng c\u00f3 th\u1ec3 b\u1ecb c\u1eaft b\u1ecf \u0111\u1ec3 b\u1ea3o v\u1ec7 quy\u1ec1n ri\u00eang t\u01b0</li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#25-goi-y-trien-khai","title":"2.5. \ud83e\udde0 G\u1ee3i \u00fd tri\u1ec3n khai","text":"V\u1ea5n \u0111\u1ec1 Gi\u1ea3i ph\u00e1p Ng\u01b0\u1eddi d\u00f9ng qu\u00ean g\u1eedi <code>X-Tenant-ID</code> Gateway tr\u1ea3 l\u1ed7i 400 v\u1edbi l\u1ed7i <code>missing_tenant_id</code> Qu\u1ea3n tr\u1ecb vi\u00ean mu\u1ed1n xem session c\u1ee7a user kh\u00e1c C\u1ea7n <code>session.read:any</code> v\u00e0 \u0111i\u1ec1u ki\u1ec7n tenant match H\u1ea1n ch\u1ebf truy c\u1eadp ch\u00e9o gi\u1eefa tenant M\u1ecdi truy v\u1ea5n \u0111\u1ec1u b\u1eaft bu\u1ed9c <code>tenant_id = {{X-Tenant-ID}}</code> <p>\u2705 C\u01a1 ch\u1ebf b\u1ea3o m\u1eadt v\u00e0 ph\u00e2n quy\u1ec1n \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf \u0111\u1ec3 ho\u1ea1t \u0111\u1ed9ng an to\u00e0n trong m\u00f4i tr\u01b0\u1eddng multi-tenant, \u0111\u1ed3ng th\u1eddi linh ho\u1ea1t cho qu\u1ea3n tr\u1ecb h\u1ec7 th\u1ed1ng tr\u00ean t\u1eebng tenant c\u1ee5 th\u1ec3.</p>"},{"location":"services/auth-service/sub/interface-contract/#3-tong-quan-api-luong-nghiep-vu","title":"3. \ud83d\udccc T\u1ed5ng quan API &amp; Lu\u1ed3ng nghi\u1ec7p v\u1ee5","text":"<p>C\u00e1c API trong <code>auth-service/sub</code> t\u1eadp trung ph\u1ee5c v\u1ee5 vi\u1ec7c x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng theo t\u1eebng tenant. T\u1ea5t c\u1ea3 \u0111\u1ec1u tu\u00e2n th\u1ee7 ki\u1ebfn tr\u00fac ph\u00e2n t\u1ea7ng r\u00f5 r\u00e0ng, ho\u1ea1t \u0111\u1ed9ng theo lu\u1ed3ng chu\u1ea9n x\u00e1c th\u1ef1c \u2013 ph\u00e1t token \u2013 qu\u1ea3n l\u00fd session \u2013 thu h\u1ed3i token.</p>"},{"location":"services/auth-service/sub/interface-contract/#31-cac-nhom-chuc-nang-chinh","title":"3.1. \ud83d\udd01 C\u00e1c nh\u00f3m ch\u1ee9c n\u0103ng ch\u00ednh","text":"Nh\u00f3m API M\u00f4 t\u1ea3 Endpoint \ud83e\uddd1\u200d\ud83d\udcbc X\u00e1c th\u1ef1c \u0110\u0103ng nh\u1eadp b\u1eb1ng OTP ho\u1eb7c Local login <code>POST /auth/login</code> \ud83d\udeaa \u0110\u0103ng xu\u1ea5t Thu h\u1ed3i token \u0111ang d\u00f9ng (logout) <code>POST /auth/logout</code> \ud83d\udcdc L\u1ecbch s\u1eed phi\u00ean Li\u1ec7t k\u00ea c\u00e1c phi\u00ean \u0111\u0103ng nh\u1eadp tr\u01b0\u1edbc \u0111\u00f3 <code>GET /auth/sessions</code> \ud83d\udd12 Thu h\u1ed3i phi\u00ean Hu\u1ef7 b\u1ecf session c\u1ee5 th\u1ec3 (manual revoke) <code>POST /auth/sessions/{id}/revoke</code>"},{"location":"services/auth-service/sub/interface-contract/#32-luong-xu-ly-chinh","title":"3.2. \ud83e\udded Lu\u1ed3ng x\u1eed l\u00fd ch\u00ednh","text":"<pre><code>sequenceDiagram\n  participant Frontend\n  participant API Gateway\n  participant Auth Sub\n  participant Token Service\n  participant Redis\n\n  Frontend-&gt;&gt;+API Gateway: /auth/login (OTP/local)\n  API Gateway-&gt;&gt;+Auth Sub: chuy\u1ec3n ti\u1ebfp login\n  Auth Sub-&gt;&gt;+Token Service: y\u00eau c\u1ea7u c\u1ea5p JWT\n  Token Service--&gt;&gt;-Auth Sub: access_token + refresh_token\n  Auth Sub-&gt;&gt;Redis: ghi revoked cache (n\u1ebfu logout)\n  Auth Sub--&gt;&gt;-API Gateway: tr\u1ea3 v\u1ec1 JWT\n  API Gateway--&gt;&gt;-Frontend: JWT\n\n  note over Auth Sub,Redis: Emit: auth.token.issued\n</code></pre>"},{"location":"services/auth-service/sub/interface-contract/#33-moi-lien-he-voi-cac-service-khac","title":"3.3. \ud83c\udf10 M\u1ed1i li\u00ean h\u1ec7 v\u1edbi c\u00e1c service kh\u00e1c","text":"Service li\u00ean quan Vai tr\u00f2 <code>token-service</code> Sinh &amp; thu h\u1ed3i access/refresh token <code>api-gateway</code> Enforce RBAC, forward <code>x-condition</code>, ki\u1ec3m tra revoked token <code>user-service</code> \u0110\u1ed3ng b\u1ed9 th\u00f4ng tin user (id, tr\u1ea1ng th\u00e1i) n\u1ebfu c\u1ea7n <code>notification-service</code> G\u1eedi OTP (trong t\u01b0\u01a1ng lai n\u1ebfu t\u00e1ch kh\u1ecfi frontend)"},{"location":"services/auth-service/sub/interface-contract/#34-su-kien-uoc-phat-ra","title":"3.4. \ud83d\udce3 S\u1ef1 ki\u1ec7n \u0111\u01b0\u1ee3c ph\u00e1t ra","text":"T\u00ean s\u1ef1 ki\u1ec7n Khi n\u00e0o? Payload <code>auth.token.issued</code> Sau khi login th\u00e0nh c\u00f4ng Th\u00f4ng tin session, token, user metadata <code>auth.token.revoked</code> Khi logout ho\u1eb7c b\u1ecb revoke Session ID, user ID, l\u00fd do <code>user.sync.triggered</code> (optional) Khi c\u1ea7n \u0111\u1ed3ng b\u1ed9 user qua tenant kh\u00e1c user_id, tenant_id <p>\ud83d\udccc Lu\u1ed3ng nghi\u1ec7p v\u1ee5 trong <code>auth-service/sub</code> \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf \u0111\u01a1n gi\u1ea3n, d\u1ec5 m\u1edf r\u1ed9ng, v\u00e0 ph\u00f9 h\u1ee3p tuy\u1ec7t \u0111\u1ed1i v\u1edbi m\u00f4 h\u00ecnh multi-tenant per-instance c\u1ee7a <code>dx-vas</code>.</p>"},{"location":"services/auth-service/sub/interface-contract/#4-chi-tiet-cac-endpoint","title":"4. \ud83d\udcec Chi ti\u1ebft c\u00e1c Endpoint","text":""},{"location":"services/auth-service/sub/interface-contract/#41-post-authlogin","title":"4.1. <code>POST /auth/login</code>","text":"<p>\u0110\u00e2y l\u00e0 endpoint ch\u00ednh \u0111\u1ec3 x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng th\u00f4ng qua OTP ho\u1eb7c t\u00e0i kho\u1ea3n n\u1ed9i b\u1ed9 (local). Sau khi x\u00e1c th\u1ef1c th\u00e0nh c\u00f4ng, h\u1ec7 th\u1ed1ng s\u1ebd t\u1ea1o session, ph\u00e1t JWT, l\u01b0u metadata v\u00e0 ph\u00e1t s\u1ef1 ki\u1ec7n <code>auth.token.issued</code>.</p>"},{"location":"services/auth-service/sub/interface-contract/#request","title":"\ud83d\udce5 Request","text":"<p>Header y\u00eau c\u1ea7u:</p> Header B\u1eaft bu\u1ed9c Ghi ch\u00fa <code>Authorization</code> \u274c Kh\u00f4ng c\u1ea7n (ch\u01b0a login) <code>X-Tenant-ID</code> \u2705 X\u00e1c \u0111\u1ecbnh tenant \u0111ang x\u1eed l\u00fd <p>Body (<code>LoginRequest</code>, d\u00f9ng discriminator <code>login_type</code>):</p> <pre><code>{\n  \"login_type\": \"otp\",  // ho\u1eb7c \"local\"\n  \"phone_number\": \"+84901234567\", // OTP\n  \"otp_code\": \"123456\"\n}\n</code></pre> <p>Ho\u1eb7c:</p> <pre><code>{\n  \"login_type\": \"local\",\n  \"username\": \"admin\",\n  \"password\": \"123456\"\n}\n</code></pre> <p>C\u00e1c field c\u1ee5 th\u1ec3 ph\u1ee5 thu\u1ed9c v\u00e0o <code>login_type</code>. T\u00e0i li\u1ec7u <code>schemas/LoginRequest</code> s\u1ebd \u0111\u1ecbnh ngh\u0129a c\u1ee5 th\u1ec3.</p>"},{"location":"services/auth-service/sub/interface-contract/#response","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"meta\": {\n    \"request_id\": \"xyz\",\n    \"timestamp\": \"...\"\n  },\n  \"data\": {\n    \"access_token\": \"&lt;JWT&gt;\",\n    \"refresh_token\": \"&lt;JWT&gt;\",\n    \"expires_in\": 3600,\n    \"session_id\": \"f2b9c6ae-...95c\",\n    \"token_type\": \"Bearer\"\n  }\n}\n</code></pre> <ul> <li>Response lu\u00f4n b\u1ecdc trong <code>ResponseMeta + TokenEnvelope</code></li> <li><code>session_id</code> l\u00e0 UUID phi\u00ean login \u0111\u01b0\u1ee3c l\u01b0u trong <code>auth_sessions</code></li> <li>Token \u0111\u01b0\u1ee3c ph\u00e1t t\u1eeb <code>token-service</code>, kh\u00f4ng ph\u1ea3i n\u1ed9i b\u1ed9 auth-sub</li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#phan-quyen-ieu-kien","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"Y\u1ebfu t\u1ed1 Gi\u00e1 tr\u1ecb <code>x-required-permission</code> <code>auth.login</code> <code>x-condition</code> <code>{ \"tenant_id\": \"{{X-Tenant-ID}}\" }</code>"},{"location":"services/auth-service/sub/interface-contract/#su-kien-phat-ra","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li><code>auth.token.issued</code></li> <li>Payload g\u1ed3m: <code>user_id</code>, <code>tenant_id</code>, <code>auth_method</code>, <code>session_id</code>, <code>ip_address</code>, <code>user_agent</code>, <code>device_type</code>, <code>location</code></li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#ma-loi-co-the-tra-ve","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"error.code HTTP M\u00f4 t\u1ea3 <code>auth.invalid_credentials</code> 401 Sai username/password <code>auth.otp.invalid</code> 400 M\u00e3 OTP kh\u00f4ng \u0111\u00fang <code>auth.otp.expired</code> 400 M\u00e3 OTP \u0111\u00e3 h\u1ebft h\u1ea1n <code>auth.rate_limited</code> 429 G\u1eedi OTP qu\u00e1 nhi\u1ec1u l\u1ea7n <code>auth.tenant_not_found</code> 400 Thi\u1ebfu ho\u1eb7c sai <code>X-Tenant-ID</code>"},{"location":"services/auth-service/sub/interface-contract/#goi-y-kiem-thu","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>\u0110\u0103ng nh\u1eadp \u0111\u00fang/sai OTP</li> <li>\u0110\u0103ng nh\u1eadp local \u0111\u00fang/sai</li> <li>Thi\u1ebfu <code>X-Tenant-ID</code> \u2192 l\u1ed7i</li> <li>Session ph\u1ea3i \u0111\u01b0\u1ee3c ghi v\u00e0o b\u1ea3ng <code>auth_sessions</code></li> <li>Token ph\u1ea3i c\u00f3 claim \u0111\u00fang (<code>sub</code>, <code>session_id</code>, <code>tenant_id</code>, <code>exp</code>...)</li> </ul> <p>\ud83d\udccc \u0110\u00e2y l\u00e0 endpoint duy nh\u1ea5t t\u1ea1o JWT trong <code>auth-service/sub</code>. M\u1ecdi c\u1ea5p ph\u00e1t token \u0111\u1ec1u \u0111\u01b0\u1ee3c u\u1ef7 quy\u1ec1n sang <code>token-service</code>.</p>"},{"location":"services/auth-service/sub/interface-contract/#42-post-authlogout","title":"4.2. <code>POST /auth/logout</code>","text":"<p>Endpoint n\u00e0y cho ph\u00e9p ng\u01b0\u1eddi d\u00f9ng ho\u1eb7c h\u1ec7 th\u1ed1ng thu h\u1ed3i token hi\u1ec7n t\u1ea1i (access ho\u1eb7c refresh) v\u00e0 \u0111\u00e1nh d\u1ea5u session t\u01b0\u01a1ng \u1ee9ng l\u00e0 \u0111\u00e3 b\u1ecb hu\u1ef7. \u0110\u1ed3ng th\u1eddi ph\u00e1t s\u1ef1 ki\u1ec7n <code>auth.token.revoked</code> \u0111\u1ec3 c\u00e1c service kh\u00e1c c\u1eadp nh\u1eadt tr\u1ea1ng th\u00e1i.</p>"},{"location":"services/auth-service/sub/interface-contract/#request_1","title":"\ud83d\udce5 Request","text":"<p>Header y\u00eau c\u1ea7u:</p> Header B\u1eaft bu\u1ed9c Ghi ch\u00fa <code>Authorization</code> \u2705 JWT hi\u1ec7n t\u1ea1i <code>X-Tenant-ID</code> \u2705 Tenant t\u01b0\u01a1ng \u1ee9ng v\u1edbi token <p>Body (<code>LogoutRequest</code>, optional):</p> <pre><code>{\n  \"reason\": \"user_logout\"\n}\n</code></pre> <p>N\u1ebfu kh\u00f4ng truy\u1ec1n <code>reason</code>, m\u1eb7c \u0111\u1ecbnh l\u00e0 <code>\"user_logout\"</code>.</p>"},{"location":"services/auth-service/sub/interface-contract/#response_1","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"meta\": {\n    \"request_id\": \"...\",\n    \"timestamp\": \"...\"\n  },\n  \"data\": {\n    \"success\": true\n  }\n}\n</code></pre> <ul> <li>Tr\u1ea3 v\u1ec1 200 OK v\u1edbi success flag</li> <li>Kh\u00f4ng c\u1ea7n tr\u1ea3 l\u1ea1i token</li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#phan-quyen-ieu-kien_1","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"Y\u1ebfu t\u1ed1 Gi\u00e1 tr\u1ecb <code>x-required-permission</code> <code>auth.logout</code> <code>x-condition</code> <code>{ \"tenant_id\": \"{{X-Tenant-ID}}\" }</code>"},{"location":"services/auth-service/sub/interface-contract/#hanh-vi-noi-bo","title":"\ud83e\udde9 H\u00e0nh vi n\u1ed9i b\u1ed9","text":"<ul> <li>Token hi\u1ec7n t\u1ea1i \u0111\u01b0\u1ee3c decode \u2192 l\u1ea5y <code>jti</code> (JWT ID), <code>session_id</code>, <code>user_id</code></li> <li>T\u1ea1o key <code>revoked:&lt;jti&gt;</code> trong Redis v\u1edbi TTL \u0111\u00fang b\u1eb1ng th\u1eddi gian c\u00f2n l\u1ea1i</li> <li>C\u1eadp nh\u1eadt b\u1ea3n ghi <code>auth_sessions</code> t\u01b0\u01a1ng \u1ee9ng: <code>revoked_at</code>, <code>revoked_reason</code></li> <li>Ghi log audit v\u00e0 ph\u00e1t s\u1ef1 ki\u1ec7n <code>auth.token.revoked</code></li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#su-kien-phat-ra_1","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li><code>auth.token.revoked</code></li> <li>Payload g\u1ed3m: <code>session_id</code>, <code>user_id</code>, <code>tenant_id</code>, <code>revoked_reason</code>, <code>revoked_at</code>, <code>ip_address</code>, <code>device_type</code></li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#ma-loi-co-the-tra-ve_1","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"error.code HTTP M\u00f4 t\u1ea3 <code>auth.token.invalid</code> 401 Token kh\u00f4ng h\u1ee3p l\u1ec7 ho\u1eb7c \u0111\u00e3 h\u1ebft h\u1ea1n <code>auth.token.already_revoked</code> 400 Token \u0111\u00e3 b\u1ecb thu h\u1ed3i tr\u01b0\u1edbc \u0111\u00f3 <code>auth.tenant_mismatch</code> 403 Token kh\u00f4ng thu\u1ed9c tenant \u0111ang g\u1eedi"},{"location":"services/auth-service/sub/interface-contract/#goi-y-kiem-thu_1","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>Logout access token \u0111ang d\u00f9ng \u2192 Redis c\u00f3 key <code>revoked:&lt;jti&gt;</code></li> <li>Logout refresh token \u2192 c\u0169ng ph\u1ea3i b\u1ecb revoke</li> <li>Check Redis TTL v\u00e0 d\u1eef li\u1ec7u</li> <li>Truy v\u1ea5n <code>GET /auth/sessions</code> \u2192 session \u0111\u1ed5i tr\u1ea1ng th\u00e1i</li> <li>Replay token sau logout \u2192 ph\u1ea3i b\u1ecb t\u1eeb ch\u1ed1i t\u1ea1i Gateway</li> </ul> <p>\ud83d\udccc \u0110\u00e2y l\u00e0 c\u01a1 ch\u1ebf ch\u00ednh \u0111\u1ec3 th\u1ef1c hi\u1ec7n session termination ch\u1ee7 \u0111\u1ed9ng, ph\u1ee5c v\u1ee5 c\u1ea3 frontend v\u00e0 admin console. C\u00e1c revoke x\u1ea3y ra t\u1ea1i \u0111\u00e2y l\u00e0 soft revoke (qua Redis), kh\u00f4ng x\u00f3a token v\u1eadt l\u00fd.</p>"},{"location":"services/auth-service/sub/interface-contract/#43-get-authsessions","title":"4.3. <code>GET /auth/sessions</code>","text":"<p>Endpoint n\u00e0y cho ph\u00e9p ng\u01b0\u1eddi d\u00f9ng truy v\u1ea5n danh s\u00e1ch phi\u00ean \u0111\u0103ng nh\u1eadp tr\u01b0\u1edbc \u0111\u00f3 c\u1ee7a ch\u00ednh m\u00ecnh, ho\u1eb7c truy xu\u1ea5t c\u1ee7a ng\u01b0\u1eddi d\u00f9ng kh\u00e1c (n\u1ebfu c\u00f3 quy\u1ec1n). H\u1ed7 tr\u1ee3 l\u1ecdc theo <code>user_id</code>, <code>tr\u1ea1ng th\u00e1i</code>, ph\u00e2n trang.</p>"},{"location":"services/auth-service/sub/interface-contract/#request_2","title":"\ud83d\udce5 Request","text":"<p>Header y\u00eau c\u1ea7u:</p> Header B\u1eaft bu\u1ed9c Ghi ch\u00fa <code>Authorization</code> \u2705 JWT h\u1ee3p l\u1ec7 <code>X-Tenant-ID</code> \u2705 Tenant hi\u1ec7n h\u00e0nh <p>Query Parameters (t\u00f9y ch\u1ecdn):</p> Tham s\u1ed1 Ki\u1ec3u Ghi ch\u00fa <code>user_id</code> UUID Ch\u1ec9 \u0111\u1ecbnh user c\u1ee5 th\u1ec3 (ch\u1ec9 khi c\u00f3 quy\u1ec1n <code>read:any</code>) <code>status</code> ENUM <code>active</code>, <code>revoked</code>, <code>expired</code>, <code>locked</code> <code>limit</code> Integer S\u1ed1 d\u00f2ng m\u1ed7i trang (default: 20) <code>offset</code> Integer B\u1ecf qua bao nhi\u00eau d\u00f2ng \u0111\u1ea7u ti\u00ean"},{"location":"services/auth-service/sub/interface-contract/#response_2","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"meta\": {\n    \"request_id\": \"...\",\n    \"pagination\": {\n      \"total\": 82,\n      \"limit\": 20,\n      \"offset\": 0\n    }\n  },\n  \"data\": [\n    {\n      \"session_id\": \"f2b9c6ae-...\",\n      \"user_id\": \"de56...\",\n      \"auth_method\": \"otp\",\n      \"created_at\": \"2024-06-01T10:45:00Z\",\n      \"revoked_at\": null,\n      \"ip_address\": \"203.113.12.1\",\n      \"device_type\": \"web\",\n      \"user_agent\": \"Mozilla/5.0 ...\",\n      \"location\": \"Ho Chi Minh, VN\",\n      \"status\": \"active\"\n    }\n  ]\n}\n</code></pre> <ul> <li>Tr\u1ea3 v\u1ec1 m\u1ea3ng <code>SessionOut</code> theo chu\u1ea9n schema</li> <li>Metadata g\u1ed3m pagination info v\u00e0 <code>request_id</code></li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#phan-quyen-ieu-kien_2","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"Y\u1ebfu t\u1ed1 Gi\u00e1 tr\u1ecb <code>x-required-permission</code> <code>session.read:self</code> ho\u1eb7c <code>session.read:any</code> <code>x-condition</code> <code>{ \"user_id\": \"{{current_user.id}}\", \"tenant_id\": \"{{X-Tenant-ID}}\" }</code> <p>N\u1ebfu user g\u1eedi <code>user_id</code> \u2260 ch\u00ednh h\u1ecd \u2192 c\u1ea7n <code>session.read:any</code>.</p>"},{"location":"services/auth-service/sub/interface-contract/#luu-y-ve-bao-mat","title":"\ud83d\udd0e L\u01b0u \u00fd v\u1ec1 b\u1ea3o m\u1eadt","text":"<ul> <li>N\u1ebfu ch\u1ec9 c\u00f3 <code>read:self</code>, h\u1ec7 th\u1ed1ng s\u1ebd \u1ea9n ho\u1eb7c mask m\u1ed9t s\u1ed1 metadata (<code>ip_address</code>, <code>location</code>, <code>user_agent</code>)</li> <li>N\u1ebfu c\u00f3 <code>read:any</code>, s\u1ebd th\u1ea5y \u0111\u1ea7y \u0111\u1ee7 th\u00f4ng tin c\u00e1c session</li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#ma-loi-co-the-tra-ve_2","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"error.code HTTP M\u00f4 t\u1ea3 <code>auth.forbidden</code> 403 Kh\u00f4ng \u0111\u1ee7 quy\u1ec1n truy c\u1eadp d\u1eef li\u1ec7u <code>auth.invalid_query</code> 400 Truy v\u1ea5n kh\u00f4ng h\u1ee3p l\u1ec7 (sai user_id, offset \u00e2m...)"},{"location":"services/auth-service/sub/interface-contract/#goi-y-kiem-thu_2","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>G\u1ecdi kh\u00f4ng truy\u1ec1n <code>user_id</code> \u2192 tr\u1ea3 session ch\u00ednh m\u00ecnh</li> <li>G\u1ecdi <code>user_id = self</code> nh\u01b0ng thi\u1ebfu quy\u1ec1n \u2192 403</li> <li>Ph\u00e2n trang: limit/offset ho\u1ea1t \u0111\u1ed9ng ch\u00ednh x\u00e1c</li> <li>So s\u00e1nh s\u1ed1 l\u01b0\u1ee3ng session kh\u1edbp DB <code>auth_sessions</code></li> <li>Mask metadata khi d\u00f9ng quy\u1ec1n <code>read:self</code></li> </ul> <p>\ud83d\udccc \u0110\u00e2y l\u00e0 API quan tr\u1ecdng \u0111\u1ec3 ng\u01b0\u1eddi d\u00f9ng t\u1ef1 ki\u1ec3m tra l\u1ecbch s\u1eed ho\u1ea1t \u0111\u1ed9ng ho\u1eb7c \u0111\u1ec3 qu\u1ea3n tr\u1ecb vi\u00ean gi\u00e1m s\u00e1t \u0111\u0103ng nh\u1eadp trong tenant c\u1ee7a h\u1ecd.</p>"},{"location":"services/auth-service/sub/interface-contract/#44-post-authsessionsidrevoke","title":"4.4. <code>POST /auth/sessions/{id}/revoke</code>","text":"<p>Endpoint n\u00e0y cho ph\u00e9p qu\u1ea3n tr\u1ecb vi\u00ean thu h\u1ed3i m\u1ed9t phi\u00ean \u0111\u0103ng nh\u1eadp c\u1ee5 th\u1ec3 c\u1ee7a ng\u01b0\u1eddi d\u00f9ng trong tenant. H\u00e0nh \u0111\u1ed9ng n\u00e0y v\u00f4 hi\u1ec7u h\u00f3a token t\u01b0\u01a1ng \u1ee9ng n\u1ebfu c\u00f2n hi\u1ec7u l\u1ef1c, c\u1eadp nh\u1eadt tr\u1ea1ng th\u00e1i session v\u00e0 ph\u00e1t s\u1ef1 ki\u1ec7n <code>auth.token.revoked</code>.</p>"},{"location":"services/auth-service/sub/interface-contract/#request_3","title":"\ud83d\udce5 Request","text":"<p>Header y\u00eau c\u1ea7u:</p> Header B\u1eaft bu\u1ed9c Ghi ch\u00fa <code>Authorization</code> \u2705 JWT c\u00f3 quy\u1ec1n qu\u1ea3n tr\u1ecb <code>X-Tenant-ID</code> \u2705 Tenant c\u1ee7a phi\u00ean c\u1ea7n revoke <p>Path Parameter:</p> Param Ki\u1ec3u Ghi ch\u00fa <code>id</code> UUID ID c\u1ee7a session (<code>session_id</code>) c\u1ea7n thu h\u1ed3i <p>Body (<code>RevokeSessionRequest</code>, optional):</p> <pre><code>{\n  \"reason\": \"admin_forced\"\n}\n</code></pre> <p>N\u1ebfu kh\u00f4ng cung c\u1ea5p <code>reason</code>, h\u1ec7 th\u1ed1ng d\u00f9ng m\u1eb7c \u0111\u1ecbnh <code>\"manual\"</code>.</p>"},{"location":"services/auth-service/sub/interface-contract/#response_3","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"meta\": {\n    \"request_id\": \"...\",\n    \"timestamp\": \"...\"\n  },\n  \"data\": {\n    \"success\": true\n  }\n}\n</code></pre> <ul> <li>Tr\u1ea3 v\u1ec1 200 OK n\u1ebfu thu h\u1ed3i th\u00e0nh c\u00f4ng ho\u1eb7c \u0111\u00e3 b\u1ecb thu h\u1ed3i tr\u01b0\u1edbc \u0111\u00f3</li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#phan-quyen-ieu-kien_3","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"Y\u1ebfu t\u1ed1 Gi\u00e1 tr\u1ecb <code>x-required-permission</code> <code>session.revoke:any</code> <code>x-condition</code> <code>{ \"tenant_id\": \"{{X-Tenant-ID}}\" }</code> <p>Ch\u1ec9 cho ph\u00e9p thao t\u00e1c v\u1edbi c\u00e1c session thu\u1ed9c tenant hi\u1ec7n t\u1ea1i.</p>"},{"location":"services/auth-service/sub/interface-contract/#hanh-vi-noi-bo_1","title":"\ud83e\udde9 H\u00e0nh vi n\u1ed9i b\u1ed9","text":"<ul> <li>Truy v\u1ea5n <code>auth_sessions</code> \u0111\u1ec3 x\u00e1c \u0111\u1ecbnh session h\u1ee3p l\u1ec7</li> <li>N\u1ebfu session \u0111\u00e3 b\u1ecb revoke \u2192 tr\u1ea3 success idempotent</li> <li>N\u1ebfu session c\u00f2n ho\u1ea1t \u0111\u1ed9ng:</li> <li>Ghi <code>revoked_at</code>, <code>revoked_reason</code></li> <li>Ghi Redis key <code>revoked:&lt;jti&gt;</code> n\u1ebfu token c\u00f2n hi\u1ec7u l\u1ef1c</li> <li>Emit s\u1ef1 ki\u1ec7n <code>auth.token.revoked</code></li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#su-kien-phat-ra_2","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li><code>auth.token.revoked</code></li> <li>Payload g\u1ed3m: <code>session_id</code>, <code>user_id</code>, <code>tenant_id</code>, <code>revoked_reason</code>, <code>revoked_by</code>, <code>ip_address</code></li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#ma-loi-co-the-tra-ve_3","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"error.code HTTP M\u00f4 t\u1ea3 <code>session.not_found</code> 404 Kh\u00f4ng t\u00ecm th\u1ea5y session <code>auth.forbidden</code> 403 Kh\u00f4ng \u0111\u1ee7 quy\u1ec1n ho\u1eb7c sai tenant <code>session.already_revoked</code> 400 Phi\u00ean \u0111\u00e3 b\u1ecb thu h\u1ed3i t\u1eeb tr\u01b0\u1edbc (c\u00f3 th\u1ec3 cho ph\u00e9p idempotent success)"},{"location":"services/auth-service/sub/interface-contract/#goi-y-kiem-thu_3","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>Revoke m\u1ed9t session ch\u01b0a b\u1ecb thu h\u1ed3i \u2192 c\u1eadp nh\u1eadt DB, Redis</li> <li>Revoke l\u1ea1i c\u00f9ng session \u2192 kh\u00f4ng l\u1ed7i (idempotent)</li> <li>Truy v\u1ea5n <code>GET /auth/sessions</code> \u2192 th\u1ea5y tr\u1ea1ng th\u00e1i <code>revoked</code></li> <li>X\u00e1c minh s\u1ef1 ki\u1ec7n <code>auth.token.revoked</code> \u0111\u01b0\u1ee3c ph\u00e1t \u0111\u00fang metadata</li> <li>Check token t\u01b0\u01a1ng \u1ee9ng \u2192 b\u1ecb t\u1eeb ch\u1ed1i khi d\u00f9ng l\u1ea1i</li> </ul> <p>\ud83d\udccc \u0110\u00e2y l\u00e0 API qu\u1ea3n tr\u1ecb quan tr\u1ecdng cho ph\u00e9p v\u00f4 hi\u1ec7u h\u00f3a c\u00e1c phi\u00ean nghi ng\u1edd ho\u1eb7c ch\u1ea5m d\u1ee9t truy c\u1eadp ngay l\u1eadp t\u1ee9c trong c\u00e1c t\u00ecnh hu\u1ed1ng kh\u1ea9n c\u1ea5p v\u1ec1 b\u1ea3o m\u1eadt.</p>"},{"location":"services/auth-service/sub/interface-contract/#5-schema-su-dung-trong-requestresponse","title":"5. \ud83d\udce6 Schema s\u1eed d\u1ee5ng trong request/response","text":"<p>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 c\u00e1c schema d\u1eef li\u1ec7u ch\u00ednh \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng trong body c\u1ee7a c\u00e1c request v\u00e0 response c\u1ee7a <code>auth-service/sub</code>. T\u1ea5t c\u1ea3 schema \u0111\u1ec1u \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a v\u00e0 version h\u00f3a r\u00f5 r\u00e0ng trong file OpenAPI (<code>openapi.yaml</code>) \u0111i k\u00e8m.</p>"},{"location":"services/auth-service/sub/interface-contract/#51-loginrequest","title":"5.1. \ud83d\udce8 <code>LoginRequest</code>","text":"<pre><code>{\n  \"login_type\": \"otp\",  // ho\u1eb7c \"local\"\n  \"phone_number\": \"+84901234567\",\n  \"otp_code\": \"123456\"\n}\n</code></pre> <ul> <li><code>login_type</code>: <code>enum</code> (<code>otp</code>, <code>local</code>)</li> <li>N\u1ebfu <code>otp</code> \u2192 y\u00eau c\u1ea7u <code>phone_number</code> v\u00e0 <code>otp_code</code></li> <li>N\u1ebfu <code>local</code> \u2192 y\u00eau c\u1ea7u <code>username</code> v\u00e0 <code>password</code></li> <li>\u0110\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a b\u1eb1ng <code>oneOf</code> trong OpenAPI v\u1edbi discriminator <code>login_type</code></li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#52-tokenenvelope","title":"5.2. \ud83d\udce4 <code>TokenEnvelope</code>","text":"<pre><code>{\n  \"access_token\": \"eyJhbGciOiJSUzI1NiIsIn...\",\n  \"refresh_token\": \"eyJhbGciOiJSUzI1NiIsIn...\",\n  \"expires_in\": 3600,\n  \"session_id\": \"3b61237d-...\",\n  \"token_type\": \"Bearer\"\n}\n</code></pre> <ul> <li>Bao g\u00f3i th\u00f4ng tin token \u0111\u01b0\u1ee3c c\u1ea5p</li> <li>Tr\u1ea3 v\u1ec1 trong m\u1ecdi response <code>login</code></li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#53-logoutrequest","title":"5.3. \ud83d\udce5 <code>LogoutRequest</code>","text":"<pre><code>{\n  \"reason\": \"user_logout\"\n}\n</code></pre> <ul> <li><code>reason</code>: string, optional, c\u00e1c gi\u00e1 tr\u1ecb g\u1ee3i \u00fd: <code>user_logout</code>, <code>expired</code>, <code>device_lost</code>, <code>admin_forced</code></li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#54-sessionout","title":"5.4. \ud83d\udcdc <code>SessionOut</code>","text":"<pre><code>{\n  \"session_id\": \"b6a1d437-...\",\n  \"user_id\": \"1e332...\",\n  \"auth_method\": \"local\",\n  \"created_at\": \"2024-06-01T10:45:00Z\",\n  \"revoked_at\": null,\n  \"ip_address\": \"192.168.1.1\",\n  \"device_type\": \"web\",\n  \"user_agent\": \"Mozilla/5.0 ...\",\n  \"location\": \"Ho Chi Minh, VN\",\n  \"status\": \"active\"\n}\n</code></pre> <ul> <li>Tr\u1ea3 v\u1ec1 trong <code>GET /auth/sessions</code></li> <li>C\u00f3 th\u1ec3 b\u1ecb \u1ea9n/mask b\u1edbt n\u1ebfu quy\u1ec1n ch\u1ec9 l\u00e0 <code>session.read:self</code></li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#55-errorenvelope","title":"5.5. \ud83d\uded1 <code>ErrorEnvelope</code>","text":"<pre><code>{\n  \"error\": {\n    \"code\": \"auth.invalid_credentials\",\n    \"message\": \"T\u00ean \u0111\u0103ng nh\u1eadp ho\u1eb7c m\u1eadt kh\u1ea9u kh\u00f4ng \u0111\u00fang\",\n    \"data\": {\n      \"attempts_left\": 1\n    }\n  },\n  \"meta\": {\n    \"request_id\": \"xyz\",\n    \"timestamp\": \"2024-06-13T07:22:30Z\"\n  }\n}\n</code></pre> <ul> <li>\u0110\u01b0\u1ee3c chu\u1ea9n h\u00f3a theo <code>adr-011-api-error-format.md</code></li> <li>T\u1ea5t c\u1ea3 response l\u1ed7i \u0111\u1ec1u b\u1ecdc trong <code>ErrorEnvelope</code></li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#56-responsemeta","title":"5.6. \ud83d\udce6 <code>ResponseMeta</code>","text":"<pre><code>{\n  \"request_id\": \"req_abc123\",\n  \"timestamp\": \"2024-06-13T07:22:30Z\",\n  \"pagination\": {\n    \"total\": 120,\n    \"limit\": 20,\n    \"offset\": 0\n  }\n}\n</code></pre> <ul> <li>C\u00f3 m\u1eb7t trong m\u1ecdi response th\u00e0nh c\u00f4ng</li> <li><code>pagination</code> ch\u1ec9 c\u00f3 khi d\u00f9ng response d\u1ea1ng danh s\u00e1ch</li> </ul> <p>\ud83d\udccc T\u1ea5t c\u1ea3 schema \u0111\u1ec1u versioned v\u00e0 test t\u1ef1 \u0111\u1ed9ng b\u1eb1ng contract testing tools (<code>schemathesis</code>, <code>dredd</code>, etc.) trong CI pipeline.</p>"},{"location":"services/auth-service/sub/interface-contract/#6-quy-uoc-response-ma-loi","title":"6. \ud83c\udfaf Quy \u01b0\u1edbc response &amp; m\u00e3 l\u1ed7i","text":"<p>M\u1ecdi API trong <code>auth-service/sub</code> tu\u00e2n th\u1ee7 nghi\u00eam ng\u1eb7t \u0111\u1ecbnh d\u1ea1ng ph\u1ea3n h\u1ed3i chu\u1ea9n ho\u00e1 c\u1ee7a h\u1ec7 th\u1ed1ng VAS DX. \u0110i\u1ec1u n\u00e0y \u0111\u1ea3m b\u1ea3o t\u00ednh nh\u1ea5t qu\u00e1n, d\u1ec5 debug v\u00e0 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng c\u00e1c c\u00f4ng c\u1ee5 t\u1ef1 \u0111\u1ed9ng ho\u00e1 (contract testing, monitoring, tracing).</p>"},{"location":"services/auth-service/sub/interface-contract/#61-cau-truc-phan-hoi-thanh-cong","title":"6.1. \ud83d\udce6 C\u1ea5u tr\u00fac ph\u1ea3n h\u1ed3i th\u00e0nh c\u00f4ng","text":"<p>M\u1ed7i response th\u00e0nh c\u00f4ng \u0111\u1ec1u ph\u1ea3i b\u1ecdc trong:</p> <pre><code>{\n  \"meta\": {\n    \"request_id\": \"abc123\",\n    \"timestamp\": \"2024-06-13T08:00:00Z\"\n  },\n  \"data\": {\n    // N\u1ed9i dung tu\u1ef3 API\n  }\n}\n</code></pre> <ul> <li><code>meta</code>: lu\u00f4n c\u00f3 <code>request_id</code> (traceable), <code>timestamp</code>, v\u00e0 optional <code>pagination</code></li> <li><code>data</code>: ch\u1ee9a payload th\u1ef1c t\u1ebf (token, session list, success flag...)</li> </ul> <p>C\u1ea5u tr\u00fac n\u00e0y \u0111\u01b0\u1ee3c chu\u1ea9n h\u00f3a theo <code>adr-012-response-structure.md</code></p>"},{"location":"services/auth-service/sub/interface-contract/#62-cau-truc-phan-hoi-loi","title":"6.2. \ud83d\uded1 C\u1ea5u tr\u00fac ph\u1ea3n h\u1ed3i l\u1ed7i","text":"<p>T\u1ea5t c\u1ea3 l\u1ed7i \u0111\u1ec1u tr\u1ea3 v\u1ec1 \u0111\u1ecbnh d\u1ea1ng chu\u1ea9n <code>ErrorEnvelope</code>:</p> <pre><code>{\n  \"error\": {\n    \"code\": \"auth.invalid_credentials\",\n    \"message\": \"Sai t\u00ean \u0111\u0103ng nh\u1eadp ho\u1eb7c m\u1eadt kh\u1ea9u\",\n    \"data\": {\n      \"attempts_left\": 1\n    }\n  },\n  \"meta\": {\n    \"request_id\": \"abc123\",\n    \"timestamp\": \"2024-06-13T08:01:30Z\"\n  }\n}\n</code></pre> <ul> <li><code>code</code>: m\u00e3 l\u1ed7i d\u1ea1ng snake-case (b\u1eaft bu\u1ed9c)</li> <li><code>message</code>: m\u00f4 t\u1ea3 ng\u1eafn g\u1ecdn, c\u00f3 th\u1ec3 d\u00f9ng \u0111a ng\u00f4n ng\u1eef</li> <li><code>data</code>: optional \u2013 d\u00f9ng \u0111\u1ec3 truy\u1ec1n th\u00eam context (v\u00ed d\u1ee5: <code>attempts_left</code>, <code>lockout_duration</code>)</li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#63-danh-sach-ma-loi-pho-bien","title":"6.3. \ud83d\udccb Danh s\u00e1ch m\u00e3 l\u1ed7i ph\u1ed5 bi\u1ebfn","text":"M\u00e3 l\u1ed7i HTTP M\u00f4 t\u1ea3 <code>auth.invalid_credentials</code> 401 Sai username/password <code>auth.otp.invalid</code> 400 M\u00e3 OTP sai <code>auth.otp.expired</code> 400 OTP \u0111\u00e3 h\u1ebft h\u1ea1n <code>auth.token.invalid</code> 401 Token kh\u00f4ng h\u1ee3p l\u1ec7 ho\u1eb7c \u0111\u00e3 thu h\u1ed3i <code>auth.token.already_revoked</code> 400 Token \u0111\u00e3 b\u1ecb thu h\u1ed3i t\u1eeb tr\u01b0\u1edbc <code>session.not_found</code> 404 Kh\u00f4ng t\u00ecm th\u1ea5y phi\u00ean <code>auth.forbidden</code> 403 Kh\u00f4ng \u0111\u1ee7 quy\u1ec1n theo RBAC <code>auth.tenant_mismatch</code> 403 Tenant kh\u00f4ng kh\u1edbp <code>auth.rate_limited</code> 429 G\u1eedi OTP/qu\u00e1 nhi\u1ec1u y\u00eau c\u1ea7u <p>Danh s\u00e1ch \u0111\u1ea7y \u0111\u1ee7 \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong file <code>error-codes.md</code> v\u00e0 <code>adr-011-api-error-format.md</code></p>"},{"location":"services/auth-service/sub/interface-contract/#64-contract-testing-yeu-cau","title":"6.4. \ud83e\uddea Contract testing y\u00eau c\u1ea7u","text":"<ul> <li>M\u1ed7i m\u00e3 l\u1ed7i \u0111\u1ec1u ph\u1ea3i c\u00f3 test t\u01b0\u01a1ng \u1ee9ng</li> <li>H\u00e0nh vi sai ph\u1ea3i tr\u1ea3 \u0111\u00fang m\u00e3 HTTP + <code>error.code</code></li> <li>CI pipeline kh\u00f4ng cho ph\u00e9p thay \u0111\u1ed5i <code>error.code</code> ho\u1eb7c <code>ResponseMeta</code> format n\u1ebfu kh\u00f4ng c\u00f3 migration</li> </ul> <p>\u2705 C\u00e1ch ti\u1ebfp c\u1eadn nh\u1ea5t qu\u00e1n gi\u00fap t\u0103ng kh\u1ea3 n\u0103ng gi\u00e1m s\u00e1t t\u1ef1 \u0111\u1ed9ng, ph\u00e2n t\u00edch l\u1ed7i ch\u00ednh x\u00e1c, h\u1ed7 tr\u1ee3 frontend hi\u1ec3n th\u1ecb r\u00f5 r\u00e0ng v\u00e0 gi\u1ea3m thi\u1ec3u l\u1ed7i t\u00edch h\u1ee3p gi\u1eefa c\u00e1c \u0111\u1ed9i.</p>"},{"location":"services/auth-service/sub/interface-contract/#7-ho-tro-kiem-thu-tich-hop","title":"7. \ud83e\uddea H\u1ed7 tr\u1ee3 ki\u1ec3m th\u1eed &amp; t\u00edch h\u1ee3p","text":"<p>T\u00e0i li\u1ec7u n\u00e0y h\u1ed7 tr\u1ee3 \u0111\u1ea7y \u0111\u1ee7 cho c\u00e1c ho\u1ea1t \u0111\u1ed9ng ki\u1ec3m th\u1eed th\u1ee7 c\u00f4ng, ki\u1ec3m th\u1eed t\u1ef1 \u0111\u1ed9ng, t\u00edch h\u1ee3p CI/CD v\u00e0 contract testing nh\u1eb1m \u0111\u1ea3m b\u1ea3o \u0111\u1ed9 tin c\u1eady v\u00e0 t\u00ednh \u0111\u00fang \u0111\u1eafn c\u1ee7a <code>auth-service/sub</code>.</p>"},{"location":"services/auth-service/sub/interface-contract/#71-mau-request-thuc-te","title":"7.1. \u2705 M\u1eabu request th\u1ef1c t\u1ebf","text":"M\u1ee5c \u0111\u00edch Method &amp; URL G\u1ee3i \u00fd curl \u0110\u0103ng nh\u1eadp OTP <code>POST /auth/login</code> <code>curl -X POST ... -H \"X-Tenant-ID: t1\" -d '{...}'</code> Logout <code>POST /auth/logout</code> <code>curl -H \"Authorization: Bearer ...\"</code> Li\u1ec7t k\u00ea session <code>GET /auth/sessions</code> <code>curl -G ... --data-urlencode 'user_id=...'</code> Thu h\u1ed3i phi\u00ean <code>POST /auth/sessions/{id}/revoke</code> <code>curl -X POST ... -d '{ \"reason\": \"admin_forced\" }'</code> <p>\ud83d\udcce G\u1ee3i \u00fd: S\u1eed d\u1ee5ng [Postman Collection] ho\u1eb7c [Insomnia Export] \u0111\u00ednh k\u00e8m d\u1ef1 \u00e1n.</p>"},{"location":"services/auth-service/sub/interface-contract/#72-contract-testing","title":"7.2. \ud83e\uddea Contract Testing","text":"M\u1ee5c ti\u00eau C\u00f4ng c\u1ee5 \u0111\u1ec1 xu\u1ea5t Ki\u1ec3m tra schema \u0111\u00fang v\u1edbi OpenAPI <code>Dredd</code>, <code>Schemathesis</code>, <code>Stoplight Prism</code> Ki\u1ec3m tra \u0111\u1ecbnh d\u1ea1ng l\u1ed7i &amp; m\u00e3 l\u1ed7i <code>pytest + snapshot test</code>, <code>jest + supertest</code> So kh\u1edbp <code>response.meta</code> &amp; pagination T\u00edch h\u1ee3p test CI/CD \u0110\u1ea3m b\u1ea3o backward compatibility Contract test snapshot lockfile <p>\u2705 T\u00e0i li\u1ec7u n\u00e0y \u0111\u1ed3ng b\u1ed9 100% v\u1edbi <code>openapi.yaml</code> \u2013 c\u00f3 th\u1ec3 d\u00f9ng \u0111\u1ec3 sinh test auto.</p>"},{"location":"services/auth-service/sub/interface-contract/#73-kiem-thu-phan-quyen-ieu-kien","title":"7.3. \ud83e\uddea Ki\u1ec3m th\u1eed ph\u00e2n quy\u1ec1n &amp; \u0111i\u1ec1u ki\u1ec7n","text":"<ul> <li>Test thi\u1ebfu <code>X-Tenant-ID</code> \u2192 tr\u1ea3 l\u1ed7i 400</li> <li>Test <code>session.read:self</code> vs <code>read:any</code> \u2192 kh\u00e1c nhau v\u1ec1 metadata</li> <li>Test <code>session.revoke:any</code> \u2192 kh\u00f4ng \u0111\u01b0\u1ee3c ph\u00e9p thu h\u1ed3i phi\u00ean tenant kh\u00e1c</li> <li>Test <code>auth.token.revoked</code> \u2192 emit event \u0111\u00fang metadata</li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#74-tich-hop-cicd","title":"7.4. \ud83d\udee0 T\u00edch h\u1ee3p CI/CD","text":"<ul> <li>M\u1ed7i PR b\u1eaft bu\u1ed9c ch\u1ea1y test schema \u2192 kh\u00f4ng cho ph\u00e9p thay \u0111\u1ed5i <code>ErrorEnvelope</code>, <code>ResponseMeta</code></li> <li>C\u00f3 rule YAML ki\u1ec3m tra presence c\u1ee7a <code>x-required-permission</code>, <code>x-condition</code> trong m\u1ed7i path</li> </ul>"},{"location":"services/auth-service/sub/interface-contract/#75-tich-hop-observability","title":"7.5. \ud83d\udce1 T\u00edch h\u1ee3p observability","text":"<ul> <li>M\u1ed7i request \u0111\u01b0\u1ee3c g\u00e1n <code>request_id</code> v\u00e0 trace ID \u0111\u1ec3 debug xuy\u00ean service</li> <li>Response chu\u1ea9n h\u00f3a h\u1ed7 tr\u1ee3 APM/monitoring nh\u01b0 Datadog, Grafana Tempo, OpenTelemetry</li> </ul> <p>\u2705 V\u1edbi t\u00e0i li\u1ec7u n\u00e0y, \u0111\u1ed9i frontend, backend, QA, v\u00e0 devops \u0111\u1ec1u c\u00f3 th\u1ec3 t\u1ef1 \u0111\u1ed9ng ho\u00e1 qu\u00e1 tr\u00ecnh ki\u1ec3m th\u1eed v\u00e0 ki\u1ec3m tra h\u1ee3p \u0111\u1ed3ng t\u00edch h\u1ee3p xuy\u00ean t\u1ea7ng m\u1ed9t c\u00e1ch ch\u00ednh x\u00e1c v\u00e0 hi\u1ec7u qu\u1ea3.</p>"},{"location":"services/auth-service/sub/interface-contract/#8-tai-lieu-lien-quan","title":"8. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Data Model</li> <li>OpenAPI Spec</li> <li>Design</li> </ul>"},{"location":"services/notification-service/master/data-model/","title":"\ud83d\uddc3\ufe0f Notification Service (Master) - Data Model","text":"<p>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 chi ti\u1ebft m\u00f4 h\u00ecnh d\u1eef li\u1ec7u c\u1ee7a Notification Service (Master). Service n\u00e0y l\u00e0 m\u1ed9t th\u00e0nh ph\u1ea7n c\u1ed1t l\u00f5i trong h\u1ec7 th\u1ed1ng <code>dx-vas</code>, ho\u1ea1t \u0111\u1ed9ng theo ki\u1ebfn tr\u00fac event-driven + multi-tenant-aware (qu\u1ea3n l\u00fd k\u00eanh g\u1eedi theo tenant).</p> <p>Notification Service ch\u1ecbu tr\u00e1ch nhi\u1ec7m qu\u1ea3n l\u00fd c\u00e1c lo\u1ea1i d\u1eef li\u1ec7u ch\u00ednh sau: - C\u1ea5u h\u00ecnh template g\u1eedi th\u00f4ng b\u00e1o (<code>notification_templates</code>) - L\u1ecbch s\u1eed g\u1eedi th\u00f4ng b\u00e1o (<code>notification_logs</code>) - C\u1ea5u h\u00ecnh k\u00eanh g\u1eedi theo t\u1eebng lo\u1ea1i (<code>notification_channel_config</code>) - Ghi nh\u1eadn s\u1ef1 ki\u1ec7n \u0111\u00e3 x\u1eed l\u00fd \u0111\u1ec3 tr\u00e1nh g\u1eedi tr\u00f9ng (<code>processed_events</code>)</p>"},{"location":"services/notification-service/master/data-model/#1-pham-vi-du-lieu-quan-ly-scope","title":"1. Ph\u1ea1m vi D\u1eef li\u1ec7u Qu\u1ea3n l\u00fd (Scope)","text":"<p>Notification Service bao g\u1ed3m vi\u1ec7c qu\u1ea3n l\u00fd: - Template th\u00f4ng b\u00e1o theo lo\u1ea1i s\u1ef1 ki\u1ec7n v\u00e0 ng\u00f4n ng\u1eef - L\u1ecbch s\u1eed g\u1eedi th\u00f4ng b\u00e1o v\u00e0 tr\u1ea1ng th\u00e1i th\u00e0nh c\u00f4ng/th\u1ea5t b\u1ea1i - C\u1ea5u h\u00ecnh k\u00eanh g\u1eedi (SMTP, SMS, push) theo lo\u1ea1i - S\u1ef1 ki\u1ec7n \u0111\u00e3 x\u1eed l\u00fd t\u1eeb Kafka \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o idempotency</p>"},{"location":"services/notification-service/master/data-model/#2-ngoai-pham-vi-out-of-scope","title":"2. Ngo\u00e0i Ph\u1ea1m Vi (Out of Scope)","text":"<p>Notification Service kh\u00f4ng ch\u1ecbu tr\u00e1ch nhi\u1ec7m qu\u1ea3n l\u00fd: - \u274c Ng\u01b0\u1eddi nh\u1eadn th\u00f4ng b\u00e1o (\u0111\u01b0\u1ee3c l\u1ea5y t\u1eeb s\u1ef1 ki\u1ec7n ho\u1eb7c h\u1ec7 th\u1ed1ng kh\u00e1c) - \u274c Qu\u1ea3n l\u00fd user/role (thu\u1ed9c v\u1ec1 user-service) - \u274c Logging audit (\u0111\u00e3 c\u00f3 service ri\u00eang)</p>"},{"location":"services/notification-service/master/data-model/#3-muc-tieu-cua-tai-lieu-mo-hinh-du-lieu","title":"3. M\u1ee5c ti\u00eau c\u1ee7a T\u00e0i li\u1ec7u M\u00f4 h\u00ecnh D\u1eef li\u1ec7u","text":"<ul> <li>Tr\u00ecnh b\u00e0y c\u1ea5u tr\u00fac b\u1ea3ng c\u1ed1t l\u00f5i: template, log, channel config</li> <li>M\u00f4 t\u1ea3 kh\u00f3a ch\u00ednh, kh\u00f3a ngo\u1ea1i, unique constraint, indexing, enum</li> <li>Ph\u1ee5c v\u1ee5 backend dev, schema migration, OpenAPI, testing</li> <li>Tu\u00e2n th\u1ee7 c\u00e1c ADR: <code>adr-007</code>, <code>adr-027</code>, <code>adr-030</code></li> </ul>"},{"location":"services/notification-service/master/data-model/#4-so-o-erd","title":"4. S\u01a1 \u0111\u1ed3 ERD","text":"<p>S\u01a1 \u0111\u1ed3 ERD s\u01a1 b\u1ed9 <pre><code>erDiagram\n  notification_templates {\n    UUID id PK\n    TEXT name\n    TEXT type\n    TEXT language\n    TEXT trigger_event\n    TEXT content\n    TIMESTAMPTZ created_at\n    TIMESTAMPTZ updated_at\n  }\n\n  notification_logs {\n    UUID id PK\n    UUID template_id FK\n    TEXT channel\n    TEXT recipient\n    TEXT status\n    TEXT error_message\n    TIMESTAMPTZ sent_at\n  }\n\n  notification_channel_config {\n    TEXT channel_type PK\n    TEXT provider\n    JSON config\n  }\n\n  processed_events {\n    UUID event_id PK\n    TEXT consumer_group_name\n    TIMESTAMPTZ processed_at\n  }\n\n  notification_templates ||--o{ notification_logs : \"used by\"\n</code></pre></p> <p>S\u01a1 \u0111\u1ed3 ERD Chi ti\u1ebft <pre><code>erDiagram\n\n  notification_templates {\n    UUID id PK\n    TEXT name\n    TEXT type \"ENUM: email, sms, push\"\n    TEXT language\n    TEXT trigger_event\n    TEXT content\n    TIMESTAMPTZ created_at\n    TIMESTAMPTZ updated_at\n  }\n\n  notification_logs {\n    UUID id PK\n    UUID template_id FK\n    TEXT channel \"ENUM: email, sms, push\"\n    TEXT recipient\n    TEXT status \"ENUM: queued, sent, failed\"\n    TEXT error_message\n    TIMESTAMPTZ sent_at\n  }\n\n  notification_channel_config {\n    TEXT channel_type PK \"ENUM: email, sms, push\"\n    TEXT provider\n    JSON config\n  }\n\n  processed_events {\n    UUID event_id PK\n    TEXT consumer_group_name\n    TIMESTAMPTZ processed_at\n  }\n\n  %% Relationships\n  notification_templates ||--o{ notification_logs : \"used by\"\n  notification_channel_config ||--|| notification_templates : \"configures\" \n</code></pre></p>"},{"location":"services/notification-service/master/data-model/#ghi-chu","title":"\ud83e\udde0 Ghi ch\u00fa:","text":"<ul> <li><code>notification_logs.template_id</code> c\u00f3 th\u1ec3 <code>NULL</code> n\u1ebfu template b\u1ecb xo\u00e1 sau khi log v\u1eabn c\u00f2n.</li> <li><code>processed_events</code> d\u00f9ng cho idempotency theo <code>ADR-030</code>.</li> <li><code>channel_type</code>, <code>type</code>, <code>status</code> \u0111\u1ec1u d\u00f9ng ENUM \u0111\u1ec3 enforce t\u00ednh nh\u1ea5t qu\u00e1n.</li> </ul>"},{"location":"services/notification-service/master/data-model/#5-chi-tiet-tung-bang","title":"5. Chi ti\u1ebft T\u1eebng B\u1ea3ng","text":""},{"location":"services/notification-service/master/data-model/#notification_templates","title":"\ud83d\udccc notification_templates","text":""},{"location":"services/notification-service/master/data-model/#muc-ich","title":"\ud83e\uddfe M\u1ee5c \u0111\u00edch","text":"<p>L\u01b0u th\u00f4ng tin template cho t\u1eebng lo\u1ea1i s\u1ef1 ki\u1ec7n v\u00e0 ng\u00f4n ng\u1eef.</p> <pre><code>CREATE TABLE notification_templates (\n    id UUID PRIMARY KEY,\n    name TEXT NOT NULL,\n    type TEXT CHECK (type IN ('email', 'sms', 'push')) NOT NULL,\n    language TEXT DEFAULT 'vi' NOT NULL,\n    trigger_event TEXT NOT NULL,\n    content TEXT NOT NULL,\n    created_at TIMESTAMPTZ DEFAULT now() NOT NULL,\n    updated_at TIMESTAMPTZ DEFAULT now() NOT NULL\n);\n</code></pre>"},{"location":"services/notification-service/master/data-model/#giai-thich-cot","title":"\ud83d\udccb Gi\u1ea3i th\u00edch c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u DL R\u00e0ng bu\u1ed9c M\u00f4 t\u1ea3 id UUID PK ID duy nh\u1ea5t name TEXT T\u00ean template type TEXT CHECK email/sms/push language TEXT DEFAULT Ng\u00f4n ng\u1eef (vi, en...) trigger_event TEXT NOT NULL S\u1ef1 ki\u1ec7n k\u00edch ho\u1ea1t (v\u00ed d\u1ee5: <code>user.created</code>) content TEXT NOT NULL N\u1ed9i dung c\u00f3 ch\u1ee9a placeholder created_at TIMESTAMPTZ DEFAULT Th\u1eddi \u0111i\u1ec3m t\u1ea1o updated_at TIMESTAMPTZ DEFAULT Th\u1eddi \u0111i\u1ec3m c\u1eadp nh\u1eadt"},{"location":"services/notification-service/master/data-model/#notification_logs","title":"\ud83d\udccc notification_logs","text":""},{"location":"services/notification-service/master/data-model/#muc-ich_1","title":"\ud83e\uddfe M\u1ee5c \u0111\u00edch","text":"<p>Ghi log tr\u1ea1ng th\u00e1i g\u1eedi, bao g\u1ed3m template \u0111\u00e3 d\u00f9ng, ng\u01b0\u1eddi nh\u1eadn, k\u00eanh g\u1eedi.</p> <pre><code>CREATE TABLE notification_logs (\n    id UUID PRIMARY KEY,\n    template_id UUID REFERENCES notification_templates(id) ON DELETE SET NULL,\n    channel TEXT NOT NULL,\n    recipient TEXT NOT NULL,\n    status TEXT CHECK (status IN ('queued', 'sent', 'failed')) NOT NULL,\n    error_message TEXT,\n    sent_at TIMESTAMPTZ\n);\n</code></pre>"},{"location":"services/notification-service/master/data-model/#giai-thich-cot_1","title":"\ud83d\udccb Gi\u1ea3i th\u00edch c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u DL R\u00e0ng bu\u1ed9c M\u00f4 t\u1ea3 id UUID PK ID log g\u1eedi duy nh\u1ea5t template_id UUID FK \u2192 <code>notification_templates</code> Li\u00ean k\u1ebft v\u1edbi template \u0111\u01b0\u1ee3c d\u00f9ng (nullable) channel TEXT CHECK (<code>email</code>, <code>sms</code>, <code>push</code>) K\u00eanh g\u1eedi th\u00f4ng b\u00e1o recipient TEXT NOT NULL Email/s\u1ed1 \u0111i\u1ec7n tho\u1ea1i ng\u01b0\u1eddi nh\u1eadn status TEXT CHECK (<code>queued</code>, <code>sent</code>, <code>failed</code>) Tr\u1ea1ng th\u00e1i g\u1eedi error_message TEXT NULLABLE M\u00f4 t\u1ea3 l\u1ed7i n\u1ebfu c\u00f3 sent_at TIMESTAMPTZ NULLABLE Th\u1eddi \u0111i\u1ec3m g\u1eedi th\u00f4ng b\u00e1o (n\u1ebfu th\u00e0nh c\u00f4ng)"},{"location":"services/notification-service/master/data-model/#notification_channel_config","title":"\ud83d\udccc notification_channel_config","text":""},{"location":"services/notification-service/master/data-model/#muc-ich_2","title":"\ud83e\uddfe M\u1ee5c \u0111\u00edch","text":"<p>L\u01b0u c\u1ea5u h\u00ecnh g\u1eedi cho t\u1eebng lo\u1ea1i k\u00eanh (SMTP, SMS, push).</p> <pre><code>CREATE TABLE notification_channel_config (\n    channel_type TEXT PRIMARY KEY CHECK (channel_type IN ('email', 'sms', 'push')),\n    provider TEXT NOT NULL,\n    config JSON NOT NULL\n);\n</code></pre>"},{"location":"services/notification-service/master/data-model/#giai-thich-cot_2","title":"\ud83d\udccb Gi\u1ea3i th\u00edch c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u DL R\u00e0ng bu\u1ed9c M\u00f4 t\u1ea3 channel_type TEXT PK, CHECK (<code>email</code>, <code>sms</code>, <code>push</code>) Lo\u1ea1i k\u00eanh g\u1eedi (primary key) provider TEXT NOT NULL T\u00ean nh\u00e0 cung c\u1ea5p d\u1ecbch v\u1ee5 g\u1eedi (SendGrid, Twilio...) config JSON NOT NULL Th\u00f4ng tin c\u1ea5u h\u00ecnh chi ti\u1ebft (host, token, v.v.)"},{"location":"services/notification-service/master/data-model/#processed_events","title":"\ud83d\udccc processed_events","text":""},{"location":"services/notification-service/master/data-model/#muc-ich_3","title":"\ud83e\uddfe M\u1ee5c \u0111\u00edch","text":"<p>Tr\u00e1nh x\u1eed l\u00fd l\u1ea1i c\u00e1c event \u0111\u00e3 nh\u1eadn qua Kafka.</p> <pre><code>CREATE TABLE processed_events (\n    event_id UUID PRIMARY KEY,\n    consumer_group_name TEXT NOT NULL,\n    processed_at TIMESTAMPTZ DEFAULT now() NOT NULL\n);\n</code></pre>"},{"location":"services/notification-service/master/data-model/#giai-thich-cot_3","title":"\ud83d\udccb Gi\u1ea3i th\u00edch c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u DL R\u00e0ng bu\u1ed9c M\u00f4 t\u1ea3 event_id UUID PK ID s\u1ef1 ki\u1ec7n duy nh\u1ea5t (<code>metadata.event_id</code> trong schema s\u1ef1 ki\u1ec7n) consumer_group_name TEXT NOT NULL T\u00ean nh\u00f3m ti\u00eau d\u00f9ng (d\u00e0nh cho vi\u1ec7c ph\u00e2n bi\u1ec7t consumer theo service) processed_at TIMESTAMPTZ DEFAULT now() Th\u1eddi \u0111i\u1ec3m \u0111\u00e3 x\u1eed l\u00fd, ph\u1ee5c v\u1ee5 audit ho\u1eb7c retry tracking"},{"location":"services/notification-service/master/data-model/#6-phu-luc-enums-constraints","title":"6. Ph\u1ee5 l\u1ee5c \u2013 ENUMs &amp; Constraints","text":""},{"location":"services/notification-service/master/data-model/#enums","title":"\ud83d\udccb ENUMs","text":"Tr\u01b0\u1eddng Gi\u00e1 tr\u1ecb type email, sms, push status queued, sent, failed channel_type email, sms, push"},{"location":"services/notification-service/master/data-model/#7-phu-luc-index-idempotency","title":"7. Ph\u1ee5 l\u1ee5c \u2013 Index &amp; Idempotency","text":"B\u1ea3ng Index M\u1ee5c \u0111\u00edch notification_templates (trigger_event, language, type) T\u00ecm template nhanh notification_logs (template_id, sent_at) Truy v\u1ea5n log theo th\u1eddi gian processed_events (event_id) \u0110\u1ea3m b\u1ea3o kh\u00f4ng x\u1eed l\u00fd tr\u00f9ng"},{"location":"services/notification-service/master/data-model/#8-retention-data-lifecycle","title":"8. \u267b\ufe0f Retention &amp; Data Lifecycle","text":""},{"location":"services/notification-service/master/data-model/#bang-notification_logs","title":"\ud83d\udd04 B\u1ea3ng: <code>notification_logs</code>","text":"<ul> <li>Retention policy: d\u1eef li\u1ec7u log s\u1ebd \u0111\u01b0\u1ee3c l\u01b0u t\u1ed1i \u0111a 180 ng\u00e0y k\u1ec3 t\u1eeb th\u1eddi \u0111i\u1ec3m g\u1eedi (<code>sent_at</code>).</li> <li>L\u00fd do: gi\u1ea3m dung l\u01b0\u1ee3ng l\u01b0u tr\u1eef v\u00e0 tr\u00e1nh \u1ea3nh h\u01b0\u1edfng \u0111\u1ebfn hi\u1ec7u n\u0103ng truy v\u1ea5n khi kh\u1ed1i l\u01b0\u1ee3ng log l\u1edbn.</li> <li>Chi\u1ebfn l\u01b0\u1ee3c xo\u00e1:</li> <li>Thi h\u00e0nh b\u1edfi batch job \u0111\u1ecbnh k\u1ef3 h\u00e0ng ng\u00e0y (d\u00f9ng cron + SQL DELETE).</li> <li>C\u00e2u l\u1ec7nh m\u1eabu:     <pre><code>DELETE FROM notification_logs\nWHERE sent_at &lt; now() - interval '180 days';\n</code></pre></li> <li>C\u00f3 th\u1ec3 m\u1edf r\u1ed9ng d\u00f9ng partition theo th\u00e1ng \u0111\u1ec3 xo\u00e1 hi\u1ec7u qu\u1ea3 h\u01a1n trong t\u01b0\u01a1ng lai.</li> </ul>"},{"location":"services/notification-service/master/data-model/#luu-y-ve-bao-mat-audit","title":"\ud83d\udd12 L\u01b0u \u00fd v\u1ec1 b\u1ea3o m\u1eadt &amp; audit:","text":"<ul> <li>C\u00e1c log b\u1ecb xo\u00e1 kh\u00f4ng th\u1ec3 kh\u00f4i ph\u1ee5c \u2013 service n\u00e0y kh\u00f4ng gi\u1eef b\u1ea3n backup n\u1ed9i b\u1ed9.</li> <li>N\u1ebfu c\u1ea7n trace h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng l\u00e2u d\u00e0i ph\u1ee5c v\u1ee5 ki\u1ec3m to\u00e1n, n\u00ean ghi l\u1ea1i b\u1ea3n sao d\u1ea1ng audit log t\u1ea1i <code>audit-logging-service</code> (xem ADR-008).</li> </ul>"},{"location":"services/notification-service/master/data-model/#9-bang-phu-tro-cho-ui-ui-metadata-tables","title":"9. \ud83e\udde9 B\u1ea3ng ph\u1ee5 tr\u1ee3 cho UI (UI Metadata Tables)","text":"<p>\u0110\u1ec3 ph\u1ee5c v\u1ee5 dashboard qu\u1ea3n tr\u1ecb template v\u00e0 log (d\u00e0nh cho admin n\u1ed9i b\u1ed9), c\u00e1c gi\u00e1 tr\u1ecb ENUM s\u1ebd \u0111\u01b0\u1ee3c chu\u1ea9n h\u00f3a th\u00e0nh b\u1ea3ng ph\u1ee5 tr\u1ee3 nh\u1eb1m:</p> <ul> <li>Cho ph\u00e9p mapping UI label, icon, m\u00e0u s\u1eafc (cho frontend)</li> <li>H\u1ed7 tr\u1ee3 localization n\u1ebfu c\u1ea7n \u0111a ng\u00f4n ng\u1eef</li> <li>Tr\u00e1nh hard-code gi\u00e1 tr\u1ecb ENUM \u1edf frontend</li> </ul>"},{"location":"services/notification-service/master/data-model/#ui_enum_channel_types","title":"\ud83d\udce6 <code>ui_enum_channel_types</code>","text":"<pre><code>CREATE TABLE ui_enum_channel_types (\n    code TEXT PRIMARY KEY CHECK (code IN ('email', 'sms', 'push')),\n    label TEXT NOT NULL,        -- Label cho UI\n    icon TEXT,                  -- T\u00ean icon (n\u1ebfu c\u00f3)\n    color TEXT                  -- M\u00e3 m\u00e0u (hex)\n);\n</code></pre> code label icon color email Email mail #1D4ED8 sms SMS message #059669 push Push Message bell #F59E0B"},{"location":"services/notification-service/master/data-model/#ui_enum_statuses","title":"\ud83d\udce6 <code>ui_enum_statuses</code>","text":"<pre><code>CREATE TABLE ui_enum_statuses (\n    code TEXT PRIMARY KEY CHECK (code IN ('queued', 'sent', 'failed')),\n    label TEXT NOT NULL,\n    color TEXT,\n    is_error BOOLEAN DEFAULT false\n);\n</code></pre> code label color is_error queued \u0110ang x\u1eed l\u00fd #E0E7FF false sent \u0110\u00e3 g\u1eedi #A7F3D0 false failed Th\u1ea5t b\u1ea1i #FCA5A5 true <p>\ud83d\udcda Ghi ch\u00fa:</p> <ul> <li>C\u00e1c b\u1ea3ng n\u00e0y kh\u00f4ng d\u00f9ng trong x\u1eed l\u00fd nghi\u1ec7p v\u1ee5, ch\u1ec9 ph\u1ee5c v\u1ee5 frontend qu\u1ea3n tr\u1ecb.</li> <li>C\u00f3 th\u1ec3 s\u1eed d\u1ee5ng API ri\u00eang <code>/ui-enum/channel-types</code> ho\u1eb7c <code>/ui-enum/statuses</code> \u0111\u1ec3 tr\u1ea3 v\u1ec1 mapping JSON.</li> </ul>"},{"location":"services/notification-service/master/data-model/#phu-luc-cac-su-kien-do-service-nay-phat-ra-outbound-events","title":"\ud83d\udd14 Ph\u1ee5 l\u1ee5c \u2013 C\u00e1c s\u1ef1 ki\u1ec7n do Service n\u00e0y ph\u00e1t ra (Outbound Events)","text":"<p>Notification Service (Master) kh\u00f4ng ch\u1ec9 consume t\u1eeb c\u00e1c service kh\u00e1c, m\u00e0 c\u00f2n ph\u00e1t ra s\u1ef1 ki\u1ec7n l\u00ean Pub/Sub sau khi x\u1eed l\u00fd ho\u00e0n t\u1ea5t.</p> <p>T\u1ea5t c\u1ea3 s\u1ef1 ki\u1ec7n ph\u00e1t ra \u0111\u1ec1u tu\u00e2n th\u1ee7 schema chu\u1ea9n ADR-030.</p>"},{"location":"services/notification-service/master/data-model/#su-kien-global_notification_requested","title":"\ud83d\udce4 S\u1ef1 ki\u1ec7n: <code>global_notification_requested</code>","text":"<p>\u0110\u01b0\u1ee3c ph\u00e1t ra khi Notification Master nh\u1eadn s\u1ef1 ki\u1ec7n t\u1eeb service kh\u00e1c v\u00e0 quy\u1ebft \u0111\u1ecbnh g\u1eedi xu\u1ed1ng Sub Service \u0111\u1ec3 x\u1eed l\u00fd theo tenant-specific rule.</p> Tr\u01b0\u1eddng Ki\u1ec3u DL M\u00f4 t\u1ea3 <code>event_type</code> string <code>global_notification_requested</code> <code>data</code> object Th\u00f4ng tin c\u1ea7n thi\u1ebft \u0111\u1ec3 Sub service render &amp; g\u1eedi <code>metadata</code> object G\u1ed3m <code>event_id</code>, <code>timestamp</code>, <code>source_service</code>, <code>tenant_id</code> n\u1ebfu c\u00f3"},{"location":"services/notification-service/master/data-model/#payload-mau","title":"\ud83d\udce6 Payload m\u1eabu","text":"<pre><code>{\n  \"event_type\": \"global_notification_requested\",\n  \"data\": {\n    \"template_id\": \"tpl-001\",\n    \"recipient\": \"parent@vas.edu.vn\",\n    \"channel\": \"email\",\n    \"params\": {\n      \"name\": \"Ph\u1ee5 huynh A\",\n      \"code\": \"ABC123\"\n    }\n  },\n  \"metadata\": {\n    \"event_id\": \"evt-vas-789\",\n    \"timestamp\": \"2025-06-05T13:00:00Z\",\n    \"source_service\": \"notification-service.master\",\n    \"tenant_id\": \"tenant-001\"\n  }\n}\n</code></pre>"},{"location":"services/notification-service/master/data-model/#ghi-chu_1","title":"\ud83e\udde0 Ghi ch\u00fa","text":"<ul> <li>Event n\u00e0y \u0111\u00f3ng vai tr\u00f2 l\u00e0m c\u1ea7u n\u1ed1i gi\u1eefa master \u2192 sub theo c\u01a1 ch\u1ebf multi-tenant.</li> <li>Sub Service l\u1eafng nghe topic <code>global_notification_requested</code> \u0111\u1ec3:</li> <li>Ki\u1ec3m tra c\u1ea5u h\u00ecnh override theo tenant</li> <li>G\u1eedi th\u1eadt \u0111\u1ebfn ng\u01b0\u1eddi d\u00f9ng c\u1ee5 th\u1ec3</li> <li>Ghi log ri\u00eang bi\u1ec7t trong v\u00f9ng d\u1eef li\u1ec7u tenant-local</li> <li>N\u1ebfu h\u1ec7 th\u1ed1ng c\u00f3 nhu c\u1ea7u t\u00edch h\u1ee3p v\u1edbi 3rd-party (CRM, Firebase Cloud Messaging\u2026), adapter c\u0169ng c\u00f3 th\u1ec3 subscribe s\u1ef1 ki\u1ec7n n\u00e0y.</li> </ul>"},{"location":"services/notification-service/master/data-model/#10-lien-ket-tai-lieu","title":"10. \ud83d\udcda Li\u00ean k\u1ebft T\u00e0i li\u1ec7u","text":"<ul> <li>Design</li> <li>Interface Contract</li> <li>OpenAPI</li> <li>ADR-008 \u2013 Audit Logging</li> <li>ADR-027 - Data Management</li> <li>ADR-030 - Event Schema Governance</li> </ul>"},{"location":"services/notification-service/master/design/","title":"\ud83d\udcd8 Thi\u1ebft k\u1ebf chi ti\u1ebft Notification Service (Master)","text":""},{"location":"services/notification-service/master/design/#1-pham-vi-va-trach-nhiem-scope-responsibilities","title":"1. \ud83e\udded Ph\u1ea1m vi v\u00e0 Tr\u00e1ch nhi\u1ec7m (Scope &amp; Responsibilities)","text":""},{"location":"services/notification-service/master/design/#muc-tieu","title":"\ud83c\udfaf M\u1ee5c ti\u00eau","text":"<ul> <li>G\u1eedi th\u00f4ng b\u00e1o \u0111a k\u00eanh (email, SMS, push) theo c\u1ea5u h\u00ecnh template.</li> <li>Cho ph\u00e9p qu\u1ea3n tr\u1ecb h\u1ec7 th\u1ed1ng t\u1ea1o v\u00e0 c\u1eadp nh\u1eadt template th\u00f4ng b\u00e1o theo lo\u1ea1i s\u1ef1 ki\u1ec7n.</li> <li>Cung c\u1ea5p API v\u00e0 Pub/Sub \u0111\u1ec3 c\u00e1c service kh\u00e1c s\u1eed d\u1ee5ng g\u1eedi th\u00f4ng b\u00e1o th\u00f4ng qua c\u1ea5u h\u00ecnh chu\u1ea9n h\u00f3a.</li> </ul>"},{"location":"services/notification-service/master/design/#cac-thuc-the-du-lieu-quan-ly","title":"\ud83d\udce6 C\u00e1c th\u1ef1c th\u1ec3 d\u1eef li\u1ec7u qu\u1ea3n l\u00fd","text":"Th\u1ef1c th\u1ec3 M\u00f4 t\u1ea3 NotificationTemplate \u0110\u1ecbnh ngh\u0129a c\u00e1c m\u1eabu th\u00f4ng b\u00e1o (template) theo lo\u1ea1i k\u00eanh v\u00e0 lo\u1ea1i s\u1ef1 ki\u1ec7n. NotificationLog Ghi nh\u1eadn l\u1ecbch s\u1eed g\u1eedi th\u00f4ng b\u00e1o th\u00e0nh c\u00f4ng/th\u1ea5t b\u1ea1i. NotificationChannelCfg C\u1ea5u h\u00ecnh g\u1eedi theo k\u00eanh: SMTP, SMS provider, push gateway."},{"location":"services/notification-service/master/design/#ngoai-pham-vi-out-of-scope","title":"\ud83d\udd12 Ngo\u00e0i Ph\u1ea1m Vi (Out of Scope)","text":"<ul> <li>\u274c Kh\u00f4ng qu\u1ea3n l\u00fd ng\u01b0\u1eddi d\u00f9ng nh\u1eadn th\u00f4ng b\u00e1o (do User Service \u0111\u1ea3m nhi\u1ec7m).</li> <li>\u274c Kh\u00f4ng th\u1ef1c hi\u1ec7n x\u1eed l\u00fd n\u1ed9i dung c\u00e1 nh\u00e2n h\u00f3a ngo\u00e0i c\u00e1c placeholder \u0111\u00e3 \u0111\u01b0\u1ee3c backend \u0111\u1ed5 v\u00e0o.</li> <li>\u274c Kh\u00f4ng l\u01b0u tr\u1eef n\u1ed9i dung email \u0111\u1ea7y \u0111\u1ee7 (ch\u1ec9 metadata v\u00e0 status).</li> <li>\u274c Kh\u00f4ng ph\u00e1t h\u00e0nh/sinh s\u1ef1 ki\u1ec7n nghi\u1ec7p v\u1ee5 (ch\u1ec9 nh\u1eadn v\u00e0 g\u1eedi).</li> <li>\u274c Kh\u00f4ng th\u1ef1c hi\u1ec7n retry ph\u00e2n t\u00e1n \u2013 retry n\u1eb1m trong queue ho\u1eb7c x\u1eed l\u00fd l\u1ed7i ri\u00eang bi\u1ec7t.</li> </ul>"},{"location":"services/notification-service/master/design/#2-thiet-ke-api-chi-tiet-interface-contract","title":"2. \ud83c\udf10 Thi\u1ebft k\u1ebf API chi ti\u1ebft (Interface Contract)","text":"Method Path T\u00e1c v\u1ee5 Y\u00eau c\u1ea7u permission GET /templates L\u1ea5y danh s\u00e1ch template hi\u1ec7n c\u00f3 \u2705 <code>notif.read_template</code> POST /templates T\u1ea1o template m\u1edbi \u2705 <code>notif.write_template</code> PUT /templates/{id} C\u1eadp nh\u1eadt n\u1ed9i dung template \u2705 <code>notif.write_template</code> POST /send G\u1eedi m\u1ed9t th\u00f4ng b\u00e1o th\u1ee7 c\u00f4ng (manual) \u2705 <code>notif.send_manual</code> <p>Tu\u00e2n th\u1ee7: - <code>ADR-011</code> \u2013 \u0111\u1ecbnh d\u1ea1ng l\u1ed7i chu\u1ea9n. - <code>ADR-012</code> \u2013 chu\u1ea9n c\u1ea5u tr\u00fac response. - <code>ADR-030</code> \u2013 qu\u1ea3n l\u00fd schema event g\u1eedi \u0111i.</p>"},{"location":"services/notification-service/master/design/#vi-du-response-post-send","title":"\ud83d\udce6 V\u00ed d\u1ee5 response <code>POST /send</code>","text":"<pre><code>{\n  \"data\": {\n    \"status\": \"queued\",\n    \"notification_id\": \"notif-123\"\n  },\n  \"meta\": {\n    \"request_id\": \"req-xyz-789\",\n    \"timestamp\": \"2025-06-05T13:20:00Z\"\n  }\n}\n</code></pre> <p>Chi ti\u1ebft t\u1ea1i Interface Contract &amp; OpenAPI Spec</p>"},{"location":"services/notification-service/master/design/#3-mo-hinh-du-lieu-chi-tiet-data-model","title":"3. \ud83d\uddc3\ufe0f M\u00f4 h\u00ecnh d\u1eef li\u1ec7u chi ti\u1ebft (Data Model)","text":""},{"location":"services/notification-service/master/design/#so-o-erd-mermaid","title":"\ud83d\uddfa\ufe0f S\u01a1 \u0111\u1ed3 ERD (Mermaid)","text":"<pre><code>erDiagram\n  NotificationTemplate ||--o{ NotificationLog : uses\n  NotificationChannelCfg ||--o{ NotificationTemplate : configures\n\n  NotificationTemplate {\n    UUID id PK\n    STRING name\n    STRING type  // email, sms, push\n    TEXT content\n    STRING language\n    STRING trigger_event\n  }\n\n  NotificationLog {\n    UUID id PK\n    UUID template_id FK\n    STRING recipient\n    STRING status // success, failed\n    TEXT error_message\n    DATETIME sent_at\n  }\n\n  NotificationChannelCfg {\n    STRING channel_type PK // email, sms, push\n    STRING provider\n    JSON config\n  }\n</code></pre> <p>Chi ti\u1ebft t\u1ea1i Data Model</p>"},{"location":"services/notification-service/master/design/#4-luong-xu-ly-nghiep-vu-chinh-business-logic-flows","title":"4. \ud83d\udd04 Lu\u1ed3ng x\u1eed l\u00fd nghi\u1ec7p v\u1ee5 ch\u00ednh (Business Logic Flows)","text":""},{"location":"services/notification-service/master/design/#luong-gui-thong-bao-qua-su-kien-noi-bo","title":"Lu\u1ed3ng: G\u1eedi th\u00f4ng b\u00e1o qua s\u1ef1 ki\u1ec7n n\u1ed9i b\u1ed9","text":"<pre><code>sequenceDiagram\n  participant SourceService\n  participant NotificationService\n  participant Queue\n  participant ChannelProvider\n\n  SourceService-&gt;&gt;NotificationService: Emit s\u1ef1 ki\u1ec7n `user.created`\n  NotificationService-&gt;&gt;Queue: Queue x\u1eed l\u00fd g\u1eedi notif\n  Queue-&gt;&gt;NotificationService: Consume v\u00e0 render n\u1ed9i dung\n  NotificationService-&gt;&gt;ChannelProvider: G\u1eedi th\u00f4ng b\u00e1o \u0111\u1ebfn ng\u01b0\u1eddi d\u00f9ng\n  ChannelProvider--&gt;&gt;NotificationService: K\u1ebft qu\u1ea3 g\u1eedi th\u00e0nh c\u00f4ng/th\u1ea5t b\u1ea1i\n</code></pre> <ol> <li>D\u1ecbch v\u1ee5 kh\u00e1c ph\u00e1t s\u1ef1 ki\u1ec7n (VD: user.created)</li> <li>Notification Service consume t\u1eeb queue v\u00e0 render template</li> <li>G\u1eedi \u0111\u1ebfn k\u00eanh t\u01b0\u01a1ng \u1ee9ng (email/SMS/push)</li> <li>Log l\u1ea1i k\u1ebft qu\u1ea3 g\u1eedi</li> </ol>"},{"location":"services/notification-service/master/design/#5-cac-su-kien-pubsub-events","title":"5. \ud83d\udce3 C\u00e1c s\u1ef1 ki\u1ec7n Pub/Sub (Events)","text":"S\u1ef1 ki\u1ec7n nh\u1eadn/ph\u00e1t Ngu\u1ed3n ph\u00e1t / \u0110\u00edch nh\u1eadn H\u00e0nh \u0111\u1ed9ng t\u1ea1i Service n\u00e0y <code>user.created</code> user-service.master G\u1eedi welcome email d\u1ef1a tr\u00ean template c\u1ea5u h\u00ecnh <code>password.reset_requested</code> auth-service.master G\u1eedi email reset password"},{"location":"services/notification-service/master/design/#payload-mau-usercreated","title":"\ud83d\udce6 Payload m\u1eabu <code>user.created</code>","text":"<pre><code>{\n  \"event_type\": \"user.created\",\n  \"data\": {\n    \"user_id\": \"u123\",\n    \"email\": \"newuser@vas.edu.vn\",\n    \"full_name\": \"Nguy\u1ec5n V\u0103n A\"\n  },\n  \"metadata\": {\n    \"event_id\": \"evt-555\",\n    \"timestamp\": \"2025-06-05T09:00:00Z\",\n    \"source_service\": \"user-service.master\"\n  }\n}\n</code></pre>"},{"location":"services/notification-service/master/design/#6-bao-mat-phan-quyen-security-authorization","title":"6. \ud83d\udd10 B\u1ea3o m\u1eadt &amp; Ph\u00e2n quy\u1ec1n (Security &amp; Authorization)","text":"<ul> <li>Authentication: th\u00f4ng qua JWT \u0111\u01b0\u1ee3c Gateway x\u00e1c th\u1ef1c</li> <li>Authorization:</li> <li>enforce b\u1edfi API Gateway qua header <code>X-Permissions</code></li> <li>permission li\u00ean quan: <code>notif.read_template</code>, <code>notif.send_manual</code>, <code>notif.write_template</code></li> <li>c\u00e1c API public qua event kh\u00f4ng c\u1ea7n token</li> </ul>"},{"location":"services/notification-service/master/design/#7-cau-hinh-phu-thuoc","title":"7. \u2699\ufe0f C\u1ea5u h\u00ecnh &amp; Ph\u1ee5 thu\u1ed9c","text":"Th\u00e0nh ph\u1ea7n M\u1ee5c \u0111\u00edch Ghi ch\u00fa <code>NOTIF_DB_URL</code> K\u1ebft n\u1ed1i CSDL PostgreSQL <code>KAFKA_BROKERS</code> Consume s\u1ef1 ki\u1ec7n Tham kh\u1ea3o config chung <code>SMTP_CONFIG</code> G\u1eedi email JSON ho\u1eb7c secrets <code>SMS_API_KEY</code> G\u1eedi SMS secrets <code>PUSH_API_TOKEN</code> G\u1eedi push notification optional <code>TOPIC_user.created</code> Topic nh\u1eadn event user T\u1eeb user-service.master"},{"location":"services/notification-service/master/design/#8-testing","title":"8. \ud83e\uddea Testing","text":"<ul> <li>Unit Test: TemplateRenderer, LogWriter</li> <li>Integration Test: Consume event <code>user.created</code>, assert log g\u1eedi email \u0111\u00fang</li> <li>Mock provider: g\u1eedi gi\u1ea3 l\u1eadp qua SMTP ho\u1eb7c sandbox mode</li> </ul>"},{"location":"services/notification-service/master/design/#9-kha-nang-giam-sat-observability","title":"9. \ud83d\udcc8 Kh\u1ea3 n\u0103ng Gi\u00e1m s\u00e1t (Observability)","text":"Metric M\u00f4 t\u1ea3 Lo\u1ea1i <code>notif_event_consumed_total</code> T\u1ed5ng event \u0111\u00e3 x\u1eed l\u00fd Counter <code>notif_send_duration_seconds</code> Th\u1eddi gian g\u1eedi m\u1ed7i th\u00f4ng b\u00e1o Histogram <code>notif_send_failure_total</code> Th\u1ed1ng k\u00ea g\u1eedi l\u1ed7i Counter <code>notif_template_used_total</code> Th\u1ed1ng k\u00ea template \u0111\u01b0\u1ee3c d\u00f9ng Counter"},{"location":"services/notification-service/master/design/#10-o-tin-cay-phuc-hoi","title":"10. \ud83d\udd01 \u0110\u1ed9 tin c\u1eady &amp; Ph\u1ee5c h\u1ed3i","text":"<ul> <li>Retry 3 l\u1ea7n n\u1ebfu g\u1eedi l\u1ed7i (SMTP timeout...)</li> <li>C\u00f3 DLQ cho c\u00e1c event l\u1ed7i kh\u00f4ng x\u1eed l\u00fd \u0111\u01b0\u1ee3c</li> <li>Idempotent theo <code>event_id</code></li> <li>Health check t\u1ea1i <code>/healthz</code></li> </ul>"},{"location":"services/notification-service/master/design/#11-hieu-nang-kha-nang-mo-rong","title":"11. \u26a1\ufe0f Hi\u1ec7u n\u0103ng &amp; Kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng","text":"<ul> <li>Stateless \u2192 scale theo instance</li> <li>SLO: g\u1eedi 95% th\u00f4ng b\u00e1o trong 1s</li> <li>Caching template: TTL 10 ph\u00fat trong memory</li> </ul>"},{"location":"services/notification-service/master/design/#12-kien-truc-service","title":"12. \ud83e\udde9 Ki\u1ebfn tr\u00fac Service","text":"<p>Notification Service (Master) \u0111\u01b0\u1ee3c chia th\u00e0nh c\u00e1c module logic r\u00f5 r\u00e0ng, t\u00e1ch bi\u1ec7t tr\u00e1ch nhi\u1ec7m \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o d\u1ec5 b\u1ea3o tr\u00ec, test, v\u00e0 m\u1edf r\u1ed9ng.</p>"},{"location":"services/notification-service/master/design/#thanh-phan-chinh","title":"\ud83e\uddf1 Th\u00e0nh ph\u1ea7n ch\u00ednh","text":"Module Tr\u00e1ch nhi\u1ec7m ch\u00ednh <code>TemplateManager</code> Qu\u1ea3n l\u00fd CRUD template, h\u1ed7 tr\u1ee3 render n\u1ed9i dung v\u1edbi placeholder &amp; multi-language <code>EventConsumer</code> L\u1eafng nghe s\u1ef1 ki\u1ec7n t\u1eeb Pub/Sub (Kafka), validate payload, v\u00e0 dispatch g\u1eedi notif <code>NotificationDispatcher</code> X\u1eed l\u00fd g\u1eedi th\u00f4ng b\u00e1o \u0111\u1ebfn k\u00eanh ph\u00f9 h\u1ee3p (email, sms, push), retry n\u1ebfu l\u1ed7i t\u1ea1m th\u1eddi <code>ChannelConfigManager</code> Qu\u1ea3n l\u00fd c\u1ea5u h\u00ecnh SMTP, SMS provider, token cho c\u00e1c k\u00eanh g\u1eedi <code>LogWriter</code> Ghi log g\u1eedi th\u00f4ng b\u00e1o (th\u00e0nh c\u00f4ng/th\u1ea5t b\u1ea1i), ph\u1ee5c v\u1ee5 audit &amp; th\u1ed1ng k\u00ea <code>APIController</code> X\u1eed l\u00fd c\u00e1c API RESTful (template CRUD, g\u1eedi th\u1ee7 c\u00f4ng), enforce RBAC"},{"location":"services/notification-service/master/design/#so-o-kien-truc-noi-bo-mermaid","title":"\ud83e\udded S\u01a1 \u0111\u1ed3 ki\u1ebfn tr\u00fac n\u1ed9i b\u1ed9 (Mermaid)","text":"<pre><code>flowchart TD\n  A[Pub/Sub Topic] --&gt; B(EventConsumer)\n  B --&gt; C[TemplateManager]\n  C --&gt; D[NotificationDispatcher]\n  D --&gt; E[ChannelConfigManager]\n  D --&gt; F[LogWriter]\n\n  subgraph REST API\n    G(APIController) --&gt; C\n    G --&gt; D\n    G --&gt; LogWriter\n  end\n</code></pre>"},{"location":"services/notification-service/master/design/#tuong-tac-chinh","title":"\ud83d\udd17 T\u01b0\u01a1ng t\u00e1c ch\u00ednh","text":"<ul> <li><code>EventConsumer</code> s\u1eed d\u1ee5ng <code>TemplateManager</code> \u0111\u1ec3 l\u1ea5y n\u1ed9i dung template, g\u1ecdi <code>NotificationDispatcher</code> \u0111\u1ec3 th\u1ef1c thi g\u1eedi.</li> <li><code>Dispatcher</code> truy c\u1eadp <code>ChannelConfigManager</code> \u0111\u1ec3 l\u1ea5y th\u00f4ng tin provider v\u00e0 g\u1eedi message.</li> <li>M\u1ecdi k\u1ebft qu\u1ea3 g\u1eedi \u0111\u01b0\u1ee3c ghi l\u1ea1i b\u1edfi <code>LogWriter</code> k\u00e8m <code>trace_id</code>, <code>status</code>, <code>template_id</code>.</li> <li><code>APIController</code> cung c\u1ea5p giao di\u1ec7n qu\u1ea3n l\u00fd template, g\u1eedi th\u1ee7 c\u00f4ng, d\u00f9ng chung module b\u00ean trong.</li> </ul> <p>\ud83d\udcda Xem th\u00eam: - Lu\u1ed3ng sequence event g\u1eedi trong m\u1ee5c 4 - M\u00f4 h\u00ecnh d\u1eef li\u1ec7u trong m\u1ee5c 3 - Event schema v\u00e0 permission li\u00ean quan trong ADR-007, 030</p>"},{"location":"services/notification-service/master/design/#13-tai-lieu-lien-ket","title":"13. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean k\u1ebft","text":"<ul> <li>Interface Contract</li> <li>Data Model</li> <li>OpenAPI Spec</li> <li>[ADR-028 \u2013 Reporting Architecture (li\u00ean quan vi\u1ec7c ti\u00eau chu\u1ea9n h\u00f3a template)]</li> <li>[ADR-030 \u2013 Event Schema Governance]</li> <li>[ADR-007 \u2013 RBAC ph\u00e2n t\u1ea7ng]</li> </ul>"},{"location":"services/notification-service/master/interface-contract/","title":"\ud83d\udcd8 Notification Service (Master) \u2013 Interface Contract","text":"<p>Service n\u00e0y ch\u1ecbu tr\u00e1ch nhi\u1ec7m g\u1eedi th\u00f4ng b\u00e1o \u0111a k\u00eanh (email, sms, push) theo template \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a s\u1eb5n, s\u1eed d\u1ee5ng b\u1edfi c\u00e1c service kh\u00e1c th\u00f4ng qua Pub/Sub ho\u1eb7c g\u1ecdi API tr\u1ef1c ti\u1ebfp. Kh\u00f4ng qu\u1ea3n l\u00fd ng\u01b0\u1eddi nh\u1eadn c\u1ee5 th\u1ec3 (user), kh\u00f4ng t\u1ea1o n\u1ed9i dung \u0111\u1ed9ng m\u00e0 nh\u1eadn payload \u0111\u00e3 chu\u1ea9n h\u00f3a t\u1eeb c\u00e1c d\u1ecbch v\u1ee5 ngu\u1ed3n.</p> <p>\ud83e\udded Nguy\u00ean t\u1eafc chung: - T\u1ea5t c\u1ea3 API \u0111\u1ec1u y\u00eau c\u1ea7u header <code>Authorization: Bearer &lt;JWT&gt;</code> tr\u1eeb khi l\u00e0 Pub/Sub consumer. - Response tu\u00e2n th\u1ee7 ADR-012 Response Structure. - L\u1ed7i tu\u00e2n th\u1ee7 ADR-011 Error Format. - M\u1ed7i API c\u00f3 <code>permission_code</code> r\u00f5 r\u00e0ng theo [ADR-007].</p>"},{"location":"services/notification-service/master/interface-contract/#api-templates","title":"\ud83d\udccc API: <code>/templates</code>","text":"<p>Danh s\u00e1ch API ph\u1ee5c v\u1ee5 qu\u1ea3n l\u00fd <code>NotificationTemplate</code></p> Method Path M\u00f4 t\u1ea3 Quy\u1ec1n GET /templates L\u1ea5y danh s\u00e1ch template <code>notif.read_template</code> POST /templates T\u1ea1o m\u1edbi template <code>notif.write_template</code> PUT /templates/{id} C\u1eadp nh\u1eadt template <code>notif.write_template</code>"},{"location":"services/notification-service/master/interface-contract/#api-send","title":"\ud83d\udccc API: <code>/send</code>","text":"Method Path M\u00f4 t\u1ea3 Quy\u1ec1n POST /send G\u1eedi th\u00f4ng b\u00e1o th\u1ee7 c\u00f4ng <code>notif.send_manual</code>"},{"location":"services/notification-service/master/interface-contract/#chi-tiet-api","title":"\ud83e\uddea Chi ti\u1ebft API","text":""},{"location":"services/notification-service/master/interface-contract/#1-get-templates","title":"1. <code>GET /templates</code>","text":"<p>L\u1ea5y danh s\u00e1ch template theo paging.</p> <p>Response m\u1eabu (200 OK):</p> <pre><code>{\n  \"data\": [\n    {\n      \"id\": \"tpl-001\",\n      \"name\": \"welcome_email\",\n      \"type\": \"email\",\n      \"language\": \"vi\",\n      \"trigger_event\": \"user.created\"\n    }\n  ],\n  \"meta\": {\n    \"request_id\": \"req-001\",\n    \"timestamp\": \"2025-06-05T09:00:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/notification-service/master/interface-contract/#2-post-templates","title":"2. <code>POST /templates</code>","text":"<p>T\u1ea1o template m\u1edbi.</p> <p>Request:</p> <pre><code>{\n  \"name\": \"reset_sms\",\n  \"type\": \"sms\",\n  \"language\": \"vi\",\n  \"trigger_event\": \"password.reset_requested\",\n  \"content\": \"M\u00e3 x\u00e1c th\u1ef1c c\u1ee7a b\u1ea1n l\u00e0: {{code}}\"\n}\n</code></pre> <p>Response (201 Created):</p> <pre><code>{\n  \"data\": {\n    \"id\": \"tpl-999\",\n    \"name\": \"reset_sms\",\n    ...\n  },\n  \"meta\": {\n    \"request_id\": \"req-002\",\n    \"timestamp\": \"2025-06-05T09:01:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/notification-service/master/interface-contract/#3-put-templatesid","title":"3. <code>PUT /templates/{id}</code>","text":"<p>C\u1eadp nh\u1eadt template.</p> <p>Path param: - <code>id</code>: UUID (VD: <code>tpl-999</code>)</p> <p>Request:</p> <pre><code>{\n  \"content\": \"Xin ch\u00e0o {{name}}, \u0111\u00e2y l\u00e0 h\u01b0\u1edbng d\u1eabn \u0111\u0103ng nh\u1eadp.\"\n}\n</code></pre> <p>Response:</p> <ul> <li><code>204 No Content</code></li> </ul>"},{"location":"services/notification-service/master/interface-contract/#4-post-send","title":"4. <code>POST /send</code>","text":"<p>G\u1eedi th\u00f4ng b\u00e1o th\u1ee7 c\u00f4ng.</p> <p>Request:</p> <pre><code>{\n  \"template_id\": \"tpl-001\",\n  \"recipient\": \"student@vas.edu.vn\",\n  \"channel\": \"email\",\n  \"params\": {\n    \"name\": \"Nguy\u1ec5n V\u0103n A\"\n  }\n}\n</code></pre> <p>Response (202 Accepted):</p> <pre><code>{\n  \"data\": {\n    \"status\": \"queued\",\n    \"notification_id\": \"notif-abc123\"\n  },\n  \"meta\": {\n    \"request_id\": \"req-003\",\n    \"timestamp\": \"2025-06-05T09:02:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/notification-service/master/interface-contract/#quyen-truy-cap-rbac","title":"\ud83d\udd10 Quy\u1ec1n truy c\u1eadp (RBAC)","text":"permission_code M\u00f4 t\u1ea3 \u00c1p d\u1ee5ng cho API notif.read_template \u0110\u1ecdc template <code>GET /templates</code> notif.write_template T\u1ea1o/C\u1eadp nh\u1eadt template <code>POST/PUT /templates</code> notif.send_manual G\u1eedi th\u00f4ng b\u00e1o th\u1ee7 c\u00f4ng <code>POST /send</code>"},{"location":"services/notification-service/master/interface-contract/#enums","title":"\ud83d\udcce ENUMs","text":"Tr\u01b0\u1eddng Gi\u00e1 tr\u1ecb h\u1ee3p l\u1ec7 M\u00f4 t\u1ea3 <code>type</code> <code>email</code>, <code>sms</code>, <code>push</code> Lo\u1ea1i k\u00eanh th\u00f4ng b\u00e1o <code>status</code> <code>queued</code>, <code>sent</code>, <code>failed</code> Tr\u1ea1ng th\u00e1i g\u1eedi"},{"location":"services/notification-service/master/interface-contract/#event-triggered-interface","title":"\ud83d\udd14 Event-triggered Interface","text":"<p>Service n\u00e0y ch\u1ee7 y\u1ebfu nh\u1eadn c\u00e1c s\u1ef1 ki\u1ec7n n\u1ed9i b\u1ed9 t\u1eeb c\u00e1c d\u1ecbch v\u1ee5 kh\u00e1c \u0111\u1ec3 g\u1eedi th\u00f4ng b\u00e1o theo template c\u1ea5u h\u00ecnh. C\u00e1c s\u1ef1 ki\u1ec7n \u0111\u01b0\u1ee3c ti\u00eau chu\u1ea9n h\u00f3a theo ADR-030 Event Schema Governance.</p> Event Type Source Service M\u00f4 t\u1ea3 h\u00e0nh \u0111\u1ed9ng x\u1eed l\u00fd Y\u00eau c\u1ea7u c\u1ea5u h\u00ecnh template <code>user.created</code> <code>user-service.master</code> G\u1eedi email ch\u00e0o m\u1eebng <code>trigger_event = user.created</code> <code>password.reset_requested</code> <code>auth-service.master</code> G\u1eedi email/SMS ch\u1ee9a m\u00e3 x\u00e1c th\u1ef1c <code>trigger_event = password.reset_requested</code> <code>report.generated</code> <code>reporting-service</code> G\u1eedi email k\u00e8m link t\u1ea3i b\u00e1o c\u00e1o <code>trigger_event = report.generated</code>"},{"location":"services/notification-service/master/interface-contract/#vi-du-event-schema-usercreated","title":"\ud83d\udce6 V\u00ed d\u1ee5 event schema: <code>user.created</code>","text":"<pre><code>{\n  \"event_type\": \"user.created\",\n  \"data\": {\n    \"user_id\": \"u123\",\n    \"email\": \"student@vas.edu.vn\",\n    \"full_name\": \"Nguy\u1ec5n V\u0103n A\"\n  },\n  \"metadata\": {\n    \"event_id\": \"evt-xyz123\",\n    \"timestamp\": \"2025-06-05T09:00:00Z\",\n    \"source_service\": \"user-service.master\"\n  }\n}\n</code></pre> <p>L\u01b0u \u00fd: M\u1ed7i event s\u1ebd \u0111\u01b0\u1ee3c \u00e1nh x\u1ea1 t\u1edbi template ph\u00f9 h\u1ee3p d\u1ef1a tr\u00ean <code>trigger_event</code>. N\u1ed9i dung th\u00f4ng b\u00e1o s\u1ebd \u0111\u01b0\u1ee3c render t\u1eeb <code>template.content</code> v\u00e0 <code>params = data</code>.</p>"},{"location":"services/notification-service/master/interface-contract/#phu-luc","title":"\ud83d\udcce Ph\u1ee5 l\u1ee5c","text":""},{"location":"services/notification-service/master/interface-contract/#chuan-hoa-ma-loi-error-codes","title":"\ud83d\udcda Chu\u1ea9n h\u00f3a m\u00e3 l\u1ed7i (Error Codes)","text":"<p>T\u1ea5t c\u1ea3 c\u00e1c m\u00e3 l\u1ed7i (<code>error.code</code>) trong response ph\u1ea3i tu\u00e2n th\u1ee7 theo chu\u1ea9n \u0111\u1ecbnh danh namespace \u0111\u01b0\u1ee3c m\u00f4 t\u1ea3 t\u1ea1i:</p> <ul> <li>Error Codes</li> <li>ADR-011 Error Format</li> </ul> <p>Y\u00eau c\u1ea7u b\u1eaft bu\u1ed9c:</p> <ul> <li> <p>M\u00e3 l\u1ed7i ph\u1ea3i vi\u1ebft theo d\u1ea1ng snake_case, c\u00f3 namespace ph\u00e2n t\u00e1ch r\u00f5 r\u00e0ng, v\u00ed d\u1ee5:</p> </li> <li> <p><code>user.user_not_found</code></p> </li> <li><code>auth.invalid_token</code></li> <li><code>common.validation_failed</code></li> <li> <p>M\u1ed7i response l\u1ed7i (401, 403, 404, 422...) ph\u1ea3i tr\u1ea3 v\u1ec1 \u0111\u1ed1i t\u01b0\u1ee3ng <code>ErrorEnvelope</code>, g\u1ed3m 2 ph\u1ea7n:</p> </li> <li> <p><code>error</code> \u2013 ch\u1ee9a <code>code</code>, <code>message</code>, <code>details</code></p> </li> <li><code>meta</code> \u2013 ch\u1ee9a <code>trace_id</code>, <code>timestamp</code></li> </ul> <p>G\u1ee3i \u00fd th\u1ef1c h\u00e0nh:</p> <ul> <li>Kh\u00f4ng d\u00f9ng c\u00e1c m\u00e3 l\u1ed7i chung chung nh\u01b0 <code>\"BAD_REQUEST\"</code>, <code>\"NOT_FOUND\"</code>, <code>\"FORBIDDEN\"</code></li> <li>Lu\u00f4n khai b\u00e1o v\u00ed d\u1ee5 c\u1ee5 th\u1ec3 (v\u00ed d\u1ee5 trong <code>components/examples/</code> ho\u1eb7c inline OpenAPI) \u0111\u1ec3 gi\u00fap dev hi\u1ec3u nhanh</li> <li>T\u00e1i s\u1eed d\u1ee5ng error namespace c\u00f3 s\u1eb5n t\u1eeb <code>error-codes.md</code> ho\u1eb7c khai b\u00e1o namespace m\u1edbi n\u1ebfu c\u1ea7n</li> </ul>"},{"location":"services/notification-service/master/interface-contract/#tai-lieu-lien-quan","title":"\ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan:","text":"<ul> <li>Design</li> <li>Data Model</li> <li>OpenAPI</li> <li>ADR-007 \u2013 RBAC</li> <li>ADR-030 \u2013 Event Schema Governance</li> <li>ADR-011 Error Format</li> <li>ADR-027 Data Management Strategy</li> <li>Error Codes</li> </ul>"},{"location":"services/notification-service/sub/data-model/","title":"\ud83d\udce6 Notification Sub Service \u2013 Data Model","text":"<p>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 chi ti\u1ebft c\u00e1c th\u1ef1c th\u1ec3 d\u1eef li\u1ec7u c\u1ed1t l\u00f5i c\u1ee7a Notification Sub Service, bao g\u1ed3m schema, quan h\u1ec7, v\u00e0 c\u00e1c l\u01b0u \u00fd v\u1ec1 b\u1ea3o m\u1eadt, \u1ea9n danh v\u00e0 chu\u1ea9n h\u00f3a schema theo chu\u1ea9n \u0111a tenant.</p>"},{"location":"services/notification-service/sub/data-model/#1-muc-tieu-pham-vi","title":"1. \ud83c\udfaf M\u1ee5c ti\u00eau &amp; Ph\u1ea1m vi","text":"<p>Ph\u1ea7n n\u00e0y x\u00e1c \u0111\u1ecbnh r\u00f5 ph\u1ea1m vi d\u1eef li\u1ec7u m\u00e0 Notification Sub Service qu\u1ea3n l\u00fd, \u0111\u1ed3ng th\u1eddi nh\u1ea5n m\u1ea1nh m\u1ee5c ti\u00eau thi\u1ebft k\u1ebf d\u1eef li\u1ec7u \u0111a tenant, c\u00f3 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng, ki\u1ec3m th\u1eed v\u00e0 truy v\u1ebft.</p>"},{"location":"services/notification-service/sub/data-model/#muc-tieu","title":"\ud83c\udfaf M\u1ee5c ti\u00eau","text":"<ul> <li>Cung c\u1ea5p m\u00f4 h\u00ecnh d\u1eef li\u1ec7u chu\u1ea9n h\u00f3a \u0111\u1ec3 l\u01b0u tr\u1eef c\u00e1c ho\u1ea1t \u0111\u1ed9ng g\u1eedi notification cho t\u1eebng tenant.</li> <li>H\u1ed7 tr\u1ee3 vi\u1ec7c truy v\u1ea5n hi\u1ec7u qu\u1ea3 th\u00f4ng tin log \u0111\u00e3 g\u1eedi theo nhi\u1ec1u ti\u00eau ch\u00ed: event, channel, tr\u1ea1ng th\u00e1i, ng\u01b0\u1eddi nh\u1eadn.</li> <li>Cho ph\u00e9p mapping \u0111\u1ed9ng gi\u1eefa event_code + channel \u2192 template t\u00f9y theo tenant.</li> <li>L\u01b0u tr\u1eef c\u1ea5u h\u00ecnh k\u00eanh g\u1eedi ri\u00eang cho m\u1ed7i tenant v\u1edbi kh\u1ea3 n\u0103ng b\u1eadt/t\u1eaft v\u00e0 fallback.</li> <li>\u0110\u1ea3m b\u1ea3o d\u1eef li\u1ec7u ph\u00f9 h\u1ee3p v\u1edbi c\u00e1c y\u00eau c\u1ea7u:</li> <li>Audit &amp; Compliance theo <code>ADR-008</code></li> <li>Retention &amp; Anonymization theo <code>ADR-024</code></li> <li>Multi-tenant Isolation theo CR-04 &amp; <code>ADR-025</code></li> </ul>"},{"location":"services/notification-service/sub/data-model/#pham-vi-du-lieu-uoc-quan-ly","title":"\ud83d\udce6 Ph\u1ea1m vi d\u1eef li\u1ec7u \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd","text":"Nh\u00f3m d\u1eef li\u1ec7u M\u00f4 t\u1ea3 ng\u1eafn g\u1ecdn Notification Template Metadata v\u00e0 n\u1ed9i dung template notification per tenant + channel Notification Log Log g\u1eedi th\u1ef1c t\u1ebf, bao g\u1ed3m trace, status, l\u1ed7i, th\u1eddi gian g\u1eedi Notification Channel Config C\u1ea5u h\u00ecnh k\u00eanh g\u1eedi \u0111\u1ed9ng (SMTP, SMS Provider, \u2026) cho m\u1ed7i tenant"},{"location":"services/notification-service/sub/data-model/#nguyen-tac-thiet-ke-du-lieu","title":"\ud83d\udd12 Nguy\u00ean t\u1eafc thi\u1ebft k\u1ebf d\u1eef li\u1ec7u","text":"Ti\u00eau ch\u00ed Gi\u1ea3i th\u00edch c\u1ee5 th\u1ec3 Multi-Tenant Isolation M\u1ecdi b\u1ea3n ghi \u0111\u1ec1u b\u1eaft bu\u1ed9c c\u00f3 <code>tenant_id</code> v\u00e0 \u0111\u01b0\u1ee3c truy v\u1ea5n d\u01b0\u1edbi \u0111i\u1ec1u ki\u1ec7n isolation Traceability M\u1ed7i notification log g\u1eafn <code>trace_id</code> xuy\u00ean su\u1ed1t h\u1ec7 th\u1ed1ng Versioning Template c\u00f3 <code>version</code>, log l\u01b0u <code>template_id</code> \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o t\u00e1i hi\u1ec7n Anonymization (optional) M\u1ed9t s\u1ed1 tr\u01b0\u1eddng nh\u01b0 <code>recipient</code>, <code>payload</code> c\u00f3 th\u1ec3 hash theo <code>ADR-024</code> Retention &amp; Deletion Cho ph\u00e9p x\u00f3a m\u1ec1m ho\u1eb7c x\u00f3a v\u0129nh vi\u1ec5n sau th\u1eddi gian theo policy"},{"location":"services/notification-service/sub/data-model/#khong-nam-trong-pham-vi","title":"\u26d4 Kh\u00f4ng n\u1eb1m trong ph\u1ea1m vi","text":"<ul> <li>Kh\u00f4ng l\u01b0u tr\u1ea1ng th\u00e1i \u0111\u1ecdc / unread</li> <li>Kh\u00f4ng l\u01b0u tr\u1ea1ng th\u00e1i g\u1eedi real-time c\u1ee7a client (client-side delivery)</li> <li>Kh\u00f4ng l\u01b0u full render HTML tr\u1eeb khi c\u1ea7n audit (tu\u1ef3 c\u1ea5u h\u00ecnh)</li> <li>Kh\u00f4ng qu\u1ea3n l\u00fd lu\u1ed3ng trigger g\u1eedi (thu\u1ed9c v\u1ec1 Notification Master)</li> </ul>"},{"location":"services/notification-service/sub/data-model/#2-mo-hinh-du-lieu-tong-the","title":"2. \ud83d\udd22 M\u00f4 h\u00ecnh d\u1eef li\u1ec7u t\u1ed5ng th\u1ec3","text":"<p>H\u1ec7 th\u1ed1ng Notification Sub qu\u1ea3n l\u00fd ba th\u1ef1c th\u1ec3 ch\u00ednh:</p> <ol> <li>NotificationTemplate \u2013 Metadata template g\u1eafn v\u1edbi <code>event_code</code>, <code>channel</code>, v\u00e0 <code>tenant</code></li> <li>NotificationLog \u2013 L\u01b0u l\u1ea1i t\u1eebng l\u1ea7n g\u1eedi th\u1ef1c t\u1ebf, bao g\u1ed3m trace, l\u1ed7i, ng\u01b0\u1eddi nh\u1eadn</li> <li>NotificationChannelCfg \u2013 C\u1ea5u h\u00ecnh k\u00eanh g\u1eedi cho m\u1ed7i <code>tenant</code> v\u00e0 <code>channel</code></li> </ol> <p>M\u00f4 h\u00ecnh tu\u00e2n th\u1ee7 ch\u1eb7t ch\u1ebd ki\u1ebfn tr\u00fac multi-tenant, h\u1ed7 tr\u1ee3 versioning, tracing v\u00e0 kh\u1ea3 n\u0103ng ki\u1ec3m to\u00e1n \u0111\u1ea7y \u0111\u1ee7.</p>"},{"location":"services/notification-service/sub/data-model/#moi-quan-he-giua-cac-thuc-the","title":"\ud83e\udded M\u1ed1i quan h\u1ec7 gi\u1eefa c\u00e1c th\u1ef1c th\u1ec3","text":"<p>```mermaid erDiagram   NotificationTemplate ||--o{ NotificationLog : used_by   NotificationChannelCfg ||--o{ NotificationTemplate : configures</p> <p>NotificationTemplate {     UUID id PK     STRING event_code     STRING channel     TEXT template_body     JSONB default_params     BOOLEAN is_active     INTEGER version     STRING tenant_id     TIMESTAMPTZ updated_at   }</p> <p>NotificationLog {     UUID id PK     UUID template_id FK     STRING recipient     STRING status     TEXT error_message     JSONB payload     STRING tenant_id     TIMESTAMPTZ sent_at     STRING event_code     STRING channel     BOOLEAN retry     STRING trace_id   }</p> <p>NotificationChannelCfg {     STRING channel PK     STRING provider     JSONB config     BOOLEAN is_enabled     STRING tenant_id     TIMESTAMPTZ updated_at   } ````</p>"},{"location":"services/notification-service/sub/data-model/#giai-thich-tong-quan-cac-bang","title":"\ud83d\udccc Gi\u1ea3i th\u00edch t\u1ed5ng quan c\u00e1c b\u1ea3ng","text":"B\u1ea3ng Vai tr\u00f2 ch\u00ednh <code>NotificationTemplate</code> Template chu\u1ea9n ho\u00e1 mapping t\u1eeb <code>event_code</code> + <code>channel</code> \u2192 body g\u1eedi <code>NotificationLog</code> Log t\u1eebng l\u1ea7n g\u1eedi: tr\u1ea1ng th\u00e1i, l\u1ed7i, trace_id, th\u00f4ng tin ng\u01b0\u1eddi nh\u1eadn <code>NotificationChannelCfg</code> L\u01b0u th\u00f4ng tin SMTP, SMS API, push key c\u1ee7a t\u1eebng tenant + tr\u1ea1ng th\u00e1i k\u00eanh"},{"location":"services/notification-service/sub/data-model/#thiet-ke-ho-tro","title":"\ud83e\udde9 Thi\u1ebft k\u1ebf h\u1ed7 tr\u1ee3:","text":"T\u00ednh n\u0103ng C\u00e1ch th\u1ef1c hi\u1ec7n Multi-tenant isolation Tr\u01b0\u1eddng <code>tenant_id</code> l\u00e0 b\u1eaft bu\u1ed9c trong t\u1ea5t c\u1ea3 c\u00e1c b\u1ea3ng Traceability (X-Trace-ID) Log g\u1eafn <code>trace_id</code>, audit event c\u00f3 th\u1ec3 li\u00ean k\u1ebft \u0111\u01b0\u1ee3c Versioning Template Template c\u00f3 tr\u01b0\u1eddng <code>version</code>; log l\u01b0u <code>template_id</code> \u0111\u1ec3 t\u00e1i hi\u1ec7n Soft-delete ho\u1eb7c TTL Log c\u00f3 th\u1ec3 x\u00f3a m\u1ec1m theo config ho\u1eb7c d\u1ecdn d\u1eb9p theo <code>retention_days</code> Anonymization (opt-in) C\u00e1c tr\u01b0\u1eddng <code>recipient</code>, <code>payload</code> c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c m\u00e3 h\u00f3a/anonymize"},{"location":"services/notification-service/sub/data-model/#3-chi-tiet-cac-bang","title":"3. \ud83d\udcda Chi ti\u1ebft c\u00e1c b\u1ea3ng","text":""},{"location":"services/notification-service/sub/data-model/#31-notificationtemplate","title":"3.1. <code>NotificationTemplate</code>","text":"<p>L\u01b0u tr\u1eef metadata v\u00e0 n\u1ed9i dung template cho t\u1eebng <code>event_code</code> v\u00e0 <code>channel</code>. H\u1ed7 tr\u1ee3 versioning, ng\u00f4n ng\u1eef, tr\u1ea1ng th\u00e1i b\u1eadt/t\u1eaft v\u00e0 ki\u1ec3m tra render (qua <code>POST /notifications/test</code>).</p> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>id</code> UUID \u2705 M\u00e3 \u0111\u1ecbnh danh template (PK) <code>tenant_id</code> STRING \u2705 Tenant s\u1edf h\u1eefu template <code>event_code</code> STRING \u2705 M\u00e3 s\u1ef1 ki\u1ec7n nghi\u1ec7p v\u1ee5, v\u00ed d\u1ee5 <code>user.welcome</code> <code>channel</code> STRING \u2705 <code>email</code>, <code>sms</code>, <code>push</code>,... <code>language</code> STRING \u26d4 ISO code: <code>vi</code>, <code>en</code>,... <code>version</code> INTEGER \u2705 Version template <code>template_body</code> TEXT \u2705 N\u1ed9i dung ch\u1ee9a bi\u1ebfn (Jinja2 format) <code>default_params</code> JSONB \u26d4 Gi\u00e1 tr\u1ecb m\u1eb7c \u0111\u1ecbnh n\u1ebfu <code>params</code> kh\u00f4ng cung c\u1ea5p <code>is_active</code> BOOLEAN \u2705 Template c\u00f2n hi\u1ec7u l\u1ef1c hay kh\u00f4ng <code>updated_at</code> TIMESTAMPTZ \u2705 Th\u1eddi \u0111i\u1ec3m c\u1eadp nh\u1eadt g\u1ea7n nh\u1ea5t <p>\ud83d\udd0e R\u00e0ng bu\u1ed9c quan tr\u1ecdng: - Unique constraint: <code>(tenant_id, event_code, channel, language, version)</code> - C\u00f3 index tr\u00ean <code>tenant_id</code>, <code>event_code</code>, <code>channel</code>, <code>is_active</code></p>"},{"location":"services/notification-service/sub/data-model/#32-notificationlog","title":"3.2. <code>NotificationLog</code>","text":"<p>L\u01b0u l\u1ea1i t\u1eebng l\u1ea7n g\u1eedi notification (g\u1eedi th\u1eadt ho\u1eb7c test). Ph\u1ee5c v\u1ee5 audit, ki\u1ec3m tra l\u1ed7i, th\u1ed1ng k\u00ea.</p> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>id</code> UUID \u2705 M\u00e3 log g\u1eedi notification (PK) <code>tenant_id</code> STRING \u2705 Tenant th\u1ef1c hi\u1ec7n g\u1eedi <code>template_id</code> UUID \u26d4 Template s\u1eed d\u1ee5ng \u0111\u1ec3 g\u1eedi (nullable n\u1ebfu g\u1eedi kh\u00f4ng qua template) <code>event_code</code> STRING \u2705 Ghi l\u1ea1i event_code \u1ee9ng v\u1edbi log n\u00e0y <code>channel</code> STRING \u2705 <code>email</code>, <code>sms</code>, <code>push</code>,... <code>recipient</code> STRING \u2705 Email/s\u1ed1 \u0111i\u1ec7n tho\u1ea1i ng\u01b0\u1eddi nh\u1eadn (c\u00f3 th\u1ec3 hash n\u1ebfu config) <code>status</code> STRING \u2705 <code>sent</code>, <code>failed</code>, <code>queued</code>, <code>fallback</code> <code>error_message</code> TEXT \u26d4 Th\u00f4ng b\u00e1o l\u1ed7i (n\u1ebfu th\u1ea5t b\u1ea1i) <code>payload</code> JSONB \u2705 N\u1ed9i dung notification \u0111\u00e3 render (ho\u1eb7c th\u00f4ng tin \u0111\u1ea7u v\u00e0o) <code>retry</code> BOOLEAN \u2705 G\u1eedi l\u1ea1i t\u1eeb l\u1ea7n tr\u01b0\u1edbc (retry ho\u1eb7c fallback) <code>trace_id</code> STRING \u2705 Trace \u0111\u1ec3 li\u00ean k\u1ebft v\u1edbi lu\u1ed3ng Master <code>sent_at</code> TIMESTAMPTZ \u2705 Th\u1eddi gian g\u1eedi th\u1ef1c t\u1ebf (ho\u1eb7c gi\u1ea3 l\u1eadp n\u1ebfu test) <p>\ud83d\udd0e L\u01b0u \u00fd: - C\u00f3 index tr\u00ean <code>tenant_id</code>, <code>event_code</code>, <code>status</code>, <code>sent_at</code>, <code>recipient</code> - C\u00f3 th\u1ec3 x\u00f3a m\u1ec1m ho\u1eb7c TTL 30 ng\u00e0y theo <code>ADR-024</code></p>"},{"location":"services/notification-service/sub/data-model/#33-notificationchannelcfg","title":"3.3. <code>NotificationChannelCfg</code>","text":"<p>L\u01b0u c\u1ea5u h\u00ecnh k\u00eanh g\u1eedi (SMTP, SMS provider...) ri\u00eang cho t\u1eebng tenant. H\u1ed7 tr\u1ee3 b\u1eadt/t\u1eaft \u0111\u1ed9ng, fallback ho\u1eb7c dry-run.</p> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>channel</code> STRING \u2705 K\u00eanh g\u1eedi (<code>email</code>, <code>sms</code>, <code>push</code>) <code>tenant_id</code> STRING \u2705 Tenant s\u1edf h\u1eefu c\u1ea5u h\u00ecnh n\u00e0y <code>provider</code> STRING \u2705 T\u00ean provider (<code>smtp</code>, <code>twilio</code>,...) <code>config</code> JSONB \u2705 Config t\u00f9y thu\u1ed9c provider (host, port, api_key...) <code>is_enabled</code> BOOLEAN \u2705 Cho ph\u00e9p b\u1eadt/t\u1eaft k\u00eanh g\u1eedi <code>updated_at</code> TIMESTAMPTZ \u2705 L\u1ea7n c\u1eadp nh\u1eadt cu\u1ed1i c\u00f9ng <p>\ud83d\udd0e Best Practice: - Config \u0111\u01b0\u1ee3c load t\u1eeb cache, invalidate khi c\u00f3 c\u1eadp nh\u1eadt - C\u00f3 th\u1ec3 c\u00f3 th\u00eam tr\u01b0\u1eddng <code>test_email</code>, <code>test_number</code> d\u00f9ng cho <code>POST /notifications/test</code></p> <p>\ud83d\udccc G\u1ee3i \u00fd m\u1edf r\u1ed9ng t\u01b0\u01a1ng lai (optional):</p> Tr\u01b0\u1eddng g\u1ee3i \u00fd th\u00eam \u00c1p d\u1ee5ng cho G\u1ee3i \u00fd <code>archived_at</code> All tables H\u1ed7 tr\u1ee3 soft-delete c\u00f3 TTL t\u1ef1 \u0111\u1ed9ng <code>created_by</code> Template Ghi l\u1ea1i ai t\u1ea1o template <code>rendered_preview</code> Log L\u01b0u b\u1ea3n HTML \u0111\u00e3 render (n\u1ebfu b\u1eadt audit n\u00e2ng cao)"},{"location":"services/notification-service/sub/data-model/#4-chinh-sach-bao-mat-a-tenant","title":"4. \ud83d\udd10 Ch\u00ednh s\u00e1ch b\u1ea3o m\u1eadt &amp; \u0111a tenant","text":"<p>Thi\u1ebft k\u1ebf d\u1eef li\u1ec7u c\u1ee7a Notification Sub Service \u0111\u1eb7t tr\u1ecdng t\u00e2m v\u00e0o t\u00e1ch bi\u1ec7t d\u1eef li\u1ec7u tenant, b\u1ea3o m\u1eadt th\u00f4ng tin c\u00e1 nh\u00e2n, v\u00e0 tu\u00e2n th\u1ee7 ch\u00ednh s\u00e1ch ki\u1ec3m to\u00e1n &amp; l\u01b0u tr\u1eef. C\u00e1c nguy\u00ean t\u1eafc sau \u0111\u01b0\u1ee3c \u00e1p d\u1ee5ng \u1edf m\u1ecdi t\u1ea7ng: schema, query, API, log v\u00e0 pipeline event.</p>"},{"location":"services/notification-service/sub/data-model/#41-tach-biet-theo-tenant-tenant-isolation","title":"4.1. \ud83e\uddf1 T\u00e1ch bi\u1ec7t theo tenant (Tenant Isolation)","text":"Bi\u1ec7n ph\u00e1p Gi\u1ea3i th\u00edch <code>tenant_id</code> b\u1eaft bu\u1ed9c M\u1ecdi b\u1ea3ng d\u1eef li\u1ec7u \u0111\u1ec1u b\u1eaft bu\u1ed9c c\u00f3 <code>tenant_id</code>, kh\u00f4ng c\u00f3 gi\u00e1 tr\u1ecb <code>NULL</code> R\u00e0ng bu\u1ed9c truy v\u1ea5n (<code>x-condition</code>) T\u1ea5t c\u1ea3 API &amp; query \u0111\u1ec1u s\u1eed d\u1ee5ng <code>WHERE tenant_id = {{X-Tenant-ID}}</code> Index h\u00f3a theo <code>tenant_id</code> T\u1ed1i \u01b0u h\u00f3a hi\u1ec7u n\u0103ng cho m\u00f4 h\u00ecnh multi-tenant t\u00e1ch bi\u1ec7t Kh\u00f4ng chia s\u1ebb c\u1ea5u h\u00ecnh M\u1ed7i tenant c\u00f3 <code>NotificationChannelCfg</code> \u0111\u1ed9c l\u1eadp, kh\u00f4ng k\u1ebf th\u1eeba m\u1eb7c \u0111\u1ecbnh <p>\ud83d\udd10 Tu\u00e2n th\u1ee7 <code>ADR-025 \u2013 Multi-Tenant Versioning</code>, <code>ADR-007 \u2013 RBAC</code>, <code>CR-04 \u2013 Ph\u00e2n v\u00f9ng tenant v\u1eadt l\u00fd/logic</code></p>"},{"location":"services/notification-service/sub/data-model/#42-bao-ve-du-lieu-ca-nhan","title":"4.2. \ud83d\udee1\ufe0f B\u1ea3o v\u1ec7 d\u1eef li\u1ec7u c\u00e1 nh\u00e2n","text":"Tr\u01b0\u1eddng nh\u1ea1y c\u1ea3m Bi\u1ec7n ph\u00e1p b\u1ea3o v\u1ec7 T\u00f9y ch\u1ec9nh <code>recipient</code> C\u00f3 th\u1ec3 b\u0103m SHA256 + salt ri\u00eang theo tenant C\u00f3 c\u1ea5u h\u00ecnh b\u1eadt/t\u1eaft <code>payload</code> C\u00f3 th\u1ec3 \u1ea9n m\u1ed9t s\u1ed1 key nh\u1ea1y c\u1ea3m C\u1ea5u h\u00ecnh whitelist field <code>error_message</code> Ch\u1ec9 hi\u1ec3n th\u1ecb n\u1ed9i b\u1ed9, kh\u00f4ng l\u1ed9 cho ng\u01b0\u1eddi d\u00f9ng M\u1eb7c \u0111\u1ecbnh kh\u00f4ng expose qua UI <code>config</code> trong channel Kh\u00f4ng tr\u1ea3 qua API Ch\u1ec9 d\u00f9ng n\u1ed9i b\u1ed9 khi g\u1eedi <p>Tu\u00e2n th\u1ee7 <code>ADR-024 \u2013 Data Anonymization &amp; Retention</code></p>"},{"location":"services/notification-service/sub/data-model/#43-chinh-sach-giu-du-lieu-retention","title":"4.3. \ud83d\udd53 Ch\u00ednh s\u00e1ch gi\u1eef d\u1eef li\u1ec7u (Retention)","text":"Lo\u1ea1i d\u1eef li\u1ec7u Ch\u00ednh s\u00e1ch g\u1ee3i \u00fd <code>NotificationLog</code> Xo\u00e1 v\u0129nh vi\u1ec5n sau 30 ng\u00e0y (<code>hard delete</code>) <code>Template</code> Kh\u00f4ng xo\u00e1 \u2013 ch\u1ec9 \u0111\u00e1nh d\u1ea5u <code>is_active=false</code> <code>ChannelCfg</code> Ghi \u0111\u00e8 theo tenant, gi\u1eef phi\u00ean b\u1ea3n cu\u1ed1i c\u00f9ng Audit event Do <code>audit-logging-service</code> l\u01b0u, TTL = 90 ng\u00e0y <p>N\u1ebfu c\u1ea7n soft-delete (d\u00f9ng <code>archived_at</code>), n\u00ean th\u00eam theo <code>ADR-026 \u2013 Hard Delete Policy</code></p>"},{"location":"services/notification-service/sub/data-model/#44-giam-sat-kiem-toan","title":"4.4. \ud83d\udd0d Gi\u00e1m s\u00e1t &amp; ki\u1ec3m to\u00e1n","text":"M\u1ee5c ti\u00eau Bi\u1ec7n ph\u00e1p tri\u1ec3n khai Truy v\u1ebft h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng Log <code>POST /notifications/test</code>, <code>GET /logs</code> v\u00e0o audit Trace to\u00e0n h\u1ec7 th\u1ed1ng G\u1eafn <code>trace_id</code> t\u1eeb Master xuy\u00ean su\u1ed1t qua log g\u1eedi Gi\u00e1m s\u00e1t channel usage M\u1ed7i g\u1eedi log s\u1ebd emit counter theo channel + status"},{"location":"services/notification-service/sub/data-model/#45-checklist-tuan-thu-bao-mat-a-tenant","title":"4.5. \u2705 Checklist tu\u00e2n th\u1ee7 b\u1ea3o m\u1eadt &amp; \u0111a tenant","text":"Ti\u00eau ch\u00ed Tr\u1ea1ng th\u00e1i M\u1ecdi b\u1ea3ng c\u00f3 <code>tenant_id</code>, c\u00f3 index ph\u00f9 h\u1ee3p \u2705 Kh\u00f4ng c\u00f3 API n\u00e0o tr\u1ea3 <code>config</code> ho\u1eb7c <code>template_body</code> sai tenant \u2705 Log kh\u00f4ng l\u1ed9 th\u00f4ng tin c\u00e1 nh\u00e2n n\u1ebfu c\u1ea5u h\u00ecnh \u1ea9n danh b\u1eadt \u2705 D\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m c\u00f3 th\u1ec3 x\u00f3a sau 30 ng\u00e0y \u2705 RBAC t\u00e1ch bi\u1ec7t r\u00f5 t\u1eebng permission cho t\u1eebng API \u2705 S\u1ef1 ki\u1ec7n g\u1eedi th\u1eed \u0111\u01b0\u1ee3c log l\u1ea1i ph\u1ee5c v\u1ee5 audit \u2705"},{"location":"services/notification-service/sub/data-model/#5-mapping-sang-cac-api","title":"5. \ud83e\udde9 Mapping sang c\u00e1c API","text":"<p>B\u1ea3ng d\u01b0\u1edbi \u0111\u00e2y tr\u00ecnh b\u00e0y m\u1ed1i quan h\u1ec7 gi\u1eefa t\u1eebng API v\u00e0 c\u00e1c b\u1ea3ng d\u1eef li\u1ec7u li\u00ean quan. M\u1ee5c ti\u00eau l\u00e0 \u0111\u1ea3m b\u1ea3o t\u00ednh nh\u1ea5t qu\u00e1n gi\u1eefa lu\u1ed3ng nghi\u1ec7p v\u1ee5, d\u1eef li\u1ec7u l\u01b0u tr\u1eef, v\u00e0 h\u1ee3p \u0111\u1ed3ng giao ti\u1ebfp (interface contract).</p> API Endpoint Method Th\u1ef1c th\u1ec3 li\u00ean quan Field truy c\u1eadp/ch\u1ec9nh s\u1eeda ch\u00ednh <code>/notifications/logs</code> <code>GET</code> <code>NotificationLog</code> <code>status</code>, <code>recipient</code>, <code>event_code</code>, <code>channel</code>, <code>sent_at</code> <code>/notifications/test</code> <code>POST</code> <code>NotificationTemplate</code>, <code>NotificationChannelCfg</code> <code>template_body</code>, <code>channel</code>, <code>event_code</code>, <code>params</code>, <code>config</code>, <code>recipient</code> \u2192 log test c\u0169ng ghi v\u00e0o <code>NotificationLog</code> (lo\u1ea1i: test) <code>status=test</code>, <code>retry=false</code>, <code>trace_id</code>, <code>payload</code> <code>/notifications/templates</code> <code>GET</code> <code>NotificationTemplate</code> <code>event_code</code>, <code>channel</code>, <code>language</code>, <code>version</code>, <code>is_active</code>, <code>updated_at</code>"},{"location":"services/notification-service/sub/data-model/#51-chi-tiet-truy-xuat-ghi-du-lieu-theo-api","title":"5.1. \ud83d\udccc Chi ti\u1ebft truy xu\u1ea5t &amp; ghi d\u1eef li\u1ec7u theo API","text":""},{"location":"services/notification-service/sub/data-model/#get-notificationslogs","title":"\ud83d\udd0d <code>GET /notifications/logs</code>","text":"<ul> <li>Read-only</li> <li>Truy v\u1ea5n tr\u00ean b\u1ea3ng <code>NotificationLog</code></li> <li>D\u1ef1a tr\u00ean <code>tenant_id</code>, c\u00f3 th\u1ec3 filter theo <code>status</code>, <code>channel</code>, <code>event_code</code>, <code>recipient</code></li> </ul>"},{"location":"services/notification-service/sub/data-model/#post-notificationstest","title":"\ud83e\uddea <code>POST /notifications/test</code>","text":"<ul> <li>Truy xu\u1ea5t <code>NotificationTemplate</code> \u0111\u1ec3 render</li> <li>Truy xu\u1ea5t <code>NotificationChannelCfg</code> \u0111\u1ec3 ki\u1ec3m tra config k\u00eanh g\u1eedi</li> <li>Ghi log g\u1eedi th\u1eed v\u00e0o <code>NotificationLog</code> (d\u1ea1ng test, kh\u00f4ng \u1ea3nh h\u01b0\u1edfng th\u1ed1ng k\u00ea ch\u00ednh)</li> <li>G\u1eafn <code>trace_id</code>, status: <code>sent</code>, <code>failed</code>, <code>test_only: true</code></li> </ul>"},{"location":"services/notification-service/sub/data-model/#get-notificationstemplates","title":"\ud83d\udcd1 <code>GET /notifications/templates</code>","text":"<ul> <li>Truy xu\u1ea5t t\u1eeb <code>NotificationTemplate</code> v\u1edbi <code>tenant_id</code> t\u01b0\u01a1ng \u1ee9ng</li> <li>Kh\u00f4ng tr\u1ea3 <code>template_body</code>, ch\u1ec9 metadata \u0111\u1ec3 UI l\u1ef1a ch\u1ecdn</li> </ul>"},{"location":"services/notification-service/sub/data-model/#52-rbac-mapping","title":"5.2. \ud83d\udd10 RBAC Mapping","text":"API Permission Code Th\u1ef1c th\u1ec3 b\u1ea3o v\u1ec7 <code>GET /notifications/logs</code> <code>notif.read.log</code> <code>NotificationLog</code> <code>POST /notifications/test</code> <code>notif.send.test</code> <code>NotificationTemplate</code>, <code>ChannelCfg</code> <code>GET /notifications/templates</code> <code>notif.read.template</code> <code>NotificationTemplate</code>"},{"location":"services/notification-service/sub/data-model/#6-schema-versioning-kiem-thu-schema","title":"6. \ud83d\udccc Schema versioning &amp; ki\u1ec3m th\u1eed schema","text":""},{"location":"services/notification-service/sub/data-model/#61-muc-tieu","title":"6.1. \ud83c\udfaf M\u1ee5c ti\u00eau","text":"<p>Vi\u1ec7c version h\u00f3a schema gi\u00fap \u0111\u1ea3m b\u1ea3o: - T\u01b0\u01a1ng th\u00edch ng\u01b0\u1ee3c khi template thay \u0111\u1ed5i c\u1ea5u tr\u00fac - H\u1ed7 tr\u1ee3 A/B testing ho\u1eb7c rollback khi c\u1ea5u h\u00ecnh g\u1eedi thay \u0111\u1ed5i - Cho ph\u00e9p ki\u1ec3m tra t\u00ednh \u0111\u00fang \u0111\u1eafn c\u1ee7a schema tr\u01b0\u1edbc khi g\u1eedi th\u1ef1c t\u1ebf</p>"},{"location":"services/notification-service/sub/data-model/#62-vi-tri-version-trong-he-thong","title":"6.2. \ud83d\udcda V\u1ecb tr\u00ed version trong h\u1ec7 th\u1ed1ng","text":"Th\u00e0nh ph\u1ea7n C\u00e1ch version h\u00f3a <code>NotificationTemplate</code> Tr\u01b0\u1eddng <code>version</code> (s\u1ed1 nguy\u00ean t\u0103ng d\u1ea7n) <code>NotificationLog</code> Tr\u01b0\u1eddng <code>template_id</code> v\u00e0 <code>event_code</code> l\u01b0u theo th\u1eddi \u0111i\u1ec3m g\u1eedi API g\u1eedi th\u1eed (<code>/test</code>) S\u1eed d\u1ee5ng <code>event_code</code>, h\u1ec7 th\u1ed1ng l\u1ea5y template <code>is_active=true</code>, <code>version=max</code> Event payload Schema validation th\u1ef1c hi\u1ec7n theo template t\u01b0\u01a1ng \u1ee9ng <p>H\u1ec7 th\u1ed1ng KH\u00d4NG nh\u00fang version v\u00e0o <code>event_code</code> \u2013 theo khuy\u1ebfn ngh\u1ecb c\u1ee7a <code>ADR-030</code>.</p>"},{"location":"services/notification-service/sub/data-model/#63-co-che-kiem-thu-schema","title":"6.3. \ud83e\uddea C\u01a1 ch\u1ebf ki\u1ec3m th\u1eed schema","text":"<p>G\u1eedi th\u1eed (<code>POST /notifications/test</code>) \u0111\u00f3ng vai tr\u00f2 l\u00e0 c\u01a1 ch\u1ebf ki\u1ec3m th\u1eed schema \u0111\u1ed9ng.</p> B\u01b0\u1edbc Di\u1ec5n gi\u1ea3i 1\ufe0f\u20e3 Ng\u01b0\u1eddi d\u00f9ng ch\u1ecdn <code>event_code</code>, <code>channel</code>, nh\u1eadp <code>recipient</code> v\u00e0 <code>params</code> 2\ufe0f\u20e3 H\u1ec7 th\u1ed1ng l\u1ea5y template \u0111ang <code>active</code> c\u00f3 <code>version = max</code> c\u1ee7a tenant 3\ufe0f\u20e3 Th\u1ef1c hi\u1ec7n render (Jinja2), n\u1ebfu l\u1ed7i s\u1ebd tr\u1ea3 v\u1ec1 <code>notif.render_failed</code> 4\ufe0f\u20e3 N\u1ebfu render th\u00e0nh c\u00f4ng, th\u1ef1c hi\u1ec7n g\u1eedi th\u1eed (t\u00f9y k\u00eanh) 5\ufe0f\u20e3 Tr\u1ea3 v\u1ec1 preview HTML + tr\u1ea1ng th\u00e1i g\u1eedi <p>\u2757 C\u00e1c l\u1ed7i render, thi\u1ebfu bi\u1ebfn, sai ki\u1ec3u s\u1ebd \u0111\u01b0\u1ee3c ph\u00e1t hi\u1ec7n t\u1ea1i b\u01b0\u1edbc 3 \u2013 kh\u00f4ng \u0111\u01b0\u1ee3c ph\u00e9p \u0111\u1ebfn b\u01b0\u1edbc g\u1eedi.</p>"},{"location":"services/notification-service/sub/data-model/#64-co-che-quan-ly-template-theo-version","title":"6.4. \ud83e\udde9 C\u01a1 ch\u1ebf qu\u1ea3n l\u00fd template theo version","text":"Tr\u01b0\u1eddng M\u00f4 t\u1ea3 <code>version</code> \u0110\u01b0\u1ee3c h\u1ec7 th\u1ed1ng auto t\u0103ng khi th\u00eam template m\u1edbi <code>is_active</code> Ch\u1ec9 m\u1ed9t b\u1ea3n active t\u1ea1i 1 th\u1eddi \u0111i\u1ec3m v\u1edbi <code>event_code + channel + language</code> <code>template_id</code> G\u1eafn v\u00e0o m\u1ed7i <code>NotificationLog</code> \u0111\u1ec3 x\u00e1c \u0111\u1ecbnh n\u1ed9i dung \u0111\u00e3 d\u00f9ng khi g\u1eedi <code>updated_at</code> Ph\u1ee5c v\u1ee5 ki\u1ec3m tra l\u1ecbch s\u1eed v\u00e0 ki\u1ec3m to\u00e1n"},{"location":"services/notification-service/sub/data-model/#65-kiem-thu-schema-nen-bao-gom","title":"6.5. \u2705 Ki\u1ec3m th\u1eed schema n\u00ean bao g\u1ed3m:","text":"Lo\u1ea1i ki\u1ec3m th\u1eed M\u1ee5c ti\u00eau G\u1eedi test thi\u1ebfu bi\u1ebfn (<code>params</code>) Ph\u00e1t hi\u1ec7n l\u1ed7i render \u0111\u1ed9ng G\u1eedi test v\u1edbi bi\u1ebfn sai ki\u1ec3u B\u1eaft l\u1ed7i schema kh\u00f4ng kh\u1edbp G\u1eedi test khi c\u00f3 version m\u1edbi \u0110\u1ea3m b\u1ea3o l\u1ea5y \u0111\u00fang version m\u1edbi nh\u1ea5t So s\u00e1nh version gi\u1eefa c\u00e1c tenant \u0110\u1ea3m b\u1ea3o isolation, kh\u00f4ng xung \u0111\u1ed9t"},{"location":"services/notification-service/sub/data-model/#7-goi-y-kiem-thu-du-lieu","title":"7. \ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed d\u1eef li\u1ec7u","text":"<p>C\u00e1c tr\u01b0\u1eddng h\u1ee3p ki\u1ec3m th\u1eed d\u01b0\u1edbi \u0111\u00e2y nh\u1eb1m \u0111\u1ea3m b\u1ea3o h\u1ec7 th\u1ed1ng l\u01b0u tr\u1eef d\u1eef li\u1ec7u \u0111\u00fang, ph\u1ea3n \u00e1nh ch\u00ednh x\u00e1c lu\u1ed3ng nghi\u1ec7p v\u1ee5, \u0111\u1ed3ng th\u1eddi h\u1ed7 tr\u1ee3 audit v\u00e0 ph\u00e2n t\u00edch s\u1ef1 c\u1ed1 d\u1ec5 d\u00e0ng.</p>"},{"location":"services/notification-service/sub/data-model/#71-kiem-thu-tao-truy-van-log-gui","title":"7.1. \ud83d\udd04 Ki\u1ec3m th\u1eed t\u1ea1o &amp; truy v\u1ea5n log g\u1eedi","text":"T\u00ecnh hu\u1ed1ng M\u1ee5c ti\u00eau ki\u1ec3m th\u1eed K\u1ebft qu\u1ea3 mong \u0111\u1ee3i G\u1eedi th\u1eed m\u1ed9t template th\u00e0nh c\u00f4ng Log ghi nh\u1eadn \u0111\u1ea7y \u0111\u1ee7 th\u00f4ng tin (trace, status, payload) Tr\u1ea1ng th\u00e1i <code>sent</code>, c\u00f3 trace_id G\u1eedi th\u1eed template thi\u1ebfu bi\u1ebfn Ki\u1ec3m tra l\u1ed7i render template Tr\u1ea1ng th\u00e1i <code>failed</code>, <code>error_message</code> r\u00f5 r\u00e0ng G\u1eedi test v\u1edbi <code>recipient</code> \u1ea9n danh Ki\u1ec3m tra c\u01a1 ch\u1ebf hash <code>recipient</code> Recipient b\u1ecb m\u00e3 h\u00f3a theo c\u1ea5u h\u00ecnh Truy v\u1ea5n log v\u1edbi <code>status=sent</code> L\u1ecdc log ch\u00ednh x\u00e1c theo tr\u1ea1ng th\u00e1i K\u1ebft qu\u1ea3 \u0111\u00fang, kh\u00f4ng ch\u1ee9a log <code>failed</code> Truy v\u1ea5n log theo <code>event_code</code> c\u1ee5 th\u1ec3 Ki\u1ec3m tra ch\u1ec9 l\u1ea5y log \u0111\u00fang lo\u1ea1i s\u1ef1 ki\u1ec7n <code>event_code</code> kh\u1edbp to\u00e0n b\u1ed9 trong response Truy v\u1ea5n log sai tenant \u0110\u1ea3m b\u1ea3o isolation d\u1eef li\u1ec7u gi\u1eefa tenants K\u1ebft qu\u1ea3 r\u1ed7ng, kh\u00f4ng c\u00f3 d\u1eef li\u1ec7u l\u1ed9"},{"location":"services/notification-service/sub/data-model/#72-kiem-thu-template","title":"7.2. \ud83d\udcc4 Ki\u1ec3m th\u1eed template","text":"T\u00ecnh hu\u1ed1ng M\u1ee5c ti\u00eau ki\u1ec3m th\u1eed K\u1ebft qu\u1ea3 mong \u0111\u1ee3i G\u1eedi test v\u1edbi <code>event_code</code> kh\u00f4ng t\u1ed3n t\u1ea1i X\u1eed l\u00fd tr\u01b0\u1eddng h\u1ee3p template kh\u00f4ng h\u1ee3p l\u1ec7 400 + <code>notif.template_not_found</code> G\u1eedi test v\u1edbi template <code>is_active=false</code> Kh\u00f4ng cho ph\u00e9p g\u1eedi test template \u0111\u00e3 t\u1eaft 400 + <code>notif.template_inactive</code> Truy v\u1ea5n danh s\u00e1ch template \u0110\u1ea3m b\u1ea3o tr\u1ea3 metadata \u0111\u00fang C\u00f3 <code>event_code</code>, <code>channel</code>, <code>version</code> C\u00f3 nhi\u1ec1u version c\u00f9ng <code>event_code</code> H\u1ec7 th\u1ed1ng ch\u1ecdn \u0111\u00fang <code>version=max</code> khi g\u1eedi test G\u1eedi \u0111\u00fang template m\u1edbi nh\u1ea5t"},{"location":"services/notification-service/sub/data-model/#73-kiem-thu-lien-quan-bao-mat-phan-vung-tenant","title":"7.3. \ud83d\udd10 Ki\u1ec3m th\u1eed li\u00ean quan b\u1ea3o m\u1eadt &amp; ph\u00e2n v\u00f9ng tenant","text":"T\u00ecnh hu\u1ed1ng M\u1ee5c ti\u00eau ki\u1ec3m th\u1eed K\u1ebft qu\u1ea3 mong \u0111\u1ee3i Truy v\u1ea5n log t\u1eeb tenant kh\u00e1c B\u1ea3o v\u1ec7 ph\u00e2n v\u00f9ng d\u1eef li\u1ec7u gi\u1eefa tenants 403 ho\u1eb7c 200 + <code>data=[]</code> C\u00f9ng <code>event_code</code>, kh\u00e1c tenant Template \u0111\u1ed9c l\u1eadp, kh\u00f4ng b\u1ecb l\u1eabn nhau K\u1ebft qu\u1ea3 \u0111\u00fang theo t\u1eebng tenant G\u1eedi th\u1eed v\u1edbi c\u1ea5u h\u00ecnh channel b\u1ecb t\u1eaft Kh\u00f4ng g\u1eedi, b\u00e1o l\u1ed7i c\u1ea5u h\u00ecnh 400 + <code>notif.channel_disabled</code> Th\u1eed c\u1ea5u h\u00ecnh k\u00eanh kh\u00f4ng h\u1ee3p l\u1ec7 Ph\u00e1t hi\u1ec7n config sai (v\u00ed d\u1ee5 thi\u1ebfu SMTP host) 500 + <code>notif.channel_config_invalid</code>"},{"location":"services/notification-service/sub/data-model/#74-kiem-thu-toan-ven-du-lieu","title":"7.4. \ud83e\udde9 Ki\u1ec3m th\u1eed to\u00e0n v\u1eb9n d\u1eef li\u1ec7u","text":"T\u00ecnh hu\u1ed1ng M\u1ee5c ti\u00eau ki\u1ec3m th\u1eed K\u1ebft qu\u1ea3 mong \u0111\u1ee3i Log kh\u00f4ng c\u00f3 <code>template_id</code> (tr\u01b0\u1eddng h\u1ee3p test JSON thu\u1ea7n) \u0110\u1ea3m b\u1ea3o nullable ho\u1ea1t \u0111\u1ed9ng \u0111\u00fang Ghi log v\u1edbi <code>template_id = null</code> Log c\u00f3 <code>trace_id</code> tr\u00f9ng v\u1edbi Master Cho ph\u00e9p li\u00ean k\u1ebft xuy\u00ean trace D\u1eef li\u1ec7u kh\u1edbp trace TTL d\u1ecdn log sau 30 ng\u00e0y D\u1eef li\u1ec7u \u0111\u01b0\u1ee3c x\u00f3a \u0111\u1ecbnh k\u1ef3 theo retention policy Kh\u00f4ng c\u00f2n d\u1eef li\u1ec7u c\u0169"},{"location":"services/notification-service/sub/data-model/#75-checklist-xac-nhan-du-lieu","title":"7.5. \u2705 Checklist x\u00e1c nh\u1eadn d\u1eef li\u1ec7u","text":"Ti\u00eau ch\u00ed Tr\u1ea1ng th\u00e1i <code>tenant_id</code> lu\u00f4n \u0111\u01b0\u1ee3c ki\u1ec3m tra trong m\u1ecdi truy v\u1ea5n \u2705 C\u00e1c b\u1ea3n ghi log c\u00f3 <code>trace_id</code> h\u1ee3p l\u1ec7 \u2705 Template kh\u00f4ng th\u1ec3 b\u1ecb g\u1eedi n\u1ebfu kh\u00f4ng active \u2705 D\u1eef li\u1ec7u test kh\u00f4ng \u0111\u01b0\u1ee3c d\u00f9ng cho th\u1ed1ng k\u00ea th\u1eadt \u2705 C\u00f3 th\u1ec3 ki\u1ec3m tra l\u1ea1i d\u1eef li\u1ec7u t\u1eeb log + trace \u2705"},{"location":"services/notification-service/sub/data-model/#8-tai-lieu-lien-quan","title":"8. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Design.md</li> <li>Interface Contract</li> <li>OpenAPI Spec</li> <li>ADR-030 \u2013 Event Schema Governance</li> <li>ADR-024 \u2013 Data Anonymization &amp; Retention</li> <li>ADR-025 \u2013 Multi-Tenant Versioning</li> <li>ADR-007 \u2013 RBAC</li> </ul>"},{"location":"services/notification-service/sub/design/","title":"\ud83d\udcd8 Thi\u1ebft k\u1ebf chi ti\u1ebft Notification Sub Service","text":""},{"location":"services/notification-service/sub/design/#1-pham-vi-va-trach-nhiem","title":"1. \ud83e\udded Ph\u1ea1m vi v\u00e0 Tr\u00e1ch nhi\u1ec7m","text":""},{"location":"services/notification-service/sub/design/#muc-tieu","title":"\ud83c\udfaf M\u1ee5c ti\u00eau","text":"<ul> <li>L\u1eafng nghe s\u1ef1 ki\u1ec7n <code>notification.triggered</code> t\u1eeb Notification Master \u0111\u1ec3 g\u1eedi th\u00f4ng b\u00e1o th\u1ef1c t\u1ebf \u0111\u1ebfn ng\u01b0\u1eddi d\u00f9ng cu\u1ed1i trong t\u1eebng tenant.</li> <li>Qu\u1ea3n l\u00fd c\u1ea5u h\u00ecnh k\u00eanh g\u1eedi c\u1ee7a tenant (email, SMS, push), mapping template v\u00e0 x\u1eed l\u00fd fallback logic.</li> <li>Ghi nh\u1eadn log g\u1eedi \u0111\u1ec3 ph\u1ee5c v\u1ee5 tra so\u00e1t, th\u1ed1ng k\u00ea, v\u00e0 audit.</li> </ul>"},{"location":"services/notification-service/sub/design/#cac-thuc-the-du-lieu-quan-ly","title":"\ud83d\udce6 C\u00e1c th\u1ef1c th\u1ec3 d\u1eef li\u1ec7u qu\u1ea3n l\u00fd","text":"Th\u1ef1c th\u1ec3 M\u00f4 t\u1ea3 <code>NotificationTemplate</code> Template \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh ri\u00eang cho t\u1eebng tenant, mapping theo trigger_event. <code>NotificationLog</code> L\u01b0u l\u1ea1i l\u1ecbch s\u1eed g\u1eedi th\u00f4ng b\u00e1o, tr\u1ea1ng th\u00e1i g\u1eedi, l\u1ed7i, th\u1eddi gian g\u1eedi. <code>NotificationChannelCfg</code> C\u1ea5u h\u00ecnh k\u00eanh g\u1eedi (SMTP, SMS provider...) do tenant qu\u1ea3n l\u00fd."},{"location":"services/notification-service/sub/design/#ngoai-pham-vi","title":"\ud83d\udd12 Ngo\u00e0i Ph\u1ea1m Vi","text":"<p>Service n\u00e0y kh\u00f4ng th\u1ef1c hi\u1ec7n: - \u274c Qu\u1ea3n l\u00fd trigger business logic t\u1ea1o ra notification \u2013 \u0111\u00e3 \u0111\u01b0\u1ee3c t\u00e1ch ri\u00eang t\u1ea1i Notification Master. - \u274c T\u1ef1 generate n\u1ed9i dung ho\u1eb7c c\u00e1 nh\u00e2n h\u00f3a s\u00e2u (vi\u1ec7c \u0111\u00f3 do master th\u1ef1c hi\u1ec7n). - \u274c G\u1eedi th\u00f4ng b\u00e1o v\u01b0\u1ee3t quy\u1ec1n tenant (cross-tenant broadcast). - \u274c X\u00e1c th\u1ef1c user \u2013 \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n t\u1ea1i Gateway.</p>"},{"location":"services/notification-service/sub/design/#oi-tuong-su-dung","title":"\ud83d\udc65 \u0110\u1ed1i t\u01b0\u1ee3ng s\u1eed d\u1ee5ng","text":"<ul> <li>Notification Master (qua Pub/Sub \u2013 async)</li> <li>Superadmin Webapp (cho m\u1ee5c \u0111\u00edch tra log, ki\u1ec3m tra tr\u1ea1ng th\u00e1i \u2013 n\u1ebfu c\u1ea7n)</li> <li>Admin Webapp c\u1ee7a tenant (truy c\u1eadp n\u1ed9i b\u1ed9 \u0111\u1ec3 ch\u1ec9nh s\u1eeda c\u1ea5u h\u00ecnh k\u00eanh)</li> </ul>"},{"location":"services/notification-service/sub/design/#2-thiet-ke-api-chi-tiet","title":"2. \ud83c\udf10 Thi\u1ebft k\u1ebf API chi ti\u1ebft","text":"Method Path T\u00e1c v\u1ee5 Y\u00eau c\u1ea7u permission (RBAC) GET <code>/notifications/logs</code> L\u1ea5y danh s\u00e1ch log g\u1eedi <code>notif.read.log</code> GET <code>/notifications/templates</code> L\u1ea5y danh s\u00e1ch template <code>notif.read.template</code> POST <code>/notifications/test</code> G\u1eedi th\u1eed 1 notification t\u1edbi ng\u01b0\u1eddi d\u00f9ng test <code>notif.send.test</code> <p>\ud83d\udd27 Tu\u00e2n th\u1ee7: - ADR-011: Error Format - ADR-012: Response Envelope - ADR-013: Path Naming - ADR-030: Event Schema Governance (consume: <code>notification.triggered</code>) - \ud83d\udcce Chi ti\u1ebft xem t\u1ea1i: Interface Contract v\u00e0 OpenAPI Spec</p>"},{"location":"services/notification-service/sub/design/#3-mo-hinh-du-lieu-chi-tiet","title":"3. \ud83d\uddc3\ufe0f M\u00f4 h\u00ecnh d\u1eef li\u1ec7u chi ti\u1ebft","text":"<pre><code>erDiagram\n  NotificationTemplate ||--o{ NotificationLog : used_by\n  NotificationChannelCfg ||--o{ NotificationTemplate : configures\n\n  NotificationTemplate {\n    UUID id PK\n    STRING event_code\n    STRING channel\n    TEXT template_body\n    JSONB default_params\n    BOOLEAN is_active\n    TIMESTAMPTZ updated_at\n  }\n\n  NotificationLog {\n    UUID id PK\n    UUID template_id FK\n    STRING recipient\n    STRING status\n    TEXT error_message\n    JSONB payload\n    TIMESTAMPTZ sent_at\n  }\n\n  NotificationChannelCfg {\n    STRING channel PK\n    STRING provider\n    JSONB config\n    BOOLEAN is_enabled\n    TIMESTAMPTZ updated_at\n  }\n````\n\n&gt; \ud83d\udcce Chi ti\u1ebft xem t\u1ea1i: [Data Model](./data-model.md)\n\n---\n\n### 4. \ud83d\udd04 Lu\u1ed3ng nghi\u1ec7p v\u1ee5 ch\u00ednh \u2013 Chi ti\u1ebft h\u00f3a\n\n#### 4.1. M\u1ee5c ti\u00eau\n\nM\u1ed7i l\u1ea7n nh\u1eadn \u0111\u01b0\u1ee3c s\u1ef1 ki\u1ec7n `notification.triggered`, service ph\u1ea3i:\n\n1. L\u1ea5y \u0111\u00fang template ph\u00f9 h\u1ee3p theo `event_code`, `channel`, `tenant_id`\n2. G\u1eedi notification qua k\u00eanh t\u01b0\u01a1ng \u1ee9ng (email, SMS, v.v.)\n3. Log \u0111\u1ea7y \u0111\u1ee7 h\u00e0nh \u0111\u1ed9ng g\u1eedi \u2013 tr\u1ea1ng th\u00e1i, l\u1ed7i n\u1ebfu c\u00f3, th\u1eddi gian\n4. C\u00f3 fallback n\u1ebfu g\u1eedi k\u00eanh ch\u00ednh th\u1ea5t b\u1ea1i (n\u1ebfu \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh)\n5. Tu\u00e2n th\u1ee7 gi\u1edbi h\u1ea1n (rate-limit, retry theo config n\u1ebfu c\u00f3)\n\n---\n\n#### 4.2. M\u00f4 t\u1ea3 logic \u0111\u1ea7y \u0111\u1ee7\n\n```mermaid\nsequenceDiagram\n    participant PubSub as Pub/Sub\n    participant NotiSub as Notification Sub\n    participant DB as Notification DB\n    participant Email as Email/SMS Gateway\n    participant Fallback as Fallback Channel\n\n    PubSub--&gt;&gt;NotiSub: Nh\u1eadn s\u1ef1 ki\u1ec7n `notification.triggered`\n    Note right of NotiSub: Extract `tenant_id`, `event_code`, `channel`, `recipient`, `params`\n\n    NotiSub-&gt;&gt;DB: Truy v\u1ea5n NotificationTemplate (match theo `event_code`, `channel`, `tenant_id`)\n    alt Kh\u00f4ng t\u00ecm th\u1ea5y template\n        NotiSub--&gt;&gt;DB: Ghi log l\u1ed7i \"template not found\"\n        Note right of NotiSub: D\u1eebng x\u1eed l\u00fd \u2013 kh\u00f4ng g\u1eedi\n    else Template h\u1ee3p l\u1ec7\n        NotiSub-&gt;&gt;DB: Ghi log tr\u1ea1ng th\u00e1i `queued`, l\u01b0u payload\n        NotiSub-&gt;&gt;Email: G\u1eedi th\u00f4ng b\u00e1o (render template + send)\n        alt G\u1eedi th\u00e0nh c\u00f4ng\n            Email--&gt;&gt;NotiSub: OK\n            NotiSub-&gt;&gt;DB: Update log \u2192 status=`sent`\n        else G\u1eedi th\u1ea5t b\u1ea1i\n            Email--&gt;&gt;NotiSub: Error\n            alt C\u00f3 fallback \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh\n                NotiSub-&gt;&gt;Fallback: G\u1eedi l\u1ea1i qua k\u00eanh fallback\n                Fallback--&gt;&gt;NotiSub: OK/Error\n                NotiSub-&gt;&gt;DB: Update log \u2192 status=`sent_fallback` ho\u1eb7c `failed`\n            else Kh\u00f4ng c\u00f3 fallback\n                NotiSub-&gt;&gt;DB: Update log \u2192 status=`failed`, l\u01b0u l\u1ed7i\n            end\n        end\n    end\n</code></pre>"},{"location":"services/notification-service/sub/design/#43-chi-tiet-cac-buoc","title":"4.3. Chi ti\u1ebft c\u00e1c b\u01b0\u1edbc","text":"B\u01b0\u1edbc M\u00f4 t\u1ea3 1. Nh\u1eadn s\u1ef1 ki\u1ec7n Service l\u1eafng nghe t\u1eeb Pub/Sub <code>notification.triggered.v1</code> v\u1edbi payload c\u00f3 <code>event_code</code>, <code>channel</code>, <code>recipient</code>, <code>params</code>, <code>trace_id</code>, <code>tenant_id</code>. 2. Tra c\u1ee9u template Truy theo <code>event_code</code> + <code>channel</code> + <code>tenant_id</code>. N\u1ebfu kh\u00f4ng c\u00f3 template t\u01b0\u01a1ng \u1ee9ng \u2192 ghi log l\u1ed7i v\u00e0 d\u1eebng. 3. Render &amp; G\u1eedi Render <code>template_body</code> v\u1edbi <code>params</code> v\u00e0 g\u1eedi th\u1ef1c t\u1ebf qua SMTP/SMS/... 4. Ghi log g\u1eedi T\u1ea1o entry trong b\u1ea3ng <code>NotificationLog</code> tr\u01b0\u1edbc khi g\u1eedi (status: <code>queued</code>), sau \u0111\u00f3 update th\u00e0nh <code>sent</code>, <code>sent_fallback</code>, ho\u1eb7c <code>failed</code>. 5. X\u1eed l\u00fd fallback N\u1ebfu k\u00eanh g\u1eedi th\u1ea5t b\u1ea1i v\u00e0 c\u00f3 c\u1ea5u h\u00ecnh fallback (VD: t\u1eeb email \u2192 SMS), th\u1ef1c hi\u1ec7n g\u1eedi l\u1ea1i qua fallback. 6. Audit &amp; Tracing Ghi \u0111\u1ea7y \u0111\u1ee7 trace_id v\u00e0 action <code>notification.sent</code> ph\u1ee5c v\u1ee5 audit (<code>adr-008</code>)."},{"location":"services/notification-service/sub/design/#44-ghi-chu-luu-y-trien-khai","title":"4.4. Ghi ch\u00fa &amp; l\u01b0u \u00fd tri\u1ec3n khai","text":"<ul> <li>Template Mapping ph\u1ea3i \u0111\u00fang channel \u2013 tr\u00e1nh g\u1eedi email b\u1eb1ng SMS template ho\u1eb7c ng\u01b0\u1ee3c l\u1ea1i.</li> <li>B\u1ea3o v\u1ec7 ch\u1ed1ng g\u1eedi l\u1eb7p n\u1ebfu Pub/Sub delivery b\u1ecb tr\u00f9ng \u2192 c\u1ea7n x\u1eed l\u00fd idempotency qua <code>event_id</code>.</li> <li>Fallback policy c\u00f3 th\u1ec3 c\u1ea5u h\u00ecnh \u1edf level <code>NotificationChannelCfg</code>, v\u00ed d\u1ee5:</li> </ul> <p><pre><code>{\n  \"channel\": \"email\",\n  \"fallback\": [\"sms\"],\n  \"retry_limit\": 2\n}\n</code></pre> * C\u1ea7n validate \u0111\u1ea7u v\u00e0o k\u1ef9: recipient kh\u00f4ng null, channel \u0111\u01b0\u1ee3c h\u1ed7 tr\u1ee3, params \u0111\u1ee7 \u0111\u1ec3 render template. * Kh\u00f4ng block worker n\u1ebfu g\u1eedi th\u1ea5t b\u1ea1i \u2013 ch\u1ec9 c\u1ea7n log v\u00e0 ti\u1ebfp t\u1ee5c.</p>"},{"location":"services/notification-service/sub/design/#5-tuong-tac-su-kien","title":"5. \ud83d\udce3 T\u01b0\u01a1ng t\u00e1c &amp; S\u1ef1 ki\u1ec7n","text":""},{"location":"services/notification-service/sub/design/#51-su-kien-nhan-vao-consumed-event","title":"5.1. S\u1ef1 ki\u1ec7n nh\u1eadn v\u00e0o (Consumed Event)","text":""},{"location":"services/notification-service/sub/design/#su-kien-notificationtriggeredv1","title":"\ud83d\udd14 S\u1ef1 ki\u1ec7n: <code>notification.triggered.v1</code>","text":"Thu\u1ed9c t\u00ednh B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>event_id</code> \u2705 UUID \u0111\u1ecbnh danh s\u1ef1 ki\u1ec7n, ph\u1ee5c v\u1ee5 idempotency <code>tenant_id</code> \u2705 Tenant g\u1eedi th\u00f4ng b\u00e1o <code>event_code</code> \u2705 M\u00e3 s\u1ef1 ki\u1ec7n tr\u1eebu t\u01b0\u1ee3ng (vd: <code>user.welcome</code>) \u0111\u1ec3 tra template <code>channel</code> \u2705 K\u00eanh g\u1eedi (<code>email</code>, <code>sms</code>, <code>push</code>, etc.) <code>recipient</code> \u2705 \u0110\u1ecba ch\u1ec9 nh\u1eadn (<code>email</code>, <code>phone</code>, <code>device_id</code>,\u2026) <code>params</code> \u2705 Tham s\u1ed1 \u0111\u1ed9ng \u0111\u1ec3 render n\u1ed9i dung template (JSON) <code>trigger_by</code> \u26d4 ID ng\u01b0\u1eddi d\u00f9ng k\u00edch ho\u1ea1t s\u1ef1 ki\u1ec7n (n\u1ebfu c\u00f3) <code>trace_id</code> \u2705 Trace \u0111\u1ec3 tracking xuy\u00ean su\u1ed1t to\u00e0n h\u1ec7 th\u1ed1ng <code>created_at</code> \u2705 Th\u1eddi \u0111i\u1ec3m ph\u00e1t sinh s\u1ef1 ki\u1ec7n (\u0111\u1ec3 log th\u1ed1ng nh\u1ea5t) <p>V\u00ed d\u1ee5 schema (JSON):</p> <pre><code>{\n  \"event_id\": \"3a36f1d4-8fa7-4704-a94e-4c55e9142cb3\",\n  \"tenant_id\": \"tenant-vas-001\",\n  \"event_code\": \"user.welcome\",\n  \"channel\": \"email\",\n  \"recipient\": \"student@example.edu.vn\",\n  \"params\": {\n    \"full_name\": \"Nguy\u1ec5n V\u0103n A\",\n    \"first_login_at\": \"2025-06-01T10:00:00Z\"\n  },\n  \"trigger_by\": \"admin_123\",\n  \"trace_id\": \"x-trace-abc-789\",\n  \"created_at\": \"2025-06-14T07:32:00Z\"\n}\n</code></pre> <p>\u2705 Schema n\u00e0y \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd v\u00e0 version h\u00f3a theo <code>ADR-030 \u2013 Event Schema Governance</code></p>"},{"location":"services/notification-service/sub/design/#52-xu-ly-su-kien","title":"5.2. X\u1eed l\u00fd s\u1ef1 ki\u1ec7n","text":"<ul> <li> <p>Notification Sub Service s\u1ebd \u0111\u0103ng k\u00fd l\u1eafng nghe topic t\u01b0\u01a1ng \u1ee9ng, v\u00ed d\u1ee5:</p> </li> <li> <p>GCP Pub/Sub: <code>vas.notification.triggered.v1</code></p> </li> <li>Kafka: <code>notification.triggered.v1</code></li> <li> <p>Khi nh\u1eadn event, service th\u1ef1c hi\u1ec7n pipeline:</p> </li> <li> <p>Parse + Validate schema theo version</p> </li> <li>Check <code>event_id</code> \u0111\u00e3 x\u1eed l\u00fd ch\u01b0a \u2192 \u0111\u1ec3 tr\u00e1nh g\u1eedi l\u1eb7p (idempotency)</li> <li>Render template</li> <li>G\u1eedi notification</li> <li>Ghi log + k\u1ebft qu\u1ea3 g\u1eedi + <code>trace_id</code> + <code>status</code></li> </ul>"},{"location":"services/notification-service/sub/design/#53-khong-phat-sinh-su-kien-outbound","title":"5.3. Kh\u00f4ng ph\u00e1t sinh s\u1ef1 ki\u1ec7n outbound","text":"<p>Notification Sub kh\u00f4ng ph\u00e1t event ng\u01b0\u1ee3c ra ngo\u00e0i. Tuy nhi\u00ean:</p> <ul> <li>C\u00f3 th\u1ec3 log v\u00e0o h\u1ec7 th\u1ed1ng Audit Logging (theo <code>adr-008</code>) b\u1eb1ng c\u00e1ch g\u1ecdi n\u1ed9i b\u1ed9 t\u1edbi <code>audit-logging-service</code></li> <li>Kh\u00f4ng c\u00f3 lu\u1ed3ng \u0111\u1ed3ng b\u1ed9 \u0111\u1ea9y ra Pub/Sub \u0111\u1ec3 tr\u00e1nh ph\u00e1t sinh spam ho\u1eb7c loop</li> </ul>"},{"location":"services/notification-service/sub/design/#54-bien-the-su-kien-kha-nang-mo-rong","title":"5.4. Bi\u1ebfn th\u1ec3 s\u1ef1 ki\u1ec7n &amp; kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng","text":"Bi\u1ebfn th\u1ec3 M\u00f4 t\u1ea3 C\u00e1ch x\u1eed l\u00fd <code>notification.triggered.v2</code> Phi\u00ean b\u1ea3n m\u1edbi c\u1ee7a schema (breaking change) Service n\u00ean dual-consume n\u1ebfu c\u1ea7n <code>notification.test.v1</code> S\u1ef1 ki\u1ec7n g\u1eedi th\u1eed (t\u1eeb Admin UI) C\u00f3 th\u1ec3 x\u1eed l\u00fd n\u1ed9i b\u1ed9, log ri\u00eang <code>notification.bulk.v1</code> G\u1eedi nhi\u1ec1u ng\u01b0\u1eddi nh\u1eadn m\u1ed9t l\u00fac Kh\u00f4ng x\u1eed l\u00fd \u2013 \u0111\u00e3 t\u00e1ch th\u00e0nh lu\u1ed3ng ri\u00eang <p>\ud83d\udccc C\u00e1c bi\u1ebfn th\u1ec3 n\u00ean \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a r\u00f5 trong <code>event-schemas/registry</code> theo <code>ADR-030</code></p>"},{"location":"services/notification-service/sub/design/#55-chinh-sach-schema-versioning","title":"5.5. Ch\u00ednh s\u00e1ch Schema &amp; Versioning","text":"<p>Tu\u00e2n th\u1ee7 nghi\u00eam ng\u1eb7t <code>ADR-030</code>:</p> <ul> <li>Kh\u00f4ng thay \u0111\u1ed5i field b\u1eaft bu\u1ed9c trong version c\u0169</li> <li>N\u1ebfu c\u1ea7n breaking change \u2192 t\u1ea1o version m\u1edbi (vd: <code>v2</code>) v\u00e0 dual-publish trong giai \u0111o\u1ea1n chuy\u1ec3n ti\u1ebfp</li> <li>M\u1ed7i s\u1ef1 ki\u1ec7n \u0111\u1ec1u mang <code>event_id</code>, <code>trace_id</code>, <code>version</code>, <code>tenant_id</code></li> </ul>"},{"location":"services/notification-service/sub/design/#6-bao-mat-rbac","title":"6. \ud83d\udd10 B\u1ea3o m\u1eadt &amp; RBAC","text":""},{"location":"services/notification-service/sub/design/#61-authentication-xac-thuc","title":"6.1. Authentication \u2013 X\u00e1c th\u1ef1c","text":"<ul> <li>M\u1ecdi API c\u1ee7a Notification Sub \u0111\u1ec1u y\u00eau c\u1ea7u ng\u01b0\u1eddi d\u00f9ng \u0111\u00e3 x\u00e1c th\u1ef1c qua API Gateway, d\u00f9ng JWT chu\u1ea9n theo <code>ADR-006</code>.</li> <li> <p>Token s\u1ebd \u0111\u01b0\u1ee3c ki\u1ec3m tra signature v\u00e0 claim g\u1ed3m:</p> </li> <li> <p><code>sub</code>: user ID</p> </li> <li><code>tenant_id</code>: m\u00e3 tenant \u0111ang truy c\u1eadp</li> <li><code>permissions</code>: danh s\u00e1ch quy\u1ec1n c\u00f3 d\u1ea1ng <code>notif.read.log</code>, <code>notif.send.test</code>, v.v.</li> <li><code>exp</code>: th\u1eddi \u0111i\u1ec3m h\u1ebft h\u1ea1n</li> <li>Token \u0111\u01b0\u1ee3c \u0111\u00ednh k\u00e8m qua header:</li> </ul> <pre><code>Authorization: Bearer &lt;access_token&gt;\n</code></pre>"},{"location":"services/notification-service/sub/design/#62-authorization-phan-quyen","title":"6.2. Authorization \u2013 Ph\u00e2n quy\u1ec1n","text":"<p>\u00c1p d\u1ee5ng m\u00f4 h\u00ecnh RBAC ph\u00e2n t\u1ea7ng theo tenant, theo chu\u1ea9n <code>ADR-007</code>. M\u1ed7i API \u0111\u1ec1u khai b\u00e1o permission y\u00eau c\u1ea7u qua <code>x-required-permission</code>, v\u00ed d\u1ee5:</p> <pre><code>x-required-permission: notif.read.log\n</code></pre>"},{"location":"services/notification-service/sub/design/#quy-tac-phan-quyen","title":"Quy t\u1eafc ph\u00e2n quy\u1ec1n:","text":"Nh\u00f3m ch\u1ee9c n\u0103ng Permission M\u00f4 t\u1ea3 Xem log g\u1eedi <code>notif.read.log</code> Cho ph\u00e9p truy xu\u1ea5t danh s\u00e1ch notification \u0111\u00e3 g\u1eedi Xem template <code>notif.read.template</code> Cho ph\u00e9p tra c\u1ee9u c\u00e1c template hi\u1ec7n c\u00f3 G\u1eedi th\u1eed <code>notif.send.test</code> G\u1eedi th\u1eed email/SMS \u0111\u1ebfn \u0111\u1ecba ch\u1ec9 ki\u1ec3m tra C\u1ea5u h\u00ecnh channel <code>notif.write.config</code> S\u1eeda th\u00f4ng tin c\u1ea5u h\u00ecnh k\u00eanh g\u1eedi c\u1ee7a tenant <p>\u2705 Danh s\u00e1ch permission \u0111\u01b0\u1ee3c c\u1ea5p theo t\u1eebng <code>user_role</code> g\u1eafn v\u1edbi <code>X-Tenant-ID</code></p>"},{"location":"services/notification-service/sub/design/#63-tenant-isolation-tach-biet-tenant","title":"6.3. Tenant Isolation \u2013 T\u00e1ch bi\u1ec7t tenant","text":"<p>Theo y\u00eau c\u1ea7u c\u1ee7a <code>CR-04</code>, m\u1ecdi h\u00e0nh \u0111\u1ed9ng (query, mutate, audit) \u0111\u1ec1u ph\u1ea3i:</p> <ul> <li>R\u00e0ng bu\u1ed9c trong ph\u1ea1m vi <code>X-Tenant-ID</code> (\u0111\u1ecdc t\u1eeb JWT ho\u1eb7c header)</li> <li>Kh\u00f4ng cho ph\u00e9p truy c\u1eadp ch\u00e9o tenant (tr\u1eeb <code>Superadmin</code>)</li> <li>C\u00f3 c\u1ea5u tr\u00fac condition r\u00f5 trong OpenAPI:</li> </ul> <pre><code>x-condition:\n  tenant_id: \"{{X-Tenant-ID}}\"\n</code></pre>"},{"location":"services/notification-service/sub/design/#64-audit-logging-ghi-log-kiem-toan","title":"6.4. Audit Logging \u2013 Ghi log ki\u1ec3m to\u00e1n","text":"<p>Tu\u00e2n th\u1ee7 <code>ADR-008</code>, m\u1ecdi h\u00e0nh \u0111\u1ed9ng quan tr\u1ecdng s\u1ebd \u0111\u01b0\u1ee3c log l\u1ea1i d\u01b0\u1edbi d\u1ea1ng Audit Event, bao g\u1ed3m:</p> H\u00e0nh \u0111\u1ed9ng Audit Action Ghi ch\u00fa G\u1eedi m\u1ed9t notification <code>notification.sent</code> Bao g\u1ed3m recipient, template_id, status S\u1eeda c\u1ea5u h\u00ecnh channel g\u1eedi <code>notification.config.updated</code> L\u01b0u l\u1ea1i gi\u00e1 tr\u1ecb c\u0169 v\u00e0 m\u1edbi G\u1eedi th\u1eed <code>notification.test_sent</code> L\u01b0u l\u1ea1i ng\u01b0\u1eddi g\u1eedi th\u1eed &amp; k\u1ebft qu\u1ea3 <p>Audit log \u0111\u01b0\u1ee3c \u0111\u1ea9y async t\u1edbi <code>audit-logging-service</code> ho\u1eb7c ghi n\u1ed9i b\u1ed9 t\u00f9y theo c\u1ea5u h\u00ecnh m\u00f4i tr\u01b0\u1eddng</p>"},{"location":"services/notification-service/sub/design/#65-data-protection-bao-ve-du-lieu-ca-nhan","title":"6.5. Data Protection \u2013 B\u1ea3o v\u1ec7 d\u1eef li\u1ec7u c\u00e1 nh\u00e2n","text":"<ul> <li>Kh\u00f4ng l\u01b0u plaintext recipient ho\u1eb7c payload n\u1ebfu kh\u00f4ng c\u1ea7n thi\u1ebft.</li> <li>Tr\u01b0\u1eddng nh\u1ea1y c\u1ea3m (<code>recipient</code>, <code>error_message</code>) c\u00f3 th\u1ec3 b\u1ecb mask ho\u1eb7c hash n\u1ebfu \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh.</li> <li>C\u00f3 th\u1ec3 d\u00f9ng <code>ADR-024</code> \u0111\u1ec3 thi\u1ebft l\u1eadp th\u1eddi gian anonymization ho\u1eb7c retention policy theo t\u1eebng tenant.</li> </ul>"},{"location":"services/notification-service/sub/design/#66-cac-bien-phap-phong-ve-bo-sung","title":"6.6. C\u00e1c bi\u1ec7n ph\u00e1p ph\u00f2ng v\u1ec7 b\u1ed5 sung","text":"L\u1edbp b\u1ea3o v\u1ec7 M\u00f4 t\u1ea3 Input validation Ki\u1ec3m tra recipient, template_id, channel c\u00f3 h\u1ee3p l\u1ec7 kh\u00f4ng Rate limiting Do API Gateway qu\u1ea3n l\u00fd \u2013 tr\u00e1nh spam g\u1eedi Idempotency D\u1ef1a tr\u00ean <code>event_id</code> \u0111\u1ec3 tr\u00e1nh g\u1eedi l\u1eb7p n\u1ebfu event b\u1ecb retry Fallback isolation N\u1ebfu g\u1eedi th\u1ea5t b\u1ea1i v\u00e0 fallback, \u0111\u1ea3m b\u1ea3o fallback kh\u00f4ng r\u00f2 d\u1eef li\u1ec7u gi\u1eefa tenant CI/CD static scan Ki\u1ec3m tra dependency &amp; config secrets tr\u01b0\u1edbc khi deploy"},{"location":"services/notification-service/sub/design/#7-cau-hinh-phu-thuoc","title":"7. \u2699\ufe0f C\u1ea5u h\u00ecnh &amp; Ph\u1ee5 thu\u1ed9c","text":""},{"location":"services/notification-service/sub/design/#71-bien-moi-truong-chinh-env-vars","title":"7.1. Bi\u1ebfn m\u00f4i tr\u01b0\u1eddng ch\u00ednh (<code>ENV VARS</code>)","text":"Bi\u1ebfn B\u1eaft bu\u1ed9c Gi\u00e1 tr\u1ecb m\u1eabu M\u00f4 t\u1ea3 <code>SERVICE_PORT</code> \u2705 <code>8080</code> C\u1ed5ng service s\u1ebd m\u1edf cho HTTP API n\u1ed9i b\u1ed9 <code>DATABASE_URL</code> \u2705 <code>postgres://user:pass@host:5432/notif_sub</code> K\u1ebft n\u1ed1i t\u1edbi CSDL Postgres ch\u1ee9a template/log <code>PUBSUB_TOPIC</code> \u2705 <code>notification.triggered.v1</code> T\u00ean topic Pub/Sub \u0111\u1ec3 subscribe s\u1ef1 ki\u1ec7n <code>GCP_PROJECT_ID</code> \u26d4 <code>vas-prod-01</code> D\u00f9ng n\u1ebfu ch\u1ea1y tr\u00ean GCP \u2013 \u0111\u1ecbnh danh project <code>TENANT_CONFIG_SECRET_PATH</code> \u2705 <code>/secrets/tenant_config/</code> Tr\u1ecf t\u1edbi th\u01b0 m\u1ee5c ch\u1ee9a config t\u1eebng tenant (template, fallback, channel) <code>SMTP_PROVIDER_SECRET</code> \u26d4 <code>secret://smtp-notif</code> Secret ch\u1ee9a config SMTP provider m\u1eb7c \u0111\u1ecbnh <code>JWT_PUBLIC_KEY_PATH</code> \u2705 <code>/etc/keys/jwt.pub</code> File public key \u0111\u1ec3 verify JWT <code>ENVIRONMENT</code> \u2705 <code>production</code> / <code>staging</code> / <code>dev</code> D\u00f9ng \u0111\u1ec3 ph\u00e2n bi\u1ec7t m\u00f4i tr\u01b0\u1eddng khi g\u1eedi Audit log, alerting <code>AUDIT_SERVICE_ENDPOINT</code> \u26d4 <code>http://audit-logging-service</code> Endpoint n\u1ed9i b\u1ed9 g\u1ecdi t\u1edbi Audit Logging n\u1ebfu b\u1eadt <p>\ud83d\udd10 Secrets nh\u01b0 SMTP credentials, access tokens kh\u00f4ng bao gi\u1edd hardcode \u2013 \u0111\u01b0\u1ee3c mount t\u1eeb Secret Manager ho\u1eb7c Vault (theo <code>ADR-003</code> v\u00e0 <code>ADR-004</code>)</p>"},{"location":"services/notification-service/sub/design/#72-cau-hinh-theo-tenant-dynamic-per-tenant","title":"7.2. C\u1ea5u h\u00ecnh theo tenant (Dynamic per-tenant)","text":"<p>C\u00e1c tenant c\u00f3 th\u1ec3 c\u00f3 c\u1ea5u h\u00ecnh kh\u00e1c nhau nh\u01b0:</p> C\u1ea5u h\u00ecnh M\u00f4 t\u1ea3 Template ri\u00eang C\u00f9ng m\u1ed9t <code>event_code</code>, m\u1ed7i tenant c\u00f3 th\u1ec3 \u0111\u1ecbnh ngh\u0129a n\u1ed9i dung template kh\u00e1c nhau C\u1ea5u h\u00ecnh k\u00eanh g\u1eedi Email: SMTP ri\u00eang, SMS: key ri\u00eang theo provider Fallback policy C\u00f3 th\u1ec3 ch\u1ecdn fallback ho\u1eb7c kh\u00f4ng, theo logic ri\u00eang c\u1ee7a tenant Ng\u00f4n ng\u1eef m\u1eb7c \u0111\u1ecbnh M\u1ed9t s\u1ed1 tenant g\u1eedi email b\u1eb1ng Ti\u1ebfng Anh, s\u1ed1 kh\u00e1c b\u1eb1ng Ti\u1ebfng Vi\u1ec7t Opt-in / Opt-out Cho ph\u00e9p user t\u1eeb ch\u1ed1i nh\u1eadn m\u1ed9t s\u1ed1 lo\u1ea1i th\u00f4ng b\u00e1o (VD: qu\u1ea3ng c\u00e1o) <p>Th\u00f4ng tin n\u00e0y \u0111\u01b0\u1ee3c n\u1ea1p t\u1eeb <code>TENANT_CONFIG_SECRET_PATH</code> theo m\u1ed7i tenant (<code>tenant_id</code>) trong runtime.</p>"},{"location":"services/notification-service/sub/design/#73-phu-thuoc-he-thong","title":"7.3. Ph\u1ee5 thu\u1ed9c h\u1ec7 th\u1ed1ng","text":"Th\u00e0nh ph\u1ea7n M\u1ee5c ti\u00eau s\u1eed d\u1ee5ng Giao th\u1ee9c <code>PostgreSQL</code> L\u01b0u tr\u1eef <code>NotificationTemplate</code>, <code>NotificationLog</code>, <code>ChannelCfg</code> SQL <code>Pub/Sub</code> Nh\u1eadn s\u1ef1 ki\u1ec7n <code>notification.triggered</code> t\u1eeb Master PubSub/Kafka <code>Email/SMS Provider</code> G\u1eedi email, SMS qua SMTP/HTTP API SMTP / HTTPS <code>audit-logging-service</code> Ghi log h\u00e0nh vi g\u1eedi (n\u1ebfu b\u1eadt) HTTP n\u1ed9i b\u1ed9 <code>vault / secret-manager</code> L\u01b0u config g\u1eedi ri\u00eang c\u1ee7a tenant N\u1ea1p khi runtime"},{"location":"services/notification-service/sub/design/#74-phan-biet-giua-cau-hinh-build-time-va-runtime","title":"7.4. Ph\u00e2n bi\u1ec7t gi\u1eefa c\u1ea5u h\u00ecnh \"build-time\" v\u00e0 \"runtime\"","text":"Lo\u1ea1i c\u1ea5u h\u00ecnh V\u00ed d\u1ee5 Ghi ch\u00fa Build-time <code>ENVIRONMENT</code>, <code>SERVICE_PORT</code>, <code>GCP_PROJECT_ID</code> D\u00f9ng trong CI/CD, x\u00e1c \u0111\u1ecbnh behavior Runtime <code>tenant_id</code>, <code>SMTP_PROVIDER_SECRET</code>, <code>ChannelCfg</code> N\u1ea1p \u0111\u1ed9ng t\u00f9y tenant ho\u1eb7c request"},{"location":"services/notification-service/sub/design/#8-kiem-thu","title":"8. \ud83e\uddea Ki\u1ec3m th\u1eed","text":"<p>Vi\u1ec7c ki\u1ec3m th\u1eed <code>notification-service/sub/</code> \u0111\u01b0\u1ee3c chia th\u00e0nh 4 l\u1edbp ch\u00ednh: Unit, Integration, Contract, v\u00e0 Security &amp; RBAC. T\u1ea5t c\u1ea3 c\u00e1c test \u0111\u1ec1u c\u1ea7n t\u1ef1 \u0111\u1ed9ng h\u00f3a v\u00e0 \u0111\u01b0\u1ee3c t\u00edch h\u1ee3p v\u00e0o CI pipeline qua GitHub Actions (<code>adr-001</code>).</p>"},{"location":"services/notification-service/sub/design/#81-unit-tests","title":"8.1. \ud83e\uddea Unit Tests","text":"M\u1ee5c ti\u00eau N\u1ed9i dung ki\u1ec3m th\u1eed X\u1eed l\u00fd s\u1ef1 ki\u1ec7n Ki\u1ec3m tra c\u00e1c nh\u00e1nh x\u1eed l\u00fd khi nh\u1eadn event: t\u00ecm th\u1ea5y template, kh\u00f4ng t\u00ecm th\u1ea5y, g\u1eedi th\u00e0nh c\u00f4ng, g\u1eedi th\u1ea5t b\u1ea1i G\u1eedi th\u00f4ng b\u00e1o Mock SMTP/SMS provider \u0111\u1ec3 ki\u1ec3m tra logic g\u1eedi Template rendering X\u00e1c minh <code>params</code> render \u0111\u00fang template ho\u1eb7c l\u1ed7i r\u00f5 r\u00e0ng khi thi\u1ebfu bi\u1ebfn Fallback logic Ki\u1ec3m tra khi channel ch\u00ednh l\u1ed7i, service fallback \u0111\u00fang channel ph\u1ee5 Logging logic Log \u0111\u00fang tr\u1ea1ng th\u00e1i: <code>queued</code>, <code>sent</code>, <code>sent_fallback</code>, <code>failed</code> <p>\u2705 T\u1ef7 l\u1ec7 coverage b\u1eaft bu\u1ed9c &gt; 80% (code coverage report t\u00edch h\u1ee3p CI/CD)</p>"},{"location":"services/notification-service/sub/design/#82-integration-tests","title":"8.2. \ud83d\udd04 Integration Tests","text":"T\u1ea7ng t\u00edch h\u1ee3p N\u1ed9i dung ki\u1ec3m th\u1eed V\u1edbi DB Insert + query c\u00e1c b\u1ea3n ghi <code>NotificationLog</code>, <code>Template</code>, <code>ChannelCfg</code> V\u1edbi Pub/Sub G\u1eedi gi\u1ea3 l\u1eadp s\u1ef1 ki\u1ec7n <code>notification.triggered.v1</code> v\u00e0 x\u00e1c minh h\u00e0nh vi end-to-end V\u1edbi SMTP/SMS gi\u1ea3 l\u1eadp D\u00f9ng fake server \u0111\u1ec3 test lu\u1ed3ng g\u1eedi th\u1eadt (smtp4dev, httpbin) V\u1edbi Audit Service Ki\u1ec3m tra audit log g\u1eedi \u0111i \u0111\u00fang \u0111\u1ecbnh d\u1ea1ng, \u0111\u00fang action"},{"location":"services/notification-service/sub/design/#83-contract-tests-theo-adr-010","title":"8.3. \ud83e\udd1d Contract Tests (theo ADR-010)","text":"<p>Tu\u00e2n th\u1ee7 ki\u1ec3m th\u1eed giao di\u1ec7n (OpenAPI contract):</p> API Ki\u1ec3m th\u1eed GET <code>/notifications/logs</code> Tr\u1ea3 \u0111\u00fang \u0111\u1ecbnh d\u1ea1ng <code>Envelope</code>, pagination POST <code>/notifications/test</code> G\u1eedi th\u1eed th\u00e0nh c\u00f4ng v\u00e0 l\u1ed7i GET <code>/notifications/templates</code> Tr\u1ea3 danh s\u00e1ch template theo tenant <p>S\u1eed d\u1ee5ng:</p> <ul> <li>Prism ho\u1eb7c Dredd \u0111\u1ec3 test OpenAPI spec</li> <li>CI s\u1ebd fail n\u1ebfu sai contract (v\u00ed d\u1ee5 \u0111\u1ed5i schema kh\u00f4ng b\u00e1o tr\u01b0\u1edbc)</li> </ul>"},{"location":"services/notification-service/sub/design/#84-rbac-security-tests","title":"8.4. \ud83d\udee1\ufe0f RBAC &amp; Security Tests","text":"T\u00ecnh hu\u1ed1ng Ki\u1ec3m th\u1eed Kh\u00f4ng c\u00f3 token B\u1ecb t\u1eeb ch\u1ed1i truy c\u1eadp (<code>401</code>) Token sai tenant Kh\u00f4ng nh\u00ecn th\u1ea5y d\u1eef li\u1ec7u tenant kh\u00e1c (<code>403</code>) Thi\u1ebfu permission Tr\u1ea3 l\u1ed7i <code>403</code>, c\u00f3 <code>error_code: permission_denied</code> C\u00f3 \u0111\u1ee7 quy\u1ec1n Truy c\u1eadp \u0111\u01b0\u1ee3c API t\u01b0\u01a1ng \u1ee9ng JWT expired Tr\u1ea3 l\u1ed7i <code>401</code> r\u00f5 r\u00e0ng JWT kh\u00f4ng \u0111\u00fang \u0111\u1ecbnh d\u1ea1ng Tr\u1ea3 <code>400</code> v\u1edbi m\u00e3 l\u1ed7i <code>invalid_token</code> <p>\u2705 K\u1ebft qu\u1ea3 test ph\u1ea3i kh\u1edbp v\u1edbi <code>error-codes.md</code> theo <code>ADR-011</code></p>"},{"location":"services/notification-service/sub/design/#85-o-luong-bao-cao","title":"8.5. \ud83d\udcca \u0110o l\u01b0\u1eddng &amp; B\u00e1o c\u00e1o","text":"<ul> <li>B\u00e1o c\u00e1o test coverage (<code>pytest-cov</code>, <code>jest</code>,...) g\u1eedi v\u1ec1 CI/CD dashboard</li> <li> <p>Ghi r\u00f5:</p> </li> <li> <p>% coverage theo service/module</p> </li> <li>T\u00ean test b\u1ecb fail v\u00e0 l\u00fd do</li> <li>T\u1ef1 \u0111\u1ed9ng ch\u1ea1y l\u1ea1i test n\u1ebfu x\u1ea3y ra race condition do message queue</li> </ul>"},{"location":"services/notification-service/sub/design/#86-test-trong-moi-truong-staging","title":"8.6. \ud83e\uddea Test trong m\u00f4i tr\u01b0\u1eddng staging","text":"<p>M\u1ed7i release tr\u01b0\u1edbc khi \u0111\u01b0a l\u00ean production s\u1ebd \u0111\u01b0\u1ee3c ki\u1ec3m tra trong staging v\u1edbi:</p> M\u00f4i tr\u01b0\u1eddng M\u1ee5c ti\u00eau DB \u0111\u1ed9c l\u1eadp Kh\u00f4ng \u1ea3nh h\u01b0\u1edfng prod Pub/Sub topic ri\u00eang Tr\u00e1nh ti\u00eau th\u1ee5 nh\u1ea7m message th\u1eadt SMTP test gateway Kh\u00f4ng g\u1eedi th\u1eadt, c\u00f3 log ki\u1ec3m ch\u1ee9ng"},{"location":"services/notification-service/sub/design/#9-giam-sat-audit","title":"9. \ud83d\udcc8 Gi\u00e1m s\u00e1t &amp; Audit","text":""},{"location":"services/notification-service/sub/design/#91-logging-ung-dung-gui-thong-bao","title":"9.1. \ud83d\udd0d Logging (\u1ee8ng d\u1ee5ng &amp; G\u1eedi th\u00f4ng b\u00e1o)","text":"M\u1ee5c ti\u00eau Chi ti\u1ebft M\u1ee9c log D\u00f9ng c\u00e1c m\u1ee9c <code>info</code>, <code>warn</code>, <code>error</code>, <code>debug</code> \u0111\u00fang chu\u1ea9n Tenant tagging M\u1ed7i log \u0111\u1ec1u ph\u1ea3i \u0111\u00ednh k\u00e8m <code>tenant_id</code>, <code>trace_id</code>, <code>event_id</code> n\u1ebfu c\u00f3 Nh\u00e2n s\u1ef1 ki\u1ec7n Log r\u00f5 event nh\u1eadn \u0111\u01b0\u1ee3c, template \u00e1p d\u1ee5ng, h\u00e0nh vi g\u1eedi Th\u1ea5t b\u1ea1i Log l\u00fd do l\u1ed7i g\u1eedi (<code>SMTP timeout</code>, <code>invalid recipient</code>, v.v.) Fallback Ghi nh\u1eadn n\u1ebfu g\u1eedi qua fallback channel Log \u0111\u1ecbnh d\u1ea1ng JSON log structure, tu\u00e2n chu\u1ea9n <code>12-factor app</code> \u0111\u1ec3 d\u1ec5 g\u1eedi sang ELK/Grafana/Loki"},{"location":"services/notification-service/sub/design/#92-metrics-prometheus-opentelemetry","title":"9.2. \ud83d\udcca Metrics (Prometheus / OpenTelemetry)","text":"Metric Ki\u1ec3u M\u00f4 t\u1ea3 <code>notif_event_received_total</code> Counter T\u1ed5ng s\u1ed1 event <code>notification.triggered</code> \u0111\u00e3 nh\u1eadn <code>notif_sent_success_total</code> Counter S\u1ed1 l\u01b0\u1ee3ng g\u1eedi th\u00e0nh c\u00f4ng qua channel ch\u00ednh <code>notif_sent_failed_total</code> Counter S\u1ed1 l\u01b0\u1ee3ng g\u1eedi th\u1ea5t b\u1ea1i ho\u00e0n to\u00e0n <code>notif_sent_fallback_total</code> Counter S\u1ed1 l\u01b0\u1ee3ng g\u1eedi qua fallback <code>notif_delivery_duration_ms</code> Histogram Th\u1eddi gian t\u1eeb l\u00fac nh\u1eadn event \u0111\u1ebfn khi g\u1eedi xong <code>notif_queue_size</code> Gauge S\u1ed1 l\u01b0\u1ee3ng event \u0111ang ch\u1edd x\u1eed l\u00fd trong h\u00e0ng \u0111\u1ee3i n\u1ed9i b\u1ed9 (n\u1ebfu d\u00f9ng buffer) <code>notif_db_latency_ms</code> Histogram Latency khi truy c\u1eadp CSDL <code>notif_config_load_errors_total</code> Counter S\u1ed1 l\u1ed7i n\u1ea1p config channel/template kh\u00f4ng h\u1ee3p l\u1ec7 <p>\u2705 T\u1ea5t c\u1ea3 metric \u0111\u1ec1u \u0111\u01b0\u1ee3c g\u1eafn nh\u00e3n (<code>labels</code>) g\u1ed3m <code>tenant_id</code>, <code>channel</code>, <code>status</code>, <code>template_id</code> n\u1ebfu c\u00f3.</p>"},{"location":"services/notification-service/sub/design/#93-slo-alerting","title":"9.3. \ud83c\udfaf SLO &amp; Alerting","text":"<p>Tu\u00e2n th\u1ee7 <code>ADR-022</code> \u2013 thi\u1ebft l\u1eadp SLO cho service:</p> M\u1ee5c ti\u00eau SLO Alert khi T\u1ef7 l\u1ec7 g\u1eedi th\u00e0nh c\u00f4ng \u2265 99% Trong 5 ph\u00fat, t\u1ec9 l\u1ec7 th\u1ea5t b\u1ea1i &gt; 5% \u0110\u1ed9 tr\u1ec5 x\u1eed l\u00fd &lt; 2s \u0110\u1ed9 tr\u1ec5 g\u1eedi &gt; 5s v\u1edbi &gt;10% notification L\u1ed7i template 0 C\u00f3 b\u1ea5t k\u1ef3 l\u1ed7i render ho\u1eb7c thi\u1ebfu template Kh\u00f4ng c\u00f3 log &lt; 1 min Kh\u00f4ng c\u00f3 event m\u1edbi \u0111\u01b0\u1ee3c nh\u1eadn trong \u2265 5 ph\u00fat (prod) <p>\u2705 Alert \u0111\u01b0\u1ee3c g\u1eedi v\u1ec1 Email/Slack qua Alertmanager ho\u1eb7c Grafana OnCall.</p>"},{"location":"services/notification-service/sub/design/#94-audit-log-tuan-thu-adr-008","title":"9.4. \ud83d\udcc1 Audit Log (tu\u00e2n th\u1ee7 ADR-008)","text":"<p>C\u00e1c h\u00e0nh vi c\u1ea7n audit:</p> H\u00e0nh vi <code>x-audit-action</code> N\u1ed9i dung c\u1ea7n log G\u1eedi notification <code>notification.sent</code> event_id, channel, status, template_id, recipient (masked), actor G\u1eedi th\u1eed <code>notification.test_sent</code> test_target, actor C\u1eadp nh\u1eadt channel <code>notification.config.updated</code> diff config, actor, time C\u1eadp nh\u1eadt template <code>notification.template.updated</code> diff content, actor, trace_id <ul> <li>Audit log \u0111\u01b0\u1ee3c \u0111\u1ea9y async t\u1edbi <code>audit-logging-service</code> qua HTTP n\u1ed9i b\u1ed9.</li> <li>Log ph\u1ea3i ch\u1ee9a: <code>actor_id</code>, <code>tenant_id</code>, <code>trace_id</code>, <code>action</code>, <code>timestamp</code>, <code>details</code>.</li> </ul>"},{"location":"services/notification-service/sub/design/#95-tracing-opentelemetry","title":"9.5. \ud83d\udd01 Tracing (OpenTelemetry)","text":"<p>T\u00edch h\u1ee3p OpenTelemetry \u0111\u1ec3 trace xuy\u00ean su\u1ed1t h\u00e0nh tr\u00ecnh notification:</p> Trace span Ghi nh\u1eadn Nh\u1eadn event timestamp nh\u1eadn, message size T\u00ecm template lookup time, cache hit/miss G\u1eedi email/SMS duration, result Log c\u1eadp nh\u1eadt DB write status <p>T\u1ea5t c\u1ea3 trace \u0111\u01b0\u1ee3c g\u1eafn v\u1edbi <code>trace_id</code> g\u1ed1c t\u1eeb s\u1ef1 ki\u1ec7n. D\u1eef li\u1ec7u g\u1eedi v\u1ec1 <code>OTEL Collector</code> \u2192 <code>Grafana Tempo</code> ho\u1eb7c <code>Jaeger</code>.</p>"},{"location":"services/notification-service/sub/design/#10-trien-khai-migration","title":"10. \ud83d\ude80 Tri\u1ec3n khai &amp; Migration","text":""},{"location":"services/notification-service/sub/design/#101-chien-luoc-trien-khai","title":"10.1. \ud83e\udded Chi\u1ebfn l\u01b0\u1ee3c tri\u1ec3n khai","text":"<p>Vi\u1ec7c tri\u1ec3n khai <code>notification-service/sub/</code> \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o Zero Downtime theo <code>ADR-014</code> v\u1edbi c\u00e1c \u0111\u1eb7c \u0111i\u1ec3m:</p> Y\u1ebfu t\u1ed1 Chi ti\u1ebft M\u00f4 h\u00ecnh deploy Container-based (Docker) Ph\u00e2n ph\u1ed1i Tri\u1ec3n khai theo tenant ho\u1eb7c c\u1ee5m tenant, c\u00f3 th\u1ec3 d\u00f9ng K8s namespace t\u00e1ch bi\u1ec7t Qu\u1ea3n l\u00fd phi\u00ean b\u1ea3n Image versioning theo tag <code>vas-notif-sub:v1.x.x</code> Tri\u1ec3n khai xanh/x\u00e1m H\u1ed7 tr\u1ee3 blue-green v\u00e0 rolling update Healthcheck Tu\u00e2n theo <code>/healthz</code>, <code>/readyz</code> cho liveness v\u00e0 readiness probe Qu\u1ea3n l\u00fd b\u00ed m\u1eadt Inject qua secret manager ho\u1eb7c volume mount (<code>ADR-003</code>)"},{"location":"services/notification-service/sub/design/#102-moi-truong-ranh-gioi-trien-khai-theo-adr-017","title":"10.2. \u2601\ufe0f M\u00f4i tr\u01b0\u1eddng &amp; ranh gi\u1edbi tri\u1ec3n khai (theo ADR-017)","text":"M\u00f4i tr\u01b0\u1eddng M\u1ee5c \u0111\u00edch Ranh gi\u1edbi <code>dev</code> Ph\u00e1t tri\u1ec3n C\u00f3 th\u1ec3 chia s\u1ebb DB + PubSub v\u1edbi team kh\u00e1c <code>staging</code> Ti\u1ec1n s\u1ea3n xu\u1ea5t M\u1ed7i tenant ch\u1ea1y instance \u0111\u1ed9c l\u1eadp <code>prod</code> V\u1eadn h\u00e0nh th\u1eadt M\u1ed7i tenant production c\u00f3 cluster ri\u00eang (ho\u1eb7c namespace ri\u00eang) <p>\ud83d\udd10 C\u1ea5u h\u00ecnh <code>ENVIRONMENT</code> s\u1ebd \u1ea3nh h\u01b0\u1edfng \u0111\u1ebfn behavior g\u1eedi th\u1eadt hay gi\u1ea3 (v\u00ed d\u1ee5: <code>smtp-sandbox</code> trong dev)</p>"},{"location":"services/notification-service/sub/design/#103-tu-ong-hoa-trien-khai-cicd","title":"10.3. \ud83d\ude80 T\u1ef1 \u0111\u1ed9ng h\u00f3a tri\u1ec3n khai (CI/CD)","text":"<p>Tu\u00e2n th\u1ee7 <code>ADR-001</code>:</p> B\u01b0\u1edbc C\u00f4ng c\u1ee5 Build Docker image <code>Dockerfile</code> chu\u1ea9n h\u00f3a Push l\u00ean registry GitHub Actions / GitLab CI Deploy staging Helm / ArgoCD Run post-deploy tests <code>pytest</code> ho\u1eb7c <code>dredd</code> (contract test) Notify k\u1ebft qu\u1ea3 Slack webhook / GitHub Status"},{"location":"services/notification-service/sub/design/#104-migration-du-lieu-schema-du-lieu","title":"10.4. \ud83d\udce5 Migration d\u1eef li\u1ec7u (schema &amp; d\u1eef li\u1ec7u)","text":"<p>Tu\u00e2n th\u1ee7 <code>ADR-023 \u2013 Schema Migration Strategy</code></p> B\u1ea3ng \u1ea3nh h\u01b0\u1edfng Chi ti\u1ebft <code>NotificationTemplate</code> D\u1eef li\u1ec7u m\u1eb7c \u0111\u1ecbnh cho t\u1eebng <code>event_code</code> c\u00f3 th\u1ec3 seed khi kh\u1edfi t\u1ea1o tenant <code>NotificationLog</code> Kh\u00f4ng migration, t\u1ea1o m\u1edbi t\u1eebng d\u00f2ng <code>NotificationChannelCfg</code> T\u00f9y tenant, c\u00f3 th\u1ec3 import t\u1eeb file c\u1ea5u h\u00ecnh YAML ho\u1eb7c JSON"},{"location":"services/notification-service/sub/design/#cong-cu-goi-y","title":"C\u00f4ng c\u1ee5 g\u1ee3i \u00fd","text":"<ul> <li>Qu\u1ea3n l\u00fd migration: <code>Alembic</code> ho\u1eb7c <code>Sqlx</code> (n\u1ebfu d\u00f9ng Python / Go)</li> <li>Ki\u1ec3m tra forward/backward compatibility: <code>schemachange</code> ho\u1eb7c <code>sqldiff</code></li> </ul>"},{"location":"services/notification-service/sub/design/#105-rollback-strategy","title":"10.5. \u26d1\ufe0f Rollback strategy","text":"Tr\u01b0\u1eddng h\u1ee3p l\u1ed7i H\u00e0nh \u0111\u1ed9ng rollback Service fail kh\u1edfi \u0111\u1ed9ng Rollback image v\u1ec1 phi\u00ean b\u1ea3n c\u0169 DB migration g\u00e2y l\u1ed7i Rollback b\u1eb1ng <code>downgrade</code> script Audit log m\u1ea5t k\u1ebft n\u1ed1i Chuy\u1ec3n sang log file t\u1ea1m th\u1eddi (buffered log) SMTP l\u1ed7i to\u00e0n c\u1ee5c B\u1eadt ch\u1ebf \u0111\u1ed9 <code>dry-run</code> t\u1ea1m th\u1eddi \u0111\u1ec3 kh\u00f4ng m\u1ea5t log"},{"location":"services/notification-service/sub/design/#106-checklist-truoc-production","title":"10.6. \ud83d\udccb Checklist tr\u01b0\u1edbc production","text":"M\u1ee5c X\u00e1c nh\u1eadn [ ] \u0110\u00e3 ki\u1ec3m tra healthcheck ho\u1ea1t \u0111\u1ed9ng \u2705 [ ] Metrics c\u00f3 hi\u1ec3n th\u1ecb tr\u00ean Grafana \u2705 [ ] Log g\u1eedi \u0111\u00fang audit format \u2705 [ ] Tenant c\u00f3 config ri\u00eang \u0111\u1ea7y \u0111\u1ee7 \u2705 [ ] Th\u1eed rollback kh\u00f4ng m\u1ea5t d\u1eef li\u1ec7u \u2705 [ ] Alert ho\u1ea1t \u0111\u1ed9ng \u0111\u00fang \u2705"},{"location":"services/notification-service/sub/design/#11-kien-truc-noi-bo","title":"11. \ud83e\udde9 Ki\u1ebfn tr\u00fac n\u1ed9i b\u1ed9","text":""},{"location":"services/notification-service/sub/design/#111-muc-tieu-phan-lop","title":"11.1. M\u1ee5c ti\u00eau ph\u00e2n l\u1edbp","text":"<p>H\u1ec7 th\u1ed1ng \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf theo h\u01b0\u1edbng module h\u00f3a r\u00f5 r\u00e0ng, t\u00e1ch bi\u1ec7t theo ch\u1ee9c n\u0103ng \u0111\u1ec3 d\u1ec5 d\u00e0ng m\u1edf r\u1ed9ng, ki\u1ec3m th\u1eed v\u00e0 b\u1ea3o tr\u00ec.</p> L\u1edbp Tr\u00e1ch nhi\u1ec7m <code>consumer</code> L\u1eafng nghe v\u00e0 x\u1eed l\u00fd s\u1ef1 ki\u1ec7n t\u1eeb Pub/Sub ho\u1eb7c message queue <code>processor</code> Th\u1ef1c thi nghi\u1ec7p v\u1ee5 g\u1eedi th\u00f4ng b\u00e1o: tra template, render, g\u1eedi, fallback <code>notifier</code> Adapter g\u1eedi th\u00f4ng b\u00e1o th\u1ef1c t\u1ebf (SMTP, SMS, Push...) <code>repository</code> Truy xu\u1ea5t &amp; ghi d\u1eef li\u1ec7u t\u1eeb/\u0111\u1ebfn Postgres <code>config</code> T\u1ea3i &amp; cache c\u1ea5u h\u00ecnh ri\u00eang cho t\u1eebng tenant <code>audit</code> G\u1eedi log ki\u1ec3m to\u00e1n (n\u1ebfu \u0111\u01b0\u1ee3c b\u1eadt) <code>api</code> Cung c\u1ea5p API n\u1ed9i b\u1ed9 cho vi\u1ec7c ki\u1ec3m tra, g\u1eedi th\u1eed, qu\u1ea3n tr\u1ecb template"},{"location":"services/notification-service/sub/design/#112-so-o-luong-xu-ly-noi-bo","title":"11.2. S\u01a1 \u0111\u1ed3 lu\u1ed3ng x\u1eed l\u00fd n\u1ed9i b\u1ed9","text":"<pre><code>flowchart TD\n    PubSub[Event Listener]\n    PubSub --&gt; Parser[Parse + Validate Event]\n    Parser --&gt; TemplateLookup[Lookup Template]\n    TemplateLookup --&gt; RenderEngine[Render Template]\n    RenderEngine --&gt; Notifier[Send Notification]\n    Notifier --&gt; Audit[Log Audit]\n    Notifier --&gt; LogWriter[Ghi NotificationLog]\n\n    subgraph Modules\n      TemplateLookup\n      RenderEngine\n      Notifier\n      Audit\n      LogWriter\n    end\n</code></pre>"},{"location":"services/notification-service/sub/design/#113-phan-tich-module-chinh","title":"11.3. Ph\u00e2n t\u00edch module ch\u00ednh","text":""},{"location":"services/notification-service/sub/design/#consumer","title":"\ud83e\udde9 <code>consumer/</code>","text":"<ul> <li>Nh\u1eadn s\u1ef1 ki\u1ec7n t\u1eeb Pub/Sub</li> <li>Parse &amp; validate schema (tu\u00e2n theo <code>ADR-030</code>)</li> <li>B\u1eaft \u0111\u1ea7u trace (<code>trace_id</code>)</li> <li>G\u1eedi v\u00e0o <code>processor</code></li> </ul>"},{"location":"services/notification-service/sub/design/#processor","title":"\ud83e\udde9 <code>processor/</code>","text":"<ul> <li>Truy c\u1eadp <code>tenant_id</code> \u0111\u1ec3 load c\u1ea5u h\u00ecnh (<code>config/</code>)</li> <li>G\u1ecdi <code>template_repository</code> \u0111\u1ec3 t\u00ecm template kh\u1edbp <code>event_code</code> + <code>channel</code></li> <li>Render n\u1ed9i dung</li> <li>G\u1ecdi <code>notifier/</code> \u0111\u1ec3 g\u1eedi \u0111i</li> <li>Ghi log + fallback n\u1ebfu th\u1ea5t b\u1ea1i</li> <li>G\u1eedi log audit n\u1ebfu b\u1eadt</li> </ul>"},{"location":"services/notification-service/sub/design/#notifier","title":"\ud83e\udde9 <code>notifier/</code>","text":"<ul> <li> <p>C\u00f3 c\u00e1c adapter theo k\u00eanh:</p> </li> <li> <p><code>notifier/email.py</code></p> </li> <li><code>notifier/sms.py</code></li> <li><code>notifier/push.py</code> (ch\u01b0a tri\u1ec3n khai)</li> <li>Giao di\u1ec7n th\u1ed1ng nh\u1ea5t: <code>send(recipient, content, config)</code></li> </ul>"},{"location":"services/notification-service/sub/design/#repository","title":"\ud83e\udde9 <code>repository/</code>","text":"<ul> <li>Truy c\u1eadp Postgres: b\u1ea3ng <code>NotificationLog</code>, <code>Template</code>, <code>ChannelCfg</code></li> <li>\u0110\u01b0\u1ee3c mock d\u1ec5 d\u00e0ng trong test</li> </ul>"},{"location":"services/notification-service/sub/design/#config","title":"\ud83e\udde9 <code>config/</code>","text":"<ul> <li>Load c\u1ea5u h\u00ecnh theo <code>tenant_id</code> t\u1eeb Secret Manager / mount path</li> <li>C\u00f3 c\u01a1 ch\u1ebf cache n\u1ed9i b\u1ed9 (TTL: 5 ph\u00fat)</li> <li>T\u1ef1 invalid cache khi c\u00f3 s\u1ef1 ki\u1ec7n <code>config.updated</code></li> </ul>"},{"location":"services/notification-service/sub/design/#audit","title":"\ud83e\udde9 <code>audit/</code>","text":"<ul> <li>T\u1ea1o c\u1ea5u tr\u00fac audit log (tu\u00e2n theo <code>ADR-008</code>)</li> <li>G\u1eedi async sang <code>audit-logging-service</code></li> </ul>"},{"location":"services/notification-service/sub/design/#api","title":"\ud83e\udde9 <code>api/</code>","text":"<ul> <li> <p>Expose REST API n\u1ed9i b\u1ed9:</p> </li> <li> <p><code>GET /notifications/logs</code></p> </li> <li><code>POST /notifications/test</code></li> <li><code>GET /notifications/templates</code></li> </ul>"},{"location":"services/notification-service/sub/design/#114-logging-tracing-luong-noi-bo","title":"11.4. Logging &amp; Tracing lu\u1ed3ng n\u1ed9i b\u1ed9","text":"<ul> <li>M\u1ed7i b\u01b0\u1edbc trong lu\u1ed3ng x\u1eed l\u00fd \u0111\u1ec1u t\u1ea1o 1 span n\u1ebfu d\u00f9ng OpenTelemetry</li> <li> <p>To\u00e0n b\u1ed9 log theo chu\u1ea9n JSON v\u00e0 \u0111\u00ednh k\u00e8m:</p> </li> <li> <p><code>tenant_id</code></p> </li> <li><code>event_id</code></li> <li><code>trace_id</code></li> <li><code>template_id</code></li> <li><code>channel</code></li> </ul>"},{"location":"services/notification-service/sub/design/#115-kha-nang-mo-rong-plugin","title":"11.5. Kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng &amp; plugin","text":"<p>H\u1ec7 th\u1ed1ng c\u00f3 th\u1ec3 d\u1ec5 d\u00e0ng m\u1edf r\u1ed9ng th\u00eam k\u00eanh g\u1eedi m\u1edbi:</p> K\u00eanh m\u1edbi C\u00e1ch m\u1edf r\u1ed9ng Zalo Th\u00eam <code>notifier/zalo.py</code> v\u1edbi h\u00e0m <code>send(...)</code> App Notification T\u00edch h\u1ee3p Firebase, d\u00f9ng chung pipeline T\u01b0\u01a1ng t\u00e1c voice K\u1ebft n\u1ed1i Twilio ho\u1eb7c WebRTC SDK"},{"location":"services/notification-service/sub/design/#12-tai-lieu-lien-quan","title":"12. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Interface Contract</li> <li>Data Model</li> <li>OpenAPI Spec</li> <li>ADR-007 \u2013 RBAC Strategy</li> <li>ADR-008 \u2013 Audit Logging</li> <li>ADR-030 \u2013 Event Schema Governance</li> <li>Change Request 04 \u2013 Tenant Isolation</li> <li>README.md \u2013 System Overview</li> <li>RBAC Deep Dive</li> <li>System Diagram</li> </ul>"},{"location":"services/notification-service/sub/interface-contract/","title":"\ud83d\udcd8 Notification Sub Service \u2013 Interface Contract","text":"<p>Service n\u00e0y cung c\u1ea5p c\u00e1c API ph\u1ee5c v\u1ee5 vi\u1ec7c: - Tra c\u1ee9u danh s\u00e1ch notification \u0111\u00e3 g\u1eedi theo nhi\u1ec1u ti\u00eau ch\u00ed (tenant, tr\u1ea1ng th\u00e1i, channel\u2026) - G\u1eedi th\u1eed m\u1ed9t template notification (cho m\u1ee5c \u0111\u00edch ki\u1ec3m tra, sandbox) - Tra c\u1ee9u danh s\u00e1ch template hi\u1ec7n h\u00e0nh (per tenant)</p>"},{"location":"services/notification-service/sub/interface-contract/#1-pham-vi-scope","title":"1. Ph\u1ea1m vi (Scope)","text":"<p>Notification Sub Service ch\u1ecbu tr\u00e1ch nhi\u1ec7m x\u1eed l\u00fd c\u00e1c h\u00e0nh \u0111\u1ed9ng sau:</p> <p>\u2705 Trong ph\u1ea1m vi: - Th\u1ef1c thi vi\u1ec7c g\u1eedi notification th\u1ef1c t\u1ebf d\u1ef1a tr\u00ean s\u1ef1 ki\u1ec7n <code>notification.triggered.v1</code> nh\u1eadn t\u1eeb Pub/Sub - Ghi nh\u1eadn log g\u1eedi (th\u00e0nh c\u00f4ng/th\u1ea5t b\u1ea1i/fallback) cho m\u1ed7i tenant - Cung c\u1ea5p API truy v\u1ea5n log \u0111\u00e3 g\u1eedi \u0111\u1ec3 ph\u1ee5c v\u1ee5 giao di\u1ec7n qu\u1ea3n tr\u1ecb - Cho ph\u00e9p g\u1eedi th\u1eed (test) m\u1ed9t template t\u1edbi m\u1ed9t \u0111\u1ecba ch\u1ec9 c\u1ee5 th\u1ec3 nh\u1eb1m ki\u1ec3m tra c\u1ea5u h\u00ecnh - Cho ph\u00e9p xem danh s\u00e1ch template \u0111ang \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng (metadata) - Ghi log ki\u1ec3m to\u00e1n (audit) cho t\u1ea5t c\u1ea3 c\u00e1c h\u00e0nh \u0111\u1ed9ng g\u1eedi, test, thay \u0111\u1ed5i config</p> <p>\ud83d\udd12 T\u1ea5t c\u1ea3 c\u00e1c API c\u00f3 r\u00e0ng bu\u1ed9c <code>tenant_id</code> (multi-tenant isolation theo CR-04 v\u00e0 <code>ADR-007</code>).</p> <p>\ud83d\udd0e Danh s\u00e1ch endpoint thu\u1ed9c ph\u1ea1m vi contract:</p> Method Path M\u00f4 t\u1ea3 ch\u1ee9c n\u0103ng <code>GET</code> <code>/notifications/logs</code> Truy xu\u1ea5t log notification \u0111\u00e3 g\u1eedi <code>POST</code> <code>/notifications/test</code> G\u1eedi th\u1eed m\u1ed9t notification (dry-run) <code>GET</code> <code>/notifications/templates</code> Truy xu\u1ea5t danh s\u00e1ch template (metadata) <p>\u274c Ngo\u00e0i ph\u1ea1m vi: - Kh\u00f4ng nh\u1eadn request g\u1eedi th\u1eadt t\u1eeb client (frontend) - Kh\u00f4ng qu\u1ea3n l\u00fd ng\u01b0\u1eddi nh\u1eadn, tr\u1ea1ng th\u00e1i \u0111\u1ecdc/unread - Kh\u00f4ng t\u1ea1o/s\u1eeda template qua API (template \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd ngo\u00e0i service n\u00e0y) - Kh\u00f4ng qu\u1ea3n l\u00fd opt-in/opt-out c\u1ee7a ng\u01b0\u1eddi d\u00f9ng (handled t\u1ea1i User Profile ho\u1eb7c Master) - Kh\u00f4ng ph\u00e1t sinh s\u1ef1 ki\u1ec7n outbound ra Pub/Sub</p> <p>\ud83e\udded Nguy\u00ean t\u1eafc chung (General Principles): - T\u1ea5t c\u1ea3 API y\u00eau c\u1ea7u header <code>Authorization: Bearer &lt;JWT&gt;</code> (theo ADR-006). - API tu\u00e2n th\u1ee7 c\u1ea5u tr\u00fac response chu\u1ea9n theo ADR-012. - M\u1ecdi l\u1ed7i \u0111\u1ec1u tu\u00e2n th\u1ee7 ADR-011 v\u00e0 Error Codes - M\u1ed9t s\u1ed1 API y\u00eau c\u1ea7u <code>x-condition: tenant_id = {{X-Tenant-ID}}</code>.</p>"},{"location":"services/notification-service/sub/interface-contract/#2-api-notificationslogs","title":"2. \ud83d\udccc API: <code>/notifications/logs</code>","text":"<p>API d\u00f9ng \u0111\u1ec3 li\u1ec7t k\u00ea c\u00e1c notification \u0111\u00e3 g\u1eedi th\u00e0nh c\u00f4ng ho\u1eb7c th\u1ea5t b\u1ea1i c\u1ee7a tenant hi\u1ec7n t\u1ea1i. Cho ph\u00e9p l\u1ecdc theo tr\u1ea1ng th\u00e1i, k\u00eanh g\u1eedi, s\u1ef1 ki\u1ec7n ho\u1eb7c ng\u01b0\u1eddi nh\u1eadn. H\u1eefu \u00edch cho m\u1ee5c \u0111\u00edch gi\u00e1m s\u00e1t, h\u1ed7 tr\u1ee3 ng\u01b0\u1eddi d\u00f9ng v\u00e0 truy v\u1ebft s\u1ef1 c\u1ed1.</p>"},{"location":"services/notification-service/sub/interface-contract/#request","title":"\ud83d\udce5 Request","text":"<pre><code>GET /notifications/logs?page=1&amp;page_size=20&amp;status=sent&amp;channel=email\nAuthorization: Bearer &lt;JWT&gt;\nX-Tenant-ID: tenant-vas-001\n</code></pre> <p>Query Parameters (t\u00f9y ch\u1ecdn):</p> T\u00ean Ki\u1ec3u M\u1eb7c \u0111\u1ecbnh M\u00f4 t\u1ea3 <code>page</code> integer 1 Trang th\u1ee9 m\u1ea5y <code>page_size</code> integer 20 S\u1ed1 k\u1ebft qu\u1ea3 m\u1ed7i trang (max: 100) <code>status</code> string <code>sent</code>, <code>failed</code>, <code>queued</code>, <code>fallback</code> <code>channel</code> string <code>email</code>, <code>sms</code>, <code>push</code> <code>event_code</code> string M\u00e3 s\u1ef1 ki\u1ec7n (<code>user.welcome</code>, v.v.) <code>recipient</code> string Email/s\u1ed1 \u0111i\u1ec7n tho\u1ea1i ng\u01b0\u1eddi nh\u1eadn"},{"location":"services/notification-service/sub/interface-contract/#response","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"meta\": {\n    \"page\": 1,\n    \"page_size\": 20,\n    \"total_pages\": 3,\n    \"total_items\": 55\n  },\n  \"data\": [\n    {\n      \"id\": \"c3017c2b-5ef0-44a9-9274-06d9ab3f6cf7\",\n      \"event_code\": \"user.welcome\",\n      \"channel\": \"email\",\n      \"status\": \"sent\",\n      \"recipient\": \"user@example.edu.vn\",\n      \"template_id\": \"tmpl-welcome-01\",\n      \"sent_at\": \"2025-06-13T09:45:00Z\",\n      \"retry\": false,\n      \"trace_id\": \"x-trace-123abc\"\n    }\n  ]\n}\n</code></pre> <p>Response tu\u00e2n theo chu\u1ea9n <code>Envelope</code> \u0111\u1ecbnh ngh\u0129a t\u1ea1i <code>ADR-012</code>.</p>"},{"location":"services/notification-service/sub/interface-contract/#phan-quyen-ieu-kien","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"Thu\u1ed9c t\u00ednh Gi\u00e1 tr\u1ecb <code>x-required-permission</code> <code>notif.read.log</code> <code>x-condition</code> <code>tenant_id = {{X-Tenant-ID}}</code> <p>JWT ph\u1ea3i ch\u1ee9a <code>tenant_id</code>, <code>sub</code>, v\u00e0 <code>permissions</code> h\u1ee3p l\u1ec7.</p>"},{"location":"services/notification-service/sub/interface-contract/#su-kien-phat-ra","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<p>Kh\u00f4ng ph\u00e1t sinh s\u1ef1 ki\u1ec7n. API n\u00e0y ch\u1ec9 ph\u1ee5c v\u1ee5 m\u1ee5c \u0111\u00edch read-only v\u00e0 truy v\u1ebft log.</p>"},{"location":"services/notification-service/sub/interface-contract/#ma-loi-co-the-tra-ve","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"HTTP <code>error_code</code> M\u00f4 t\u1ea3 401 <code>auth.unauthorized</code> Thi\u1ebfu ho\u1eb7c sai JWT token 403 <code>auth.permission_denied</code> Kh\u00f4ng c\u00f3 quy\u1ec1n <code>notif.read.log</code> 400 <code>common.validation_failed</code> Tham s\u1ed1 query kh\u00f4ng h\u1ee3p l\u1ec7 429 <code>common.rate_limited</code> G\u1eedi qu\u00e1 nhanh, b\u1ecb gi\u1edbi h\u1ea1n truy c\u1eadp 500 <code>common.internal_server_error</code> L\u1ed7i n\u1ed9i b\u1ed9 kh\u00f4ng x\u00e1c \u0111\u1ecbnh <p>Danh s\u00e1ch m\u00e3 l\u1ed7i tu\u00e2n th\u1ee7 \u0111\u1ecbnh ngh\u0129a trong Error Codes</p>"},{"location":"services/notification-service/sub/interface-contract/#goi-y-kiem-thu","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"T\u00ecnh hu\u1ed1ng K\u1ebft qu\u1ea3 mong \u0111\u1ee3i Kh\u00f4ng c\u00f3 <code>Authorization</code> header 401 + <code>auth.unauthorized</code> Token kh\u00f4ng c\u00f3 quy\u1ec1n <code>notif.read.log</code> 403 + <code>auth.permission_denied</code> <code>page = -1</code> ho\u1eb7c <code>page_size = 0</code> 400 + <code>common.validation_failed</code> Token h\u1ee3p l\u1ec7, c\u00f3 quy\u1ec1n 200, tr\u1ea3 \u0111\u00fang danh s\u00e1ch theo filter <code>recipient</code> kh\u00f4ng t\u1ed3n t\u1ea1i 200, <code>data=[]</code>, kh\u00f4ng c\u00f3 l\u1ed7i Truy v\u1ea5n qu\u00e1 nhi\u1ec1u l\u1ea7n 429 + <code>common.rate_limited</code> <p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 ph\u1ea7n m\u00f4 t\u1ea3 chi ti\u1ebft chu\u1ea9n 5\u2605 cho API <code>POST /notifications/test</code>, \u0111\u1ea3m b\u1ea3o \u0111\u1ed3ng b\u1ed9 v\u1edbi <code>design.md</code>, <code>error-codes.md</code>, <code>adr-012</code>, <code>adr-011</code>, v\u00e0 h\u1ed7 tr\u1ee3 ki\u1ec3m th\u1eed c\u1ea5u h\u00ecnh g\u1eedi th\u00f4ng b\u00e1o trong m\u00f4i tr\u01b0\u1eddng multi-tenant:</p>"},{"location":"services/notification-service/sub/interface-contract/#3-api-notificationstest","title":"3. \ud83d\udccc API: <code>/notifications/test</code>","text":"<p>API d\u00f9ng \u0111\u1ec3 g\u1eedi th\u1eed m\u1ed9t notification d\u1ef1a tr\u00ean template hi\u1ec7n c\u00f3, d\u00f9ng cho m\u1ee5c \u0111\u00edch ki\u1ec3m tra k\u00eanh g\u1eedi (email/SMS) v\u00e0 n\u1ed9i dung hi\u1ec3n th\u1ecb. Ch\u1ec9 g\u1eedi \u0111\u1ebfn m\u1ed9t <code>recipient</code> duy nh\u1ea5t, kh\u00f4ng log l\u1ea1i trong h\u1ec7 th\u1ed1ng ch\u00ednh, kh\u00f4ng \u1ea3nh h\u01b0\u1edfng d\u1eef li\u1ec7u th\u1eadt. Th\u01b0\u1eddng \u0111\u01b0\u1ee3c d\u00f9ng trong trang c\u1ea5u h\u00ecnh k\u00eanh g\u1eedi ho\u1eb7c giao di\u1ec7n test template.</p>"},{"location":"services/notification-service/sub/interface-contract/#request_1","title":"\ud83d\udce5 Request","text":"<pre><code>POST /notifications/test\nAuthorization: Bearer &lt;JWT&gt;\nContent-Type: application/json\nX-Tenant-ID: tenant-vas-001\n</code></pre> <p>Payload:</p> <pre><code>{\n  \"channel\": \"email\",\n  \"recipient\": \"test@example.com\",\n  \"event_code\": \"user.welcome\",\n  \"params\": {\n    \"full_name\": \"L\u00ea Minh\",\n    \"class\": \"5A\",\n    \"school\": \"Tr\u01b0\u1eddng Vi\u1ec7t Anh\"\n  }\n}\n</code></pre> <p>M\u00f4 t\u1ea3 field:</p> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>channel</code> string \u2705 <code>email</code>, <code>sms</code>, <code>push</code> <code>recipient</code> string \u2705 \u0110\u1ecba ch\u1ec9 email/s\u1ed1 \u0111i\u1ec7n tho\u1ea1i nh\u1eadn test <code>event_code</code> string \u2705 M\u00e3 s\u1ef1 ki\u1ec7n (template) \u0111\u1ec3 g\u1eedi th\u1eed <code>params</code> object \u26d4 D\u1eef li\u1ec7u s\u1ebd \u0111\u01b0\u1ee3c render v\u00e0o template"},{"location":"services/notification-service/sub/interface-contract/#response_1","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"meta\": {\n    \"trace_id\": \"trace-x123\",\n    \"status\": \"sent\"\n  },\n  \"data\": {\n    \"channel\": \"email\",\n    \"recipient\": \"test@example.com\",\n    \"event_code\": \"user.welcome\",\n    \"template_id\": \"tmpl-welcome-01\",\n    \"preview\": \"&lt;p&gt;Xin ch\u00e0o L\u00ea Minh, ch\u00e0o m\u1eebng b\u1ea1n \u0111\u1ebfn l\u1edbp 5A!&lt;/p&gt;\"\n  }\n}\n</code></pre> <p>Tr\u01b0\u1eddng <code>preview</code> ch\u1ee9a n\u1ed9i dung \u0111\u00e3 \u0111\u01b0\u1ee3c render \u2013 h\u1eefu \u00edch \u0111\u1ec3 ki\u1ec3m th\u1eed c\u1ea5u tr\u00fac template.</p>"},{"location":"services/notification-service/sub/interface-contract/#phan-quyen-ieu-kien_1","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"Thu\u1ed9c t\u00ednh Gi\u00e1 tr\u1ecb <code>x-required-permission</code> <code>notif.send.test</code> <code>x-condition</code> <code>tenant_id = {{X-Tenant-ID}}</code>"},{"location":"services/notification-service/sub/interface-contract/#su-kien-phat-ra_1","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"T\u00ean s\u1ef1 ki\u1ec7n M\u00f4 t\u1ea3 <code>notification.test_sent</code> Log ki\u1ec3m to\u00e1n cho vi\u1ec7c test g\u1eedi notification <p>S\u1ef1 ki\u1ec7n s\u1ebd \u0111\u01b0\u1ee3c g\u1eedi async t\u1edbi <code>audit-logging-service</code>, kh\u00f4ng \u0111\u01b0a v\u00e0o lu\u1ed3ng g\u1eedi th\u1eadt.</p>"},{"location":"services/notification-service/sub/interface-contract/#ma-loi-co-the-tra-ve_1","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"HTTP <code>error_code</code> M\u00f4 t\u1ea3 401 <code>auth.unauthorized</code> Thi\u1ebfu ho\u1eb7c sai JWT token 403 <code>auth.permission_denied</code> Kh\u00f4ng c\u00f3 quy\u1ec1n <code>notif.send.test</code> 400 <code>notif.template_not_found</code> Kh\u00f4ng t\u00ecm th\u1ea5y template t\u01b0\u01a1ng \u1ee9ng <code>event_code</code> 400 <code>notif.invalid_recipient</code> Sai \u0111\u1ecbnh d\u1ea1ng email ho\u1eb7c s\u1ed1 \u0111i\u1ec7n tho\u1ea1i 400 <code>common.validation_failed</code> Payload kh\u00f4ng h\u1ee3p l\u1ec7 (thi\u1ebfu field) 429 <code>common.rate_limited</code> G\u1eedi th\u1eed qu\u00e1 nhanh trong th\u1eddi gian ng\u1eafn 500 <code>common.internal_server_error</code> L\u1ed7i h\u1ec7 th\u1ed1ng khi g\u1eedi th\u1eed notification <p>M\u1ecdi m\u00e3 l\u1ed7i tu\u00e2n th\u1ee7 \u0111\u1ecbnh ngh\u0129a trong Error Codes</p>"},{"location":"services/notification-service/sub/interface-contract/#goi-y-kiem-thu_1","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"T\u00ecnh hu\u1ed1ng K\u1ebft qu\u1ea3 mong \u0111\u1ee3i Kh\u00f4ng c\u00f3 token <code>401 unauthorized</code> Token kh\u00f4ng c\u00f3 quy\u1ec1n <code>403 permission_denied</code> Sai <code>event_code</code> <code>400 notif.template_not_found</code> Sai <code>recipient</code> <code>400 notif.invalid_recipient</code> Thi\u1ebfu <code>channel</code> <code>400 common.validation_failed</code> G\u1eedi th\u1eed th\u00e0nh c\u00f4ng <code>200</code>, status = <code>sent</code>, c\u00f3 <code>preview</code> HTML G\u1eedi qu\u00e1 nhanh <code>429 common.rate_limited</code> G\u1eedi b\u1eb1ng token tenant kh\u00e1c <code>403 permission_denied</code>"},{"location":"services/notification-service/sub/interface-contract/#4-api-notificationstemplates","title":"4. \ud83d\udccc API: <code>/notifications/templates</code>","text":"<p>API d\u00f9ng \u0111\u1ec3 li\u1ec7t k\u00ea danh s\u00e1ch metadata c\u1ee7a c\u00e1c template notification \u0111ang \u0111\u01b0\u1ee3c \u00e1p d\u1ee5ng cho <code>tenant</code> hi\u1ec7n t\u1ea1i. Kh\u00f4ng tr\u1ea3 n\u1ed9i dung \u0111\u1ea7y \u0111\u1ee7 (body), ch\u1ec9 metadata c\u1ea7n thi\u1ebft ph\u1ee5c v\u1ee5 giao di\u1ec7n ch\u1ecdn template.</p>"},{"location":"services/notification-service/sub/interface-contract/#request_2","title":"\ud83d\udce5 Request","text":"<pre><code>GET /notifications/templates\nAuthorization: Bearer &lt;JWT&gt;\nX-Tenant-ID: tenant-vas-001\n</code></pre> <p>Query Parameters (tu\u1ef3 ch\u1ecdn):</p> T\u00ean Ki\u1ec3u M\u00f4 t\u1ea3 <code>channel</code> string L\u1ecdc theo k\u00eanh (<code>email</code>, <code>sms</code>) <code>active</code> boolean L\u1ecdc theo tr\u1ea1ng th\u00e1i \u0111ang b\u1eadt"},{"location":"services/notification-service/sub/interface-contract/#response_2","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"meta\": {\n    \"total_items\": 2\n  },\n  \"data\": [\n    {\n      \"template_id\": \"tmpl-welcome-01\",\n      \"event_code\": \"user.welcome\",\n      \"channel\": \"email\",\n      \"language\": \"vi\",\n      \"version\": 3,\n      \"active\": true,\n      \"updated_at\": \"2025-06-01T08:00:00Z\"\n    },\n    {\n      \"template_id\": \"tmpl-resetpass-01\",\n      \"event_code\": \"user.reset_password\",\n      \"channel\": \"email\",\n      \"language\": \"en\",\n      \"version\": 1,\n      \"active\": true,\n      \"updated_at\": \"2025-05-10T14:32:12Z\"\n    }\n  ]\n}\n</code></pre> <p>Response s\u1eed d\u1ee5ng <code>Envelope</code> theo <code>ADR-012</code>.</p>"},{"location":"services/notification-service/sub/interface-contract/#phan-quyen-ieu-kien_2","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"Thu\u1ed9c t\u00ednh Gi\u00e1 tr\u1ecb <code>x-required-permission</code> <code>notif.read.template</code> <code>x-condition</code> <code>tenant_id = {{X-Tenant-ID}}</code>"},{"location":"services/notification-service/sub/interface-contract/#su-kien-phat-ra_2","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<p>Kh\u00f4ng ph\u00e1t sinh s\u1ef1 ki\u1ec7n. \u0110\u00e2y l\u00e0 API d\u1ea1ng read-only, kh\u00f4ng c\u00f3 side effect.</p>"},{"location":"services/notification-service/sub/interface-contract/#ma-loi-co-the-tra-ve_2","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"HTTP <code>error_code</code> M\u00f4 t\u1ea3 401 <code>auth.unauthorized</code> Thi\u1ebfu ho\u1eb7c sai JWT token 403 <code>auth.permission_denied</code> Kh\u00f4ng c\u00f3 quy\u1ec1n <code>notif.read.template</code> 400 <code>common.validation_failed</code> Tham s\u1ed1 query kh\u00f4ng h\u1ee3p l\u1ec7 429 <code>common.rate_limited</code> Truy c\u1eadp qu\u00e1 nhanh, b\u1ecb gi\u1edbi h\u1ea1n 500 <code>common.internal_server_error</code> L\u1ed7i kh\u00f4ng x\u00e1c \u0111\u1ecbnh t\u1eeb h\u1ec7 th\u1ed1ng <p>T\u1ea5t c\u1ea3 m\u00e3 l\u1ed7i tu\u00e2n th\u1ee7 Error Codes</p>"},{"location":"services/notification-service/sub/interface-contract/#goi-y-kiem-thu_2","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"T\u00ecnh hu\u1ed1ng K\u1ebft qu\u1ea3 mong \u0111\u1ee3i Token kh\u00f4ng h\u1ee3p l\u1ec7 <code>401 unauthorized</code> Thi\u1ebfu quy\u1ec1n <code>notif.read.template</code> <code>403 permission_denied</code> G\u1ecdi API v\u1edbi token h\u1ee3p l\u1ec7 200, danh s\u00e1ch metadata template \u0111\u00fang L\u1ecdc theo <code>channel=email</code> Ch\u1ec9 tr\u1ea3 c\u00e1c template email L\u1ecdc theo <code>active=false</code> Tr\u1ea3 c\u00e1c template kh\u00f4ng c\u00f2n d\u00f9ng Kh\u00f4ng c\u00f3 template n\u00e0o <code>data=[]</code>, kh\u00f4ng l\u1ed7i"},{"location":"services/notification-service/sub/interface-contract/#phu-luc-bang-permission-code","title":"\ud83d\udccc Ph\u1ee5 l\u1ee5c: B\u1ea3ng Permission Code","text":"<p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 b\u1ea3ng ph\u00e2n quy\u1ec1n (RBAC) \u00e1p d\u1ee5ng cho <code>notification-service/sub/</code>. M\u1ed7i permission x\u00e1c \u0111\u1ecbnh r\u00f5 h\u00e0nh \u0111\u1ed9ng cho m\u1ed9t lo\u1ea1i t\u00e0i nguy\u00ean v\u00e0 ph\u1ea1m vi (scope). Permission \u0111\u01b0\u1ee3c ki\u1ec3m tra d\u1ef1a tr\u00ean JWT claim (<code>permissions</code>) k\u1ebft h\u1ee3p v\u1edbi \u0111i\u1ec1u ki\u1ec7n <code>tenant_id</code>.</p> <code>permission_code</code> M\u00f4 t\u1ea3 quy\u1ec1n \u00c1p d\u1ee5ng cho API <code>resource</code> <code>scope</code> <code>notif.read.log</code> Truy v\u1ea5n log notification \u0111\u00e3 g\u1eedi <code>GET /notifications/logs</code> <code>NotificationLog</code> <code>read</code> <code>notif.send.test</code> G\u1eedi th\u1eed notification b\u1eb1ng template <code>POST /notifications/test</code> <code>NotificationSendTest</code> <code>write</code> <code>notif.read.template</code> Truy v\u1ea5n metadata template c\u1ee7a tenant <code>GET /notifications/templates</code> <code>NotificationTemplate</code> <code>read</code> <p>\u2705 T\u1ea5t c\u1ea3 c\u00e1c permission \u0111\u1ec1u \u0111\u01b0\u1ee3c ki\u1ec3m tra c\u00f9ng <code>x-condition: tenant_id = {{X-Tenant-ID}}</code> \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o isolation gi\u1eefa c\u00e1c tenant.</p> <p>\ud83d\udd12 Best Practice: - C\u00e1c role nh\u01b0 <code>notification_admin</code>, <code>tenant_config_editor</code> c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c g\u00e1n nh\u1eefng permission n\u00e0y. - Kh\u00f4ng n\u00ean g\u00e1n tr\u1ef1c ti\u1ebfp cho end-user frontend, ch\u1ec9 \u00e1p d\u1ee5ng cho Admin Webapp ho\u1eb7c h\u1ec7 th\u1ed1ng li\u00ean k\u1ebft.</p> <p>\ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan:</p> <ul> <li>Data Model</li> <li>OpenAPI Spec</li> <li>Design</li> <li>ADR-012 \u2013 Response Structure</li> <li>ADR-011 \u2013 Error Format</li> <li>Error Codes</li> </ul>"},{"location":"services/reporting-service/data-model/","title":"\ud83d\uddc3\ufe0f Reporting Service - Data Model","text":""},{"location":"services/reporting-service/data-model/#1-gioi-thieu","title":"1. Gi\u1edbi thi\u1ec7u","text":"<p>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 chi ti\u1ebft m\u00f4 h\u00ecnh d\u1eef li\u1ec7u c\u1ee7a Reporting Service. Service n\u00e0y l\u00e0 m\u1ed9t th\u00e0nh ph\u1ea7n c\u1ed1t l\u00f5i trong h\u1ec7 th\u1ed1ng <code>dx-vas</code>, ho\u1ea1t \u0111\u1ed9ng theo ki\u1ebfn tr\u00fac multi-tenant, ph\u1ee5c v\u1ee5 nhu c\u1ea7u b\u00e1o c\u00e1o v\u00e0 ph\u00e2n t\u00edch h\u1ec7 th\u1ed1ng c\u1ee7a c\u1ea3 c\u1ea5p Superadmin l\u1eabn t\u1eebng tenant ri\u00eang bi\u1ec7t.</p> <p>Reporting Service ch\u1ecbu tr\u00e1ch nhi\u1ec7m qu\u1ea3n l\u00fd c\u00e1c lo\u1ea1i d\u1eef li\u1ec7u ch\u00ednh sau: -   C\u00e1c c\u1ea5u h\u00ecnh m\u1eabu b\u00e1o c\u00e1o (<code>report_templates</code>) -   L\u1ecbch s\u1eed truy v\u1ea5n v\u00e0 k\u1ebft qu\u1ea3 b\u00e1o c\u00e1o (<code>report_query_logs</code>) -   C\u1ea5u h\u00ecnh b\u00e1o c\u00e1o \u0111\u00e3 l\u01b0u c\u1ee7a ng\u01b0\u1eddi d\u00f9ng (<code>saved_report_configs</code>) -   C\u1ea5u h\u00ecnh hi\u1ec3n th\u1ecb dashboard (<code>saved_dashboard_layouts</code>)</p> <p>M\u00f4 h\u00ecnh d\u1eef li\u1ec7u n\u00e0y l\u00e0 c\u01a1 s\u1edf cho vi\u1ec7c ph\u00e1t tri\u1ec3n backend, \u0111\u1ecbnh ngh\u0129a API, th\u1ef1c hi\u1ec7n schema migration, \u0111\u1ea3m b\u1ea3o t\u00ednh nh\u1ea5t qu\u00e1n d\u1eef li\u1ec7u, v\u00e0 \u0111\u1ed3ng th\u1eddi ph\u1ee5c v\u1ee5 cho vi\u1ec7c truy v\u1ea5n t\u1edbi h\u1ec7 th\u1ed1ng Data Warehouse nh\u01b0 BigQuery.</p>"},{"location":"services/reporting-service/data-model/#2-pham-vi-du-lieu-quan-ly-scope","title":"2. Ph\u1ea1m vi D\u1eef li\u1ec7u Qu\u1ea3n l\u00fd (Scope)","text":"<p>Reporting Service bao g\u1ed3m vi\u1ec7c qu\u1ea3n l\u00fd: -   Danh s\u00e1ch c\u00e1c m\u1eabu b\u00e1o c\u00e1o \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a s\u1eb5n (<code>report_templates</code>) -   C\u00e1c truy v\u1ea5n \u0111\u01b0\u1ee3c th\u1ef1c thi d\u1ef1a tr\u00ean c\u00e1c template (<code>report_query_logs</code>) -   C\u1ea5u h\u00ecnh b\u00e1o c\u00e1o \u0111\u01b0\u1ee3c ng\u01b0\u1eddi d\u00f9ng l\u01b0u l\u1ea1i (<code>saved_report_configs</code>) -   C\u1ea5u h\u00ecnh dashboard c\u1ee7a ng\u01b0\u1eddi d\u00f9ng (<code>saved_dashboard_layouts</code>)</p>"},{"location":"services/reporting-service/data-model/#3-ngoai-pham-vi-out-of-scope","title":"3. Ngo\u00e0i Ph\u1ea1m Vi (Out of Scope)","text":"<p>Reporting Service kh\u00f4ng ch\u1ecbu tr\u00e1ch nhi\u1ec7m qu\u1ea3n l\u00fd: -   \u274c D\u1eef li\u1ec7u th\u00f4 (raw data) t\u1eeb c\u00e1c h\u1ec7 th\u1ed1ng ngu\u1ed3n \u2013 \u0111\u00e3 \u0111\u01b0\u1ee3c ETL \u0111\u01b0a v\u00e0o Data Warehouse. -   \u274c Truy c\u1eadp tr\u1ef1c ti\u1ebfp v\u00e0o c\u00e1c table nghi\u1ec7p v\u1ee5 c\u1ee5 th\u1ec3 c\u1ee7a CRM/SIS/LMS \u2013 \u0111\u01b0\u1ee3c truy v\u1ea5n gi\u00e1n ti\u1ebfp qua BigQuery. -   \u274c Qu\u1ea3n l\u00fd quy\u1ec1n truy c\u1eadp ng\u01b0\u1eddi d\u00f9ng \u2013 th\u1ef1c hi\u1ec7n th\u00f4ng qua API Gateway v\u00e0 RBAC Service.</p>"},{"location":"services/reporting-service/data-model/#4-muc-tieu-cua-tai-lieu-mo-hinh-du-lieu","title":"4. M\u1ee5c ti\u00eau c\u1ee7a T\u00e0i li\u1ec7u M\u00f4 h\u00ecnh D\u1eef li\u1ec7u","text":"<ul> <li>Tr\u00ecnh b\u00e0y c\u1ea5u tr\u00fac c\u00e1c b\u1ea3ng d\u1eef li\u1ec7u c\u1ed1t l\u00f5i c\u1ee7a Reporting Service.</li> <li>M\u00f4 t\u1ea3 c\u00e1c r\u00e0ng bu\u1ed9c d\u1eef li\u1ec7u (constraints), kh\u00f3a ch\u00ednh/ngo\u1ea1i, ch\u1ec9 m\u1ee5c (indexes).</li> <li>H\u1ed7 tr\u1ee3 cho qu\u00e1 tr\u00ecnh ph\u00e1t tri\u1ec3n backend, vi\u1ebft \u0111\u1eb7c t\u1ea3 OpenAPI, th\u1ef1c hi\u1ec7n schema migration, ki\u1ec3m th\u1eed v\u00e0 b\u1ea3o tr\u00ec service.</li> <li>L\u00e0m n\u1ec1n t\u1ea3ng \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o t\u00ednh nh\u1ea5t qu\u00e1n schema v\u1edbi c\u00e1c t\u00e0i li\u1ec7u li\u00ean quan nh\u01b0 <code>design.md</code>, <code>interface-contract.md</code>, <code>openapi.yaml</code>, v\u00e0 c\u00e1c ADRs nh\u01b0 [ADR-028 Reporting Architecture], [ADR-029 Report Template Schema], v\u00e0 [ADR-030 Event Schema Governance].</li> </ul>"},{"location":"services/reporting-service/data-model/#5-so-o-erd-entity-relationship-diagram","title":"5. S\u01a1 \u0111\u1ed3 ERD (Entity Relationship Diagram)","text":"<p>S\u01a1 \u0111\u1ed3 s\u01a1 b\u1ed9 <pre><code>erDiagram\n\n  report_templates ||--o{ report_query_logs : generates\n  report_templates ||--o{ saved_report_configs : based_on\n  saved_report_configs ||--o{ saved_dashboard_layouts : uses\n\n  report_templates {\n    string id PK\n    string name\n    string description\n    jsonb input_parameters\n    string data_view\n    string query_template\n    jsonb required_permission\n    string version\n    boolean is_active\n    timestamp created_at\n    timestamp updated_at\n  }\n\n  report_query_logs {\n    string id PK\n    string template_id FK\n    string user_id\n    string tenant_id\n    jsonb input_used\n    timestamp executed_at\n    float query_duration_ms\n    string status\n    jsonb metadata\n  }\n\n  saved_report_configs {\n    string id PK\n    string user_id\n    string tenant_id\n    string template_id FK\n    string name\n    jsonb input_parameters\n    timestamp created_at\n    timestamp updated_at\n  }\n\n  saved_dashboard_layouts {\n    string id PK\n    string config_id FK\n    string user_id\n    string layout_type\n    jsonb widget_arrangement\n    timestamp created_at\n    timestamp updated_at\n  }\n</code></pre></p> <p>\ud83d\udcdd Ghi ch\u00fa:</p> <ul> <li><code>report_templates</code>: \u0110\u1ecbnh ngh\u0129a m\u1eabu b\u00e1o c\u00e1o, do Superadmin t\u1ea1o ho\u1eb7c h\u1ec7 th\u1ed1ng c\u00e0i s\u1eb5n.</li> <li><code>report_query_logs</code>: Ghi nh\u1eadn c\u00e1c l\u1ea7n ng\u01b0\u1eddi d\u00f9ng truy v\u1ea5n theo m\u1eabu.</li> <li><code>saved_report_configs</code>: Cho ph\u00e9p ng\u01b0\u1eddi d\u00f9ng l\u01b0u c\u1ea5u h\u00ecnh \u0111\u1ec3 t\u00e1i s\u1eed d\u1ee5ng.</li> <li><code>saved_dashboard_layouts</code>: Cho ph\u00e9p ng\u01b0\u1eddi d\u00f9ng t\u1ef1 c\u1ea5u h\u00ecnh dashboard t\u1eeb nhi\u1ec1u config.</li> </ul> <p>S\u01a1 \u0111\u1ed3 chi ti\u1ebft <pre><code>erDiagram\n\nreport_templates {\n  string template_id PK\n  string name\n  string description\n  string data_view\n  boolean is_active\n  string created_by\n  timestamp created_at\n}\n\nreport_template_versions {\n  string version PK\n  string template_id FK\n  string query_template\n  jsonb input_parameters_schema\n  timestamp created_at\n  string created_by\n}\n\nreport_template_permissions {\n  string template_id FK\n  string permission_code\n}\n\nreport_query_logs {\n  string log_id PK\n  string user_id\n  string tenant_id\n  string template_id FK\n  jsonb input_used\n  string status\n  int query_duration_ms\n  timestamp executed_at\n}\n\nsaved_report_configs {\n  string config_id PK\n  string user_id\n  string tenant_id\n  string template_id FK\n  jsonb input_parameters\n  string name\n  timestamp created_at\n}\n\nsaved_dashboard_layouts {\n  string layout_id PK\n  string user_id\n  string config_id FK\n  jsonb layout\n  string layout_type\n  timestamp updated_at\n}\n\nreport_templates ||--o{ report_template_versions : has\nreport_templates ||--o{ report_template_permissions : has\nreport_templates ||--o{ report_query_logs : used_in\nreport_templates ||--o{ saved_report_configs : config_of\nsaved_report_configs ||--o{ saved_dashboard_layouts : contains\n</code></pre></p>"},{"location":"services/reporting-service/data-model/#6-mo-ta-chi-tiet-tung-bang","title":"6. M\u00f4 t\u1ea3 chi ti\u1ebft t\u1eebng b\u1ea3ng","text":""},{"location":"services/reporting-service/data-model/#61-report_templates","title":"6.1. <code>report_templates</code>","text":"<pre><code>CREATE TABLE report_templates (\n  template_id VARCHAR PRIMARY KEY,\n  name TEXT NOT NULL,\n  description TEXT,\n  data_view TEXT NOT NULL,\n  is_active BOOLEAN DEFAULT true,\n  created_by TEXT,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n</code></pre> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>id</code> <code>string</code> \u2705 M\u00e3 \u0111\u1ecbnh danh duy nh\u1ea5t c\u1ee7a template <code>name</code> <code>string</code> \u2705 T\u00ean hi\u1ec3n th\u1ecb c\u1ee7a template <code>description</code> <code>string</code> \u26d4 M\u00f4 t\u1ea3 ng\u1eafn v\u1ec1 b\u00e1o c\u00e1o <code>input_parameters</code> <code>jsonb</code> \u2705 Danh s\u00e1ch c\u00e1c tham s\u1ed1 ng\u01b0\u1eddi d\u00f9ng c\u1ea7n nh\u1eadp <code>data_view</code> <code>string</code> \u2705 View/table trong Data Warehouse m\u00e0 query_template s\u1eed d\u1ee5ng <code>query_template</code> <code>string</code> \u2705 C\u00e2u truy v\u1ea5n \u0111\u1ed9ng v\u1edbi placeholder <code>required_permission</code> <code>jsonb</code> \u2705 Danh s\u00e1ch quy\u1ec1n c\u1ea7n c\u00f3 \u0111\u1ec3 truy c\u1eadp <code>version</code> <code>string</code> \u2705 Phi\u00ean b\u1ea3n c\u1ee7a template, v\u00ed d\u1ee5: \"v1\", \"v2\" <code>is_active</code> <code>boolean</code> \u2705 \u0110\u00e1nh d\u1ea5u template \u0111\u00e3 b\u1ecb v\u00f4 hi\u1ec7u h\u00f3a ch\u01b0a <code>created_at</code> <code>timestamp</code> \u2705 Ng\u00e0y t\u1ea1o <code>updated_at</code> <code>timestamp</code> \u2705 Ng\u00e0y c\u1eadp nh\u1eadt cu\u1ed1i c\u00f9ng"},{"location":"services/reporting-service/data-model/#62-report_query_logs","title":"6.2. <code>report_query_logs</code>","text":"<pre><code>CREATE TABLE report_query_logs (\n  log_id UUID PRIMARY KEY,\n  user_id TEXT NOT NULL,\n  tenant_id TEXT NOT NULL,\n  template_id VARCHAR,\n  input_used JSONB,\n  status TEXT CHECK (status IN ('success', 'error', 'timeout', 'unauthorized', 'validation_failed')),\n  query_duration_ms INT,\n  executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  FOREIGN KEY (template_id) REFERENCES report_templates(template_id) ON DELETE SET NULL\n);\n</code></pre> <p>\ud83d\udcdd Gi\u1ea3i th\u00edch: Ch\u00fang ta d\u00f9ng ON DELETE SET NULL cho logs \u0111\u1ec3 v\u1eabn gi\u1eef log truy v\u1ea5n d\u00f9 template b\u1ecb x\u00f3a.</p> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>id</code> <code>string</code> \u2705 ID c\u1ee7a log <code>template_id</code> <code>string</code> \u2705 Template m\u00e0 truy v\u1ea5n d\u1ef1a tr\u00ean <code>user_id</code> <code>string</code> \u2705 ID ng\u01b0\u1eddi d\u00f9ng th\u1ef1c hi\u1ec7n truy v\u1ea5n <code>tenant_id</code> <code>string</code> \u2705 ID tenant <code>input_used</code> <code>jsonb</code> \u2705 Tham s\u1ed1 truy v\u1ea5n s\u1eed d\u1ee5ng <code>executed_at</code> <code>timestamp</code> \u2705 Th\u1eddi \u0111i\u1ec3m th\u1ef1c hi\u1ec7n truy v\u1ea5n <code>query_duration_ms</code> <code>float</code> \u2705 Th\u1eddi gian th\u1ef1c thi <code>status</code> <code>string</code> \u2705 <code>success</code>, <code>error</code>, <code>timeout</code> <code>metadata</code> <code>jsonb</code> \u26d4 Th\u00f4ng tin th\u00eam: source IP, user-agent, etc."},{"location":"services/reporting-service/data-model/#63-saved_report_configs","title":"6.3. <code>saved_report_configs</code>","text":"<pre><code>CREATE TABLE saved_report_configs (\n  config_id UUID PRIMARY KEY,\n  user_id TEXT NOT NULL,\n  tenant_id TEXT NOT NULL,\n  template_id VARCHAR NOT NULL,\n  input_parameters JSONB NOT NULL,\n  name TEXT,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  FOREIGN KEY (template_id) REFERENCES report_templates(template_id) ON DELETE CASCADE\n);\n</code></pre> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>id</code> <code>string</code> \u2705 ID c\u1ea5u h\u00ecnh <code>user_id</code> <code>string</code> \u2705 Ng\u01b0\u1eddi t\u1ea1o <code>tenant_id</code> <code>string</code> \u2705 Tenant t\u01b0\u01a1ng \u1ee9ng <code>template_id</code> <code>string</code> \u2705 Template \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng <code>name</code> <code>string</code> \u2705 T\u00ean c\u1ea5u h\u00ecnh ng\u01b0\u1eddi d\u00f9ng t\u1ef1 \u0111\u1eb7t <code>input_parameters</code> <code>jsonb</code> \u2705 Tham s\u1ed1 \u0111i\u1ec1n s\u1eb5n <code>created_at</code> <code>timestamp</code> \u2705 Ng\u00e0y t\u1ea1o <code>updated_at</code> <code>timestamp</code> \u2705 Ng\u00e0y c\u1eadp nh\u1eadt g\u1ea7n nh\u1ea5t"},{"location":"services/reporting-service/data-model/#64-saved_dashboard_layouts","title":"6.4. <code>saved_dashboard_layouts</code>","text":"<pre><code>CREATE TABLE saved_dashboard_layouts (\n  layout_id UUID PRIMARY KEY,\n  user_id TEXT NOT NULL,\n  config_id UUID NOT NULL,\n  layout JSONB NOT NULL,\n  layout_type TEXT CHECK (layout_type IN ('chart', 'table', 'dashboard_grid')),\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  FOREIGN KEY (config_id) REFERENCES saved_report_configs(config_id) ON DELETE CASCADE\n);\n</code></pre> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>id</code> <code>string</code> \u2705 ID layout <code>config_id</code> <code>string</code> \u2705 Li\u00ean k\u1ebft t\u1edbi <code>saved_report_configs</code> <code>user_id</code> <code>string</code> \u2705 Ng\u01b0\u1eddi s\u1edf h\u1eefu <code>layout_type</code> <code>string</code> \u2705 <code>grid</code>, <code>tabbed</code>, etc. <code>widget_arrangement</code> <code>jsonb</code> \u2705 JSON \u0111\u1ecbnh ngh\u0129a layout UI <code>created_at</code> <code>timestamp</code> \u2705 Th\u1eddi \u0111i\u1ec3m t\u1ea1o <code>updated_at</code> <code>timestamp</code> \u2705 L\u1ea7n c\u1eadp nh\u1eadt cu\u1ed1i"},{"location":"services/reporting-service/data-model/#7-cac-bang-phu-tro","title":"7. C\u00e1c b\u1ea3ng ph\u1ee5 tr\u1ee3","text":""},{"location":"services/reporting-service/data-model/#71-report_template_versions","title":"7.1. <code>report_template_versions</code>","text":"<pre><code>CREATE TABLE report_template_versions (\n  version TEXT NOT NULL,\n  template_id VARCHAR NOT NULL,\n  query_template TEXT NOT NULL,\n  input_parameters_schema JSONB NOT NULL,\n  created_by TEXT,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  PRIMARY KEY (template_id, version),\n  FOREIGN KEY (template_id) REFERENCES report_templates(template_id) ON DELETE CASCADE\n);\n</code></pre> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>id</code> <code>string</code> \u2705 ID b\u1ea3n ghi <code>template_id</code> <code>string</code> \u2705 Li\u00ean k\u1ebft t\u1edbi template ch\u00ednh <code>version</code> <code>string</code> \u2705 S\u1ed1 phi\u00ean b\u1ea3n (v\u00ed d\u1ee5: \"v1\", \"v2\") <code>query_template</code> <code>string</code> \u2705 N\u1ed9i dung query t\u01b0\u01a1ng \u1ee9ng v\u1edbi phi\u00ean b\u1ea3n n\u00e0y <code>input_parameters</code> <code>jsonb</code> \u2705 \u0110\u1ecbnh ngh\u0129a tham s\u1ed1 t\u01b0\u01a1ng \u1ee9ng <code>created_at</code> <code>timestamp</code> \u2705 Th\u1eddi \u0111i\u1ec3m t\u1ea1o b\u1ea3n n\u00e0y <code>created_by</code> <code>string</code> \u2705 Ng\u01b0\u1eddi t\u1ea1o phi\u00ean b\u1ea3n n\u00e0y <p>\ud83c\udfaf D\u00f9ng \u0111\u1ec3 l\u01b0u tr\u1eef c\u00e1c phi\u00ean b\u1ea3n c\u0169 c\u1ee7a report template, gi\u00fap rollback d\u1ec5 d\u00e0ng ho\u1eb7c theo d\u00f5i l\u1ecbch s\u1eed.</p>"},{"location":"services/reporting-service/data-model/#72-report_template_permissions","title":"7.2. <code>report_template_permissions</code>","text":"<pre><code>CREATE TABLE report_template_permissions (\n  template_id VARCHAR NOT NULL,\n  permission_code TEXT NOT NULL,\n  PRIMARY KEY (template_id, permission_code),\n  FOREIGN KEY (template_id) REFERENCES report_templates(template_id) ON DELETE CASCADE\n);\n</code></pre> Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>template_id</code> <code>string</code> \u2705 ID template <code>permission_code</code> <code>string</code> \u2705 M\u00e3 quy\u1ec1n y\u00eau c\u1ea7u (v\u00ed d\u1ee5: <code>report.view_finance</code>) <code>is_required</code> <code>bool</code> \u2705 <code>true</code> = b\u1eaft bu\u1ed9c, <code>false</code> = t\u00f9y ch\u1ecdn <code>created_at</code> <code>timestamp</code> \u2705 Ng\u00e0y th\u00eam quy\u1ec1n n\u00e0y v\u00e0o template <p>\ud83c\udfaf Cho ph\u00e9p t\u00e1ch ri\u00eang quy\u1ec1n ki\u1ec3m so\u00e1t truy c\u1eadp v\u1edbi t\u1eebng template thay v\u00ec nh\u00e9t to\u00e0n b\u1ed9 trong 1 c\u1ed9t JSON.</p>"},{"location":"services/reporting-service/data-model/#73-report_query_status_logs","title":"7.3. <code>report_query_status_logs</code>","text":"Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>id</code> <code>string</code> \u2705 ID log <code>query_id</code> <code>string</code> \u2705 ID t\u1eeb b\u1ea3ng <code>report_query_logs</code> <code>status</code> <code>string</code> \u2705 <code>started</code>, <code>running</code>, <code>success</code>, <code>error</code>, <code>timeout</code> <code>timestamp</code> <code>timestamp</code> \u2705 Th\u1eddi \u0111i\u1ec3m log <code>message</code> <code>string</code> \u26d4 M\u00f4 t\u1ea3 chi ti\u1ebft ho\u1eb7c l\u1ed7i <p>\ud83c\udfaf Ghi nh\u1eadn chi ti\u1ebft lifecycle c\u1ee7a truy v\u1ea5n \u0111\u1ec3 ph\u1ee5c v\u1ee5 debug v\u00e0 audit.</p>"},{"location":"services/reporting-service/data-model/#8-indexes-constraints","title":"8. Indexes &amp; Constraints","text":"<p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c ch\u1ec9 m\u1ee5c v\u00e0 r\u00e0ng bu\u1ed9c quan tr\u1ecdng nh\u1eb1m \u0111\u1ea3m b\u1ea3o hi\u1ec7u n\u0103ng truy v\u1ea5n v\u00e0 t\u00ednh to\u00e0n v\u1eb9n d\u1eef li\u1ec7u trong h\u1ec7 th\u1ed1ng.</p>"},{"location":"services/reporting-service/data-model/#81-report_templates","title":"8.1. <code>report_templates</code>","text":"<p>Indexes: - <code>idx_report_templates_active</code>: (<code>is_active</code>) - <code>idx_report_templates_name</code>: (<code>name</code>) - <code>idx_report_templates_data_view</code>: (<code>data_view</code>)</p> <p>Constraints: - <code>UNIQUE(template_id, version)</code> - <code>CHECK (version ~ '^v[0-9]+$')</code> \u2013 \u0111\u1ea3m b\u1ea3o version h\u1ee3p l\u1ec7</p>"},{"location":"services/reporting-service/data-model/#82-report_query_logs","title":"8.2. <code>report_query_logs</code>","text":"<p>Indexes: - <code>idx_query_logs_user</code>: (<code>user_id</code>) - <code>idx_query_logs_template</code>: (<code>template_id</code>) - <code>idx_query_logs_tenant_time</code>: (<code>tenant_id</code>, <code>executed_at</code> DESC)</p> <p>Constraints: - <code>CHECK (query_duration_ms &gt;= 0)</code> - <code>CHECK (status IN ('success', 'error', 'timeout'))</code></p>"},{"location":"services/reporting-service/data-model/#83-saved_report_configs","title":"8.3. <code>saved_report_configs</code>","text":"<p>Indexes: - <code>idx_saved_config_user</code>: (<code>user_id</code>) - <code>idx_saved_config_tenant</code>: (<code>tenant_id</code>) - <code>idx_saved_config_template</code>: (<code>template_id</code>)</p> <p>Constraints: - <code>UNIQUE(user_id, name)</code> \u2013 m\u1ed7i ng\u01b0\u1eddi d\u00f9ng kh\u00f4ng \u0111\u01b0\u1ee3c \u0111\u1eb7t t\u00ean tr\u00f9ng nhau cho c\u1ea5u h\u00ecnh \u0111\u00e3 l\u01b0u - <code>CHECK (input_parameters IS NOT NULL)</code></p>"},{"location":"services/reporting-service/data-model/#84-saved_dashboard_layouts","title":"8.4. <code>saved_dashboard_layouts</code>","text":"<p>Indexes: - <code>idx_dashboard_layout_user</code>: (<code>user_id</code>) - <code>idx_dashboard_layout_config</code>: (<code>config_id</code>)</p> <p>Constraints: - <code>CHECK (layout_type IN ('grid', 'tabbed', 'freeform'))</code></p>"},{"location":"services/reporting-service/data-model/#85-report_template_versions","title":"8.5. <code>report_template_versions</code>","text":"<p>Indexes: - <code>idx_versions_template</code>: (<code>template_id</code>) - <code>idx_versions_created_by</code>: (<code>created_by</code>)</p> <p>Constraints: - <code>UNIQUE(template_id, version)</code> - <code>CHECK (version ~ '^v[0-9]+$')</code></p>"},{"location":"services/reporting-service/data-model/#86-report_template_permissions","title":"8.6. <code>report_template_permissions</code>","text":"<p>Indexes: - <code>idx_permissions_template</code>: (<code>template_id</code>) - <code>idx_permissions_code</code>: (<code>permission_code</code>)</p> <p>Constraints: - <code>UNIQUE(template_id, permission_code)</code></p>"},{"location":"services/reporting-service/data-model/#9-chinh-sach-luu-tru-xoa-du-lieu-retention","title":"9. Ch\u00ednh s\u00e1ch L\u01b0u tr\u1eef &amp; X\u00f3a d\u1eef li\u1ec7u (Retention)","text":"<p>H\u1ec7 th\u1ed1ng Reporting Service c\u1ea7n \u00e1p d\u1ee5ng c\u00e1c ch\u00ednh s\u00e1ch l\u01b0u tr\u1eef ph\u00f9 h\u1ee3p \u0111\u1ec3 c\u00e2n b\u1eb1ng gi\u1eefa truy xu\u1ea5t hi\u1ec7u qu\u1ea3, chi ph\u00ed l\u01b0u tr\u1eef v\u00e0 y\u00eau c\u1ea7u tu\u00e2n th\u1ee7 ph\u00e1p l\u00fd.</p>"},{"location":"services/reporting-service/data-model/#91-report_query_logs","title":"9.1. <code>report_query_logs</code>","text":"<ul> <li>Th\u1eddi gian gi\u1eef: 12 th\u00e1ng</li> <li>C\u01a1 ch\u1ebf x\u00f3a: T\u1ef1 \u0111\u1ed9ng th\u00f4ng qua batch job \u0111\u1ecbnh k\u1ef3 (v\u00ed d\u1ee5: Cloud Scheduler + Cloud Function)</li> <li>L\u00fd do: Log n\u00e0y ph\u1ee5c v\u1ee5 th\u1ed1ng k\u00ea hi\u1ec7u n\u0103ng v\u00e0 truy v\u1ebft ng\u01b0\u1eddi d\u00f9ng. Sau 12 th\u00e1ng, d\u1eef li\u1ec7u c\u0169 \u00edt gi\u00e1 tr\u1ecb s\u1eed d\u1ee5ng.</li> </ul>"},{"location":"services/reporting-service/data-model/#92-report_template_versions","title":"9.2. <code>report_template_versions</code>","text":"<ul> <li>Th\u1eddi gian gi\u1eef: V\u0129nh vi\u1ec5n (ho\u1eb7c cho \u0111\u1ebfn khi template ch\u00ednh b\u1ecb x\u00f3a)</li> <li>C\u01a1 ch\u1ebf x\u00f3a: Ch\u1ec9 x\u00f3a khi Superadmin ho\u1eb7c h\u1ec7 th\u1ed1ng quy\u1ebft \u0111\u1ecbnh x\u00f3a template ch\u00ednh</li> <li>L\u00fd do: C\u1ea7n l\u01b0u l\u1ecbch s\u1eed \u0111\u1ec3 rollback ho\u1eb7c ki\u1ec3m tra thay \u0111\u1ed5i.</li> </ul>"},{"location":"services/reporting-service/data-model/#93-saved_report_configs-saved_dashboard_layouts","title":"9.3. <code>saved_report_configs</code> &amp; <code>saved_dashboard_layouts</code>","text":"<ul> <li>Th\u1eddi gian gi\u1eef: V\u0129nh vi\u1ec5n (mi\u1ec5n l\u00e0 user c\u00f2n ho\u1ea1t \u0111\u1ed9ng)</li> <li>C\u01a1 ch\u1ebf x\u00f3a: Theo y\u00eau c\u1ea7u ng\u01b0\u1eddi d\u00f9ng ho\u1eb7c khi user b\u1ecb x\u00f3a kh\u1ecfi h\u1ec7 th\u1ed1ng</li> <li>L\u00fd do: \u0110\u00e2y l\u00e0 d\u1eef li\u1ec7u do ng\u01b0\u1eddi d\u00f9ng l\u01b0u th\u1ee7 c\u00f4ng, n\u00ean c\u1ea7n t\u00f4n tr\u1ecdng quy\u1ec1n s\u1edf h\u1eefu.</li> </ul>"},{"location":"services/reporting-service/data-model/#94-report_template_permissions","title":"9.4. <code>report_template_permissions</code>","text":"<ul> <li>Th\u1eddi gian gi\u1eef: V\u0129nh vi\u1ec5n</li> <li>L\u00fd do: L\u00e0 m\u1ed9t ph\u1ea7n c\u1ea5u tr\u00fac quy\u1ec1n c\u1ee7a template, lu\u00f4n c\u1ea7n cho x\u00e1c th\u1ef1c truy c\u1eadp.</li> </ul>"},{"location":"services/reporting-service/data-model/#95-tuan-thu-adr-024","title":"9.5. Tu\u00e2n th\u1ee7 ADR-024","text":"<p>T\u1ea5t c\u1ea3 c\u00e1c b\u1ea3ng log v\u00e0 d\u1eef li\u1ec7u c\u00f3 th\u1ec3 ch\u1ee9a th\u00f4ng tin c\u00e1 nh\u00e2n (nh\u01b0 <code>user_id</code>, <code>input_used</code>, <code>tenant_id</code>) \u0111\u1ec1u: - Tu\u00e2n th\u1ee7 ch\u00ednh s\u00e1ch \u1ea9n danh h\u00f3a theo ADR-024 - Data Anonymization &amp; Retention - C\u1ea7n ki\u1ec3m tra masking h\u1ee3p l\u00fd tr\u01b0\u1edbc khi l\u01b0u log truy v\u1ea5n ho\u1eb7c log dashboard</p>"},{"location":"services/reporting-service/data-model/#10-phan-quyen-truy-cap-du-lieu","title":"10. Ph\u00e2n quy\u1ec1n truy c\u1eadp d\u1eef li\u1ec7u","text":"<p>To\u00e0n b\u1ed9 h\u1ec7 th\u1ed1ng Reporting Service tu\u00e2n th\u1ee7 m\u00f4 h\u00ecnh ph\u00e2n quy\u1ec1n \u0111\u1ed9ng (RBAC) \u0111\u00e3 \u0111\u01b0\u1ee3c m\u00f4 t\u1ea3 trong ADR-007 v\u00e0 rbac-deep-dive.md.</p>"},{"location":"services/reporting-service/data-model/#101-truy-van-bao-cao-reportsquery","title":"10.1. Truy v\u1ea5n b\u00e1o c\u00e1o (<code>/reports/query</code>)","text":"<ul> <li>Ki\u1ec3m tra quy\u1ec1n truy c\u1eadp:</li> <li>M\u1ed7i <code>report_template</code> khai b\u00e1o m\u1ed9t ho\u1eb7c nhi\u1ec1u <code>required_permission</code>.</li> <li>T\u1ea1i th\u1eddi \u0111i\u1ec3m truy v\u1ea5n, <code>RBAC Validator</code> s\u1ebd ki\u1ec3m tra xem user c\u00f3 \u0111\u1ee7 c\u00e1c permission c\u1ea7n thi\u1ebft trong context tenant hay kh\u00f4ng.</li> <li>Vi\u1ec7c n\u00e0y \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n \u1edf t\u1ea7ng API Gateway (d\u1ef1a tr\u00ean <code>x-required-permission</code>) v\u00e0 \u1edf t\u1ea7ng Reporting Service nh\u01b0 l\u1edbp ki\u1ec3m tra b\u1ed5 sung (fail-safe).</li> <li>V\u00ed d\u1ee5 permission code:</li> <li><code>report.view_financial_summary</code></li> <li><code>report.view_user_growth</code></li> </ul>"},{"location":"services/reporting-service/data-model/#102-quan-ly-template-report-templates","title":"10.2. Qu\u1ea3n l\u00fd Template (<code>/report-templates/**</code>)","text":"<ul> <li>Ch\u1ec9 Superadmin c\u00f3 quy\u1ec1n th\u1ef1c hi\u1ec7n c\u00e1c thao t\u00e1c t\u1ea1o, c\u1eadp nh\u1eadt, v\u00f4 hi\u1ec7u h\u00f3a template.</li> <li>Permission \u00e1p d\u1ee5ng:</li> <li><code>report.manage_templates</code></li> <li><code>report.view_templates</code></li> </ul>"},{"location":"services/reporting-service/data-model/#103-saved-report-configs-dashboards-saved-configs-dashboards","title":"10.3. Saved Report Configs &amp; Dashboards (<code>/saved-configs</code>, <code>/dashboards</code>)","text":"<ul> <li>Quy\u1ec1n theo ng\u01b0\u1eddi d\u00f9ng:</li> <li>Ng\u01b0\u1eddi d\u00f9ng ch\u1ec9 \u0111\u01b0\u1ee3c ph\u00e9p xem/ch\u1ec9nh s\u1eeda/l\u01b0u dashboard c\u1ee7a ch\u00ednh m\u00ecnh (<code>user_id</code>)</li> <li>RBAC n\u00e2ng cao (n\u1ebfu \u00e1p d\u1ee5ng):</li> <li>C\u00f3 th\u1ec3 th\u00eam permission nh\u01b0 <code>report.save_config</code>, <code>report.share_dashboard</code> n\u1ebfu mu\u1ed1n m\u1edf r\u1ed9ng chia s\u1ebb trong t\u01b0\u01a1ng lai.</li> </ul>"},{"location":"services/reporting-service/data-model/#104-logging-truy-vet","title":"10.4. Logging &amp; Truy v\u1ebft","text":"<ul> <li>D\u1eef li\u1ec7u log (<code>report_query_logs</code>) \u0111\u01b0\u1ee3c ghi l\u1ea1i cho m\u1ed7i truy v\u1ea5n nh\u01b0ng ch\u1ec9 Superadmin v\u00e0 c\u00e1c Auditor m\u1edbi c\u00f3 quy\u1ec1n truy c\u1eadp \u0111\u1ec3 xem to\u00e0n b\u1ed9.</li> <li>API log truy v\u1ea5n kh\u00f4ng public trong OpenAPI.</li> </ul>"},{"location":"services/reporting-service/data-model/#105-co-che-kiem-soat-phan-quyen","title":"10.5. C\u01a1 ch\u1ebf ki\u1ec3m so\u00e1t ph\u00e2n quy\u1ec1n","text":"T\u1ea7ng ki\u1ec3m so\u00e1t Vai tr\u00f2 API Gateway Enforce <code>x-required-permission</code> t\u1eeb template Reporting Service Ki\u1ec3m tra l\u1ea1i b\u1eb1ng RBACValidator n\u1ed9i b\u1ed9 Database Kh\u00f4ng \u0111\u1ec3 l\u1ed9 d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m; x\u00e1c th\u1ef1c \u1edf t\u1ea7ng truy v\u1ea5n"},{"location":"services/reporting-service/data-model/#106-lien-ket-adr","title":"10.6. Li\u00ean k\u1ebft ADR","text":"<ul> <li>ADR-007 - RBAC Architecture</li> <li>ADR-028 - Reporting Architecture</li> <li>ADR-029 - Report Template Schema</li> </ul>"},{"location":"services/reporting-service/data-model/#11-mo-rong-trong-tuong-lai","title":"11. M\u1edf r\u1ed9ng trong t\u01b0\u01a1ng lai","text":"<p>H\u1ec7 th\u1ed1ng d\u1eef li\u1ec7u c\u1ee7a Reporting Service \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf v\u1edbi kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng cao nh\u1eb1m \u0111\u00e1p \u1ee9ng c\u00e1c nhu c\u1ea7u m\u1edbi c\u1ee7a t\u1ed5 ch\u1ee9c v\u00e0 t\u00edch h\u1ee3p c\u00e1c c\u00f4ng ngh\u1ec7 hi\u1ec7n \u0111\u1ea1i nh\u01b0 AI, multi-tenant reporting, v\u00e0 dashboard \u0111\u1ed9ng.</p>"},{"location":"services/reporting-service/data-model/#111-mo-rong-schema-template","title":"11.1. M\u1edf r\u1ed9ng Schema Template","text":"<ul> <li>Th\u00eam c\u00e1c lo\u1ea1i input parameter m\u1edbi:</li> <li><code>multi-select enum</code>, <code>daterange</code>, <code>autocomplete query</code>, <code>dynamic metric</code></li> <li>Support c\u00e1c rule validate n\u00e2ng cao:</li> <li>Theo <code>regex</code>, <code>min/max</code>, ho\u1eb7c ph\u1ee5 thu\u1ed9c l\u1eabn nhau gi\u1eefa c\u00e1c parameter</li> </ul>"},{"location":"services/reporting-service/data-model/#112-cau-truc-template-ong-theo-tung-nhom-bao-cao","title":"11.2. C\u1ea5u tr\u00fac Template \u0111\u1ed9ng theo t\u1eebng nh\u00f3m b\u00e1o c\u00e1o","text":"<ul> <li>T\u00e1ch c\u00e1c b\u1ea3ng <code>report_templates</code> v\u00e0 <code>report_template_versions</code> th\u00e0nh c\u00e1c nh\u00f3m (module h\u00f3a) theo l\u0129nh v\u1ef1c: <code>user_growth</code>, <code>revenue</code>, <code>admissions</code>, v.v.</li> <li>H\u1ed7 tr\u1ee3 \u0111a ng\u00f4n ng\u1eef cho <code>name</code>, <code>description</code></li> </ul>"},{"location":"services/reporting-service/data-model/#113-dashboard-config-nang-cao","title":"11.3. Dashboard Config n\u00e2ng cao","text":"<ul> <li>Cho ph\u00e9p:</li> <li>L\u01b0u dashboard chia s\u1ebb \u0111\u01b0\u1ee3c gi\u1eefa nhi\u1ec1u ng\u01b0\u1eddi</li> <li>C\u00f3 tr\u1ea1ng th\u00e1i \"private/public\"</li> <li>Dashboard ph\u00e2n quy\u1ec1n theo role</li> </ul>"},{"location":"services/reporting-service/data-model/#114-audit-log-nang-cao","title":"11.4. Audit Log n\u00e2ng cao","text":"<ul> <li>M\u1edf r\u1ed9ng th\u00eam b\u1ea3ng <code>report_audit_logs</code>:</li> <li>L\u01b0u l\u1ea1i truy v\u1ea5n, h\u00e0nh \u0111\u1ed9ng ch\u1ec9nh s\u1eeda template, quy\u1ec1n truy c\u1eadp d\u1eef li\u1ec7u theo user</li> <li>Tu\u00e2n th\u1ee7 ADR-008 - Audit Logging</li> </ul>"},{"location":"services/reporting-service/data-model/#115-chuan-bi-cho-ai-agent","title":"11.5. Chu\u1ea9n b\u1ecb cho AI Agent","text":"<ul> <li>Thi\u1ebft k\u1ebf schema <code>report_query_logs</code> v\u00e0 <code>saved_configs</code> c\u00f3 th\u1ec3 ph\u1ee5c v\u1ee5 recommendation engine:</li> <li>D\u1ef1 \u0111o\u00e1n b\u00e1o c\u00e1o th\u01b0\u1eddng d\u00f9ng</li> <li>T\u1ef1 \u0111\u1ed9ng \u0111\u1ec1 xu\u1ea5t dashboard cho t\u1eebng nh\u00f3m ng\u01b0\u1eddi d\u00f9ng</li> <li>L\u01b0u metadata \u0111\u1ee7 phong ph\u00fa \u0111\u1ec3 AI d\u1ec5 ph\u00e2n t\u00edch h\u00e0nh vi</li> </ul>"},{"location":"services/reporting-service/data-model/#116-truy-van-thoi-gian-thuc-streaming-report","title":"11.6. Truy v\u1ea5n th\u1eddi gian th\u1ef1c (Streaming Report)","text":"<ul> <li>K\u1ebft n\u1ed1i v\u1edbi BigQuery Streaming ho\u1eb7c h\u1ec7 th\u1ed1ng OLAP (Clickhouse, Pinot) \u0111\u1ec3 h\u1ed7 tr\u1ee3 b\u00e1o c\u00e1o g\u1ea7n real-time.</li> <li>Th\u00eam c\u1ed9t <code>is_streaming_enabled</code> trong <code>report_templates</code></li> </ul>"},{"location":"services/reporting-service/data-model/#117-tich-hop-to-chuc-thu-3-external-systems","title":"11.7. T\u00edch h\u1ee3p t\u1ed5 ch\u1ee9c th\u1ee9 3 (External Systems)","text":"<ul> <li>Cho ph\u00e9p ghi <code>report_query_logs</code> v\u00e0o h\u1ec7 th\u1ed1ng gi\u00e1m s\u00e1t nh\u01b0:</li> <li>GCP Cloud Logging</li> <li>Elastic Stack</li> <li>Cho ph\u00e9p g\u1ecdi webhook khi m\u1ed9t lo\u1ea1i b\u00e1o c\u00e1o \u0111\u01b0\u1ee3c truy c\u1eadp \u0111\u1ee7 nhi\u1ec1u (d\u00f9ng cho c\u1ea3nh b\u00e1o h\u1ec7 th\u1ed1ng)</li> </ul>"},{"location":"services/reporting-service/data-model/#12-enum","title":"12. ENUM","text":"<p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c gi\u00e1 tr\u1ecb ENUM \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng trong schema c\u1ee7a Reporting Service. C\u00e1c enum n\u00e0y n\u00ean \u0111\u01b0\u1ee3c l\u01b0u tr\u1eef t\u1eadp trung trong file schema ho\u1eb7c table config (n\u1ebfu c\u1ea7n m\u1edf r\u1ed9ng \u0111\u1ed9ng).</p>"},{"location":"services/reporting-service/data-model/#121-status-trong-report_query_logs","title":"12.1. <code>status</code> trong <code>report_query_logs</code>","text":"Gi\u00e1 tr\u1ecb \u00dd ngh\u0129a <code>success</code> Truy v\u1ea5n th\u00e0nh c\u00f4ng <code>error</code> L\u1ed7i trong qu\u00e1 tr\u00ecnh truy v\u1ea5n <code>timeout</code> Truy v\u1ea5n b\u1ecb timeout <code>unauthorized</code> Ng\u01b0\u1eddi d\u00f9ng kh\u00f4ng c\u00f3 quy\u1ec1n <code>validation_failed</code> Sai \u0111\u1ecbnh d\u1ea1ng ho\u1eb7c thi\u1ebfu tham s\u1ed1"},{"location":"services/reporting-service/data-model/#122-layout_type-trong-saved_dashboard_layouts","title":"12.2. <code>layout_type</code> trong <code>saved_dashboard_layouts</code>","text":"Gi\u00e1 tr\u1ecb \u00dd ngh\u0129a <code>chart</code> Bi\u1ec3u \u0111\u1ed3 \u0111\u01a1n <code>table</code> D\u1ea1ng b\u1ea3ng <code>dashboard_grid</code> Giao di\u1ec7n nhi\u1ec1u bi\u1ec3u \u0111\u1ed3"},{"location":"services/reporting-service/data-model/#123-input_type-trong-report_template_versionsinput_parameters_schema","title":"12.3. <code>input_type</code> trong <code>report_template_versions.input_parameters_schema</code>","text":"Gi\u00e1 tr\u1ecb M\u00f4 t\u1ea3 <code>string</code> Chu\u1ed7i v\u0103n b\u1ea3n <code>number</code> S\u1ed1 <code>date</code> Ng\u00e0y <code>enum</code> T\u1eadp gi\u00e1 tr\u1ecb l\u1ef1a ch\u1ecdn <code>multi-select</code> Ch\u1ecdn nhi\u1ec1u gi\u00e1 tr\u1ecb <code>boolean</code> \u0110\u00fang/Sai <code>daterange</code> Kho\u1ea3ng th\u1eddi gian <code>autocomplete</code> G\u1ee3i \u00fd t\u1eeb danh s\u00e1ch <code>query-select</code> Truy v\u1ea5n \u0111\u1ed9ng danh s\u00e1ch t\u1eeb data_view"},{"location":"services/reporting-service/data-model/#124-permission_code-vi-du","title":"12.4. <code>permission_code</code> (v\u00ed d\u1ee5)","text":"Gi\u00e1 tr\u1ecb M\u00f4 t\u1ea3 <code>report.view_financial_summary</code> Xem b\u00e1o c\u00e1o t\u00e0i ch\u00ednh t\u1ed5ng quan <code>report.manage_report_templates</code> Qu\u1ea3n l\u00fd m\u1eabu b\u00e1o c\u00e1o <code>report.view_user_growth</code> Xem t\u0103ng tr\u01b0\u1edfng ng\u01b0\u1eddi d\u00f9ng <code>report.save_config</code> L\u01b0u c\u1ea5u h\u00ecnh b\u00e1o c\u00e1o c\u00e1 nh\u00e2n <p>L\u01b0u \u00fd: C\u00e1c enum n\u00e0y \u0111\u01b0\u1ee3c d\u00f9ng trong schema <code>report_template_versions.input_parameters_schema</code>, c\u00e1c c\u1ea5u h\u00ecnh template, v\u00e0 c\u01a1 ch\u1ebf ph\u00e2n quy\u1ec1n \u0111\u1ed9ng.</p> <p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 MARKDOWN BLOCK cho ph\u1ea7n m\u1edbi <code>\ud83d\udcd1 13. ENUM d\u01b0\u1edbi d\u1ea1ng b\u1ea3ng ph\u1ee5 tr\u1ee3</code>, gi\u00fap b\u1ea1n qu\u1ea3n l\u00fd c\u00e1c enum d\u01b0\u1edbi d\u1ea1ng b\u1ea3ng d\u1eef li\u1ec7u thay v\u00ec ch\u1ec9 l\u00e0 <code>CHECK</code>. C\u00e1ch n\u00e0y gi\u00fap:</p> <ul> <li>D\u1ec5 c\u1eadp nh\u1eadt, tra c\u1ee9u, h\u1ed7 tr\u1ee3 dashboard qu\u1ea3n tr\u1ecb.</li> <li>Cho ph\u00e9p mapping m\u00f4 t\u1ea3 v\u00e0 metadata (ng\u00f4n ng\u1eef, m\u00e0u s\u1eafc, v.v.).</li> <li>Th\u00e2n thi\u1ec7n h\u01a1n n\u1ebfu b\u1ea1n d\u00f9ng BigQuery ho\u1eb7c dashboard t\u00f9y bi\u1ebfn.</li> </ul>"},{"location":"services/reporting-service/data-model/#13-enum-duoi-dang-bang-phu-tro","title":"\ud83d\udcd1 13. ENUM d\u01b0\u1edbi d\u1ea1ng b\u1ea3ng ph\u1ee5 tr\u1ee3","text":"<p>Thay v\u00ec s\u1eed d\u1ee5ng <code>CHECK constraint</code>, h\u1ec7 th\u1ed1ng s\u1ebd qu\u1ea3n l\u00fd c\u00e1c gi\u00e1 tr\u1ecb enum quan tr\u1ecdng d\u01b0\u1edbi d\u1ea1ng b\u1ea3ng ph\u1ee5 tr\u1ee3 (lookup tables). \u0110i\u1ec1u n\u00e0y t\u0103ng t\u00ednh linh ho\u1ea1t v\u00e0 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng.</p>"},{"location":"services/reporting-service/data-model/#131-report_statuses","title":"13.1. \ud83d\udcc4 report_statuses","text":"<p>Tr\u1ea1ng th\u00e1i tr\u1ea3 v\u1ec1 khi th\u1ef1c hi\u1ec7n m\u1ed9t truy v\u1ea5n b\u00e1o c\u00e1o.</p> <pre><code>CREATE TABLE report_statuses (\n  status TEXT PRIMARY KEY,\n  description TEXT,\n  color TEXT  -- v\u00ed d\u1ee5: d\u00f9ng cho dashboard UI\n);\n\nINSERT INTO report_statuses (status, description, color) VALUES\n  ('success', 'Truy v\u1ea5n th\u00e0nh c\u00f4ng', 'green'),\n  ('error', 'L\u1ed7i kh\u00f4ng x\u00e1c \u0111\u1ecbnh', 'red'),\n  ('timeout', 'Qu\u00e1 th\u1eddi gian x\u1eed l\u00fd', 'orange'),\n  ('unauthorized', 'Kh\u00f4ng \u0111\u1ee7 quy\u1ec1n truy c\u1eadp', 'gray'),\n  ('validation_failed', 'Tham s\u1ed1 \u0111\u1ea7u v\u00e0o kh\u00f4ng h\u1ee3p l\u1ec7', 'yellow');\n</code></pre> <p>B\u1ea3ng n\u00e0y thay th\u1ebf <code>CHECK(status IN ...)</code> trong <code>report_query_logs</code>.</p>"},{"location":"services/reporting-service/data-model/#132-dashboard_layout_types","title":"13.2. \ud83d\udcc4 dashboard_layout_types","text":"<p>C\u00e1c ki\u1ec3u layout dashboard cho ph\u00e9p.</p> <pre><code>CREATE TABLE dashboard_layout_types (\n  layout_type TEXT PRIMARY KEY,\n  description TEXT\n);\n\nINSERT INTO dashboard_layout_types (layout_type, description) VALUES\n  ('chart', 'Hi\u1ec3n th\u1ecb d\u1ea1ng bi\u1ec3u \u0111\u1ed3'),\n  ('table', 'Hi\u1ec3n th\u1ecb d\u1ea1ng b\u1ea3ng'),\n  ('dashboard_grid', 'D\u1ea1ng l\u01b0\u1edbi k\u1ebft h\u1ee3p');\n</code></pre> <p>Thay th\u1ebf <code>CHECK(layout_type IN ...)</code> trong <code>saved_dashboard_layouts</code>.</p>"},{"location":"services/reporting-service/data-model/#ap-dung","title":"\ud83d\udd17 \u00c1p d\u1ee5ng","text":"<p>C\u00e1c b\u1ea3ng nh\u01b0 <code>report_query_logs</code>, <code>saved_dashboard_layouts</code> s\u1ebd tham chi\u1ebfu qua <code>FOREIGN KEY</code>:</p> <pre><code>FOREIGN KEY (status) REFERENCES report_statuses(status)\nFOREIGN KEY (layout_type) REFERENCES dashboard_layout_types(layout_type)\n</code></pre> <p>\ud83c\udfaf L\u1ee3i \u00edch:</p> <ul> <li>H\u1ed7 tr\u1ee3 hi\u1ec3n th\u1ecb UI phong ph\u00fa (label, color, v.v.).</li> <li>D\u1ec5 thay \u0111\u1ed5i, m\u1edf r\u1ed9ng m\u00e0 kh\u00f4ng c\u1ea7n ALTER TABLE.</li> <li>C\u00f3 th\u1ec3 \u0111\u1ed3ng b\u1ed9 v\u00e0 qu\u1ea3n l\u00fd qua giao di\u1ec7n admin.</li> </ul>"},{"location":"services/reporting-service/data-model/#14-tai-lieu-lien-ket","title":"14. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean k\u1ebft","text":"<ul> <li>Interface Contract</li> <li>OpenAPI Spec</li> <li>Design</li> </ul>"},{"location":"services/reporting-service/design/","title":"\ud83d\udcd8 Thi\u1ebft k\u1ebf chi ti\u1ebft Reporting Service","text":""},{"location":"services/reporting-service/design/#1-pham-vi-va-trach-nhiem-scope-responsibilities","title":"1. \ud83e\udded Ph\u1ea1m vi v\u00e0 Tr\u00e1ch nhi\u1ec7m (Scope &amp; Responsibilities)","text":""},{"location":"services/reporting-service/design/#muc-tieu","title":"\ud83c\udfaf M\u1ee5c ti\u00eau","text":"<ul> <li>Cung c\u1ea5p h\u1ec7 th\u1ed1ng b\u00e1o c\u00e1o t\u1ed5ng h\u1ee3p cho Superadmin v\u1edbi kh\u1ea3 n\u0103ng t\u00f9y bi\u1ebfn cao d\u1ef1a tr\u00ean c\u00e1c m\u1eabu b\u00e1o c\u00e1o \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh.</li> <li>Truy v\u1ea5n d\u1eef li\u1ec7u ph\u00e2n t\u00edch t\u1eeb Data Warehouse (BigQuery) d\u1ef1a tr\u00ean template \u0111\u00e3 \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a v\u00e0 c\u00e1c tham s\u1ed1 \u0111\u1ea7u v\u00e0o.</li> <li>Qu\u1ea3n l\u00fd v\u00f2ng \u0111\u1eddi c\u1ee7a Report Templates, h\u1ed7 tr\u1ee3 versioning v\u00e0 ph\u00e2n quy\u1ec1n chi ti\u1ebft.</li> </ul>"},{"location":"services/reporting-service/design/#cac-thuc-the-du-lieu-quan-ly","title":"\ud83d\udce6 C\u00e1c th\u1ef1c th\u1ec3 d\u1eef li\u1ec7u qu\u1ea3n l\u00fd","text":"Th\u1ef1c th\u1ec3 M\u00f4 t\u1ea3 ReportTemplate M\u1eabu b\u00e1o c\u00e1o \u0111\u1ecbnh ngh\u0129a truy v\u1ea5n v\u00e0 metadata, c\u00f3 versioning. SavedReportConfig C\u1ea5u h\u00ecnh b\u00e1o c\u00e1o c\u1ee5 th\u1ec3 m\u00e0 ng\u01b0\u1eddi d\u00f9ng \u0111\u00e3 l\u01b0u v\u1edbi tham s\u1ed1 \u0111\u1ea7u v\u00e0o. ReportQueryLog Log chi ti\u1ebft c\u00e1c truy v\u1ea5n th\u1ef1c hi\u1ec7n qua service (cho auditing/monitoring). <p>\u26a0\ufe0f Service n\u00e0y kh\u00f4ng l\u01b0u d\u1eef li\u1ec7u th\u00f4, d\u1eef li\u1ec7u k\u1ebft qu\u1ea3 b\u00e1o c\u00e1o hay d\u1eef li\u1ec7u ph\u00e2n t\u00edch \u2013 t\u1ea5t c\u1ea3 \u0111\u1ebfn t\u1eeb BigQuery.</p>"},{"location":"services/reporting-service/design/#ngoai-pham-vi-out-of-scope","title":"\ud83d\udd12 Ngo\u00e0i Ph\u1ea1m Vi (Out of Scope)","text":"<p>Service n\u00e0y kh\u00f4ng th\u1ef1c hi\u1ec7n c\u00e1c t\u00e1c v\u1ee5 sau:</p> <ul> <li>\u274c L\u01b0u tr\u1eef d\u1eef li\u1ec7u ph\u00e2n t\u00edch g\u1ed1c (do Data Warehouse \u0111\u1ea3m nh\u1eadn).</li> <li>\u274c Tr\u1ef1c ti\u1ebfp truy c\u1eadp c\u00e1c service nh\u01b0 School Management System (SMS)</li> <li>\u274c Sinh b\u00e1o c\u00e1o th\u1eddi gian th\u1ef1c t\u1eeb d\u1eef li\u1ec7u giao d\u1ecbch g\u1ed1c.</li> <li>\u274c G\u1eedi th\u00f4ng b\u00e1o khi b\u00e1o c\u00e1o ho\u00e0n th\u00e0nh (giao cho Notification Service).</li> <li>\u274c Ph\u00e2n t\u00edch AI ho\u1eb7c ML tr\u00ean d\u1eef li\u1ec7u (chu\u1ea9n b\u1ecb cho giai \u0111o\u1ea1n sau).</li> </ul>"},{"location":"services/reporting-service/design/#2-thiet-ke-api-chi-tiet-interface-contract","title":"2. \ud83c\udf10 Thi\u1ebft k\u1ebf API chi ti\u1ebft (Interface Contract)","text":"Method Path T\u00e1c v\u1ee5 Y\u00eau c\u1ea7u permission GET <code>/templates</code> Danh s\u00e1ch Report Template \u2705 <code>report.view_templates</code> POST <code>/templates</code> T\u1ea1o template m\u1edbi \u2705 <code>report.manage_templates</code> GET <code>/reports</code> L\u1ea5y k\u1ebft qu\u1ea3 b\u00e1o c\u00e1o (theo template + input) \u2705 <code>report.view_report</code> POST <code>/reports/save-config</code> L\u01b0u c\u1ea5u h\u00ecnh b\u00e1o c\u00e1o c\u00e1 nh\u00e2n h\u00f3a \u2705 <code>report.save_report_config</code> GET <code>/reports/saved-configs</code> Danh s\u00e1ch c\u1ea5u h\u00ecnh \u0111\u00e3 l\u01b0u \u2705 <code>report.view_report_config</code> <p>\ud83d\udd27 Tu\u00e2n th\u1ee7: ADR-011, ADR-012</p>"},{"location":"services/reporting-service/design/#vi-du-response-get-templates","title":"\ud83d\udce6 V\u00ed d\u1ee5 response <code>GET /templates</code>","text":"<pre><code>{\n  \"data\": [\n    {\n      \"template_id\": \"fin-summary-001\",\n      \"name\": \"T\u1ed5ng h\u1ee3p t\u00e0i ch\u00ednh theo th\u00e1ng\",\n      \"version\": 2,\n      \"input_parameters\": [\n        { \"name\": \"month\", \"type\": \"string\", \"description\": \"Th\u00e1ng b\u00e1o c\u00e1o (MM-YYYY)\" }\n      ]\n    }\n  ],\n  \"meta\": {\n    \"request_id\": \"req-123\",\n    \"timestamp\": \"2025-06-04T10:30:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/reporting-service/design/#3-mo-hinh-du-lieu-chi-tiet-data-model","title":"3. \ud83d\uddc3\ufe0f M\u00f4 h\u00ecnh d\u1eef li\u1ec7u chi ti\u1ebft (Data Model)","text":"<pre><code>erDiagram\n  ReportTemplate ||--o{ SavedReportConfig : references\n  ReportTemplate {\n    STRING template_id PK\n    STRING name\n    INT version\n    JSON input_parameters\n    STRING created_by\n    DATETIME created_at\n  }\n\n  SavedReportConfig {\n    UUID config_id PK\n    STRING template_id FK\n    STRING owner_user_id\n    JSON input_values\n    STRING name\n    DATETIME saved_at\n  }\n\n  ReportQueryLog {\n    UUID query_id PK\n    STRING user_id\n    STRING template_id\n    JSON input_used\n    DATETIME executed_at\n    FLOAT duration_seconds\n  }\n</code></pre> <p>Chi ti\u1ebft: Data Model</p>"},{"location":"services/reporting-service/design/#4-luong-xu-ly-nghiep-vu-chinh-business-logic-flows","title":"4. \ud83d\udd04 Lu\u1ed3ng x\u1eed l\u00fd nghi\u1ec7p v\u1ee5 ch\u00ednh (Business Logic Flows)","text":""},{"location":"services/reporting-service/design/#luong-sinh-bao-cao-theo-template","title":"Lu\u1ed3ng: Sinh b\u00e1o c\u00e1o theo template","text":"<pre><code>sequenceDiagram\n  participant Superadmin as SuperadminWebapp\n  participant Gateway as API Gateway\n  participant Reporting as Reporting Service\n  participant BigQuery as Data Warehouse\n\n  Superadmin-&gt;&gt;Gateway: G\u1eedi request GET /reports?template_id=...&amp;input=...\n  Gateway-&gt;&gt;Reporting: Forward request + headers\n  Reporting-&gt;&gt;BigQuery: Truy v\u1ea5n d\u1eef li\u1ec7u theo query template\n  BigQuery--&gt;&gt;Reporting: Tr\u1ea3 v\u1ec1 b\u1ea3ng k\u1ebft qu\u1ea3\n  Reporting--&gt;&gt;Gateway: Response d\u1ea1ng chu\u1ea9n ADR-012\n  Gateway--&gt;&gt;Superadmin: Hi\u1ec3n th\u1ecb d\u1eef li\u1ec7u\n</code></pre>"},{"location":"services/reporting-service/design/#5-cac-su-kien-pubsub-events","title":"5. \ud83d\udce3 C\u00e1c s\u1ef1 ki\u1ec7n Pub/Sub (Events)","text":"S\u1ef1 ki\u1ec7n nh\u1eadn/ph\u00e1t Ngu\u1ed3n ph\u00e1t / \u0110\u00edch nh\u1eadn H\u00e0nh \u0111\u1ed9ng t\u1ea1i Service n\u00e0y report.query_logged (Service n\u00e0y ph\u00e1t ra) Ghi log \u0111\u1ec3 ph\u1ee5c v\u1ee5 auditing v\u00e0 ph\u00e2n t\u00edch"},{"location":"services/reporting-service/design/#vi-du-payload","title":"\ud83d\udce6 V\u00ed d\u1ee5 Payload","text":"<pre><code>{\n  \"event_type\": \"report.query_logged\",\n  \"data\": {\n    \"template_id\": \"fin-summary-001\",\n    \"user_id\": \"admin123\",\n    \"input\": { \"month\": \"05-2025\" },\n    \"duration\": 2.45\n  },\n  \"metadata\": {\n    \"event_id\": \"evt-abc-123\",\n    \"timestamp\": \"2025-06-04T10:30:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/reporting-service/design/#6-bao-mat-phan-quyen-chi-tiet","title":"6. \ud83d\udd10 B\u1ea3o m\u1eadt &amp; Ph\u00e2n quy\u1ec1n chi ti\u1ebft","text":""},{"location":"services/reporting-service/design/#61-xac-thuc-inh-danh","title":"6.1. X\u00e1c th\u1ef1c &amp; \u0110\u1ecbnh danh","text":"<p>Reporting Service kh\u00f4ng x\u1eed l\u00fd x\u00e1c th\u1ef1c tr\u1ef1c ti\u1ebfp, m\u00e0 nh\u1eadn th\u00f4ng tin \u0111\u1ecbnh danh t\u1eeb API Gateway th\u00f4ng qua c\u00e1c HTTP headers chu\u1ea9n:</p> Header M\u00f4 t\u1ea3 <code>x-user-id</code> M\u00e3 \u0111\u1ecbnh danh duy nh\u1ea5t c\u1ee7a ng\u01b0\u1eddi d\u00f9ng <code>x-tenant-id</code> M\u00e3 \u0111\u1ecbnh danh tenant <code>x-user-role</code> Vai tr\u00f2 h\u1ec7 th\u1ed1ng (<code>superadmin</code>, <code>staff</code>,...) <code>x-auth-scope</code> N\u1ebfu d\u00f9ng OAuth2/OIDC, th\u00f4ng tin scope token <p>T\u1ea5t c\u1ea3 c\u00e1c request ph\u1ea3i \u0111i qua Gateway v\u00e0 \u0111\u01b0\u1ee3c x\u00e1c th\u1ef1c tr\u01b0\u1edbc \u0111\u00f3 b\u1edfi Auth Service.</p>"},{"location":"services/reporting-service/design/#62-kiem-soat-truy-cap-rbac","title":"6.2. Ki\u1ec3m so\u00e1t Truy c\u1eadp (RBAC)","text":"<p>M\u1ecdi API trong Reporting Service b\u1eaft bu\u1ed9c khai b\u00e1o <code>x-required-permission</code> t\u1ea1i Gateway (tu\u00e2n th\u1ee7 <code>ADR-007</code>), v\u00e0 Reporting Service s\u1ebd ki\u1ec3m tra chi ti\u1ebft quy\u1ec1n truy c\u1eadp theo logic sau:</p> H\u00e0nh \u0111\u1ed9ng <code>x-required-permission</code> Truy v\u1ea5n danh s\u00e1ch template <code>report.view_templates</code> T\u1ea1o/s\u1eeda report template <code>report.manage_templates</code> Sinh b\u00e1o c\u00e1o t\u1eeb template <code>report.view_report</code> L\u01b0u c\u1ea5u h\u00ecnh b\u00e1o c\u00e1o c\u00e1 nh\u00e2n <code>report.save_report_config</code>"},{"location":"services/reporting-service/design/#chi-tiet-hoa-kiem-soat-noi-bo","title":"\ud83c\udfaf Chi ti\u1ebft h\u00f3a ki\u1ec3m so\u00e1t n\u1ed9i b\u1ed9","text":"<p>Ngo\u00e0i <code>x-required-permission</code>, h\u1ec7 th\u1ed1ng c\u00f2n \u00e1p d\u1ee5ng:</p> <ul> <li>\u2705 Ki\u1ec3m tra <code>tenant_id</code> c\u1ee7a template kh\u1edbp v\u1edbi context ng\u01b0\u1eddi d\u00f9ng</li> <li>\u2705 Ki\u1ec3m tra <code>owner_user_id</code> cho Saved Config \u0111\u1ec3 tr\u00e1nh truy c\u1eadp ch\u00e9o</li> <li>\u2705 (T\u00f9y ch\u1ecdn) G\u1eafn permission ri\u00eang cho t\u1eebng <code>template_id</code> trong metadata, cho ph\u00e9p RBAC theo b\u00e1o c\u00e1o c\u1ee5 th\u1ec3</li> </ul>"},{"location":"services/reporting-service/design/#63-masking-thong-tin-au-vao-nhat-ky-truy-van","title":"6.3. Masking th\u00f4ng tin \u0111\u1ea7u v\u00e0o &amp; Nh\u1eadt k\u00fd truy v\u1ea5n","text":"<ul> <li>Tr\u01b0\u1eddng <code>input_values</code> trong b\u1ea3ng <code>SavedReportConfig</code> ho\u1eb7c event log s\u1ebd \u0111\u01b0\u1ee3c mask m\u1ed9t ph\u1ea7n ho\u1eb7c to\u00e0n b\u1ed9 n\u1ebfu ch\u1ee9a th\u00f4ng tin nh\u1ea1y c\u1ea3m.</li> <li>Vi\u1ec7c masking tu\u00e2n th\u1ee7 <code>ADR-024 - Data Anonymization &amp; Retention</code>.</li> <li>Tr\u01b0\u1eddng h\u1ee3p v\u00ed d\u1ee5 c\u1ea7n masking: m\u00e3 s\u1ed1 h\u1ecdc sinh, s\u1ed1 \u0111i\u1ec7n tho\u1ea1i, email...</li> </ul>"},{"location":"services/reporting-service/design/#64-kiem-soat-api-template-oc-hai","title":"6.4. Ki\u1ec3m so\u00e1t API Template \u0111\u1ed9c h\u1ea1i","text":"<ul> <li>C\u00e1c query template \u0111\u01b0\u1ee3c ki\u1ec3m duy\u1ec7t th\u1ee7 c\u00f4ng b\u1edfi Superadmin ho\u1eb7c s\u1eed d\u1ee5ng tr\u00ecnh ki\u1ec3m tra \u0111\u1ecbnh d\u1ea1ng query \u0111\u1ec3 tr\u00e1nh truy v\u1ea5n t\u1ed1n chi ph\u00ed ho\u1eb7c g\u00e2y l\u1ed7i.</li> <li>C\u00e1c API c\u00f3 c\u1ea5u tr\u00fac \u0111\u1ed9ng (nh\u01b0 <code>/reports?template_id=...</code>) b\u1eaft bu\u1ed9c ph\u1ea3i ki\u1ec3m tra input theo <code>validation_rules</code> \u0111\u1ecbnh ngh\u0129a s\u1eb5n trong template.</li> </ul>"},{"location":"services/reporting-service/design/#7-cau-hinh-bien-moi-truong","title":"7. \u2699\ufe0f C\u1ea5u h\u00ecnh &amp; Bi\u1ebfn m\u00f4i tr\u01b0\u1eddng","text":""},{"location":"services/reporting-service/design/#71-cac-bien-moi-truong-chinh","title":"7.1. C\u00e1c bi\u1ebfn m\u00f4i tr\u01b0\u1eddng ch\u00ednh","text":"Bi\u1ebfn m\u00f4i tr\u01b0\u1eddng M\u00f4 t\u1ea3 <code>ENV</code> M\u00f4i tr\u01b0\u1eddng tri\u1ec3n khai (<code>development</code>, <code>staging</code>, <code>production</code>) <code>PORT</code> C\u1ed5ng service s\u1ebd l\u1eafng nghe <code>BQ_PROJECT_ID</code> GCP project ch\u1ee9a BigQuery <code>BQ_DATASET_NAME</code> T\u00ean dataset m\u1eb7c \u0111\u1ecbnh \u0111\u1ec3 query d\u1eef li\u1ec7u <code>TEMPLATE_STORAGE_BUCKET</code> GCS bucket d\u00f9ng \u0111\u1ec3 l\u01b0u tr\u1eef template (n\u1ebfu c\u00f3 d\u1ea1ng file) <code>PUBSUB_TOPIC_REPORT_LOG</code> T\u00ean topic Pub/Sub \u0111\u1ec3 ph\u00e1t s\u1ef1 ki\u1ec7n sinh b\u00e1o c\u00e1o <code>REDIS_URI</code> URI k\u1ebft n\u1ed1i Redis (d\u00f9ng \u0111\u1ec3 cache metadata template ho\u1eb7c token RBAC) <code>JWT_PUBLIC_KEY_URL</code> URL \u0111\u1ebfn public key d\u00f9ng \u0111\u1ec3 x\u00e1c th\u1ef1c JWT t\u1eeb API Gateway <code>LOG_LEVEL</code> M\u1ee9c \u0111\u1ed9 log (<code>DEBUG</code>, <code>INFO</code>, <code>WARNING</code>, <code>ERROR</code>) <code>TRACING_ENABLED</code> B\u1eadt/t\u1eaft tracing (gi\u00e1m s\u00e1t) v\u1edbi OpenTelemetry <code>MAX_QUERY_TIMEOUT_SEC</code> Timeout t\u1ed1i \u0111a cho m\u1ed7i truy v\u1ea5n BigQuery"},{"location":"services/reporting-service/design/#72-quan-ly-cau-hinh-runtime","title":"7.2. Qu\u1ea3n l\u00fd c\u1ea5u h\u00ecnh runtime","text":"<p>Reporting Service s\u1eed d\u1ee5ng th\u01b0 vi\u1ec7n <code>dynaconf</code> (ho\u1eb7c <code>pydantic.BaseSettings</code>) \u0111\u1ec3 load bi\u1ebfn t\u1eeb:</p> <ul> <li>\u2705 <code>.env</code> file trong local dev</li> <li>\u2705 Secret Manager (ho\u1eb7c runtime Env Vars) trong production</li> <li>\u2705 GCS config file (t\u00f9y ch\u1ecdn m\u1edf r\u1ed9ng trong t\u01b0\u01a1ng lai)</li> </ul>"},{"location":"services/reporting-service/design/#73-cau-hinh-cache","title":"7.3. C\u1ea5u h\u00ecnh cache","text":"<ul> <li>Redis \u0111\u01b0\u1ee3c d\u00f9ng \u0111\u1ec3 cache:</li> <li>\u2705 Metadata c\u00e1c <code>Report Template</code></li> <li>\u2705 Th\u00f4ng tin RBAC \u0111\u00e3 \u0111\u01b0\u1ee3c resolve (token \u2192 permission list)</li> <li>\u2705 (T\u00f9y ch\u1ecdn) Cached query result (n\u1ebfu query \u0111\u1eaft gi\u00e1 v\u00e0 l\u1eb7p l\u1ea1i)</li> <li>TTL m\u1eb7c \u0111\u1ecbnh: 5\u201310 ph\u00fat t\u00f9y lo\u1ea1i, c\u00f3 th\u1ec3 c\u1ea5u h\u00ecnh qua ENV</li> </ul>"},{"location":"services/reporting-service/design/#74-cau-hinh-bao-ve-truy-van","title":"7.4. C\u1ea5u h\u00ecnh b\u1ea3o v\u1ec7 truy v\u1ea5n","text":"<ul> <li>C\u1ea5u h\u00ecnh gi\u1edbi h\u1ea1n:</li> <li>Th\u1eddi gian t\u1ed1i \u0111a th\u1ef1c thi truy v\u1ea5n (configurable)</li> <li>K\u00edch th\u01b0\u1edbc t\u1ed1i \u0111a result set</li> <li>S\u1ed1 d\u00f2ng t\u1ed1i \u0111a cho export</li> </ul>"},{"location":"services/reporting-service/design/#8-chien-luoc-kiem-thu","title":"8. \ud83e\uddea Chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed","text":""},{"location":"services/reporting-service/design/#81-cac-lop-kiem-thu","title":"8.1. C\u00e1c l\u1edbp ki\u1ec3m th\u1eed","text":"<p>Reporting Service \u0111\u01b0\u1ee3c ki\u1ec3m th\u1eed theo nhi\u1ec1u l\u1edbp \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o ch\u1ea5t l\u01b0\u1ee3ng v\u00e0 t\u00ednh tin c\u1eady:</p> L\u1edbp ki\u1ec3m th\u1eed M\u00f4 t\u1ea3 Unit Test Ki\u1ec3m th\u1eed t\u1eebng h\u00e0m x\u1eed l\u00fd (template parser, RBAC validator, cache layer) Integration Test Ki\u1ec3m th\u1eed v\u1edbi BigQuery mock ho\u1eb7c dataset th\u1eed nghi\u1ec7m, ki\u1ec3m tra end-to-end Contract Test Ki\u1ec3m th\u1eed tu\u00e2n th\u1ee7 Interface Contract v\u00e0 \u0111\u1ecbnh d\u1ea1ng ph\u1ea3n h\u1ed3i (ADR-011/012) RBAC Rule Test Ki\u1ec3m tra vi\u1ec7c t\u1eeb ch\u1ed1i truy c\u1eadp n\u1ebfu kh\u00f4ng c\u00f3 quy\u1ec1n ph\u00f9 h\u1ee3p (403) Template Validation Ki\u1ec3m tra logic ki\u1ec3m so\u00e1t <code>input_parameters</code>, <code>query_template</code>, <code>x-required-permission</code>"},{"location":"services/reporting-service/design/#82-mo-phong-bigquery-pubsub","title":"8.2. M\u00f4 ph\u1ecfng BigQuery &amp; Pub/Sub","text":"<ul> <li>\u2705 S\u1eed d\u1ee5ng <code>BigQuery Emulator</code> ho\u1eb7c dataset test ri\u00eang (n\u1ebfu emu kh\u00f4ng h\u1ed7 tr\u1ee3 \u0111\u1ee7 t\u00ednh n\u0103ng)</li> <li>\u2705 D\u00f9ng th\u01b0 vi\u1ec7n <code>google-cloud-pubsub</code> v\u1edbi mock/subscription gi\u1ea3 l\u1eadp \u0111\u1ec3 ki\u1ec3m th\u1eed fanout</li> <li>\u2705 Redis s\u1eed d\u1ee5ng test instance ho\u1eb7c <code>fakeredis</code> trong unit test</li> </ul>"},{"location":"services/reporting-service/design/#83-kiem-thu-template-ong","title":"8.3. Ki\u1ec3m th\u1eed Template \u0111\u1ed9ng","text":"<ul> <li>B\u1ed9 ki\u1ec3m th\u1eed \u0111\u1eb7c bi\u1ec7t v\u1edbi nhi\u1ec1u m\u1eabu template:</li> <li>V\u1edbi input thi\u1ebfu, sai \u0111\u1ecbnh d\u1ea1ng</li> <li>V\u1edbi query template l\u1ed7i c\u00fa ph\u00e1p</li> <li>V\u1edbi quy\u1ec1n truy c\u1eadp kh\u00f4ng \u0111\u1ee7</li> <li>V\u1edbi input ch\u1ee9a d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m (\u0111\u1ec3 ki\u1ec3m tra masking)</li> </ul>"},{"location":"services/reporting-service/design/#84-bao-cao-va-coverage","title":"8.4. B\u00e1o c\u00e1o v\u00e0 Coverage","text":"<ul> <li>C\u00f4ng c\u1ee5: <code>pytest</code>, <code>coverage</code>, <code>tox</code></li> <li>Target coverage:</li> <li> <p>90% cho logic business</p> </li> <li>100% cho RBAC ki\u1ec3m tra ch\u00e9o</li> <li>B\u00e1o c\u00e1o coverage t\u00edch h\u1ee3p trong GitHub Actions (workflow CI/CD)</li> </ul>"},{"location":"services/reporting-service/design/#85-load-test-cho-truy-van-phuc-tap","title":"8.5. Load Test (cho truy v\u1ea5n ph\u1ee9c t\u1ea1p)","text":"<ul> <li>S\u1eed d\u1ee5ng <code>Locust</code> ho\u1eb7c <code>k6</code> \u0111\u1ec3 m\u00f4 ph\u1ecfng truy v\u1ea5n \u0111\u1ed3ng th\u1eddi t\u1eeb Superadmin Webapp</li> <li>K\u1ecbch b\u1ea3n test bao g\u1ed3m:</li> <li>Truy v\u1ea5n c\u00f9ng l\u00fac nhi\u1ec1u b\u00e1o c\u00e1o c\u00f3 range l\u1edbn</li> <li>Truy v\u1ea5n v\u1edbi c\u1ea5u h\u00ecnh filter ph\u1ee9c t\u1ea1p</li> <li>L\u1eb7p l\u1ea1i truy v\u1ea5n \u0111\u1ec3 test caching</li> </ul>"},{"location":"services/reporting-service/design/#9-quan-sat-giam-sat","title":"9. \ud83d\udcc8 Quan s\u00e1t &amp; Gi\u00e1m s\u00e1t","text":""},{"location":"services/reporting-service/design/#91-logging","title":"9.1. Logging","text":"<ul> <li>T\u1ea5t c\u1ea3 truy v\u1ea5n \u0111\u1ebfn Reporting Service \u0111\u1ec1u \u0111\u01b0\u1ee3c log v\u1edbi c\u00e1c th\u00f4ng tin:</li> <li><code>user_id</code>, <code>tenant_id</code>, <code>template_id</code>, <code>query_duration</code>, <code>row_count</code></li> <li><code>status</code>: <code>success</code>, <code>validation_error</code>, <code>permission_denied</code>, <code>bq_error</code>, ...</li> <li>Log \u0111\u1ecbnh d\u1ea1ng JSON, tu\u00e2n th\u1ee7 <code>ADR-008 - Audit Logging</code></li> <li>Log nh\u1ea1y c\u1ea3m s\u1ebd \u0111\u01b0\u1ee3c masking (tu\u00e2n th\u1ee7 <code>ADR-024</code>)</li> <li>G\u1eedi log v\u1ec1 Stackdriver Logging (GCP) ho\u1eb7c ELK (tu\u1ef3 m\u00f4i tr\u01b0\u1eddng)</li> </ul>"},{"location":"services/reporting-service/design/#92-metric-monitoring","title":"9.2. Metric &amp; Monitoring","text":"<ul> <li> <p>H\u1ec7 th\u1ed1ng xu\u1ea5t Prometheus metrics:   | Metric                          | Nh\u00e3n                        | M\u00f4 t\u1ea3                                              |   |----------------------------------|------------------------------|----------------------------------------------------|   | <code>report_query_duration_seconds</code> | <code>template_id</code>, <code>status</code>     | Th\u1eddi gian truy v\u1ea5n BigQuery                       |   | <code>report_query_count_total</code>      | <code>status</code>, <code>template_id</code>     | T\u1ed5ng s\u1ed1 l\u1ea7n truy v\u1ea5n                              |   | <code>report_template_cache_hit</code>     | <code>template_id</code>               | S\u1ed1 l\u1ea7n cache metadata template \u0111\u01b0\u1ee3c d\u00f9ng          |   | <code>report_result_cache_hit</code>       | <code>template_id</code>               | (tu\u1ef3 ch\u1ecdn) s\u1ed1 l\u1ea7n k\u1ebft qu\u1ea3 query \u0111\u01b0\u1ee3c d\u00f9ng l\u1ea1i     |   | <code>rbac_denied_total</code>             | <code>permission_code</code>           | S\u1ed1 l\u1ea7n b\u1ecb t\u1eeb ch\u1ed1i do thi\u1ebfu quy\u1ec1n truy c\u1eadp         |</p> </li> <li> <p>T\u00edch h\u1ee3p v\u1edbi Grafana \u0111\u1ec3 gi\u00e1m s\u00e1t realtime</p> </li> </ul>"},{"location":"services/reporting-service/design/#93-tracing","title":"9.3. Tracing","text":"<ul> <li>H\u1ed7 tr\u1ee3 OpenTelemetry (<code>trace_id</code>, <code>span_id</code>) g\u1eafn v\u00e0o t\u1ea5t c\u1ea3 log v\u00e0 response</li> <li>Truy v\u1ebft to\u00e0n b\u1ed9 pipeline t\u1eeb Superadmin \u2192 Gateway \u2192 Reporting Service \u2192 BigQuery</li> </ul>"},{"location":"services/reporting-service/design/#94-alerting","title":"9.4. Alerting","text":"<ul> <li>C\u00e1c c\u1ea3nh b\u00e1o \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh cho:</li> <li>Truy v\u1ea5n ch\u1eadm b\u1ea5t th\u01b0\u1eddng</li> <li>T\u0103ng \u0111\u1ed9t bi\u1ebfn l\u1ed7i truy v\u1ea5n ho\u1eb7c l\u1ed7i quy\u1ec1n truy c\u1eadp</li> <li> <p>Cache miss rate qu\u00e1 cao</p> </li> <li> <p>C\u1ea3nh b\u00e1o \u0111\u01b0\u1ee3c g\u1eedi qua Slack/Webhook, theo ng\u01b0\u1ee1ng c\u1ea5u h\u00ecnh</p> </li> </ul>"},{"location":"services/reporting-service/design/#10-o-tin-cay-phuc-hoi","title":"10. \ud83d\ude80 \u0110\u1ed9 tin c\u1eady &amp; Ph\u1ee5c h\u1ed3i","text":""},{"location":"services/reporting-service/design/#101-phan-lop-loi-thong-bao-loi","title":"10.1. Ph\u00e2n l\u1edbp l\u1ed7i &amp; th\u00f4ng b\u00e1o l\u1ed7i","text":"<ul> <li>M\u1ecdi l\u1ed7i \u0111\u1ec1u \u0111\u01b0\u1ee3c chu\u1ea9n h\u00f3a theo \u0111\u1ecbnh d\u1ea1ng <code>ADR-011</code>.</li> <li>Ph\u00e2n lo\u1ea1i l\u1ed7i:</li> <li><code>400 Bad Request</code>: Input sai format, thi\u1ebfu tham s\u1ed1</li> <li><code>403 Forbidden</code>: Kh\u00f4ng \u0111\u1ee7 quy\u1ec1n (RBAC)</li> <li><code>404 Not Found</code>: Template ID kh\u00f4ng t\u1ed3n t\u1ea1i ho\u1eb7c kh\u00f4ng thu\u1ed9c quy\u1ec1n truy c\u1eadp</li> <li><code>429 Too Many Requests</code>: Qu\u00e1 gi\u1edbi h\u1ea1n truy v\u1ea5n \u0111\u1ecbnh k\u1ef3</li> <li><code>500 Internal Error</code>: L\u1ed7i h\u1ec7 th\u1ed1ng (BigQuery, Redis, etc.)</li> </ul>"},{"location":"services/reporting-service/design/#102-kha-nang-phuc-hoi-khi-mat-dich-vu-phu-tro","title":"10.2. Kh\u1ea3 n\u0103ng ph\u1ee5c h\u1ed3i khi m\u1ea5t d\u1ecbch v\u1ee5 ph\u1ee5 tr\u1ee3","text":"Th\u00e0nh ph\u1ea7n ph\u1ee5 tr\u1ee3 Ph\u1ea3n \u1ee9ng c\u1ee7a h\u1ec7 th\u1ed1ng Redis T\u1ef1 \u0111\u1ed9ng reconnect. N\u1ebfu l\u1ed7i, fallback sang truy v\u1ea5n g\u1ed1c BigQuery C\u00f3 retry strategy cho l\u1ed7i t\u1ea1m th\u1eddi. Ghi log n\u1ebfu th\u1ea5t b\u1ea1i GCS (template) N\u1ebfu DB l\u1ed7i, fallback sang b\u1ea3n cache GCS n\u1ebfu c\u00f3 Pub/Sub Ghi \u0111\u1ec7m s\u1ef1 ki\u1ec7n v\u00e0 retry theo batch n\u1ebfu m\u1ea5t k\u1ebft n\u1ed1i"},{"location":"services/reporting-service/design/#103-xu-ly-tinh-huong-truy-van-ton-tai-nguyen","title":"10.3. X\u1eed l\u00fd t\u00ecnh hu\u1ed1ng truy v\u1ea5n t\u1ed1n t\u00e0i nguy\u00ean","text":"<ul> <li>M\u1ed7i template \u0111\u1ec1u c\u00f3 metadata \u0111\u1ec3 gi\u1edbi h\u1ea1n:</li> <li>Maximum bytes billed</li> <li>Timeout per query</li> <li>S\u1ed1 d\u00f2ng k\u1ebft qu\u1ea3 tr\u1ea3 v\u1ec1 (limit)</li> <li>K\u1ebft h\u1ee3p v\u1edbi caching \u0111\u1ec3 gi\u1ea3m t\u1ea3i khi nhi\u1ec1u ng\u01b0\u1eddi d\u00f9ng truy v\u1ea5n tr\u00f9ng n\u1ed9i dung</li> </ul>"},{"location":"services/reporting-service/design/#104-kiem-soat-tai-nguyen-gioi-han-truy-cap","title":"10.4. Ki\u1ec3m so\u00e1t t\u00e0i nguy\u00ean &amp; gi\u1edbi h\u1ea1n truy c\u1eadp","text":"<ul> <li>S\u1eed d\u1ee5ng token bucket rate limiter (tu\u1ef3 ch\u1ecdn, t\u00edch h\u1ee3p t\u1ea1i Gateway)</li> <li>Truy v\u1ea5n qu\u00e1 m\u1ee9c \u0111\u01b0\u1ee3c tr\u1ea3 v\u1ec1 <code>429</code> v\u00e0 log l\u1ea1i</li> </ul>"},{"location":"services/reporting-service/design/#105-graceful-shutdown-deployment-safe","title":"10.5. Graceful shutdown &amp; Deployment safe","text":"<ul> <li>Tri\u1ec3n khai theo rolling update</li> <li>K\u1ebft h\u1ee3p readiness probe \u0111\u1ec3 ng\u0103n nh\u1eadn request khi ch\u01b0a s\u1eb5n s\u00e0ng</li> <li>Ghi log m\u1ecdi t\u00ecnh hu\u1ed1ng shutdown ho\u1eb7c l\u1ed7i g\u00f3i g\u1ecdn trong <code>trace_id</code></li> </ul>"},{"location":"services/reporting-service/design/#11-hieu-nang-mo-rong","title":"11. \u26a1\ufe0f Hi\u1ec7u n\u0103ng &amp; M\u1edf r\u1ed9ng","text":""},{"location":"services/reporting-service/design/#111-caching-chien-luoc","title":"11.1. Caching chi\u1ebfn l\u01b0\u1ee3c","text":"<ul> <li>Metadata Caching (Redis):</li> <li>C\u00e1c th\u00f4ng tin \u0111\u01b0\u1ee3c cache:<ul> <li>Danh s\u00e1ch <code>report_templates</code></li> <li>Chi ti\u1ebft <code>input_parameters</code> c\u1ee7a m\u1ed7i template</li> <li>RBAC token \u0111\u00e3 resolve (danh s\u00e1ch permission ng\u01b0\u1eddi d\u00f9ng)</li> </ul> </li> <li> <p>TTL: 5\u201310 ph\u00fat, ho\u1eb7c cache theo tenant</p> </li> <li> <p>Query Result Caching (tu\u1ef3 ch\u1ecdn):</p> </li> <li>Nh\u1eefng b\u00e1o c\u00e1o th\u01b0\u1eddng xuy\u00ean truy v\u1ea5n l\u1eb7p (theo tenant + template + input) s\u1ebd \u0111\u01b0\u1ee3c cache</li> <li>TTL t\u00f9y theo t\u1ea7n su\u1ea5t truy c\u1eadp, th\u01b0\u1eddng 60\u2013300s</li> </ul>"},{"location":"services/reporting-service/design/#112-scale-ngang-de-dang","title":"11.2. Scale ngang d\u1ec5 d\u00e0ng","text":"<ul> <li>Reporting Service l\u00e0 stateless, d\u1ec5 d\u00e0ng scale b\u1eb1ng Kubernetes ho\u1eb7c Cloud Run</li> <li>Redis v\u00e0 BigQuery \u0111\u1ec1u h\u1ed7 tr\u1ee3 truy c\u1eadp song song t\u1eeb nhi\u1ec1u instance</li> </ul>"},{"location":"services/reporting-service/design/#113-gioi-han-truy-van-quota","title":"11.3. Gi\u1edbi h\u1ea1n truy v\u1ea5n &amp; quota","text":"<ul> <li>Gi\u1edbi h\u1ea1n k\u00edch th\u01b0\u1edbc d\u1eef li\u1ec7u c\u00f3 th\u1ec3 truy v\u1ea5n m\u1ed7i l\u1ea7n (bytes billed)</li> <li>Gi\u1edbi h\u1ea1n th\u1eddi gian x\u1eed l\u00fd truy v\u1ea5n</li> <li>Gi\u1edbi h\u1ea1n s\u1ed1 l\u01b0\u1ee3ng d\u00f2ng tr\u1ea3 v\u1ec1</li> <li>T\u00f9y ch\u1ec9nh theo <code>template_type</code> ho\u1eb7c g\u00e1n theo <code>tier</code> c\u1ee7a tenant</li> </ul>"},{"location":"services/reporting-service/design/#114-horizontal-sharding-tuong-lai","title":"11.4. Horizontal sharding (t\u01b0\u01a1ng lai)","text":"<ul> <li>Khi s\u1ed1 l\u01b0\u1ee3ng tenant l\u1edbn, c\u00f3 th\u1ec3 t\u00e1ch template, config, audit log ra theo shard</li> <li>C\u00f3 th\u1ec3 s\u1eed d\u1ee5ng BigQuery <code>dataset per tenant</code> ho\u1eb7c filter tr\u00ean tr\u01b0\u1eddng <code>tenant_id</code></li> </ul>"},{"location":"services/reporting-service/design/#115-du-phong-su-co-high-availability","title":"11.5. D\u1ef1 ph\u00f2ng s\u1ef1 c\u1ed1 (High Availability)","text":"<ul> <li>D\u1eef li\u1ec7u template c\u00f3 backup \u0111\u1ecbnh k\u1ef3 tr\u00ean GCS</li> <li>Health check Redis, Pub/Sub, BigQuery \u0111\u1ecbnh k\u1ef3 \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o truy c\u1eadp \u1ed5n \u0111\u1ecbnh</li> <li>C\u1ea3nh b\u00e1o real-time n\u1ebfu t\u1ef7 l\u1ec7 l\u1ed7i t\u0103ng ho\u1eb7c th\u1eddi gian truy v\u1ea5n t\u0103ng b\u1ea5t th\u01b0\u1eddng</li> </ul>"},{"location":"services/reporting-service/design/#12-ke-hoach-trien-khai-migration","title":"12. \ud83d\udee0 K\u1ebf ho\u1ea1ch Tri\u1ec3n khai &amp; Migration","text":""},{"location":"services/reporting-service/design/#121-giai-oan-1-mvp-noi-bo","title":"12.1. Giai \u0111o\u1ea1n 1 \u2013 MVP n\u1ed9i b\u1ed9","text":"<ul> <li>\u2705 X\u00e2y d\u1ef1ng core Reporting Service v\u1edbi API <code>/reports/query</code>, <code>/reports/templates</code></li> <li>\u2705 S\u1eed d\u1ee5ng m\u1ed9t s\u1ed1 report template c\u1ed1 \u0111\u1ecbnh (t\u1eeb file JSON)</li> <li>\u2705 Ch\u1ea1y truy v\u1ea5n tr\u00ean BigQuery test dataset</li> <li>\u2705 T\u00edch h\u1ee3p v\u1edbi API Gateway, Superadmin Webapp (phi\u00ean b\u1ea3n th\u00f4)</li> <li>\u2705 Logging truy v\u1ea5n, RBAC c\u01a1 b\u1ea3n</li> <li>\u26a0\ufe0f Ch\u01b0a c\u00f3 caching ho\u1eb7c template dynamic</li> </ul>"},{"location":"services/reporting-service/design/#122-giai-oan-2-dynamic-templates-metadata","title":"12.2. Giai \u0111o\u1ea1n 2 \u2013 Dynamic Templates &amp; Metadata","text":"<ul> <li>\u2705 Chuy\u1ec3n storage template sang Cloud SQL/PostgreSQL</li> <li>\u2705 API <code>/reports/templates/:id</code> ho\u1ea1t \u0111\u1ed9ng v\u1edbi metadata \u0111\u1ed9ng</li> <li>\u2705 C\u01a1 ch\u1ebf validate input + permission check \u0111\u1ed9ng</li> <li>\u2705 Redis caching cho template &amp; RBAC</li> <li>\u2705 B\u1ed5 sung audit log cho m\u1ed7i truy v\u1ea5n (tu\u00e2n theo ADR-008)</li> </ul>"},{"location":"services/reporting-service/design/#123-giai-oan-3-production-ready-phan-quyen-nang-cao","title":"12.3. Giai \u0111o\u1ea1n 3 \u2013 Production-ready &amp; Ph\u00e2n quy\u1ec1n n\u00e2ng cao","text":"<ul> <li>\u2705 RBAC theo t\u1eebng template (<code>x-required-permission</code>)</li> <li>\u2705 Giao di\u1ec7n c\u1ea5u h\u00ecnh &amp; t\u1ea1o template (trong Superadmin Webapp)</li> <li>\u2705 API <code>/reports/saved-configs</code> (optional)</li> <li>\u2705 Alert &amp; dashboard monitoring</li> <li>\u2705 K\u1ecbch b\u1ea3n retry/resilience/timeout ho\u00e0n thi\u1ec7n</li> </ul>"},{"location":"services/reporting-service/design/#124-giai-oan-4-toi-uu-hoa-chuan-bi-cho-ai","title":"12.4. Giai \u0111o\u1ea1n 4 \u2013 T\u1ed1i \u01b0u h\u00f3a &amp; Chu\u1ea9n b\u1ecb cho AI","text":"<ul> <li>\u2705 Chu\u1ea9n h\u00f3a metadata template theo ADR-029</li> <li>\u2705 Index query performance trong BigQuery</li> <li>\u2705 C\u1ea5u tr\u00fac schema dataset BigQuery cho AI agent d\u1ec5 truy c\u1eadp</li> <li>\u2705 Export log + truy v\u1ea5n ra GCS l\u00e0m training data (n\u1ebfu c\u1ea7n)</li> <li>\u2705 Th\u1eed nghi\u1ec7m AI Agent v\u1edbi m\u1ed9t s\u1ed1 c\u00e2u h\u1ecfi truy v\u1ea5n \u0111\u01a1n gi\u1ea3n</li> </ul>"},{"location":"services/reporting-service/design/#125-migration-du-lieu","title":"12.5. Migration d\u1eef li\u1ec7u","text":"<ul> <li>\u2705 N\u1ebfu tr\u01b0\u1edbc \u0111\u00f3 c\u00f3 template d\u1ea1ng file JSON (static), vi\u1ebft tool migrate sang schema m\u1edbi</li> <li>\u2705 \u0110\u1ed3ng b\u1ed9 t\u1eeb GCS \u2192 PostgreSQL theo batch</li> </ul>"},{"location":"services/reporting-service/design/#13-kien-truc-service","title":"13. \ud83e\udde9 Ki\u1ebfn tr\u00fac Service","text":"<p>Reporting Service \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf v\u1edbi c\u00e1c th\u00e0nh ph\u1ea7n logic ri\u00eang bi\u1ec7t, theo h\u01b0\u1edbng m\u00f4-\u0111un h\u00f3a \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o d\u1ec5 b\u1ea3o tr\u00ec v\u00e0 m\u1edf r\u1ed9ng. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 s\u01a1 \u0111\u1ed3 t\u1ed5ng qu\u00e1t c\u00e1c module ch\u00ednh:</p> <pre><code>flowchart TD\n    A[Request Router]\n    A --&gt; B[AuthContext Resolver]\n    B --&gt; C[RBACValidator]\n    C --&gt; D[TemplateManager]\n    D --&gt; E[InputValidator]\n    E --&gt; F[QueryGenerator]\n    F --&gt; G[BigQueryClient]\n    G --&gt; H[ResponseFormatter]\n\n    subgraph Cache\n      C1[RBAC Token Cache]\n      C2[Template Metadata Cache]\n      C3[Query Result Cache - optional]\n    end\n\n    D &lt;---&gt; C2\n    C &lt;---&gt; C1\n    F --&gt; C3\n    C3 --&gt; H\n</code></pre>"},{"location":"services/reporting-service/design/#thanh-phan-chi-tiet","title":"Th\u00e0nh ph\u1ea7n chi ti\u1ebft","text":"Module Vai tr\u00f2 ch\u00ednh <code>AuthContextResolver</code> Tr\u00edch xu\u1ea5t <code>user_id</code>, <code>tenant_id</code>, v\u00e0 <code>permissions</code> t\u1eeb token JWT ho\u1eb7c API Gateway <code>RBACValidator</code> Ki\u1ec3m tra quy\u1ec1n truy c\u1eadp d\u1ef1a tr\u00ean <code>x-required-permission</code> t\u1eeb report template <code>TemplateManager</code> T\u1ea3i template t\u1eeb DB/cache, validate version v\u00e0 tr\u1ea1ng th\u00e1i active <code>InputValidator</code> Ki\u1ec3m tra <code>input_parameters</code> d\u1ef1a tr\u00ean schema template (type, format, required, etc.) <code>QueryGenerator</code> Render SQL query t\u1eeb <code>query_template</code> v\u00e0 <code>input_parameters</code> \u0111\u00e3 validate <code>BigQueryClient</code> G\u1eedi truy v\u1ea5n t\u1edbi BigQuery, gi\u1edbi h\u1ea1n chi ph\u00ed/time, x\u1eed l\u00fd l\u1ed7i, retry <code>ResponseFormatter</code> Chu\u1ea9n h\u00f3a k\u1ebft qu\u1ea3 tr\u1ea3 v\u1ec1 theo ADR-012, th\u00eam metadata (trace_id, timestamp) <code>CacheManager</code> Qu\u1ea3n l\u00fd c\u00e1c l\u1edbp cache: permission, template metadata, query result (optional)"},{"location":"services/reporting-service/design/#iem-mo-rong","title":"\u0110i\u1ec3m m\u1edf r\u1ed9ng","text":"<ul> <li>C\u00e1c module c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c g\u1ecdi \u0111\u1ed9c l\u1eadp \u0111\u1ec3 ph\u1ee5c v\u1ee5 c\u00e1c API kh\u00e1c nhau (<code>/query</code>, <code>/templates</code>, <code>/validate</code>, v.v.)</li> <li>C\u1ea5u tr\u00fac module t\u00e1ch bi\u1ec7t cho ph\u00e9p d\u1ec5 d\u00e0ng vi\u1ebft unit test v\u00e0 mock t\u1eebng ph\u1ea7n</li> <li>C\u00e1c b\u01b0\u1edbc x\u1eed l\u00fd \u0111\u1ec1u sinh <code>trace_id</code> v\u00e0 log chi ti\u1ebft \u0111\u1ec3 ph\u1ee5c v\u1ee5 observability</li> </ul>"},{"location":"services/reporting-service/design/#14-tai-lieu-lien-quan","title":"14. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Interface Contract</li> <li>Data Model</li> <li>OpenAPI Spec</li> <li>ADR-006 - Auth Strategy</li> <li>ADR-007 - RBAC</li> <li>ADR-008 - Audit Logging</li> <li>ADR-011 - API Error Format</li> <li>ADR-012 - Response Structure</li> <li>ADR-024 - Data Anonymization &amp; Retention</li> <li>ADR-028 - Reporting Architecture</li> <li>ADR-029 - Report Template Schema</li> <li>ADR-030 - Event Schema Governance</li> </ul>"},{"location":"services/reporting-service/interface-contract/","title":"\ud83d\udcd8 Reporting Service \u2013 Interface Contract","text":"<ul> <li>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 c\u00e1c API ch\u00ednh m\u00e0 Reporting Service cung c\u1ea5p, ph\u1ee5c v\u1ee5 nhu c\u1ea7u b\u00e1o c\u00e1o ph\u00e2n t\u00edch to\u00e0n h\u1ec7 th\u1ed1ng.</li> <li>Ph\u1ea1m vi (Scope):   Reporting Service cho ph\u00e9p Superadmin Webapp v\u00e0 c\u00e1c AI Agent truy v\u1ea5n c\u00e1c b\u00e1o c\u00e1o \u0111\u00e3 \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a qua Report Template, qu\u1ea3n l\u00fd Template v\u00e0 c\u00e1c c\u1ea5u h\u00ecnh b\u00e1o c\u00e1o \u0111\u00e3 l\u01b0u. Service kh\u00f4ng tr\u1ef1c ti\u1ebfp x\u1eed l\u00fd pipeline ETL hay ghi d\u1eef li\u1ec7u v\u00e0o Data Warehouse, m\u00e0 ch\u1ec9 t\u01b0\u01a1ng t\u00e1c d\u1ea1ng read/query.</li> </ul> <p>\ud83e\udded Nguy\u00ean t\u1eafc chung (General Principles): - T\u1ea5t c\u1ea3 API y\u00eau c\u1ea7u <code>Authorization: Bearer &lt;JWT&gt;</code>. - Header <code>X-Tenant-ID</code> \u0111\u01b0\u1ee3c y\u00eau c\u1ea7u cho m\u1ecdi request. - Header <code>X-Request-ID</code> \u0111\u01b0\u1ee3c sinh ra v\u00e0 tr\u1ea3 v\u1ec1 trong response \u0111\u1ec3 h\u1ed7 tr\u1ee3 trace. - C\u00e1c response theo chu\u1ea9n ADR-012 Response Structure. - C\u00e1c l\u1ed7i theo chu\u1ea9n ADR-011 Error Format. - T\u1ea5t c\u1ea3 response d\u1ea1ng <code>GET</code> l\u00e0 d\u1ea1ng <code>cached</code>, n\u1ebfu c\u00f3 <code>ETag</code> \u0111\u01b0\u1ee3c tr\u1ea3 v\u1ec1 th\u00ec n\u00ean d\u00f9ng <code>If-None-Match</code> \u0111\u1ec3 gi\u1ea3m t\u1ea3i.</p>"},{"location":"services/reporting-service/interface-contract/#2-tom-tat-endpoint-http-method","title":"2. \ud83d\udccc T\u00f3m t\u1eaft Endpoint &amp; HTTP Method","text":"Method Endpoint M\u00f4 t\u1ea3 ng\u1eafn Ph\u00e2n h\u1ec7 Y\u00eau c\u1ea7u quy\u1ec1n POST <code>/reports/query</code> Truy v\u1ea5n b\u00e1o c\u00e1o theo template Query Engine <code>report.view_*</code> GET <code>/report-templates</code> L\u1ea5y danh s\u00e1ch template Template Management <code>report.view_templates</code> GET <code>/report-templates/{id}</code> Chi ti\u1ebft template Template Management <code>report.view_templates</code> POST <code>/report-templates</code> T\u1ea1o template m\u1edbi Template Management <code>report.manage_templates</code> PATCH <code>/report-templates/{id}</code> C\u1eadp nh\u1eadt template Template Management <code>report.manage_templates</code> DELETE <code>/report-templates/{id}</code> V\u00f4 hi\u1ec7u h\u00f3a template Template Management <code>report.manage_templates</code> GET <code>/saved-configs</code> Danh s\u00e1ch c\u1ea5u h\u00ecnh c\u00e1 nh\u00e2n Saved Config <code>report.view_saved_config</code> POST <code>/saved-configs</code> L\u01b0u c\u1ea5u h\u00ecnh b\u00e1o c\u00e1o Saved Config <code>report.manage_saved_config</code> DELETE <code>/saved-configs/{id}</code> X\u00f3a c\u1ea5u h\u00ecnh \u0111\u00e3 l\u01b0u Saved Config <code>report.manage_saved_config</code> <p>\ud83d\udcd8 HTTP Status Codes d\u00f9ng chung:</p> <ul> <li><code>200 OK</code>: Th\u00e0nh c\u00f4ng</li> <li><code>201 Created</code>: T\u1ea1o m\u1edbi th\u00e0nh c\u00f4ng</li> <li><code>204 No Content</code>: X\u00f3a th\u00e0nh c\u00f4ng</li> <li><code>400 Bad Request</code>: Input kh\u00f4ng h\u1ee3p l\u1ec7</li> <li><code>401 Unauthorized</code>: JWT token kh\u00f4ng h\u1ee3p l\u1ec7</li> <li><code>403 Forbidden</code>: Thi\u1ebfu permission theo RBAC</li> <li><code>404 Not Found</code>: Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i nguy\u00ean</li> <li><code>409 Conflict</code>: Phi\u00ean b\u1ea3n xung \u0111\u1ed9t</li> <li><code>422 Unprocessable Entity</code>: Input \u0111\u00fang schema nh\u01b0ng business logic sai</li> <li><code>500 Internal Server Error</code>: L\u1ed7i h\u1ec7 th\u1ed1ng</li> </ul> <p>\ud83d\udd01 S\u1ef1 ki\u1ec7n ph\u00e1t ra (Pub/Sub Events):</p> <p>C\u00e1c API d\u01b0\u1edbi \u0111\u00e2y s\u1ebd ph\u00e1t s\u1ef1 ki\u1ec7n t\u01b0\u01a1ng \u1ee9ng v\u00e0o <code>PubSubEvents</code> \u0111\u1ec3 ph\u1ee5c v\u1ee5 m\u1ee5c \u0111\u00edch logging/auditing:</p> API Event Code Ghi ch\u00fa <code>POST /reports/query</code> <code>report.query_logged</code> Ghi l\u1ea1i th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng th\u1ef1c hi\u1ec7n truy v\u1ea5n <code>POST /report-templates</code> <code>report_template_created</code> Ghi l\u1ea1i metadata template <code>PATCH /report-templates/{id}</code> <code>report_template_updated</code> Bao g\u1ed3m version m\u1edbi <code>DELETE /report-templates/{id}</code> <code>report_template_disabled</code> Kh\u00f4ng x\u00f3a v\u1eadt l\u00fd <code>POST /saved-configs</code> <code>report_config_saved</code> Ghi l\u1ea1i c\u1ea5u h\u00ecnh ng\u01b0\u1eddi d\u00f9ng <code>DELETE /saved-configs/{id}</code> <code>report_config_deleted</code> Ghi l\u1ea1i h\u00e0nh \u0111\u1ed9ng"},{"location":"services/reporting-service/interface-contract/#2-nhom-api-reports-truy-van-bao-cao","title":"2. Nh\u00f3m API: <code>/reports</code> \u2013 Truy v\u1ea5n b\u00e1o c\u00e1o","text":"<p>Cho ph\u00e9p truy v\u1ea5n b\u00e1o c\u00e1o theo template \u0111\u00e3 \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a v\u00e0 input t\u00f9y ch\u1ec9nh. Tr\u1ea3 v\u1ec1 d\u1eef li\u1ec7u t\u1ed5ng h\u1ee3p t\u1eeb Data Warehouse (BigQuery).</p>"},{"location":"services/reporting-service/interface-contract/#post-reportsquery","title":"<code>POST /reports/query</code>","text":"<ul> <li>M\u00f4 t\u1ea3: Th\u1ef1c thi m\u1ed9t truy v\u1ea5n b\u00e1o c\u00e1o d\u1ef1a tr\u00ean report template v\u00e0 input parameters t\u1eeb ng\u01b0\u1eddi d\u00f9ng.</li> <li>Y\u00eau c\u1ea7u: Header ch\u1ee9a <code>Authorization</code>, <code>X-Tenant-ID</code>, v\u00e0 <code>Content-Type: application/json</code>.</li> <li>RBAC: C\u1ea7n <code>x-required-permission</code> t\u01b0\u01a1ng \u1ee9ng v\u1edbi template (VD: <code>report.view_financial_summary</code>).</li> </ul>"},{"location":"services/reporting-service/interface-contract/#request-body","title":"\ud83d\udce5 Request Body","text":"<pre><code>{\n  \"template_id\": \"student_summary\",\n  \"version\": 1,\n  \"input_parameters\": {\n    \"from_date\": \"2024-01-01\",\n    \"to_date\": \"2024-01-31\",\n    \"status\": \"active\"\n  }\n}\n</code></pre>"},{"location":"services/reporting-service/interface-contract/#success-response-200-ok","title":"\ud83d\udce4 Success Response (200 OK)","text":"<pre><code>{\n  \"meta\": {\n    \"trace_id\": \"a1b2c3\",\n    \"timestamp\": \"2025-06-04T10:00:00Z\"\n  },\n  \"data\": [\n    { \"date\": \"2024-01-01\", \"total_students\": 234 },\n    { \"date\": \"2024-01-02\", \"total_students\": 241 }\n  ]\n}\n</code></pre>"},{"location":"services/reporting-service/interface-contract/#error-responses","title":"\u26a0\ufe0f Error Responses","text":"HTTP Code Description 400 Input kh\u00f4ng h\u1ee3p l\u1ec7 ho\u1eb7c thi\u1ebfu input parameters b\u1eaft bu\u1ed9c 403 Kh\u00f4ng c\u00f3 permission truy c\u1eadp template 404 Template ID kh\u00f4ng t\u1ed3n t\u1ea1i 500 L\u1ed7i x\u1eed l\u00fd ho\u1eb7c truy v\u1ea5n BigQuery th\u1ea5t b\u1ea1i"},{"location":"services/reporting-service/interface-contract/#3-nhom-api-report-templates-quan-ly-mau-bao-cao","title":"3. Nh\u00f3m API: <code>/report-templates</code> \u2013 Qu\u1ea3n l\u00fd m\u1eabu b\u00e1o c\u00e1o","text":"<p>Cho ph\u00e9p qu\u1ea3n tr\u1ecb vi\u00ean h\u1ec7 th\u1ed1ng (Superadmin) t\u1ea1o, c\u1eadp nh\u1eadt, v\u00e0 truy v\u1ea5n c\u00e1c m\u1eabu b\u00e1o c\u00e1o (Report Templates). \u0110\u00e2y l\u00e0 n\u1ec1n t\u1ea3ng \u0111\u1ec3 x\u00e2y d\u1ef1ng b\u00e1o c\u00e1o \u0111\u1ed9ng.</p>"},{"location":"services/reporting-service/interface-contract/#get-report-templates","title":"<code>GET /report-templates</code>","text":"<ul> <li>M\u00f4 t\u1ea3: L\u1ea5y danh s\u00e1ch t\u1ea5t c\u1ea3 c\u00e1c report templates \u0111ang ho\u1ea1t \u0111\u1ed9ng.</li> <li>RBAC: Y\u00eau c\u1ea7u permission <code>report.view_templates</code>.</li> </ul>"},{"location":"services/reporting-service/interface-contract/#response","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"meta\": {\n    \"trace_id\": \"xyz123\",\n    \"timestamp\": \"2025-06-04T10:30:00Z\"\n  },\n  \"data\": [\n    {\n      \"id\": \"student_summary\",\n      \"name\": \"T\u1ed5ng k\u1ebft h\u1ecdc sinh theo tr\u1ea1ng th\u00e1i\",\n      \"description\": \"Hi\u1ec3n th\u1ecb t\u1ed5ng s\u1ed1 h\u1ecdc sinh theo tr\u1ea1ng th\u00e1i m\u1ed7i ng\u00e0y\",\n      \"version\": 1,\n      \"active\": true\n    }\n  ]\n}\n</code></pre>"},{"location":"services/reporting-service/interface-contract/#get-report-templatesid","title":"<code>GET /report-templates/{id}</code>","text":"<ul> <li>M\u00f4 t\u1ea3: Truy v\u1ea5n chi ti\u1ebft m\u1ed9t report template.</li> <li>RBAC: Y\u00eau c\u1ea7u <code>report.view_templates</code>.</li> </ul>"},{"location":"services/reporting-service/interface-contract/#response_1","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"meta\": { \"trace_id\": \"abc123\", \"timestamp\": \"2025-06-04T10:35:00Z\" },\n  \"data\": {\n    \"id\": \"student_summary\",\n    \"version\": 1,\n    \"input_parameters\": [\n      {\n        \"name\": \"from_date\",\n        \"type\": \"date\",\n        \"required\": true,\n        \"description\": \"T\u1eeb ng\u00e0y\",\n        \"default_value\": null\n      }\n    ],\n    \"x-required-permission\": \"report.view_student_summary\"\n  }\n}\n</code></pre>"},{"location":"services/reporting-service/interface-contract/#post-report-templates","title":"<code>POST /report-templates</code>","text":"<ul> <li>M\u00f4 t\u1ea3: T\u1ea1o m\u1edbi m\u1ed9t template.</li> <li>RBAC: Ch\u1ec9 d\u00e0nh cho Superadmin \u2013 <code>report.manage_templates</code></li> </ul>"},{"location":"services/reporting-service/interface-contract/#patch-report-templatesid","title":"<code>PATCH /report-templates/{id}</code>","text":"<ul> <li>M\u00f4 t\u1ea3: C\u1eadp nh\u1eadt n\u1ed9i dung template ho\u1eb7c metadata.</li> <li>L\u01b0u \u00fd: Version m\u1edbi s\u1ebd \u0111\u01b0\u1ee3c t\u1ea1o, version c\u0169 v\u1eabn \u0111\u01b0\u1ee3c gi\u1eef l\u1ea1i n\u1ebfu c\u00f3 saved reports \u0111ang s\u1eed d\u1ee5ng.</li> <li>RBAC: <code>report.manage_templates</code></li> </ul>"},{"location":"services/reporting-service/interface-contract/#delete-report-templatesid","title":"<code>DELETE /report-templates/{id}</code>","text":"<ul> <li>M\u00f4 t\u1ea3: V\u00f4 hi\u1ec7u h\u00f3a template (kh\u00f4ng x\u00f3a v\u1eadt l\u00fd).</li> <li>RBAC: <code>report.manage_templates</code></li> </ul>"},{"location":"services/reporting-service/interface-contract/#4-nhom-api-saved-configs-quan-ly-cau-hinh-bao-cao-ca-nhan-tuy-chon","title":"4. Nh\u00f3m API: <code>/saved-configs</code> \u2013 Qu\u1ea3n l\u00fd c\u1ea5u h\u00ecnh b\u00e1o c\u00e1o c\u00e1 nh\u00e2n (T\u00f9y ch\u1ecdn)","text":"<p>Cho ph\u00e9p ng\u01b0\u1eddi d\u00f9ng (Superadmin) l\u01b0u l\u1ea1i c\u00e1c c\u1ea5u h\u00ecnh truy v\u1ea5n th\u01b0\u1eddng d\u00f9ng \u0111\u1ec3 t\u00e1i s\u1eed d\u1ee5ng sau n\u00e0y. Ph\u1ee5c v\u1ee5 ch\u1ee9c n\u0103ng \u201cMy Dashboard\u201d ho\u1eb7c \u201cSaved Reports\u201d.</p>"},{"location":"services/reporting-service/interface-contract/#get-saved-configs","title":"<code>GET /saved-configs</code>","text":"<ul> <li>M\u00f4 t\u1ea3: L\u1ea5y danh s\u00e1ch c\u1ea5u h\u00ecnh b\u00e1o c\u00e1o \u0111\u00e3 l\u01b0u c\u1ee7a ng\u01b0\u1eddi d\u00f9ng hi\u1ec7n t\u1ea1i.</li> <li>RBAC: <code>report.view_saved_config</code></li> </ul>"},{"location":"services/reporting-service/interface-contract/#response_2","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"meta\": { \"trace_id\": \"xyz\", \"timestamp\": \"2025-06-04T11:00:00Z\" },\n  \"data\": [\n    {\n      \"id\": \"rpt001\",\n      \"template_id\": \"student_summary\",\n      \"version\": 1,\n      \"name\": \"B\u00e1o c\u00e1o h\u1ecdc sinh th\u00e1ng 1\",\n      \"input_parameters\": {\n        \"from_date\": \"2024-01-01\",\n        \"to_date\": \"2024-01-31\"\n      },\n      \"created_at\": \"2025-05-01T10:00:00Z\"\n    }\n  ]\n}\n</code></pre>"},{"location":"services/reporting-service/interface-contract/#post-saved-configs","title":"<code>POST /saved-configs</code>","text":"<ul> <li>M\u00f4 t\u1ea3: T\u1ea1o m\u1edbi m\u1ed9t c\u1ea5u h\u00ecnh b\u00e1o c\u00e1o \u0111\u00e3 l\u01b0u.</li> <li>RBAC: <code>report.manage_saved_config</code></li> </ul>"},{"location":"services/reporting-service/interface-contract/#request-body_1","title":"\ud83d\udce5 Request Body","text":"<pre><code>{\n  \"template_id\": \"student_summary\",\n  \"version\": 1,\n  \"name\": \"B\u00e1o c\u00e1o h\u1ecdc sinh th\u00e1ng 1\",\n  \"input_parameters\": {\n    \"from_date\": \"2024-01-01\",\n    \"to_date\": \"2024-01-31\"\n  }\n}\n</code></pre>"},{"location":"services/reporting-service/interface-contract/#delete-saved-configsid","title":"<code>DELETE /saved-configs/{id}</code>","text":"<ul> <li>M\u00f4 t\u1ea3: X\u00f3a m\u1ed9t c\u1ea5u h\u00ecnh b\u00e1o c\u00e1o \u0111\u00e3 l\u01b0u.</li> <li>RBAC: <code>report.manage_saved_config</code></li> </ul>"},{"location":"services/reporting-service/interface-contract/#phu-luc","title":"\ud83d\udcce Ph\u1ee5 l\u1ee5c","text":""},{"location":"services/reporting-service/interface-contract/#chuan-hoa-ma-loi-error-codes","title":"\ud83d\udcda Chu\u1ea9n h\u00f3a m\u00e3 l\u1ed7i (Error Codes)","text":"<p>T\u1ea5t c\u1ea3 c\u00e1c m\u00e3 l\u1ed7i (<code>error.code</code>) trong response ph\u1ea3i tu\u00e2n th\u1ee7 theo chu\u1ea9n \u0111\u1ecbnh danh namespace \u0111\u01b0\u1ee3c m\u00f4 t\u1ea3 t\u1ea1i:</p> <ul> <li>Error Codes</li> <li>ADR-011 Error Format</li> </ul> <p>Y\u00eau c\u1ea7u b\u1eaft bu\u1ed9c:</p> <ul> <li> <p>M\u00e3 l\u1ed7i ph\u1ea3i vi\u1ebft theo d\u1ea1ng snake_case, c\u00f3 namespace ph\u00e2n t\u00e1ch r\u00f5 r\u00e0ng, v\u00ed d\u1ee5:</p> </li> <li> <p><code>user.user_not_found</code></p> </li> <li><code>auth.invalid_token</code></li> <li><code>common.validation_failed</code></li> <li> <p>M\u1ed7i response l\u1ed7i (401, 403, 404, 422...) ph\u1ea3i tr\u1ea3 v\u1ec1 \u0111\u1ed1i t\u01b0\u1ee3ng <code>ErrorEnvelope</code>, g\u1ed3m 2 ph\u1ea7n:</p> </li> <li> <p><code>error</code> \u2013 ch\u1ee9a <code>code</code>, <code>message</code>, <code>details</code></p> </li> <li><code>meta</code> \u2013 ch\u1ee9a <code>trace_id</code>, <code>timestamp</code></li> </ul> <p>G\u1ee3i \u00fd th\u1ef1c h\u00e0nh:</p> <ul> <li>Kh\u00f4ng d\u00f9ng c\u00e1c m\u00e3 l\u1ed7i chung chung nh\u01b0 <code>\"BAD_REQUEST\"</code>, <code>\"NOT_FOUND\"</code>, <code>\"FORBIDDEN\"</code></li> <li>Lu\u00f4n khai b\u00e1o v\u00ed d\u1ee5 c\u1ee5 th\u1ec3 (v\u00ed d\u1ee5 trong <code>components/examples/</code> ho\u1eb7c inline OpenAPI) \u0111\u1ec3 gi\u00fap dev hi\u1ec3u nhanh</li> <li>T\u00e1i s\u1eed d\u1ee5ng error namespace c\u00f3 s\u1eb5n t\u1eeb <code>error-codes.md</code> ho\u1eb7c khai b\u00e1o namespace m\u1edbi n\u1ebfu c\u1ea7n</li> </ul>"},{"location":"services/reporting-service/interface-contract/#tai-lieu-lien-quan","title":"\ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Design Spec</li> <li>Data Model</li> <li>OpenAPI Spec</li> <li>ADR-012 - Response Structure</li> <li>ADR-011 - API Error Format</li> <li>ADR-029 - Report Template Schema</li> <li>ADR-007 - RBAC Architecture</li> <li>ADR-028 - Reporting Architecture</li> <li>ADR-030 - Event Schema Governance</li> <li>Error Codes</li> </ul>"},{"location":"services/superadmin-webapp/design/","title":"\ud83d\udcd8 Thi\u1ebft k\u1ebf chi ti\u1ebft Superadmin Webapp","text":""},{"location":"services/superadmin-webapp/design/#1-pham-vi-va-trach-nhiem-scope-responsibilities","title":"1. \ud83e\udded Ph\u1ea1m vi v\u00e0 Tr\u00e1ch nhi\u1ec7m (Scope &amp; Responsibilities)","text":"<p>Superadmin Webapp l\u00e0 m\u1ed9t Single Page Application (SPA) d\u00e0nh ri\u00eang cho ban qu\u1ea3n tr\u1ecb h\u1ec7 th\u1ed1ng VAS DX, d\u00f9ng \u0111\u1ec3:</p> <ul> <li>T\u1ea1o v\u00e0 c\u1ea5u h\u00ecnh tenant m\u1edbi.</li> <li>Qu\u1ea3n l\u00fd ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c (<code>user-service/master</code>).</li> <li>G\u00e1n user v\u00e0o tenant v\u00e0 vai tr\u00f2 t\u01b0\u01a1ng \u1ee9ng (<code>sub-user-service</code>).</li> <li>Qu\u1ea3n l\u00fd template role &amp; permission (<code>rbac-deep-dive.md</code>).</li> <li>Theo d\u00f5i audit log, tr\u1ea1ng th\u00e1i \u0111\u1ed3ng b\u1ed9, h\u1ec7 th\u1ed1ng (<code>audit-logging</code>, <code>adr-008</code>, <code>adr-021</code>).</li> </ul> <p>Tu\u00e2n th\u1ee7 nghi\u00eam ng\u1eb7t [ADR-006 Auth Strategy], [ADR-007 RBAC], [ADR-013 Path Naming], [ADR-012 Response Structure], [ADR-011 API Error Format], [ADR-027 Data Strategy], v\u00e0 c\u00e1c ADR li\u00ean quan.</p>"},{"location":"services/superadmin-webapp/design/#2-thanh-phan-kien-truc-architecture-overview","title":"2. \ud83c\udfd7\ufe0f Th\u00e0nh ph\u1ea7n Ki\u1ebfn tr\u00fac (Architecture Overview)","text":"<pre><code>flowchart TD\n  A[Superadmin SPA] --&gt;|OAuth2| B(API Gateway)\n  B --&gt; C[Auth Service Master]\n  B --&gt; D[User Service Master]\n  B --&gt; E[Sub User Service]\n  B --&gt; F[RBAC Template Service logic]\n  B --&gt; G[Audit Logging Service]\n</code></pre> <ul> <li>SPA tri\u1ec3n khai frontend ho\u00e0n to\u00e0n static, giao ti\u1ebfp qua API Gateway</li> <li>X\u00e1c th\u1ef1c OAuth2 qua Google (theo ADR-006)</li> <li>Ph\u00e2n quy\u1ec1n \u0111\u1ed9ng d\u1ef1a tr\u00ean RBAC template (theo ADR-007)</li> <li>Giao di\u1ec7n s\u1eed d\u1ee5ng TailwindCSS + Vue/React + AuthContext</li> </ul>"},{"location":"services/superadmin-webapp/design/#3-cac-tinh-nang-chinh-functional-specs","title":"3. \ud83d\udd0d C\u00e1c T\u00ednh n\u0103ng Ch\u00ednh (Functional Specs)","text":""},{"location":"services/superadmin-webapp/design/#31-quan-ly-tenant","title":"3.1. Qu\u1ea3n l\u00fd Tenant","text":"<ul> <li>T\u1ea1o m\u1edbi tenant (POST /tenants)</li> <li>B\u1eadt/t\u1eaft tenant, c\u1ea5u h\u00ecnh <code>subdomain</code>, gi\u1edbi h\u1ea1n ng\u01b0\u1eddi d\u00f9ng</li> </ul>"},{"location":"services/superadmin-webapp/design/#32-quan-ly-user-global","title":"3.2. Qu\u1ea3n l\u00fd User Global","text":"<ul> <li>Tra c\u1ee9u user to\u00e0n c\u1ee5c (<code>GET /users-global</code>)</li> <li>G\u00e1n user v\u00e0o tenant (<code>POST /user-tenant-assignments</code>)</li> <li>G\u1ee1 user kh\u1ecfi tenant (<code>DELETE /user-tenant-assignments</code>)</li> </ul>"},{"location":"services/superadmin-webapp/design/#33-quan-ly-rbac-template","title":"3.3. Qu\u1ea3n l\u00fd RBAC Template","text":"<ul> <li>T\u1ea1o/s\u1eeda/xo\u00e1 role template (<code>POST /rbac/templates/roles</code>...)</li> <li>G\u00e1n permission cho role (<code>PATCH /rbac/templates/roles/:id</code>)</li> <li>Qu\u1ea3n l\u00fd permission template (<code>POST /rbac/templates/permissions</code>...)</li> </ul>"},{"location":"services/superadmin-webapp/design/#34-theo-doi-hoat-ong-ong-bo","title":"3.4. Theo d\u00f5i ho\u1ea1t \u0111\u1ed9ng &amp; \u0111\u1ed3ng b\u1ed9","text":"<ul> <li>Xem audit log theo ng\u01b0\u1eddi d\u00f9ng, h\u00e0nh \u0111\u1ed9ng, service (<code>GET /audit-logs</code>)</li> <li>Ki\u1ec3m tra tr\u1ea1ng th\u00e1i \u0111\u1ed3ng b\u1ed9 sub-service (<code>GET /sync-status</code>)</li> </ul>"},{"location":"services/superadmin-webapp/design/#35-thiet-lap-he-thong","title":"3.5. Thi\u1ebft l\u1eadp h\u1ec7 th\u1ed1ng","text":"<ul> <li>C\u1ea5u h\u00ecnh OAuth2 Providers (<code>GET/POST /auth/providers</code>)</li> <li>Qu\u1ea3n l\u00fd domain, redirect, email system</li> </ul>"},{"location":"services/superadmin-webapp/design/#4-bao-mat-phan-quyen","title":"4. \ud83d\udd10 B\u1ea3o m\u1eadt &amp; Ph\u00e2n quy\u1ec1n","text":"<ul> <li>X\u00e1c th\u1ef1c: OAuth2 Google (ADR-006), to\u00e0n b\u1ed9 SPA y\u00eau c\u1ea7u login</li> <li>Ph\u00e2n quy\u1ec1n: theo RBAC Template t\u1eeb <code>user-service/master</code> v\u1edbi permission nh\u01b0:</li> <li><code>system.manage_tenant</code></li> <li><code>system.manage_rbac_template</code></li> <li><code>system.view_audit_log</code></li> </ul>"},{"location":"services/superadmin-webapp/design/#5-kiem-thu-am-bao-chat-luong","title":"5. \ud83e\uddea Ki\u1ec3m th\u1eed &amp; \u0110\u1ea3m b\u1ea3o ch\u1ea5t l\u01b0\u1ee3ng","text":"Lo\u1ea1i ki\u1ec3m th\u1eed C\u00f4ng c\u1ee5 Ghi ch\u00fa Unit Test Vitest/Jest Ki\u1ec3m th\u1eed t\u1eebng component + logic permission Integration Test Cypress / Playwright Ki\u1ec3m th\u1eed end-to-end qua API Gateway Accessibility Test axe-core + Lighthouse Tu\u00e2n th\u1ee7 WCAG AA Contract Test Dredd + OpenAPI Ki\u1ec3m tra \u0111\u00fang c\u1ea5u tr\u00fac response Load Test (UI) k6 + Puppeteer M\u00f4 ph\u1ecfng 500 user login"},{"location":"services/superadmin-webapp/design/#6-observability-audit","title":"6. \ud83d\udcc8 Observability &amp; Audit","text":"<ul> <li>Audit Events: <code>tenant_created</code>, <code>user_assigned</code>, <code>role_template_updated</code> (ADR-008)</li> <li>Frontend Log: error boundary + Sentry/LogRocket</li> <li>Metrics: route time, error count, login success rate</li> </ul>"},{"location":"services/superadmin-webapp/design/#7-trien-khai-cicd","title":"7. \ud83d\ude80 Tri\u1ec3n khai &amp; CI/CD","text":"<ul> <li>Tri\u1ec3n khai tr\u00ean Netlify/Vercel ho\u1eb7c Nginx SPA hosting</li> <li>CI: ki\u1ec3m th\u1eed + lint + ki\u1ec3m tra accessibility (GitHub Actions)</li> <li>CD: push to main \u2192 build &amp; deploy t\u1ef1 \u0111\u1ed9ng</li> </ul>"},{"location":"services/superadmin-webapp/design/#8-phu-luc-cac-tai-lieu-lien-quan","title":"8. \ud83e\udde9 Ph\u1ee5 l\u1ee5c: C\u00e1c T\u00e0i li\u1ec7u Li\u00ean quan","text":"<ul> <li>ADR-006 - Auth Strategy</li> <li>ADR-007 - RBAC</li> <li>ADR-011 - Error Format</li> <li>ADR-012 - Response Structure</li> <li>ADR-027 - Data Strategy</li> <li>rbac-deep-dive.md</li> <li>system-diagrams.md</li> <li>user-service/master/design.md</li> <li>auth-service/master/design.md</li> </ul>"},{"location":"services/token-service/data-model/","title":"\ud83d\uddc3\ufe0f Token Service - Data Model","text":"<p>Token Service l\u00e0 th\u00e0nh ph\u1ea7n trung t\u00e2m trong ki\u1ebfn tr\u00fac DX-VAS, ch\u1ecbu tr\u00e1ch nhi\u1ec7m qu\u1ea3n l\u00fd c\u00e1c d\u1eef li\u1ec7u sau: - JWKS keys (<code>jwks_keys</code>) \u2013 l\u01b0u metadata key \u0111\u1ec3 API Gateway x\u00e1c th\u1ef1c JWT offline (RS256) theo ADR-006. - Auth sessions (<code>auth_sessions</code>) \u2013 session_id, user_id, tenant_id, TTL refresh token. - Revoked tokens (<code>revoked_tokens</code>) \u2013 jti, tenant_id, revoked_at, reason (CR-03). - Token stats (<code>token_stats</code>) \u2013 latency, ip_address, device, ch\u1ec9 khi <code>enable_token_stats=true</code>.  </p>"},{"location":"services/token-service/data-model/#1-pham-vi-du-lieu-quan-ly-scope","title":"1. Ph\u1ea1m vi D\u1eef li\u1ec7u Qu\u1ea3n l\u00fd (Scope)","text":"<p>Token Service qu\u1ea3n l\u00fd d\u1eef li\u1ec7u li\u00ean quan \u0111\u1ebfn lu\u1ed3ng ph\u00e1t h\u00e0nh, thu h\u1ed3i v\u00e0 introspect JWT, bao g\u1ed3m: - C\u1ea5u h\u00ecnh v\u00e0 metadata JWKS. - L\u1ecbch s\u1eed phi\u00ean (session) cho refresh token. - Danh s\u00e1ch token \u0111\u00e3 b\u1ecb thu h\u1ed3i \u0111\u1ec3 ch\u1eb7n offline. - Th\u1ed1ng k\u00ea (tu\u1ef3 ch\u1ecdn) cho m\u1ed7i token (latency, IP, v.v.).</p>"},{"location":"services/token-service/data-model/#2-ngoai-pham-vi-out-of-scope","title":"2. Ngo\u00e0i Ph\u1ea1m Vi (Out of Scope)","text":"<p>Token Service kh\u00f4ng qu\u1ea3n l\u00fd: - \u274c Th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng / role / permission (thu\u1ed9c User Service). - \u274c D\u1eef li\u1ec7u SMS / Email (thu\u1ed9c Notification Service). - \u274c L\u1ecbch s\u1eed audit chi ti\u1ebft ngo\u00e0i c\u00e1c s\u1ef1 ki\u1ec7n token.*.v1 (\u0111\u00e3 publish Pub/Sub).</p>"},{"location":"services/token-service/data-model/#3-muc-tieu-cua-tai-lieu-mo-hinh-du-lieu","title":"3. M\u1ee5c ti\u00eau c\u1ee7a T\u00e0i li\u1ec7u M\u00f4 h\u00ecnh D\u1eef li\u1ec7u","text":"<ul> <li>M\u00f4 t\u1ea3 chi ti\u1ebft c\u1ea5u tr\u00fac b\u1ea3ng ph\u1ee5c v\u1ee5 Issuance, Revocation, Introspection.  </li> <li>Th\u1ec3 hi\u1ec7n r\u00f5 r\u00e0ng r\u00e0ng bu\u1ed9c PK/FK, index, ENUM (n\u1ebfu c\u00f3).  </li> <li>\u0110\u1ea3m b\u1ea3o tu\u00e2n th\u1ee7 c\u00e1c ADR quan tr\u1ecdng:  </li> <li>ADR-023 (Schema Migration Strategy)  </li> <li>ADR-024 (Data Anonymization &amp; Retention)  </li> <li>ADR-026 (Hard Delete Policy)  </li> </ul>"},{"location":"services/token-service/data-model/#4-so-o-erd-entity-relationship-diagram","title":"4. S\u01a1 \u0111\u1ed3 ERD (Entity Relationship Diagram)","text":"<p>S\u01a1 \u0111\u1ed3 s\u01a1 b\u1ed9</p> <pre><code>erDiagram\n  jwks_keys {\n    UUID kid PK\n    JSON public_key\n    BOOLEAN active\n    TIMESTAMPTZ created_at\n    TIMESTAMPTZ rotated_at\n  }\n  auth_sessions {\n    UUID session_id PK\n    UUID user_id\n    TEXT tenant_id\n    TIMESTAMPTZ created_at\n    TIMESTAMPTZ last_active_at\n  }\n  revoked_tokens {\n    UUID jti PK\n    TEXT tenant_id\n    TIMESTAMPTZ revoked_at\n    TEXT reason\n    UUID revoked_by\n  }\n  token_stats {\n    UUID stat_id PK\n    UUID jti FK\n    INTEGER latency_ms\n    TEXT ip_address\n    JSON device_info\n    TIMESTAMPTZ recorded_at\n  }\n\n  jwks_keys ||--o{ auth_sessions : \"signs sessions\"\n  auth_sessions ||--o{ revoked_tokens : \"may be revoked\"\n  revoked_tokens ||--o| token_stats : \"0..1 stats\"\n</code></pre> <p>Ch\u00fa th\u00edch:</p> <ul> <li><code>revoked_tokens \u2192 token_stats</code> l\u00e0 quan h\u1ec7 1-to-0..1 (m\u1ed9t revoke c\u00f3 th\u1ec3 kh\u00f4ng c\u00f3 stat).</li> <li><code>jwks_keys.active</code> ch\u1ec9 one-hot active key; c\u00e1c key c\u0169 gi\u1eef \u0111\u1ec3 verify until TTL.</li> </ul> <p>S\u01a1 \u0111\u1ed3 ERD chi ti\u1ebft</p> <pre><code>erDiagram\n  jwks_keys {\n    UUID    kid PK              \"Key ID\"\n    JSONB   public_key NOT_NULL JWK public key\n    BOOLEAN active DEFAULT FALSE\n    TIMESTAMPTZ created_at NOT_NULL DEFAULT now()\n    TIMESTAMPTZ rotated_at NOT_NULL\n  }\n  auth_sessions {\n    UUID        session_id PK           \"Session ID (refresh token)\"\n    UUID        user_id NOT_NULL        Global user_id\n    TEXT        tenant_id NOT_NULL      \"Tenant context\"\n    TIMESTAMPTZ created_at NOT_NULL DEFAULT now()\n    TIMESTAMPTZ last_active_at DEFAULT now() NOT_NULL\n  }\n  revoked_tokens {\n    UUID        jti PK                  \"JWT ID\"\n    TEXT        tenant_id NOT_NULL\n    TIMESTAMPTZ revoked_at NOT_NULL DEFAULT now()\n    TEXT        reason\n    UUID        revoked_by\n  }\n  token_stats {\n    UUID    stat_id PK                  \"Stats record ID\"\n    UUID    jti FK NOT_NULL             References \"revoked_tokens.jti\"\n    INT     latency_ms NOT_NULL\n    TEXT    ip_address\n    JSONB   device_info\n    TIMESTAMPTZ recorded_at NOT_NULL DEFAULT now()\n  }\n\n  jwks_keys   ||--o{ auth_sessions   : \"signs sessions\"\n  auth_sessions ||--o{ revoked_tokens  : \"may be revoked\"\n  revoked_tokens ||--o| token_stats    : \"0..1 stats\"\n</code></pre> <p>Ch\u00fa th\u00edch &amp; Best Practices</p> <ul> <li> <p>Cardinality</p> </li> <li> <p><code>jwks_keys (1) \u2192 auth_sessions (0..*)</code> \u2013 m\u1ed9t key c\u00f3 th\u1ec3 sign nhi\u1ec1u phi\u00ean.</p> </li> <li><code>auth_sessions (1) \u2192 revoked_tokens (0..*)</code> \u2013 kh\u00f4ng ph\u1ea3i m\u1ecdi session \u0111\u1ec1u b\u1ecb revoke.</li> <li><code>revoked_tokens (1) \u2192 token_stats (0..1)</code> \u2013 stats ch\u1ec9 sinh khi <code>enable_token_stats=true</code>.</li> <li> <p>Indexes</p> </li> <li> <p><code>jwks_keys(active)</code> for fast lookup of current key.</p> </li> <li><code>auth_sessions(user_id, tenant_id)</code> for session validation.</li> <li><code>revoked_tokens(tenant_id)</code> \u0111\u1ec3 Gateway check revoked nhanh.</li> <li> <p>Retention &amp; Delete</p> </li> <li> <p><code>jwks_keys</code>: gi\u1eef 30 ng\u00e0y sau rotation \u2192 Cron purge (ADR-024/026).</p> </li> <li><code>revoked_tokens</code>: TTL 30d \u2192 auto-purge (ADR-024/026).</li> <li><code>token_stats</code>: TTL 90d \u2192 anonymize &amp; delete (ADR-024).</li> </ul>"},{"location":"services/token-service/data-model/#5-chi-tiet-tung-bang","title":"5. Chi ti\u1ebft T\u1eebng B\u1ea3ng","text":""},{"location":"services/token-service/data-model/#51-bang-jwks_keys","title":"5.1 B\u1ea3ng <code>jwks_keys</code>","text":"<pre><code>CREATE TABLE jwks_keys (\n  kid UUID PRIMARY KEY,\n  public_key JSONB NOT NULL,\n  active BOOLEAN NOT NULL DEFAULT FALSE,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  rotated_at TIMESTAMPTZ\n);\n</code></pre> C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u R\u00e0ng bu\u1ed9c Default M\u00f4 t\u1ea3 <code>kid</code> <code>UUID</code> <code>PRIMARY KEY</code> Key ID, kh\u1edbp JWT header <code>kid</code> <code>public_key</code> <code>JSONB</code> <code>NOT NULL</code> JWK Public Key <code>active</code> <code>BOOLEAN</code> <code>NOT NULL</code> <code>FALSE</code> True n\u1ebfu \u0111ang d\u00f9ng \u0111\u1ec3 verify <code>created_at</code> <code>TIMESTAMPTZ</code> <code>NOT NULL</code> <code>now()</code> Th\u1eddi \u0111i\u1ec3m t\u1ea1o key <code>rotated_at</code> <code>TIMESTAMPTZ</code> Th\u1eddi \u0111i\u1ec3m key \u0111\u01b0\u1ee3c rotate l\u1ea7n cu\u1ed1i"},{"location":"services/token-service/data-model/#indexes-constraints","title":"Indexes &amp; Constraints","text":"<ul> <li>Primary Key: <code>pk_jwks_keys</code> on <code>(kid)</code></li> <li>Unique Constraint: <code>uq_jwks_keys_active</code> on <code>(active)</code> \u2013 ch\u1ec9 m\u1ed9t key \u0111\u01b0\u1ee3c active t\u1ea1i m\u1ed9t th\u1eddi \u0111i\u1ec3m</li> <li>B-tree Index: <code>idx_jwks_created_at</code> on <code>(created_at)</code> \u2013 t\u1ed1i \u01b0u truy v\u1ea5n key m\u1edbi nh\u1ea5t</li> </ul>"},{"location":"services/token-service/data-model/#52-bang-auth_sessions","title":"5.2 B\u1ea3ng <code>auth_sessions</code>","text":"<pre><code>CREATE TABLE auth_sessions (\n  session_id UUID PRIMARY KEY,\n  user_id UUID NOT NULL,\n  tenant_id TEXT NOT NULL,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  last_active_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n</code></pre> C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u R\u00e0ng bu\u1ed9c Default M\u00f4 t\u1ea3 <code>session_id</code> <code>UUID</code> <code>PRIMARY KEY</code> ID phi\u00ean d\u00f9ng cho refresh token <code>user_id</code> <code>UUID</code> <code>NOT NULL</code> <code>user_id_global</code> t\u1eeb User Service <code>tenant_id</code> <code>TEXT</code> <code>NOT NULL</code> Tenant context <code>created_at</code> <code>TIMESTAMPTZ</code> <code>NOT NULL</code> <code>now()</code> Th\u1eddi \u0111i\u1ec3m phi\u00ean \u0111\u01b0\u1ee3c t\u1ea1o <code>last_active_at</code> <code>TIMESTAMPTZ</code> <code>NOT NULL</code> <code>now()</code> Th\u1eddi \u0111i\u1ec3m phi\u00ean ho\u1ea1t \u0111\u1ed9ng cu\u1ed1i c\u00f9ng"},{"location":"services/token-service/data-model/#indexes-constraints_1","title":"Indexes &amp; Constraints","text":"<ul> <li>Primary Key: <code>pk_auth_sessions</code> tr\u00ean (<code>session_id</code>)</li> <li>B-tree Index: <code>idx_auth_sessions_user_tenant</code> tr\u00ean (<code>user_id</code>, <code>tenant_id</code>) \u2013 t\u1ed1i \u01b0u lookup session theo user &amp; tenant</li> <li>B-tree Index: <code>idx_auth_sessions_last_active</code> tr\u00ean (<code>last_active_at</code>) \u2013 h\u1ed7 tr\u1ee3 purge phi\u00ean c\u0169 v\u00e0 th\u1ed1ng k\u00ea session c\u00f2n s\u1ed1ng</li> </ul>"},{"location":"services/token-service/data-model/#53-bang-revoked_tokens","title":"5.3 B\u1ea3ng <code>revoked_tokens</code>","text":"<pre><code>CREATE TABLE revoked_tokens (\n  jti UUID PRIMARY KEY,\n  tenant_id TEXT NOT NULL,\n  revoked_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  reason TEXT,\n  revoked_by UUID\n);\n</code></pre> C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u R\u00e0ng bu\u1ed9c Default M\u00f4 t\u1ea3 <code>jti</code> <code>UUID</code> <code>PRIMARY KEY</code> JWT ID \u0111\u1ec3 thu h\u1ed3i (claim <code>jti</code>) <code>tenant_id</code> <code>TEXT</code> <code>NOT NULL</code> Tenant context <code>revoked_at</code> <code>TIMESTAMPTZ</code> <code>NOT NULL</code> <code>now()</code> Th\u1eddi \u0111i\u1ec3m token b\u1ecb thu h\u1ed3i <code>reason</code> <code>TEXT</code> L\u00fd do (<code>logout</code>, <code>rotation</code>, v.v.) <code>revoked_by</code> <code>UUID</code> ID ng\u01b0\u1eddi/th\u1ef1c th\u1ec3 th\u1ef1c hi\u1ec7n revoke"},{"location":"services/token-service/data-model/#indexes-constraints_2","title":"Indexes &amp; Constraints","text":"<ul> <li>Primary Key: <code>pk_revoked_tokens</code> tr\u00ean (<code>jti</code>)</li> <li>B-tree Index: <code>idx_revoked_tokens_tenant_revoked_at</code> tr\u00ean (<code>tenant_id</code>, <code>revoked_at</code>) \u2013 t\u1ed1i \u01b0u truy v\u1ea5n v\u00e0 purge theo tenant &amp; th\u1eddi gian</li> <li>Check Constraint: <code>chk_revoked_tokens_reason</code> CHECK (<code>reason</code> IN ('logout','rotation','breach','expired'))</li> </ul>"},{"location":"services/token-service/data-model/#54-bang-token_stats","title":"5.4 B\u1ea3ng <code>token_stats</code>","text":"<pre><code>CREATE TABLE token_stats (\n  stat_id UUID PRIMARY KEY,\n  jti UUID NOT NULL REFERENCES revoked_tokens(jti) ON DELETE CASCADE,\n  latency_ms INTEGER NOT NULL,\n  ip_address TEXT,\n  device_info JSONB,\n  recorded_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n</code></pre> C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u R\u00e0ng bu\u1ed9c Default M\u00f4 t\u1ea3 <code>stat_id</code> <code>UUID</code> <code>PRIMARY KEY</code> ID b\u1ea3n ghi th\u1ed1ng k\u00ea <code>jti</code> <code>UUID</code> <code>NOT NULL</code>, FK \u2192 <code>revoked_tokens(jti)</code> Tham chi\u1ebfu t\u1edbi token \u0111\u00e3 b\u1ecb thu h\u1ed3i <code>latency_ms</code> <code>INTEGER</code> <code>NOT NULL</code> Th\u1eddi gian (ms) th\u1ef1c hi\u1ec7n issuance/revoke <code>ip_address</code> <code>TEXT</code> \u0110\u1ecba ch\u1ec9 IP client <code>device_info</code> <code>JSONB</code> Th\u00f4ng tin thi\u1ebft b\u1ecb (type, user_agent, phi\u00ean b\u1ea3n) <code>recorded_at</code> <code>TIMESTAMPTZ</code> <code>NOT NULL</code> <code>now()</code> Th\u1eddi \u0111i\u1ec3m ghi nh\u1eadn th\u1ed1ng k\u00ea"},{"location":"services/token-service/data-model/#indexes-constraints_3","title":"Indexes &amp; Constraints","text":"<ul> <li>Primary Key: <code>pk_token_stats</code> tr\u00ean (<code>stat_id</code>)</li> <li>Foreign Key: <code>fk_token_stats_revoked</code></li> </ul> <p><pre><code>ALTER TABLE token_stats\n  ADD CONSTRAINT fk_token_stats_revoked\n    FOREIGN KEY (jti) REFERENCES revoked_tokens(jti) ON DELETE CASCADE;\n</code></pre> * B-tree Index: <code>idx_token_stats_jti_recorded</code> tr\u00ean (<code>jti</code>, <code>recorded_at</code>) \u2013 t\u1ed1i \u01b0u lookup stats cho m\u1ed7i token v\u00e0 purge theo th\u1eddi gian</p>"},{"location":"services/token-service/data-model/#6-indexes-constraints","title":"6. Indexes &amp; Constraints","text":"<p>\u0110\u1ec3 \u0111\u1ea3m b\u1ea3o hi\u1ec7u n\u0103ng truy v\u1ea5n v\u00e0 t\u00ednh to\u00e0n v\u1eb9n d\u1eef li\u1ec7u, m\u1ed7i b\u1ea3ng trong Token Service \u0111\u01b0\u1ee3c trang b\u1ecb c\u00e1c ch\u1ec9 m\u1ee5c (index) v\u00e0 r\u00e0ng bu\u1ed9c (constraint) nh\u01b0 sau:</p> B\u1ea3ng T\u00ean Index / Constraint Lo\u1ea1i \u0110\u1ecbnh ngh\u0129a M\u1ee5c \u0111\u00edch jwks_keys <code>pk_jwks_keys</code> Primary Key <code>(kid)</code> \u0110\u1ea3m b\u1ea3o <code>kid</code> l\u00e0 duy nh\u1ea5t, d\u00f9ng l\u00e0m PK <code>uq_jwks_keys_active</code> Unique Constraint <code>(active)</code> Ch\u1ec9 m\u1ed9t public key \u0111\u01b0\u1ee3c \u0111\u00e1nh d\u1ea5u <code>active = TRUE</code> <code>idx_jwks_created_at</code> B-tree Index <code>(created_at)</code> T\u00ecm key m\u1edbi nh\u1ea5t khi rotate auth_sessions <code>pk_auth_sessions</code> Primary Key <code>(session_id)</code> \u0110\u1ecbnh danh phi\u00ean <code>idx_auth_sessions_user_tenant</code> B-tree Index <code>(user_id, tenant_id)</code> Lookup sessions theo ng\u01b0\u1eddi d\u00f9ng &amp; tenant <code>idx_auth_sessions_last_active</code> B-tree Index <code>(last_active_at)</code> X\u00f3a session c\u0169, th\u1ed1ng k\u00ea session c\u00f2n \u201cs\u1ed1ng\u201d revoked_tokens <code>pk_revoked_tokens</code> Primary Key <code>(jti)</code> \u0110\u1ecbnh danh token b\u1ecb thu h\u1ed3i <code>idx_revoked_tokens_tenant_at</code> B-tree Index <code>(tenant_id, revoked_at)</code> T\u00ecm tokens \u0111\u00e3 thu h\u1ed3i theo tenant v\u00e0 th\u1eddi gian, t\u1ed1i \u01b0u purge job <code>chk_revoked_tokens_reason</code> Check Constraint <code>reason IN ('logout','rotation','breach','expired')</code> Gi\u1edbi h\u1ea1n gi\u00e1 tr\u1ecb <code>reason</code> theo ENUM token_stats <code>pk_token_stats</code> Primary Key <code>(stat_id)</code> \u0110\u1ecbnh danh record th\u1ed1ng k\u00ea <code>fk_token_stats_revoked_tokens</code> Foreign Key <code>(jti) REFERENCES revoked_tokens(jti) ON DELETE CASCADE</code> \u0110\u1ea3m b\u1ea3o m\u1ed7i stat li\u00ean k\u1ebft t\u1edbi m\u1ed9t revoked token <code>idx_token_stats_jti_recorded</code> B-tree Index <code>(jti, recorded_at)</code> Lookup stats cho m\u1ed9t token v\u00e0 purge theo th\u1eddi gian"},{"location":"services/token-service/data-model/#chi-tiet-best-practices","title":"Chi ti\u1ebft &amp; Best Practices","text":"<ul> <li>Primary Key &amp; Unique:  </li> <li>PK \u0111\u1eb7t tr\u00ean c\u1ed9t \u0111\u1ecbnh danh duy nh\u1ea5t (<code>kid</code>, <code>session_id</code>, <code>jti</code>, <code>stat_id</code>).  </li> <li> <p>Unique cho <code>jwks_keys.active</code> \u0111\u1ec3 ch\u1ec9 1 key \u0111\u01b0\u1ee3c active.</p> </li> <li> <p>B-tree Index:  </p> </li> <li>D\u00f9ng cho c\u1ed9t th\u01b0\u1eddng xuy\u00ean filter/sort: <code>created_at</code>, <code>last_active_at</code>, <code>revoked_at</code>, <code>recorded_at</code>.  </li> <li> <p>Composite index <code>(user_id, tenant_id)</code> gi\u00fap t\u00ecm session theo tenant nhanh.</p> </li> <li> <p>Check Constraint:  </p> </li> <li> <p>S\u1eed d\u1ee5ng <code>CHECK</code> \u0111\u1ec3 validate ENUM-like (<code>reason</code>), kh\u00f4ng ph\u1ee5 thu\u1ed9c ENUM type DB, gi\u1eef t\u00ednh di \u0111\u1ed9ng.</p> </li> <li> <p>Foreign Key:  </p> </li> <li> <p><code>token_stats.jti</code> tham chi\u1ebfu <code>revoked_tokens.jti</code> v\u1edbi <code>ON DELETE CASCADE</code> \u0111\u1ec3 t\u1ef1 cleanup stats khi token b\u1ecb x\u00f3a.</p> </li> <li> <p>Retention &amp; Purge:  </p> </li> <li>C\u00e1c cron/job purge d\u1ef1a tr\u00ean ch\u1ec9 m\u1ee5c <code>(tenant_id, revoked_at)</code> v\u00e0 <code>(jti, recorded_at)</code> \u0111\u1ec3 x\u00f3a d\u1eef li\u1ec7u qu\u00e1 h\u1ea1n nhanh.</li> </ul> <p>C\u00e1c t\u00ean index/constraint tu\u00e2n chu\u1ea9n 5\u2605 Data Model Standard: c\u00f3 prefix t\u01b0\u01a1ng \u1ee9ng b\u1ea3ng, r\u00f5 r\u00e0ng lo\u1ea1i index, d\u1ec5 tra c\u1ee9u khi debugging v\u00e0 tuning.</p>"},{"location":"services/token-service/data-model/#7-chinh-sach-luu-tru-xoa-du-lieu","title":"7. Ch\u00ednh s\u00e1ch L\u01b0u tr\u1eef &amp; X\u00f3a D\u1eef li\u1ec7u","text":"<p>Tu\u00e2n theo ADR-024 (Data Anonymization &amp; Retention) v\u00e0 ADR-026 (Hard-Delete Policy), m\u1ecdi d\u1eef li\u1ec7u c\u0169 \u0111\u1ec1u \u0111\u01b0\u1ee3c x\u00f3a ho\u1eb7c \u1ea9n danh theo TTL \u0111\u1ecbnh s\u1eb5n.</p>"},{"location":"services/token-service/data-model/#71-ttl-job-purge","title":"7.1 TTL &amp; Job Purge","text":"B\u1ea3ng TTL Job T\u1ea7n su\u1ea5t H\u00e0nh \u0111\u1ed9ng <code>jwks_keys</code> 30 ng\u00e0y k\u1ec3 t\u1eeb <code>rotated_at</code> <code>purge_jwks_keys</code> H\u00e0ng ng\u00e0y 02:00 UTC <code>DELETE FROM jwks_keys WHERE rotated_at &lt; now() - INTERVAL '30 days';</code> <code>auth_sessions</code> 14 ng\u00e0y k\u1ec3 t\u1eeb <code>last_active_at</code> <code>purge_auth_sessions</code> H\u00e0ng gi\u1edd <code>DELETE FROM auth_sessions WHERE last_active_at &lt; now() - INTERVAL '14 days';</code> <code>revoked_tokens</code> 30 ng\u00e0y k\u1ec3 t\u1eeb <code>revoked_at</code> <code>purge_revoked_tokens</code> H\u00e0ng ng\u00e0y 03:00 UTC <code>DELETE FROM revoked_tokens WHERE revoked_at &lt; now() - INTERVAL '30 days';</code> <code>token_stats</code> 90 ng\u00e0y k\u1ec3 t\u1eeb <code>recorded_at</code> <code>anonymize_token_stats</code> &amp; <code>purge_token_stats</code> H\u00e0ng ng\u00e0y 04:00 UTC 1) <code>UPDATE token_stats SET ip_address = NULL, device_info = NULL WHERE recorded_at &lt; now() - INTERVAL '90 days';</code>2) <code>DELETE FROM token_stats WHERE recorded_at &lt; now() - INTERVAL '90 days';</code>"},{"location":"services/token-service/data-model/#72-audit-event-notification","title":"7.2 Audit &amp; Event Notification","text":"<ul> <li>M\u1ed7i job purge/anonymize ghi v\u00e0o b\u1ea3ng <code>audit_log.purge_history</code> (schema v1: <code>resource</code>, <code>deleted_count</code>, <code>run_at</code>, <code>initiator='system'</code>).  </li> <li>Sau khi ho\u00e0n th\u00e0nh, ph\u00e1t s\u1ef1 ki\u1ec7n <code>data.purged.v1</code> l\u00ean Pub/Sub topic <code>data.v1</code> v\u1edbi payload: <pre><code>  {\n    \"event\": \"data.purged.v1\",\n    \"resource\": \"revoked_tokens\",\n    \"deleted_count\": 12345,\n    \"timestamp\": \"2025-06-09T02:00:00Z\"\n  }\n</code></pre></li> </ul>"},{"location":"services/token-service/data-model/#73-hard-delete-rollback","title":"7.3 Hard-Delete &amp; Rollback","text":"<ul> <li>Hard-Delete: Kh\u00f4ng c\u00f3 c\u01a1 ch\u1ebf soft-delete\u2014d\u1eef li\u1ec7u v\u01b0\u1ee3t TTL b\u1ecb x\u00f3a v\u0129nh vi\u1ec5n.</li> <li>Undo Migration: N\u1ebfu c\u1ea7n kh\u00f4i ph\u1ee5c, s\u1eed d\u1ee5ng Flyway <code>U20250617__recreate_revoked_tokens.sql</code> (ADR-023).</li> </ul>"},{"location":"services/token-service/data-model/#74-kiem-soat-giam-sat","title":"7.4 Ki\u1ec3m so\u00e1t &amp; Gi\u00e1m s\u00e1t","text":"<ul> <li> <p>Job purge/anonymize ph\u1ea3i log metric:</p> </li> <li> <p><code>purge_revoked_tokens_count</code></p> </li> <li><code>purge_auth_sessions_count</code></li> <li><code>anonymize_token_stats_count</code></li> <li>Alert n\u1ebfu job th\u1ea5t b\u1ea1i ho\u1eb7c <code>deleted_count = 0</code> b\u1ea5t th\u01b0\u1eddng (k\u1ecbch b\u1ea3n d\u1eef li\u1ec7u qu\u00e1 nhi\u1ec1u ho\u1eb7c qu\u00e1 \u00edt).</li> </ul>"},{"location":"services/token-service/data-model/#8-data-synchronization-events","title":"8. Data Synchronization &amp; Events","text":"<p>M\u1ee5c ti\u00eau \u2013 Ph\u00e1t h\u00e0nh s\u1ef1 ki\u1ec7n b\u1ea5t \u0111\u1ed3ng b\u1ed9 \u0111\u1ec3 c\u00e1c th\u00e0nh ph\u1ea7n kh\u00e1c (API Gateway, Audit Service, Monitoring) nh\u1eadn bi\u1ebft ngay thay \u0111\u1ed5i li\u00ean quan JWT, \u0111\u1ed3ng th\u1eddi \u0111\u1ea3m b\u1ea3o \u0111\u1ed3ng nh\u1ea5t v\u00e0 c\u00f3 th\u1ec3 m\u1edf r\u1ed9ng theo ADR-030.</p>"},{"location":"services/token-service/data-model/#81-pubsub-topic-event-names","title":"8.1 Pub/Sub Topic &amp; Event Names","text":"<ul> <li>Topic chung: <code>token.v1</code> </li> <li>T\u00ean s\u1ef1 ki\u1ec7n (theo ADR-030 \u2013 Event Schema Governance):  </li> <li><code>token.issued.v1</code> </li> <li><code>token.revoked.v1</code> </li> <li><code>token.introspect_fail.v1</code> </li> </ul> <p>M\u1ed7i event c\u00f3 attribute <code>tenant_id</code>, d\u00f9ng \u0111\u1ec3 filter fan-out t\u1edbi c\u00e1c subscription.</p>"},{"location":"services/token-service/data-model/#82-json-schema-registry","title":"8.2 JSON Schema &amp; Registry","text":"Event Schema ID Ghi ch\u00fa <code>token_issued_v1</code> <code>token_issued_v1</code> Invariants: <code>jti</code>, <code>session_id</code> <code>token_revoked_v1</code> <code>token_revoked_v1</code> Invariants: <code>jti</code>, <code>revoked_by</code> <code>token_introspect_fail_v1</code> <code>token_introspect_fail_v1</code> Invariants: <code>token</code>, <code>error</code> <p>Schemas \u0111\u01b0\u1ee3c l\u01b0u trong Schema Registry (backward-compatible \u2265 6 th\u00e1ng).</p>"},{"location":"services/token-service/data-model/#83-payload-examples","title":"8.3 Payload Examples","text":""},{"location":"services/token-service/data-model/#831-tokenissuedv1","title":"8.3.1 <code>token.issued.v1</code>","text":"<pre><code>{\n  \"event\": \"token.issued.v1\",\n  \"timestamp\": \"2025-06-09T08:00:00Z\",\n  \"tenant_id\": \"school-xyz\",\n  \"user_id\": \"user-123\",\n  \"jti\": \"uuid-abc-123\",\n  \"session_id\": \"sess-456-def\",\n  \"ip_address\": \"203.0.113.5\",\n  \"device\": {\n    \"type\": \"web\",\n    \"user_agent\": \"Mozilla/5.0\"\n  }\n}\n</code></pre>"},{"location":"services/token-service/data-model/#832-tokenrevokedv1","title":"8.3.2 <code>token.revoked.v1</code>","text":"<pre><code>{\n  \"event\": \"token.revoked.v1\",\n  \"timestamp\": \"2025-06-09T09:15:30Z\",\n  \"tenant_id\": \"school-xyz\",\n  \"user_id\": \"user-123\",\n  \"jti\": \"uuid-abc-123\",\n  \"revoked_by\": \"admin-789\",\n  \"reason\": \"logout\",\n  \"ip_address\": \"203.0.113.5\"\n}\n</code></pre>"},{"location":"services/token-service/data-model/#833-tokenintrospect_failv1","title":"8.3.3 <code>token.introspect_fail.v1</code>","text":"<pre><code>{\n  \"event\": \"token.introspect_fail.v1\",\n  \"timestamp\": \"2025-06-09T09:16:00Z\",\n  \"tenant_id\": \"school-xyz\",\n  \"token\": \"eyJhbGciOiJSUzI1NiIs\u2026\",\n  \"error\": {\n    \"code\": \"token.revoked\",\n    \"message\": \"Token \u0111\u00e3 b\u1ecb thu h\u1ed3i\"\n  }\n}\n</code></pre>"},{"location":"services/token-service/data-model/#84-consumers-subscriptions","title":"8.4 Consumers &amp; Subscriptions","text":"Subscriber Subscription ID X\u1eed l\u00fd ch\u00ednh API Gateway <code>sub-token-revoked</code> Xo\u00e1 cache <code>revoked:{jti}</code> khi nh\u1eadn <code>token.revoked.v1</code> Audit Logging <code>sub-token-audit</code> Ghi log event v\u00e0o b\u1ea3ng <code>audit_log.token_events</code> Monitoring Service <code>sub-token-monitor</code> T\u00ednh metrics - hit/miss, latency, fail rates <ul> <li>Filter: subscription l\u1ecdc attribute <code>tenant_id</code> \u0111\u1ec3 ph\u00e2n v\u00f9ng ri\u00eang cho m\u1ed7i tenant.</li> </ul>"},{"location":"services/token-service/data-model/#85-delivery-semantics-ordering","title":"8.5 Delivery Semantics &amp; Ordering","text":"<ul> <li>At-least-once delivery, idempotent consumers.</li> <li>Ordering: Pub/Sub \u0111\u1ea3m b\u1ea3o ordering trong c\u00f9ng <code>orderingKey=tenant_id</code>.</li> <li>Retries: DLQ (Dead-Letter Queue) cho event th\u1ea5t b\u1ea1i sau 5 l\u1ea7n x\u1eed l\u00fd.</li> </ul>"},{"location":"services/token-service/data-model/#86-governance-versioning","title":"8.6 Governance &amp; Versioning","text":"<ul> <li>M\u1ed7i event t\u00edch h\u1ee3p field <code>schema_version</code> (m\u1eb7c \u0111\u1ecbnh = 1).</li> <li>Khi schema thay \u0111\u1ed5i, t\u0103ng suffix: <code>token.issued.v2</code>, gi\u1eef backward-compat trong \u2265 6 th\u00e1ng.</li> <li>Theo ADR-030, m\u1ecdi consumer ph\u1ea3i ki\u1ec3m tra <code>schema_version</code> tr\u01b0\u1edbc khi deserialize.</li> </ul>"},{"location":"services/token-service/data-model/#9-data-access-control","title":"9. Data Access Control","text":"<p>M\u1ee5c ti\u00eau \u2013 \u0110\u1ea3m b\u1ea3o ch\u1ec9 Token Service v\u00e0 c\u00e1c th\u00e0nh ph\u1ea7n \u0111\u00e3 x\u00e1c th\u1ef1c m\u1edbi \u0111\u01b0\u1ee3c ph\u00e9p truy c\u1eadp d\u1eef li\u1ec7u, tu\u00e2n principle of least privilege v\u00e0 tu\u00e2n chu\u1ea9n b\u1ea3o m\u1eadt m\u1ea1ng/D\u1eef li\u1ec7u.</p>"},{"location":"services/token-service/data-model/#91-authentication-database-users","title":"9.1 Authentication &amp; Database Users","text":"<ul> <li>Cloud SQL IAM Authentication </li> <li>Admin s\u1eed d\u1ee5ng IAM role <code>cloudsql.admin</code> \u0111\u1ec3 k\u1ebft n\u1ed1i v\u1edbi instance.  </li> <li>Application user </li> <li>T\u00e0i kho\u1ea3n DB <code>token_service</code> (mapping Workload Identity <code>svc-token-db@dx-vas-core.iam.gserviceaccount.com</code>).  </li> <li>Kh\u00f4ng c\u00f3 quy\u1ec1n SUPERUSER.</li> </ul>"},{"location":"services/token-service/data-model/#92-network-encryption","title":"9.2 Network &amp; Encryption","text":"<ul> <li>K\u1ebft n\u1ed1i Private IP qua VPC Peering (GKE \u2194 Cloud SQL).  </li> <li>SSL/TLS b\u1eaft bu\u1ed9c: <code>sslmode=require</code>, verify server cert.  </li> <li>Firewall ch\u1ec9 m\u1edf c\u1ed5ng 5432 cho subnet GKE core.</li> </ul>"},{"location":"services/token-service/data-model/#93-privilege-matrix-least-privilege","title":"9.3 Privilege Matrix (Least Privilege)","text":"DB User B\u1ea3ng / Schema Quy\u1ec1n <code>token_service</code> <code>jwks_keys</code> SELECT, INSERT, UPDATE <code>auth_sessions</code> SELECT, INSERT, UPDATE, DELETE <code>revoked_tokens</code> SELECT, INSERT, DELETE <code>token_stats</code> SELECT, INSERT, DELETE <code>audit_log.*</code> INSERT DB Admin T\u1ea5t c\u1ea3 ALL PRIVILEGES <pre><code>-- V\u00ed d\u1ee5 GRANT trong migration\nGRANT SELECT, INSERT, UPDATE ON jwks_keys TO token_service;\nGRANT SELECT, INSERT, UPDATE, DELETE ON auth_sessions TO token_service;\nGRANT SELECT, INSERT, DELETE ON revoked_tokens TO token_service;\nGRANT SELECT, INSERT, DELETE ON token_stats TO token_service;\nGRANT INSERT ON audit_log.* TO token_service;\n</code></pre>"},{"location":"services/token-service/data-model/#10-mo-rong-trong-tuong-lai","title":"10. M\u1edf r\u1ed9ng trong T\u01b0\u01a1ng lai","text":"<p>\u0110\u1ecbnh h\u01b0\u1edbng c\u00e1c c\u1ea3i ti\u1ebfn ti\u1ebfp theo nh\u1eb1m t\u0103ng kh\u1ea3 n\u0103ng quan s\u00e1t, hi\u1ec7u su\u1ea5t v\u00e0 tu\u00e2n th\u1ee7 quy m\u00f4 l\u1edbn h\u01a1n, \u0111\u1ed3ng th\u1eddi gi\u1eef v\u1eefng t\u00ednh m\u1edf r\u1ed9ng &amp; an to\u00e0n theo 5\u2605 Data Model Standard v\u00e0 c\u00e1c ADR li\u00ean quan.</p>"},{"location":"services/token-service/data-model/#101-embedded-rbac-claims","title":"10.1 Embedded RBAC Claims","text":"<ul> <li>M\u1ee5c ti\u00eau: Cho ph\u00e9p l\u01b0u tr\u1ef1c ti\u1ebfp b\u1ea3ng <code>rbac_claims</code> v\u00e0o JWT \u0111\u1ec3 gi\u1ea3m truy v\u1ea5n DB/Redis khi ph\u00e2n quy\u1ec1n.  </li> <li> <p>Thi\u1ebft k\u1ebf: <pre><code>  CREATE TABLE token_rbac_claims (\n    jti            UUID PRIMARY KEY REFERENCES revoked_tokens(jti),\n    rbac_payload   JSONB NOT NULL,        -- roles &amp; perms t\u1ea1i th\u1eddi \u0111i\u1ec3m issue\n    issued_at      TIMESTAMPTZ NOT NULL\n  );\n</code></pre></p> </li> <li> <p>Constraint &amp; Index:</p> </li> <li> <p><code>idx_token_rbac_claims_issued_at</code> on <code>(issued_at)</code> cho purge.</p> </li> <li>Retention: TTL 2 ph\u00fat (purge nhanh), theo ADR-024.</li> </ul>"},{"location":"services/token-service/data-model/#102-key-usage-logging","title":"10.2 Key Usage Logging","text":"<ul> <li>M\u1ee5c ti\u00eau: Thu th\u1eadp chi ti\u1ebft m\u1ed7i l\u1ea7n JWKS key signing/verification \u0111\u1ec3 ph\u00e2n t\u00edch v\u00e0 audit.</li> <li>Thi\u1ebft k\u1ebf:</li> </ul> <p><pre><code>CREATE TABLE key_usage_log (\n  log_id       UUID PRIMARY KEY,\n  kid          UUID NOT NULL REFERENCES jwks_keys(kid),\n  operation    TEXT NOT NULL CHECK (operation IN ('sign','verify')),\n  jti          UUID,                    -- n\u1ebfu operation='sign'\n  timestamp    TIMESTAMPTZ NOT NULL DEFAULT now(),\n  tenant_id    TEXT,\n  result       BOOLEAN NOT NULL\n);\n</code></pre> * Indexes:</p> <ul> <li>Composite <code>(kid, timestamp)</code> cho ph\u00e2n t\u00edch key hot-path.</li> <li>Purge: TTL 7 ng\u00e0y, job <code>purge_key_usage_log</code>.</li> </ul>"},{"location":"services/token-service/data-model/#103-partitioning-sharding","title":"10.3 Partitioning &amp; Sharding","text":"<ul> <li> <p>Partitioned Tables:</p> </li> <li> <p><code>revoked_tokens</code> theo <code>tenant_id</code> hash \u2192 t\u0103ng t\u1ed1c lookup.</p> </li> <li><code>token_stats</code> partition by date period (monthly) cho purge hi\u1ec7u qu\u1ea3.</li> <li>Shard Key: S\u1eed d\u1ee5ng <code>tenant_id</code> + <code>jti</code> l\u00e0m composite shard key khi m\u1edf r\u1ed9ng Multi-Region.</li> </ul>"},{"location":"services/token-service/data-model/#104-cross-region-replication","title":"10.4 Cross-Region Replication","text":"<ul> <li> <p>JWKS Replicas:</p> </li> <li> <p>T\u1ea1o b\u1ea3ng <code>jwks_keys_replica</code> t\u1ea1i region ph\u1ee5, s\u1eed d\u1ee5ng Logical Replication ho\u1eb7c Cloud SQL read replicas.</p> </li> <li>Failover: API Gateway c\u00f3 th\u1ec3 fallback verify t\u1eeb replica n\u1ebfu primary unreachable (theo ADR-004).</li> </ul>"},{"location":"services/token-service/data-model/#105-real-time-analytics-feed","title":"10.5 Real-time Analytics Feed","text":"<ul> <li>CDC Stream: D\u00f9ng Debezium \u2192 Pub/Sub topic <code>dw.token_changes.v1</code> \u2192 Data Platform.</li> <li>Mart Tables:</li> </ul> <p><pre><code>CREATE TABLE fct_token_issuance (\n  tenant_id TEXT,\n  date DATE,\n  issued_count BIGINT,\n  revoked_count BIGINT\n) PARTITION BY RANGE (date);\n</code></pre> * Use-case: B\u00e1o c\u00e1o issuance/revocation theo tenant, k\u1ebft h\u1ee3p BI Engine.</p>"},{"location":"services/token-service/data-model/#106-audit-history-versioning","title":"10.6 Audit History &amp; Versioning","text":"<ul> <li> <p>Temporal Tables:</p> </li> <li> <p>M\u1edf r\u1ed9ng <code>revoked_tokens</code> th\u00e0nh <code>revoked_tokens_history</code> l\u01b0u phi\u00ean b\u1ea3n tr\u01b0\u1edbc khi x\u00f3a/\u1ea9n danh.</p> </li> <li> <p>Schema Versioning:</p> </li> <li> <p>Ghi <code>schema_version</code> v\u00e0o setiap b\u1ea3n ghi \u0111\u1ec3 support ADR-023 khi migration ti\u1ebfp theo.</p> </li> </ul> <p>V\u1edbi khung m\u1edf r\u1ed9ng n\u00e0y, Token Service s\u1ebd s\u1eb5n s\u00e0ng \u0111\u00f3n \u0111\u1ea7u c\u00e1c y\u00eau c\u1ea7u m\u1edf r\u1ed9ng l\u1edbn (10k tenant), tu\u00e2n chu\u1ea9n ADR-023, ADR-024, ADR-030 v\u00e0 gi\u1eef p95 latency &lt; 5 ms cho m\u1ecdi truy v\u1ea5n d\u1eef li\u1ec7u.</p>"},{"location":"services/token-service/data-model/#11-enums","title":"11. ENUMs","text":"<p>M\u1ee5c \u0111\u00edch \u2013 \u0110\u1ecbnh ngh\u0129a t\u1eadp gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o t\u00ednh nh\u1ea5t qu\u00e1n v\u00e0 gi\u1ea3m l\u1ed7i \u0111\u1ea7u v\u00e0o. Theo 5\u2605 Data Model Standard, ch\u00fang ta d\u00f9ng <code>CHECK</code> constraints thay v\u00ec lo\u1ea1i ENUM DB ri\u00eang \u0111\u1ec3 gi\u1eef t\u00ednh di \u0111\u1ed9ng gi\u1eefa PostgreSQL v\u00e0 MariaDB.</p>"},{"location":"services/token-service/data-model/#111-reason-trong-revoked_tokens","title":"11.1 <code>reason</code> trong <code>revoked_tokens</code>","text":"<p>Token c\u00f3 th\u1ec3 b\u1ecb thu h\u1ed3i b\u1edfi c\u00e1c nguy\u00ean nh\u00e2n sau:</p> Gi\u00e1 tr\u1ecb M\u00f4 t\u1ea3 <code>logout</code> Ng\u01b0\u1eddi d\u00f9ng th\u1ef1c hi\u1ec7n \u0111\u0103ng xu\u1ea5t <code>rotation</code> Token b\u1ecb thu h\u1ed3i do xoay kh\u00f3a JWT <code>breach</code> Token b\u1ecb thu h\u1ed3i do ph\u00e1t hi\u1ec7n vi ph\u1ea1m b\u1ea3o m\u1eadt <code>expired</code> Token t\u1ef1 h\u1ebft h\u1ea1n <p>SQL (PostgreSQL / MariaDB)</p> <pre><code>ALTER TABLE revoked_tokens\n  ADD CONSTRAINT chk_revoked_tokens_reason\n    CHECK (reason IN (\n      'logout',\n      'rotation',\n      'breach',\n      'expired'\n    ));\n</code></pre>"},{"location":"services/token-service/data-model/#112-tuy-chon-event-trong-pubsub","title":"11.2 (T\u00f9y ch\u1ecdn) <code>event</code> trong Pub/Sub","text":"<p>\u0110\u1ec3 \u0111\u1ed3ng b\u1ed9 v\u1edbi ADR-030, c\u00e1c t\u00ean event c\u0169ng l\u00e0 \u201cenum\u201d tr\u00ean Pub/Sub:</p> Gi\u00e1 tr\u1ecb M\u00f4 t\u1ea3 <code>token.issued.v1</code> S\u1ef1 ki\u1ec7n khi JWT m\u1edbi \u0111\u01b0\u1ee3c ph\u00e1t h\u00e0nh <code>token.revoked.v1</code> S\u1ef1 ki\u1ec7n khi JWT b\u1ecb thu h\u1ed3i <code>token.introspect_fail.v1</code> S\u1ef1 ki\u1ec7n khi introspect tr\u1ea3 k\u1ebft qu\u1ea3 kh\u00f4ng h\u1ee3p l\u1ec7 <p>L\u01b0u \u00fd: Vi\u1ec7c validate event name th\u01b0\u1eddng di\u1ec5n ra \u1edf Consumer (API Gateway, Audit Service) qua schema registry, kh\u00f4ng qua DB.</p>"},{"location":"services/token-service/data-model/#113-best-practices","title":"11.3 Best Practices","text":"<ul> <li>Kh\u00f4ng hard-code gi\u00e1 tr\u1ecb trong \u1ee9ng d\u1ee5ng; tham chi\u1ebfu qua <code>CHECK</code> ho\u1eb7c enum type trong codegen.</li> <li>Khi m\u1edf r\u1ed9ng th\u00eam l\u00fd do ho\u1eb7c event m\u1edbi, lu\u00f4n update <code>CHECK</code> constraint v\u00e0 publish event schema m\u1edbi (<code>v2</code>).</li> <li>\u0110\u1ea3m b\u1ea3o migration theo 3-phase (ADR-023): Prepare \u2192 Transition \u2192 Cleanup khi thay \u0111\u1ed5i gi\u00e1 tr\u1ecb enum.</li> </ul>"},{"location":"services/token-service/data-model/#12-phu-luc-kiem-thu","title":"12. Ph\u1ee5 l\u1ee5c Ki\u1ec3m th\u1eed","text":"<p>\u0110\u1ec3 \u0111\u1ea3m b\u1ea3o t\u00ednh to\u00e0n v\u1eb9n, t\u00ednh \u0111\u00fang \u0111\u1eafn v\u00e0 hi\u1ec7u n\u0103ng c\u1ee7a Data Model, ch\u00fang ta \u00e1p d\u1ee5ng \u0111a t\u1ea7ng ki\u1ec3m th\u1eed theo 5\u2605 Data Model Standard.</p>"},{"location":"services/token-service/data-model/#121-unit-tests","title":"12.1 Unit Tests","text":"<ul> <li>Framework: pgTAP (PostgreSQL) / SQLUnit (MariaDB)</li> <li>C\u00e1c k\u1ecbch b\u1ea3n:</li> <li>Schema validation <ul> <li>Ki\u1ec3m tra c\u00e1c b\u1ea3ng t\u1ed3n t\u1ea1i v\u1edbi \u0111\u00fang c\u1ed9t, ki\u1ec3u, NOT NULL.  </li> <li><code>SELECT column_name FROM information_schema.columns WHERE table_name='revoked_tokens'</code> \u2192 so v\u1edbi spec.</li> </ul> </li> <li>Constraints <ul> <li>Th\u1eed ch\u00e8n <code>revoked_tokens</code> v\u1edbi <code>reason='invalid'</code> \u2192 ph\u1ea3i fail <code>CHECK chk_revoked_tokens_reason</code>.  </li> <li>Th\u1eed ch\u00e8n hai b\u1ea3n ghi <code>jwks_keys</code> c\u00f9ng <code>active=TRUE</code> \u2192 ph\u1ea3i fail unique.</li> </ul> </li> <li>Default values <ul> <li>Th\u1eed insert kh\u00f4ng cung c\u1ea5p <code>created_at</code> \u2192 gi\u00e1 tr\u1ecb m\u1eb7c \u0111\u1ecbnh l\u00e0 <code>now()</code>.  </li> <li>Th\u1eed insert <code>auth_sessions</code> kh\u00f4ng cung c\u1ea5p <code>last_active_at</code> \u2192 default <code>now()</code>.</li> </ul> </li> </ul>"},{"location":"services/token-service/data-model/#122-integration-tests","title":"12.2 Integration Tests","text":"<ul> <li>M\u00f4i tr\u01b0\u1eddng: Docker Compose v\u1edbi PostgreSQL v\u00e0 MariaDB, seed d\u1eef li\u1ec7u m\u1eabu.</li> <li>C\u00e1c k\u1ecbch b\u1ea3n:</li> <li>Full Issuance \u2192 Revocation \u2192 Stats <ul> <li>G\u1ecdi API <code>/v1/token/issue</code> \u2192 ki\u1ec3m tra <code>auth_sessions</code>, <code>jwks_keys</code> d\u00f9ng \u0111\u00fang <code>kid</code>.  </li> <li>G\u1ecdi <code>/v1/token/revoke</code> \u2192 b\u1ea3n ghi <code>revoked_tokens</code> t\u1ed3n t\u1ea1i \u2192 th\u1eed insert <code>token_stats</code>.  </li> <li>X\u00e1c nh\u1eadn <code>token_stats.jti</code> FK \u2192 khi x\u00f3a <code>revoked_tokens</code>, <code>token_stats</code> t\u1ef1 cascade delete.</li> </ul> </li> <li>Migration Script <ul> <li>Ch\u1ea1y Flyway t\u1eeb v1.0 \u2192 v1.2 \u2192 v1.3 \u2192 v1.4 trong m\u00f4i tr\u01b0\u1eddng test.  </li> <li>Ki\u1ec3m tra b\u1ea3ng <code>revoked_tokens_v2</code> t\u1ed3n t\u1ea1i \u1edf pha Prepare, sau Transition ch\u1ec9 \u0111\u1ecdc t\u1eeb v2, sau Cleanup ch\u1ec9 c\u00f2n v2.</li> </ul> </li> <li>Event Publication <ul> <li>Sau each DML tr\u00ean DB, theo d\u00f5i Pub/Sub mock \u2192 \u0111\u1ea3m b\u1ea3o event <code>token.*.v1</code> \u0111\u01b0\u1ee3c publish \u0111\u00fang payload.</li> </ul> </li> </ul>"},{"location":"services/token-service/data-model/#123-retention-purge-tests","title":"12.3 Retention &amp; Purge Tests","text":"<ul> <li>Framework: Scheduled job runner + test data expiration.</li> <li>C\u00e1c k\u1ecbch b\u1ea3n:</li> <li>TTL revoke <ul> <li>Insert <code>revoked_tokens.revoked_at = now() - '31 days'</code> \u2192 ch\u1ea1y <code>purge_revoked_tokens</code> \u2192 b\u1ea3n ghi b\u1ecb x\u00f3a.  </li> <li>B\u1ea3o \u0111\u1ea3m <code>purge_revoked_tokens_count</code> metric t\u0103ng ch\u00ednh x\u00e1c.</li> </ul> </li> <li>Anonymize stats <ul> <li>Insert <code>token_stats.recorded_at = now() - '91 days'</code> v\u1edbi <code>ip_address</code>, <code>device_info</code>.  </li> <li>Ch\u1ea1y <code>anonymize_token_stats</code> \u2192 c\u00e1c tr\u01b0\u1eddng PII ph\u1ea3i null; sau \u0111\u00f3 ch\u1ea1y <code>purge_token_stats</code> \u2192 b\u1ea3n ghi b\u1ecb x\u00f3a.</li> </ul> </li> </ul>"},{"location":"services/token-service/data-model/#124-performance-tests","title":"12.4 Performance Tests","text":"<ul> <li>C\u00f4ng c\u1ee5: pgbench / sysbench / JMeter</li> <li>Ch\u1ec9 s\u1ed1 m\u1ee5c ti\u00eau:</li> <li>p95 SELECT revoked_tokens \u2264 5 ms (with index).  </li> <li>p95 INSERT auth_sessions \u2264 10 ms.  </li> <li>Bulk purge 100k records in &lt; 30s.</li> <li>K\u1ecbch b\u1ea3n:</li> <li>Th\u1ef1c hi\u1ec7n 10k concurrent selects <code>SELECT 1 FROM revoked_tokens WHERE jti=?</code>.  </li> <li>Th\u1ef1c hi\u1ec7n 1k inserts <code>auth_sessions</code>/s v\u1edbi batch size 50.  </li> <li>Ch\u1ea1y purge job tr\u00ean 1M revoked_tokens.</li> </ul>"},{"location":"services/token-service/data-model/#125-security-privilege-tests","title":"12.5 Security &amp; Privilege Tests","text":"<ul> <li>Verify least privilege:</li> <li>K\u1ebft n\u1ed1i DB b\u1eb1ng role <code>token_service</code> \u2192 th\u1eed <code>DROP TABLE jwks_keys</code> \u2192 ph\u1ea3i b\u1ecb DENY.  </li> <li>K\u1ebft n\u1ed1i b\u1eb1ng <code>db_admin</code> \u2192 c\u00f3 quy\u1ec1n ALL.</li> <li>SSL enforcement:</li> <li>K\u1ebft n\u1ed1i kh\u00f4ng d\u00f9ng SSL \u2192 th\u1ea5t b\u1ea1i v\u1edbi <code>sslmode=require</code>.</li> <li>Audit Logging:</li> <li>Khi purge ho\u1eb7c rotation ch\u1ea1y, ki\u1ec3m tra <code>audit_log.purge_history</code> c\u00f3 b\u1ea3n ghi.</li> </ul>"},{"location":"services/token-service/data-model/#126-concurrency-consistency","title":"12.6 Concurrency &amp; Consistency","text":"<ul> <li>K\u1ecbch b\u1ea3n:</li> <li>Race Condition: 2 clients c\u00f9ng revoke <code>jti</code> \u2192 ch\u1ec9 m\u1ed9t b\u1ea3n ghi \u0111\u01b0\u1ee3c insert, kh\u00f4ng duplicate.  </li> <li>Dual-write migration: Trong pha Prepare, record inserted v\u00e0o c\u1ea3 b\u1ea3ng c\u0169 &amp; b\u1ea3ng v2, sau phase Transition ch\u1ec9 d\u00f9ng v2.</li> </ul>"},{"location":"services/token-service/data-model/#127-cicd-integration","title":"12.7 CI/CD Integration","text":"<ul> <li>Pipeline:</li> <li>Stage Unit Test (pgTAP).  </li> <li>Stage Integration Test (Dockerized DB).  </li> <li>Stage Migration Test (Flyway).  </li> <li>Stage Performance Test (light load).  </li> <li>B\u1ea3o \u0111\u1ea3m: 100 % test must pass before merge.</li> </ul> <p>V\u1edbi suite ki\u1ec3m th\u1eed tr\u00ean, Data Model c\u1ee7a Token Service \u0111\u1ea3m b\u1ea3o \u0111\u00fang, an to\u00e0n, hi\u1ec7u n\u0103ng v\u00e0 d\u1ec5 m\u1edf r\u1ed9ng, \u0111\u00e1p \u1ee9ng to\u00e0n b\u1ed9 ADR v\u00e0 5\u2605 Data Model Standard.  </p>"},{"location":"services/token-service/data-model/#13-lien-ket-tai-lieu","title":"13. \ud83d\udcda Li\u00ean k\u1ebft T\u00e0i li\u1ec7u","text":"<ul> <li>Interface Contract</li> <li>Data Model</li> <li>OpenAPI Spec</li> </ul>"},{"location":"services/token-service/data-model/#cac-quyet-inh-kien-truc-adr","title":"\ud83d\udd16 C\u00e1c Quy\u1ebft \u0111\u1ecbnh Ki\u1ebfn tr\u00fac (ADR)","text":"<ul> <li>ADR-003 Secrets Management: Quy tr\u00ecnh l\u01b0u tr\u1eef &amp; xoay kh\u00f3a b\u00ed m\u1eadt an to\u00e0n.  </li> <li>ADR-004 Security Policy: Ch\u00ednh s\u00e1ch b\u1ea3o m\u1eadt t\u1ed5ng th\u1ec3.  </li> <li>ADR-005 Environment Configuration Strategy: Chu\u1ea9n t\u00e1ch c\u1ea5u h\u00ecnh \u2013 <code>SERVICE__SECTION__KEY</code>.  </li> <li>ADR-006 Auth Strategy: Chi\u1ebfn l\u01b0\u1ee3c x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng v\u00e0 c\u1ea5p ph\u00e1t token.  </li> <li>ADR-009 API Governance: Quy t\u1eafc versioning, naming v\u00e0 style REST.  </li> <li>ADR-011 API Error Format: Quy \u01b0\u1edbc m\u00e3 l\u1ed7i &amp; th\u00f4ng \u0111i\u1ec7p l\u1ed7i (<code>namespace.snake_case</code>).  </li> <li>ADR-012 Response Structure: Chu\u1ea9n h\u00f3a c\u1ea5u tr\u00fac JSON response cho API.</li> <li>ADR-018 Release Approval Policy: Quy tr\u00ecnh ph\u00ea duy\u1ec7t ph\u00e1t h\u00e0nh.</li> <li>ADR-022 SLA &amp; SLO Monitoring: Khung gi\u00e1m s\u00e1t &amp; \u0111\u1ecbnh ngh\u0129a SLO.</li> <li>ADR-023 Schema Migration Strategy: 3-phase migration (Prepare \u2192 Transition \u2192 Cleanup).  </li> <li>ADR-024 Data Anonymization &amp; Retention: \u1ea8n danh PII v\u00e0 TTL d\u1eef li\u1ec7u.  </li> <li>ADR-026 Hard-Delete Policy: Quy tr\u00ecnh xo\u00e1 v\u0129nh vi\u1ec5n &amp; purge log.  </li> <li>ADR-030 Event Schema Governance: \u0110\u1eb7t t\u00ean &amp; version s\u1ef1 ki\u1ec7n <code>*.v{n}</code>.</li> </ul>"},{"location":"services/token-service/design/","title":"\ud83d\udce6 Token Service \u2013 Thi\u1ebft k\u1ebf Ki\u1ebfn tr\u00fac chi ti\u1ebft","text":""},{"location":"services/token-service/design/#1-muc-tieu-pham-vi","title":"1. \ud83c\udfaf M\u1ee5c ti\u00eau &amp; Ph\u1ea1m vi","text":""},{"location":"services/token-service/design/#11-muc-ich","title":"1.1. M\u1ee5c \u0111\u00edch","text":"<p><code>TokenService</code> \u0111\u01b0\u1ee3c x\u00e2y d\u1ef1ng \u0111\u1ec3 tr\u1edf th\u00e0nh th\u00e0nh ph\u1ea7n chuy\u00ean tr\u00e1ch qu\u1ea3n l\u00fd to\u00e0n b\u1ed9 v\u00f2ng \u0111\u1eddi c\u1ee7a token trong h\u1ec7 sinh th\u00e1i DX-VAS, nh\u1eb1m \u0111\u1ea3m b\u1ea3o b\u1ea3o m\u1eadt, kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng, t\u00ednh nh\u1ea5t qu\u00e1n v\u00e0 kh\u1ea3 n\u0103ng introspect token.</p>"},{"location":"services/token-service/design/#12-chuc-nang-chinh","title":"1.2. Ch\u1ee9c n\u0103ng ch\u00ednh","text":"<ul> <li>Sinh JWT token (access + refresh) sau khi x\u00e1c th\u1ef1c th\u00e0nh c\u00f4ng t\u1eeb <code>auth-service</code>.</li> <li>L\u00e0 n\u01a1i ki\u1ec3m tra v\u00e0 x\u00e1c minh token (<code>introspect</code>).</li> <li>H\u1ed7 tr\u1ee3 thu h\u1ed3i token (<code>revoke</code>) theo <code>jti</code>.</li> <li>Cung c\u1ea5p metadata chi ti\u1ebft cho m\u1ed7i phi\u00ean \u0111\u0103ng nh\u1eadp.</li> </ul>"},{"location":"services/token-service/design/#13-ngoai-pham-vi","title":"1.3. Ngo\u00e0i ph\u1ea1m vi","text":"<ul> <li>Kh\u00f4ng ch\u1ecbu tr\u00e1ch nhi\u1ec7m x\u00e1c th\u1ef1c danh t\u00ednh ng\u01b0\u1eddi d\u00f9ng (\u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n b\u1edfi <code>auth-service</code>).</li> <li>Kh\u00f4ng ph\u00e1t h\u00e0nh token d\u1ea1ng OTP, Magic Link.</li> </ul>"},{"location":"services/token-service/design/#14-nguoi-su-dung-chinh","title":"1.4. Ng\u01b0\u1eddi s\u1eed d\u1ee5ng ch\u00ednh","text":"<ul> <li><code>auth-service/master</code>, <code>auth-service/sub</code></li> <li><code>API Gateway</code></li> <li>Frontend client (gi\u00e1n ti\u1ebfp qua introspect/token-info)</li> </ul>"},{"location":"services/token-service/design/#2-thiet-ke-api","title":"2. \ud83c\udf10 Thi\u1ebft k\u1ebf API","text":"Method Endpoint M\u00f4 t\u1ea3 ng\u1eafn POST <code>/v1/token</code> Sinh m\u1edbi access &amp; refresh token POST <code>/v1/token/refresh</code> L\u00e0m m\u1edbi access token t\u1eeb refresh POST <code>/v1/token/introspect</code> Ki\u1ec3m tra h\u1ee3p l\u1ec7 c\u1ee7a JWT POST <code>/v1/token/revoke</code> Thu h\u1ed3i token theo jti GET <code>/jwks.json</code> JWKS public keys cho Gateway GET <code>/v1/token/info</code> L\u1ea5y metadata c\u1ee7a access token <p>HTTP Status \u2194 Error-code matrix</p> HTTP error.code Khi n\u00e0o x\u1ea3y ra 400 <code>common.validation_failed</code> Body schema sai 401 <code>auth.invalid_credentials</code> Refresh token sai 403 <code>token.revoked</code> Token b\u1ecb thu h\u1ed3i 409 <code>token.rotation_in_progress</code> Key \u0111ang rollover 422 <code>common.validation_error</code> JSON h\u1ee3p l\u1ec7 nh\u01b0ng kh\u00f4ng tho\u1ea3 \u0111i\u1ec1u ki\u1ec7n nghi\u1ec7p v\u1ee5 429 <code>common.rate_limited</code> V\u01b0\u1ee3t ng\u01b0\u1ee1ng RPS/burst (theo ADR-022) 500 <code>common.internal_error</code> Kh\u00f4ng mong \u0111\u1ee3i <p>Quy \u01b0\u1edbc path versioning M\u1ecdi endpoint c\u1ee7a Token Service tu\u00e2n \u0111\u1ecbnh d\u1ea1ng <code>/v{major}/\u2026</code> \u2013 v\u00ed d\u1ee5 <code>/v1/token</code>, <code>/v1/token/refresh</code>. Quy t\u1eafc n\u00e0y l\u1ea5y t\u1eeb ADR-009 (API Governance) v\u00e0 ADR-013 (Path Naming Convention) \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o kh\u1ea3 n\u0103ng thay \u0111\u1ed5i phi\u00ean b\u1ea3n m\u00e0 kh\u00f4ng ph\u00e1 v\u1ee1 client.</p> <p>Chi ti\u1ebft: Interface Contract &amp; OpenAPI</p>"},{"location":"services/token-service/design/#3-mo-hinh-du-lieu-chi-tiet","title":"3. \ud83d\uddc3\ufe0f M\u00f4 h\u00ecnh d\u1eef li\u1ec7u chi ti\u1ebft","text":"<p><code>token-service</code> kh\u00f4ng s\u1eed d\u1ee5ng c\u01a1 s\u1edf d\u1eef li\u1ec7u quan h\u1ec7. To\u00e0n b\u1ed9 tr\u1ea1ng th\u00e1i x\u00e1c th\u1ef1c (sessions, revoked tokens, JWKS keys) \u0111\u01b0\u1ee3c l\u01b0u tr\u1eef d\u01b0\u1edbi d\u1ea1ng Redis Key-Value v\u1edbi TTL ph\u00f9 h\u1ee3p, \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o t\u1ed1c \u0111\u1ed9 v\u00e0 kh\u1ea3 n\u0103ng thu h\u1ed3i.</p>"},{"location":"services/token-service/design/#31-redis-key-structure","title":"3.1. \ud83e\uddf1 Redis Key Structure","text":"Redis Key Ki\u1ec3u d\u1eef li\u1ec7u TTL M\u00f4 t\u1ea3 <code>session:{jti}</code> Hash/Object = <code>access_token.exp</code> Th\u00f4ng tin phi\u00ean x\u00e1c th\u1ef1c \u0111ang ho\u1ea1t \u0111\u1ed9ng <code>revoked:{jti}</code> Flag (string: <code>\"revoked\"</code>) Tu\u1ef3 ch\u1ec9nh (th\u01b0\u1eddng = access_token TTL) D\u00f9ng \u0111\u1ec3 \u0111\u00e1nh d\u1ea5u token \u0111\u00e3 b\u1ecb thu h\u1ed3i <code>jwks</code> JSON String Kh\u00f4ng TTL Danh s\u00e1ch public keys (JWKS) \u0111\u1ec3 verify JWT <code>jwk_kid:&lt;kid&gt;</code> String Tu\u1ef3 ch\u1ecdn Public key theo t\u1eebng <code>kid</code>, d\u00f9ng \u0111\u1ec3 rotate key d\u1ea7n d\u1ea7n"},{"location":"services/token-service/design/#vi-du-session2fd2b01e-83b1-4ff1-96bc-a076d42dc3cc","title":"\ud83d\udd0d V\u00ed d\u1ee5: <code>session:2fd2b01e-83b1-4ff1-96bc-a076d42dc3cc</code>","text":"<pre><code>{\n  \"user_id\": \"user_abc123\",\n  \"tenant_id\": \"vas-primary\",\n  \"login_method\": \"otp\",\n  \"issued_at\": \"2025-06-10T15:00:00Z\",\n  \"expires_at\": \"2025-06-10T16:00:00Z\",\n  \"metadata\": {\n    \"ip\": \"113.23.45.12\",\n    \"ua\": \"Mozilla/5.0 (Macintosh...)\"\n  }\n}\n</code></pre> <p>\ud83d\udccc Redis \u0111\u01b0\u1ee3c xem l\u00e0 ngu\u1ed3n d\u1eef li\u1ec7u t\u1ea1m th\u1eddi (ephemeral). N\u1ebfu key b\u1ecb m\u1ea5t (do TTL ho\u1eb7c crash), token t\u01b0\u01a1ng \u1ee9ng s\u1ebd tr\u1edf n\u00ean kh\u00f4ng th\u1ec3 introspect ho\u1eb7c revoke.</p>"},{"location":"services/token-service/design/#32-cau-truc-payload-metadata","title":"3.2. \ud83d\udce6 C\u1ea5u tr\u00fac Payload &amp; Metadata","text":""},{"location":"services/token-service/design/#321-tokenissuerequest-payload-gui-en-post-v1token","title":"3.2.1 \ud83d\udd10 TokenIssueRequest \u2013 Payload g\u1eedi \u0111\u1ebfn POST /v1/token","text":"Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>user_id</code> string \u2705 ID ng\u01b0\u1eddi d\u00f9ng duy nh\u1ea5t trong h\u1ec7 th\u1ed1ng <code>tenant_id</code> string \u2705 M\u00e3 tenant hi\u1ec7n h\u00e0nh <code>login_method</code> string (<code>google</code>, <code>otp</code>, <code>local</code>) \u2705 Ph\u01b0\u01a1ng th\u1ee9c x\u00e1c th\u1ef1c m\u00e0 ng\u01b0\u1eddi d\u00f9ng \u0111\u00e3 s\u1eed d\u1ee5ng <code>session_metadata</code> object \u274c D\u1eef li\u1ec7u ph\u1ee5 tr\u1ee3 b\u1ed5 sung cho phi\u00ean \u0111\u0103ng nh\u1eadp <code>exp_seconds</code> integer \u274c Th\u1eddi gian s\u1ed1ng c\u1ee7a access_token (t\u00ednh b\u1eb1ng gi\u00e2y) <p>Field <code>login_method</code> do <code>auth-service</code> x\u00e1c \u0111\u1ecbnh. <code>token-service</code> kh\u00f4ng x\u00e1c minh gi\u00e1 tr\u1ecb n\u00e0y m\u00e0 ch\u1ec9 s\u1eed d\u1ee5ng \u0111\u1ec3 nh\u00fang v\u00e0o token ho\u1eb7c ghi log.</p>"},{"location":"services/token-service/design/#322-jwt-claims-uoc-sinh-ra","title":"3.2.2 \ud83e\uddfe JWT Claims \u0111\u01b0\u1ee3c sinh ra","text":"<p>Access token (JWT) s\u1ebd bao g\u1ed3m c\u00e1c claims sau:</p> Claim Ki\u1ec3u M\u00f4 t\u1ea3 <code>sub</code> string M\u00e3 ng\u01b0\u1eddi d\u00f9ng (<code>user_id</code>) <code>tenant</code> string M\u00e3 tenant <code>login_method</code> string Ph\u01b0\u01a1ng th\u1ee9c x\u00e1c th\u1ef1c <code>jti</code> string M\u00e3 \u0111\u1ecbnh danh phi\u00ean duy nh\u1ea5t <code>iat</code> timestamp Th\u1eddi \u0111i\u1ec3m ph\u00e1t h\u00e0nh <code>exp</code> timestamp Th\u1eddi \u0111i\u1ec3m h\u1ebft h\u1ea1n <code>iss</code> string <code>\"token-service\"</code> <code>aud</code> string <code>\"dx_vas\"</code> ho\u1eb7c t\u00ean service s\u1eed d\u1ee5ng"},{"location":"services/token-service/design/#323-redis-session-key-session","title":"3.2.3 \ud83d\udcbe Redis Session (Key: session:) <p>(Chi ti\u1ebft \u0111\u00e3 \u0111\u01b0\u1ee3c m\u00f4 t\u1ea3 \u1edf <code>3.1</code>, kh\u00f4ng l\u1eb7p l\u1ea1i \u1edf \u0111\u00e2y.)</p>","text":""},{"location":"services/token-service/design/#324-audit-log-trace","title":"3.2.4 \ud83d\udcdd Audit Log &amp; Trace <ul> <li>Khi ph\u00e1t h\u00e0nh token th\u00e0nh c\u00f4ng, <code>token-service</code> g\u1eedi event:</li> </ul> <pre><code>{\n  \"event\": \"auth.token.issued\",\n  \"actor_id\": \"abc123\",\n  \"tenant_id\": \"vas-primary\",\n  \"metadata\": {\n    \"login_method\": \"otp\",\n    \"jti\": \"uuid\",\n    \"exp\": \"2025-06-10T16:00:00Z\"\n  }\n}\n</code></pre> <ul> <li> <p>Tr\u01b0\u1eddng <code>login_method</code> gi\u00fap:</p> </li> <li> <p>Ph\u00e2n t\u00edch h\u00e0nh vi login (OTP vs Google)</p> </li> <li>Ghi nh\u1eadn t\u1ef7 l\u1ec7 chuy\u1ec3n \u0111\u1ed5i</li> <li>Truy t\u00ecm c\u00e1c lu\u1ed3ng \u0111\u0103ng nh\u1eadp kh\u00f4ng h\u1ee3p l\u1ec7</li> </ul>  <p>\ud83d\udccc L\u01b0u \u00fd ki\u1ebfn tr\u00fac:</p> <ul> <li>M\u1ecdi tr\u01b0\u1eddng <code>login_method</code> v\u00e0 <code>metadata</code> \u0111\u1ec1u do <code>auth-service</code> truy\u1ec1n sang.</li> <li><code>token-service</code> kh\u00f4ng th\u1ef1c hi\u1ec7n x\u00e1c th\u1ef1c, ch\u1ec9 ghi nh\u1eadn v\u00e0 ph\u1ea3n \u00e1nh tr\u1ea1ng th\u00e1i.</li> </ul> <p>\ud83d\udc49 Chi ti\u1ebft s\u01a1 \u0111\u1ed3 ERD, \u0111\u1ecbnh ngh\u0129a b\u1ea3ng v\u00e0 chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed d\u1eef li\u1ec7u \u0111\u01b0\u1ee3c tr\u00ecnh b\u00e0y t\u1ea1i: \ud83d\udcc2 Data Model</p>","text":""},{"location":"services/token-service/design/#4-luong-xu-ly-nghiep-vu-chinh","title":"4. \ud83d\udd04 Lu\u1ed3ng x\u1eed l\u00fd nghi\u1ec7p v\u1ee5 ch\u00ednh","text":"<p><code>TokenService</code> l\u00e0 trung t\u00e2m ph\u00e1t h\u00e0nh v\u00e0 x\u00e1c th\u1ef1c token JWT trong to\u00e0n b\u1ed9 h\u1ec7 th\u1ed1ng. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c lu\u1ed3ng nghi\u1ec7p v\u1ee5 ch\u00ednh:</p>"},{"location":"services/token-service/design/#luong-1-sinh-token-sau-ang-nhap-thanh-cong","title":"\ud83d\udd10 Lu\u1ed3ng 1: Sinh Token sau \u0111\u0103ng nh\u1eadp th\u00e0nh c\u00f4ng","text":"<pre><code>sequenceDiagram\n    participant AuthService as Auth Service (Sub)\n    participant TokenService\n    participant Redis\n    participant Client\n\n    AuthService-&gt;&gt;TokenService: POST /token (user_id, session_id, scope,\u2026)\n    TokenService-&gt;&gt;TokenService: Sinh access_token + refresh_token (JWT)\n    TokenService-&gt;&gt;Redis: L\u01b0u jti c\u1ee7a refresh_token (TTL ~30d)\n    TokenService--&gt;&gt;AuthService: Tr\u1ea3 access_token, refresh_token\n    AuthService--&gt;&gt;Client: Tr\u1ea3 token cho frontend\n</code></pre>"},{"location":"services/token-service/design/#luong-2-lam-moi-access_token-bang-refresh_token","title":"\ud83d\udd01 Lu\u1ed3ng 2: L\u00e0m m\u1edbi access_token b\u1eb1ng refresh_token","text":"<pre><code>sequenceDiagram\n    participant Client\n    participant AuthService\n    participant TokenService\n    participant Redis\n\n    Client-&gt;&gt;AuthService: G\u1eedi refresh_token\n    AuthService-&gt;&gt;TokenService: POST /token/refresh\n    TokenService-&gt;&gt;Redis: Ki\u1ec3m tra jti c\u00f3 b\u1ecb revoke kh\u00f4ng\n    TokenService-&gt;&gt;TokenService: Gi\u1ea3i m\u00e3, validate claims\n    TokenService-&gt;&gt;TokenService: Sinh access_token m\u1edbi\n    TokenService--&gt;&gt;AuthService: Tr\u1ea3 token m\u1edbi\n    AuthService--&gt;&gt;Client: Tr\u1ea3 access_token m\u1edbi\n</code></pre>"},{"location":"services/token-service/design/#luong-3-thu-hoi-token-khi-logout","title":"\ud83d\udd12 Lu\u1ed3ng 3: Thu h\u1ed3i token khi logout","text":"<pre><code>sequenceDiagram\n    participant Client\n    participant AuthService\n    participant TokenService\n    participant Redis\n    participant DB\n\n    Client-&gt;&gt;AuthService: Logout\n    AuthService-&gt;&gt;TokenService: POST /token/revoke (jti, reason)\n    TokenService-&gt;&gt;Redis: Ghi jti v\u00e0o cache revoked\n    TokenService-&gt;&gt;DB: Ghi jti + reason v\u00e0o b\u1ea3ng revoked_tokens\n    TokenService--&gt;&gt;AuthService: Ghi nh\u1eadn th\u00e0nh c\u00f4ng\n</code></pre>"},{"location":"services/token-service/design/#luong-4-introspect-token-vi-du-tu-api-gateway","title":"\ud83e\uddea Lu\u1ed3ng 4: Introspect token (v\u00ed d\u1ee5 t\u1eeb API Gateway)","text":"<pre><code>sequenceDiagram\n    participant APIGateway\n    participant TokenService\n    participant Redis\n\n    APIGateway-&gt;&gt;TokenService: POST /token/introspect\n    TokenService-&gt;&gt;Redis: Ki\u1ec3m tra jti c\u00f3 b\u1ecb revoke kh\u00f4ng\n    TokenService-&gt;&gt;TokenService: Gi\u1ea3i m\u00e3 JWT, ki\u1ec3m tra exp, scope, session_id\n    TokenService--&gt;&gt;APIGateway: Tr\u1ea3 metadata c\u1ee7a token\n</code></pre>"},{"location":"services/token-service/design/#luong-5-fallback-khi-introspect-token-that-bai","title":"\ud83d\udd01 Lu\u1ed3ng 5: Fallback khi introspect token th\u1ea5t b\u1ea1i","text":"<p>Trong m\u1ed9t s\u1ed1 tr\u01b0\u1eddng h\u1ee3p (v\u00ed d\u1ee5: API Gateway kh\u00f4ng verify \u0111\u01b0\u1ee3c token ho\u1eb7c cache l\u1ed7i), c\u00f3 th\u1ec3 fallback sang introspect tr\u1ef1c ti\u1ebfp.</p> <pre><code>sequenceDiagram\n    participant APIGateway\n    participant TokenService\n    participant Redis\n\n    APIGateway-&gt;&gt;TokenService: POST /token/introspect\n    TokenService-&gt;&gt;Redis: Kh\u00f4ng truy c\u1eadp \u0111\u01b0\u1ee3c cache (timeout)\n    TokenService-&gt;&gt;TokenService: Gi\u1ea3i m\u00e3 JWT b\u1eb1ng JWKS\n    TokenService-&gt;&gt;DB: Ki\u1ec3m tra jti trong b\u1ea3ng revoked_tokens\n    TokenService--&gt;&gt;APIGateway: Tr\u1ea3 k\u1ebft qu\u1ea3 introspect\n</code></pre> <ul> <li>\u2705 Fallback logic \u0111\u1ea3m b\u1ea3o h\u1ec7 th\u1ed1ng kh\u00f4ng b\u1ecb \"fail closed\" m\u1ed9t c\u00e1ch v\u00f4 l\u00fd.</li> <li>C\u01a1 ch\u1ebf caching resilience \u0111\u01b0\u1ee3c khuy\u1ebfn ngh\u1ecb t\u1ea1i [ADR-012] &amp; [ADR-004].</li> </ul>"},{"location":"services/token-service/design/#luong-6-multi-key-rotation-rs256-hoac-es256","title":"\ud83d\udd11 Lu\u1ed3ng 6: Multi-key Rotation (RS256 ho\u1eb7c ES256)","text":"<p>\u0110\u1ec3 t\u0103ng t\u00ednh b\u1ea3o m\u1eadt, <code>TokenService</code> h\u1ed7 tr\u1ee3 xoay key \u0111\u1ecbnh k\u1ef3 th\u00f4ng qua <code>kid</code>.</p> <pre><code>sequenceDiagram\n    participant Operator\n    participant TokenService\n    participant Client\n    participant APIGateway\n\n    Operator-&gt;&gt;TokenService: C\u1eadp nh\u1eadt key m\u1edbi (priv + pub) v\u1edbi kid=\"key-202506\"\n    TokenService-&gt;&gt;JWKS: C\u1eadp nh\u1eadt public key m\u1edbi\n    Client-&gt;&gt;TokenService: \u0110\u0103ng nh\u1eadp nh\u1eadn token (kid = key-202506)\n    TokenService--&gt;&gt;Client: JWT signed b\u1eb1ng key m\u1edbi\n\n    APIGateway-&gt;&gt;JWKS: T\u1ef1 \u0111\u1ed9ng c\u1eadp nh\u1eadt keys \u0111\u1ecbnh k\u1ef3 (cache TTL = 1 ng\u00e0y)\n    APIGateway-&gt;&gt;Client: Verify token theo kid\n</code></pre> <p>\ud83d\udccc L\u01b0u \u00fd:</p> <ul> <li>Public keys \u0111\u01b0\u1ee3c c\u00f4ng b\u1ed1 qua <code>/jwks.json</code> v\u00e0 cache b\u1edfi c\u00e1c consumer (gateway, frontend, v.v.).</li> <li>Khi deploy key m\u1edbi, c\u1ea7n gi\u1eef key c\u0169 th\u00eam m\u1ed9t kho\u1ea3ng th\u1eddi gian (<code>grace period</code>) \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o token c\u0169 c\u00f2n hi\u1ec7u l\u1ef1c v\u1eabn \u0111\u01b0\u1ee3c verify th\u00e0nh c\u00f4ng.</li> </ul> <p>\ud83c\udfaf Nh\u1eefng k\u1ecbch b\u1ea3n n\u00e0y gi\u00fap \u0111\u1ea3m b\u1ea3o <code>TokenService</code>:</p> <ul> <li>T\u0103ng \u0111\u1ed9 s\u1eb5n s\u00e0ng (high availability) v\u1edbi fallback th\u00f4ng minh.</li> <li>D\u1ec5 m\u1edf r\u1ed9ng v\u00e0 b\u1ea3o m\u1eadt h\u01a1n nh\u1edd h\u1ed7 tr\u1ee3 \u0111a key v\u00e0 rotation \u0111\u1ecbnh k\u1ef3.</li> </ul> <p>\ud83d\udccc Ghi ch\u00fa b\u1ed5 sung:</p> <ul> <li>M\u1ecdi token \u0111\u1ec1u c\u00f3 tr\u01b0\u1eddng <code>jti</code> duy nh\u1ea5t gi\u00fap d\u1ec5 d\u00e0ng revoke ho\u1eb7c introspect.</li> <li>Vi\u1ec7c l\u01b0u <code>jti</code> v\u00e0o Redis gi\u00fap <code>TokenService</code> truy xu\u1ea5t nhanh (O(1)) \u0111\u1ec3 ki\u1ec3m tra revoked token.</li> <li>Refresh token ch\u1ec9 \u0111\u01b0\u1ee3c c\u1ea5p 1 l\u1ea7n. Rotation logic s\u1ebd c\u1eadp nh\u1eadt jti m\u1edbi m\u1ed7i l\u1ea7n refresh.</li> </ul> <p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 n\u1ed9i dung \u0111\u00e3 c\u1eadp nh\u1eadt m\u1ee5c <code>## 5. \ud83d\udce3 T\u01b0\u01a1ng t\u00e1c v\u1edbi c\u00e1c Service kh\u00e1c &amp; Lu\u1ed3ng s\u1ef1 ki\u1ec7n</code> cho file <code>token-service/design.md</code>, theo y\u00eau c\u1ea7u m\u1edbi:</p> <ul> <li>\u2705 PUB/SUB \u0111\u01b0\u1ee3c n\u00e2ng c\u1ea5p th\u00e0nh th\u00e0nh ph\u1ea7n ch\u00ednh th\u1ee9c.</li> <li>\u2705 B\u1ed5 sung th\u00eam th\u00f4ng \u0111i\u1ec7p chu\u1ea9n, m\u00f4 t\u1ea3 \u0111\u1ecbnh d\u1ea1ng payload.</li> <li>\u2705 \u0110\u1ea3m b\u1ea3o ph\u00f9 h\u1ee3p v\u1edbi ki\u1ebfn tr\u00fac \u0111a tenant, tu\u00e2n th\u1ee7 ADR-008 (Audit Logging), ADR-012 (Response Structure), ADR-018 (Release Policy), ADR-021 (External Observability).</li> </ul>"},{"location":"services/token-service/design/#5-tuong-tac-voi-cac-service-khac-luong-su-kien","title":"5. \ud83d\udce3 T\u01b0\u01a1ng t\u00e1c v\u1edbi c\u00e1c Service kh\u00e1c &amp; Lu\u1ed3ng s\u1ef1 ki\u1ec7n","text":"<p>Token Service kh\u00f4ng ch\u1ec9 l\u00e0 th\u00e0nh ph\u1ea7n ph\u1ee5c v\u1ee5 Auth Service Sub trong vi\u1ec7c c\u1ea5p ph\u00e1t v\u00e0 x\u00e1c th\u1ef1c token, m\u00e0 c\u00f2n \u0111\u00f3ng vai tr\u00f2 cung c\u1ea5p t\u00edn hi\u1ec7u b\u1ea3o m\u1eadt ch\u1ee7 \u0111\u1ed9ng qua k\u00eanh Pub/Sub \u0111\u1ec3 ph\u1ee5c v\u1ee5 auditing, observability, v\u00e0 b\u1ea3o m\u1eadt ch\u1ee7 \u0111\u1ed9ng.</p>"},{"location":"services/token-service/design/#51-giao-tiep-chinh-giua-cac-service","title":"5.1. Giao ti\u1ebfp ch\u00ednh gi\u1eefa c\u00e1c Service","text":"Service Endpoint M\u1ee5c \u0111\u00edch <code>auth-service/sub</code> <code>POST /token</code> T\u1ea1o token m\u1edbi cho phi\u00ean \u0111\u00e3 x\u00e1c th\u1ef1c. <code>auth-service/sub</code> <code>POST /token/refresh</code> C\u1ea5p token m\u1edbi t\u1eeb refresh token. <code>auth-service/sub</code> <code>POST /token/revoke</code> Thu h\u1ed3i token theo JTI. <code>auth-service/sub</code> <code>POST /token/introspect</code> X\u00e1c th\u1ef1c t\u00ednh h\u1ee3p l\u1ec7 c\u1ee7a token v\u00e0 tr\u00edch xu\u1ea5t metadata. <code>api-gateway</code> <code>GET /.well-known/jwks.json</code> L\u1ea5y public key \u0111\u1ec3 x\u00e1c minh ch\u1eef k\u00fd token JWT. <code>audit-logging-service</code> <code>Pub/Sub subscriber</code> Ghi log c\u00e1c s\u1ef1 ki\u1ec7n li\u00ean quan \u0111\u1ebfn token (revoked, issued)."},{"location":"services/token-service/design/#52-giao-tiep-voi-he-thong-pubsub","title":"5.2. Giao ti\u1ebfp v\u1edbi h\u1ec7 th\u1ed1ng Pub/Sub","text":"<p>Token Service b\u1eaft bu\u1ed9c ph\u00e1t h\u00e0nh c\u00e1c s\u1ef1 ki\u1ec7n chu\u1ea9n l\u00ean Pub/Sub \u0111\u1ec3 c\u00e1c th\u00e0nh ph\u1ea7n nh\u01b0 Audit Logging, Security Analytics, ho\u1eb7c c\u00e1c h\u1ec7 th\u1ed1ng Realtime Alert c\u00f3 th\u1ec3 x\u1eed l\u00fd ti\u1ebfp.</p> Event Name Trigger Description <code>token.issued.v1</code> Khi c\u1ea5p token m\u1edbi Th\u00f4ng tin metadata c\u1ee7a access token v\u00e0 session <code>token.revoked.v1</code> Khi m\u1ed9t token b\u1ecb thu h\u1ed3i Truy d\u1ea5u s\u1ef1 ki\u1ec7n b\u1ea3o m\u1eadt <code>token.introspect_fail.v1</code> Khi ki\u1ec3m tra token th\u1ea5t b\u1ea1i Ph\u00e1t hi\u1ec7n token gi\u1ea3 m\u1ea1o ho\u1eb7c sai l\u1ec7ch c\u1ea5u tr\u00fac"},{"location":"services/token-service/design/#cau-truc-payload-mau-tokenrevoked","title":"\ud83d\udd36 C\u1ea5u tr\u00fac payload m\u1eabu <code>token.revoked</code> <pre><code>{\n  \"event\": \"token.revoked.v1\",\n  \"timestamp\": \"2025-06-07T12:34:56Z\",\n  \"tenant_id\": \"vas001\",\n  \"user_id\": \"user-123\",\n  \"jti\": \"abc123-token-id\",\n  \"session_id\": \"sess-xyz\",\n  \"revoked_by\": \"system\",  // ho\u1eb7c \"user\"\n  \"reason\": \"logout\",\n  \"ip_address\": \"203.0.113.42\"\n}\n</code></pre>","text":""},{"location":"services/token-service/design/#cau-truc-payload-mau-tokenissued","title":"\ud83d\udd37 C\u1ea5u tr\u00fac payload m\u1eabu <code>token.issued</code> <pre><code>{\n  \"event\": \"token.issued.v1\",\n  \"timestamp\": \"2025-06-07T12:00:00Z\",\n  \"tenant_id\": \"vas001\",\n  \"user_id\": \"user-123\",\n  \"jti\": \"xyz-token-001\",\n  \"session_id\": \"sess-abc-789\",\n  \"ip_address\": \"192.168.1.5\",\n  \"device\": {\n    \"type\": \"web\",\n    \"user_agent\": \"Mozilla/5.0\",\n    \"app_version\": \"v1.0.3\"\n  }\n}\n</code></pre>","text":""},{"location":"services/token-service/design/#53-kien-truc-trien-khai-pubsub","title":"5.3. Ki\u1ebfn tr\u00fac tri\u1ec3n khai Pub/Sub","text":"<pre><code>graph TD\n  A[TokenService] -- issue/revoke --&gt; B[Pub/Sub: token.*]\n  B --&gt; C[AuditLogging Service]\n  B --&gt; D[Security Alerting]\n  B --&gt; E[Real-time Dashboard]\n</code></pre> <ul> <li>\u0110\u1ea3m b\u1ea3o ti\u00eau chu\u1ea9n schema s\u1ef1 ki\u1ec7n: tu\u00e2n theo <code>adr-030-event-schema-governance.md</code></li> <li>D\u1ec5 d\u00e0ng t\u00edch h\u1ee3p m\u1edf r\u1ed9ng: c\u00e1c adapter m\u1edbi (EDR, SIEM, ML Threat Detection) c\u00f3 th\u1ec3 d\u1ec5 d\u00e0ng subscribe.</li> </ul>"},{"location":"services/token-service/design/#54-luu-vet-trong-audit-logs","title":"5.4. L\u01b0u v\u1ebft trong Audit Logs","text":"<p>Ngo\u00e0i vi\u1ec7c ph\u00e1t Pub/Sub, Token Service c\u0169ng s\u1ebd g\u1eedi b\u1ea3n sao log n\u1ed9i b\u1ed9 \u0111\u1ebfn <code>audit-logging-service</code> qua c\u01a1 ch\u1ebf chu\u1ea9n c\u1ee7a to\u00e0n h\u1ec7 th\u1ed1ng.</p> Action Service Consumer Audit Target Token Issued <code>auth-service/sub</code> <code>audit-logging-service</code> Token Revoked <code>auth-service/sub</code> <code>audit-logging-service</code> Token Introspect <code>api-gateway</code> ho\u1eb7c <code>admin</code> <code>audit-logging-service</code> <p>\u2705 T\u00f3m l\u1ea1i:</p> <ul> <li>Token Service b\u1eaft bu\u1ed9c ph\u00e1t h\u00e0nh s\u1ef1 ki\u1ec7n l\u00ean Pub/Sub v\u1edbi schema chu\u1ea9n.</li> <li> <p>M\u1ecdi s\u1ef1 ki\u1ec7n c\u00f3 th\u1ec3 d\u00f9ng \u0111\u1ec3:</p> </li> <li> <p>Theo d\u00f5i t\u00ecnh tr\u1ea1ng b\u1ea3o m\u1eadt theo th\u1eddi gian th\u1ef1c.</p> </li> <li>Audit h\u00e0nh vi \u0111\u0103ng nh\u1eadp/\u0111\u0103ng xu\u1ea5t.</li> <li>Ph\u00e1t hi\u1ec7n t\u1ea5n c\u00f4ng brute-force ho\u1eb7c replay.</li> <li>Hi\u1ec3n th\u1ecb tr\u1ea1ng th\u00e1i phi\u00ean ho\u1ea1t \u0111\u1ed9ng tr\u00ean frontend c\u1ee7a user.</li> </ul>"},{"location":"services/token-service/design/#6-bao-mat-phan-quyen","title":"6. \ud83d\udd10 B\u1ea3o m\u1eadt &amp; Ph\u00e2n quy\u1ec1n","text":"<p>TokenService l\u00e0 tuy\u1ebfn ph\u00f2ng th\u1ee7 \u0111\u1ea7u ti\u00ean v\u00e0 \u0111\u00f3ng vai tr\u00f2 trung t\u00e2m trong c\u01a1 ch\u1ebf x\u00e1c th\u1ef1c, do \u0111\u00f3 c\u00e1c ch\u00ednh s\u00e1ch b\u1ea3o m\u1eadt \u0111\u01b0\u1ee3c \u00e1p d\u1ee5ng c\u1ef1c k\u1ef3 nghi\u00eam ng\u1eb7t, bao g\u1ed3m:</p>"},{"location":"services/token-service/design/#61-co-che-bao-ve-endpoint","title":"6.1. C\u01a1 ch\u1ebf b\u1ea3o v\u1ec7 endpoint","text":"Endpoint C\u01a1 ch\u1ebf b\u1ea3o v\u1ec7 <code>POST /v1/token</code> Y\u00eau c\u1ea7u ch\u1ee9ng th\u1ef1c th\u00e0nh c\u00f4ng t\u1eeb <code>auth-service/sub</code> <code>POST /v1/token/refresh</code> Ki\u1ec3m tra refresh token h\u1ee3p l\u1ec7, kh\u00f4ng b\u1ecb thu h\u1ed3i <code>POST /v1/token/revoke</code> X\u00e1c th\u1ef1c token ho\u1eb7c JTI; ki\u1ec3m tra session ownership <code>POST /v1/token/introspect</code> Y\u00eau c\u1ea7u x\u00e1c th\u1ef1c v\u00e0 ph\u00e2n quy\u1ec1n (d\u00e0nh cho n\u1ed9i b\u1ed9) <code>GET /.well-known/jwks.json</code> Public, tuy nhi\u00ean \u0111\u01b0\u1ee3c ki\u1ec3m so\u00e1t cache v\u00e0 audit"},{"location":"services/token-service/design/#62-kiem-tra-phong-chong-lam-dung-token","title":"6.2. Ki\u1ec3m tra &amp; ph\u00f2ng ch\u1ed1ng l\u1ea1m d\u1ee5ng token","text":"<ul> <li>\u2705 Replay Protection:</li> <li>M\u1ed7i token c\u00f3 m\u1ed9t <code>jti</code> (JWT ID) duy nh\u1ea5t, \u0111\u01b0\u1ee3c l\u01b0u v\u00e0o Redis khi b\u1ecb revoke.</li> <li> <p>Lu\u1ed3ng ki\u1ec3m tra s\u1ebd \u0111\u1ed1i chi\u1ebfu <code>jti</code> v\u1edbi danh s\u00e1ch \u0111\u00e3 thu h\u1ed3i (blacklist).</p> </li> <li> <p>\u2705 Token Rotation Policy:</p> </li> <li>Refresh token c\u00f3 th\u1ec3 b\u1ecb thu h\u1ed3i sau m\u1ed7i l\u1ea7n s\u1eed d\u1ee5ng (token rotation).</li> <li> <p>H\u1ea1n ch\u1ebf c\u00e1c cu\u1ed9c t\u1ea5n c\u00f4ng khi refresh token b\u1ecb r\u00f2 r\u1ec9.</p> </li> <li> <p>\u2705 Signature Verification:</p> </li> <li>S\u1eed d\u1ee5ng thu\u1eadt to\u00e1n <code>RS256</code> v\u1edbi public/private key kh\u00e1c nhau cho t\u1eebng m\u00f4i tr\u01b0\u1eddng.</li> <li> <p>Endpoint <code>/jwks.json</code> lu\u00f4n cung c\u1ea5p <code>kid</code> h\u1ee3p l\u1ec7, tu\u00e2n theo cache policy ng\u1eafn.</p> </li> <li> <p>\u2705 X\u00e1c th\u1ef1c \u1ee9ng d\u1ee5ng n\u1ed9i b\u1ed9:</p> </li> <li>Endpoint <code>introspect</code> \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf ch\u1ec9 cho service n\u1ed9i b\u1ed9, y\u00eau c\u1ea7u mTLS ho\u1eb7c API key gi\u1edbi h\u1ea1n IP.</li> </ul>"},{"location":"services/token-service/design/#63-phan-quyen-theo-hanh-vi-rbac","title":"6.3. Ph\u00e2n quy\u1ec1n theo h\u00e0nh vi (RBAC)","text":"H\u00e0nh vi Y\u00eau c\u1ea7u permission (g\u1ee3i \u00fd) Thu h\u1ed3i token (admin) <code>token.revoke.any</code> Thu h\u1ed3i token (user t\u1ef1 l\u00e0m) <code>token.revoke.self</code> Introspect token (gateway) <code>token.introspect</code> Xoay kh\u00f3a JWKS <code>token.key.rotate</code> <p>S\u1eed d\u1ee5ng <code>x-required-permission</code> trong OpenAPI \u0111\u1ec3 th\u1ec3 hi\u1ec7n r\u00f5 y\u00eau c\u1ea7u permission cho m\u1ed7i operation.</p>"},{"location":"services/token-service/design/#64-gioi-han-kiem-soat-hanh-vi","title":"6.4. Gi\u1edbi h\u1ea1n &amp; ki\u1ec3m so\u00e1t h\u00e0nh vi","text":"<ul> <li>\ud83d\udd10 Rate Limiting:</li> <li>Gi\u1edbi h\u1ea1n s\u1ed1 l\u1ea7n g\u1ecdi <code>/token</code> v\u00e0 <code>/refresh</code> tr\u00ean m\u1ed7i IP ho\u1eb7c user ID.</li> <li> <p>T\u00edch h\u1ee3p Cloud Armor ho\u1eb7c reCAPTCHA \u1edf l\u1edbp frontend n\u1ebfu v\u01b0\u1ee3t ng\u01b0\u1ee1ng.</p> </li> <li> <p>\ud83d\udd0d Audit \u0111\u1ea7y \u0111\u1ee7:</p> </li> <li> <p>M\u1ed7i h\u00e0nh vi t\u1ea1o, revoke, introspect token \u0111\u1ec1u \u0111\u01b0\u1ee3c ghi v\u00e0o <code>audit-logging-service</code>.</p> </li> <li> <p>\ud83e\uddef T\u1ef1 \u0111\u1ed9ng h\u00f3a ph\u1ea3n \u1ee9ng b\u1ea3o m\u1eadt:</p> </li> <li>N\u1ebfu c\u00f3 nhi\u1ec1u <code>token.introspect.fail</code> trong th\u1eddi gian ng\u1eafn t\u1eeb m\u1ed9t IP \u2192 k\u00edch ho\u1ea1t c\u1ea3nh b\u00e1o ho\u1eb7c ch\u1eb7n IP t\u1ea1m th\u1eddi.</li> </ul>"},{"location":"services/token-service/design/#65-bao-ve-cau-hinh-khoa-bi-mat-theo-adr-003-secrets-management","title":"6.5 B\u1ea3o v\u1ec7 c\u1ea5u h\u00ecnh &amp; kh\u00f3a b\u00ed m\u1eadt  (theo ADR-003 \u2013 Secrets Management)","text":"Th\u00e0nh ph\u1ea7n C\u01a1 ch\u1ebf Chi ti\u1ebft RSA private key GCP Secret Manager \u2013 versioned \u2022 L\u01b0u m\u1ed7i key d\u01b0\u1edbi <code>projects/&lt;proj&gt;/secrets/jwt_key/versions/*</code>.\u2022 Alias <code>active</code> \u2194 version \u0111ang d\u00f9ng; alias <code>next</code> \u2194 version m\u1edbi sinh ra. Xoay kh\u00f3a (rotation job <code>rotate_key</code>) IaC \u00b7 Cloud Build 1. Sinh version m\u1edbi, g\u00e1n alias <code>next</code>.2. C\u1eadp nh\u1eadt <code>kid</code> &amp; redeploy TokenSvc (song song 2 key).3. Grace-period 24 h cho client refresh JWT.4. Chuy\u1ec3n alias <code>active</code> \u2192 version m\u1edbi, x\u00f3a version c\u0169. IAM &amp; Workload Identity Principle of least privilege <code>svc-token-signer@dx-vas-core.iam.gserviceaccount.com</code> ch\u1ec9 c\u00f3 <code>roles/secretmanager.secretAccessor</code>. Audit &amp; Event Immutable log + Pub/Sub \u2022 Ghi b\u1ea3n ghi <code>audit_log.key_rotation</code> (schema v1: <code>who</code>, <code>when</code>, <code>reason</code>, <code>old_kid</code>, <code>new_kid</code>).\u2022 Ph\u00e1t s\u1ef1 ki\u1ec7n <code>key.rotated.v1</code> l\u00ean topic <code>security.v1</code>. Env-Config b\u00ed m\u1eadt kh\u00e1c Secret Manager + ADR-005 mapping Bi\u1ebfn env tu\u00e2n format <code>SERVICE__SECTION__KEY</code>, v\u00ed d\u1ee5:<code>TOKEN_SERVICE__RUNTIME__REDIS_URI</code>, <code>TOKEN_SERVICE__SECRET__KMS_KEY_ID</code>. <p>L\u01b0u \u00fd v\u1eadn h\u00e0nh \u2022 N\u1ebfu JWKS fetch l\u1ed7i &gt; 3 l\u1ea7n / 5 ph\u00fat, API Gateway fail-closed t\u1ea5t c\u1ea3 request. \u2022 Rotation job ch\u1ea1y 90 ng\u00e0y/l\u1ea7n (theo SLA Security), c\u00f3 th\u1ec3 trigger kh\u1ea9n c\u1ea5p qua <code>POST /admin/rotate-key</code> (RBAC <code>security.rotate_key</code>). \u2022 Th\u00f4ng tin key kh\u00f4ng bao gi\u1edd ghi v\u00e0o log th\u00f4ng th\u01b0\u1eddng; ch\u1ec9 l\u01b0u HASH \u0111\u1ea7u m\u1ea9u \u0111\u1ec3 \u0111\u1ed1i chi\u1ebfu.</p>"},{"location":"services/token-service/design/#66-test-kiem-chung-bao-mat","title":"6.6. Test &amp; ki\u1ec3m ch\u1ee9ng b\u1ea3o m\u1eadt","text":"<ul> <li>\u2705 C\u00e1c test b\u1eaft bu\u1ed9c:</li> <li>Token tampering (s\u1eeda payload)</li> <li>Replay token c\u0169</li> <li>Expired token</li> <li>Invalid signature</li> <li>\u2705 \u00c1p d\u1ee5ng tool nh\u01b0 <code>jwt.io debugger</code>, <code>burpsuite</code>, v\u00e0 <code>OWASP ZAP</code> \u0111\u1ec3 ki\u1ec3m th\u1eed \u0111\u1ecbnh k\u1ef3.</li> </ul>"},{"location":"services/token-service/design/#7-cau-hinh-phu-thuoc","title":"7. \u2699\ufe0f C\u1ea5u h\u00ecnh &amp; Ph\u1ee5 thu\u1ed9c","text":"<p>Token Service y\u00eau c\u1ea7u m\u1ed9t s\u1ed1 c\u1ea5u h\u00ecnh \u0111\u1ed9ng (qua <code>.env</code>) v\u00e0 ph\u1ee5 thu\u1ed9c v\u00e0o c\u00e1c d\u1ecbch v\u1ee5 h\u1ea1 t\u1ea7ng c\u1ee5 th\u1ec3 \u0111\u1ec3 v\u1eadn h\u00e0nh \u1ed5n \u0111\u1ecbnh, b\u1ea3o m\u1eadt v\u00e0 c\u00f3 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng.</p>"},{"location":"services/token-service/design/#71-bien-moi-truong-quan-trong-env","title":"7.1. Bi\u1ebfn m\u00f4i tr\u01b0\u1eddng quan tr\u1ecdng (<code>.env</code>)","text":"Bi\u1ebfn M\u00f4 t\u1ea3 B\u1eaft bu\u1ed9c <code>ENVIRONMENT</code> <code>local</code>, <code>staging</code>, <code>production</code> \u2705 <code>PORT</code> C\u1ed5ng ch\u1ea1y service \u2705 <code>TOKEN_SERVICE__SECRET__JWT_KEY_PATH</code> \u0110\u01b0\u1eddng d\u1eabn t\u1edbi private key \u0111\u1ec3 k\u00fd JWT (PEM) \u2705 <code>JWT_PUBLIC_KEY_PATH</code> \u0110\u01b0\u1eddng d\u1eabn t\u1edbi public key ph\u1ee5c v\u1ee5 <code>/jwks.json</code> \u2705 <code>JWT_EXP_SECONDS</code> Th\u1eddi gian s\u1ed1ng c\u1ee7a access token (gi\u00e2y), v\u00ed d\u1ee5 <code>900</code> (15 ph\u00fat) \u2705 <code>JWT_REFRESH_EXP_SECONDS</code> TTL c\u1ee7a refresh token (gi\u00e2y), v\u00ed d\u1ee5 <code>604800</code> (7 ng\u00e0y) \u2705 <code>JWT_ISSUER</code> Issuer c\u1ee7a token (<code>vas.dx-auth</code>) \u2705 <code>TOKEN_SERVICE__RUNTIME__REDIS_URI</code> K\u1ebft n\u1ed1i Redis \u0111\u1ec3 l\u01b0u revoked tokens v\u00e0 introspect cache \u2705 <code>DB_URL</code> K\u1ebft n\u1ed1i PostgreSQL (n\u1ebfu ghi l\u1ea1i key rotation ho\u1eb7c log) \u26d4\ufe0f (Optional) <code>PUBSUB_TOPIC_ISSUED</code> T\u00ean topic Pub/Sub ph\u00e1t s\u1ef1 ki\u1ec7n <code>token.issued</code> \u2705 <code>PUBSUB_TOPIC_REVOKED</code> T\u00ean topic Pub/Sub ph\u00e1t s\u1ef1 ki\u1ec7n <code>token.revoked</code> \u2705 <code>JWKS_ROTATION_CRON</code> L\u1ecbch quay v\u00f2ng key (CRON format), v\u00ed d\u1ee5 <code>\"0 0 * * *\"</code> \u26d4\ufe0f (Optional) <code>CACHE_CONTROL_HEADER</code> TTL cho header <code>/jwks.json</code>, v\u00ed d\u1ee5 <code>public, max-age=300</code> \u2705 TOKEN_SERVICE__SECRET__JWT_KEY_ID Secret Manager resource ID c\u1ee7a RSA private key (<code>projects/\u2026/secrets/jwt_key/versions/active</code>) \u2705 KMS_KEY_ID ID Cloud KMS key (n\u1ebfu d\u00f9ng k\u00fd qua KMS) \u26d4\ufe0f (Optional)"},{"location":"services/token-service/design/#env-config-mapping-adr-005","title":"Env-Config mapping (ADR-005)    ENV var Config-Center key Sample value     <code>TOKEN_SERVICE__RUNTIME__REDIS_URI</code> <code>token-service/runtime/redis_uri</code> <code>redis://redis:6379/0</code>   <code>KMS_KEY_ID</code> <code>token-service/secret/kms_key_id</code> <code>projects/\u2026/cryptoKeys/jwt-key</code>   <code>TOKEN_SERVICE__SECRET__JWT_KEY_ID</code> <code>token-service/secret/jwt_key_id</code> <code>projects/\u2026/secrets/jwt_key/versions/active</code>     <p>\ud83d\udcd8 L\u01b0u \u00fd: File <code>.env.example</code> ph\u1ea3i lu\u00f4n \u0111\u1ed3ng b\u1ed9 v\u1edbi t\u1ea5t c\u1ea3 c\u00e1c bi\u1ebfn m\u00f4i tr\u01b0\u1eddng.</p>","text":""},{"location":"services/token-service/design/#72-phu-thuoc-dich-vu-external-dependencies","title":"7.2. Ph\u1ee5 thu\u1ed9c d\u1ecbch v\u1ee5 (External Dependencies)","text":"Th\u00e0nh ph\u1ea7n M\u1ee5c \u0111\u00edch s\u1eed d\u1ee5ng Ph\u01b0\u01a1ng \u00e1n backup Redis L\u01b0u revoked tokens (JTI blacklist), cache introspect Redis Sentinel ho\u1eb7c GCP Memorystore PostgreSQL L\u01b0u th\u00f4ng tin audit key rotation, request logs GCP Cloud SQL + Automated Backups Pub/Sub (GCP) Ph\u00e1t th\u00f4ng \u0111i\u1ec7p <code>token.*</code> \u0111\u1ec3 c\u00e1c service kh\u00e1c subscribe Dead Letter Topics + retry Audit Logging Service Nh\u1eadn log s\u1ef1 ki\u1ec7n <code>token.issued</code>, <code>token.revoked</code> Fallback l\u01b0u local n\u1ebfu l\u1ed7i Auth Service Sub Giao ti\u1ebfp 2 chi\u1ec1u khi x\u00e1c th\u1ef1c phi\u00ean N/A"},{"location":"services/token-service/design/#73-khoa-bi-mat-va-private-keys","title":"7.3. Kh\u00f3a b\u00ed m\u1eadt v\u00e0 private keys","text":"<ul> <li>To\u00e0n b\u1ed9 private keys \u0111\u01b0\u1ee3c l\u01b0u t\u1ea1i:</li> <li><code>GCP Secret Manager</code> (Production)</li> <li><code>.secrets/</code> folder m\u00e3 h\u00f3a (Local)</li> <li>Private key versioning c\u00f3 \u0111\u1ecbnh danh <code>kid</code>, g\u1eafn v\u00e0o JWT header.</li> </ul> <p>\ud83d\udd10 Quy tr\u00ecnh quay v\u00f2ng key tu\u00e2n theo ADR-006: t\u1ea1o b\u1ea3n m\u1edbi, c\u1eadp nh\u1eadt JWKS, gi\u1eef song song trong <code>grace_period</code>.</p>"},{"location":"services/token-service/design/#74-cau-hinh-cache-introspection","title":"7.4. C\u1ea5u h\u00ecnh cache &amp; introspection","text":"<ul> <li>Introspect Cache:</li> <li>Redis l\u01b0u k\u1ebft qu\u1ea3 introspect (valid, expired, revoked).</li> <li> <p>TTL khuy\u1ebfn ngh\u1ecb: 5 ph\u00fat.</p> </li> <li> <p>JWKS Endpoint Cache:</p> </li> <li>Header HTTP: <code>Cache-Control: public, max-age=300</code></li> <li>Frontend/API Gateway c\u1ea7n t\u00f4n tr\u1ecdng TTL n\u00e0y.</li> </ul>"},{"location":"services/token-service/design/#75-cau-hinh-quan-sat-alert","title":"7.5. C\u1ea5u h\u00ecnh quan s\u00e1t &amp; alert","text":"Lo\u1ea1i c\u1ea3nh b\u00e1o M\u00f4 t\u1ea3 S\u1ed1 l\u01b0\u1ee3ng <code>token.revoked</code> t\u0103ng \u0111\u1ed9t bi\u1ebfn C\u00f3 th\u1ec3 do brute-force ho\u1eb7c l\u1ed7i session S\u1ed1 l\u1ea7n introspect th\u1ea5t b\u1ea1i C\u00f3 th\u1ec3 do token sai, gi\u1ea3 m\u1ea1o, ho\u1eb7c l\u1ed7i system Thi\u1ebfu kh\u00f3a JWKS h\u1ee3p l\u1ec7 G\u00e2y l\u1ed7i verify token t\u1eeb ph\u00eda client L\u1ed7i kh\u00f4ng g\u1eedi \u0111\u01b0\u1ee3c s\u1ef1 ki\u1ec7n Pub/Sub Nguy c\u01a1 m\u1ea5t t\u00edn hi\u1ec7u b\u1ea3o m\u1eadt cho downstream system <pre><code>graph TD\n  A(Token Service)\n  A --&gt;|Redis URL| B[Redis]\n  A --&gt;|DB_URL| C[PostgreSQL]\n  A --&gt;|Pub/Sub Topic| D[Audit Logging Service]\n  A --&gt;|JWKS| E[API Gateway]\n</code></pre>"},{"location":"services/token-service/design/#8-chien-luoc-kiem-thu","title":"8. \ud83e\uddea Chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed","text":"<p>Token Service \u0111\u1ea3m nhi\u1ec7m vai tr\u00f2 b\u1ea3o m\u1eadt quan tr\u1ecdng, do \u0111\u00f3 ki\u1ec3m th\u1eed kh\u00f4ng ch\u1ec9 l\u00e0 m\u1ed9t b\u01b0\u1edbc trong ph\u00e1t tri\u1ec3n, m\u00e0 l\u00e0 m\u1ed9t y\u00eau c\u1ea7u b\u1eaft bu\u1ed9c \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o t\u00ednh \u0111\u00fang \u0111\u1eafn, an to\u00e0n v\u00e0 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng.</p>"},{"location":"services/token-service/design/#81-unit-test-kiem-thu-on-vi","title":"8.1. Unit Test (Ki\u1ec3m th\u1eed \u0111\u01a1n v\u1ecb)","text":"<p>\u2705 B\u1eaft bu\u1ed9c \u0111\u1ea1t \u2265 90% coverage tr\u00ean c\u00e1c module logic ch\u00ednh:</p> Module Ph\u1ea1m vi ki\u1ec3m th\u1eed <code>TokenIssuer</code> - Sinh JWT \u0111\u00fang c\u1ea5u h\u00ecnh- G\u1eafn \u0111\u00fang claims, kid <code>TokenValidator</code> - Ki\u1ec3m tra token h\u1ee3p l\u1ec7, sai ch\u1eef k\u00fd, h\u1ebft h\u1ea1n <code>RefreshHandler</code> - Lu\u1ed3ng c\u1ea5p m\u1edbi token t\u1eeb refresh token, ki\u1ec3m tra TTL <code>RevocationRegistry</code> - Ghi nh\u1eadn token b\u1ecb thu h\u1ed3i, ki\u1ec3m tra JTI <code>JWKSProvider</code> - Tr\u1ea3 v\u1ec1 danh s\u00e1ch public key h\u1ee3p l\u1ec7 <code>KeyRotationJob</code> - Sinh key m\u1edbi, c\u1eadp nh\u1eadt JWKS, ki\u1ec3m tra TTL/grace period <p>Test tools: - Python: <code>pytest</code>, <code>pytest-cov</code>, <code>freezegun</code> - Node.js: <code>jest</code>, <code>supertest</code></p>"},{"location":"services/token-service/design/#82-integration-test-kiem-thu-tich-hop","title":"8.2. Integration Test (Ki\u1ec3m th\u1eed t\u00edch h\u1ee3p)","text":"<p>\u2705 M\u00f4 ph\u1ecfng h\u00e0nh vi gi\u1eefa c\u00e1c th\u00e0nh ph\u1ea7n:</p> K\u1ecbch b\u1ea3n ki\u1ec3m th\u1eed M\u1ee5c ti\u00eau \u0110\u0103ng nh\u1eadp v\u00e0 l\u1ea5y JWT Check claims, expiry Refresh token c\u00f2n h\u1ea1n \u2192 sinh access token m\u1edbi TTL, valid session Refresh token h\u1ebft h\u1ea1n \u2192 b\u1ecb t\u1eeb ch\u1ed1i 401 Unauthorized Thu h\u1ed3i token \u2192 introspect th\u1ea5t b\u1ea1i \u0110\u1ea3m b\u1ea3o revoked c\u00f3 hi\u1ec7u l\u1ef1c <code>.well-known/jwks.json</code> \u2192 lu\u00f4n tr\u1ea3 \u0111\u00fang keys Verify key rotation C\u00e1c service kh\u00e1c introspect token Simulate API Gateway/RBAC Audit log \u0111\u01b0\u1ee3c g\u1eedi t\u1edbi <code>audit-logging-service</code> \u0111\u00fang \u0111\u1ecbnh d\u1ea1ng Quan s\u00e1t h\u1ec7 th\u1ed1ng <p>Test tools: - Docker Compose: kh\u1edfi \u0111\u1ed9ng full-stack mock (Redis, PostgreSQL) - K\u1ecbch b\u1ea3n Postman/Newman/Playwright API</p>"},{"location":"services/token-service/design/#83-contract-test-openapi-based","title":"8.3. Contract Test (OpenAPI-based)","text":"<p>\u2705 \u00c1p d\u1ee5ng <code>ADR-010</code> v\u00e0 <code>adr-012-response-structure.md</code></p> <ul> <li>S\u1eed d\u1ee5ng <code>openapi.yaml</code> \u0111\u1ec3:</li> <li>Ki\u1ec3m tra m\u1ecdi response ph\u1ea3i \u0111\u00fang schema</li> <li>\u0110\u1ea3m b\u1ea3o <code>ErrorEnvelope</code>, <code>ResponseMeta</code>, headers nh\u01b0 <code>X-Request-ID</code> lu\u00f4n c\u00f3 m\u1eb7t</li> <li>Tools \u0111\u1ec1 xu\u1ea5t:</li> <li><code>schemathesis</code>, <code>dredd</code>, <code>openapi-tester</code>, <code>resolv</code></li> </ul>"},{"location":"services/token-service/design/#84-security-negative-test","title":"8.4. Security &amp; Negative Test","text":"<p>\u2705 Ph\u1ea3i c\u00f3 c\u00e1c test cho:</p> T\u00ecnh hu\u1ed1ng b\u1ea5t th\u01b0\u1eddng K\u1ebft qu\u1ea3 k\u1ef3 v\u1ecdng Token b\u1ecb s\u1eeda payload 401 Unauthorized Token sai ch\u1eef k\u00fd 401 Token h\u1ebft h\u1ea1n 401 Token b\u1ecb revoke nh\u01b0ng v\u1eabn introspect 403 ho\u1eb7c 401 Replay refresh token 403 JTI b\u1ecb block \u2192 kh\u00f4ng ch\u1ea5p nh\u1eadn n\u1eefa 403 <p>Tool g\u1ee3i \u00fd: - <code>OWASP ZAP</code> (qu\u00e9t API) - <code>jwt.io</code> debugger - Custom script test v\u1edbi nhi\u1ec1u lo\u1ea1i token gi\u1ea3 m\u1ea1o</p>"},{"location":"services/token-service/design/#85-performance-test-optional","title":"8.5. Performance Test (Optional)","text":"<p>\u2705 \u0110\u1ec1 xu\u1ea5t n\u1ebfu tri\u1ec3n khai production:</p> <ul> <li>K\u1ecbch b\u1ea3n:</li> <li>Sinh 10,000 token trong v\u00f2ng 1 ph\u00fat \u2192 \u0111\u1ea3m b\u1ea3o &lt; 50ms/token</li> <li>1000 l\u01b0\u1ee3t introspect/s (qua Redis cache)</li> <li>\u0110\u00e1nh gi\u00e1 kh\u1ea3 n\u0103ng ph\u1ee5c v\u1ee5 JWKS t\u1eeb CDN / API Gateway</li> </ul>"},{"location":"services/token-service/design/#86-cicd-integration","title":"8.6. CI/CD Integration","text":"<ul> <li>Test \u0111\u01b0\u1ee3c t\u00edch h\u1ee3p v\u00e0o pipeline GitHub Actions/GitLab CI:</li> <li>\u2705 <code>pre-commit</code>: format + lint</li> <li>\u2705 <code>pytest/jest</code> unit + integration</li> <li>\u2705 <code>contract-test</code> (d\u1ef1a tr\u00ean OpenAPI)</li> <li>\u2705 <code>security scan</code>: d\u00f9ng <code>bandit</code>, <code>semgrep</code>, <code>npm audit</code></li> </ul>"},{"location":"services/token-service/design/#87-tu-ong-sinh-test-tu-openapi","title":"8.7. T\u1ef1 \u0111\u1ed9ng sinh test t\u1eeb OpenAPI","text":"<ul> <li>C\u00f3 th\u1ec3 d\u00f9ng:</li> <li><code>schemathesis</code> \u0111\u1ec3 t\u1ef1 sinh c\u00e1c request b\u1ea5t th\u01b0\u1eddng t\u1eeb spec</li> <li><code>openapi-enforcer</code> + <code>chai</code> (Node.js)</li> <li>K\u1ebft h\u1ee3p v\u1edbi <code>Postman</code> \u0111\u1ec3 x\u00e1c th\u1ef1c <code>examples</code> trong <code>openapi.yaml</code></li> </ul> <p>\ud83d\udccc T\u1ea5t c\u1ea3 c\u00e1c test \u0111\u1ec1u \u0111\u01b0\u1ee3c t\u1ed5 ch\u1ee9c theo tree <code>tests/unit</code>, <code>tests/integration</code>, <code>tests/security</code> v\u00e0 ch\u1ea1y t\u1ef1 \u0111\u1ed9ng trong CI tr\u01b0\u1edbc khi PR \u0111\u01b0\u1ee3c merge.</p> <p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 n\u1ed9i dung chi ti\u1ebft v\u00e0 \u0111\u1ea7y \u0111\u1ee7 cho m\u1ee5c <code>## 9. \ud83d\udcc8 Quan s\u00e1t &amp; Gi\u00e1m s\u00e1t</code> c\u1ee7a <code>token-service/design.md</code>, tu\u00e2n th\u1ee7 chu\u1ea9n 5\u2605 observability v\u00e0 c\u00e1c ADR li\u00ean quan (\u0111\u1eb7c bi\u1ec7t l\u00e0 <code>adr-004-security</code>, <code>adr-008-audit-logging</code>, <code>adr-022-sla-slo-monitoring</code>):</p>"},{"location":"services/token-service/design/#9-quan-sat-giam-sat","title":"9. \ud83d\udcc8 Quan s\u00e1t &amp; Gi\u00e1m s\u00e1t","text":"<p>Token Service \u0111\u00f3ng vai tr\u00f2 trung t\u00e2m trong x\u00e1c th\u1ef1c &amp; b\u1ea3o m\u1eadt c\u1ee7a h\u1ec7 th\u1ed1ng DX-VAS. Do \u0111\u00f3, c\u1ea7n \u0111\u01b0\u1ee3c quan s\u00e1t k\u1ef9 l\u01b0\u1ee1ng v\u1ec1 m\u1eb7t: - S\u1ee9c kh\u1ecfe (health) - T\u00ednh kh\u1ea3 d\u1ee5ng (availability) - T\u1ea5n c\u00f4ng &amp; h\u00e0nh vi b\u1ea5t th\u01b0\u1eddng</p>"},{"location":"services/token-service/design/#91-logging","title":"9.1. Logging","text":"<ul> <li>Chu\u1ea9n \u0111\u1ecbnh d\u1ea1ng: theo <code>adr-012-response-structure.md</code></li> <li>M\u1ecdi request ph\u1ea3i c\u00f3 <code>X-Request-ID</code>, log theo trace-id</li> <li>Log security-critical:</li> <li>Token \u0111\u01b0\u1ee3c ph\u00e1t h\u00e0nh</li> <li>Token b\u1ecb thu h\u1ed3i</li> <li>L\u1ed7i x\u00e1c th\u1ef1c (token h\u1ebft h\u1ea1n, sai ch\u1eef k\u00fd, gi\u1ea3 m\u1ea1o)</li> <li>Log \u0111\u01b0\u1ee3c g\u1eedi v\u1ec1:</li> <li><code>stdout</code> (local/dev)</li> <li>Google Cloud Logging (production)</li> </ul> <p>V\u00ed d\u1ee5 log JSON: <pre><code>{\n  \"timestamp\": \"2025-06-07T09:42:00Z\",\n  \"level\": \"INFO\",\n  \"trace_id\": \"b83f3f98-2d2f-4110-a7f2-b7d7dfc9f3c2\",\n  \"message\": \"Token issued\",\n  \"user_id\": \"user_123\",\n  \"jti\": \"abc123\",\n  \"ip_address\": \"123.45.67.89\"\n}\n</code></pre></p>"},{"location":"services/token-service/design/#92-metrics-prometheus","title":"9.2. Metrics (Prometheus)","text":""},{"location":"services/token-service/design/#a-metrics-chinh","title":"a. Metrics ch\u00ednh    T\u00ean Metric M\u00f4 t\u1ea3     <code>token_issued_total</code> T\u1ed5ng s\u1ed1 token \u0111\u01b0\u1ee3c ph\u00e1t h\u00e0nh   <code>token_revoked_total</code> T\u1ed5ng s\u1ed1 token b\u1ecb thu h\u1ed3i   <code>token_verify_failed_total</code> Token invalid (h\u1ebft h\u1ea1n, sai ch\u1eef k\u00fd...)   <code>jwks_rotation_count</code> S\u1ed1 l\u1ea7n quay v\u00f2ng JWKS   <code>jwks_cache_hit_ratio</code> Ph\u1ea7n tr\u0103m JWKS truy xu\u1ea5t t\u1eeb cache (1-H)*   <code>token_request_duration_seconds</code> Histogram th\u1eddi gian x\u1eed l\u00fd 1 request     <p><code>jwks_cache_hit_ratio = hits / (hits + miss)</code> \u2013 M\u1ee5c ti\u00eau \u2265 98 %, c\u1ea3nh b\u00e1o n\u1ebfu &lt; 90 % 10\u2032.</p>","text":""},{"location":"services/token-service/design/#b-vi-du-bieu-o-tren-grafana","title":"b. V\u00ed d\u1ee5 bi\u1ec3u \u0111\u1ed3 tr\u00ean Grafana <ul> <li> <p>Dashboard: Token Service Overview</p> </li> <li> <p>Panel 1: <code>token_issued_total</code> theo tenant</p> </li> <li>Panel 2: Th\u1eddi gian x\u1eed l\u00fd trung b\u00ecnh <code>/token</code> trong 5 ph\u00fat</li> <li>Panel 3: Error rate t\u1eeb <code>token_verify_failed_total</code></li> <li>Panel 4: T\u1ec9 l\u1ec7 revoked tokens b\u1ecb truy c\u1eadp l\u1ea1i (attack detection)</li> </ul>","text":""},{"location":"services/token-service/design/#93-tracing","title":"9.3. Tracing","text":"<ul> <li> <p>T\u00edch h\u1ee3p v\u1edbi OpenTelemetry:</p> </li> <li> <p><code>api-gateway</code> \u2192 <code>auth-service/sub</code> \u2192 <code>token-service</code></p> </li> <li>M\u1ed7i request \u0111\u01b0\u1ee3c g\u1eafn trace-id</li> <li>C\u00f3 th\u1ec3 xem flow call token issuance, introspection</li> <li>H\u1ed7 tr\u1ee3 GCP Trace ho\u1eb7c Jaeger (trong dev)</li> </ul>"},{"location":"services/token-service/design/#94-alerting-slo-monitoring","title":"9.4. Alerting &amp; SLO Monitoring","text":"<p>Tu\u00e2n th\u1ee7 theo <code>adr-022-sla-slo-monitoring.md</code></p>"},{"location":"services/token-service/design/#a-canh-bao-khan-cap","title":"a. C\u1ea3nh b\u00e1o kh\u1ea9n c\u1ea5p    \u0110i\u1ec1u ki\u1ec7n M\u1ee9c \u0111\u1ed9 H\u00e0nh \u0111\u1ed9ng     <code>token_verify_failed_total &gt; 50</code>/5 ph\u00fat \u26a0\ufe0f Warning Ki\u1ec3m tra t\u1ea5n c\u00f4ng token gi\u1ea3 m\u1ea1o   Kh\u00f4ng c\u00f3 <code>jwks_rotation_count</code> &gt; 24h \ud83d\udd25 Critical C\u00f3 th\u1ec3 g\u00e2y verify failure to\u00e0n h\u1ec7 th\u1ed1ng   <code>token_issued_total</code> gi\u1ea3m b\u1ea5t th\u01b0\u1eddng \u26a0\ufe0f Warning Ki\u1ec3m tra lu\u1ed3ng login ho\u1eb7c refresh   <code>jwks_cache_hit_ratio</code> &lt; 0.90 trong 10\u2032 \ud83d\udd25 Critical Ki\u1ec3m tra Redis cache, JWKS endpoint; n\u1ebfu Redis down \u2192 chuy\u1ec3n ch\u1ebf \u0111\u1ed9 <code>introspect</code> t\u1ea1m","text":""},{"location":"services/token-service/design/#b-service-level-objectives-slo","title":"b. Service-Level Objectives (SLO)    M\u1ee5c ti\u00eau Gi\u00e1 tr\u1ecb     Uptime <code>/token</code>, <code>/jwks.json</code> \u2265 99.95%   Token issuance latency (p95) &lt; 100ms   JWKS cache hit ratio \u2265 98%   Rate of revoked-token re-use &lt; 1%","text":""},{"location":"services/token-service/design/#95-audit-logging","title":"9.5. Audit Logging","text":"<ul> <li> <p>S\u1ef1 ki\u1ec7n <code>token.issued</code>, <code>token.revoked</code> ph\u1ea3i \u0111\u01b0\u1ee3c:</p> </li> <li> <p>G\u1eedi qua Pub/Sub topic (tu\u00e2n th\u1ee7 <code>adr-008</code>)</p> </li> <li>Ghi l\u1ea1i d\u1ea1ng chu\u1ea9n audit log (d\u00f9ng <code>audit-logging-service</code>)</li> </ul> <p>V\u00ed d\u1ee5 message:</p> <pre><code>{\n  \"event\": \"token.revoked\",\n  \"jti\": \"abc123\",\n  \"user_id\": \"user_456\",\n  \"revoked_at\": \"2025-06-07T10:00:00Z\",\n  \"reason\": \"logout\"\n}\n</code></pre>"},{"location":"services/token-service/design/#96-healthcheck","title":"9.6. Healthcheck","text":"<ul> <li><code>/healthz</code>: ki\u1ec3m tra Redis, JWKS keys, background jobs</li> <li><code>/readyz</code>: ki\u1ec3m tra n\u1ebfu JWKS \u0111\u00e3 s\u1eb5n s\u00e0ng ph\u1ee5c v\u1ee5 client</li> </ul> <p>D\u00f9ng \u0111\u1ec3 t\u00edch h\u1ee3p v\u00e0o load balancer ho\u1eb7c CI/CD gate.</p>"},{"location":"services/token-service/design/#10-o-tin-cay-phuc-hoi","title":"10. \ud83d\ude80 \u0110\u1ed9 tin c\u1eady &amp; Ph\u1ee5c h\u1ed3i","text":"<p>Token Service l\u00e0 m\u1ed9t d\u1ecbch v\u1ee5 n\u1ec1n t\u1ea3ng b\u1ea3o m\u1eadt, y\u00eau c\u1ea7u t\u00ednh s\u1eb5n s\u00e0ng c\u1ef1c cao. B\u1ea5t k\u1ef3 s\u1ef1 c\u1ed1 n\u00e0o \u0111\u1ec1u c\u00f3 th\u1ec3 \u1ea3nh h\u01b0\u1edfng to\u00e0n h\u1ec7 th\u1ed1ng. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c chi\u1ebfn l\u01b0\u1ee3c \u0111\u1ea3m b\u1ea3o \u0111\u1ed9 tin c\u1eady v\u00e0 kh\u1ea3 n\u0103ng ph\u1ee5c h\u1ed3i:</p>"},{"location":"services/token-service/design/#101-zero-downtime-deployment","title":"10.1. Zero Downtime Deployment","text":"<p>\u2705 Tu\u00e2n th\u1ee7 <code>adr-014-zero-downtime.md</code> v\u00e0 <code>adr-015-deployment-strategy.md</code>:</p> <ul> <li>Tri\u1ec3n khai theo chi\u1ebfn l\u01b0\u1ee3c Rolling Update ho\u1eb7c Blue-Green Deployment</li> <li>D\u00f9ng readinessProbe v\u00e0 livenessProbe \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o ch\u1ec9 nh\u1eadn traffic khi service s\u1eb5n s\u00e0ng</li> <li>D\u00f9ng feature flags \u0111\u1ec3 t\u00e1ch bi\u1ec7t release v\u00e0 rollout</li> </ul>"},{"location":"services/token-service/design/#102-auto-scaling-load-balancing","title":"10.2. Auto-Scaling &amp; Load Balancing","text":"<p>\u2705 Tu\u00e2n th\u1ee7 <code>adr-016-auto-scaling.md</code></p> <ul> <li>Horizontal Pod Autoscaler (HPA) theo:</li> <li>CPU \u2265 70%</li> <li>request latency \u2265 200ms</li> <li>C\u00e2n b\u1eb1ng t\u1ea3i qua GCP Load Balancer ho\u1eb7c Istio Ingress</li> <li>JWKS endpoint (<code>/.well-known/jwks.json</code>) n\u00ean \u0111\u01b0\u1ee3c cache CDN ho\u1eb7c Cloudflare \u0111\u1ec3 gi\u1ea3m t\u1ea3i</li> </ul>"},{"location":"services/token-service/design/#103-graceful-fallback","title":"10.3. Graceful Fallback","text":"T\u00ecnh hu\u1ed1ng s\u1ef1 c\u1ed1 H\u00e0nh \u0111\u1ed9ng Gateway H\u00e0nh \u0111\u1ed9ng Token Service L\u01b0u \u00fd SRE Redis Cluster (revoked_tokens) M\u1ea5t k\u1ebft n\u1ed1i 1. V\u1eabn x\u00e1c th\u1ef1c ch\u1eef k\u00fd b\u1eb1ng JWKS (offline).2. B\u1eadt degrade-mode: Gateway chuy\u1ec3n sang g\u1ecdi <code>POST /v1/token/introspect</code> cho m\u1ecdi request (c\u00f3 throttle 200 RPS). Gi\u1eef b\u1ea3ng <code>revoked_tokens</code> in-memory LRU (size 50 k); song song retry k\u1ebft n\u1ed1i Redis. Alert <code>revoked_cache_down</code> \ud83d\udd25; SRE ki\u1ec3m tra Memorystore, VPC-SC. Token Service Unavailable Gateway fail-closed (HTTP 503). \u2014 Alert <code>token_service_down</code> \ud83d\udd25; auto-rollback qua Argo Rollouts. JWKS fetch l\u1ed7i &gt; 3 l\u1ea7n / 5 ph\u00fat Gateway reject m\u1ecdi request (<code>502 jwks.unavailable</code>). \u2014 H\u1ebft s\u1ef1 c\u1ed1 \u2192 hit ratio JWKS \u2265 98 % t\u1ef1 clear. <p>L\u01b0u \u00fd: Thi\u1ebft k\u1ebf m\u1edbi kh\u00f4ng c\u00f2n fallback qua DB; Token Service ch\u1ec9 ph\u1ee5 thu\u1ed9c Redis v\u00e0 b\u1ed9 nh\u1edb RAM cho mode kh\u1ea9n c\u1ea5p</p>"},{"location":"services/token-service/design/#104-high-availability-architecture","title":"10.4. High Availability Architecture","text":"<ul> <li>Redis:</li> <li>Redis Sentinel ho\u1eb7c Redis Cluster v\u1edbi 3 node (quorum)</li> <li>PostgreSQL:</li> <li>CloudSQL HA ho\u1eb7c Patroni Cluster</li> <li>TokenService:</li> <li>Tri\u1ec3n khai &gt;= 3 replicas</li> <li>T\u1ef1 \u0111\u1ed9ng restart khi g\u1eb7p l\u1ed7i kh\u00f4ng ph\u1ee5c h\u1ed3i</li> </ul>"},{"location":"services/token-service/design/#105-retry-circuit-breaker","title":"10.5. Retry &amp; Circuit Breaker","text":"<ul> <li>Retry v\u1edbi exponential backoff cho:</li> <li>G\u1ecdi DB (max 3 l\u1ea7n)</li> <li>G\u1eedi log \u0111\u1ebfn Pub/Sub</li> <li>Circuit breaker:</li> <li>D\u1eebng ph\u00e1t token n\u1ebfu Redis unavailable &gt; 30s li\u00ean ti\u1ebfp</li> </ul>"},{"location":"services/token-service/design/#106-disaster-recovery","title":"10.6. Disaster Recovery","text":"<ul> <li>To\u00e0n b\u1ed9 JWKS keys \u0111\u01b0\u1ee3c backup h\u00e0ng gi\u1edd v\u00e0o Cloud Storage</li> <li>Audit logs l\u01b0u v\u00e0o Pub/Sub \u2192 kh\u00f4ng m\u1ea5t d\u1eef li\u1ec7u d\u00f9 service down</li> <li>C\u00f3 th\u1ec3 deploy l\u1ea1i to\u00e0n b\u1ed9 service trong 15 ph\u00fat t\u1eeb config IaC (Terraform)</li> </ul>"},{"location":"services/token-service/design/#107-am-bao-backward-compatibility","title":"10.7. \u0110\u1ea3m b\u1ea3o backward compatibility","text":"<ul> <li>JWKS rotation \u0111\u1ea3m b\u1ea3o:</li> <li>Key m\u1edbi ph\u00e1t h\u00e0nh \u2192 JWKS th\u00eam tr\u01b0\u1edbc 5 ph\u00fat</li> <li>Key c\u0169 gi\u1eef l\u1ea1i \u00edt nh\u1ea5t 15 ph\u00fat (grace period)</li> <li>Token kh\u00f4ng b\u1ecb revoke v\u1eabn ti\u1ebfp t\u1ee5c d\u00f9ng \u0111\u01b0\u1ee3c \u2192 tr\u00e1nh m\u1ea5t session</li> </ul>"},{"location":"services/token-service/design/#108-kiem-thu-truoc-khi-release","title":"10.8. Ki\u1ec3m th\u1eed tr\u01b0\u1edbc khi release","text":"<ul> <li>\u2705 <code>contract testing</code> \u0111\u1ea3m b\u1ea3o backward compatibility</li> <li>\u2705 <code>load testing</code> tr\u01b0\u1edbc release l\u1edbn: simulate 1,000 TPS</li> <li>\u2705 <code>chaos testing</code>: shutdown Redis, \u0111\u1ed5i key b\u1ea5t ng\u1edd \u2192 \u0111\u1ea3m b\u1ea3o service ph\u1ea3n \u1ee9ng \u0111\u00fang</li> </ul> <p>\ud83d\udccc T\u00f3m t\u1eaft: Token Service \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf v\u1edbi nhi\u1ec1u l\u1edbp d\u1ef1 ph\u00f2ng, fallback, autoscaling v\u00e0 circuit breaking \u0111\u1ec3 \u0111\u1ea1t \u0111\u1ed9 tin c\u1eady &gt;99.95%, ngay c\u1ea3 trong t\u00ecnh hu\u1ed1ng m\u1ea5t Redis ho\u1eb7c key rotation tr\u1ee5c tr\u1eb7c.</p>"},{"location":"services/token-service/design/#11-hieu-nang-kha-nang-mo-rong","title":"11. \u26a1\ufe0f Hi\u1ec7u n\u0103ng &amp; Kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng","text":"<p>Token Service l\u00e0 m\u1ed9t service c\u00f3 t\u1ea7n su\u1ea5t truy c\u1eadp c\u1ef1c cao, \u0111\u1eb7c bi\u1ec7t t\u1ea1i c\u00e1c lu\u1ed3ng login, refresh token v\u00e0 introspect. Thi\u1ebft k\u1ebf c\u1ea7n t\u1ed1i \u01b0u c\u1ea3 v\u1ec1 latency l\u1eabn kh\u1ea3 n\u0103ng scale ngang.</p>"},{"location":"services/token-service/design/#111-hieu-nang-tung-loai-endpoint","title":"11.1. Hi\u1ec7u n\u0103ng t\u1eebng lo\u1ea1i endpoint","text":"Endpoint T\u1ea7n su\u1ea5t M\u1ee5c ti\u00eau latency (p95) T\u1ed1i \u01b0u h\u00f3a ch\u00ednh <code>POST /token</code> Cao &lt; 100ms Truy v\u1ea5n DB nhanh, sinh JWT chu\u1ea9n <code>POST /refresh</code> R\u1ea5t cao &lt; 80ms Cache session + Redis pipelining <code>POST /introspect</code> R\u1ea5t cao &lt; 50ms Cache JWT payload, short-circuit <code>GET /.well-known/jwks.json</code> Trung b\u00ecnh &lt; 20ms Static cache CDN ho\u1eb7c Redis local <code>POST /revoke</code> Trung b\u00ecnh &lt; 120ms Ghi Pub/Sub v\u00e0 Redis TTL hi\u1ec7u qu\u1ea3"},{"location":"services/token-service/design/#112-ky-thuat-toi-uu","title":"11.2. K\u1ef9 thu\u1eadt t\u1ed1i \u01b0u","text":"<ul> <li>Caching t\u00edch c\u1ef1c:</li> <li>JWKS: cache t\u1ea1i CDN + Redis local theo <code>kid</code></li> <li>Introspection: cache JWT decoded payload TTL ng\u1eafn</li> <li>Batching &amp; pipelining Redis \u0111\u1ec3 x\u1eed l\u00fd h\u00e0ng lo\u1ea1t revoke token</li> <li>G\u00f3i <code>jti</code> v\u00e0 <code>user_id</code> trong claim \u0111\u1ec3 introspect nhanh h\u01a1n</li> <li>Slim JWT: ch\u1ec9 gi\u1eef d\u1eef li\u1ec7u c\u1ea7n thi\u1ebft (sub, exp, jti, scope)</li> </ul>"},{"location":"services/token-service/design/#113-horizontal-scaling","title":"11.3. Horizontal Scaling","text":"<ul> <li>Tri\u1ec3n khai t\u1ed1i thi\u1ec3u 3 replicas</li> <li>Scale out theo CPU + latency (<code>token_request_duration_seconds</code>)</li> <li>Redis cluster \u0111\u01b0\u1ee3c scale ri\u00eang (d\u1ea1ng managed ho\u1eb7c Kubernetes operator)</li> </ul>"},{"location":"services/token-service/design/#114-connection-pooling","title":"11.4. Connection pooling","text":"<ul> <li>DB (PostgreSQL): d\u00f9ng <code>asyncpg</code> pool v\u1edbi 50 connections</li> <li>Redis: d\u00f9ng pool v\u1edbi size \u0111\u1ed9ng theo l\u01b0\u1ee3ng request</li> <li>HTTP clients: re-use session, keep-alive enabled</li> </ul>"},{"location":"services/token-service/design/#115-thu-tai-load-testing","title":"11.5. Th\u1eed t\u1ea3i (Load Testing)","text":"<ul> <li>\u0110\u00e3 benchmark v\u1edbi <code>Locust</code> v\u00e0 <code>k6</code>:</li> <li>1000 TPS / 3 replica =&gt; p95 latency ~65ms (token), ~40ms (introspect)</li> <li>T\u1ed1c \u0111\u1ed9 revocation (Redis write): 3000/s</li> <li>T\u1ef1 \u0111\u1ed9ng ch\u1ea1y l\u1ea1i load test m\u1ed7i l\u1ea7n deploy staging (CI job <code>performance-benchmark</code>)</li> </ul>"},{"location":"services/token-service/design/#116-cdn-edge-cache","title":"11.6. CDN &amp; Edge Cache","text":"<ul> <li>JWKS endpoint (<code>/.well-known/jwks.json</code>) \u0111\u01b0\u1ee3c:</li> <li>Cache t\u1ea1i CDN (Cloudflare, GCP CDN)</li> <li>Cache t\u1ea1i Redis trong 5 ph\u00fat TTL</li> <li>Tr\u1ea3 k\u00e8m <code>Cache-Control: public, max-age=300</code> header</li> </ul>"},{"location":"services/token-service/design/#117-graceful-degradation","title":"11.7. Graceful degradation","text":"<ul> <li>fallback ki\u1ec3m tra JWKS + in-memory LRU</li> <li>N\u1ebfu Pub/Sub full \u2192 ghi audit log v\u00e0o file + retry job</li> <li>N\u1ebfu key rotation th\u1ea5t b\u1ea1i \u2192 gi\u1eef l\u1ea1i <code>last-valid-kid</code> trong 15 ph\u00fat</li> </ul> <p>\ud83d\udccc T\u00f3m t\u1eaft: Token Service \u0111\u1ea1t hi\u1ec7u n\u0103ng cao th\u00f4ng qua: - cache hi\u1ec7u qu\u1ea3 (JWKS, introspect, session) - design \u0111\u01a1n gi\u1ea3n, stateless - scale ngang t\u1ed1t nh\u1edd Redis v\u00e0 PostgreSQL t\u00e1ch bi\u1ec7t - b\u1ea3o v\u1ec7 h\u1ec7 th\u1ed1ng v\u1edbi fallback &amp; circuit breaker</p>"},{"location":"services/token-service/design/#12-ke-hoach-trien-khai","title":"12. \ud83d\udee0 K\u1ebf ho\u1ea1ch Tri\u1ec3n khai","text":"<p>Token Service l\u00e0 m\u1ed9t th\u00e0nh ph\u1ea7n b\u1ea3o m\u1eadt tr\u1ecdng y\u1ebfu, n\u00ean qu\u00e1 tr\u00ecnh tri\u1ec3n khai c\u1ea7n \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n t\u1eebng b\u01b0\u1edbc, c\u00f3 gi\u00e1m s\u00e1t v\u00e0 kh\u1ea3 n\u0103ng rollback nhanh n\u1ebfu x\u1ea3y ra s\u1ef1 c\u1ed1.</p>"},{"location":"services/token-service/design/#121-phan-ky-trien-khai","title":"12.1. Ph\u00e2n k\u1ef3 tri\u1ec3n khai","text":"Giai \u0111o\u1ea1n M\u1ee5c ti\u00eau ch\u00ednh \u23f3 Giai \u0111o\u1ea1n 1 Tri\u1ec3n khai t\u1ea1i m\u00f4i tr\u01b0\u1eddng Staging, test contract + load \ud83d\ude80 Giai \u0111o\u1ea1n 2 Tri\u1ec3n khai Production d\u01b0\u1edbi c\u1edd feature (<code>enable_token_service</code>) \ud83d\udd01 Giai \u0111o\u1ea1n 3 B\u1eadt to\u00e0n b\u1ed9 t\u00ednh n\u0103ng, monitor s\u00e1t, rollback n\u1ebfu c\u1ea7n"},{"location":"services/token-service/design/#122-cong-cu-trien-khai","title":"12.2. C\u00f4ng c\u1ee5 tri\u1ec3n khai","text":"<ul> <li>CI/CD: GitHub Actions + ArgoCD ho\u1eb7c Cloud Build</li> <li>Infrastructure: GCP (Cloud Run ho\u1eb7c GKE), Terraform</li> <li>Monitoring &amp; Alerting: Cloud Monitoring + Prometheus + Grafana + Alertmanager</li> </ul>"},{"location":"services/token-service/design/#123-zero-downtime","title":"12.3. Zero Downtime","text":"<p>\u2705 Theo <code>adr-014-zero-downtime.md</code>, c\u00e1c b\u01b0\u1edbc sau \u0111\u01b0\u1ee3c \u00e1p d\u1ee5ng:</p> <ul> <li>D\u00f9ng <code>readinessProbe</code> \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o pod ch\u1ec9 nh\u1eadn traffic sau khi warm-up.</li> <li>H\u1ed7 tr\u1ee3 hot-reload public key JWKS \u0111\u1ec3 kh\u00f4ng l\u00e0m gi\u00e1n \u0111o\u1ea1n c\u00e1c service kh\u00e1c.</li> <li>Blue-Green deployment (n\u1ebfu Cloud Run) ho\u1eb7c rolling update (n\u1ebfu GKE).</li> </ul>"},{"location":"services/token-service/design/#124-seed-du-lieu-ban-au","title":"12.4. Seed d\u1eef li\u1ec7u ban \u0111\u1ea7u","text":"<ul> <li>Sinh JWKS ban \u0111\u1ea7u v\u1edbi key <code>kid=initial-1</code>, l\u01b0u v\u00e0o secret v\u00e0 JWKS DB table.</li> <li>T\u1ea1o service account \u0111\u1ea7u ti\u00ean (internal) c\u00f3 quy\u1ec1n introspect.</li> <li>T\u1ea1o policy ph\u00e1t token cho <code>auth-service/sub</code>.</li> </ul>"},{"location":"services/token-service/design/#125-migration-data-schema-safe-migration-adr-023","title":"12.5. Migration &amp; Data Schema (Safe-Migration \u2013 ADR-023)","text":"<p>\u0110\u1ed1i v\u1edbi m\u1ecdi thay \u0111\u1ed5i schema ho\u1eb7c lifecycle d\u1eef li\u1ec7u c\u1ee7a Token Service, \u00e1p d\u1ee5ng quy tr\u00ecnh 3 pha sau \u0111\u1ec3 b\u1ea3o \u0111\u1ea3m kh\u00f4ng downtime v\u00e0 an to\u00e0n rollback.</p>"},{"location":"services/token-service/design/#1-prepare-shadow-write","title":"\ud83d\udd39 1. Prepare (Shadow Write)","text":"B\u01b0\u1edbc Thao t\u00e1c Ghi ch\u00fa 1.1 T\u1ea1o table/bucket song song \u2013 vd. <code>revoked_tokens_v2</code> Flyway script <code>V20250615__create_revoked_tokens_v2.sql</code> 1.2 Dual-write: m\u00e3 ngu\u1ed3n TokenSvc ghi c\u1ea3 b\u1ea3ng c\u0169 &amp; v2 (<code>FeatureFlag: dual_write=true</code>) Version <code>v1.2.0</code> 1.3 C\u1eadp nh\u1eadt schema_version (<code>migration_stage=prepare</code>) \u2013 publish event <code>schema.prepare.v1</code> payload <code>{resource: \"revoked_tokens\", stage:\"prepare\"}</code> 1.4 Ch\u1ea1y backfill n\u1ebfu c\u1ea7n (COPY ... FROM ...) Job <code>backfill_revoked_v2</code>"},{"location":"services/token-service/design/#2-transition-read-switch","title":"\ud83d\udd39 2. Transition (Read Switch)","text":"B\u01b0\u1edbc Thao t\u00e1c Ghi ch\u00fa 2.1 Redeploy TokenSvc <code>v1.3.0</code> \u2013 Option flag <code>read_v2=true</code>, v\u1eabn dual-write Canary 10 % \u279c 100 % trong 30\u2032 2.2 Theo d\u00f5i metric <code>revoked_sync_lag_ms</code> &amp; compare count(c1) vs c2 SLO lag &lt; 500 ms 2.3 Khi \u1ed5n \u0111\u1ecbnh (&gt; 24 h), t\u1eaft dual-write (<code>dual_write=false</code>) Promote stage <code>transition</code> 2.4 Publish event <code>schema.transitioned.v1</code> \u2014"},{"location":"services/token-service/design/#3-cleanup-decommission","title":"\ud83d\udd39 3. Cleanup (Decommission)","text":"B\u01b0\u1edbc Thao t\u00e1c Ghi ch\u00fa 3.1 Ch\u1ea1y cron <code>verify_no_read_old</code> (24 h) \u2013 n\u1ebfu 0 query v\u00e0o b\u1ea3ng c\u0169 3.2 DROP b\u1ea3ng c\u0169 <code>revoked_tokens</code> (Flyway <code>V20250617__drop_revoked_tokens.sql</code>) 3.3 Prepare undo script: Flyway <code>U20250617__recreate_revoked_tokens.sql</code> \u0111\u1ec3 kh\u00f4i ph\u1ee5c b\u1ea3ng c\u0169 n\u1ebfu rollback 3.4 C\u1eadp nh\u1eadt alias - secret (n\u1ebfu migration li\u00ean quan key) 3.5 Publish <code>schema.cleanup.v1</code> &amp; ghi <code>audit_log.schema_migration</code> field <code>who/when/stage=\"cleanup\"</code> 3.6 Bump <code>schema_version</code> global (<code>revoked_tokens</code> \u21d2 2) README + OpenAPI"},{"location":"services/token-service/design/#rollback-plan","title":"\ud83d\udd39 Rollback Plan","text":"<ul> <li>N\u1ebfu trong Transition metric l\u1ed7i &gt; threshold \u2192 g\u1eafn flag <code>read_v2=false</code>, rollback canary.  </li> <li>Ph\u1ea7n Prepare lu\u00f4n an to\u00e0n: b\u1ea3ng c\u0169 ch\u01b0a xo\u00e1.  </li> <li>Sau Cleanup kh\u00f4ng rollback; c\u1ea7n migration m\u1edbi <code>v3</code>.</li> </ul> <p>Nh\u1eafc l\u1ea1i: Lu\u00f4n commit Flyway script + n\u00e2ng <code>schema_version</code> trong c\u00f9ng PR v\u1edbi code dual-write \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o kh\u1ea3 n\u0103ng kh\u00f4i ph\u1ee5c.</p>"},{"location":"services/token-service/design/#126-quan-ly-cau-hinh-moi-truong","title":"12.6. Qu\u1ea3n l\u00fd c\u1ea5u h\u00ecnh &amp; m\u00f4i tr\u01b0\u1eddng","text":"<ul> <li>T\u1ea5t c\u1ea3 secrets l\u01b0u t\u1ea1i GCP Secret Manager:</li> <li><code>TOKEN_PRIVATE_KEY</code></li> <li><code>REDIS_URI</code>, <code>DB_URI</code></li> <li>Bi\u1ebfn m\u00f4i tr\u01b0\u1eddng:</li> <li><code>ENABLE_TOKEN_SERVICE=true</code></li> <li><code>JWT_TTL=3600</code>, <code>REFRESH_TTL=604800</code></li> <li><code>.env</code> chu\u1ea9n h\u00f3a theo <code>adr-005-env-config.md</code></li> </ul>"},{"location":"services/token-service/design/#127-rollback-nhanh","title":"12.7. Rollback nhanh","text":"<ul> <li>Duy tr\u00ec <code>feature flag</code> \u0111\u1ec3 rollback soft (kh\u00f4ng c\u1ea7n redeploy)</li> <li>N\u1ebfu rollback to\u00e0n b\u1ed9:</li> <li>Cloud Run \u2192 <code>revert revision</code></li> <li>GKE \u2192 <code>kubectl rollout undo deployment token-service</code></li> </ul>"},{"location":"services/token-service/design/#128-quan-ly-phat-hanh","title":"12.8. Qu\u1ea3n l\u00fd ph\u00e1t h\u00e0nh","text":"<p>\u2705 Tu\u00e2n th\u1ee7 <code>adr-018-release-approval-policy.md</code>:</p> <ul> <li>PR \u0111\u01b0\u1ee3c merge v\u00e0o <code>main</code> c\u1ea7n 2 approvers.</li> <li>Checklist CI: \u2705 Test | \u2705 Contract Valid | \u2705 Load Test | \u2705 Security Scan</li> <li>Production release c\u1ea7n manual approval t\u1eeb ki\u1ebfn tr\u00fac s\u01b0 b\u1ea3o m\u1eadt.</li> </ul>"},{"location":"services/token-service/design/#129-sau-trien-khai","title":"12.9. Sau tri\u1ec3n khai","text":"<ul> <li>Theo d\u00f5i:</li> <li>JWKS fetch rate</li> <li>Latency <code>/token</code>, <code>/refresh</code></li> <li>S\u1ed1 l\u01b0\u1ee3ng revoke fail</li> <li>\u0110\u1ecbnh k\u1ef3 ki\u1ec3m tra audit log &amp; key expiry</li> <li>\u00c1p d\u1ee5ng <code>chaos testing</code> theo qu\u00fd \u0111\u1ec3 ki\u1ec3m tra resilience.</li> </ul> <p>\ud83d\udccc T\u00f3m t\u1eaft: Tri\u1ec3n khai Token Service y\u00eau c\u1ea7u quy tr\u00ecnh ki\u1ec3m so\u00e1t ch\u1eb7t ch\u1ebd v\u1ec1 key management, rollback, seed d\u1eef li\u1ec7u v\u00e0 gi\u00e1m s\u00e1t ch\u00e9o to\u00e0n h\u1ec7 th\u1ed1ng. Ph\u00e2n k\u1ef3 r\u00f5 r\u00e0ng gi\u00fap h\u1ea1n ch\u1ebf r\u1ee7i ro v\u00e0 t\u0103ng \u0111\u1ed9 tin c\u1eady trong Production.</p>"},{"location":"services/token-service/design/#13-kien-truc-service","title":"13. \ud83e\udde9 Ki\u1ebfn tr\u00fac Service","text":"<p>Token Service \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf d\u01b0\u1edbi d\u1ea1ng stateless microservice, \u0111\u00f3ng vai tr\u00f2 trung t\u00e2m trong vi\u1ec7c ph\u00e1t h\u00e0nh, x\u00e1c th\u1ef1c v\u00e0 thu h\u1ed3i token tr\u00ean to\u00e0n h\u1ec7 th\u1ed1ng. Ki\u1ebfn tr\u00fac \u0111\u01b0\u1ee3c t\u1ed1i \u01b0u ho\u00e1 cho hi\u1ec7u n\u0103ng, b\u1ea3o m\u1eadt v\u00e0 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng.</p>"},{"location":"services/token-service/design/#131-thanh-phan-chinh-modules","title":"13.1. Th\u00e0nh ph\u1ea7n ch\u00ednh (Modules)","text":"Module M\u00f4 t\u1ea3 ch\u1ee9c n\u0103ng ch\u00ednh <code>TokenIssuer</code> Sinh access token v\u00e0 refresh token theo c\u1ea5u h\u00ecnh <code>JWKSManager</code> Qu\u1ea3n l\u00fd keypair, ph\u1ee5c v\u1ee5 JWKS endpoint (<code>/.well-known/jwks.json</code>) <code>TokenIntrospector</code> Ki\u1ec3m tra t\u00ednh h\u1ee3p l\u1ec7 c\u1ee7a token (bao g\u1ed3m revoked) <code>TokenRevoker</code> Thu h\u1ed3i token b\u1eb1ng c\u00e1ch ghi <code>jti</code> ho\u1eb7c <code>sub</code> v\u00e0o Redis <code>KeyRotationJob</code> T\u1ef1 \u0111\u1ed9ng xoay v\u00f2ng kh\u00f3a \u0111\u1ecbnh k\u1ef3 (configurable) <code>AuditPublisher</code> G\u1eedi b\u1ea3n ghi audit (login, logout, revoke) l\u00ean Pub/Sub <code>SessionTracker</code> Ghi l\u1ea1i c\u00e1c phi\u00ean \u0111\u0103ng nh\u1eadp n\u1ebfu c\u1ea5u h\u00ecnh <code>track_sessions=true</code>"},{"location":"services/token-service/design/#132-luong-tuong-tac-chinh","title":"13.2. Lu\u1ed3ng t\u01b0\u01a1ng t\u00e1c ch\u00ednh","text":"<pre><code>sequenceDiagram\n    actor FE as Frontend\n    participant AuthSub as Auth Service Sub\n    participant Token as Token Service\n    participant Redis as Redis\n    participant PubSub as Pub/Sub\n\n    FE-&gt;&gt;AuthSub: \u0110\u0103ng nh\u1eadp (/auth/login)\n    AuthSub-&gt;&gt;Token: POST /token (sub, scope)\n    Token-&gt;&gt;Token: Sinh access_token + refresh_token\n    Token-&gt;&gt;Redis: L\u01b0u session (optional)\n    Token-&gt;&gt;PubSub: G\u1eedi event audit.login\n    Token--&gt;&gt;AuthSub: Tr\u1ea3 token\n</code></pre>"},{"location":"services/token-service/design/#133-trien-khai-ha-tang","title":"13.3. Tri\u1ec3n khai &amp; H\u1ea1 t\u1ea7ng","text":"<ul> <li>Containerized tr\u00ean GKE ho\u1eb7c Cloud Run</li> <li>D\u00f9ng Redis l\u00e0m b\u1ed9 nh\u1edb trung gian \u0111\u1ec3 revoke token</li> <li>D\u1eef li\u1ec7u JWKS v\u00e0 revoked token \u0111\u01b0\u1ee3c persist trong PostgreSQL</li> <li>Expose qua API Gateway v\u1edbi <code>x-required-permission</code> \u0111\u1ec3 audit introspect</li> </ul>"},{"location":"services/token-service/design/#134-quan-he-voi-cac-service-khac","title":"13.4. Quan h\u1ec7 v\u1edbi c\u00e1c service kh\u00e1c","text":"Service T\u01b0\u01a1ng t\u00e1c ch\u00ednh <code>auth-service/sub</code> G\u1ecdi <code>/token</code>, <code>/refresh</code>, <code>/revoke</code> <code>api-gateway</code> G\u1ecdi <code>/introspect</code> (\u1edf ch\u1ebf \u0111\u1ed9 b\u1ea3o v\u1ec7) <code>user-service</code> \u0110\u01b0\u1ee3c tham chi\u1ebfu <code>sub</code> t\u1eeb JWT claim <code>audit-logging</code> Ghi audit login/logout n\u1ebfu audit.enable=true"},{"location":"services/token-service/design/#135-phan-tach-nhiem-vu-responsibility-split","title":"13.5. Ph\u00e2n t\u00e1ch nhi\u1ec7m v\u1ee5 (Responsibility Split)","text":"Tr\u00e1ch nhi\u1ec7m Service \u0111\u1ea3m nhi\u1ec7m Ph\u00e1t h\u00e0nh token <code>token-service</code> Qu\u1ea3n l\u00fd ng\u01b0\u1eddi d\u00f9ng, ph\u00e2n quy\u1ec1n <code>auth-service/sub</code> L\u01b0u tr\u1eef token session Redis (t\u1ea1m th\u1eddi) Ki\u1ec3m tra token trong m\u1ed7i request <code>api-gateway</code> L\u01b0u log ho\u1ea1t \u0111\u1ed9ng <code>audit-logging-service</code>"},{"location":"services/token-service/design/#136-high-level-diagram","title":"13.6. High-level Diagram","text":"<pre><code>flowchart TD\n    A[auth-service/sub] --&gt;|/token| T(Token Service)\n    T --&gt; R[Redis (jti, session)]\n    T --&gt; K[PostgreSQL - jwks_keys]\n    T --&gt; P[Pub/Sub - audit.*]\n    G[API Gateway] --&gt;|/introspect| T\n</code></pre> <p>\ud83d\udccc T\u00f3m t\u1eaft: Token Service ho\u1ea1t \u0111\u1ed9ng nh\u01b0 m\u1ed9t service \u0111\u1ed9c l\u1eadp, x\u1eed l\u00fd to\u00e0n b\u1ed9 v\u00f2ng \u0111\u1eddi c\u1ee7a JWT v\u00e0 refresh token, \u0111\u1ea3m b\u1ea3o stateless, ch\u1ecbu t\u1ea3i l\u1edbn, an to\u00e0n v\u00e0 c\u00f3 th\u1ec3 t\u00edch h\u1ee3p s\u00e2u v\u1edbi h\u1ec7 th\u1ed1ng gi\u00e1m s\u00e1t, audit v\u00e0 key rotation t\u1ef1 \u0111\u1ed9ng.</p>"},{"location":"services/token-service/design/#14-tai-lieu-lien-quan","title":"14. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan","text":""},{"location":"services/token-service/design/#cac-quyet-inh-kien-truc-adr","title":"\ud83d\udd16 C\u00e1c Quy\u1ebft \u0111\u1ecbnh Ki\u1ebfn tr\u00fac (ADR)","text":"<ul> <li>ADR-003 Secrets Management: Quy tr\u00ecnh l\u01b0u tr\u1eef &amp; xoay kh\u00f3a b\u00ed m\u1eadt an to\u00e0n.  </li> <li>ADR-004 Security Policy: Ch\u00ednh s\u00e1ch b\u1ea3o m\u1eadt t\u1ed5ng th\u1ec3.  </li> <li>ADR-005 Environment Configuration Strategy: Chu\u1ea9n t\u00e1ch c\u1ea5u h\u00ecnh \u2013 <code>SERVICE__SECTION__KEY</code>.  </li> <li>ADR-006 Auth Strategy: Chi\u1ebfn l\u01b0\u1ee3c x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng v\u00e0 c\u1ea5p ph\u00e1t token.  </li> <li>ADR-009 API Governance: Quy t\u1eafc versioning, naming v\u00e0 style REST.  </li> <li>ADR-011 API Error Format: Quy \u01b0\u1edbc m\u00e3 l\u1ed7i &amp; th\u00f4ng \u0111i\u1ec7p l\u1ed7i (<code>namespace.snake_case</code>).  </li> <li>ADR-012 Response Structure: Chu\u1ea9n h\u00f3a c\u1ea5u tr\u00fac JSON response cho API.</li> <li>ADR-018 Release Approval Policy: Quy tr\u00ecnh ph\u00ea duy\u1ec7t ph\u00e1t h\u00e0nh.</li> <li>ADR-022 SLA &amp; SLO Monitoring: Khung gi\u00e1m s\u00e1t &amp; \u0111\u1ecbnh ngh\u0129a SLO.</li> <li>ADR-023 Schema Migration Strategy: 3-phase migration (Prepare \u2192 Transition \u2192 Cleanup).  </li> <li>ADR-024 Data Anonymization &amp; Retention: \u1ea8n danh PII v\u00e0 TTL d\u1eef li\u1ec7u.  </li> <li>ADR-026 Hard-Delete Policy: Quy tr\u00ecnh xo\u00e1 v\u0129nh vi\u1ec5n &amp; purge log.  </li> <li>ADR-030 Event Schema Governance: \u0110\u1eb7t t\u00ean &amp; version s\u1ef1 ki\u1ec7n <code>*.v{n}</code>.</li> </ul>"},{"location":"services/token-service/design/#dich-vu-lien-quan","title":"\ud83e\udde9 D\u1ecbch v\u1ee5 li\u00ean quan","text":"<ul> <li>auth-service/sub: Service g\u1ecdi t\u1edbi <code>/token</code>, <code>/refresh</code>.</li> <li>api-gateway: Service s\u1eed d\u1ee5ng <code>/introspect</code> \u0111\u1ec3 x\u00e1c th\u1ef1c JWT.</li> <li>audit-logging-service: Ghi l\u1ea1i c\u00e1c s\u1ef1 ki\u1ec7n login, logout t\u1eeb Token Service.</li> <li>user-service/master: N\u01a1i ch\u1ee9a th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng \u0111\u01b0\u1ee3c li\u00ean k\u1ebft b\u1edfi <code>sub</code> trong token.</li> </ul>"},{"location":"services/token-service/design/#file-trong-token-service","title":"\ud83d\udcc2 File trong Token Service","text":"<ul> <li>Interface Contract</li> <li>Data Model</li> <li>OpenAPI Spec</li> </ul>"},{"location":"services/token-service/interface-contract/","title":"\ud83d\udcc4 Token Service \u2013 Interface Contract","text":"<p>Token Service cung c\u1ea5p c\u00e1c API trung t\u00e2m \u0111\u1ec3 ph\u00e1t h\u00e0nh, l\u00e0m m\u1edbi, thu h\u1ed3i v\u00e0 x\u00e1c minh token (access/refresh/JWT) theo chu\u1ea9n c\u1ee7a h\u1ec7 th\u1ed1ng DX-VAS.</p>"},{"location":"services/token-service/interface-contract/#tong-quan-api","title":"\ud83d\udccc T\u1ed5ng quan API","text":"Method Endpoint M\u00f4 t\u1ea3 B\u1ea3o m\u1eadt Ghi ch\u00fa POST <code>/v1/token</code> C\u1ea5p token m\u1edbi d\u1ef1a tr\u00ean th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng \ud83d\udd12 Auth \u0110\u01b0\u1ee3c g\u1ecdi b\u1edfi <code>auth-service/sub</code> POST <code>/v1/token/refresh</code> L\u00e0m m\u1edbi token b\u1eb1ng refresh token \ud83d\udd12 G\u1ecdi tr\u1ef1c ti\u1ebfp t\u1eeb client POST <code>/v1/token/revoke</code> Thu h\u1ed3i 1 token c\u1ee5 th\u1ec3 ho\u1eb7c theo <code>sub</code> \ud83d\udd12 S\u1eed d\u1ee5ng Redis \u0111\u1ec3 blacklist <code>jti</code> POST <code>/v1/token/introspect</code> Ki\u1ec3m tra t\u00ednh h\u1ee3p l\u1ec7 c\u1ee7a token \ud83d\udd12 Internal S\u1eed d\u1ee5ng b\u1edfi <code>api-gateway</code> GET <code>/.well-known/jwks.json</code> Tr\u1ea3 v\u1ec1 public keys \u0111\u1ec3 x\u00e1c th\u1ef1c ch\u1eef k\u00fd JWT \ud83d\udd13 Public D\u00f9ng cho c\u00e1c service verify token <p>Quy \u01b0\u1edbc path versioning M\u1ecdi endpoint c\u1ee7a Token Service tu\u00e2n \u0111\u1ecbnh d\u1ea1ng <code>/v{major}/\u2026</code> \u2013 v\u00ed d\u1ee5 <code>/v1/token</code>, <code>/v1/token/refresh</code>. Quy t\u1eafc n\u00e0y l\u1ea5y t\u1eeb ADR-009 (API Governance) v\u00e0 ADR-013 (Path Naming Convention) \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o kh\u1ea3 n\u0103ng thay \u0111\u1ed5i phi\u00ean b\u1ea3n m\u00e0 kh\u00f4ng ph\u00e1 v\u1ee1 client.</p>"},{"location":"services/token-service/interface-contract/#1-post-v1tokenissue","title":"\u2705 1. POST <code>/v1/token/issue</code>","text":""},{"location":"services/token-service/interface-contract/#muc-ich","title":"\ud83c\udfaf M\u1ee5c \u0111\u00edch","text":"<p>Ph\u00e1t h\u00e0nh c\u1eb7p token (access_token, refresh_token) m\u1edbi cho user \u0111\u00e3 \u0111\u01b0\u1ee3c x\u00e1c th\u1ef1c tr\u01b0\u1edbc \u0111\u00f3. API n\u00e0y \u0111\u01b0\u1ee3c g\u1ecdi n\u1ed9i b\u1ed9 b\u1edfi auth-service (Master ho\u1eb7c Sub) sau khi x\u00e1c th\u1ef1c danh t\u00ednh ng\u01b0\u1eddi d\u00f9ng th\u00e0nh c\u00f4ng.</p>"},{"location":"services/token-service/interface-contract/#headers-yeu-cau","title":"\ud83d\udd10 Headers y\u00eau c\u1ea7u","text":"T\u00ean Header B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>X-Request-ID</code> \u2705 ID truy v\u1ebft request, s\u1ebd \u0111\u01b0\u1ee3c tr\u1ea3 v\u1ec1 trong <code>meta.trace_id</code>. <code>X-Tenant-ID</code> \u2705 \u0110\u1ecbnh danh tenant \u0111ang th\u1ef1c hi\u1ec7n y\u00eau c\u1ea7u. <code>Content-Type</code> \u2705 <code>application/json</code> <code>Authorization</code> \u2705 Token x\u00e1c th\u1ef1c c\u1ee7a service g\u1ecdi \u0111\u1ebfn (v\u00ed d\u1ee5: service account token c\u1ee7a Auth Service), ch\u1ee9ng minh quy\u1ec1n \u0111\u01b0\u1ee3c g\u1ecdi <code>token.issue</code>."},{"location":"services/token-service/interface-contract/#request-body","title":"\ud83d\udce5 Request Body","text":"<pre><code>{\n  \"sub\": \"user-123\",\n  \"roles\": [\"teacher\"],\n  \"permissions\": [\"report.view_login_by_tenant\"],\n  \"session_id\": \"sess-abc-123\",\n  \"login_method\": \"otp\",\n  \"session_metadata\": {\n    \"ip\": \"113.23.45.12\",\n    \"device_type\": \"android\",\n    \"user_agent\": \"Mozilla/5.0\"\n  }\n}\n</code></pre> Tr\u01b0\u1eddng B\u1eaft bu\u1ed9c Ki\u1ec3u DL M\u00f4 t\u1ea3 <code>sub</code> \u2705 string Global User ID c\u1ee7a ng\u01b0\u1eddi d\u00f9ng c\u1ea7n c\u1ea5p token. <code>roles</code> \u2705 array Danh s\u00e1ch c\u00e1c <code>role_code</code> c\u1ee7a ng\u01b0\u1eddi d\u00f9ng trong tenant hi\u1ec7n t\u1ea1i. <code>permissions</code> \u2705 array Danh s\u00e1ch c\u00e1c <code>permission_code</code> ng\u01b0\u1eddi d\u00f9ng c\u00f3. <code>session_id</code> \u2705 string ID c\u1ee7a phi\u00ean \u0111\u0103ng nh\u1eadp, l\u1ea5y t\u1eeb b\u1ea3ng <code>auth_sessions</code>. <code>login_method</code> \u2705 string <code>google</code> / <code>otp</code> / <code>local</code> <code>session_metadata</code> \u274c object IP, thi\u1ebft b\u1ecb, tr\u00ecnh duy\u1ec7t (ghi log)"},{"location":"services/token-service/interface-contract/#response","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"data\": {\n    \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\",\n    \"refresh_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\",\n    \"token_type\": \"Bearer\",\n    \"expires_in\": 3600\n  },\n  \"meta\": {\n    \"trace_id\": \"req-uuid\",\n    \"timestamp\": \"2025-06-07T14:35:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/token-service/interface-contract/#response-headers","title":"\ud83d\udce4 Response Headers","text":"Header M\u00f4 t\u1ea3 <code>X-Request-ID</code> Echo l\u1ea1i ID request <code>X-Tenant-ID</code> Echo l\u1ea1i tenant"},{"location":"services/token-service/interface-contract/#response-example-200","title":"\ud83e\uddea Response Example (200)","text":"<pre><code>HTTP/1.1 200 OK\nX-Request-ID: abc123\nX-Tenant-ID: vas-001\nContent-Type: application/json\n\n{\n  \"data\": {\n    \"access_token\": \"eyJhbGciOi...\",\n    \"refresh_token\": \"eyJhbGciOi...\",\n    \"token_type\": \"Bearer\",\n    \"expires_in\": 3600\n  },\n  \"meta\": {\n    \"trace_id\": \"abc123\",\n    \"timestamp\": \"2025-06-07T14:35:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/token-service/interface-contract/#error-responses","title":"\u274c Error Responses","text":"HTTP code message 400 <code>common.validation_error</code> Token y\u00eau c\u1ea7u kh\u00f4ng h\u1ee3p l\u1ec7 401 <code>auth.unauthorized</code> Kh\u00f4ng c\u00f3 quy\u1ec1n ph\u00e1t h\u00e0nh token 403 <code>auth.tenant.mismatch</code> Tenant kh\u00f4ng kh\u1edbp v\u1edbi user 422 <code>common.validation_error</code> JSON h\u1ee3p l\u1ec7 nh\u01b0ng kh\u00f4ng tho\u1ea3 \u0111i\u1ec1u ki\u1ec7n nghi\u1ec7p v\u1ee5 429 <code>common.rate_limited</code> V\u01b0\u1ee3t ng\u01b0\u1ee1ng RPS/burst (theo ADR-022) 500 <code>common.internal_error</code> L\u1ed7i h\u1ec7 th\u1ed1ng n\u1ed9i b\u1ed9 <p>\u2757 Note: T\u1ea5t c\u1ea3 l\u1ed7i \u0111\u1ec1u tr\u1ea3 v\u1ec1 d\u01b0\u1edbi d\u1ea1ng <code>ErrorEnvelope</code> theo ADR-011</p>"},{"location":"services/token-service/interface-contract/#2-post-v1tokenrefresh","title":"\u2705 2. POST <code>/v1/token/refresh</code>","text":""},{"location":"services/token-service/interface-contract/#muc-ich_1","title":"\ud83c\udfaf M\u1ee5c \u0111\u00edch","text":"<p>Ph\u00e1t h\u00e0nh c\u1eb7p token m\u1edbi d\u1ef1a tr\u00ean <code>refresh_token</code> h\u1ee3p l\u1ec7. API n\u00e0y cho ph\u00e9p client duy tr\u00ec \u0111\u0103ng nh\u1eadp m\u00e0 kh\u00f4ng c\u1ea7n nh\u1eadp l\u1ea1i m\u1eadt kh\u1ea9u. \u0110\u01b0\u1ee3c g\u1ecdi tr\u1ef1c ti\u1ebfp t\u1eeb client (mobile/web app) ho\u1eb7c t\u1eeb <code>auth-service/sub</code>.</p>"},{"location":"services/token-service/interface-contract/#headers-yeu-cau_1","title":"\ud83d\udd10 Headers y\u00eau c\u1ea7u","text":"T\u00ean Header B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>X-Request-ID</code> \u2705 ID truy v\u1ebft request <code>X-Tenant-ID</code> \u2705 Tenant hi\u1ec7n h\u00e0nh <code>Content-Type</code> \u2705 <code>application/json</code> <code>Authorization</code> \u2705 <code>Bearer &lt;refresh_token&gt;</code> \u2013 \u0111\u01b0\u1ee3c c\u1ea5p t\u1eeb l\u1ea7n \u0111\u0103ng nh\u1eadp tr\u01b0\u1edbc"},{"location":"services/token-service/interface-contract/#request-body_1","title":"\ud83d\udce5 Request Body","text":"<pre><code>{\n  \"session_id\": \"session-abc-uuid\"\n}\n</code></pre> Tr\u01b0\u1eddng B\u1eaft bu\u1ed9c Ki\u1ec3u DL M\u00f4 t\u1ea3 <code>session_id</code> \u2705 string ID phi\u00ean c\u1ea7n l\u00e0m m\u1edbi token"},{"location":"services/token-service/interface-contract/#response_1","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"data\": {\n    \"access_token\": \"eyJhbGciOi...\",\n    \"refresh_token\": \"eyJhbGciOi...\",\n    \"token_type\": \"Bearer\",\n    \"expires_in\": 3600\n  },\n  \"meta\": {\n    \"trace_id\": \"abc123\",\n    \"timestamp\": \"2025-06-07T15:00:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/token-service/interface-contract/#response-headers_1","title":"\ud83d\udce4 Response Headers","text":"Header M\u00f4 t\u1ea3 <code>X-Request-ID</code> Echo l\u1ea1i ID request <code>X-Tenant-ID</code> Echo l\u1ea1i tenant"},{"location":"services/token-service/interface-contract/#response-example-200_1","title":"\ud83e\uddea Response Example (200)","text":"<pre><code>HTTP/1.1 200 OK\nX-Request-ID: abc123\nX-Tenant-ID: vas-001\nContent-Type: application/json\n\n{\n  \"data\": {\n    \"access_token\": \"eyJhbGciOi...\",\n    \"refresh_token\": \"eyJhbGciOi...\",\n    \"token_type\": \"Bearer\",\n    \"expires_in\": 3600\n  },\n  \"meta\": {\n    \"trace_id\": \"abc123\",\n    \"timestamp\": \"2025-06-07T15:00:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/token-service/interface-contract/#error-responses_1","title":"\u274c Error Responses","text":"HTTP code message 400 <code>auth.refresh.invalid</code> Token refresh kh\u00f4ng h\u1ee3p l\u1ec7 ho\u1eb7c \u0111\u00e3 h\u1ebft h\u1ea1n 401 <code>auth.unauthorized</code> Kh\u00f4ng c\u00f3 quy\u1ec1n l\u00e0m m\u1edbi token 403 <code>auth.session.revoked</code> Phi\u00ean \u0111\u00e3 b\u1ecb thu h\u1ed3i ho\u1eb7c b\u1ecb ch\u1eb7n 404 <code>auth.session.not_found</code> Kh\u00f4ng t\u00ecm th\u1ea5y phi\u00ean t\u01b0\u01a1ng \u1ee9ng 422 <code>common.validation_error</code> JSON h\u1ee3p l\u1ec7 nh\u01b0ng kh\u00f4ng tho\u1ea3 \u0111i\u1ec1u ki\u1ec7n nghi\u1ec7p v\u1ee5 429 <code>common.rate_limited</code> V\u01b0\u1ee3t ng\u01b0\u1ee1ng RPS/burst (theo ADR-022) 500 <code>common.internal_error</code> L\u1ed7i h\u1ec7 th\u1ed1ng <p>\u2757 Ghi ch\u00fa: \u0110\u00e1p \u1ee9ng chu\u1ea9n ADR-011 - Error Format</p>"},{"location":"services/token-service/interface-contract/#3-post-v1tokenrevoke","title":"\u2705 3. POST <code>/v1/token/revoke</code>","text":""},{"location":"services/token-service/interface-contract/#muc-ich_2","title":"\ud83c\udfaf M\u1ee5c \u0111\u00edch","text":"<p>Thu h\u1ed3i m\u1ed9t phi\u00ean \u0111\u0103ng nh\u1eadp (session) c\u1ee5 th\u1ec3, ch\u1ea5m d\u1ee9t hi\u1ec7u l\u1ef1c c\u1ee7a c\u1ea3 access token v\u00e0 refresh token t\u01b0\u01a1ng \u1ee9ng. API n\u00e0y \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng khi ng\u01b0\u1eddi d\u00f9ng ch\u1ee7 \u0111\u1ed9ng \u0111\u0103ng xu\u1ea5t kh\u1ecfi m\u1ed9t thi\u1ebft b\u1ecb c\u1ee5 th\u1ec3 ho\u1eb7c to\u00e0n b\u1ed9 h\u1ec7 th\u1ed1ng.</p>"},{"location":"services/token-service/interface-contract/#headers-yeu-cau_2","title":"\ud83d\udd10 Headers y\u00eau c\u1ea7u","text":"T\u00ean Header B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>X-Request-ID</code> \u2705 ID truy v\u1ebft request <code>X-Tenant-ID</code> \u2705 Tenant hi\u1ec7n h\u00e0nh <code>Content-Type</code> \u2705 <code>application/json</code> <code>Authorization</code> \u2705 Access Token h\u1ee3p l\u1ec7 \u0111\u1ec3 x\u00e1c \u0111\u1ecbnh <code>sub</code> th\u1ef1c hi\u1ec7n y\u00eau c\u1ea7u"},{"location":"services/token-service/interface-contract/#request-body_2","title":"\ud83d\udce5 Request Body","text":"<pre><code>{\n  \"session_id\": \"session-abc-uuid\"\n}\n</code></pre> Tr\u01b0\u1eddng B\u1eaft bu\u1ed9c Ki\u1ec3u DL M\u00f4 t\u1ea3 <code>session_id</code> \u2705 string ID c\u1ee7a phi\u00ean c\u1ea7n thu h\u1ed3i"},{"location":"services/token-service/interface-contract/#response-204-no-content","title":"\ud83d\udce4 Response (204 No Content)","text":"<pre><code>HTTP/1.1 204 No Content\nX-Request-ID: abc123\nX-Tenant-ID: vas-001\n</code></pre> <p>\u2705 Kh\u00f4ng c\u00f3 response body n\u1ebfu th\u00e0nh c\u00f4ng. Ph\u1ea3n h\u1ed3i <code>204</code> th\u1ec3 hi\u1ec7n r\u1eb1ng session \u0111\u00e3 \u0111\u01b0\u1ee3c thu h\u1ed3i (ho\u1eb7c kh\u00f4ng t\u1ed3n t\u1ea1i nh\u01b0ng x\u1eed l\u00fd idempotent).</p>"},{"location":"services/token-service/interface-contract/#error-responses_2","title":"\u274c Error Responses","text":"HTTP code message 400 <code>auth.revoke.invalid</code> D\u1eef li\u1ec7u y\u00eau c\u1ea7u kh\u00f4ng h\u1ee3p l\u1ec7 401 <code>auth.unauthorized</code> Kh\u00f4ng c\u00f3 quy\u1ec1n thu h\u1ed3i phi\u00ean 403 <code>auth.session.forbidden</code> Session kh\u00f4ng thu\u1ed9c v\u1ec1 user hi\u1ec7n t\u1ea1i 404 <code>auth.session.not_found</code> Kh\u00f4ng t\u00ecm th\u1ea5y session \u0111\u01b0\u1ee3c y\u00eau c\u1ea7u 422 <code>common.validation_error</code> JSON h\u1ee3p l\u1ec7 nh\u01b0ng kh\u00f4ng tho\u1ea3 \u0111i\u1ec1u ki\u1ec7n nghi\u1ec7p v\u1ee5 429 <code>common.rate_limited</code> V\u01b0\u1ee3t ng\u01b0\u1ee1ng RPS/burst (theo ADR-022) 500 <code>common.internal_error</code> L\u1ed7i h\u1ec7 th\u1ed1ng n\u1ed9i b\u1ed9 <p>\u2757 Note: M\u1ecdi l\u1ed7i \u0111\u1ec1u s\u1eed d\u1ee5ng chu\u1ea9n <code>ErrorEnvelope</code> t\u1eeb ADR-011</p>"},{"location":"services/token-service/interface-contract/#4-post-v1tokenintrospect","title":"\u2705 4. POST <code>/v1/token/introspect</code>","text":""},{"location":"services/token-service/interface-contract/#muc-ich_3","title":"\ud83c\udfaf M\u1ee5c \u0111\u00edch","text":"<p>Ki\u1ec3m tra t\u00ednh h\u1ee3p l\u1ec7 c\u1ee7a m\u1ed9t access token ho\u1eb7c refresh token. Tr\u1ea3 v\u1ec1 metadata n\u1ebfu h\u1ee3p l\u1ec7, ho\u1eb7c tr\u1ea1ng th\u00e1i <code>active: false</code> n\u1ebfu kh\u00f4ng h\u1ee3p l\u1ec7. API \u0111\u01b0\u1ee3c d\u00f9ng ch\u1ee7 y\u1ebfu b\u1edfi c\u00e1c h\u1ec7 th\u1ed1ng backend nh\u01b0 API Gateway ho\u1eb7c c\u00e1c service ph\u1ee5 tr\u1ee3 mu\u1ed1n x\u00e1c minh th\u00f4ng tin token (khi kh\u00f4ng d\u00f9ng JWKS tr\u1ef1c ti\u1ebfp).</p>"},{"location":"services/token-service/interface-contract/#headers-yeu-cau_3","title":"\ud83d\udd10 Headers y\u00eau c\u1ea7u","text":"T\u00ean Header B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>X-Request-ID</code> \u2705 ID truy v\u1ebft request <code>X-Tenant-ID</code> \u2705 Tenant hi\u1ec7n h\u00e0nh <code>Content-Type</code> \u2705 <code>application/json</code> <code>Authorization</code> \u2705 Access token c\u00f3 quy\u1ec1n introspect token (th\u01b0\u1eddng l\u00e0 h\u1ec7 th\u1ed1ng n\u1ed9i b\u1ed9)"},{"location":"services/token-service/interface-contract/#request-body_3","title":"\ud83d\udce5 Request Body","text":"<pre><code>{\n  \"token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\"\n}\n</code></pre> Tr\u01b0\u1eddng B\u1eaft bu\u1ed9c Ki\u1ec3u DL M\u00f4 t\u1ea3 <code>token</code> \u2705 string JWT token c\u1ea7n ki\u1ec3m tra"},{"location":"services/token-service/interface-contract/#response-200-ok","title":"\ud83d\udce4 Response (200 OK)","text":"<p>Tr\u01b0\u1eddng <code>active</code> cho bi\u1ebft token c\u00f3 h\u1ee3p l\u1ec7 kh\u00f4ng. N\u1ebfu <code>active: false</code>, c\u00e1c tr\u01b0\u1eddng c\u00f2n l\u1ea1i c\u00f3 th\u1ec3 r\u1ed7ng ho\u1eb7c kh\u00f4ng t\u1ed3n t\u1ea1i.</p> <pre><code>{\n  \"active\": true,\n  \"sub\": \"user-123\",\n  \"aud\": \"dx-vas\",\n  \"exp\": 1711111111,\n  \"iat\": 1711100000,\n  \"scope\": \"read write\",\n  \"token_type\": \"access\",\n  \"session_id\": \"session-abc-uuid\",\n  \"client_id\": \"frontend-app\",\n  \"login_method\": \"otp\",\n  \"meta\": {\n    \"device_type\": \"web\",\n    \"ip_address\": \"192.168.1.10\",\n    \"user_agent\": \"Mozilla/5.0\"\n  }\n}\n</code></pre> Tr\u01b0\u1eddng M\u00f4 t\u1ea3 <code>active</code> Token h\u1ee3p l\u1ec7 (<code>true</code>) hay kh\u00f4ng (<code>false</code>) <code>sub</code> ID ng\u01b0\u1eddi d\u00f9ng <code>exp</code>, <code>iat</code> Th\u1eddi \u0111i\u1ec3m h\u1ebft h\u1ea1n / ph\u00e1t h\u00e0nh <code>token_type</code> access / refresh <code>session_id</code> G\u1eafn v\u1edbi b\u1ea3ng <code>auth_sessions</code> <code>meta</code> D\u1eef li\u1ec7u b\u1ed5 sung (IP, thi\u1ebft b\u1ecb, agent...) <code>login_method</code> Ph\u01b0\u01a1ng th\u1ee9c \u0111\u0103ng nh\u1eadp ban \u0111\u1ea7u c\u1ee7a session (<code>otp</code>, <code>google</code>, <code>local</code>)"},{"location":"services/token-service/interface-contract/#error-responses_3","title":"\u274c Error Responses","text":"HTTP code message 400 <code>auth.introspect.invalid</code> Token \u0111\u1ea7u v\u00e0o kh\u00f4ng h\u1ee3p l\u1ec7 401 <code>auth.unauthorized</code> Kh\u00f4ng c\u00f3 quy\u1ec1n introspect token 422 <code>common.validation_error</code> JSON h\u1ee3p l\u1ec7 nh\u01b0ng kh\u00f4ng tho\u1ea3 \u0111i\u1ec1u ki\u1ec7n nghi\u1ec7p v\u1ee5 429 <code>common.rate_limited</code> V\u01b0\u1ee3t ng\u01b0\u1ee1ng RPS/burst (theo ADR-022) 500 <code>common.internal_error</code> L\u1ed7i h\u1ec7 th\u1ed1ng <p>\u2757 API tr\u1ea3 v\u1ec1 <code>200 OK</code> v\u1edbi <code>active: false</code> n\u1ebfu token kh\u00f4ng h\u1ee3p l\u1ec7 \u2013 kh\u00f4ng tr\u1ea3 v\u1ec1 <code>401</code> \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o kh\u00f4ng ti\u1ebft l\u1ed9 th\u00f4ng tin cho attacker.</p>"},{"location":"services/token-service/interface-contract/#5-get-well-knownjwksjson","title":"\u2705 5. GET <code>/.well-known/jwks.json</code>","text":""},{"location":"services/token-service/interface-contract/#muc-ich_4","title":"\ud83c\udfaf M\u1ee5c \u0111\u00edch","text":"<p>Cung c\u1ea5p danh s\u00e1ch public key hi\u1ec7n h\u00e0nh d\u00f9ng \u0111\u1ec3 x\u00e1c minh ch\u1eef k\u00fd JWT do <code>token-service</code> ph\u00e1t h\u00e0nh. Endpoint n\u00e0y ph\u1ee5c v\u1ee5 cho vi\u1ec7c verify token ph\u00eda client, API Gateway, ho\u1eb7c c\u00e1c service kh\u00e1c th\u00f4ng qua <code>kid</code> trong header c\u1ee7a JWT.</p>"},{"location":"services/token-service/interface-contract/#authorization","title":"\ud83d\udd13 Authorization","text":"<ul> <li>\u274c Kh\u00f4ng y\u00eau c\u1ea7u x\u00e1c th\u1ef1c</li> <li>\u2705 Public endpoint, c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c truy c\u1eadp b\u1edfi b\u1ea5t k\u1ef3 h\u1ec7 th\u1ed1ng n\u00e0o c\u1ea7n verify ch\u1eef k\u00fd</li> </ul>"},{"location":"services/token-service/interface-contract/#response-200-ok_1","title":"\ud83d\udce4 Response (200 OK)","text":"<pre><code>{\n  \"keys\": [\n    {\n      \"kty\": \"RSA\",\n      \"kid\": \"2024-rotation-1\",\n      \"use\": \"sig\",\n      \"alg\": \"RS256\",\n      \"n\": \"uA6kkl5e8fKNS3k0_4ZFnN...\",\n      \"e\": \"AQAB\"\n    },\n    {\n      \"kty\": \"RSA\",\n      \"kid\": \"2023-fallback\",\n      \"use\": \"sig\",\n      \"alg\": \"RS256\",\n      \"n\": \"zN9uhNfUJ73hdJs0_qlmv...\",\n      \"e\": \"AQAB\"\n    }\n  ]\n}\n</code></pre> Tr\u01b0\u1eddng M\u00f4 t\u1ea3 <code>kid</code> Key ID \u2013 d\u00f9ng \u0111\u1ec3 kh\u1edbp v\u1edbi <code>kid</code> trong JWT header <code>alg</code> Thu\u1eadt to\u00e1n ch\u1eef k\u00fd \u2013 th\u01b0\u1eddng l\u00e0 <code>RS256</code> <code>kty</code> Lo\u1ea1i key, v\u00ed d\u1ee5 <code>RSA</code> <code>use</code> M\u1ee5c \u0111\u00edch \u2013 \u1edf \u0111\u00e2y l\u00e0 <code>\"sig\"</code> \u0111\u1ec3 k\u00fd token <code>n</code>, <code>e</code> Th\u00e0nh ph\u1ea7n c\u1ee7a public key (modulus v\u00e0 exponent)"},{"location":"services/token-service/interface-contract/#rotation-va-cache","title":"\u267b\ufe0f Rotation v\u00e0 cache","text":"<ul> <li>C\u00e1c public key s\u1ebd \u0111\u01b0\u1ee3c xoay v\u00f2ng \u0111\u1ecbnh k\u1ef3 theo ch\u00ednh s\u00e1ch t\u1eeb 03-cr-token-service.md</li> <li>Th\u1eddi gian cache: <code>max-age=3600</code> (1h) khuy\u1ebfn ngh\u1ecb \u0111\u1ec3 tr\u00e1nh g\u1ecdi l\u1ea1i li\u00ean t\u1ee5c</li> </ul> <pre><code>Cache-Control: public, max-age=3600\nContent-Type: application/json\n</code></pre>"},{"location":"services/token-service/interface-contract/#ung-dung","title":"\u2705 \u1ee8ng d\u1ee5ng","text":"<ul> <li>C\u00e1c service ho\u1eb7c gateway ch\u1ec9 c\u1ea7n l\u1ea5y public key t\u1eeb endpoint n\u00e0y v\u00e0 l\u01b0u v\u00e0o cache.</li> <li>S\u1eed d\u1ee5ng th\u01b0 vi\u1ec7n x\u00e1c th\u1ef1c JWT (nh\u01b0 <code>jsonwebtoken</code>, <code>pyjwt</code>, <code>jose</code>) \u0111\u1ec3 verify ch\u1eef k\u00fd d\u1ef1a tr\u00ean <code>kid</code>.</li> </ul>"},{"location":"services/token-service/interface-contract/#ghi-chu-ve-jwksjson-va-caching-strategy","title":"\ud83d\udd10 Ghi ch\u00fa v\u1ec1 <code>/jwks.json</code> v\u00e0 Caching Strategy","text":"<ul> <li> <p>Endpoint <code>/.well-known/jwks.json</code> l\u00e0 public, kh\u00f4ng y\u00eau c\u1ea7u x\u00e1c th\u1ef1c, v\u00e0 \u0111\u01b0\u1ee3c c\u00e1c service kh\u00e1c s\u1eed d\u1ee5ng \u0111\u1ec3 verify ch\u1eef k\u00fd JWT.</p> </li> <li> <p>\u0110\u1ec3 t\u0103ng hi\u1ec7u su\u1ea5t v\u00e0 gi\u1ea3m t\u1ea3i cho <code>token-service</code>, trong m\u00f4i tr\u01b0\u1eddng Production, endpoint n\u00e0y n\u00ean \u0111\u01b0\u1ee3c cache b\u1edfi Public API Gateway ho\u1eb7c CDN (nh\u01b0 Cloudflare, Cloud CDN).</p> </li> </ul>"},{"location":"services/token-service/interface-contract/#goi-y-cau-hinh-caching","title":"\ud83d\udd04 G\u1ee3i \u00fd c\u1ea5u h\u00ecnh caching:","text":"Header Gi\u00e1 tr\u1ecb \u0111\u1ec1 xu\u1ea5t M\u00f4 t\u1ea3 <code>Cache-Control</code> <code>public, max-age=3600</code> Cho ph\u00e9p cache trong 1 gi\u1edd <code>ETag</code> <code>\"&lt;fingerprint&gt;\"</code> Cho ph\u00e9p client check b\u1eb1ng <code>If-None-Match</code> <code>Last-Modified</code> <code>ISO timestamp</code> H\u1ed7 tr\u1ee3 cache theo th\u1eddi gian c\u1eadp nh\u1eadt <p>\ud83d\udd10 JWKS ch\u1ec9 n\u00ean thay \u0111\u1ed5i khi rotate public keys. Khi \u0111\u00f3 c\u1ea7n <code>purge cache</code> ho\u1eb7c invalidate.</p> <p>\ud83d\udccc N\u1ebfu tri\u1ec3n khai tr\u00ean GCP API Gateway, b\u1ea1n c\u00f3 th\u1ec3 d\u00f9ng c\u1ea5u h\u00ecnh <code>x-google-backend.cacheControl</code> ho\u1eb7c g\u1eafn cache layer ri\u00eang t\u1ea1i Cloud CDN.</p> <pre><code>paths:\n  /.well-known/jwks.json:\n    get:\n      summary: JWKS public keys\n      responses:\n        '200':\n          headers:\n            Cache-Control:\n              schema:\n                type: string\n              example: public, max-age=3600\n</code></pre>"},{"location":"services/token-service/interface-contract/#enum-su-dung","title":"\ud83d\udcce ENUM s\u1eed d\u1ee5ng","text":"<p>Trong qu\u00e1 tr\u00ecnh thi\u1ebft k\u1ebf API c\u1ee7a <code>token-service</code>, m\u1ed9t s\u1ed1 enum \u0111\u00e3 \u0111\u01b0\u1ee3c chu\u1ea9n h\u00f3a \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o t\u00ednh r\u00f5 r\u00e0ng, m\u1edf r\u1ed9ng v\u00e0 h\u1ed7 tr\u1ee3 t\u1ed1t cho UI/UX, ki\u1ec3m th\u1eed v\u00e0 i18n. D\u01b0\u1edbi \u0111\u00e2y l\u00e0 danh s\u00e1ch c\u00e1c enum \u0111ang \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng.</p>"},{"location":"services/token-service/interface-contract/#1-token_type","title":"1. <code>token_type</code>","text":"Gi\u00e1 tr\u1ecb M\u00f4 t\u1ea3 <code>access</code> Token truy c\u1eadp, c\u00f3 th\u1eddi h\u1ea1n ng\u1eafn (~15 ph\u00fat) <code>refresh</code> Token l\u00e0m m\u1edbi, d\u00f9ng \u0111\u1ec3 l\u1ea5y access token m\u1edbi <p>\ud83d\udd10 Enum n\u00e0y \u0111\u01b0\u1ee3c d\u00f9ng trong response c\u1ee7a <code>/v1/token/introspect</code> \u0111\u1ec3 ph\u00e2n bi\u1ec7t lo\u1ea1i token \u0111ang \u0111\u01b0\u1ee3c ki\u1ec3m tra.</p>"},{"location":"services/token-service/interface-contract/#2-grant_type","title":"2. <code>grant_type</code>","text":"Gi\u00e1 tr\u1ecb M\u00f4 t\u1ea3 <code>password</code> \u0110\u0103ng nh\u1eadp qua email/password truy\u1ec1n th\u1ed1ng <code>refresh_token</code> L\u00e0m m\u1edbi token th\u00f4ng qua refresh token <code>jwt_bearer</code> Grant flow n\u1ed9i b\u1ed9 s\u1eed d\u1ee5ng JWT \u0111\u00e3 \u0111\u01b0\u1ee3c x\u00e1c th\u1ef1c tr\u01b0\u1edbc \u0111\u00f3 <p>\ud83d\udd04 Enum n\u00e0y gi\u00fap m\u1edf r\u1ed9ng cho c\u00e1c lu\u1ed3ng x\u00e1c th\u1ef1c OAuth2 trong t\u01b0\u01a1ng lai.</p>"},{"location":"services/token-service/interface-contract/#3-device_type","title":"3. <code>device_type</code>","text":"Gi\u00e1 tr\u1ecb M\u00f4 t\u1ea3 <code>web</code> Tr\u00ecnh duy\u1ec7t web th\u00f4ng th\u01b0\u1eddng <code>android</code> Thi\u1ebft b\u1ecb Android <code>ios</code> Thi\u1ebft b\u1ecb iOS <p>\ud83d\udcf1 \u0110\u01b0\u1ee3c d\u00f9ng trong metadata c\u1ee7a <code>auth_sessions</code> v\u00e0 introspection response \u0111\u1ec3 ph\u1ee5c v\u1ee5 th\u1ed1ng k\u00ea, c\u1ea3nh b\u00e1o b\u1ea3o m\u1eadt, v\u00e0 ph\u00e2n t\u00edch h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng.</p>"},{"location":"services/token-service/interface-contract/#4-session_status-du-phong-cho-mo-rong-tuong-lai","title":"4. <code>session_status</code> (d\u1ef1 ph\u00f2ng cho m\u1edf r\u1ed9ng t\u01b0\u01a1ng lai)","text":"Gi\u00e1 tr\u1ecb M\u00f4 t\u1ea3 <code>active</code> Phi\u00ean \u0111ang ho\u1ea1t \u0111\u1ed9ng v\u00e0 c\u00f3 th\u1ec3 s\u1eed d\u1ee5ng <code>revoked</code> Phi\u00ean \u0111\u00e3 b\u1ecb thu h\u1ed3i b\u1edfi ng\u01b0\u1eddi d\u00f9ng ho\u1eb7c h\u1ec7 th\u1ed1ng <code>expired</code> Phi\u00ean \u0111\u00e3 h\u1ebft h\u1ea1n theo th\u1eddi gian c\u1ea5u h\u00ecnh <p>\u23f3 Enum n\u00e0y s\u1ebd h\u1eefu \u00edch n\u1ebfu h\u1ec7 th\u1ed1ng m\u1edf r\u1ed9ng logic qu\u1ea3n l\u00fd session n\u00e2ng cao.</p>"},{"location":"services/token-service/interface-contract/#5-login_method","title":"5. <code>login_method</code>","text":"Gi\u00e1 tr\u1ecb M\u00f4 t\u1ea3 <code>google</code> \u0110\u0103ng nh\u1eadp b\u1eb1ng Google OAuth2 <code>otp</code> \u0110\u0103ng nh\u1eadp b\u1eb1ng m\u00e3 OTP <code>local</code> \u0110\u0103ng nh\u1eadp b\u1eb1ng t\u00e0i kho\u1ea3n n\u1ed9i b\u1ed9 <p>\ud83d\udd10 D\u00f9ng \u0111\u1ec3 x\u00e1c \u0111\u1ecbnh ph\u01b0\u01a1ng th\u1ee9c x\u00e1c th\u1ef1c \u0111\u00e3 \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng khi ph\u00e1t h\u00e0nh token/session.</p>"},{"location":"services/token-service/interface-contract/#permission-mapping","title":"\ud83d\udcce Permission Mapping","text":"<p>M\u1eb7c d\u00f9 <code>token-service</code> kh\u00f4ng tr\u1ef1c ti\u1ebfp qu\u1ea3n l\u00fd ng\u01b0\u1eddi d\u00f9ng ho\u1eb7c ph\u00e2n quy\u1ec1n truy c\u1eadp t\u00e0i nguy\u00ean, nh\u01b0ng v\u1eabn c\u1ea7n \u0111\u1ecbnh ngh\u0129a r\u00f5 c\u00e1c quy\u1ec1n (permissions) \u00e1p d\u1ee5ng cho c\u00e1c h\u1ec7 th\u1ed1ng g\u1ecdi \u0111\u1ebfn c\u00e1c endpoint \u0111\u1eb7c th\u00f9 nh\u01b0 introspect ho\u1eb7c revoke. \u0110i\u1ec1u n\u00e0y \u0111\u1ea3m b\u1ea3o ki\u1ec3m so\u00e1t truy c\u1eadp, tu\u00e2n th\u1ee7 nguy\u00ean t\u1eafc Principle of Least Privilege (ADR-004, ADR-006, ADR-007).</p>"},{"location":"services/token-service/interface-contract/#note-event-names-follow-adr-030-v1","title":"&gt; Note: Event names follow ADR-030 (*.v1)","text":""},{"location":"services/token-service/interface-contract/#cac-permission-ap-dung-cho-token-service","title":"\ud83d\udd12 C\u00e1c permission \u00e1p d\u1ee5ng cho <code>token-service</code>","text":"Permission Key M\u00f4 t\u1ea3 Endpoint y\u00eau c\u1ea7u <code>token.generate</code> Cho ph\u00e9p t\u1ea1o access token / refresh token (n\u1ed9i b\u1ed9) <code>POST /v1/token</code> <code>token.refresh</code> Cho ph\u00e9p l\u00e0m m\u1edbi access token th\u00f4ng qua refresh token <code>POST /v1/token/refresh</code> <code>token.revoke</code> Cho ph\u00e9p thu h\u1ed3i (revoke) m\u1ed9t session token c\u1ee5 th\u1ec3 <code>POST /v1/token/revoke</code> <code>token.introspect</code> Cho ph\u00e9p ki\u1ec3m tra th\u00f4ng tin v\u00e0 tr\u1ea1ng th\u00e1i c\u1ee7a token <code>POST /v1/token/introspect</code> <code>token.jwks.read</code> Quy\u1ec1n public, kh\u00f4ng c\u1ea7n auth \u2013 d\u00f9ng cho <code>GET /.well-known/jwks.json</code> \u274c (public) <p>\ud83d\udccc Trong h\u1ea7u h\u1ebft c\u00e1c tr\u01b0\u1eddng h\u1ee3p, <code>token-service</code> ho\u1ea1t \u0111\u1ed9ng nh\u01b0 service n\u1ed9i b\u1ed9 n\u00ean c\u00e1c quy\u1ec1n n\u00e0y \u0111\u01b0\u1ee3c ki\u1ec3m tra b\u1eb1ng service-to-service authentication (JWT c\u00f3 embedded scope/permission claim).</p>"},{"location":"services/token-service/interface-contract/#vi-du-cau-truc-claim-permissions-trong-access-token","title":"\ud83e\udde9 V\u00ed d\u1ee5 c\u1ea5u tr\u00fac claim <code>permissions</code> trong access token:","text":"<pre><code>{\n  \"sub\": \"user-abc-123\",\n  \"scope\": \"read write\",\n  \"permissions\": [\n    \"user.read\",\n    \"token.introspect\",\n    \"token.revoke\"\n  ],\n  \"aud\": \"dx-vas\",\n  \"exp\": 1712345678\n}\n</code></pre>"},{"location":"services/token-service/interface-contract/#ap-dung-trong-openapi","title":"\u2705 \u00c1p d\u1ee5ng trong OpenAPI","text":"<p>M\u1ed7i operation trong <code>openapi.yaml</code> n\u00ean khai b\u00e1o custom field:</p> <pre><code>x-required-permission: token.introspect\n</code></pre> <p>Ho\u1eb7c n\u1ebfu operation kh\u00f4ng c\u1ea7n quy\u1ec1n c\u1ee5 th\u1ec3 (v\u00ed d\u1ee5: <code>/.well-known/jwks.json</code>) th\u00ec kh\u00f4ng c\u1ea7n khai b\u00e1o permission.</p>"},{"location":"services/token-service/interface-contract/#error-codes-envelope","title":"\ud83d\udee1\ufe0f Error Codes &amp; Envelope","text":"<p>T\u1ea5t c\u1ea3 l\u1ed7i \u0111\u01b0\u1ee3c tr\u1ea3 v\u1ec1 d\u01b0\u1edbi d\u1ea1ng chu\u1ea9n <code>ErrorEnvelope</code> (ADR-011), \u0111\u1ea3m b\u1ea3o nh\u1ea5t qu\u00e1n trong to\u00e0n h\u1ec7 th\u1ed1ng.</p> <pre><code>{\n  \"error\": {\n    \"code\": \"token.expired\",\n    \"message\": \"Token has expired\"\n  },\n  \"meta\": {\n    \"trace_id\": \"a1b2c3\",\n    \"timestamp\": \"2025-06-07T10:30:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/token-service/interface-contract/#bang-ma-loi-chi-tiet","title":"\ud83d\udd12 B\u1ea3ng m\u00e3 l\u1ed7i chi ti\u1ebft","text":"M\u00e3 l\u1ed7i (<code>error.code</code>) M\u00f4 t\u1ea3 HTTP Status \u00c1p d\u1ee5ng cho endpoint <code>token.invalid</code> Access token kh\u00f4ng h\u1ee3p l\u1ec7 401 <code>/v1/token/introspect</code> <code>token.expired</code> Token \u0111\u00e3 h\u1ebft h\u1ea1n 401 <code>/v1/token/refresh</code>, introspect <code>token.revoked</code> Token \u0111\u00e3 b\u1ecb thu h\u1ed3i 401 <code>/v1/token/refresh</code>, introspect <code>token.unknown_jti</code> Token kh\u00f4ng n\u1eb1m trong danh s\u00e1ch thu h\u1ed3i 400 <code>/v1/token/revoke</code> <code>session.not_found</code> Kh\u00f4ng t\u00ecm th\u1ea5y phi\u00ean \u0111\u0103ng nh\u1eadp 404 <code>/v1/token/revoke</code> <code>session.inactive</code> Phi\u00ean \u0111\u0103ng nh\u1eadp \u0111\u00e3 b\u1ecb h\u1ee7y 403 <code>/v1/token/refresh</code>, <code>/v1/token/revoke</code> <code>jwks.not_found</code> Kh\u00f4ng t\u00ecm th\u1ea5y kho\u00e1 c\u00f4ng khai JWKS 500 <code>/.well-known/jwks.json</code> <code>common.validation_error</code> D\u1eef li\u1ec7u g\u1eedi l\u00ean kh\u00f4ng h\u1ee3p l\u1ec7 400 M\u1ecdi endpoint <code>POST</code> <code>common.missing_param</code> Thi\u1ebfu tham s\u1ed1 b\u1eaft bu\u1ed9c (<code>grant_type</code>, <code>refresh_token</code>) 400 <code>/v1/token</code>, <code>/v1/token/refresh</code> <code>common.unauthorized</code> Thi\u1ebfu token ho\u1eb7c token kh\u00f4ng h\u1ee3p l\u1ec7 401 T\u1ea5t c\u1ea3 endpoint b\u1ea3o v\u1ec7 <code>common.forbidden</code> Kh\u00f4ng \u0111\u1ee7 quy\u1ec1n th\u1ef1c hi\u1ec7n h\u00e0nh \u0111\u1ed9ng 403 Theo <code>x-required-permission</code> <code>common.validation_error</code> JSON h\u1ee3p l\u1ec7 nh\u01b0ng kh\u00f4ng tho\u1ea3 \u0111i\u1ec1u ki\u1ec7n nghi\u1ec7p v\u1ee5 422 M\u1ecdi endpoint <code>common.rate_limited</code> V\u01b0\u1ee3t ng\u01b0\u1ee1ng RPS/burst (theo ADR-022) 429 M\u1ecdi endpoint <code>common.internal_error</code> L\u1ed7i kh\u00f4ng x\u00e1c \u0111\u1ecbnh t\u1eeb ph\u00eda server 500 M\u1ecdi endpoint"},{"location":"services/token-service/interface-contract/#response-headers-rate-limiting-adr-022","title":"Response Headers \u2013 Rate Limiting  (ADR-022)","text":"Header Description Example <code>RateLimit-Limit</code> Gi\u1edbi h\u1ea1n t\u1ed1i \u0111a request trong 1 c\u1eeda s\u1ed5 (per tenant / client). <code>120</code> <code>RateLimit-Remaining</code> S\u1ed1 request c\u00f2n l\u1ea1i trong c\u1eeda s\u1ed5 hi\u1ec7n t\u1ea1i. Ch\u1ec9 xu\u1ea5t hi\u1ec7n khi c\u00f2n &gt; 0. <code>17</code> <code>Retry-After</code> Th\u1eddi gian (gi\u00e2y) c\u1ea7n ch\u1edd tr\u01b0\u1edbc khi g\u1eedi l\u1ea1i request, k\u00e8m theo HTTP 429. <code>42</code>"},{"location":"services/token-service/interface-contract/#header-ratelimit-remaining-va-retry-after-uoc-tra-ve-khi-gan-het-hoac-a-vuot-qua-nguong-tuan-theo-khuyen-nghi-adr-022-slaslo-monitoring","title":"&gt; Header <code>RateLimit-Remaining</code> v\u00e0 <code>Retry-After</code> \u0111\u01b0\u1ee3c tr\u1ea3 v\u1ec1 khi g\u1ea7n h\u1ebft ho\u1eb7c \u0111\u00e3 v\u01b0\u1ee3t qu\u00e1 ng\u01b0\u1ee1ng, tu\u00e2n theo khuy\u1ebfn ngh\u1ecb ADR-022 SLA/SLO Monitoring.","text":"<p>\ud83d\udccc M\u1ecdi l\u1ed7i \u0111\u1ec1u tr\u1ea3 v\u1ec1 k\u00e8m <code>X-Request-ID</code> trong response headers v\u00e0 \u0111\u01b0\u1ee3c ghi log (audit + cloud logging).</p>"},{"location":"services/token-service/interface-contract/#vi-du-curl","title":"\ud83d\udcdd V\u00ed d\u1ee5 Curl","text":"<p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c v\u00ed d\u1ee5 <code>curl</code> minh h\u1ecda c\u00e1ch s\u1eed d\u1ee5ng c\u00e1c API ch\u00ednh c\u1ee7a <code>token-service</code>. C\u00e1c v\u00ed d\u1ee5 n\u00e0y d\u00f9ng \u0111\u1ec3 ki\u1ec3m th\u1eed nhanh, t\u00edch h\u1ee3p CI pipeline, ho\u1eb7c h\u01b0\u1edbng d\u1eabn frontend/backend team t\u00edch h\u1ee3p.</p>"},{"location":"services/token-service/interface-contract/#1-ang-nhap-e-lay-token-moi","title":"\ud83d\udd11 1. \u0110\u0103ng nh\u1eadp \u0111\u1ec3 l\u1ea5y token m\u1edbi","text":"<pre><code>curl -X POST https://api.truongvietanh.edu.vn/v1/token \\\n  -H \"Content-Type: application/json\" \\\n  -H \"X-Request-ID: req-001\" \\\n  -H \"X-Tenant-ID: vas-primary\" \\\n  -H \"Authorization: Bearer &lt;service-token&gt;\" \\\n  -d '{\n    \"sub\": \"user-123\",\n    \"roles\": [\"teacher\"],\n    \"permissions\": [\"report.view_login_by_tenant\"],\n    \"session_id\": \"sess-abc-123\",\n    \"login_method\": \"otp\",\n    \"session_metadata\": {\n      \"ip\": \"113.23.45.12\",\n      \"device_type\": \"android\"\n    }\n  }'\n</code></pre> <p>\ud83d\udccc Tr\u1ea3 v\u1ec1 access_token + refresh_token n\u1ebfu h\u1ee3p l\u1ec7.</p>"},{"location":"services/token-service/interface-contract/#2-lam-moi-token","title":"\u267b\ufe0f 2. L\u00e0m m\u1edbi token","text":"<pre><code>curl -X POST https://api.truongvietanh.edu.vn/v1/token/refresh \\\n  -H \"Content-Type: application/json\" \\\n  -H \"X-Request-ID: req-002\" \\\n  -H \"X-Tenant-ID: vas-truongvietanh\" \\\n  -d '{\n    \"refresh_token\": \"eyJhbGciOiJIUzI1NiIsIn...\"\n  }'\n</code></pre> <p>\ud83d\udccc Tr\u1ea3 v\u1ec1 c\u1eb7p token m\u1edbi n\u1ebfu refresh token h\u1ee3p l\u1ec7.</p>"},{"location":"services/token-service/interface-contract/#3-thu-hoi-token-logout-toan-bo-thiet-bi","title":"\ud83d\uded1 3. Thu h\u1ed3i token (logout to\u00e0n b\u1ed9 thi\u1ebft b\u1ecb)","text":"<pre><code>curl -X POST https://api.truongvietanh.edu.vn/v1/token/revoke \\\n  -H \"Authorization: Bearer &lt;access_token&gt;\" \\\n  -H \"X-Request-ID: req-003\" \\\n  -H \"X-Tenant-ID: vas-truongvietanh\" \\\n  -d '{}'\n</code></pre> <p>\ud83d\udccc Thu h\u1ed3i session hi\u1ec7n t\u1ea1i (access + refresh token).</p>"},{"location":"services/token-service/interface-contract/#4-kiem-tra-token-introspect","title":"\ud83e\uddd0 4. Ki\u1ec3m tra token (introspect)","text":"<pre><code>curl -X POST https://api.truongvietanh.edu.vn/v1/token/introspect \\\n  -H \"Authorization: Bearer &lt;access_token&gt;\" \\\n  -H \"X-Request-ID: req-004\" \\\n  -H \"X-Tenant-ID: vas-truongvietanh\" \\\n  -d '{\n    \"token\": \"eyJhbGciOiJIUzI1NiIsIn...\"\n  }'\n</code></pre> <p>\ud83d\udccc Tr\u1ea3 v\u1ec1 th\u00f4ng tin token, tr\u1ea1ng th\u00e1i (active/revoked/expired), claims.</p>"},{"location":"services/token-service/interface-contract/#5-lay-jwks-key","title":"\ud83d\udd10 5. L\u1ea5y JWKS key","text":"<pre><code>curl -X GET https://api.truongvietanh.edu.vn/.well-known/jwks.json\n</code></pre> <p>\ud83d\udccc Tr\u1ea3 v\u1ec1 public key JWKS \u0111\u1ec3 h\u1ec7 th\u1ed1ng kh\u00e1c verify ch\u1eef k\u00fd JWT.</p>"},{"location":"services/token-service/interface-contract/#ghi-chu","title":"\ud83e\uddea Ghi ch\u00fa","text":"<ul> <li><code>X-Request-ID</code> l\u00e0 b\u1eaft bu\u1ed9c \u0111\u1ec3 trace log.</li> <li><code>X-Tenant-ID</code> gi\u00fap multi-tenant isolation (b\u1eaft bu\u1ed9c).</li> <li>B\u1ea1n c\u00f3 th\u1ec3 test JWT validity v\u1edbi jwt.io.</li> <li>Token m\u1eabu \u0111\u1ec3 test c\u00f3 th\u1ec3 l\u1ea5y t\u1eeb Auth Web ho\u1eb7c Dev Tool g\u1eafn v\u1edbi <code>auth-service</code>.</li> </ul>"},{"location":"services/token-service/interface-contract/#tai-lieu-lien-quan","title":"\ud83d\udcda T\u00e0i li\u1ec7u li\u00ean quan","text":"<ul> <li>Design</li> <li>Data Model</li> <li>OpenAPI Spec</li> </ul>"},{"location":"services/token-service/interface-contract/#cac-quyet-inh-kien-truc-adr","title":"\ud83d\udd16 C\u00e1c Quy\u1ebft \u0111\u1ecbnh Ki\u1ebfn tr\u00fac (ADR)","text":"<ul> <li>ADR-003 Secrets Management: Quy tr\u00ecnh l\u01b0u tr\u1eef &amp; xoay kh\u00f3a b\u00ed m\u1eadt an to\u00e0n.  </li> <li>ADR-004 Security Policy: Ch\u00ednh s\u00e1ch b\u1ea3o m\u1eadt t\u1ed5ng th\u1ec3.  </li> <li>ADR-005 Environment Configuration Strategy: Chu\u1ea9n t\u00e1ch c\u1ea5u h\u00ecnh \u2013 <code>SERVICE__SECTION__KEY</code>.  </li> <li>ADR-006 Auth Strategy: Chi\u1ebfn l\u01b0\u1ee3c x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng v\u00e0 c\u1ea5p ph\u00e1t token.  </li> <li>ADR-009 API Governance: Quy t\u1eafc versioning, naming v\u00e0 style REST.  </li> <li>ADR-011 API Error Format: Quy \u01b0\u1edbc m\u00e3 l\u1ed7i &amp; th\u00f4ng \u0111i\u1ec7p l\u1ed7i (<code>namespace.snake_case</code>).  </li> <li>ADR-012 Response Structure: Chu\u1ea9n h\u00f3a c\u1ea5u tr\u00fac JSON response cho API.</li> <li>ADR-018 Release Approval Policy: Quy tr\u00ecnh ph\u00ea duy\u1ec7t ph\u00e1t h\u00e0nh.</li> <li>ADR-022 SLA &amp; SLO Monitoring: Khung gi\u00e1m s\u00e1t &amp; \u0111\u1ecbnh ngh\u0129a SLO.</li> <li>ADR-023 Schema Migration Strategy: 3-phase migration (Prepare \u2192 Transition \u2192 Cleanup).  </li> <li>ADR-024 Data Anonymization &amp; Retention: \u1ea8n danh PII v\u00e0 TTL d\u1eef li\u1ec7u.  </li> <li>ADR-026 Hard-Delete Policy: Quy tr\u00ecnh xo\u00e1 v\u0129nh vi\u1ec5n &amp; purge log.  </li> <li>ADR-030 Event Schema Governance: \u0110\u1eb7t t\u00ean &amp; version s\u1ef1 ki\u1ec7n <code>*.v{n}</code>.</li> </ul>"},{"location":"services/user-service/master/data-model/","title":"User Service Master - Data Model","text":""},{"location":"services/user-service/master/data-model/#1-gioi-thieu","title":"1. Gi\u1edbi thi\u1ec7u","text":"<p>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 chi ti\u1ebft m\u00f4 h\u00ecnh d\u1eef li\u1ec7u c\u1ee7a User Service Master \u2013 m\u1ed9t trong nh\u1eefng th\u00e0nh ph\u1ea7n c\u1ed1t l\u00f5i c\u1ee7a h\u1ec7 th\u1ed1ng <code>dx-vas</code> theo ki\u1ebfn tr\u00fac multi-tenant. Service n\u00e0y ch\u1ecbu tr\u00e1ch nhi\u1ec7m qu\u1ea3n l\u00fd \u0111\u1ecbnh danh to\u00e0n c\u1ee5c ng\u01b0\u1eddi d\u00f9ng, th\u00f4ng tin tenant, v\u00e0 m\u1eabu vai tr\u00f2/quy\u1ec1n to\u00e0n c\u1ee5c (RBAC templates).</p>"},{"location":"services/user-service/master/data-model/#2-pham-vi","title":"2. Ph\u1ea1m vi","text":"<p>User Service Master bao g\u1ed3m:</p> <ul> <li>Qu\u1ea3n l\u00fd ng\u01b0\u1eddi d\u00f9ng to\u00e0n h\u1ec7 th\u1ed1ng (<code>users_global</code>).</li> <li>Qu\u1ea3n l\u00fd danh s\u00e1ch tenant (<code>tenants</code>) v\u00e0 tr\u1ea1ng th\u00e1i c\u1ee7a tenant.</li> <li>Qu\u1ea3n l\u00fd vi\u1ec7c g\u00e1n ng\u01b0\u1eddi d\u00f9ng v\u00e0o tenant (<code>user_tenant_assignments</code>).</li> <li>Cung c\u1ea5p m\u1eabu vai tr\u00f2 (<code>global_roles_templates</code>) v\u00e0 m\u1eabu quy\u1ec1n (<code>global_permissions_templates</code>) d\u00f9ng chung cho c\u00e1c tenant.</li> <li>Ph\u00e1t s\u1ef1 ki\u1ec7n t\u1edbi c\u00e1c Sub User Services ho\u1eb7c c\u00e1c service kh\u00e1c khi c\u00f3 thay \u0111\u1ed5i li\u00ean quan \u0111\u1ebfn \u0111\u1ecbnh danh ho\u1eb7c template RBAC.</li> </ul>"},{"location":"services/user-service/master/data-model/#3-khong-bao-gom-out-of-scope","title":"3. Kh\u00f4ng bao g\u1ed3m (Out of Scope)","text":"<p>User Service Master kh\u00f4ng ch\u1ecbu tr\u00e1ch nhi\u1ec7m:</p> <ul> <li>Qu\u1ea3n l\u00fd ng\u01b0\u1eddi d\u00f9ng n\u1ed9i b\u1ed9 c\u1ee7a t\u1eebng tenant \u2013 vi\u1ec7c n\u00e0y thu\u1ed9c v\u1ec1 Sub User Service.</li> <li>Qu\u1ea3n l\u00fd quy\u1ec1n c\u1ee5 th\u1ec3 (<code>roles</code>, <code>permissions</code>, <code>mappings</code>) \u1edf c\u1ea5p tenant.</li> <li>X\u1eed l\u00fd x\u00e1c th\u1ef1c \u0111\u0103ng nh\u1eadp ng\u01b0\u1eddi d\u00f9ng (Google OAuth2, OTP, Local login) \u2013 thu\u1ed9c v\u1ec1 Auth Services.</li> <li>Ghi log audit chi ti\u1ebft t\u1eebng thay \u0111\u1ed5i (n\u1ebfu audit \u0111\u01b0\u1ee3c x\u1eed l\u00fd b\u1edfi service ri\u00eang).</li> </ul>"},{"location":"services/user-service/master/data-model/#4-muc-tieu","title":"4. M\u1ee5c ti\u00eau","text":"<ul> <li>Tr\u00ecnh b\u00e0y c\u1ea5u tr\u00fac c\u00e1c b\u1ea3ng d\u1eef li\u1ec7u c\u1ed1t l\u00f5i c\u1ee7a User Service Master.</li> <li>M\u00f4 t\u1ea3 c\u00e1c r\u00e0ng bu\u1ed9c d\u1eef li\u1ec7u (constraints), kh\u00f3a ch\u00ednh/ngo\u1ea1i, ch\u1ec9 m\u1ee5c.</li> <li>H\u1ed7 tr\u1ee3 cho qu\u00e1 tr\u00ecnh ph\u00e1t tri\u1ec3n backend, vi\u1ebft OpenAPI, migration, testing v\u00e0 b\u1ea3o tr\u00ec.</li> <li>L\u00e0m n\u1ec1n t\u1ea3ng \u0111\u1ec3 \u0111\u1ed3ng b\u1ed9 schema v\u1edbi t\u00e0i li\u1ec7u <code>interface-contract.md</code>, <code>openapi.yaml</code>, v\u00e0 c\u00e1c ADR li\u00ean quan (nh\u01b0 ADR-007, ADR-025).</li> </ul>"},{"location":"services/user-service/master/data-model/#5-cac-bang-chinh-va-phan-nhom-logic","title":"5. C\u00e1c b\u1ea3ng ch\u00ednh v\u00e0 ph\u00e2n nh\u00f3m logic","text":"<p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 danh s\u00e1ch c\u00e1c b\u1ea3ng ch\u00ednh trong c\u01a1 s\u1edf d\u1eef li\u1ec7u c\u1ee7a User Service Master, \u0111\u01b0\u1ee3c chia th\u00e0nh 3 nh\u00f3m logic r\u00f5 r\u00e0ng:</p>"},{"location":"services/user-service/master/data-model/#nhom-a-inh-danh-nguoi-dung-va-phan-quyen-toan-cuc","title":"\ud83d\udd39 Nh\u00f3m A \u2013 \u0110\u1ecbnh danh ng\u01b0\u1eddi d\u00f9ng v\u00e0 ph\u00e2n quy\u1ec1n to\u00e0n c\u1ee5c","text":"T\u00ean b\u1ea3ng Vai tr\u00f2 ch\u00ednh <code>users_global</code> L\u01b0u tr\u1eef th\u00f4ng tin \u0111\u1ecbnh danh ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c. <code>tenants</code> L\u01b0u tr\u1eef th\u00f4ng tin c\u00e1c tenant trong h\u1ec7 th\u1ed1ng. <code>user_tenant_assignments</code> Mapping gi\u1eefa ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c v\u00e0 c\u00e1c tenant, k\u00e8m tr\u1ea1ng th\u00e1i."},{"location":"services/user-service/master/data-model/#nhom-b-template-rbac-dung-chung","title":"\ud83d\udd39 Nh\u00f3m B \u2013 Template RBAC d\u00f9ng chung","text":"T\u00ean b\u1ea3ng Vai tr\u00f2 ch\u00ednh <code>global_roles_templates</code> Danh s\u00e1ch vai tr\u00f2 m\u1eabu d\u00f9ng \u0111\u1ec3 kh\u1edfi t\u1ea1o RBAC trong m\u1ed7i tenant. <code>global_permissions_templates</code> Danh s\u00e1ch quy\u1ec1n m\u1eabu, g\u1eafn v\u1edbi role templates."},{"location":"services/user-service/master/data-model/#nhom-c-ho-tro-mo-rong-tuy-chon","title":"\ud83d\udd39 Nh\u00f3m C \u2013 H\u1ed7 tr\u1ee3 &amp; M\u1edf r\u1ed9ng (tu\u1ef3 ch\u1ecdn)","text":"T\u00ean b\u1ea3ng Vai tr\u00f2 ch\u00ednh <code>processed_events</code> L\u01b0u c\u00e1c <code>event_id</code> \u0111\u00e3 x\u1eed l\u00fd (idempotency khi nh\u1eadn l\u1ea1i message Pub/Sub). <code>audit_log_users_master</code> (Tu\u1ef3 ch\u1ecdn) L\u01b0u log audit c\u00e1c thao t\u00e1c trong User Service Master. <p>\ud83d\udd0d Ghi ch\u00fa: - C\u00e1c b\u1ea3ng \u1edf Nh\u00f3m A l\u00e0 b\u1eaft bu\u1ed9c v\u00e0 trung t\u00e2m c\u1ee7a to\u00e0n b\u1ed9 service. - Nh\u00f3m B h\u1ed7 tr\u1ee3 vi\u1ec7c chu\u1ea9n ho\u00e1 v\u00e0 \u0111\u1ed3ng b\u1ed9 RBAC gi\u1eefa Master v\u00e0 Sub User Service. - Nh\u00f3m C ph\u1ee5c v\u1ee5 kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng, theo d\u00f5i v\u00e0 debug n\u1ebfu c\u1ea7n.</p>"},{"location":"services/user-service/master/data-model/#6-chi-tiet-bang-users_global","title":"6. Chi ti\u1ebft b\u1ea3ng: <code>users_global</code>","text":""},{"location":"services/user-service/master/data-model/#muc-ich","title":"\ud83e\uddfe M\u1ee5c \u0111\u00edch","text":"<p>B\u1ea3ng <code>users_global</code> l\u01b0u tr\u1eef th\u00f4ng tin \u0111\u1ecbnh danh c\u1ed1t l\u00f5i c\u1ee7a ng\u01b0\u1eddi d\u00f9ng trong to\u00e0n b\u1ed9 h\u1ec7 th\u1ed1ng. \u0110\u00e2y l\u00e0 n\u01a1i duy nh\u1ea5t l\u01b0u th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng c\u1ea5p to\u00e0n c\u1ee5c, b\u1ea5t k\u1ec3 h\u1ecd thu\u1ed9c tenant n\u00e0o.</p>"},{"location":"services/user-service/master/data-model/#cau-lenh-create-table","title":"\ud83d\udcdc C\u00e2u l\u1ec7nh <code>CREATE TABLE</code>","text":"<pre><code>CREATE TABLE users_global (\n  user_id UUID PRIMARY KEY,                         -- \ud83d\udd11 ID \u0111\u1ecbnh danh to\u00e0n c\u1ee5c\n  full_name TEXT NOT NULL,                          -- H\u1ecd t\u00ean ng\u01b0\u1eddi d\u00f9ng\n  email TEXT NOT NULL,                              -- Email (d\u00f9ng cho x\u00e1c th\u1ef1c OAuth2 ho\u1eb7c li\u00ean h\u1ec7)\n  phone TEXT,                                       -- S\u1ed1 \u0111i\u1ec7n tho\u1ea1i (n\u1ebfu c\u00f3)\n  auth_provider TEXT NOT NULL,                      -- H\u1ec7 th\u1ed1ng x\u00e1c th\u1ef1c (e.g., \"google\", \"local\", \"zalo\")\n  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,    -- Th\u1eddi \u0111i\u1ec3m t\u1ea1o\n  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,    -- Th\u1eddi \u0111i\u1ec3m c\u1eadp nh\u1eadt g\u1ea7n nh\u1ea5t\n\n  UNIQUE (email, auth_provider),                    -- \ud83d\udd10 M\u1ed7i email ch\u1ec9 \u0111\u01b0\u1ee3c d\u00f9ng m\u1ed9t l\u1ea7n trong c\u00f9ng m\u1ed9t h\u1ec7 th\u1ed1ng x\u00e1c th\u1ef1c\n  CHECK (auth_provider IN ('google', 'local', 'otp'))  -- \ud83d\udee1\ufe0f R\u00e0ng bu\u1ed9c gi\u00e1 tr\u1ecb h\u1ee3p l\u1ec7\n);\n</code></pre>"},{"location":"services/user-service/master/data-model/#giai-thich-cot","title":"\ud83e\udde9 Gi\u1ea3i th\u00edch c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u \u00dd ngh\u0129a <code>user_id</code> UUID Kh\u00f3a ch\u00ednh to\u00e0n c\u1ee5c, d\u00f9ng \u0111\u1ec3 li\u00ean k\u1ebft v\u1edbi t\u1ea5t c\u1ea3 b\u1ea3ng kh\u00e1c <code>full_name</code> TEXT T\u00ean \u0111\u1ea7y \u0111\u1ee7 c\u1ee7a ng\u01b0\u1eddi d\u00f9ng <code>email</code> TEXT Email ng\u01b0\u1eddi d\u00f9ng \u2013 duy nh\u1ea5t trong ph\u1ea1m vi <code>auth_provider</code> <code>phone</code> TEXT S\u1ed1 \u0111i\u1ec7n tho\u1ea1i (t\u00f9y ch\u1ecdn) <code>auth_provider</code> TEXT H\u1ec7 th\u1ed1ng x\u00e1c th\u1ef1c (OAuth2, OTP local...) <code>created_at</code> TIMESTAMPTZ Th\u1eddi \u0111i\u1ec3m t\u1ea1o b\u1ea3n ghi <code>updated_at</code> TIMESTAMPTZ Th\u1eddi \u0111i\u1ec3m c\u1eadp nh\u1eadt cu\u1ed1i c\u00f9ng"},{"location":"services/user-service/master/data-model/#lien-ket-chi-so","title":"\ud83d\udd17 Li\u00ean k\u1ebft &amp; Ch\u1ec9 s\u1ed1","text":"<ul> <li>\u2705 Unique Constraint: <code>(email, auth_provider)</code> gi\u00fap h\u1ed7 tr\u1ee3 nhi\u1ec1u provider nh\u01b0ng v\u1eabn \u0111\u1ea3m b\u1ea3o t\u00ednh duy nh\u1ea5t.</li> <li>\ud83d\udccc Index khuy\u1ebfn ngh\u1ecb: t\u1ea1o th\u00eam index tr\u00ean <code>(auth_provider, email)</code> \u0111\u1ec3 t\u1ed1i \u01b0u tra c\u1ee9u khi \u0111\u0103ng nh\u1eadp.</li> <li>\ud83e\udde9 M\u1ed1i li\u00ean h\u1ec7: <code>user_id</code> \u0111\u01b0\u1ee3c tham chi\u1ebfu b\u1edfi:<ul> <li><code>user_tenant_assignments.user_id_global</code></li> <li><code>audit_log_users_master.actor_id</code> (n\u1ebfu c\u00f3)</li> <li>C\u00e1c b\u1ea3ng Sub User Service: <code>users_in_tenant.user_id_global</code></li> </ul> </li> </ul>"},{"location":"services/user-service/master/data-model/#7-chi-tiet-bang-tenants","title":"7. Chi ti\u1ebft b\u1ea3ng: <code>tenants</code>","text":""},{"location":"services/user-service/master/data-model/#muc-ich_1","title":"\ud83e\uddfe M\u1ee5c \u0111\u00edch","text":"<p>B\u1ea3ng <code>tenants</code> l\u01b0u th\u00f4ng tin nh\u1eadn di\u1ec7n c\u00e1c tenant (tr\u01b0\u1eddng th\u00e0nh vi\u00ean) trong h\u1ec7 th\u1ed1ng. M\u1ed7i tenant t\u01b0\u01a1ng \u1ee9ng v\u1edbi m\u1ed9t tr\u01b0\u1eddng ho\u1eb7c t\u1ed5 ch\u1ee9c ri\u00eang bi\u1ec7t, c\u00f3 h\u1ec7 th\u1ed1ng ph\u1ee5 tr\u1ee3 ri\u00eang (Sub Services).</p>"},{"location":"services/user-service/master/data-model/#cau-lenh-create-table_1","title":"\ud83d\udcdc C\u00e2u l\u1ec7nh <code>CREATE TABLE</code>","text":"<pre><code>CREATE TABLE tenants (\n  tenant_id TEXT PRIMARY KEY,                          -- \ud83d\udd11 M\u00e3 \u0111\u1ecbnh danh duy nh\u1ea5t cho tenant (v\u00ed d\u1ee5: \"va_camau\")\n  tenant_name TEXT NOT NULL,                           -- T\u00ean hi\u1ec3n th\u1ecb c\u1ee7a tenant\n  status TEXT NOT NULL DEFAULT 'active',               -- Tr\u1ea1ng th\u00e1i: active, suspended, deleted...\n  logo_url TEXT,                                       -- Logo \u0111\u1ea1i di\u1ec7n (t\u00f9y ch\u1ecdn)\n  project_id TEXT,                                     -- GCP Project ID g\u1eafn v\u1edbi tenant n\u00e0y (n\u1ebfu c\u00f3)\n  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,\n  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,\n\n  CHECK (status IN ('active', 'suspended', 'deleted')) -- \ud83d\udee1\ufe0f Tr\u1ea1ng th\u00e1i h\u1ee3p l\u1ec7\n);\n</code></pre>"},{"location":"services/user-service/master/data-model/#giai-thich-cot_1","title":"\ud83e\udde9 Gi\u1ea3i th\u00edch c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u \u00dd ngh\u0129a <code>tenant_id</code> TEXT M\u00e3 \u0111\u1ecbnh danh duy nh\u1ea5t cho tenant (vi\u1ebft th\u01b0\u1eddng, snake_case) <code>tenant_name</code> TEXT T\u00ean \u0111\u1ea7y \u0111\u1ee7, th\u00e2n thi\u1ec7n v\u1edbi ng\u01b0\u1eddi d\u00f9ng <code>status</code> TEXT Tr\u1ea1ng th\u00e1i ho\u1ea1t \u0111\u1ed9ng c\u1ee7a tenant (<code>active</code>, <code>suspended</code>, <code>deleted</code>) <code>logo_url</code> TEXT Link logo (n\u1ebfu c\u00f3), d\u00f9ng cho hi\u1ec3n th\u1ecb branding <code>project_id</code> TEXT GCP Project ID n\u1ebfu m\u1ed7i tenant c\u00f3 stack ri\u00eang bi\u1ec7t <code>created_at</code> TIMESTAMPTZ Th\u1eddi \u0111i\u1ec3m t\u1ea1o <code>updated_at</code> TIMESTAMPTZ Th\u1eddi \u0111i\u1ec3m c\u1eadp nh\u1eadt cu\u1ed1i c\u00f9ng"},{"location":"services/user-service/master/data-model/#lien-ket-chi-so_1","title":"\ud83d\udd17 Li\u00ean k\u1ebft &amp; Ch\u1ec9 s\u1ed1","text":"<ul> <li>\ud83d\udccc Tenant ID s\u1ebd \u0111\u01b0\u1ee3c tham chi\u1ebfu b\u1edfi:<ul> <li><code>user_tenant_assignments.tenant_id</code></li> <li>Sub services d\u00f9ng \u0111\u1ec3 \u0111\u1ecbnh tuy\u1ebfn v\u00e0 ph\u00e2n quy\u1ec1n</li> </ul> </li> <li>\u2705 Index khuy\u1ebfn ngh\u1ecb: index tr\u00ean <code>status</code> \u0111\u1ec3 l\u1ecdc nhanh c\u00e1c tenant \u0111ang ho\u1ea1t \u0111\u1ed9ng</li> </ul>"},{"location":"services/user-service/master/data-model/#8-chi-tiet-bang-user_tenant_assignments","title":"8. Chi ti\u1ebft b\u1ea3ng: <code>user_tenant_assignments</code>","text":""},{"location":"services/user-service/master/data-model/#muc-ich_2","title":"\ud83e\uddfe M\u1ee5c \u0111\u00edch","text":"<p>B\u1ea3ng <code>user_tenant_assignments</code> l\u01b0u th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng n\u00e0o \u0111\u01b0\u1ee3c g\u00e1n v\u00e0o tenant n\u00e0o. \u0110\u00e2y l\u00e0 c\u1ea7u n\u1ed1i gi\u1eefa <code>users_global</code> v\u00e0 c\u00e1c tenant, x\u00e1c \u0111\u1ecbnh quy\u1ec1n truy c\u1eadp c\u1ee7a m\u1ed9t ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c v\u00e0o tenant c\u1ee5 th\u1ec3.</p>"},{"location":"services/user-service/master/data-model/#cau-lenh-create-table_2","title":"\ud83d\udcdc C\u00e2u l\u1ec7nh <code>CREATE TABLE</code>","text":"<pre><code>CREATE TABLE user_tenant_assignments (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),       -- \ud83d\udd11 ID duy nh\u1ea5t cho m\u1ed7i l\u1ea7n g\u00e1n\n  user_id_global UUID NOT NULL REFERENCES users_global(user_id), -- \ud83d\udd17 Ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c\n  tenant_id TEXT NOT NULL REFERENCES tenants(tenant_id),         -- \ud83d\udd17 Tenant \u0111\u01b0\u1ee3c g\u00e1n\n  assignment_status TEXT NOT NULL DEFAULT 'active',     -- Tr\u1ea1ng th\u00e1i: active, revoked\n  assigned_at TIMESTAMPTZ DEFAULT now() NOT NULL,       -- \u23f1\ufe0f Th\u1eddi \u0111i\u1ec3m g\u00e1n\n  updated_at TIMESTAMPTZ,                               -- \u23f1\ufe0f Th\u1eddi \u0111i\u1ec3m h\u1ee7y g\u00e1n (n\u1ebfu c\u00f3)\n  assigned_by UUID,                                     -- \ud83d\udd17 Ng\u01b0\u1eddi g\u00e1n (user_id_global) \u2013 th\u01b0\u1eddng l\u00e0 Superadmin\n  UNIQUE (user_id_global, tenant_id),                   -- \ud83d\udee1\ufe0f Kh\u00f4ng th\u1ec3 g\u00e1n tr\u00f9ng ng\u01b0\u1eddi d\u00f9ng v\u00e0o c\u00f9ng tenant\n  CHECK (assignment_status IN ('active', 'revoked'))\n);\n</code></pre>"},{"location":"services/user-service/master/data-model/#giai-thich-cot_2","title":"\ud83e\udde9 Gi\u1ea3i th\u00edch c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u \u00dd ngh\u0129a <code>id</code> UUID ID duy nh\u1ea5t cho b\u1ea3n ghi (d\u00f9ng cho tra c\u1ee9u, c\u1eadp nh\u1eadt tr\u1ea1ng th\u00e1i) <code>user_id_global</code> UUID Ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c \u0111\u01b0\u1ee3c g\u00e1n v\u00e0o tenant n\u00e0y <code>tenant_id</code> TEXT Tenant c\u1ee5 th\u1ec3 <code>assignment_status</code> TEXT Tr\u1ea1ng th\u00e1i hi\u1ec7n t\u1ea1i: active / revoked <code>assigned_at</code> TIMESTAMPTZ Th\u1eddi \u0111i\u1ec3m th\u1ef1c hi\u1ec7n g\u00e1n <code>updated_at</code> TIMESTAMPTZ Th\u1eddi \u0111i\u1ec3m h\u1ee7y quy\u1ec1n truy c\u1eadp (n\u1ebfu c\u00f3) <code>assigned_by</code> UUID ID c\u1ee7a user th\u1ef1c hi\u1ec7n thao t\u00e1c g\u00e1n (th\u01b0\u1eddng l\u00e0 superadmin)"},{"location":"services/user-service/master/data-model/#lien-ket-chi-so_2","title":"\ud83d\udd17 Li\u00ean k\u1ebft &amp; Ch\u1ec9 s\u1ed1","text":"<ul> <li>\ud83d\udd01 D\u00f9ng \u0111\u1ec3 x\u00e1c \u0111\u1ecbnh quy\u1ec1n truy c\u1eadp tenant khi ng\u01b0\u1eddi d\u00f9ng \u0111\u0103ng nh\u1eadp (Auth Service)</li> <li>\ud83e\udde0 Gateway c\u00f3 th\u1ec3 cache <code>user_id_global</code> \u2194 danh s\u00e1ch <code>tenant_id</code> \u0111\u1ec3 t\u1ed1i \u01b0u hi\u1ec7u su\u1ea5t</li> <li>\u2705 C\u1ea7n index tr\u00ean <code>user_id_global</code>, <code>tenant_id</code>, v\u00e0 <code>assignment_status</code> cho tra c\u1ee9u nhanh</li> </ul>"},{"location":"services/user-service/master/data-model/#su-kien-phat-ra","title":"\ud83d\udce4 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li><code>tenant_user_assigned</code>: Khi m\u1ed9t user \u0111\u01b0\u1ee3c g\u00e1n v\u00e0o tenant (assignment m\u1edbi)</li> <li><code>tenant_user_revoked</code>: Khi quy\u1ec1n truy c\u1eadp c\u1ee7a user v\u00e0o tenant b\u1ecb h\u1ee7y (status chuy\u1ec3n sang <code>revoked</code>)</li> </ul>"},{"location":"services/user-service/master/data-model/#9-chi-tiet-bang-global_roles_templates","title":"9. Chi ti\u1ebft b\u1ea3ng: <code>global_roles_templates</code>","text":""},{"location":"services/user-service/master/data-model/#muc-ich_3","title":"\ud83e\uddfe M\u1ee5c \u0111\u00edch","text":"<p>B\u1ea3ng <code>global_roles_templates</code> l\u01b0u tr\u1eef c\u00e1c m\u1eabu vai tr\u00f2 d\u00f9ng chung to\u00e0n h\u1ec7 th\u1ed1ng. C\u00e1c vai tr\u00f2 n\u00e0y \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf b\u1edfi superadmin \u0111\u1ec3 l\u00e0m n\u1ec1n t\u1ea3ng g\u00e1n role m\u1eb7c \u0111\u1ecbnh cho t\u1eebng tenant trong h\u1ec7 th\u1ed1ng multi-tenant. \u0110\u00e2y l\u00e0 ph\u1ea7n c\u1ed1t l\u00f5i c\u1ee7a c\u01a1 ch\u1ebf RBAC ph\u00e2n t\u1ea7ng, gi\u00fap ti\u00eau chu\u1ea9n h\u00f3a qu\u1ea3n l\u00fd quy\u1ec1n truy c\u1eadp theo t\u1eebng lo\u1ea1i ng\u01b0\u1eddi d\u00f9ng (admin, teacher, parent...).</p>"},{"location":"services/user-service/master/data-model/#cau-lenh-create-table_3","title":"\ud83d\udcdc C\u00e2u l\u1ec7nh <code>CREATE TABLE</code>","text":"<pre><code>CREATE TABLE global_roles_templates (\n  role_template_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  template_key TEXT NOT NULL UNIQUE,\n  template_name TEXT NOT NULL,\n  description TEXT,\n  is_system BOOLEAN NOT NULL DEFAULT FALSE,\n  created_by UUID NOT NULL REFERENCES users_global(user_id),\n  updated_by UUID REFERENCES users_global(user_id),\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ\n);\n</code></pre>"},{"location":"services/user-service/master/data-model/#giai-thich-cot_3","title":"\ud83e\udde9 Gi\u1ea3i th\u00edch c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u \u00dd ngh\u0129a <code>role_template_id</code> <code>UUID</code> M\u00e3 \u0111\u1ecbnh danh duy nh\u1ea5t cho template <code>template_key</code> <code>TEXT</code> Kh\u00f3a k\u1ef9 thu\u1eadt duy nh\u1ea5t (e.g., <code>teacher_default</code>, <code>admin_basic</code>) <code>template_name</code> <code>TEXT</code> T\u00ean hi\u1ec3n th\u1ecb c\u1ee7a template <code>description</code> <code>TEXT</code> M\u00f4 t\u1ea3 ch\u1ee9c n\u0103ng c\u1ee7a role n\u00e0y <code>is_system</code> <code>BOOLEAN</code> \u0110\u00e1nh d\u1ea5u vai tr\u00f2 h\u1ec7 th\u1ed1ng (kh\u00f4ng cho x\u00f3a) <code>created_by</code> <code>UUID</code> ID ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c t\u1ea1o template (superadmin) <code>updated_by</code> <code>UUID</code> ID ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c c\u1eadp nh\u1eadt g\u1ea7n nh\u1ea5t <code>created_at</code> <code>TIMESTAMPTZ</code> Th\u1eddi \u0111i\u1ec3m t\u1ea1o template <code>updated_at</code> <code>TIMESTAMPTZ</code> Th\u1eddi \u0111i\u1ec3m c\u1eadp nh\u1eadt g\u1ea7n nh\u1ea5t"},{"location":"services/user-service/master/data-model/#lien-ket-su-dung","title":"\ud83d\udd17 Li\u00ean k\u1ebft &amp; S\u1eed d\u1ee5ng","text":"<ul> <li>Li\u00ean k\u1ebft 1-n v\u1edbi: <code>global_permissions_templates</code> th\u00f4ng qua b\u1ea3ng ph\u1ee5 <code>global_role_permissions_templates</code></li> <li> <p>\u0110\u01b0\u1ee3c d\u00f9ng khi:</p> </li> <li> <p>Giao di\u1ec7n qu\u1ea3n tr\u1ecb t\u1ea1o ho\u1eb7c s\u1eeda m\u1eabu role</p> </li> <li>G\u00e1n vai tr\u00f2 m\u1eb7c \u0111\u1ecbnh khi kh\u1edfi t\u1ea1o tenant m\u1edbi</li> <li>\u0110\u1ed3ng b\u1ed9 RBAC t\u1eeb master \u2192 sub</li> </ul>"},{"location":"services/user-service/master/data-model/#su-kien-phat-ra_1","title":"\ud83d\udce4 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li><code>role_template.created</code>: Khi superadmin t\u1ea1o m\u1eabu vai tr\u00f2 m\u1edbi</li> <li><code>role_template.updated</code>: Khi c\u1eadp nh\u1eadt n\u1ed9i dung role ho\u1eb7c quy\u1ec1n li\u00ean quan</li> <li>C\u00e1c s\u1ef1 ki\u1ec7n n\u00e0y \u0111\u01b0\u1ee3c ph\u00e1t qua Pub/Sub \u0111\u1ec3 \u0111\u1ed3ng b\u1ed9 xu\u1ed1ng <code>user-service/sub</code> theo t\u1eebng tenant n\u1ebfu c\u00f3 y\u00eau c\u1ea7u \u00e1p d\u1ee5ng m\u1eabu.</li> </ul>"},{"location":"services/user-service/master/data-model/#10-chi-tiet-bang-global_permissions_templates","title":"10. Chi ti\u1ebft b\u1ea3ng: <code>global_permissions_templates</code>","text":""},{"location":"services/user-service/master/data-model/#muc-ich_4","title":"\ud83e\uddfe M\u1ee5c \u0111\u00edch","text":"<p>B\u1ea3ng <code>global_permissions_templates</code> \u0111\u1ecbnh ngh\u0129a t\u1eadp c\u00e1c quy\u1ec1n (permission) d\u00f9ng chung tr\u00ean to\u00e0n h\u1ec7 th\u1ed1ng, \u0111\u00f3ng vai tr\u00f2 l\u00e0 m\u1eabu n\u1ec1n t\u1ea3ng cho c\u01a1 ch\u1ebf RBAC ph\u00e2n t\u1ea7ng. C\u00e1c quy\u1ec1n n\u00e0y s\u1ebd \u0111\u01b0\u1ee3c li\u00ean k\u1ebft v\u1edbi <code>global_roles_templates</code> \u0111\u1ec3 t\u1ea1o th\u00e0nh c\u1ea5u tr\u00fac role-permission m\u1eb7c \u0111\u1ecbnh cho m\u1ed7i tenant. Ch\u00fang \u0111\u1ea3m b\u1ea3o s\u1ef1 th\u1ed1ng nh\u1ea5t, an to\u00e0n v\u00e0 d\u1ec5 m\u1edf r\u1ed9ng trong qu\u1ea3n l\u00fd ph\u00e2n quy\u1ec1n h\u1ec7 th\u1ed1ng.</p>"},{"location":"services/user-service/master/data-model/#cau-lenh-create-table_4","title":"\ud83d\udcdc C\u00e2u l\u1ec7nh <code>CREATE TABLE</code>","text":"<pre><code>CREATE TABLE global_permissions_templates (\n  permission_template_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  permission_key TEXT NOT NULL UNIQUE,\n  permission_name TEXT NOT NULL,\n  description TEXT,\n  service_scope TEXT NOT NULL,\n  created_by UUID NOT NULL REFERENCES users_global(user_id),\n  updated_by UUID REFERENCES users_global(user_id),\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ\n);\n</code></pre>"},{"location":"services/user-service/master/data-model/#giai-thich-cot_4","title":"\ud83e\udde9 Gi\u1ea3i th\u00edch c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u \u00dd ngh\u0129a <code>permission_template_id</code> <code>UUID</code> M\u00e3 \u0111\u1ecbnh danh c\u1ee7a m\u1eabu quy\u1ec1n <code>permission_key</code> <code>TEXT</code> Kh\u00f3a k\u1ef9 thu\u1eadt, \u0111\u1ecbnh danh duy nh\u1ea5t (e.g., <code>user.read:any</code>, <code>tenant.update</code>) <code>permission_name</code> <code>TEXT</code> T\u00ean hi\u1ec3n th\u1ecb th\u00e2n thi\u1ec7n c\u1ee7a quy\u1ec1n <code>description</code> <code>TEXT</code> M\u00f4 t\u1ea3 ch\u1ee9c n\u0103ng quy\u1ec1n <code>service_scope</code> <code>TEXT</code> T\u00ean service li\u00ean quan (e.g., <code>user-service</code>, <code>tenant-service</code>) <code>created_by</code> <code>UUID</code> ID ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c t\u1ea1o quy\u1ec1n <code>updated_by</code> <code>UUID</code> ID ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c c\u1eadp nh\u1eadt g\u1ea7n nh\u1ea5t <code>created_at</code> <code>TIMESTAMPTZ</code> Th\u1eddi \u0111i\u1ec3m t\u1ea1o m\u1eabu quy\u1ec1n <code>updated_at</code> <code>TIMESTAMPTZ</code> Th\u1eddi \u0111i\u1ec3m c\u1eadp nh\u1eadt g\u1ea7n nh\u1ea5t"},{"location":"services/user-service/master/data-model/#lien-ket-su-dung_1","title":"\ud83d\udd17 Li\u00ean k\u1ebft &amp; S\u1eed d\u1ee5ng","text":"<ul> <li>Li\u00ean k\u1ebft 1-n v\u1edbi: <code>global_roles_templates</code> qua b\u1ea3ng trung gian <code>global_role_permissions_templates</code></li> <li> <p>\u0110\u01b0\u1ee3c s\u1eed d\u1ee5ng khi:</p> </li> <li> <p>Kh\u1edfi t\u1ea1o h\u1ec7 th\u1ed1ng ph\u00e2n quy\u1ec1n tenant m\u1edbi</p> </li> <li>Hi\u1ec3n th\u1ecb danh s\u00e1ch quy\u1ec1n cho UI qu\u1ea3n tr\u1ecb h\u1ec7 th\u1ed1ng</li> <li>Ph\u00e2n quy\u1ec1n m\u1eb7c \u0111\u1ecbnh trong c\u00e1c service s\u1eed d\u1ee5ng RBAC (Auth, User, Token\u2026)</li> </ul>"},{"location":"services/user-service/master/data-model/#su-kien-phat-ra_2","title":"\ud83d\udce4 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li><code>permission_template.created</code>: Khi superadmin t\u1ea1o quy\u1ec1n m\u1edbi</li> <li><code>permission_template.updated</code>: Khi c\u1eadp nh\u1eadt m\u00f4 t\u1ea3 ho\u1eb7c ph\u1ea1m vi quy\u1ec1n</li> <li>C\u00e1c s\u1ef1 ki\u1ec7n n\u00e0y \u0111\u01b0\u1ee3c publish qua Pub/Sub \u0111\u1ec3 ph\u1ee5c v\u1ee5 audit logging v\u00e0/ho\u1eb7c \u0111\u1ed3ng b\u1ed9 \u0111\u1ecbnh ngh\u0129a quy\u1ec1n t\u1edbi c\u00e1c h\u1ec7 th\u1ed1ng ph\u1ee5 tr\u1ee3 n\u1ebfu c\u1ea7n.</li> </ul>"},{"location":"services/user-service/master/data-model/#11-chi-tiet-bang-global_role_permissions_templates","title":"11. Chi ti\u1ebft b\u1ea3ng: <code>global_role_permissions_templates</code>","text":""},{"location":"services/user-service/master/data-model/#muc-ich_5","title":"\ud83e\uddfe M\u1ee5c \u0111\u00edch","text":"<p>B\u1ea3ng <code>global_role_permissions_templates</code> \u0111\u1ecbnh ngh\u0129a quan h\u1ec7 nhi\u1ec1u-nhi\u1ec1u gi\u1eefa c\u00e1c vai tr\u00f2 m\u1eabu (<code>global_roles_templates</code>) v\u00e0 c\u00e1c quy\u1ec1n m\u1eabu (<code>global_permissions_templates</code>). \u0110\u00e2y l\u00e0 b\u1ea3ng trung gian quan tr\u1ecdng gi\u00fap \u00e1nh x\u1ea1 c\u1ea5u tr\u00fac ph\u00e2n quy\u1ec1n m\u1eb7c \u0111\u1ecbnh cho t\u1eebng lo\u1ea1i ng\u01b0\u1eddi d\u00f9ng, \u0111\u00f3ng vai tr\u00f2 l\u00e0m n\u1ec1n cho qu\u00e1 tr\u00ecnh kh\u1edfi t\u1ea1o RBAC cho t\u1eebng tenant m\u1edbi trong h\u1ec7 th\u1ed1ng multi-tenant.</p>"},{"location":"services/user-service/master/data-model/#cau-lenh-create-table_5","title":"\ud83d\udcdc C\u00e2u l\u1ec7nh <code>CREATE TABLE</code>","text":"<pre><code>CREATE TABLE global_role_permissions_templates (\n  role_template_id UUID NOT NULL REFERENCES global_roles_templates(role_template_id) ON DELETE CASCADE,\n  permission_template_id UUID NOT NULL REFERENCES global_permissions_templates(permission_template_id) ON DELETE CASCADE,\n  PRIMARY KEY (role_template_id, permission_template_id)\n);\n</code></pre>"},{"location":"services/user-service/master/data-model/#giai-thich-cot_5","title":"\ud83e\udde9 Gi\u1ea3i th\u00edch c\u1ed9t","text":"C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u \u00dd ngh\u0129a <code>role_template_id</code> <code>UUID</code> Kh\u00f3a ngo\u1ea1i \u0111\u1ebfn b\u1ea3ng m\u1eabu vai tr\u00f2 <code>permission_template_id</code> <code>UUID</code> Kh\u00f3a ngo\u1ea1i \u0111\u1ebfn b\u1ea3ng m\u1eabu quy\u1ec1n PRIMARY KEY <code>(role_template_id, permission_template_id)</code> \u0110\u1ea3m b\u1ea3o duy nh\u1ea5t m\u1ed7i c\u1eb7p role-permission <ul> <li><code>ON DELETE CASCADE</code> \u0111\u1ea3m b\u1ea3o n\u1ebfu role ho\u1eb7c permission b\u1ecb x\u00f3a, c\u00e1c \u00e1nh x\u1ea1 li\u00ean quan c\u0169ng b\u1ecb x\u00f3a theo \u2192 tr\u00e1nh orphan records.</li> </ul>"},{"location":"services/user-service/master/data-model/#lien-ket-su-dung_2","title":"\ud83d\udd17 Li\u00ean k\u1ebft &amp; S\u1eed d\u1ee5ng","text":"<ul> <li> <p>Li\u00ean k\u1ebft 1-n t\u1eeb:</p> </li> <li> <p><code>global_roles_templates.role_template_id</code></p> </li> <li> <p><code>global_permissions_templates.permission_template_id</code></p> </li> <li> <p>\u0110\u01b0\u1ee3c s\u1eed d\u1ee5ng khi:</p> </li> <li> <p>T\u1ea1o m\u1edbi ho\u1eb7c ch\u1ec9nh s\u1eeda m\u1eabu vai tr\u00f2 trong UI qu\u1ea3n tr\u1ecb h\u1ec7 th\u1ed1ng</p> </li> <li>Kh\u1edfi t\u1ea1o d\u1eef li\u1ec7u RBAC m\u1eb7c \u0111\u1ecbnh cho tenant m\u1edbi (ph\u00e2n ph\u1ed1i role \u2192 permission)</li> <li>\u0110\u1ed3ng b\u1ed9 d\u1eef li\u1ec7u RBAC t\u1eeb master \u2192 sub khi c\u00f3 c\u1eadp nh\u1eadt quy\u1ec1n h\u1ec7 th\u1ed1ng</li> </ul>"},{"location":"services/user-service/master/data-model/#su-kien-phat-ra_3","title":"\ud83d\udce4 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li>Kh\u00f4ng ph\u00e1t sinh s\u1ef1 ki\u1ec7n ri\u00eang t\u1eeb b\u1ea3ng n\u00e0y.</li> <li>Tuy nhi\u00ean, khi c\u1eadp nh\u1eadt mapping n\u00e0y (th\u00eam/x\u00f3a permission trong role), c\u00e1c service c\u1ea7n ph\u00e1t <code>role_template.updated</code> t\u1eeb logic nghi\u1ec7p v\u1ee5 \u1edf t\u1ea7ng \u1ee9ng d\u1ee5ng.</li> </ul>"},{"location":"services/user-service/master/data-model/#12-cac-bang-phu-tro-phu-luc","title":"12. C\u00e1c b\u1ea3ng ph\u1ee5 tr\u1ee3 &amp; ph\u1ee5 l\u1ee5c","text":""},{"location":"services/user-service/master/data-model/#bang-processed_events","title":"\ud83d\udd04 B\u1ea3ng: <code>processed_events</code>","text":""},{"location":"services/user-service/master/data-model/#muc-ich_6","title":"\ud83d\udccc M\u1ee5c \u0111\u00edch","text":"<p>Ghi l\u1ea1i c\u00e1c s\u1ef1 ki\u1ec7n \u0111\u00e3 x\u1eed l\u00fd \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o t\u00ednh idempotent trong h\u1ec7 th\u1ed1ng Event-Driven (v\u00ed d\u1ee5: khi nh\u1eadn l\u1ea1i c\u00f9ng m\u1ed9t s\u1ef1 ki\u1ec7n t\u1eeb Pub/Sub).</p> <pre><code>CREATE TABLE processed_events (\n  event_id UUID PRIMARY KEY,              -- \ud83d\udd11 ID duy nh\u1ea5t c\u1ee7a s\u1ef1 ki\u1ec7n\n  service_name TEXT NOT NULL,             -- \ud83e\udded T\u00ean service x\u1eed l\u00fd s\u1ef1 ki\u1ec7n\n  processed_at TIMESTAMPTZ DEFAULT now()  -- \u23f1\ufe0f Th\u1eddi \u0111i\u1ec3m x\u1eed l\u00fd\n);\n</code></pre>"},{"location":"services/user-service/master/data-model/#giai-thich","title":"\ud83d\udccb Gi\u1ea3i th\u00edch","text":"C\u1ed9t Ki\u1ec3u d\u1eef li\u1ec7u \u00dd ngh\u0129a <code>event_id</code> UUID ID s\u1ef1 ki\u1ec7n (th\u01b0\u1eddng \u0111\u1ebfn t\u1eeb metadata c\u1ee7a Pub/Sub) <code>service_name</code> TEXT T\u00ean service \u0111\u00e3 x\u1eed l\u00fd s\u1ef1 ki\u1ec7n n\u00e0y <code>processed_at</code> TIMESTAMPTZ Th\u1eddi \u0111i\u1ec3m x\u1eed l\u00fd"},{"location":"services/user-service/master/data-model/#phu-luc-a-cac-index-quan-trong","title":"\ud83d\udcd8 Ph\u1ee5 l\u1ee5c A \u2013 C\u00e1c Index quan tr\u1ecdng","text":"B\u1ea3ng C\u1ed9t Lo\u1ea1i Index <code>users_global</code> <code>(email, auth_provider)</code> UNIQUE INDEX <code>user_tenant_assignments</code> <code>(user_id_global, tenant_id)</code> UNIQUE INDEX <code>tenants</code> <code>tenant_id</code> PRIMARY KEY <code>global_roles_templates</code> <code>template_code</code> UNIQUE INDEX <code>global_permissions_templates</code> <code>permission_code</code> UNIQUE INDEX"},{"location":"services/user-service/master/data-model/#phu-luc-b-rang-buoc-ac-biet","title":"\ud83d\udcd8 Ph\u1ee5 l\u1ee5c B \u2013 R\u00e0ng bu\u1ed9c \u0111\u1eb7c bi\u1ec7t","text":"<ul> <li><code>users_global.email</code> ch\u1ec9 l\u00e0 UNIQUE trong ph\u1ea1m vi <code>auth_provider</code> (n\u1ebfu mu\u1ed1n h\u1ed7 tr\u1ee3 nhi\u1ec1u provider).</li> <li><code>user_tenant_assignments</code> c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c m\u1edf r\u1ed9ng \u0111\u1ec3 l\u01b0u c\u1ea3 tr\u1ea1ng th\u00e1i <code>invited</code>, <code>active</code>, <code>revoked</code>.</li> </ul>"},{"location":"services/user-service/master/data-model/#phu-luc-c-cac-su-kien-phat-ra-tu-user-service-master","title":"\ud83d\udcd8 Ph\u1ee5 l\u1ee5c C \u2013 C\u00e1c s\u1ef1 ki\u1ec7n ph\u00e1t ra t\u1eeb User Service Master","text":"S\u1ef1 ki\u1ec7n Trigger M\u1ee5c \u0111\u00edch <code>user_global_created</code> Khi t\u1ea1o user m\u1edbi Cho ph\u00e9p c\u00e1c service kh\u00e1c kh\u1edfi t\u1ea1o li\u00ean k\u1ebft <code>tenant_created</code> Khi t\u1ea1o tenant Cho ph\u00e9p Sub Service t\u1ea1o m\u00f4i tr\u01b0\u1eddng d\u1eef li\u1ec7u <code>tenant_user_assigned</code> Khi g\u00e1n user v\u00e0o tenant \u0110\u1ed3ng b\u1ed9 RBAC v\u00e0 t\u1ea1o user c\u1ee5c b\u1ed9 \u1edf Sub Service <code>rbac_template_updated</code> Khi c\u1eadp nh\u1eadt role/permission templates Th\u00f4ng b\u00e1o Sub Service c\u1eadp nh\u1eadt c\u1ea5u h\u00ecnh RBAC"},{"location":"services/user-service/master/data-model/#phu-luc-d-enum-va-gia-tri-ac-biet","title":"\ud83d\udcd8 Ph\u1ee5 l\u1ee5c D \u2013 Enum v\u00e0 gi\u00e1 tr\u1ecb \u0111\u1eb7c bi\u1ec7t","text":"<ul> <li><code>auth_provider</code>:</li> <li><code>google</code></li> <li><code>local</code></li> <li><code>otp</code></li> <li><code>user_tenant_assignments.status</code> (n\u1ebfu c\u00f3 m\u1edf r\u1ed9ng):</li> <li><code>active</code></li> <li><code>revoked</code></li> <li><code>invited</code></li> </ul>"},{"location":"services/user-service/master/data-model/#phu-luc-e-chien-luoc-kiem-thu-lien-quan-en-mo-hinh-du-lieu","title":"\ud83d\udcd8 Ph\u1ee5 l\u1ee5c E \u2013 Chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed li\u00ean quan \u0111\u1ebfn m\u00f4 h\u00ecnh d\u1eef li\u1ec7u","text":""},{"location":"services/user-service/master/data-model/#1-kiem-thu-muc-co-so-du-lieu-database-level","title":"\ud83d\udd0d 1. Ki\u1ec3m th\u1eed m\u1ee9c c\u01a1 s\u1edf d\u1eef li\u1ec7u (Database-level)","text":"Lo\u1ea1i ki\u1ec3m th\u1eed M\u00f4 t\u1ea3 \u2705 R\u00e0ng bu\u1ed9c PK/FK \u0110\u1ea3m b\u1ea3o kh\u00f4ng th\u1ec3 insert/update d\u1eef li\u1ec7u sai li\u00ean k\u1ebft gi\u1eefa c\u00e1c b\u1ea3ng \u2705 R\u00e0ng bu\u1ed9c UNIQUE Ki\u1ec3m th\u1eed c\u00e1c c\u1ed9t <code>email</code>, <code>template_code</code>, <code>permission_code</code> kh\u00f4ng b\u1ecb tr\u00f9ng \u2705 Enum/Constraint logic Ki\u1ec3m th\u1eed gi\u00e1 tr\u1ecb h\u1ee3p l\u1ec7 c\u1ee7a <code>auth_provider</code>, <code>status</code>, v.v. \u2705 Trigger (n\u1ebfu c\u00f3) N\u1ebfu s\u1eed d\u1ee5ng trigger (v\u00ed d\u1ee5: audit log, cascading update), c\u1ea7n test k\u1ef9"},{"location":"services/user-service/master/data-model/#2-kiem-thu-tinh-toan-ven-du-lieu-xuyen-suot-integration-data-consistency","title":"\ud83d\udd04 2. Ki\u1ec3m th\u1eed t\u00ednh to\u00e0n v\u1eb9n d\u1eef li\u1ec7u xuy\u00ean su\u1ed1t (Integration Data Consistency)","text":"T\u00ecnh hu\u1ed1ng ki\u1ec3m th\u1eed Mong \u0111\u1ee3i T\u1ea1o user m\u1edbi \u2192 G\u00e1n v\u00e0o tenant Ghi \u0111\u00fang <code>users_global</code>, <code>user_tenant_assignments</code>, ph\u00e1t \u0111\u00fang event C\u1eadp nh\u1eadt template RBAC Ghi \u0111\u00fang b\u1ea3ng template, ph\u00e1t s\u1ef1 ki\u1ec7n <code>rbac_template_updated</code> G\u1ee1 user kh\u1ecfi tenant Kh\u00f4ng c\u00f2n entry trong <code>user_tenant_assignments</code>, ph\u00e1t s\u1ef1 ki\u1ec7n n\u1ebfu c\u1ea7n X\u1eed l\u00fd l\u1ea1i event tr\u00f9ng (<code>processed_events</code>) Event kh\u00f4ng b\u1ecb x\u1eed l\u00fd l\u1ea1i nhi\u1ec1u l\u1ea7n"},{"location":"services/user-service/master/data-model/#3-kiem-thu-voi-du-lieu-mau","title":"\u2699\ufe0f 3. Ki\u1ec3m th\u1eed v\u1edbi d\u1eef li\u1ec7u m\u1eabu","text":"T\u00ean t\u1eadp d\u1eef li\u1ec7u M\u00f4 t\u1ea3 <code>test_user_1.json</code> M\u1ed9t user Google, \u0111\u00e3 g\u00e1n v\u00e0o 2 tenants <code>test_templates.yaml</code> Role template v\u1edbi nhi\u1ec1u permission c\u00f3 <code>default_condition</code> ph\u1ee9c t\u1ea1p <code>test_event.json</code> S\u1ef1 ki\u1ec7n gi\u1ea3 l\u1eadp <code>tenant_user_assigned</code> \u0111\u1ec3 test idempotency"},{"location":"services/user-service/master/data-model/#4-kiem-thu-bao-mat-du-lieu-security-focused-db-tests","title":"\ud83d\udee1\ufe0f 4. Ki\u1ec3m th\u1eed b\u1ea3o m\u1eadt d\u1eef li\u1ec7u (Security-focused DB tests)","text":"Lo\u1ea1i ki\u1ec3m th\u1eed M\u00f4 t\u1ea3 Truy c\u1eadp tr\u00e1i ph\u00e9p d\u1eef li\u1ec7u tenant kh\u00e1c \u0110\u1ea3m b\u1ea3o query lu\u00f4n c\u00f3 \u0111i\u1ec1u ki\u1ec7n <code>tenant_id</code>, kh\u00f4ng r\u00f2 r\u1ec9 d\u1eef li\u1ec7u SQL Injection / Escaping Ki\u1ec3m th\u1eed c\u00e1c c\u1ed9t d\u1ea1ng TEXT \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o escaping \u0111\u00fang (qua ORM)"},{"location":"services/user-service/master/data-model/#5-goi-y-cong-cu-ho-tro","title":"\ud83d\udcc2 5. G\u1ee3i \u00fd c\u00f4ng c\u1ee5 h\u1ed7 tr\u1ee3","text":"<ul> <li>Migration Tool: Alembic / Prisma / Liquibase (tu\u1ef3 stack)</li> <li>DB Unit Testing: pgTAP (PostgreSQL), DBUnit (Java), pytest-postgresql</li> <li>Event Testing: Mock Pub/Sub + Log capture</li> </ul>"},{"location":"services/user-service/master/data-model/#tham-chieu-cheo","title":"\ud83d\udcd8 Tham chi\u1ebfu ch\u00e9o","text":"<ul> <li>Thi\u1ebft k\u1ebf t\u1ed5ng quan (<code>design.md</code>) \u2013 ph\u1ea7n \"Chi\u1ebfn l\u01b0\u1ee3c Test\"</li> <li>OpenAPI (<code>openapi.yaml</code>) \u2013 \u0111\u1ec3 mock endpoint ki\u1ec3m th\u1eed d\u1eef li\u1ec7u</li> <li>Audit Strategy (<code>adr-008-audit-logging.md</code>)</li> </ul>"},{"location":"services/user-service/master/data-model/#phu-luc-f-lien-ket-tai-lieu","title":"\ud83d\udcd8 Ph\u1ee5 l\u1ee5c F \u2013 Li\u00ean k\u1ebft t\u00e0i li\u1ec7u","text":"<ul> <li>Interface Contract</li> <li>OpenAPI Spec</li> <li>Design</li> <li>RBAC Deep Dive</li> </ul>"},{"location":"services/user-service/master/design/","title":"\ud83d\udcd8 User Service Master \u2013 Service Design Document","text":""},{"location":"services/user-service/master/design/#1-muc-ich-scope","title":"1. M\u1ee5c \u0111\u00edch (Scope)","text":"<p>User Service Master ch\u1ecbu tr\u00e1ch nhi\u1ec7m qu\u1ea3n l\u00fd \u0111\u1ecbnh danh ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c (<code>users_global</code>), danh s\u00e1ch tenant (<code>tenants</code>) v\u00e0 vi\u1ec7c g\u00e1n ng\u01b0\u1eddi d\u00f9ng v\u00e0o tenant c\u1ee5 th\u1ec3 (<code>user_tenant_assignments</code>). Ngo\u00e0i ra, service n\u00e0y c\u0169ng cung c\u1ea5p c\u00e1c template RBAC to\u00e0n c\u1ee5c (<code>global_roles_templates</code>, <code>global_permissions_templates</code>) \u0111\u1ec3 c\u00e1c Sub User Service c\u00f3 th\u1ec3 \u0111\u1ed3ng b\u1ed9 v\u00e0 kh\u1edfi t\u1ea1o RBAC c\u1ee5c b\u1ed9 cho t\u1eebng tenant.</p> <p>Service n\u00e0y l\u00e0 n\u1ec1n t\u1ea3ng c\u1ed1t l\u00f5i cho to\u00e0n b\u1ed9 h\u1ec7 th\u1ed1ng ph\u00e2n quy\u1ec1n \u0111a tenant, \u0111\u1ea3m b\u1ea3o t\u00ednh nh\u1ea5t qu\u00e1n trong qu\u1ea3n l\u00fd ng\u01b0\u1eddi d\u00f9ng v\u00e0 h\u1ed7 tr\u1ee3 c\u00e1c lu\u1ed3ng x\u00e1c th\u1ef1c t\u1eeb Auth Master/Sub.</p>"},{"location":"services/user-service/master/design/#khong-chiu-trach-nhiem-out-of-scope","title":"\ud83d\udeab Kh\u00f4ng ch\u1ecbu tr\u00e1ch nhi\u1ec7m (Out of Scope)","text":"<p>User Service Master kh\u00f4ng ch\u1ecbu tr\u00e1ch nhi\u1ec7m \u0111\u1ed1i v\u1edbi c\u00e1c ch\u1ee9c n\u0103ng sau:</p> <ul> <li>\u274c Qu\u1ea3n l\u00fd RBAC chi ti\u1ebft \u1edf c\u1ea5p tenant (bao g\u1ed3m roles, permissions, v\u00e0 user-role mapping c\u1ee5c b\u1ed9) \u2013 \u0111\u00e2y l\u00e0 tr\u00e1ch nhi\u1ec7m c\u1ee7a Sub User Service t\u01b0\u01a1ng \u1ee9ng.</li> <li>\u274c Th\u1ef1c hi\u1ec7n x\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng (Google OAuth2, OTP, Local login) \u2013 do Auth Service Master/Sub x\u1eed l\u00fd.</li> <li>\u274c L\u01b0u tr\u1eef ho\u1eb7c x\u1eed l\u00fd c\u00e1c d\u1eef li\u1ec7u nghi\u1ec7p v\u1ee5 chi ti\u1ebft c\u1ee7a t\u1eebng tenant (v\u00ed d\u1ee5: h\u1ecdc sinh, gi\u00e1o vi\u00ean, l\u1edbp h\u1ecdc, h\u1ecdc ph\u00ed...) \u2013 c\u00e1c adapter CRM/SIS/LMS \u0111\u1ea3m nhi\u1ec7m ph\u1ea7n n\u00e0y.</li> <li>\u274c Cung c\u1ea5p c\u00e1c giao di\u1ec7n frontend \u2013 v\u00ed d\u1ee5 Superadmin Webapp ch\u1ec9 g\u1ecdi API t\u1eeb Gateway, ch\u1ee9 kh\u00f4ng truy c\u1eadp tr\u1ef1c ti\u1ebfp v\u00e0o service n\u00e0y.</li> </ul>"},{"location":"services/user-service/master/design/#2-trach-nhiem-chinh-responsibilities","title":"2. Tr\u00e1ch nhi\u1ec7m ch\u00ednh (Responsibilities)","text":"<ul> <li>Qu\u1ea3n l\u00fd b\u1ea3ng \u0111\u1ecbnh danh ng\u01b0\u1eddi d\u00f9ng to\u00e0n h\u1ec7 th\u1ed1ng (<code>users_global</code>)</li> <li>Cho ph\u00e9p t\u1ea1o, c\u1eadp nh\u1eadt, tra c\u1ee9u th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c</li> <li>Qu\u1ea3n l\u00fd danh s\u00e1ch tenant \u0111ang ho\u1ea1t \u0111\u1ed9ng v\u00e0 tr\u1ea1ng th\u00e1i</li> <li>G\u00e1n quy\u1ec1n ng\u01b0\u1eddi d\u00f9ng v\u00e0o c\u00e1c tenant c\u1ee5 th\u1ec3 (<code>user_tenant_assignments</code>)</li> <li>Cung c\u1ea5p b\u1ed9 template <code>roles</code> v\u00e0 <code>permissions</code> d\u00f9ng \u0111\u1ec3 seed xu\u1ed1ng c\u00e1c tenant</li> <li>Ph\u00e1t s\u1ef1 ki\u1ec7n <code>user_created</code>, <code>tenant_user_assigned</code>, <code>rbac_template_updated</code> ph\u1ee5c v\u1ee5 Sub Services</li> </ul>"},{"location":"services/user-service/master/design/#3-luong-nghiep-vu-chinh-business-flows","title":"3. Lu\u1ed3ng nghi\u1ec7p v\u1ee5 ch\u00ednh (Business Flows)","text":""},{"location":"services/user-service/master/design/#ang-nhap-google-oauth2-qua-auth-master","title":"\ud83d\udd39 \u0110\u0103ng nh\u1eadp Google OAuth2 (qua Auth Master)","text":"<ol> <li>Auth Master x\u00e1c th\u1ef1c th\u00e0nh c\u00f4ng user Google \u2192 g\u1ecdi <code>GET /users-global/by-email</code></li> <li>N\u1ebfu ch\u01b0a t\u1ed3n t\u1ea1i \u2192 g\u1ecdi <code>POST /users-global</code> \u0111\u1ec3 t\u1ea1o m\u1edbi</li> <li>G\u1ecdi <code>GET /user-tenant-assignments?user_id=...</code> \u0111\u1ec3 l\u1ea5y danh s\u00e1ch tenant ng\u01b0\u1eddi d\u00f9ng thu\u1ed9c v\u1ec1</li> <li>Ng\u01b0\u1eddi d\u00f9ng ch\u1ecdn tenant \u2192 chuy\u1ec3n qua lu\u1ed3ng Auth ti\u1ebfp theo</li> </ol>"},{"location":"services/user-service/master/design/#gan-nguoi-dung-vao-tenant","title":"\ud83d\udd39 G\u00e1n ng\u01b0\u1eddi d\u00f9ng v\u00e0o tenant","text":"<ul> <li>Admin h\u1ec7 th\u1ed1ng (qua Superadmin Webapp) c\u00f3 th\u1ec3 g\u00e1n ng\u01b0\u1eddi d\u00f9ng v\u00e0o 1 ho\u1eb7c nhi\u1ec1u tenant</li> <li>G\u1ecdi <code>POST /user-tenant-assignments</code></li> <li>Ph\u00e1t s\u1ef1 ki\u1ec7n <code>tenant_user_assigned</code> \u0111\u1ec3 Sub User Service t\u1ea1o b\u1ea3n ghi c\u1ee5c b\u1ed9</li> </ul>"},{"location":"services/user-service/master/design/#luong-1-superadmin-gan-nguoi-dung-vao-tenant","title":"\ud83d\udd04 Lu\u1ed3ng 1: Superadmin g\u00e1n ng\u01b0\u1eddi d\u00f9ng v\u00e0o tenant","text":"<pre><code>sequenceDiagram\n    participant FE as Superadmin Webapp\n    participant GW as API Gateway\n    participant USM as User Service Master\n    participant DB as PostgreSQL (users_global + user_tenant_assignments)\n    participant PUB as Google Pub/Sub\n\n    FE-&gt;&gt;GW: POST /user-tenant-assignments\n    GW-&gt;&gt;USM: POST /user-tenant-assignments\n    USM-&gt;&gt;DB: Ghi user_id, tenant_id, role_codes v\u00e0o b\u1ea3ng user_tenant_assignments\n    USM--&gt;&gt;PUB: Ph\u00e1t s\u1ef1 ki\u1ec7n tenant_user_assigned (ch\u1ee9a user_id, tenant_id, role_codes)\n    USM--&gt;&gt;GW: 200 OK (status: success)\n    GW--&gt;&gt;FE: Hi\u1ec3n th\u1ecb k\u1ebft qu\u1ea3 g\u00e1n th\u00e0nh c\u00f4ng\n</code></pre> <p>\ud83d\udcdd Gi\u1ea3i th\u00edch chi ti\u1ebft:</p> <ol> <li>Superadmin g\u1eedi y\u00eau c\u1ea7u g\u00e1n ng\u01b0\u1eddi d\u00f9ng (<code>user_id</code>) v\u00e0o m\u1ed9t <code>tenant_id</code>, k\u00e8m danh s\u00e1ch <code>role_codes</code>.</li> <li>API Gateway \u0111\u1ecbnh tuy\u1ebfn request t\u1edbi User Service Master.</li> <li>User Service Master ghi th\u00f4ng tin v\u00e0o b\u1ea3ng <code>user_tenant_assignments</code>.</li> <li>Sau khi ghi th\u00e0nh c\u00f4ng, service ph\u00e1t m\u1ed9t s\u1ef1 ki\u1ec7n <code>tenant_user_assigned</code> l\u00ean Pub/Sub, gi\u00fap Sub User Service c\u1ee7a tenant t\u01b0\u01a1ng \u1ee9ng c\u00f3 th\u1ec3 \u0111\u1ed3ng b\u1ed9 RBAC.</li> <li>K\u1ebft qu\u1ea3 tr\u1ea3 v\u1ec1 cho frontend x\u00e1c nh\u1eadn h\u00e0nh \u0111\u1ed9ng \u0111\u00e3 th\u00e0nh c\u00f4ng.</li> </ol> <p>\ud83d\udd01 Tr\u01b0\u1eddng h\u1ee3p l\u1ed7i ti\u1ec1m \u1ea9n:</p> <ul> <li><code>user_id</code> kh\u00f4ng t\u1ed3n t\u1ea1i trong <code>users_global</code> \u2192 404.</li> <li><code>tenant_id</code> kh\u00f4ng h\u1ee3p l\u1ec7 ho\u1eb7c kh\u00f4ng t\u1ed3n t\u1ea1i \u2192 400.</li> <li>L\u1ed7i logic: ng\u01b0\u1eddi d\u00f9ng \u0111\u00e3 \u0111\u01b0\u1ee3c g\u00e1n v\u00e0o tenant \u0111\u00f3 \u2192 409 Conflict.</li> </ul>"},{"location":"services/user-service/master/design/#luong-2-ang-nhap-google-oauth2-yeu-cau-tu-auth-master","title":"\ud83d\udd10 Lu\u1ed3ng 2: \u0110\u0103ng nh\u1eadp Google OAuth2 \u2013 y\u00eau c\u1ea7u t\u1eeb Auth Master","text":"<pre><code>sequenceDiagram\n    participant FE as Frontend (Superadmin Webapp)\n    participant AuthM as Auth Service Master\n    participant UserM as User Service Master\n\n    FE-&gt;&gt;AuthM: \u0110\u0103ng nh\u1eadp Google (OAuth2)\n    AuthM-&gt;&gt;Google: Trao \u0111\u1ed5i token\n    Google--&gt;&gt;AuthM: Tr\u1ea3 v\u1ec1 user info (email, name,...)\n\n    AuthM-&gt;&gt;UserM: GET /users-global/by-email?email=...\n    alt Kh\u00f4ng t\u00ecm th\u1ea5y\n        AuthM-&gt;&gt;UserM: POST /users-global (t\u1ea1o user)\n    end\n\n    AuthM-&gt;&gt;UserM: GET /user-tenant-assignments?user_id=...\n    UserM--&gt;&gt;AuthM: Tr\u1ea3 v\u1ec1 danh s\u00e1ch tenant \u0111\u00e3 g\u00e1n\n\n    AuthM--&gt;&gt;FE: Tr\u1ea3 v\u1ec1 danh s\u00e1ch tenant \u0111\u1ec3 ch\u1ecdn\n</code></pre> <p>\u27a1\ufe0f Sau b\u01b0\u1edbc n\u00e0y, AuthM s\u1ebd ti\u1ebfp t\u1ee5c g\u1ecdi Sub User Service t\u01b0\u01a1ng \u1ee9ng \u0111\u1ec3 l\u1ea5y RBAC v\u00e0 ph\u00e1t h\u00e0nh JWT.</p>"},{"location":"services/user-service/master/design/#luong-3-taocap-nhat-rbac-template","title":"\ud83e\udde9 Lu\u1ed3ng 3: T\u1ea1o/C\u1eadp nh\u1eadt RBAC Template","text":"<pre><code>sequenceDiagram\n    participant FE as Superadmin Webapp\n    participant Gateway as API Gateway\n    participant UserM as User Service Master\n    participant PubSub as GCP Pub/Sub\n\n    FE-&gt;&gt;Gateway: POST /rbac/templates (role/permission)\n    Gateway-&gt;&gt;UserM: POST /rbac/templates\n    UserM-&gt;&gt;DB: T\u1ea1o ho\u1eb7c c\u1eadp nh\u1eadt b\u1ea3ng templates\n    UserM-&gt;&gt;PubSub: Publish event rbac_template_updated\n    PubSub--&gt;&gt;SubUser: Trigger \u0111\u1ed3ng b\u1ed9 template\n</code></pre> <p>\u27a1\ufe0f C\u00e1c Sub User Service c\u00f3 th\u1ec3 t\u1ef1 \u0111\u1ed3ng b\u1ed9 ho\u1eb7c hi\u1ec3n th\u1ecb g\u1ee3i \u00fd c\u1eadp nh\u1eadt template.</p>"},{"location":"services/user-service/master/design/#luong-4-sub-auth-service-tao-user-local-moi-va-cap-user_id_global","title":"\ud83d\udc64 Lu\u1ed3ng 4: Sub Auth Service t\u1ea1o user local m\u1edbi v\u00e0 c\u1ea5p <code>user_id_global</code>","text":"<pre><code>sequenceDiagram\n    participant AuthT as Sub Auth Service\n    participant Gateway as API Gateway\n    participant UserM as User Service Master\n\n    AuthT-&gt;&gt;Gateway: POST /users-global (t\u1ea1o user local)\n    Gateway-&gt;&gt;UserM: POST /users-global\n    UserM-&gt;&gt;DB: T\u1ea1o user (auth_provider = 'local')\n    UserM--&gt;&gt;Gateway: Tr\u1ea3 v\u1ec1 user_id_global\n    Gateway--&gt;&gt;AuthT: Tr\u1ea3 v\u1ec1 user_id_global\n</code></pre> <p>\u27a1\ufe0f AuthT sau \u0111\u00f3 s\u1ebd g\u00e1n user v\u00e0o tenant c\u1ee7a m\u00ecnh v\u00e0 ph\u00e1t h\u00e0nh JWT theo chu\u1ea9n \u0111a tenant.</p>"},{"location":"services/user-service/master/design/#4-mo-hinh-du-lieu","title":"4. M\u00f4 h\u00ecnh d\u1eef li\u1ec7u","text":"<p>C\u00e1c b\u1ea3ng ch\u00ednh do User Service Master qu\u1ea3n l\u00fd bao g\u1ed3m:</p> <ul> <li><code>users_global</code>: danh s\u00e1ch ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c, g\u1eafn v\u1edbi auth_provider.</li> <li><code>tenants</code>: th\u00f4ng tin t\u1eebng tenant (tr\u01b0\u1eddng th\u00e0nh vi\u00ean).</li> <li><code>user_tenant_assignments</code>: li\u00ean k\u1ebft ng\u01b0\u1eddi d\u00f9ng v\u1edbi t\u1eebng tenant c\u1ee5 th\u1ec3.</li> <li><code>global_roles_templates</code>: danh s\u00e1ch template vai tr\u00f2 to\u00e0n c\u1ee5c.</li> <li><code>global_permissions_templates</code>: danh s\u00e1ch template quy\u1ec1n to\u00e0n c\u1ee5c.</li> </ul>"},{"location":"services/user-service/master/design/#so-o-erd-tong-quan","title":"\ud83e\udde9 S\u01a1 \u0111\u1ed3 ERD t\u1ed5ng quan","text":"<pre><code>erDiagram\n\n    USERS_GLOBAL {\n        UUID user_id PK\n        TEXT full_name\n        TEXT email\n        TEXT auth_provider\n    }\n\n    TENANTS {\n        TEXT tenant_id PK\n        TEXT tenant_name\n        TEXT status\n    }\n\n    USER_TENANT_ASSIGNMENTS {\n        UUID id PK\n        UUID user_id_global FK\n        TEXT tenant_id FK\n        TEXT role_codes\n        BOOLEAN is_active\n    }\n\n    GLOBAL_ROLES_TEMPLATES {\n        UUID template_id PK\n        TEXT template_code\n        TEXT description\n    }\n\n    GLOBAL_PERMISSIONS_TEMPLATES {\n        UUID template_id PK\n        TEXT permission_code\n        TEXT action\n        TEXT resource\n        TEXT default_condition\n    }\n\n    USERS_GLOBAL ||--o{ USER_TENANT_ASSIGNMENTS : has\n    TENANTS ||--o{ USER_TENANT_ASSIGNMENTS : includes\n    GLOBAL_ROLES_TEMPLATES ||--o{ GLOBAL_PERMISSIONS_TEMPLATES : defines\n</code></pre> <p>\ud83d\udcdd Ghi ch\u00fa quan tr\u1ecdng cho s\u01a1 \u0111\u1ed3 ERD:</p> <ul> <li><code>USER_TENANT_ASSIGNMENTS.role_codes</code>: L\u00e0 m\u1ed9t m\u1ea3ng TEXT. Mermaid kh\u00f4ng h\u1ed7 tr\u1ee3 ki\u1ec3u <code>TEXT[]</code>, n\u00ean \u0111\u01b0\u1ee3c ghi l\u00e0 <code>TEXT</code> cho \u0111\u01a1n gi\u1ea3n.</li> <li><code>GLOBAL_PERMISSIONS_TEMPLATES.default_condition</code>: L\u00e0 m\u1ed9t tr\u01b0\u1eddng JSONB d\u00f9ng \u0111\u1ec3 \u0111\u1ecbnh ngh\u0129a \u0111i\u1ec1u ki\u1ec7n RBAC. Mermaid ch\u1ec9 h\u1ed7 tr\u1ee3 <code>TEXT</code>, n\u00ean c\u1ea7n hi\u1ec3u <code>TEXT default_condition</code> \u1edf \u0111\u00e2y l\u00e0 bi\u1ec3u di\u1ec5n c\u1ee7a JSONB.</li> <li><code>email</code>, <code>template_code</code>, <code>permission_code</code>: C\u00f3 r\u00e0ng bu\u1ed9c <code>UNIQUE</code> trong thi\u1ebft k\u1ebf th\u1ef1c t\u1ebf \u2013 kh\u00f4ng th\u1ec3 hi\u1ec7n trong s\u01a1 \u0111\u1ed3 Mermaid nh\u01b0ng \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a trong migration script ho\u1eb7c t\u00e0i li\u1ec7u <code>data-model.md</code>.</li> </ul> <p>\ud83d\udc49 Xem chi ti\u1ebft \u0111\u1ecbnh ngh\u0129a b\u1ea3ng t\u1ea1i: <code>data-model.md</code></p>"},{"location":"services/user-service/master/design/#5-api","title":"5. API","text":"<p>User Service Master cung c\u1ea5p c\u00e1c API ph\u1ee5c v\u1ee5 cho:</p> <ul> <li>Superadmin Webapp: qu\u1ea3n l\u00fd \u0111\u1ecbnh danh ng\u01b0\u1eddi d\u00f9ng v\u00e0 RBAC to\u00e0n c\u1ee5c.</li> <li>Auth Service Master/Sub: tra c\u1ee9u, t\u1ea1o ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c.</li> <li>Sub User Service: \u0111\u1ed3ng b\u1ed9 danh s\u00e1ch assignment, template RBAC.</li> </ul> <p>Chi ti\u1ebft \u0111\u1ecbnh ngh\u0129a tham kh\u1ea3o t\u1ea1i <code>interface-contract.md</code> v\u00e0 <code>openapi.yaml</code>.</p>"},{"location":"services/user-service/master/design/#bang-tom-tat-api-chinh","title":"\ud83d\udcda B\u1ea3ng t\u00f3m t\u1eaft API ch\u00ednh","text":"Method Path M\u00f4 t\u1ea3 ng\u1eafn Y\u00eau c\u1ea7u quy\u1ec1n GET <code>/users-global/by-email</code> Tra c\u1ee9u ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c theo email Authenticated (Google) POST <code>/users-global</code> T\u1ea1o ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c m\u1edbi Authenticated (Google, OTP) GET <code>/tenants</code> Li\u1ec7t k\u00ea danh s\u00e1ch c\u00e1c tenant hi\u1ec7n c\u00f3 Superadmin GET <code>/user-tenant-assignments</code> Tra c\u1ee9u c\u00e1c tenant m\u00e0 ng\u01b0\u1eddi d\u00f9ng thu\u1ed9c v\u1ec1 Auth Service / Admin Tenant POST <code>/user-tenant-assignments</code> G\u00e1n ng\u01b0\u1eddi d\u00f9ng v\u00e0o tenant c\u1ee5 th\u1ec3 Superadmin GET <code>/global-roles-templates</code> Tra c\u1ee9u template vai tr\u00f2 to\u00e0n c\u1ee5c Superadmin POST <code>/global-roles-templates</code> T\u1ea1o m\u1edbi template vai tr\u00f2 to\u00e0n c\u1ee5c Superadmin GET <code>/global-permissions-templates</code> Tra c\u1ee9u template quy\u1ec1n to\u00e0n c\u1ee5c Superadmin POST <code>/global-permissions-templates</code> T\u1ea1o m\u1edbi template quy\u1ec1n to\u00e0n c\u1ee5c Superadmin"},{"location":"services/user-service/master/design/#6-su-kien-phat-ra-events","title":"6. S\u1ef1 ki\u1ec7n ph\u00e1t ra (Events)","text":"<p>User Service Master ph\u00e1t c\u00e1c s\u1ef1 ki\u1ec7n l\u00ean Google Cloud Pub/Sub \u0111\u1ec3:</p> <ul> <li>Th\u00f4ng b\u00e1o cho c\u00e1c Sub User Services v\u1ec1 thay \u0111\u1ed5i RBAC.</li> <li>Cho ph\u00e9p c\u00e1c service kh\u00e1c \u0111\u1ed3ng b\u1ed9 \u0111\u1ecbnh danh ng\u01b0\u1eddi d\u00f9ng v\u00e0 c\u1ea5u h\u00ecnh tenant.</li> </ul>"},{"location":"services/user-service/master/design/#danh-sach-su-kien","title":"\ud83d\udce2 Danh s\u00e1ch s\u1ef1 ki\u1ec7n","text":""},{"location":"services/user-service/master/design/#1-tenant_user_assigned","title":"1. <code>tenant_user_assigned</code>","text":"<p>Khi m\u1ed9t ng\u01b0\u1eddi d\u00f9ng \u0111\u01b0\u1ee3c g\u00e1n v\u00e0o m\u1ed9t tenant m\u1edbi.</p> <pre><code>{\n  \"event_id\": \"evt_7a3a8b40\",\n  \"event_type\": \"tenant_user_assigned\",\n  \"user_id_global\": \"usr_12345678\",\n  \"tenant_id\": \"vas-truong-a\",\n  \"role_codes\": [\"teacher\", \"homeroom\"],\n  \"assignment_status\": \"active\",\n  \"timestamp\": \"2025-06-01T08:30:00Z\"\n}\n</code></pre> <ul> <li>Consumer: Sub User Service c\u1ee7a tenant t\u01b0\u01a1ng \u1ee9ng</li> <li>T\u00e1c d\u1ee5ng: T\u1ef1 \u0111\u1ed9ng t\u1ea1o <code>users_in_tenant</code> v\u00e0 mapping role cho user trong tenant \u0111\u00f3</li> <li>Y\u00eau c\u1ea7u idempotency: Sub Service ph\u1ea3i ki\u1ec3m tra <code>event_id</code> ho\u1eb7c <code>user_id + tenant_id</code> \u0111\u00e3 x\u1eed l\u00fd hay ch\u01b0a.</li> </ul>"},{"location":"services/user-service/master/design/#2-rbac_template_updated","title":"2. <code>rbac_template_updated</code>","text":"<p>Khi m\u1ed9t template vai tr\u00f2 ho\u1eb7c quy\u1ec1n to\u00e0n c\u1ee5c \u0111\u01b0\u1ee3c c\u1eadp nh\u1eadt.</p> <pre><code>{\n  \"event_id\": \"evt_5baf6c2d\",\n  \"event_type\": \"rbac_template_updated\",\n  \"template_type\": \"permission\",\n  \"template_id\": \"perm_tpl_001\",\n  \"action\": \"create_or_update\",\n  \"updated_by\": \"superadmin@vas.edu.vn\",\n  \"timestamp\": \"2025-06-01T09:00:00Z\"\n}\n</code></pre> <ul> <li>Consumer: Sub User Services c\u00f3 nhu c\u1ea7u \u0111\u1ed3ng b\u1ed9 template</li> <li>T\u00e1c d\u1ee5ng: Cho ph\u00e9p Sub Service quy\u1ebft \u0111\u1ecbnh c\u00f3 n\u00ean c\u1eadp nh\u1eadt local template kh\u00f4ng (ho\u1eb7c g\u1ee3i \u00fd cho admin c\u1eadp nh\u1eadt th\u1ee7 c\u00f4ng)</li> <li>G\u1ee3i \u00fd th\u1ef1c thi: C\u00f3 th\u1ec3 l\u01b0u l\u1ea1i trong b\u1ea3ng <code>rbac_template_sync_log</code> t\u1ea1i Sub Service \u0111\u1ec3 ki\u1ec3m so\u00e1t phi\u00ean b\u1ea3n.</li> </ul>"},{"location":"services/user-service/master/design/#7-bao-mat-phan-quyen","title":"7. \ud83d\udd10 B\u1ea3o m\u1eadt &amp; Ph\u00e2n quy\u1ec1n","text":"<p><code>user-service/master</code> x\u1eed l\u00fd th\u00f4ng tin \u0111\u1ecbnh danh to\u00e0n c\u1ee5c (Global User Identity), do \u0111\u00f3 y\u00eau c\u1ea7u ch\u00ednh s\u00e1ch b\u1ea3o m\u1eadt v\u00e0 ki\u1ec3m so\u00e1t ph\u00e2n quy\u1ec1n ch\u1eb7t ch\u1ebd theo ki\u1ebfn tr\u00fac RBAC ph\u00e2n t\u1ea7ng (xem chi ti\u1ebft t\u1ea1i <code>rbac-deep-dive.md</code>).</p>"},{"location":"services/user-service/master/design/#71-authentication-xac-thuc","title":"\ud83d\udee1\ufe0f 7.1. Authentication (X\u00e1c th\u1ef1c)","text":"<ul> <li>T\u1ea5t c\u1ea3 c\u00e1c endpoint \u0111\u1ec1u y\u00eau c\u1ea7u JWT access token h\u1ee3p l\u1ec7, do <code>auth-service/master</code> c\u1ea5p ph\u00e1t.</li> <li>Token \u0111\u01b0\u1ee3c x\u00e1c th\u1ef1c t\u1ea1i API Gateway, s\u1eed d\u1ee5ng public key t\u1eeb <code>JWKS</code> endpoint.</li> <li>Service kh\u00f4ng decode token m\u00e0 d\u1ef1a v\u00e0o gateway \u0111\u1ec3 inject <code>X-User-ID</code>, <code>X-User-Role</code>, <code>X-Tenant-ID</code>.</li> </ul>"},{"location":"services/user-service/master/design/#72-authorization-phan-quyen-ong","title":"\ud83e\udde9 7.2. Authorization (Ph\u00e2n quy\u1ec1n \u0111\u1ed9ng)","text":"<ul> <li>H\u1ec7 th\u1ed1ng \u00e1p d\u1ee5ng RBAC 3 t\u1ea7ng: <code>global</code>, <code>tenant</code>, v\u00e0 <code>scoped-role</code>.</li> <li>M\u1ed7i endpoint \u0111\u1ecbnh ngh\u0129a <code>x-required-permission</code>, v\u00ed d\u1ee5:</li> </ul> <pre><code>x-required-permission: user.read:any\n</code></pre> <ul> <li>C\u00e1c permission \u0111\u01b0\u1ee3c mapping theo b\u1ea3ng sau:</li> </ul> Permission M\u00f4 t\u1ea3 <code>user.read:any</code> Truy c\u1eadp th\u00f4ng tin b\u1ea5t k\u1ef3 user n\u00e0o <code>user.read:self</code> Truy c\u1eadp ch\u1ec9 th\u00f4ng tin c\u1ee7a ch\u00ednh m\u00ecnh <code>user.create</code> T\u1ea1o user m\u1edbi to\u00e0n c\u1ee5c <code>user.update:any</code> S\u1eeda th\u00f4ng tin user b\u1ea5t k\u1ef3 <code>user.update:self</code> S\u1eeda th\u00f4ng tin c\u1ee7a ch\u00ednh m\u00ecnh"},{"location":"services/user-service/master/design/#73-bao-ve-du-lieu-nhay-cam","title":"\ud83d\udd10 7.3. B\u1ea3o v\u1ec7 d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m","text":"<ul> <li> <p>Tr\u01b0\u1eddng <code>password</code>, <code>token</code>, <code>email_verified_at</code> \u0111\u1ec1u \u0111\u01b0\u1ee3c b\u1ea3o v\u1ec7:</p> </li> <li> <p><code>password</code> ch\u1ec9 ghi, kh\u00f4ng bao gi\u1edd tr\u1ea3 v\u1ec1 (g\u1eafn <code>writeOnly: true</code>)</p> </li> <li>Email \u0111\u01b0\u1ee3c x\u00e1c minh \u1edf <code>auth/master</code>, kh\u00f4ng l\u01b0u l\u1ea1i trong <code>user/master</code></li> <li> <p>C\u00e1c tr\u01b0\u1eddng c\u00f3 th\u1ec3 b\u1ecb gi\u1edbi h\u1ea1n truy c\u1eadp tu\u1ef3 theo vai tr\u00f2:</p> </li> <li> <p><code>internal_notes</code> ch\u1ec9 hi\u1ec7n v\u1edbi <code>admin</code>, kh\u00f4ng hi\u1ec7n v\u1edbi <code>self</code></p> </li> </ul>"},{"location":"services/user-service/master/design/#74-audit-logging","title":"\ud83d\udd01 7.4. Audit Logging","text":"<ul> <li> <p>M\u1ecdi thao t\u00e1c ghi (<code>POST</code>, <code>PATCH</code>, <code>DELETE</code>) \u0111\u1ec1u emit s\u1ef1 ki\u1ec7n audit:</p> </li> <li> <p><code>user.created</code>, <code>user.updated</code>, <code>user.merged</code></p> </li> <li>Log audit \u0111\u01b0\u1ee3c g\u1eedi qua Pub/Sub \u2192 <code>audit-logging-service</code>, tu\u00e2n th\u1ee7 ADR-008</li> </ul>"},{"location":"services/user-service/master/design/#75-internal-auth","title":"\ud83d\udd12 7.5. Internal Auth","text":"<ul> <li>C\u00e1c call n\u1ed9i b\u1ed9 (v\u00ed d\u1ee5: t\u1eeb <code>auth-service/master</code>) s\u1eed d\u1ee5ng <code>SERVICE_AUTH_TOKEN</code> v\u00e0 \u0111\u01b0\u1ee3c ki\u1ec3m tra t\u1ea1i gateway.</li> <li>Nh\u1eefng API kh\u00f4ng d\u00e0nh cho public (seed role, fetch global profile) c\u00f3 g\u1eafn:</li> </ul> <pre><code>x-internal-only: true\nx-service-auth-required: true\n</code></pre>"},{"location":"services/user-service/master/design/#76-rate-limiting-abuse-prevention","title":"\ud83d\udeab 7.6. Rate Limiting &amp; Abuse Prevention","text":"<ul> <li>Gateway c\u1ea5u h\u00ecnh limit m\u1eb7c \u0111\u1ecbnh: <code>100 req/min/user</code></li> <li>C\u00e1c endpoint nh\u1ea1y c\u1ea3m (t\u00ecm theo email, t\u1ea1o user) c\u00f3 th\u1ec3 g\u1eafn limit ri\u00eang.</li> </ul>"},{"location":"services/user-service/master/design/#8-cau-hinh-trien-khai","title":"8. \u2699\ufe0f C\u1ea5u h\u00ecnh &amp; Tri\u1ec3n khai","text":""},{"location":"services/user-service/master/design/#bien-moi-truong","title":"\ud83d\udd27 Bi\u1ebfn m\u00f4i tr\u01b0\u1eddng","text":"<p>Service s\u1eed d\u1ee5ng c\u1ea5u h\u00ecnh t\u1eeb file <code>.env</code> (ho\u1eb7c <code>settings/.env.&lt;env&gt;.template</code>) theo chu\u1ea9n h\u00f3a t\u1eeb ADR-005: Env Config. M\u1ed9t s\u1ed1 bi\u1ebfn ch\u00ednh:</p> T\u00ean bi\u1ebfn M\u00f4 t\u1ea3 V\u00ed d\u1ee5 <code>ENVIRONMENT</code> M\u00f4i tr\u01b0\u1eddng ch\u1ea1y (<code>local</code>, <code>staging</code>, <code>production</code>) <code>staging</code> <code>SERVICE_PORT</code> C\u1ed5ng ch\u1ea1y service <code>8000</code> <code>DATABASE_URL</code> K\u1ebft n\u1ed1i PostgreSQL <code>postgresql://user:pass@host/db</code> <code>REDIS_URL</code> K\u1ebft n\u1ed1i Redis (cache session/token) <code>redis://localhost:6379/0</code> <code>SERVICE_AUTH_TOKEN</code> Token d\u00f9ng \u0111\u1ec3 g\u1ecdi n\u1ed9i b\u1ed9 gi\u1eefa c\u00e1c service (Auth Master \u2192 User Master) <code>secret-key</code> <code>JWT_PUBLIC_KEY</code> Public key \u0111\u1ec3 validate access token (d\u1ea1ng PEM) \u2013 <code>GOOGLE_CLOUD_PROJECT</code> Project ID d\u00f9ng cho Pub/Sub (n\u1ebfu b\u1eadt audit) <code>dxvas-dev</code> <code>LOG_LEVEL</code> M\u1ee9c log (<code>DEBUG</code>, <code>INFO</code>, ...) <code>INFO</code> <p>\ud83d\udc49 To\u00e0n b\u1ed9 c\u00e1c bi\u1ebfn \u0111\u01b0\u1ee3c li\u1ec7t k\u00ea v\u00e0 version h\u00f3a t\u1ea1i: <code>settings/.env.template</code>.</p>"},{"location":"services/user-service/master/design/#cau-truc-thu-muc-cau-hinh","title":"\ud83d\udee0 C\u1ea5u tr\u00fac th\u01b0 m\u1ee5c c\u1ea5u h\u00ecnh","text":"<pre><code>settings/\n\u251c\u2500\u2500 .env.template              # Bi\u1ebfn m\u00f4i tr\u01b0\u1eddng chu\u1ea9n (d\u00f9ng cho m\u1ecdi m\u00f4i tr\u01b0\u1eddng)\n\u251c\u2500\u2500 env.staging.yaml          # Override cho m\u00f4i tr\u01b0\u1eddng staging\n\u251c\u2500\u2500 env.production.yaml       # Override cho m\u00f4i tr\u01b0\u1eddng production\n\u2514\u2500\u2500 secrets.yaml              # Ch\u1ec9 ch\u1ee9a key nh\u1ea1y c\u1ea3m, inject t\u1eeb Vault/SecretManager\n</code></pre> <ul> <li>To\u00e0n b\u1ed9 file <code>yaml</code> \u0111\u1ec1u \u0111\u01b0\u1ee3c load t\u1ef1 \u0111\u1ed9ng b\u1edfi module config chu\u1ea9n trong <code>dx-core</code>.</li> <li>Secrets nh\u01b0 <code>JWT_PRIVATE_KEY</code> KH\u00d4NG \u0111\u01b0\u1ee3c ghi tr\u1ef1c ti\u1ebfp v\u00e0o <code>.env</code>, m\u00e0 \u0111\u01b0\u1ee3c mount v\u00e0o volume ho\u1eb7c l\u1ea5y t\u1eeb SecretManager (theo ADR-003: Secrets).</li> </ul>"},{"location":"services/user-service/master/design/#cicd-trien-khai","title":"\ud83d\ude80 CI/CD &amp; Tri\u1ec3n khai","text":"<p>Tu\u00e2n th\u1ee7 ADR-001: CI/CD Pipeline:</p> Th\u00e0nh ph\u1ea7n C\u00f4ng c\u1ee5 Ghi ch\u00fa Build &amp; test GitHub Actions <code>test.yaml</code>, <code>lint.yaml</code> trong <code>.github/workflows/</code> Build image Docker, Poetry Image t\u1ed1i \u01b0u t\u1eeb <code>python:slim</code>, kh\u00f4ng include dev deps Scan b\u1ea3o m\u1eadt <code>trivy</code>, <code>semgrep</code> T\u00edch h\u1ee3p v\u00e0o CI Deploy ArgoCD T\u1ef1 \u0111\u1ed9ng rollout n\u1ebfu merge v\u00e0o <code>main</code> Observability OpenTelemetry, Grafana, Sentry Default g\u1eafn theo dx-core Migration Alembic, trigger qua Argo Job T\u00e1ch step migrate v\u00e0 deploy r\u00f5 r\u00e0ng <p>\ud83d\udccc \u0110\u1ec3 ch\u1ea1y service c\u1ee5c b\u1ed9:</p> <pre><code>cp settings/.env.template .env\ndocker-compose up -d postgres redis\nmake run\n</code></pre>"},{"location":"services/user-service/master/design/#9-chien-luoc-test","title":"9. \ud83e\uddea Chi\u1ebfn l\u01b0\u1ee3c Test","text":"<p>Vi\u1ec7c ki\u1ec3m th\u1eed <code>user-service/master</code> \u0111\u01b0\u1ee3c t\u1ed5 ch\u1ee9c theo chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed \u0111a t\u1ea7ng, \u0111\u1ea3m b\u1ea3o ch\u1ea5t l\u01b0\u1ee3ng t\u1eeb m\u1ee9c \u0111\u1ed9 logic n\u1ed9i b\u1ed9 \u0111\u1ebfn t\u00edch h\u1ee3p li\u00ean service, \u0111\u1ed3ng th\u1eddi c\u00f3 th\u1ec3 ch\u1ea1y hi\u1ec7u qu\u1ea3 trong CI/CD pipeline.</p>"},{"location":"services/user-service/master/design/#91-unit-test","title":"\u2705 9.1. Unit Test","text":"<ul> <li> <p>Ph\u1ea1m vi:</p> </li> <li> <p>X\u1eed l\u00fd logic nghi\u1ec7p v\u1ee5: t\u1ea1o user, validate d\u1eef li\u1ec7u, ph\u00e2n quy\u1ec1n \u0111\u1ed9ng</p> </li> <li>Format h\u00f3a response v\u00e0 m\u00e3 l\u1ed7i theo ADR-012</li> <li>C\u00f4ng c\u1ee5: <code>pytest + pytest-mock</code></li> <li>M\u1ed7i PR m\u1edbi \u0111\u1ec1u b\u1eaft bu\u1ed9c ch\u1ea1y qua test suite n\u00e0y trong GitHub Actions (<code>test.yaml</code>)</li> <li>Y\u00eau c\u1ea7u coverage \u2265 85%</li> </ul>"},{"location":"services/user-service/master/design/#92-contract-test-consumer-driven","title":"\u2705 9.2. Contract Test (Consumer-Driven)","text":"<p>Tu\u00e2n th\u1ee7 ADR-010: Contract Testing</p> <ul> <li>Ki\u1ec3m th\u1eed t\u01b0\u01a1ng th\u00edch gi\u1eefa <code>user-service/master</code> v\u00e0 c\u00e1c consumer (v\u00ed d\u1ee5: <code>auth/master</code>, <code>api-gateway</code>)</li> <li>D\u00f9ng <code>pact-python</code>, publish pact file l\u00ean <code>pact-broker</code></li> <li>CI s\u1ebd fail n\u1ebfu producer l\u00e0m g\u00e3y contract</li> <li> <p>B\u1eaft bu\u1ed9c c\u00f3 contract test cho c\u00e1c API:</p> </li> <li> <p><code>GET /users-global/{id}</code></p> </li> <li><code>POST /users-global</code></li> <li><code>GET /users-global/by-email</code></li> </ul>"},{"location":"services/user-service/master/design/#93-integration-test-service-level","title":"\u2705 9.3. Integration Test (Service level)","text":"<ul> <li>Spin-up to\u00e0n b\u1ed9 stack (PostgreSQL, Redis, user-service) trong Docker Compose</li> <li>Ch\u1ea1y c\u00e1c test query + mutation logic \u0111\u1ea7y \u0111\u1ee7 (bao g\u1ed3m validate RBAC, ph\u00e2n quy\u1ec1n)</li> <li>D\u00f9ng <code>httpx</code> ho\u1eb7c <code>pytest-httpx</code> \u0111\u1ec3 test end-to-end response format</li> <li>\u0110\u1ea3m b\u1ea3o emit \u0111\u00fang c\u00e1c s\u1ef1 ki\u1ec7n (<code>user.created</code>, <code>user.duplicated</code>, <code>user.updated</code>) qua Pub/Sub mock</li> </ul>"},{"location":"services/user-service/master/design/#94-load-performance-test-tuy-chon","title":"\u2705 9.4. Load &amp; Performance Test (T\u00f9y ch\u1ecdn)","text":"<ul> <li>D\u00f9ng <code>locust</code> ho\u1eb7c <code>k6</code> \u0111\u1ec3 test throughput c\u1ee7a c\u00e1c API truy xu\u1ea5t h\u00e0ng lo\u1ea1t (pagination, filter)</li> <li>\u01af\u1edbc l\u01b0\u1ee3ng ng\u01b0\u1ee1ng t\u1ed1i \u01b0u: 1000 req/s v\u1edbi latency P95 &lt; 200ms</li> <li>Gi\u00fap tune indexing, limit-offset, caching Redis user_id \u2192 full profile</li> </ul>"},{"location":"services/user-service/master/design/#95-security-test","title":"\u2705 9.5. Security Test","text":"<ul> <li><code>pytest</code> v\u1edbi c\u00e1c case \u0111\u1eb7c bi\u1ec7t: kh\u00f4ng c\u00f3 token, token sai scope, sai tenant</li> <li>K\u1ebft h\u1ee3p <code>semgrep</code> \u0111\u1ec3 ph\u00e1t hi\u1ec7n hardcoded secrets, l\u1ed7i injection</li> <li>Test <code>user.read:self</code> vs <code>user.read:any</code> \u0111\u1ec3 x\u00e1c minh ph\u00e2n quy\u1ec1n \u0111\u1ed9ng</li> </ul>"},{"location":"services/user-service/master/design/#bao-cao-tich-hop-ci","title":"\ud83e\uddea B\u00e1o c\u00e1o &amp; T\u00edch h\u1ee3p CI","text":"<ul> <li>Test ch\u1ea1y qua <code>make test</code>, <code>make test-contract</code>, <code>make test-int</code></li> <li>K\u1ebft qu\u1ea3 publish l\u00ean <code>coverage.xml</code>, <code>junit.xml</code>, t\u00edch h\u1ee3p GitHub Checks</li> <li>Pact Broker: <code>https://pact.dxvas.vn</code></li> <li>Allure Report: T\u00f9y ch\u1ecdn publish khi ch\u1ea1y full test suite</li> </ul> <p>\ud83e\udde0 M\u1ecdi k\u1ecbch b\u1ea3n test c\u1ea7n bao g\u1ed3m tr\u01b0\u1eddng h\u1ee3p th\u00e0nh c\u00f4ng, l\u1ed7i logic, v\u00e0 l\u1ed7i h\u1ec7 th\u1ed1ng (timeout, l\u1ed7i DB, l\u1ed7i Pub/Sub...).</p>"},{"location":"services/user-service/master/design/#10-quan-sat-giam-sat","title":"10. \ud83d\udcc8 Quan s\u00e1t &amp; Gi\u00e1m s\u00e1t","text":"<p>H\u1ec7 th\u1ed1ng quan s\u00e1t (observability) c\u1ee7a <code>user-service/master</code> gi\u00fap \u0111\u1ea3m b\u1ea3o kh\u1ea3 n\u0103ng ph\u00e1t hi\u1ec7n l\u1ed7i s\u1edbm, \u0111o l\u01b0\u1eddng s\u1ee9c kh\u1ecfe h\u1ec7 th\u1ed1ng v\u00e0 h\u1ed7 tr\u1ee3 ph\u00e2n t\u00edch h\u00e0nh vi ng\u01b0\u1eddi d\u00f9ng ph\u1ee5c v\u1ee5 v\u1eadn h\u00e0nh \u0111a tenant hi\u1ec7u qu\u1ea3.</p>"},{"location":"services/user-service/master/design/#101-logging","title":"\ud83d\udcca 10.1. Logging","text":"<ul> <li>Chu\u1ea9n log JSON theo <code>dx-core</code>, \u0111\u1ecbnh d\u1ea1ng:   <code>{ timestamp, level, service, trace_id, span_id, user_id, tenant_id, msg, extra... }</code></li> <li>T\u00edch h\u1ee3p OpenTelemetry \u0111\u1ec3 \u0111\u00ednh k\u00e8m <code>trace_id</code>, <code>span_id</code> theo chu\u1ea9n OTEL.</li> <li> <p>Log \u0111\u01b0\u1ee3c g\u1eedi v\u1ec1:</p> </li> <li> <p>Dev: <code>stdout</code> \u2192 Loki/Grafana</p> </li> <li>Prod: GCP Logging ho\u1eb7c OpenObserve</li> </ul> Level M\u1ee5c \u0111\u00edch <code>INFO</code> Thao t\u00e1c th\u00f4ng th\u01b0\u1eddng <code>WARN</code> Thao t\u00e1c sai, kh\u00f4ng l\u00e0m crash <code>ERROR</code> Exception, database l\u1ed7i, s\u1ef1 c\u1ed1 nghi\u00eam tr\u1ecdng <code>DEBUG</code> G\u1ee1 l\u1ed7i (ch\u1ec9 b\u1eadt khi local/dev)"},{"location":"services/user-service/master/design/#102-metrics","title":"\ud83d\udcc8 10.2. Metrics","text":"<ul> <li>S\u1eed d\u1ee5ng <code>Prometheus</code> exporter th\u00f4ng qua <code>dx-core.metrics</code>.</li> <li>M\u1ed9t s\u1ed1 metrics quan tr\u1ecdng:</li> </ul> Metric Lo\u1ea1i Nh\u00e3n Ghi ch\u00fa <code>http_requests_total</code> Counter path, method, status T\u1ed5ng s\u1ed1 request <code>http_request_duration_seconds</code> Histogram path, method \u0110\u1ed9 tr\u1ec5 <code>user_create_success_total</code> Counter tenant_id T\u1ea1o user th\u00e0nh c\u00f4ng <code>user_lookup_by_email_miss_total</code> Counter \u2013 Kh\u00f4ng t\u00ecm th\u1ea5y user theo email <code>db_query_duration_seconds</code> Histogram model, operation Theo d\u00f5i hi\u1ec7u n\u0103ng DB"},{"location":"services/user-service/master/design/#103-audit-logging","title":"\ud83d\udd10 10.3. Audit Logging","text":"<p>Tu\u00e2n th\u1ee7 ADR-008:</p> <ul> <li> <p>Emit c\u00e1c s\u1ef1 ki\u1ec7n audit d\u1ea1ng Pub/Sub:</p> </li> <li> <p><code>user.created</code></p> </li> <li><code>user.updated</code></li> <li><code>user.duplicated</code></li> <li>M\u1ed7i event bao g\u1ed3m: <code>actor_id</code>, <code>target_user_id</code>, <code>tenant_id</code>, <code>action</code>, <code>changes</code></li> <li> <p>\u0110\u01b0\u1ee3c forward sang <code>audit-logging-service</code> \u0111\u1ec3 l\u01b0u DB ri\u00eang (GCP BigQuery ho\u1eb7c PostgreSQL ph\u00e2n v\u00f9ng)</p> </li> <li> <p>T\u1ea5t c\u1ea3 c\u00e1c thao t\u00e1c thay \u0111\u1ed5i d\u1eef li\u1ec7u li\u00ean quan \u0111\u1ebfn ng\u01b0\u1eddi d\u00f9ng v\u00e0 tenant \u0111\u1ec1u \u0111\u01b0\u1ee3c ghi l\u1ea1i th\u00f4ng qua Audit Logging Service, bao g\u1ed3m:</p> <ul> <li><code>user.created</code>, <code>user.updated</code>, <code>user.deleted</code></li> <li><code>user_tenant_assignment.created</code></li> <li><code>tenant.created</code>, <code>tenant.status_changed</code></li> <li><code>role_template.updated</code>, <code>permission_template.updated</code></li> </ul> </li> <li> <p>Log bao g\u1ed3m:</p> <ul> <li><code>actor_id</code>, <code>tenant_id</code>, <code>action</code>, <code>target_table</code>, <code>before</code>, <code>after</code>, <code>timestamp</code></li> <li>Request <code>X-Request-ID</code> \u0111\u1ec3 truy v\u1ebft qua to\u00e0n h\u1ec7 th\u1ed1ng</li> </ul> </li> </ul>"},{"location":"services/user-service/master/design/#104-cost-observability-billing","title":"\ud83d\udcb0 10.4. Cost Observability (Billing)","text":"<p>\u00c1p d\u1ee5ng ADR-020:</p> <ul> <li>T\u1ef1 \u0111\u1ed9ng emit s\u1ef1 ki\u1ec7n <code>usage.user.query</code> v\u00e0 <code>usage.user.create</code></li> <li>H\u1ed7 tr\u1ee3 billing theo s\u1ed1 l\u1ea7n truy c\u1eadp d\u1eef li\u1ec7u <code>global user</code> c\u1ee7a m\u1ed7i tenant</li> <li>C\u00e1c service kh\u00e1c (nh\u01b0 SIS, CRM) c\u00f3 th\u1ec3 t\u00edch h\u1ee3p c\u00e1c s\u1ef1 ki\u1ec7n n\u00e0y \u0111\u1ec3 \u01b0\u1edbc l\u01b0\u1ee3ng chi ph\u00ed</li> </ul>"},{"location":"services/user-service/master/design/#105-health-check-alert","title":"\ud83e\uddea 10.5. Health Check &amp; Alert","text":"<ul> <li>Endpoint: <code>GET /healthz</code> (c\u00f3 th\u1ec3 b\u1ed5 sung <code>/readyz</code>)</li> <li> <p>T\u00edch h\u1ee3p:</p> </li> <li> <p>Argo Rollout \u2192 ki\u1ec3m tra tr\u01b0\u1edbc khi scale</p> </li> <li>GCP Cloud Monitoring \u2192 alert theo latency v\u00e0 error rate</li> </ul>"},{"location":"services/user-service/master/design/#11-o-tin-cay-phuc-hoi","title":"11. \ud83d\ude80 \u0110\u1ed9 tin c\u1eady &amp; Ph\u1ee5c h\u1ed3i","text":"<p><code>user-service/master</code> \u0111\u00f3ng vai tr\u00f2 then ch\u1ed1t trong h\u1ec7 th\u1ed1ng \u0111\u1ecbnh danh to\u00e0n c\u1ee5c, do \u0111\u00f3 \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf v\u1edbi m\u1ee5c ti\u00eau kh\u1ea3 d\u1ee5ng cao (HA), \u0111\u1ea3m b\u1ea3o kh\u00f4ng m\u1ea5t d\u1eef li\u1ec7u v\u00e0 kh\u00f4ng gi\u00e1n \u0111o\u1ea1n khi c\u1eadp nh\u1eadt.</p>"},{"location":"services/user-service/master/design/#111-trien-khai-khong-gian-oan-zero-downtime","title":"\ud83e\uddf1 11.1. Tri\u1ec3n khai kh\u00f4ng gi\u00e1n \u0111o\u1ea1n (Zero Downtime)","text":"<p>Tu\u00e2n th\u1ee7 ADR-014: Zero Downtime:</p> <ul> <li>S\u1eed d\u1ee5ng chi\u1ebfn l\u01b0\u1ee3c rollout <code>blue-green</code> ho\u1eb7c <code>canary</code> qua Argo Rollouts.</li> <li>Endpoint <code>GET /healthz</code> + probe readiness ki\u1ec3m tra DB + Redis + Pub/Sub.</li> <li>Th\u1ef1c hi\u1ec7n shadow traffic test tr\u01b0\u1edbc khi 100% chuy\u1ec3n route.</li> </ul>"},{"location":"services/user-service/master/design/#112-chinh-sach-trien-khai","title":"\u2699\ufe0f 11.2. Ch\u00ednh s\u00e1ch tri\u1ec3n khai","text":"<p>Theo ADR-015: Deployment Strategy v\u00e0 ADR-018: Release Approval:</p> <ul> <li> <p>M\u1ecdi release \u0111\u1ec1u y\u00eau c\u1ea7u:</p> </li> <li> <p>Pass CI (<code>unit</code>, <code>contract</code>, <code>integration</code>)</p> </li> <li>\u0110\u01b0\u1ee3c duy\u1ec7t b\u1edfi reviewer k\u1ef9 thu\u1eadt</li> <li>G\u1eafn tag version (<code>v2.x.x</code>)</li> <li>T\u1ef1 \u0111\u1ed9ng deploy n\u1ebfu PR merge v\u00e0o <code>main</code> v\u00e0 c\u00f3 tag.</li> </ul>"},{"location":"services/user-service/master/design/#113-auto-scaling","title":"\u267b\ufe0f 11.3. Auto Scaling","text":"<p>Tu\u00e2n th\u1ee7 ADR-016: Auto Scaling:</p> <ul> <li> <p>S\u1eed d\u1ee5ng HPA (Horizontal Pod Autoscaler) theo:</p> </li> <li> <p>CPU: \u2265 70%</p> </li> <li>Request QPS: \u2265 500 req/s</li> <li>Gi\u1edbi h\u1ea1n min 2 replica, max 10 (c\u00f3 th\u1ec3 override theo tenant load)</li> </ul>"},{"location":"services/user-service/master/design/#114-du-phong-du-lieu-recovery","title":"\ud83d\udcbe 11.4. D\u1ef1 ph\u00f2ng d\u1eef li\u1ec7u &amp; recovery","text":"<ul> <li>To\u00e0n b\u1ed9 d\u1eef li\u1ec7u l\u01b0u t\u1ea1i PostgreSQL ph\u00e2n v\u00f9ng theo tenant_id.</li> <li>Backup qua Cloud SQL export \u0111\u1ecbnh k\u1ef3 (6 gi\u1edd/l\u1ea7n).</li> <li>M\u1ed7i thay \u0111\u1ed5i ng\u01b0\u1eddi d\u00f9ng \u0111\u1ec1u ph\u00e1t <code>user.updated</code> \u2192 c\u00f3 th\u1ec3 sync v\u00e0o h\u1ec7 th\u1ed1ng ph\u1ee5 nh\u01b0 CRM/LMS/SIS \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o redundancy.</li> </ul>"},{"location":"services/user-service/master/design/#115-retry-timeouts","title":"\u26a1 11.5. Retry &amp; Timeouts","text":"<ul> <li>Giao ti\u1ebfp n\u1ed9i b\u1ed9 gi\u1eefa services c\u00f3 timeout 3s + retry 2 l\u1ea7n (exponential backoff).</li> <li> <p>N\u1ebfu <code>user.master</code> kh\u00f4ng ph\u1ea3n h\u1ed3i:</p> </li> <li> <p>Gateway tr\u1ea3 l\u1ed7i <code>503</code> v\u1edbi m\u00e3 <code>user.service_unavailable</code></p> </li> <li>Ghi log + emit alert</li> </ul>"},{"location":"services/user-service/master/design/#116-rollback-observability","title":"\ud83d\udd04 11.6. Rollback &amp; Observability","text":"<ul> <li>N\u1ebfu rollout l\u1ed7i (readiness probe fail &gt; 20s), t\u1ef1 \u0111\u1ed9ng rollback v\u1ec1 version tr\u01b0\u1edbc.</li> <li>T\u00edch h\u1ee3p OpenTelemetry \u0111\u1ec3 debug l\u1ed7i multi-hop: t\u1eeb gateway \u2192 auth \u2192 user.</li> </ul>"},{"location":"services/user-service/master/design/#12-hieu-nang-kha-nang-mo-rong","title":"12. \u26a1\ufe0f Hi\u1ec7u n\u0103ng &amp; Kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng","text":"<p><code>user-service/master</code> \u0111\u01b0\u1ee3c thi\u1ebft k\u1ebf \u0111\u1ec3 ph\u1ee5c v\u1ee5 truy v\u1ea5n user to\u00e0n c\u1ee5c \u0111a tenant, v\u1edbi kh\u1ea3 n\u0103ng scale linh ho\u1ea1t v\u00e0 \u0111\u00e1p \u1ee9ng h\u00e0ng tri\u1ec7u b\u1ea3n ghi. M\u1ecdi th\u00e0nh ph\u1ea7n t\u1eeb l\u01b0u tr\u1eef, cache \u0111\u1ebfn API \u0111\u1ec1u \u0111\u01b0\u1ee3c t\u1ed1i \u01b0u \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o throughput cao, latency th\u1ea5p v\u00e0 h\u1ed7 tr\u1ee3 m\u1edf r\u1ed9ng theo chi\u1ec1u ngang.</p>"},{"location":"services/user-service/master/design/#121-truy-van-toi-uu-indexing","title":"\u26a1 12.1. Truy v\u1ea5n t\u1ed1i \u01b0u &amp; indexing","text":"<ul> <li> <p>C\u00e1c API th\u01b0\u1eddng xuy\u00ean s\u1eed d\u1ee5ng nh\u01b0:</p> </li> <li> <p><code>GET /users-global/by-email</code></p> </li> <li><code>GET /users-global/by-phone</code></li> <li><code>GET /users-global/{id}</code>     \u0111\u1ec1u \u0111\u01b0\u1ee3c t\u1ed1i \u01b0u th\u00f4ng qua index ph\u1ee9c h\u1ee3p (<code>email, tenant_id</code>, <code>phone_number, tenant_id</code>).</li> <li>C\u01a1 ch\u1ebf filter s\u1eed d\u1ee5ng <code>tenant_id</code> nh\u01b0 \u0111i\u1ec1u ki\u1ec7n b\u1eaft bu\u1ed9c \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o query nhanh v\u00e0 c\u00e1ch ly d\u1eef li\u1ec7u.</li> </ul>"},{"location":"services/user-service/master/design/#122-caching-thong-minh","title":"\ud83e\udde0 12.2. Caching th\u00f4ng minh","text":"<ul> <li>Redis layer \u0111\u1ec3 cache c\u00e1c b\u1ea3n ghi ng\u01b0\u1eddi d\u00f9ng ph\u1ed5 bi\u1ebfn (d\u1ef1a v\u00e0o LRU ho\u1eb7c Top-K queries).</li> <li>TTL m\u1eb7c \u0111\u1ecbnh: 15 ph\u00fat. C\u00f3 c\u01a1 ch\u1ebf invalidate khi c\u00f3 <code>user.updated</code>.</li> <li> <p>D\u1eef li\u1ec7u cache:</p> </li> <li> <p><code>user_id \u2192 profile</code></p> </li> <li><code>email/phone \u2192 user_id</code></li> <li>C\u01a1 ch\u1ebf warming cache khi kh\u1edfi \u0111\u1ed9ng \u0111\u1ec3 t\u0103ng cold-start performance.</li> </ul>"},{"location":"services/user-service/master/design/#123-ho-tro-phan-trang-lon-deep-pagination","title":"\ud83d\ude80 12.3. H\u1ed7 tr\u1ee3 ph\u00e2n trang l\u1edbn (deep pagination)","text":"<ul> <li>D\u00f9ng c\u01a1 ch\u1ebf seek-based pagination (trang theo <code>created_at</code> ho\u1eb7c <code>user_id</code>) \u0111\u1ec3 tr\u00e1nh hi\u1ec7u n\u0103ng k\u00e9m khi offset l\u1edbn.</li> <li>Default limit: 20. Max limit: 1000.</li> <li>C\u00f3 h\u1ed7 tr\u1ee3 c\u1ea3 offset pagination cho use-case qu\u1ea3n tr\u1ecb vi\u00ean.</li> </ul>"},{"location":"services/user-service/master/design/#124-horizontal-scaling","title":"\u2699\ufe0f 12.4. Horizontal Scaling","text":"<ul> <li>Service stateless \u2192 c\u00f3 th\u1ec3 scale theo replica (tu\u00e2n th\u1ee7 ADR-016)</li> <li> <p>Redis + PostgreSQL c\u00f3 th\u1ec3 t\u00e1ch c\u1ee5m theo workload:</p> </li> <li> <p>Redis: scale theo s\u1ed1 l\u01b0\u1ee3ng hot user</p> </li> <li>Postgres: c\u00f3 th\u1ec3 sharding theo <code>tenant_id</code> n\u1ebfu v\u01b0\u1ee3t qu\u00e1 ng\u01b0\u1ee1ng</li> </ul>"},{"location":"services/user-service/master/design/#125-theo-doi-hieu-nang","title":"\ud83d\udcc9 12.5. Theo d\u00f5i hi\u1ec7u n\u0103ng","text":"<ul> <li> <p>Metrics Prometheus:</p> </li> <li> <p><code>http_request_duration_seconds</code></p> </li> <li><code>user.lookup_latency_p95</code></li> <li><code>db_user_query_duration_seconds</code></li> <li> <p>C\u1ea3nh b\u00e1o n\u1ebfu:</p> </li> <li> <p><code>P95 &gt; 200ms</code> trong 5 ph\u00fat</p> </li> <li><code>cache_miss_rate &gt; 30%</code> trong 10 ph\u00fat</li> </ul>"},{"location":"services/user-service/master/design/#126-benchmark-load-test","title":"\ud83e\uddea 12.6. Benchmark &amp; Load test","text":"<ul> <li> <p>D\u00f9ng <code>k6</code> \u0111\u1ec3 test v\u1edbi 1 tri\u1ec7u user, 1000 req/s trong 10 ph\u00fat:</p> </li> <li> <p><code>P95 &lt; 150ms</code>, <code>success_rate &gt; 99.9%</code></p> </li> <li> <p>Test profile:</p> </li> <li> <p>90% <code>GET</code></p> </li> <li>8% <code>POST</code></li> <li>2% <code>PATCH</code></li> </ul>"},{"location":"services/user-service/master/design/#13-kien-truc-service","title":"13. \ud83e\udde9 Ki\u1ebfn tr\u00fac Service","text":"<p><code>user-service/master</code> l\u00e0 m\u1ed9t th\u00e0nh ph\u1ea7n core multi-tenant, ch\u1ecbu tr\u00e1ch nhi\u1ec7m qu\u1ea3n l\u00fd danh t\u00ednh to\u00e0n c\u1ee5c cho ng\u01b0\u1eddi d\u00f9ng tr\u00ean to\u00e0n h\u1ec7 th\u1ed1ng VAS, bao g\u1ed3m: ID \u0111\u1ecbnh danh, t\u00e0i kho\u1ea3n g\u1ed1c, v\u00e0 th\u00f4ng tin li\u00ean k\u1ebft gi\u1eefa ng\u01b0\u1eddi d\u00f9ng v\u1edbi c\u00e1c tenant. Service n\u00e0y ho\u1ea1t \u0111\u1ed9ng \u0111\u1ed9c l\u1eadp v\u1edbi c\u00e1c sub-service tenant-specific, v\u00e0 l\u00e0 ngu\u1ed3n d\u1eef li\u1ec7u g\u1ed1c ph\u1ee5c v\u1ee5 <code>auth-service/master</code>, <code>token-service</code> v\u00e0 h\u1ec7 th\u1ed1ng SMS m\u1edbi t\u00edch h\u1ee3p.</p>"},{"location":"services/user-service/master/design/#131-so-o-kien-truc-cap-nhat-tuan-cr-04","title":"\ud83e\udded 13.1. S\u01a1 \u0111\u1ed3 ki\u1ebfn tr\u00fac c\u1eadp nh\u1eadt (tu\u00e2n CR-04)","text":"<pre><code>flowchart TD\n  subgraph Core Services\n    GATEWAY[API Gateway]\n    AUTH_MASTER[Auth Service - Master]\n    USER_MASTER[User Service - Master]\n    TOKEN[Token Service]\n    AUDIT[Audit Logging Service]\n  end\n\n  subgraph Data Layer\n    PG_GLOBAL[(PostgreSQL - Global)]\n    REDIS[(Redis)]\n  end\n\n  subgraph Tenant System\n    SMS[(School Management System)]\n  end\n\n  GATEWAY --&gt;|JWT + RBAC + X-Tenant-ID| AUTH_MASTER\n  GATEWAY --&gt;|RBAC + Route| USER_MASTER\n\n  AUTH_MASTER --&gt;|Lookup user| USER_MASTER\n  USER_MASTER --&gt;|Read/write| PG_GLOBAL\n  USER_MASTER --&gt;|Cache email/user_id| REDIS\n  USER_MASTER --&gt;|Emit user.created/updated| PUBSUB[(Pub/Sub)]\n  USER_MASTER --&gt; AUDIT\n\n  PUBSUB --&gt; SMS\n</code></pre>"},{"location":"services/user-service/master/design/#132-thanh-phan-chinh","title":"\ud83e\udde9 13.2. Th\u00e0nh ph\u1ea7n ch\u00ednh","text":"Th\u00e0nh ph\u1ea7n Vai tr\u00f2 <code>FastAPI</code> Framework tri\u1ec3n khai HTTP API <code>PostgreSQL</code> (global) L\u01b0u tr\u1eef ch\u00ednh th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c <code>Redis</code> T\u0103ng t\u1ed1c truy xu\u1ea5t <code>email \u2192 user_id</code>, <code>user_id \u2192 profile</code> <code>Pub/Sub</code> Ph\u00e1t s\u1ef1 ki\u1ec7n cho c\u00e1c h\u1ec7 th\u1ed1ng downstream nh\u01b0 <code>SMS</code> <code>Audit Logging</code> Ghi nh\u1eadn thay \u0111\u1ed5i user ph\u1ee5c v\u1ee5 ki\u1ec3m tra v\u00e0 compliance"},{"location":"services/user-service/master/design/#133-cau-truc-thu-muc","title":"\u2699\ufe0f 13.3. C\u1ea5u tr\u00fac th\u01b0 m\u1ee5c","text":"<pre><code>user-service/\n\u251c\u2500\u2500 main.py                  # Entry point ch\u00ednh\n\u251c\u2500\u2500 api/                     # Router FastAPI\n\u2502   \u251c\u2500\u2500 global_users.py      # \u0110\u1ecbnh ngh\u0129a endpoint /users-global/*\n\u251c\u2500\u2500 models/                  # ORM models\n\u251c\u2500\u2500 schemas/                 # Request/response schemas\n\u251c\u2500\u2500 services/                # Business logic: user creation, update, conflict detection\n\u251c\u2500\u2500 events/                  # Emit Pub/Sub events\n\u251c\u2500\u2500 core/                    # C\u1ea5u h\u00ecnh, middleware, utils\n\u2514\u2500\u2500 tests/                   # Ki\u1ec3m th\u1eed unit &amp; integration\n</code></pre>"},{"location":"services/user-service/master/design/#134-giao-tiep-tich-hop","title":"\ud83d\udd04 13.4. Giao ti\u1ebfp &amp; t\u00edch h\u1ee3p","text":"D\u1ecbch v\u1ee5 M\u1ee5c \u0111\u00edch <code>auth-service/master</code> X\u00e1c th\u1ef1c ng\u01b0\u1eddi d\u00f9ng, g\u1ecdi <code>GET /users-global/by-email</code> <code>token-service</code> Cung c\u1ea5p JWT token v\u1edbi <code>user_id</code> to\u00e0n c\u1ee5c <code>API Gateway</code> \u00c1p d\u1ee5ng RBAC &amp; inject c\u00e1c header (<code>X-User-ID</code>, <code>X-Permissions</code>, <code>X-Tenant-ID</code>) <code>SMS (Tenant)</code> Ti\u00eau th\u1ee5 s\u1ef1 ki\u1ec7n <code>user.created</code>, <code>user.updated</code> \u0111\u1ec3 sync user profile <code>audit-logging-service</code> Nh\u1eadn log t\u1eeb m\u1ecdi h\u00e0nh \u0111\u1ed9ng c\u1eadp nh\u1eadt, t\u1ea1o user"},{"location":"services/user-service/master/design/#135-cac-su-kien-phat-ra","title":"\ud83d\udce3 13.5. C\u00e1c s\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<p>Tu\u00e2n chu\u1ea9n \u0111\u1ecbnh danh s\u1ef1 ki\u1ec7n t\u1eeb [ADR-030: Event Schema Governance]:</p> S\u1ef1 ki\u1ec7n Khi n\u00e0o ph\u00e1t Payload <code>user.created</code> Khi t\u1ea1o user m\u1edbi to\u00e0n c\u1ee5c <code>{ user_id, email, created_by, timestamp }</code> <code>user.updated</code> Khi c\u1eadp nh\u1eadt th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng <code>{ user_id, fields_changed, updated_by }</code> <code>user.duplicated</code> Khi ph\u00e1t hi\u1ec7n tr\u00f9ng th\u00f4ng tin \u0111\u1ecbnh danh <code>{ conflict_user_ids, resolution_strategy }</code>"},{"location":"services/user-service/master/design/#14-tai-lieu-lien-quan","title":"14. T\u00e0i li\u1ec7u li\u00ean quan","text":"T\u00ean t\u00e0i li\u1ec7u M\u00f4 t\u1ea3 ng\u1eafn g\u1ecdn rbac-deep-dive.md M\u00f4 t\u1ea3 chi ti\u1ebft ki\u1ebfn tr\u00fac RBAC, c\u00e1c b\u1ea3ng li\u00ean quan v\u00e0 s\u01a1 \u0111\u1ed3 quy\u1ec1n adr-007-rbac.md Quy\u1ebft \u0111\u1ecbnh thi\u1ebft k\u1ebf ki\u1ebfn tr\u00fac RBAC ph\u00e2n t\u1ea7ng theo m\u00f4 h\u00ecnh Master-Sub adr-006-auth-strategy.md M\u00f4 t\u1ea3 chi\u1ebfn l\u01b0\u1ee3c x\u00e1c th\u1ef1c, JWT v\u00e0 vai tr\u00f2 c\u1ee7a User Service Master/Sub Data Model Chi ti\u1ebft c\u00e1c b\u1ea3ng CSDL \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd b\u1edfi User Service Master Interface Contract H\u1ee3p \u0111\u1ed3ng API \u0111\u1ecbnh ngh\u0129a r\u00f5 input/output, auth, m\u00e3 l\u1ed7i c\u1ee7a c\u00e1c endpoint OpenAPI File \u0111\u1eb7c t\u1ea3 OpenAPI k\u1ef9 thu\u1eadt d\u00f9ng \u0111\u1ec3 t\u1ea1o SDK/Client/Docs t\u1ef1 \u0111\u1ed9ng system-diagrams.md S\u01a1 \u0111\u1ed3 ki\u1ebfn tr\u00fac t\u1ed5ng th\u1ec3 h\u1ec7 th\u1ed1ng, c\u00e1c service v\u00e0 d\u00f2ng t\u01b0\u01a1ng t\u00e1c README.md T\u00e0i li\u1ec7u ki\u1ebfn tr\u00fac t\u1ed5ng quan, m\u1ee5c ti\u00eau t\u1ed5ng th\u1ec3 v\u00e0 c\u00e1c nguy\u00ean l\u00fd thi\u1ebft k\u1ebf"},{"location":"services/user-service/master/interface-contract/","title":"\ud83d\udcd8 User Service Master \u2013 Interface Contract","text":"<p>T\u00e0i li\u1ec7u n\u00e0y \u0111\u1ecbnh ngh\u0129a giao di\u1ec7n API c\u1ee7a d\u1ecbch v\u1ee5 <code>user-service/master</code>, ph\u1ee5c v\u1ee5 cho c\u00e1c h\u1ec7 th\u1ed1ng s\u1eed d\u1ee5ng to\u00e0n c\u1ee5c nh\u01b0 Superadmin Webapp, Auth Service, v\u00e0 c\u00e1c Sub Service. D\u1ecbch v\u1ee5 n\u00e0y ch\u1ecbu tr\u00e1ch nhi\u1ec7m qu\u1ea3n l\u00fd ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c, g\u00e1n ng\u01b0\u1eddi d\u00f9ng v\u00e0o tenant, v\u00e0 \u0111i\u1ec1u ph\u1ed1i RBAC template.</p>"},{"location":"services/user-service/master/interface-contract/#1-muc-ich","title":"1. \ud83c\udfaf M\u1ee5c \u0111\u00edch","text":"<p>Cung c\u1ea5p c\u00e1c API \u0111\u1ec3: - Tra c\u1ee9u ho\u1eb7c t\u1ea1o ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c theo t\u1eebng provider. - T\u1ea1o v\u00e0 qu\u1ea3n l\u00fd tenant (tr\u01b0\u1eddng h\u1ecdc). - G\u00e1n ng\u01b0\u1eddi d\u00f9ng v\u00e0o tenant c\u1ee5 th\u1ec3. - Qu\u1ea3n l\u00fd h\u1ec7 th\u1ed1ng role/permission template to\u00e0n c\u1ee5c ph\u1ee5c v\u1ee5 RBAC ph\u00e2n t\u1ea7ng. - Ph\u00e1t s\u1ef1 ki\u1ec7n \u0111\u1ec3 \u0111\u1ed3ng b\u1ed9 h\u00f3a t\u1edbi c\u00e1c Sub Service.</p>"},{"location":"services/user-service/master/interface-contract/#2-pham-vi-oi-tuong-su-dung","title":"2. \ud83e\udded Ph\u1ea1m vi &amp; \u0110\u1ed1i t\u01b0\u1ee3ng s\u1eed d\u1ee5ng","text":"\u0110\u1ed1i t\u01b0\u1ee3ng g\u1ecdi API M\u1ee5c \u0111\u00edch Superadmin Webapp Qu\u1ea3n l\u00fd ng\u01b0\u1eddi d\u00f9ng &amp; ph\u00e2n quy\u1ec1n to\u00e0n c\u1ee5c Auth Service Tra c\u1ee9u ho\u1eb7c t\u1ea1o ng\u01b0\u1eddi d\u00f9ng khi login Sub User Service \u0110\u1ed3ng b\u1ed9 danh s\u00e1ch assignment, RBAC template"},{"location":"services/user-service/master/interface-contract/#3-phan-loai-api","title":"3. \ud83d\udcc2 Ph\u00e2n lo\u1ea1i API","text":"Nh\u00f3m ch\u1ee9c n\u0103ng M\u00f4 t\u1ea3 User Lookup Tra c\u1ee9u ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c User Creation T\u1ea1o ng\u01b0\u1eddi d\u00f9ng m\u1edbi theo provider Tenant Mgmt T\u1ea1o v\u00e0 qu\u1ea3n l\u00fd tenant Assignment G\u00e1n user v\u00e0o tenant RBAC Template Qu\u1ea3n l\u00fd role/permission m\u1eabu to\u00e0n c\u1ee5c Event Emit Ph\u00e1t s\u1ef1 ki\u1ec7n Pub/Sub theo ti\u00eau chu\u1ea9n ADR-030"},{"location":"services/user-service/master/interface-contract/#4-danh-sach-endpoint-chinh","title":"4. \ud83d\udccb Danh s\u00e1ch endpoint ch\u00ednh","text":"Method Path M\u00f4 t\u1ea3 ng\u1eafn Quy\u1ec1n y\u00eau c\u1ea7u GET <code>/users-global/by-email</code> Tra c\u1ee9u ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c theo email + auth_provider <code>user.read</code> POST <code>/users-global</code> T\u1ea1o ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c n\u1ebfu ch\u01b0a t\u1ed3n t\u1ea1i <code>user.create</code> GET <code>/tenants</code> Li\u1ec7t k\u00ea c\u00e1c tenant hi\u1ec7n c\u00f3 <code>tenant.read</code> POST <code>/tenants</code> T\u1ea1o tenant m\u1edbi (ch\u1ec9 d\u00f9ng cho Superadmin) <code>tenant.create</code> GET <code>/user-tenant-assignments</code> Li\u1ec7t k\u00ea c\u00e1c tenant m\u00e0 m\u1ed9t user \u0111\u00e3 \u0111\u01b0\u1ee3c g\u00e1n <code>tenant_user.read</code> POST <code>/user-tenant-assignments</code> G\u00e1n ng\u01b0\u1eddi d\u00f9ng v\u00e0o tenant c\u1ee5 th\u1ec3 <code>tenant_user.assign</code> GET <code>/global-roles-templates</code> Li\u1ec7t k\u00ea c\u00e1c role template to\u00e0n c\u1ee5c <code>rbac.template.read</code> POST <code>/global-roles-templates</code> T\u1ea1o role template m\u1edbi to\u00e0n c\u1ee5c <code>rbac.template.create</code> GET <code>/global-permissions-templates</code> Li\u1ec7t k\u00ea c\u00e1c permission template to\u00e0n c\u1ee5c <code>rbac.template.read</code> POST <code>/global-permissions-templates</code> T\u1ea1o permission template m\u1edbi to\u00e0n c\u1ee5c <code>rbac.template.create</code> PATCH <code>/global-roles-templates/{template_key}</code> C\u1eadp nh\u1eadt danh s\u00e1ch quy\u1ec1n trong m\u1ed9t role template c\u1ee5 th\u1ec3 <code>rbac.template.update</code> PATCH <code>/global-permissions-templates/{perm_key}</code> C\u1eadp nh\u1eadt m\u00f4 t\u1ea3 ho\u1eb7c scope c\u1ee7a permission template <code>rbac.template.update</code>"},{"location":"services/user-service/master/interface-contract/#5-chi-tiet-tung-api","title":"5. \ud83d\udccc Chi ti\u1ebft t\u1eebng API","text":""},{"location":"services/user-service/master/interface-contract/#51-get-users-globalby-email","title":"5.1. <code>GET /users-global/by-email</code>","text":"<p>Tra c\u1ee9u ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c theo <code>email</code> v\u00e0 <code>auth_provider</code>. \u0110\u01b0\u1ee3c s\u1eed d\u1ee5ng b\u1edfi Auth Service \u0111\u1ec3 ki\u1ec3m tra ng\u01b0\u1eddi d\u00f9ng \u0111\u00e3 t\u1ed3n t\u1ea1i hay ch\u01b0a tr\u01b0\u1edbc khi t\u1ea1o m\u1edbi.</p>"},{"location":"services/user-service/master/interface-contract/#request","title":"\ud83d\udce5 Request","text":"<p>Query parameters: - <code>email</code> (string, b\u1eaft bu\u1ed9c) \u2013 email ng\u01b0\u1eddi d\u00f9ng c\u1ea7n tra c\u1ee9u - <code>auth_provider</code> (enum, b\u1eaft bu\u1ed9c) \u2013 nh\u00e0 cung c\u1ea5p x\u00e1c th\u1ef1c   Gi\u00e1 tr\u1ecb h\u1ee3p l\u1ec7: <code>\"google\"</code>, <code>\"local\"</code>, <code>\"otp\"</code></p> <p>Headers: - <code>Authorization: Bearer &lt;JWT&gt;</code></p>"},{"location":"services/user-service/master/interface-contract/#response","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"data\": {\n    \"id\": \"usr_abc123\",\n    \"email\": \"alice@vas.edu.vn\",\n    \"auth_provider\": \"google\",\n    \"full_name\": \"Alice B\",\n    \"status\": \"active\",\n    \"created_at\": \"2025-06-01T12:00:00Z\"\n  },\n  \"meta\": {\n    \"trace_id\": \"abc-xyz\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#phan-quyen-ieu-kien","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"<ul> <li>Y\u00eau c\u1ea7u: Bearer JWT h\u1ee3p l\u1ec7 (do Token Service ph\u00e1t h\u00e0nh)</li> <li>Quy\u1ec1n: <code>user.read</code> (global scope)</li> <li> <p>\u0110i\u1ec1u ki\u1ec7n:</p> </li> <li> <p><code>auth_provider</code> ph\u1ea3i h\u1ee3p l\u1ec7</p> </li> <li>Truy c\u1eadp t\u1eeb service \u0111\u01b0\u1ee3c c\u1ea5p quy\u1ec1n truy v\u1ea5n to\u00e0n c\u1ee5c (v\u00ed d\u1ee5: Auth Master)</li> </ul>"},{"location":"services/user-service/master/interface-contract/#su-kien-phat-ra","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li>\u274c Kh\u00f4ng ph\u00e1t s\u1ef1 ki\u1ec7n.   \u0110\u00e2y l\u00e0 thao t\u00e1c tra c\u1ee9u (read-only).</li> </ul>"},{"location":"services/user-service/master/interface-contract/#ma-loi-co-the-tra-ve","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 400 Thi\u1ebfu <code>email</code> ho\u1eb7c <code>auth_provider</code>, sai \u0111\u1ecbnh d\u1ea1ng 401 Thi\u1ebfu ho\u1eb7c JWT kh\u00f4ng h\u1ee3p l\u1ec7 403 Kh\u00f4ng c\u00f3 quy\u1ec1n <code>user.read</code> 404 Kh\u00f4ng t\u00ecm th\u1ea5y ng\u01b0\u1eddi d\u00f9ng ph\u00f9 h\u1ee3p 422 Gi\u00e1 tr\u1ecb <code>auth_provider</code> kh\u00f4ng h\u1ee3p l\u1ec7"},{"location":"services/user-service/master/interface-contract/#goi-y-kiem-thu","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>\u2705 Truy v\u1ea5n user h\u1ee3p l\u1ec7 \u2192 tr\u1ea3 v\u1ec1 th\u00f4ng tin ch\u00ednh x\u00e1c</li> <li>\u274c Truy v\u1ea5n email kh\u00f4ng t\u1ed3n t\u1ea1i \u2192 tr\u1ea3 <code>404</code></li> <li>\u274c Thi\u1ebfu <code>auth_provider</code> \u2192 tr\u1ea3 <code>400</code></li> <li>\u274c S\u1eed d\u1ee5ng JWT kh\u00f4ng c\u00f3 quy\u1ec1n <code>user.read</code> \u2192 tr\u1ea3 <code>403</code></li> <li>\u2705 Log trace_id trong <code>meta</code> \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o observability</li> </ul>"},{"location":"services/user-service/master/interface-contract/#52-post-users-global","title":"5.2. <code>POST /users-global</code>","text":"<p>T\u1ea1o ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c m\u1edbi n\u1ebfu ch\u01b0a t\u1ed3n t\u1ea1i, d\u1ef1a tr\u00ean <code>email</code> v\u00e0 <code>auth_provider</code>. S\u1eed d\u1ee5ng b\u1edfi Auth Service ho\u1eb7c Superadmin \u0111\u1ec3 kh\u1edfi t\u1ea1o ng\u01b0\u1eddi d\u00f9ng global trong l\u1ea7n \u0111\u0103ng nh\u1eadp \u0111\u1ea7u ti\u00ean.</p>"},{"location":"services/user-service/master/interface-contract/#request_1","title":"\ud83d\udce5 Request","text":"<p>Headers: - <code>Authorization: Bearer &lt;JWT&gt;</code></p> <p>Request body (JSON): <pre><code>{\n  \"email\": \"alice@vas.edu.vn\",\n  \"auth_provider\": \"google\",\n  \"full_name\": \"Alice B\"\n}\n</code></pre></p> <p>Field m\u00f4 t\u1ea3:</p> <ul> <li><code>email</code> (string, b\u1eaft bu\u1ed9c): email ng\u01b0\u1eddi d\u00f9ng, duy nh\u1ea5t theo <code>auth_provider</code></li> <li><code>auth_provider</code> (enum, b\u1eaft bu\u1ed9c): <code>\"google\"</code> | <code>\"local\"</code> | <code>\"otp\"</code></li> <li><code>full_name</code> (string, t\u00f9y ch\u1ecdn): t\u00ean \u0111\u1ea7y \u0111\u1ee7</li> </ul>"},{"location":"services/user-service/master/interface-contract/#response_1","title":"\ud83d\udce4 Response","text":"<p>201 Created</p> <pre><code>{\n  \"data\": {\n    \"id\": \"usr_xyz789\",\n    \"email\": \"alice@vas.edu.vn\",\n    \"auth_provider\": \"google\",\n    \"full_name\": \"Alice B\",\n    \"status\": \"active\"\n  },\n  \"meta\": {\n    \"trace_id\": \"abc-xyz\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#phan-quyen-ieu-kien_1","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"<ul> <li>Y\u00eau c\u1ea7u: Bearer JWT h\u1ee3p l\u1ec7</li> <li>Quy\u1ec1n: <code>user.create</code> (global scope)</li> <li> <p>\u0110i\u1ec1u ki\u1ec7n:</p> </li> <li> <p>N\u1ebfu user \u0111\u00e3 t\u1ed3n t\u1ea1i \u2192 tr\u1ea3 <code>409</code></p> </li> <li>Ph\u1ea3i x\u00e1c th\u1ef1c qua Auth Service c\u00f3 quy\u1ec1n global</li> </ul>"},{"location":"services/user-service/master/interface-contract/#su-kien-phat-ra_1","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li><code>user_global_created</code>   Schema: <code>vas.user.created.v1</code>   N\u1ed9i dung ch\u1ee9a: <code>user_id</code>, <code>email</code>, <code>auth_provider</code>, <code>created_at</code></li> </ul>"},{"location":"services/user-service/master/interface-contract/#ma-loi-co-the-tra-ve_1","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 400 Thi\u1ebfu field b\u1eaft bu\u1ed9c (<code>email</code>, <code>auth_provider</code>) 401 Thi\u1ebfu JWT ho\u1eb7c kh\u00f4ng h\u1ee3p l\u1ec7 403 Kh\u00f4ng c\u00f3 quy\u1ec1n <code>user.create</code> 409 Ng\u01b0\u1eddi d\u00f9ng \u0111\u00e3 t\u1ed3n t\u1ea1i 422 <code>auth_provider</code> kh\u00f4ng h\u1ee3p l\u1ec7"},{"location":"services/user-service/master/interface-contract/#goi-y-kiem-thu_1","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>\u2705 T\u1ea1o user m\u1edbi v\u1edbi email + provider h\u1ee3p l\u1ec7 \u2192 tr\u1ea3 201 + event</li> <li>\u274c T\u1ea1o tr\u00f9ng user \u2192 tr\u1ea3 409</li> <li>\u274c Thi\u1ebfu <code>email</code> ho\u1eb7c <code>auth_provider</code> \u2192 tr\u1ea3 400</li> <li>\u2705 Ki\u1ec3m tra s\u1ef1 ki\u1ec7n <code>user_global_created</code> \u0111\u01b0\u1ee3c ph\u00e1t \u0111\u00fang schema</li> <li>\u2705 G\u1ecdi 2 l\u1ea7n li\u00ean ti\u1ebfp \u2192 ch\u1ec9 1 record \u0111\u01b0\u1ee3c t\u1ea1o (idempotency ki\u1ec3m so\u00e1t b\u1eb1ng unique key)</li> </ul>"},{"location":"services/user-service/master/interface-contract/#53-get-tenants","title":"5.3. <code>GET /tenants</code>","text":"<p>Li\u1ec7t k\u00ea danh s\u00e1ch t\u1ea5t c\u1ea3 c\u00e1c tenant (tr\u01b0\u1eddng h\u1ecdc) hi\u1ec7n c\u00f3 trong h\u1ec7 th\u1ed1ng. Endpoint n\u00e0y \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng b\u1edfi Superadmin Webapp v\u00e0 c\u00e1c h\u1ec7 th\u1ed1ng \u0111\u1ed3ng b\u1ed9 (Sub Service, SMS) \u0111\u1ec3 tra c\u1ee9u danh s\u00e1ch tenant to\u00e0n c\u1ee5c.</p>"},{"location":"services/user-service/master/interface-contract/#request_2","title":"\ud83d\udce5 Request","text":"<p>Headers: - <code>Authorization: Bearer &lt;JWT&gt;</code></p> <p>Query parameters (tu\u1ef3 ch\u1ecdn): - <code>page</code>: s\u1ed1 trang (default = 1) - <code>page_size</code>: s\u1ed1 l\u01b0\u1ee3ng b\u1ea3n ghi m\u1ed7i trang (default = 20, t\u1ed1i \u0111a 100) - <code>search</code>: chu\u1ed7i t\u00ecm ki\u1ebfm theo <code>name</code> ho\u1eb7c <code>project_id</code> (optional)</p>"},{"location":"services/user-service/master/interface-contract/#response_2","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"data\": [\n    {\n      \"id\": \"tenant_abc123\",\n      \"name\": \"Tr\u01b0\u1eddng Vi\u1ec7t Anh\",\n      \"project_id\": \"vas-tenant-001\",\n      \"created_at\": \"2025-06-01T12:00:00Z\"\n    }\n  ],\n  \"meta\": {\n    \"page\": 1,\n    \"page_size\": 20,\n    \"total\": 5,\n    \"trace_id\": \"abc-xyz\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#phan-quyen-ieu-kien_2","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"<ul> <li>Y\u00eau c\u1ea7u: Bearer JWT h\u1ee3p l\u1ec7</li> <li>Quy\u1ec1n: <code>tenant.read</code></li> <li> <p>\u0110i\u1ec1u ki\u1ec7n:</p> </li> <li> <p>Ch\u1ec9 c\u00f3 Superadmin ho\u1eb7c h\u1ec7 th\u1ed1ng trung t\u00e2m m\u1edbi \u0111\u01b0\u1ee3c xem t\u1ea5t c\u1ea3 tenant</p> </li> </ul>"},{"location":"services/user-service/master/interface-contract/#su-kien-phat-ra_2","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li>\u274c Kh\u00f4ng ph\u00e1t sinh s\u1ef1 ki\u1ec7n \u2013 thao t\u00e1c \u0111\u1ecdc d\u1eef li\u1ec7u</li> </ul>"},{"location":"services/user-service/master/interface-contract/#ma-loi-co-the-tra-ve_2","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 401 Kh\u00f4ng c\u00f3 ho\u1eb7c JWT kh\u00f4ng h\u1ee3p l\u1ec7 403 Kh\u00f4ng c\u00f3 quy\u1ec1n <code>tenant.read</code> 422 Tham s\u1ed1 <code>page</code>, <code>page_size</code> kh\u00f4ng h\u1ee3p l\u1ec7"},{"location":"services/user-service/master/interface-contract/#goi-y-kiem-thu_2","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>\u2705 G\u1ecdi v\u1edbi quy\u1ec1n <code>tenant.read</code> h\u1ee3p l\u1ec7 \u2192 tr\u1ea3 danh s\u00e1ch tenant</li> <li>\u274c G\u1ecdi kh\u00f4ng JWT ho\u1eb7c quy\u1ec1n kh\u00f4ng \u0111\u00fang \u2192 tr\u1ea3 401 / 403</li> <li>\u2705 Ki\u1ec3m tra paging ho\u1ea1t \u0111\u1ed9ng \u0111\u00fang (meta.total, meta.page)</li> <li>\u2705 Ki\u1ec3m tra filter <code>search</code> tr\u1ea3 v\u1ec1 \u0111\u00fang tenant li\u00ean quan</li> <li>\u2705 Log trace_id trong m\u1ed7i ph\u1ea3n h\u1ed3i</li> </ul>"},{"location":"services/user-service/master/interface-contract/#54-post-tenants","title":"5.4. <code>POST /tenants</code>","text":"<p>T\u1ea1o m\u1edbi m\u1ed9t tenant (tr\u01b0\u1eddng h\u1ecdc) trong h\u1ec7 th\u1ed1ng. Ch\u1ec9 \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng b\u1edfi Superadmin Webapp \u0111\u1ec3 kh\u1edfi t\u1ea1o m\u00f4i tr\u01b0\u1eddng \u0111\u1ed9c l\u1eadp cho m\u1ed9t tr\u01b0\u1eddng. Sau khi t\u1ea1o, s\u1ebd ph\u00e1t s\u1ef1 ki\u1ec7n <code>tenant_created</code> \u0111\u1ec3 c\u00e1c Sub Service (Auth, User, Notification, SMS...) kh\u1edfi t\u1ea1o stack t\u01b0\u01a1ng \u1ee9ng.</p>"},{"location":"services/user-service/master/interface-contract/#request_3","title":"\ud83d\udce5 Request","text":"<p>Headers: - <code>Authorization: Bearer &lt;JWT&gt;</code></p> <p>Request body (JSON): <pre><code>{\n  \"name\": \"Tr\u01b0\u1eddng Vi\u1ec7t Anh\",\n  \"project_id\": \"vas-tenant-001\"\n}\n</code></pre></p> <p>M\u00f4 t\u1ea3 tr\u01b0\u1eddng d\u1eef li\u1ec7u:</p> <ul> <li><code>name</code> (string, b\u1eaft bu\u1ed9c): t\u00ean hi\u1ec3n th\u1ecb c\u1ee7a tenant (v\u00ed d\u1ee5: \u201cTr\u01b0\u1eddng Vi\u1ec7t Anh\u201d)</li> <li><code>project_id</code> (string, b\u1eaft bu\u1ed9c): m\u00e3 duy nh\u1ea5t d\u00f9ng \u0111\u1ec3 c\u1ea5u h\u00ecnh m\u00f4i tr\u01b0\u1eddng (cloud resource, codebase,...)</li> </ul>"},{"location":"services/user-service/master/interface-contract/#response_3","title":"\ud83d\udce4 Response","text":"<p>201 Created</p> <pre><code>{\n  \"data\": {\n    \"id\": \"tenant_xyz789\",\n    \"name\": \"Tr\u01b0\u1eddng Vi\u1ec7t Anh\",\n    \"project_id\": \"vas-tenant-001\",\n    \"created_at\": \"2025-06-13T08:00:00Z\"\n  },\n  \"meta\": {\n    \"trace_id\": \"abc-xyz\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#phan-quyen-ieu-kien_3","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"<ul> <li>Y\u00eau c\u1ea7u: Bearer JWT h\u1ee3p l\u1ec7</li> <li>Quy\u1ec1n: <code>tenant.create</code></li> <li> <p>\u0110i\u1ec1u ki\u1ec7n:</p> </li> <li> <p><code>project_id</code> ph\u1ea3i duy nh\u1ea5t to\u00e0n h\u1ec7 th\u1ed1ng (unique index)</p> </li> <li>Ch\u1ec9 Superadmin c\u00f3 quy\u1ec1n g\u1ecdi</li> </ul>"},{"location":"services/user-service/master/interface-contract/#su-kien-phat-ra_3","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li><code>tenant_created</code>   Schema: <code>vas.tenant.created.v1</code>   Payload: <code>{ tenant_id, name, project_id, created_at }</code>   Consumer: t\u1ea5t c\u1ea3 c\u00e1c Sub Service kh\u1edfi t\u1ea1o schema, role mapping theo tenant m\u1edbi</li> </ul>"},{"location":"services/user-service/master/interface-contract/#ma-loi-co-the-tra-ve_3","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 400 Thi\u1ebfu <code>name</code> ho\u1eb7c <code>project_id</code> 401 Thi\u1ebfu ho\u1eb7c sai JWT 403 Kh\u00f4ng c\u00f3 quy\u1ec1n <code>tenant.create</code> 409 <code>project_id</code> \u0111\u00e3 t\u1ed3n t\u1ea1i 422 <code>project_id</code> sai \u0111\u1ecbnh d\u1ea1ng (<code>snake-case</code> y\u00eau c\u1ea7u)"},{"location":"services/user-service/master/interface-contract/#goi-y-kiem-thu_3","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>\u2705 T\u1ea1o tenant v\u1edbi <code>project_id</code> h\u1ee3p l\u1ec7 \u2192 tr\u1ea3 201 + ph\u00e1t event</li> <li>\u274c G\u1ecdi l\u1eb7p l\u1ea1i v\u1edbi <code>project_id</code> \u0111\u00e3 t\u1ed3n t\u1ea1i \u2192 tr\u1ea3 409</li> <li>\u274c Thi\u1ebfu JWT ho\u1eb7c quy\u1ec1n \u2192 tr\u1ea3 401 / 403</li> <li>\u2705 Ki\u1ec3m tra log trace_id trong meta</li> <li>\u2705 Ki\u1ec3m tra Sub Service nh\u1eadn event v\u00e0 t\u1ea1o schema \u0111\u00fang</li> </ul>"},{"location":"services/user-service/master/interface-contract/#55-get-user-tenant-assignments","title":"5.5. <code>GET /user-tenant-assignments</code>","text":"<p>Li\u1ec7t k\u00ea t\u1ea5t c\u1ea3 c\u00e1c tenant m\u00e0 m\u1ed9t ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c \u0111\u00e3 \u0111\u01b0\u1ee3c g\u00e1n v\u00e0o. \u0110\u01b0\u1ee3c s\u1eed d\u1ee5ng b\u1edfi Auth Service trong qu\u00e1 tr\u00ecnh x\u00e1c \u0111\u1ecbnh \u201cscope\u201d khi login, ho\u1eb7c b\u1edfi Superadmin \u0111\u1ec3 ki\u1ec3m tra tr\u1ea1ng th\u00e1i ph\u00e2n quy\u1ec1n.</p>"},{"location":"services/user-service/master/interface-contract/#request_4","title":"\ud83d\udce5 Request","text":"<p>Headers: - <code>Authorization: Bearer &lt;JWT&gt;</code></p> <p>Query parameters: - <code>user_global_id</code> (string, b\u1eaft bu\u1ed9c): ID ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c c\u1ea7n truy v\u1ea5n - <code>status</code> (optional): <code>active</code> | <code>revoked</code></p>"},{"location":"services/user-service/master/interface-contract/#response_4","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"data\": [\n    {\n      \"tenant_id\": \"tenant_abc123\",\n      \"project_id\": \"vas-tenant-001\",\n      \"assigned_by\": \"admin@vas.edu.vn\",\n      \"assigned_at\": \"2025-06-01T10:00:00Z\",\n      \"status\": \"active\"\n    }\n  ],\n  \"meta\": {\n    \"trace_id\": \"abc-xyz\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#phan-quyen-ieu-kien_4","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"<ul> <li>Y\u00eau c\u1ea7u: Bearer JWT h\u1ee3p l\u1ec7</li> <li>Quy\u1ec1n: <code>tenant_user.read</code></li> <li> <p>\u0110i\u1ec1u ki\u1ec7n:</p> </li> <li> <p><code>user_global_id</code> ph\u1ea3i t\u1ed3n t\u1ea1i</p> </li> <li>G\u1ecdi t\u1eeb h\u1ec7 th\u1ed1ng trung t\u00e2m c\u00f3 quy\u1ec1n truy c\u1eadp th\u00f4ng tin ph\u00e2n quy\u1ec1n to\u00e0n c\u1ee5c</li> </ul>"},{"location":"services/user-service/master/interface-contract/#su-kien-phat-ra_4","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li>\u274c Kh\u00f4ng ph\u00e1t sinh s\u1ef1 ki\u1ec7n \u2013 \u0111\u00e2y l\u00e0 thao t\u00e1c ch\u1ec9 \u0111\u1ecdc</li> </ul>"},{"location":"services/user-service/master/interface-contract/#ma-loi-co-the-tra-ve_4","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 400 Thi\u1ebfu <code>user_global_id</code> ho\u1eb7c sai \u0111\u1ecbnh d\u1ea1ng 401 Thi\u1ebfu ho\u1eb7c JWT kh\u00f4ng h\u1ee3p l\u1ec7 403 Kh\u00f4ng c\u00f3 quy\u1ec1n <code>tenant_user.read</code> 404 Kh\u00f4ng t\u00ecm th\u1ea5y ng\u01b0\u1eddi d\u00f9ng"},{"location":"services/user-service/master/interface-contract/#goi-y-kiem-thu_4","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>\u2705 G\u1ecdi h\u1ee3p l\u1ec7 \u2192 tr\u1ea3 danh s\u00e1ch tenant user \u0111\u00e3 \u0111\u01b0\u1ee3c g\u00e1n</li> <li>\u2705 G\u1ecdi v\u1edbi <code>status=revoked</code> \u2192 ch\u1ec9 tr\u1ea3 assignment \u0111\u00e3 b\u1ecb thu h\u1ed3i</li> <li>\u274c Kh\u00f4ng c\u00f3 <code>user_global_id</code> \u2192 tr\u1ea3 400</li> <li>\u2705 Ki\u1ec3m tra trace_id c\u00f3 trong ph\u1ea3n h\u1ed3i</li> <li>\u274c G\u1ecdi v\u1edbi JWT kh\u00f4ng c\u00f3 quy\u1ec1n \u2192 tr\u1ea3 403</li> </ul>"},{"location":"services/user-service/master/interface-contract/#56-post-user-tenant-assignments","title":"5.6. <code>POST /user-tenant-assignments</code>","text":"<p>G\u00e1n m\u1ed9t ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c (<code>user_global_id</code>) v\u00e0o m\u1ed9t tenant c\u1ee5 th\u1ec3. \u0110\u01b0\u1ee3c s\u1eed d\u1ee5ng b\u1edfi Superadmin \u0111\u1ec3 ph\u00e2n ng\u01b0\u1eddi d\u00f9ng (h\u1ecdc sinh, gi\u00e1o vi\u00ean, nh\u00e2n vi\u00ean) v\u00e0o tr\u01b0\u1eddng. Sau khi g\u00e1n, h\u1ec7 th\u1ed1ng s\u1ebd ph\u00e1t s\u1ef1 ki\u1ec7n \u0111\u1ec3 c\u00e1c Sub Service t\u1ea1o t\u00e0i kho\u1ea3n t\u01b0\u01a1ng \u1ee9ng cho user trong m\u00f4i tr\u01b0\u1eddng tenant.</p>"},{"location":"services/user-service/master/interface-contract/#request_5","title":"\ud83d\udce5 Request","text":"<p>Headers: - <code>Authorization: Bearer &lt;JWT&gt;</code></p> <p>Request body (JSON): <pre><code>{\n  \"user_global_id\": \"usr_abc123\",\n  \"tenant_id\": \"tenant_xyz789\",\n  \"assigned_by\": \"admin@vas.edu.vn\"\n}\n</code></pre></p> <p>M\u00f4 t\u1ea3 field:</p> <ul> <li><code>user_global_id</code> (string, b\u1eaft bu\u1ed9c): ID ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c</li> <li><code>tenant_id</code> (string, b\u1eaft bu\u1ed9c): ID tenant m\u00e0 ng\u01b0\u1eddi d\u00f9ng s\u1ebd \u0111\u01b0\u1ee3c g\u00e1n v\u00e0o</li> <li><code>assigned_by</code> (string, t\u00f9y ch\u1ecdn): email ho\u1eb7c ID c\u1ee7a ng\u01b0\u1eddi th\u1ef1c hi\u1ec7n thao t\u00e1c</li> </ul>"},{"location":"services/user-service/master/interface-contract/#response_5","title":"\ud83d\udce4 Response","text":"<p>201 Created</p> <pre><code>{\n  \"data\": {\n    \"assignment_id\": \"assign_001\",\n    \"user_global_id\": \"usr_abc123\",\n    \"tenant_id\": \"tenant_xyz789\",\n    \"status\": \"active\",\n    \"assigned_at\": \"2025-06-13T08:30:00Z\"\n  },\n  \"meta\": {\n    \"trace_id\": \"abc-xyz\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#phan-quyen-ieu-kien_5","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"<ul> <li>Y\u00eau c\u1ea7u: Bearer JWT h\u1ee3p l\u1ec7</li> <li>Quy\u1ec1n: <code>tenant_user.assign</code></li> <li> <p>\u0110i\u1ec1u ki\u1ec7n:</p> </li> <li> <p>G\u00e1n tr\u00f9ng (<code>user_global_id</code> \u0111\u00e3 thu\u1ed9c <code>tenant_id</code>) \u2192 tr\u1ea3 <code>409</code></p> </li> <li>Sub Service ch\u1ec9 \u0111\u1ed3ng b\u1ed9 khi tr\u1ea1ng th\u00e1i l\u00e0 <code>active</code></li> </ul>"},{"location":"services/user-service/master/interface-contract/#su-kien-phat-ra_5","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li><code>tenant_user_assigned</code>   Schema: <code>vas.tenant_user.assigned.v1</code>   Payload: <code>{ user_global_id, tenant_id, assigned_by, assigned_at }</code>   Consumer: Sub User Service, Auth Sub, Notification Sub, LMS Sub...</li> </ul>"},{"location":"services/user-service/master/interface-contract/#ma-loi-co-the-tra-ve_5","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 400 Thi\u1ebfu field b\u1eaft bu\u1ed9c (<code>user_global_id</code>, <code>tenant_id</code>) 401 Kh\u00f4ng c\u00f3 ho\u1eb7c sai JWT 403 Kh\u00f4ng c\u00f3 quy\u1ec1n <code>tenant_user.assign</code> 404 Kh\u00f4ng t\u00ecm th\u1ea5y user ho\u1eb7c tenant 409 Ng\u01b0\u1eddi d\u00f9ng \u0111\u00e3 \u0111\u01b0\u1ee3c g\u00e1n v\u00e0o tenant n\u00e0y"},{"location":"services/user-service/master/interface-contract/#goi-y-kiem-thu_5","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>\u2705 G\u00e1n user ch\u01b0a t\u1eebng thu\u1ed9c tenant \u2192 201 Created + ph\u00e1t event</li> <li>\u274c G\u00e1n l\u1eb7p l\u1ea1i user v\u00e0o c\u00f9ng tenant \u2192 409 Conflict</li> <li>\u2705 Ki\u1ec3m tra s\u1ef1 ki\u1ec7n <code>tenant_user_assigned</code> \u0111\u01b0\u1ee3c ph\u00e1t \u0111\u00fang schema</li> <li>\u274c G\u1ecdi thi\u1ebfu field \u2192 tr\u1ea3 400</li> <li>\u2705 G\u1ecdi sai tenant ho\u1eb7c user kh\u00f4ng t\u1ed3n t\u1ea1i \u2192 404</li> <li>\u2705 Ki\u1ec3m tra trace_id c\u00f3 trong meta ph\u1ea3n h\u1ed3i</li> </ul>"},{"location":"services/user-service/master/interface-contract/#57-get-global-roles-templates","title":"5.7. <code>GET /global-roles-templates</code>","text":"<p>Li\u1ec7t k\u00ea t\u1ea5t c\u1ea3 c\u00e1c role template to\u00e0n c\u1ee5c. \u0110\u01b0\u1ee3c s\u1eed d\u1ee5ng b\u1edfi Superadmin Webapp v\u00e0 c\u00e1c Sub Service \u0111\u1ec3 tham chi\u1ebfu khi \u00e1p d\u1ee5ng RBAC template cho user trong t\u1eebng tenant.</p>"},{"location":"services/user-service/master/interface-contract/#request_6","title":"\ud83d\udce5 Request","text":"<p>Headers: - <code>Authorization: Bearer &lt;JWT&gt;</code></p> <p>Query parameters (optional): - <code>is_system</code> (boolean): l\u1ecdc theo role m\u1eb7c \u0111\u1ecbnh h\u1ec7 th\u1ed1ng (<code>true</code>) ho\u1eb7c do ng\u01b0\u1eddi d\u00f9ng t\u1ea1o (<code>false</code>)</p>"},{"location":"services/user-service/master/interface-contract/#response_6","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"data\": [\n    {\n      \"template_key\": \"student_basic\",\n      \"name\": \"H\u1ecdc sinh c\u01a1 b\u1ea3n\",\n      \"is_system\": true,\n      \"description\": \"Quy\u1ec1n c\u01a1 b\u1ea3n cho h\u1ecdc sinh\",\n      \"permissions\": [\"report.view\", \"notification.read\"]\n    }\n  ],\n  \"meta\": {\n    \"trace_id\": \"abc-xyz\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#phan-quyen-ieu-kien_6","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"<ul> <li>Y\u00eau c\u1ea7u: Bearer JWT h\u1ee3p l\u1ec7</li> <li>Quy\u1ec1n: <code>rbac.template.read</code></li> <li> <p>\u0110i\u1ec1u ki\u1ec7n:</p> </li> <li> <p>\u0110\u01b0\u1ee3c s\u1eed d\u1ee5ng trong context Superadmin ho\u1eb7c h\u1ec7 th\u1ed1ng \u0111\u1ed3ng b\u1ed9</p> </li> </ul>"},{"location":"services/user-service/master/interface-contract/#su-kien-phat-ra_6","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li>\u274c Kh\u00f4ng c\u00f3 s\u1ef1 ki\u1ec7n \u2013 thao t\u00e1c \u0111\u1ecdc</li> </ul>"},{"location":"services/user-service/master/interface-contract/#ma-loi-co-the-tra-ve_6","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 401 Kh\u00f4ng c\u00f3 ho\u1eb7c JWT kh\u00f4ng h\u1ee3p l\u1ec7 403 Kh\u00f4ng c\u00f3 quy\u1ec1n <code>rbac.template.read</code> 422 <code>is_system</code> kh\u00f4ng h\u1ee3p l\u1ec7 (ph\u1ea3i l\u00e0 true/false)"},{"location":"services/user-service/master/interface-contract/#goi-y-kiem-thu_6","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>\u2705 G\u1ecdi b\u00ecnh th\u01b0\u1eddng \u2192 tr\u1ea3 danh s\u00e1ch role template to\u00e0n c\u1ee5c</li> <li>\u2705 G\u1ecdi v\u1edbi <code>is_system=true</code> \u2192 ch\u1ec9 tr\u1ea3 role m\u1eb7c \u0111\u1ecbnh h\u1ec7 th\u1ed1ng</li> <li>\u274c G\u1ecdi kh\u00f4ng quy\u1ec1n \u2192 tr\u1ea3 403</li> <li>\u2705 Ki\u1ec3m tra trace_id trong ph\u1ea3n h\u1ed3i</li> <li>\u2705 D\u00f9ng th\u00f4ng tin <code>template_key</code> \u0111\u1ec3 tra c\u1ee9u permission t\u01b0\u01a1ng \u1ee9ng</li> </ul>"},{"location":"services/user-service/master/interface-contract/#58-post-global-roles-templates","title":"5.8. <code>POST /global-roles-templates</code>","text":"<p>T\u1ea1o m\u1edbi m\u1ed9t role template to\u00e0n c\u1ee5c. \u0110\u01b0\u1ee3c s\u1eed d\u1ee5ng b\u1edfi Superadmin \u0111\u1ec3 \u0111\u1ecbnh ngh\u0129a c\u00e1c nh\u00f3m quy\u1ec1n chu\u1ea9n \u00e1p d\u1ee5ng cho user trong tenant. Khi template \u0111\u01b0\u1ee3c t\u1ea1o, Sub Service s\u1ebd c\u00f3 th\u1ec3 tra c\u1ee9u v\u00e0 \u00e1p d\u1ee5ng t\u01b0\u01a1ng \u1ee9ng khi c\u1ea5u h\u00ecnh RBAC.</p>"},{"location":"services/user-service/master/interface-contract/#request_7","title":"\ud83d\udce5 Request","text":"<p>Headers: - <code>Authorization: Bearer &lt;JWT&gt;</code></p> <p>Request body (JSON): <pre><code>{\n  \"template_key\": \"teacher_advanced\",\n  \"name\": \"Gi\u00e1o vi\u00ean n\u00e2ng cao\",\n  \"description\": \"Quy\u1ec1n \u0111\u1ea7y \u0111\u1ee7 cho gi\u00e1o vi\u00ean b\u1ed9 m\u00f4n\",\n  \"permissions\": [\"report.view\", \"lms.grade.edit\"]\n}\n</code></pre></p> <p>M\u00f4 t\u1ea3 field:</p> <ul> <li><code>template_key</code> (string, b\u1eaft bu\u1ed9c): \u0111\u1ecbnh danh duy nh\u1ea5t cho template (snake_case)</li> <li><code>name</code> (string, b\u1eaft bu\u1ed9c): t\u00ean hi\u1ec3n th\u1ecb</li> <li><code>description</code> (string, t\u00f9y ch\u1ecdn): m\u00f4 t\u1ea3 ch\u1ee9c n\u0103ng c\u1ee7a role</li> <li><code>permissions</code> (array string, b\u1eaft bu\u1ed9c): danh s\u00e1ch <code>permission_key</code> li\u00ean k\u1ebft v\u1edbi role</li> </ul>"},{"location":"services/user-service/master/interface-contract/#response_7","title":"\ud83d\udce4 Response","text":"<p>201 Created</p> <pre><code>{\n  \"data\": {\n    \"template_key\": \"teacher_advanced\",\n    \"name\": \"Gi\u00e1o vi\u00ean n\u00e2ng cao\",\n    \"permissions\": [\"report.view\", \"lms.grade.edit\"]\n  },\n  \"meta\": {\n    \"trace_id\": \"abc-xyz\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#phan-quyen-ieu-kien_7","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"<ul> <li>Y\u00eau c\u1ea7u: Bearer JWT h\u1ee3p l\u1ec7</li> <li>Quy\u1ec1n: <code>rbac.template.create</code></li> <li> <p>\u0110i\u1ec1u ki\u1ec7n:</p> </li> <li> <p><code>template_key</code> duy nh\u1ea5t (unique)</p> </li> <li>C\u00e1c <code>permission_key</code> ph\u1ea3i t\u1ed3n t\u1ea1i trong danh s\u00e1ch permission template to\u00e0n c\u1ee5c</li> </ul>"},{"location":"services/user-service/master/interface-contract/#su-kien-phat-ra_7","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li>\u274c Kh\u00f4ng ph\u00e1t s\u1ef1 ki\u1ec7n ngay.   Ch\u1ec9 ph\u00e1t khi c\u00f3 c\u1eadp nh\u1eadt (<code>PATCH</code>) template (<code>rbac_template_updated</code>)</li> </ul>"},{"location":"services/user-service/master/interface-contract/#ma-loi-co-the-tra-ve_7","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 400 Thi\u1ebfu field b\u1eaft bu\u1ed9c ho\u1eb7c \u0111\u1ecbnh d\u1ea1ng sai 401 Thi\u1ebfu ho\u1eb7c JWT kh\u00f4ng h\u1ee3p l\u1ec7 403 Kh\u00f4ng c\u00f3 quy\u1ec1n <code>rbac.template.create</code> 409 <code>template_key</code> \u0111\u00e3 t\u1ed3n t\u1ea1i 422 <code>permissions</code> ch\u1ee9a <code>permission_key</code> kh\u00f4ng h\u1ee3p l\u1ec7"},{"location":"services/user-service/master/interface-contract/#goi-y-kiem-thu_7","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>\u2705 T\u1ea1o m\u1edbi role template v\u1edbi <code>template_key</code> h\u1ee3p l\u1ec7 \u2192 tr\u1ea3 201</li> <li>\u274c T\u1ea1o tr\u00f9ng <code>template_key</code> \u2192 tr\u1ea3 409</li> <li>\u2705 Ki\u1ec3m tra <code>permission_key</code> h\u1ee3p l\u1ec7 \u2192 ch\u1ea5p nh\u1eadn</li> <li>\u274c Ch\u00e8n <code>permission_key</code> kh\u00f4ng c\u00f3 \u2192 tr\u1ea3 422</li> <li>\u2705 Ki\u1ec3m tra trace_id trong ph\u1ea3n h\u1ed3i</li> </ul>"},{"location":"services/user-service/master/interface-contract/#59-get-global-permissions-templates","title":"5.9. <code>GET /global-permissions-templates</code>","text":"<p>Li\u1ec7t k\u00ea t\u1ea5t c\u1ea3 c\u00e1c permission template to\u00e0n c\u1ee5c. \u0110\u01b0\u1ee3c s\u1eed d\u1ee5ng \u0111\u1ec3 c\u1ea5u h\u00ecnh role template ho\u1eb7c \u0111\u1ec3 g\u1ee3i \u00fd quy\u1ec1n trong UI Superadmin Webapp. L\u00e0 ngu\u1ed3n d\u1eef li\u1ec7u chu\u1ea9n \u0111\u1ec3 c\u1ea5u tr\u00fac RBAC cho to\u00e0n h\u1ec7 th\u1ed1ng theo t\u1ea7ng d\u1ecbch v\u1ee5.</p>"},{"location":"services/user-service/master/interface-contract/#request_8","title":"\ud83d\udce5 Request","text":"<p>Headers: - <code>Authorization: Bearer &lt;JWT&gt;</code></p> <p>Query parameters (optional): - <code>service_scope</code> (string): l\u1ecdc c\u00e1c permission theo t\u00ean service, v\u00ed d\u1ee5 <code>\"report\"</code>, <code>\"lms\"</code> - <code>keyword</code> (string): t\u00ecm ki\u1ebfm theo <code>permission_key</code> ho\u1eb7c m\u00f4 t\u1ea3</p>"},{"location":"services/user-service/master/interface-contract/#response_8","title":"\ud83d\udce4 Response","text":"<pre><code>{\n  \"data\": [\n    {\n      \"permission_key\": \"report.view\",\n      \"service_scope\": \"report\",\n      \"description\": \"Xem b\u00e1o c\u00e1o h\u1ecdc t\u1eadp\"\n    },\n    {\n      \"permission_key\": \"lms.grade.edit\",\n      \"service_scope\": \"lms\",\n      \"description\": \"Ch\u1ea5m \u0111i\u1ec3m h\u1ecdc vi\u00ean\"\n    }\n  ],\n  \"meta\": {\n    \"trace_id\": \"abc-xyz\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#phan-quyen-ieu-kien_8","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"<ul> <li>Y\u00eau c\u1ea7u: Bearer JWT h\u1ee3p l\u1ec7</li> <li>Quy\u1ec1n: <code>rbac.template.read</code></li> <li> <p>\u0110i\u1ec1u ki\u1ec7n:</p> </li> <li> <p>G\u1ecdi t\u1eeb Superadmin Webapp ho\u1eb7c h\u1ec7 th\u1ed1ng n\u1ed9i b\u1ed9 trung t\u00e2m</p> </li> </ul>"},{"location":"services/user-service/master/interface-contract/#su-kien-phat-ra_8","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li>\u274c Kh\u00f4ng c\u00f3 \u2013 \u0111\u00e2y l\u00e0 thao t\u00e1c tra c\u1ee9u t\u0129nh</li> </ul>"},{"location":"services/user-service/master/interface-contract/#ma-loi-co-the-tra-ve_8","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 401 Kh\u00f4ng c\u00f3 ho\u1eb7c JWT kh\u00f4ng h\u1ee3p l\u1ec7 403 Kh\u00f4ng c\u00f3 quy\u1ec1n <code>rbac.template.read</code> 422 <code>service_scope</code> kh\u00f4ng h\u1ee3p l\u1ec7 (n\u1ebfu validate)"},{"location":"services/user-service/master/interface-contract/#goi-y-kiem-thu_8","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>\u2705 Tr\u1ea3 danh s\u00e1ch \u0111\u1ea7y \u0111\u1ee7 permission template n\u1ebfu kh\u00f4ng c\u00f3 filter</li> <li>\u2705 G\u1ecdi v\u1edbi <code>service_scope=report</code> \u2192 ch\u1ec9 tr\u1ea3 c\u00e1c permission li\u00ean quan</li> <li>\u2705 G\u1ecdi v\u1edbi <code>keyword=grade</code> \u2192 tr\u1ea3 c\u00e1c permission c\u00f3 li\u00ean quan</li> <li>\u274c G\u1ecdi sai quy\u1ec1n ho\u1eb7c JWT \u2192 tr\u1ea3 403 ho\u1eb7c 401</li> <li>\u2705 Ki\u1ec3m tra trace_id c\u00f3 trong ph\u1ea3n h\u1ed3i</li> </ul>"},{"location":"services/user-service/master/interface-contract/#510-post-global-permissions-templates","title":"5.10. <code>POST /global-permissions-templates</code>","text":"<p>T\u1ea1o m\u1ed9t permission template m\u1edbi \u1edf c\u1ea5p to\u00e0n c\u1ee5c. \u0110\u01b0\u1ee3c s\u1eed d\u1ee5ng b\u1edfi Superadmin \u0111\u1ec3 m\u1edf r\u1ed9ng h\u1ec7 th\u1ed1ng quy\u1ec1n theo t\u1eebng d\u1ecbch v\u1ee5 (service_scope). C\u00e1c permission n\u00e0y l\u00e0 \u0111\u01a1n v\u1ecb c\u01a1 b\u1ea3n \u0111\u1ec3 g\u00e1n v\u00e0o role template v\u00e0 \u00e1p d\u1ee5ng cho RBAC tenant.</p>"},{"location":"services/user-service/master/interface-contract/#request_9","title":"\ud83d\udce5 Request","text":"<p>Headers: - <code>Authorization: Bearer &lt;JWT&gt;</code></p> <p>Request body (JSON): <pre><code>{\n  \"permission_key\": \"finance.invoice.view\",\n  \"service_scope\": \"finance\",\n  \"description\": \"Xem h\u00f3a \u0111\u01a1n h\u1ecdc ph\u00ed\"\n}\n</code></pre></p> <p>M\u00f4 t\u1ea3 field:</p> <ul> <li><code>permission_key</code> (string, b\u1eaft bu\u1ed9c): \u0111\u1ecbnh danh quy\u1ec1n (theo \u0111\u1ecbnh d\u1ea1ng <code>scope.action</code>, v\u00ed d\u1ee5: <code>report.view</code>)</li> <li><code>service_scope</code> (string, b\u1eaft bu\u1ed9c): t\u00ean d\u1ecbch v\u1ee5 li\u00ean quan (v\u00ed d\u1ee5: <code>report</code>, <code>lms</code>, <code>finance</code>)</li> <li><code>description</code> (string, t\u00f9y ch\u1ecdn): m\u00f4 t\u1ea3 r\u00f5 h\u00e0nh vi g\u1eafn v\u1edbi quy\u1ec1n</li> </ul>"},{"location":"services/user-service/master/interface-contract/#response_9","title":"\ud83d\udce4 Response","text":"<p>201 Created</p> <pre><code>{\n  \"data\": {\n    \"permission_key\": \"finance.invoice.view\",\n    \"service_scope\": \"finance\",\n    \"description\": \"Xem h\u00f3a \u0111\u01a1n h\u1ecdc ph\u00ed\"\n  },\n  \"meta\": {\n    \"trace_id\": \"abc-xyz\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#phan-quyen-ieu-kien_9","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"<ul> <li>Y\u00eau c\u1ea7u: Bearer JWT h\u1ee3p l\u1ec7</li> <li>Quy\u1ec1n: <code>rbac.template.create</code></li> <li> <p>\u0110i\u1ec1u ki\u1ec7n:</p> </li> <li> <p><code>permission_key</code> ph\u1ea3i duy nh\u1ea5t</p> </li> <li><code>permission_key</code> tu\u00e2n \u0111\u1ecbnh d\u1ea1ng <code>service_scope.action</code> (snake_case)</li> <li><code>service_scope</code> ph\u1ea3i \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a h\u1ee3p l\u1ec7 trong h\u1ec7 th\u1ed1ng</li> </ul>"},{"location":"services/user-service/master/interface-contract/#su-kien-phat-ra_9","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li>\u274c Kh\u00f4ng ph\u00e1t \u2013 permission ch\u1ec9 c\u00f3 hi\u1ec7u l\u1ef1c khi g\u00e1n v\u00e0o role template</li> </ul>"},{"location":"services/user-service/master/interface-contract/#ma-loi-co-the-tra-ve_9","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 400 Thi\u1ebfu field ho\u1eb7c sai \u0111\u1ecbnh d\u1ea1ng 401 Kh\u00f4ng c\u00f3 ho\u1eb7c sai JWT 403 Kh\u00f4ng c\u00f3 quy\u1ec1n <code>rbac.template.create</code> 409 <code>permission_key</code> \u0111\u00e3 t\u1ed3n t\u1ea1i 422 <code>permission_key</code> sai \u0111\u1ecbnh d\u1ea1ng (<code>&lt;scope&gt;.&lt;action&gt;</code>)"},{"location":"services/user-service/master/interface-contract/#goi-y-kiem-thu_9","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>\u2705 T\u1ea1o permission m\u1edbi h\u1ee3p l\u1ec7 \u2192 tr\u1ea3 201</li> <li>\u274c T\u1ea1o permission tr\u00f9ng <code>permission_key</code> \u2192 tr\u1ea3 409</li> <li>\u274c <code>permission_key</code> thi\u1ebfu d\u1ea5u ch\u1ea5m ho\u1eb7c sai ki\u1ec3u \u2192 tr\u1ea3 422</li> <li>\u2705 Ki\u1ec3m tra trace_id trong ph\u1ea3n h\u1ed3i</li> <li>\u2705 D\u00f9ng permission m\u1edbi \u0111\u1ec3 g\u00e1n v\u00e0o role template v\u00e0 ki\u1ec3m tra hi\u1ec7u l\u1ef1c</li> </ul>"},{"location":"services/user-service/master/interface-contract/#511-patch-global-roles-templatestemplate_key","title":"5.11. <code>PATCH /global-roles-templates/{template_key}</code>","text":"<p>C\u1eadp nh\u1eadt danh s\u00e1ch quy\u1ec1n (permissions) c\u1ee7a m\u1ed9t role template to\u00e0n c\u1ee5c. Sau khi c\u1eadp nh\u1eadt, h\u1ec7 th\u1ed1ng s\u1ebd ph\u00e1t s\u1ef1 ki\u1ec7n <code>rbac_template_updated</code> \u0111\u1ec3 c\u00e1c Sub Service \u0111\u1ed3ng b\u1ed9 l\u1ea1i RBAC cache cho c\u00e1c tenant.</p>"},{"location":"services/user-service/master/interface-contract/#request_10","title":"\ud83d\udce5 Request","text":"<p>Headers: - <code>Authorization: Bearer &lt;JWT&gt;</code></p> <p>Path parameters: - <code>template_key</code> (string, b\u1eaft bu\u1ed9c): \u0111\u1ecbnh danh c\u1ee7a role template c\u1ea7n c\u1eadp nh\u1eadt</p> <p>Request body (JSON): <pre><code>{\n  \"permissions\": [\"report.view\", \"lms.grade.edit\"]\n}\n</code></pre></p> <p>M\u00f4 t\u1ea3 field:</p> <ul> <li><code>permissions</code> (array string, b\u1eaft bu\u1ed9c): danh s\u00e1ch <code>permission_key</code> m\u1edbi cho template n\u00e0y.   Danh s\u00e1ch c\u0169 s\u1ebd b\u1ecb thay th\u1ebf ho\u00e0n to\u00e0n.</li> </ul>"},{"location":"services/user-service/master/interface-contract/#response_10","title":"\ud83d\udce4 Response","text":"<p>200 OK</p> <pre><code>{\n  \"data\": {\n    \"template_key\": \"teacher_advanced\",\n    \"updated_permissions\": [\"report.view\", \"lms.grade.edit\"]\n  },\n  \"meta\": {\n    \"trace_id\": \"abc-xyz\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#phan-quyen-ieu-kien_10","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"<ul> <li>Y\u00eau c\u1ea7u: Bearer JWT h\u1ee3p l\u1ec7</li> <li>Quy\u1ec1n: <code>rbac.template.update</code></li> <li> <p>\u0110i\u1ec1u ki\u1ec7n:</p> </li> <li> <p><code>template_key</code> ph\u1ea3i t\u1ed3n t\u1ea1i</p> </li> <li>C\u00e1c <code>permission_key</code> cung c\u1ea5p ph\u1ea3i t\u1ed3n t\u1ea1i trong global permissions template</li> <li>Kh\u00f4ng cho ph\u00e9p ch\u1ec9nh s\u1eeda c\u00e1c template c\u00f3 <code>is_system = true</code> (n\u1ebfu \u00e1p d\u1ee5ng)</li> </ul>"},{"location":"services/user-service/master/interface-contract/#su-kien-phat-ra_10","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li><code>rbac_template_updated</code>   Schema: <code>vas.rbac.template.updated.v1</code>   Payload: <code>{ template_key, updated_permissions, updated_at }</code>   Consumer: t\u1ea5t c\u1ea3 Sub Service s\u1eed d\u1ee5ng RBAC caching (User Sub, LMS Sub, CRM Sub...)</li> </ul>"},{"location":"services/user-service/master/interface-contract/#ma-loi-co-the-tra-ve_10","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 400 Thi\u1ebfu ho\u1eb7c sai \u0111\u1ecbnh d\u1ea1ng <code>permissions</code> 401 Kh\u00f4ng c\u00f3 ho\u1eb7c JWT kh\u00f4ng h\u1ee3p l\u1ec7 403 Kh\u00f4ng c\u00f3 quy\u1ec1n <code>rbac.template.update</code> 404 <code>template_key</code> kh\u00f4ng t\u1ed3n t\u1ea1i 422 C\u00f3 <code>permission_key</code> kh\u00f4ng t\u1ed3n t\u1ea1i trong h\u1ec7 th\u1ed1ng"},{"location":"services/user-service/master/interface-contract/#goi-y-kiem-thu_10","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>\u2705 C\u1eadp nh\u1eadt role template v\u1edbi quy\u1ec1n h\u1ee3p l\u1ec7 \u2192 tr\u1ea3 200 + ph\u00e1t event</li> <li>\u274c S\u1eed d\u1ee5ng <code>template_key</code> kh\u00f4ng t\u1ed3n t\u1ea1i \u2192 tr\u1ea3 404</li> <li>\u274c Ch\u00e8n <code>permission_key</code> sai \u2192 tr\u1ea3 422</li> <li>\u2705 Ki\u1ec3m tra event <code>rbac_template_updated</code> ph\u00e1t \u0111\u00fang schema</li> <li>\u2705 Ki\u1ec3m tra trace_id c\u00f3 trong ph\u1ea3n h\u1ed3i</li> </ul>"},{"location":"services/user-service/master/interface-contract/#512-patch-global-permissions-templatesperm_key","title":"5.12. <code>PATCH /global-permissions-templates/{perm_key}</code>","text":"<p>C\u1eadp nh\u1eadt th\u00f4ng tin m\u00f4 t\u1ea3 ho\u1eb7c <code>service_scope</code> c\u1ee7a m\u1ed9t permission template to\u00e0n c\u1ee5c. S\u1eed d\u1ee5ng trong tr\u01b0\u1eddng h\u1ee3p c\u1ea7n \u0111i\u1ec1u ch\u1ec9nh m\u00f4 t\u1ea3 cho r\u00f5 r\u00e0ng h\u01a1n, ho\u1eb7c chuy\u1ec3n scope sang d\u1ecbch v\u1ee5 kh\u00e1c trong qu\u00e1 tr\u00ecnh refactor h\u1ec7 th\u1ed1ng.</p>"},{"location":"services/user-service/master/interface-contract/#request_11","title":"\ud83d\udce5 Request","text":"<p>Headers: - <code>Authorization: Bearer &lt;JWT&gt;</code></p> <p>Path parameters: - <code>perm_key</code> (string, b\u1eaft bu\u1ed9c): \u0111\u1ecbnh danh c\u1ee7a permission c\u1ea7n c\u1eadp nh\u1eadt</p> <p>Request body (JSON): <pre><code>{\n  \"description\": \"Quy\u1ec1n xem h\u00f3a \u0111\u01a1n h\u1ecdc ph\u00ed\",\n  \"service_scope\": \"billing\"\n}\n</code></pre></p> <p>M\u00f4 t\u1ea3 field:</p> <ul> <li><code>description</code> (string, optional): m\u00f4 t\u1ea3 c\u1eadp nh\u1eadt</li> <li><code>service_scope</code> (string, optional): t\u00ean service m\u1edbi (n\u1ebfu c\u1ea7n \u0111\u1ed5i)</li> </ul>"},{"location":"services/user-service/master/interface-contract/#response_11","title":"\ud83d\udce4 Response","text":"<p>200 OK</p> <pre><code>{\n  \"data\": {\n    \"permission_key\": \"finance.invoice.view\",\n    \"description\": \"Quy\u1ec1n xem h\u00f3a \u0111\u01a1n h\u1ecdc ph\u00ed\",\n    \"service_scope\": \"billing\"\n  },\n  \"meta\": {\n    \"trace_id\": \"abc-xyz\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#phan-quyen-ieu-kien_11","title":"\ud83d\udd10 Ph\u00e2n quy\u1ec1n &amp; \u0110i\u1ec1u ki\u1ec7n","text":"<ul> <li>Y\u00eau c\u1ea7u: Bearer JWT h\u1ee3p l\u1ec7</li> <li>Quy\u1ec1n: <code>rbac.template.update</code></li> <li> <p>\u0110i\u1ec1u ki\u1ec7n:</p> </li> <li> <p><code>perm_key</code> ph\u1ea3i t\u1ed3n t\u1ea1i</p> </li> <li>Kh\u00f4ng cho ph\u00e9p \u0111\u1ed5i <code>permission_key</code> (immutable)</li> <li>N\u1ebfu c\u1eadp nh\u1eadt <code>service_scope</code>, gi\u00e1 tr\u1ecb m\u1edbi ph\u1ea3i h\u1ee3p l\u1ec7 theo quy \u01b0\u1edbc h\u1ec7 th\u1ed1ng</li> </ul>"},{"location":"services/user-service/master/interface-contract/#su-kien-phat-ra_11","title":"\ud83d\udce3 S\u1ef1 ki\u1ec7n ph\u00e1t ra","text":"<ul> <li>\u274c Kh\u00f4ng ph\u00e1t s\u1ef1 ki\u1ec7n \u2013 v\u00ec kh\u00f4ng \u1ea3nh h\u01b0\u1edfng logic ph\u00e2n quy\u1ec1n runtime   (permission \u0111\u01b0\u1ee3c \u00e1p d\u1ee5ng th\u00f4ng qua role template \u0111\u00e3 cache ri\u00eang)</li> </ul>"},{"location":"services/user-service/master/interface-contract/#ma-loi-co-the-tra-ve_11","title":"\u274c M\u00e3 l\u1ed7i c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 400 Body r\u1ed7ng ho\u1eb7c kh\u00f4ng c\u00f3 field h\u1ee3p l\u1ec7 \u0111\u1ec3 c\u1eadp nh\u1eadt 401 Thi\u1ebfu ho\u1eb7c JWT kh\u00f4ng h\u1ee3p l\u1ec7 403 Kh\u00f4ng c\u00f3 quy\u1ec1n <code>rbac.template.update</code> 404 <code>perm_key</code> kh\u00f4ng t\u1ed3n t\u1ea1i 422 <code>service_scope</code> m\u1edbi kh\u00f4ng h\u1ee3p l\u1ec7"},{"location":"services/user-service/master/interface-contract/#goi-y-kiem-thu_11","title":"\ud83e\uddea G\u1ee3i \u00fd ki\u1ec3m th\u1eed","text":"<ul> <li>\u2705 C\u1eadp nh\u1eadt m\u00f4 t\u1ea3 permission \u2192 tr\u1ea3 200</li> <li>\u2705 C\u1eadp nh\u1eadt <code>service_scope</code> \u2192 tr\u1ea3 200, ki\u1ec3m tra hi\u1ec3n th\u1ecb \u0111\u00fang n\u01a1i d\u00f9ng</li> <li>\u274c G\u1ecdi v\u1edbi <code>perm_key</code> sai \u2192 tr\u1ea3 404</li> <li>\u274c Body r\u1ed7ng ho\u1eb7c kh\u00f4ng h\u1ee3p l\u1ec7 \u2192 tr\u1ea3 400</li> <li>\u2705 Ki\u1ec3m tra trace_id trong ph\u1ea3n h\u1ed3i</li> </ul>"},{"location":"services/user-service/master/interface-contract/#6-su-kien-phat-ra-pubsub","title":"6. \ud83d\udce1 S\u1ef1 ki\u1ec7n ph\u00e1t ra (Pub/Sub)","text":"<p><code>user-service/master</code> l\u00e0 ngu\u1ed3n ph\u00e1t sinh m\u1ed9t s\u1ed1 s\u1ef1 ki\u1ec7n quan tr\u1ecdng ph\u1ee5c v\u1ee5 cho qu\u00e1 tr\u00ecnh \u0111\u1ed3ng b\u1ed9 d\u1eef li\u1ec7u ng\u01b0\u1eddi d\u00f9ng v\u00e0 RBAC ph\u00e2n t\u1ea7ng trong to\u00e0n b\u1ed9 h\u1ec7 th\u1ed1ng. C\u00e1c s\u1ef1 ki\u1ec7n \u0111\u1ec1u tu\u00e2n theo chu\u1ea9n \u0111\u1ecbnh danh <code>vas.&lt;domain&gt;.&lt;action&gt;.v1</code> theo <code>adr-030-event-schema-governance.md</code>.</p> Event Name Trigger Schema Consumer (v\u00ed d\u1ee5) <code>user_global_created</code> Khi t\u1ea1o user to\u00e0n c\u1ee5c (<code>POST /users-global</code>) <code>vas.user.created.v1</code> <code>user-service/sub</code>, <code>audit-log</code> <code>tenant_created</code> Khi t\u1ea1o tenant m\u1edbi (<code>POST /tenants</code>) <code>vas.tenant.created.v1</code> <code>user-service/sub</code>, <code>sms-service</code> <code>tenant_user_assigned</code> Khi g\u00e1n user v\u00e0o tenant (<code>POST /user-tenant-assignments</code>) <code>vas.tenant_user.assigned.v1</code> <code>user-service/sub</code>, <code>auth-service/sub</code> <code>rbac_template_updated</code> Khi c\u1eadp nh\u1eadt role template (<code>PATCH /global-roles-templates/{template_key}</code>) <code>vas.rbac.template.updated.v1</code> <code>user-service/sub</code>, <code>lms-service/sub</code> <p>L\u01b0u \u00fd: - M\u1ed7i s\u1ef1 ki\u1ec7n \u0111\u1ec1u k\u00e8m <code>trace_id</code> \u0111\u1ec3 ph\u1ee5c v\u1ee5 cho audit v\u00e0 trace li\u00ean d\u1ecbch v\u1ee5. - To\u00e0n b\u1ed9 schema \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a r\u00f5 trong <code>event-schema.yaml</code> c\u1ee7a <code>eventing standard</code> (tham kh\u1ea3o <code>adr-030</code>). - C\u00e1c Sub Service s\u1ebd d\u00f9ng consumer ri\u00eang bi\u1ec7t \u0111\u1ec3 x\u1eed l\u00fd s\u1ef1 ki\u1ec7n theo <code>tenant_id</code>.</p>"},{"location":"services/user-service/master/interface-contract/#61-vi-du-su-kien-user_global_created","title":"6.1. \ud83d\udce6 V\u00ed d\u1ee5: S\u1ef1 ki\u1ec7n <code>user_global_created</code>","text":"<ul> <li>\u0110\u01b0\u1ee3c ph\u00e1t b\u1edfi: <code>POST /users-global</code></li> <li>Ti\u00eau chu\u1ea9n \u0111\u1ecbnh danh: <code>vas.user.created.v1</code></li> <li>M\u1ee5c \u0111\u00edch: \u0110\u1ed3ng b\u1ed9 t\u1ea1o user t\u1edbi c\u00e1c Sub Service (User Sub, Notification, LMS, Audit...)</li> </ul>"},{"location":"services/user-service/master/interface-contract/#payload-mau","title":"\ud83d\udce4 Payload m\u1eabu","text":"<pre><code>{\n  \"event_name\": \"vas.user.created.v1\",\n  \"trace_id\": \"abc-xyz-123\",\n  \"emitted_at\": \"2025-06-13T08:35:00Z\",\n  \"data\": {\n    \"user_id\": \"usr_xyz789\",\n    \"email\": \"alice@vas.edu.vn\",\n    \"auth_provider\": \"google\",\n    \"full_name\": \"Alice B\",\n    \"status\": \"active\",\n    \"created_at\": \"2025-06-13T08:30:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#mo-ta-schema","title":"\ud83e\uddfe M\u00f4 t\u1ea3 schema","text":"Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>event_name</code> string \u2705 \u0110\u1ecbnh danh s\u1ef1 ki\u1ec7n theo chu\u1ea9n ADR-030 <code>trace_id</code> string \u2705 ID trace ph\u1ee5c v\u1ee5 observability <code>emitted_at</code> datetime \u2705 Th\u1eddi \u0111i\u1ec3m s\u1ef1 ki\u1ec7n \u0111\u01b0\u1ee3c ph\u00e1t <code>data.user_id</code> string \u2705 ID ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c <code>data.email</code> string \u2705 Email \u0111\u0103ng nh\u1eadp <code>data.auth_provider</code> enum (<code>google</code>, <code>local</code>, <code>otp</code>) \u2705 Nh\u00e0 cung c\u1ea5p x\u00e1c th\u1ef1c <code>data.full_name</code> string \u2705 H\u1ecd t\u00ean ng\u01b0\u1eddi d\u00f9ng <code>data.status</code> string \u2705 Tr\u1ea1ng th\u00e1i ban \u0111\u1ea7u (<code>active</code>, <code>inactive</code>) <code>data.created_at</code> datetime \u2705 Th\u1eddi \u0111i\u1ec3m kh\u1edfi t\u1ea1o"},{"location":"services/user-service/master/interface-contract/#goi-y-kiem-thu-su-kien","title":"\u2705 G\u1ee3i \u00fd ki\u1ec3m th\u1eed s\u1ef1 ki\u1ec7n","text":"<ul> <li>T\u1ea1o user m\u1edbi \u2192 ki\u1ec3m tra message \u0111\u01b0\u1ee3c \u0111\u1ea9y v\u00e0o message broker (Kafka, NATS...)</li> <li>Ki\u1ec3m tra trace_id c\u00f3 m\u1eb7t \u1edf c\u1ea3 ph\u00eda caller l\u1eabn message</li> <li>Sub Service nh\u1eadn \u0111\u00fang schema v\u00e0 x\u1eed l\u00fd \u0111\u00fang logic kh\u1edfi t\u1ea1o user n\u1ed9i b\u1ed9</li> </ul>"},{"location":"services/user-service/master/interface-contract/#62-vi-du-su-kien-tenant_user_assigned","title":"6.2. \ud83d\udce6 V\u00ed d\u1ee5: S\u1ef1 ki\u1ec7n <code>tenant_user_assigned</code>","text":"<ul> <li>\u0110\u01b0\u1ee3c ph\u00e1t b\u1edfi: <code>POST /user-tenant-assignments</code></li> <li>Ti\u00eau chu\u1ea9n \u0111\u1ecbnh danh: <code>vas.tenant_user.assigned.v1</code></li> <li>M\u1ee5c \u0111\u00edch: \u0110\u1ed3ng b\u1ed9 vi\u1ec7c g\u00e1n user v\u00e0o tenant t\u1edbi c\u00e1c Sub Service \u0111\u1ec3 kh\u1edfi t\u1ea1o user n\u1ed9i b\u1ed9 trong tenant context.</li> </ul>"},{"location":"services/user-service/master/interface-contract/#payload-mau_1","title":"\ud83d\udce4 Payload m\u1eabu","text":"<pre><code>{\n  \"event_name\": \"vas.tenant_user.assigned.v1\",\n  \"trace_id\": \"trace-xyz-456\",\n  \"emitted_at\": \"2025-06-13T09:15:00Z\",\n  \"data\": {\n    \"user_global_id\": \"usr_abc123\",\n    \"tenant_id\": \"tenant_vas001\",\n    \"project_id\": \"vas-tenant-001\",\n    \"assigned_by\": \"admin@vas.edu.vn\",\n    \"assigned_at\": \"2025-06-13T09:14:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#mo-ta-schema_1","title":"\ud83e\uddfe M\u00f4 t\u1ea3 schema","text":"Tr\u01b0\u1eddng Ki\u1ec3u B\u1eaft bu\u1ed9c M\u00f4 t\u1ea3 <code>event_name</code> string \u2705 \u0110\u1ecbnh danh s\u1ef1 ki\u1ec7n (theo ADR-030) <code>trace_id</code> string \u2705 Trace ID li\u00ean k\u1ebft v\u1edbi lu\u1ed3ng t\u01b0\u01a1ng t\u00e1c <code>emitted_at</code> datetime \u2705 Th\u1eddi \u0111i\u1ec3m ph\u00e1t s\u1ef1 ki\u1ec7n <code>data.user_global_id</code> string \u2705 ID ng\u01b0\u1eddi d\u00f9ng to\u00e0n c\u1ee5c <code>data.tenant_id</code> string \u2705 ID tenant \u0111\u00edch <code>data.project_id</code> string \u2705 M\u00e3 \u0111\u1ecbnh danh duy nh\u1ea5t c\u1ee7a tenant (d\u00f9ng cho context isolation) <code>data.assigned_by</code> string \u2705 Ng\u01b0\u1eddi th\u1ef1c hi\u1ec7n thao t\u00e1c g\u00e1n (email ho\u1eb7c ID) <code>data.assigned_at</code> datetime \u2705 Th\u1eddi \u0111i\u1ec3m thao t\u00e1c g\u00e1n \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n"},{"location":"services/user-service/master/interface-contract/#goi-y-kiem-thu-su-kien_1","title":"\u2705 G\u1ee3i \u00fd ki\u1ec3m th\u1eed s\u1ef1 ki\u1ec7n","text":"<ul> <li>Th\u1ef1c hi\u1ec7n <code>POST /user-tenant-assignments</code> \u2192 ki\u1ec3m tra event \u0111\u01b0\u1ee3c \u0111\u1ea9y \u0111\u00fang \u0111\u1ecbnh d\u1ea1ng</li> <li>Sub Service ki\u1ec3m tra context <code>tenant_id + project_id</code> \u0111\u1ec3 t\u1ea1o schema ho\u1eb7c account n\u1ed9i b\u1ed9</li> <li>Audit Service ghi nh\u1eadn <code>assigned_by</code> + <code>trace_id</code> \u0111\u1ec3 ph\u1ee5c v\u1ee5 tra so\u00e1t</li> <li>Ki\u1ec3m tra event kh\u00f4ng ph\u00e1t tr\u00f9ng khi g\u00e1n l\u1ea1i user c\u0169</li> </ul>"},{"location":"services/user-service/master/interface-contract/#7-cach-su-dung-pho-bien-business-flow","title":"7. \ud83e\udde0 C\u00e1ch s\u1eed d\u1ee5ng ph\u1ed5 bi\u1ebfn (business flow)","text":"<p>D\u01b0\u1edbi \u0111\u00e2y l\u00e0 c\u00e1c lu\u1ed3ng nghi\u1ec7p v\u1ee5 ch\u00ednh c\u00f3 s\u1ef1 tham gia c\u1ee7a <code>user-service/master</code>, \u0111\u00f3ng vai tr\u00f2 trung t\u00e2m trong qu\u1ea3n l\u00fd \u0111\u1ecbnh danh to\u00e0n c\u1ee5c, RBAC ph\u00e2n t\u1ea7ng, v\u00e0 \u0111\u1ed3ng b\u1ed9 user \u0111\u1ebfn t\u1eebng tenant.</p>"},{"location":"services/user-service/master/interface-contract/#71-ang-nhap-lan-au-tao-user-toan-cuc-qua-auth-service","title":"7.1. \ud83c\udf10 \u0110\u0103ng nh\u1eadp l\u1ea7n \u0111\u1ea7u &amp; t\u1ea1o user to\u00e0n c\u1ee5c (qua Auth Service)","text":"<pre><code>sequenceDiagram\n    participant FE as Frontend\n    participant Auth as Auth Service\n    participant UserMaster as User Service Master\n\n    FE-&gt;&gt;Auth: G\u1eedi m\u00e3 OAuth (code)\n    Auth-&gt;&gt;UserMaster: GET /users-global/by-email\n    alt User ch\u01b0a t\u1ed3n t\u1ea1i\n        Auth-&gt;&gt;UserMaster: POST /users-global\n    end\n    UserMaster--&gt;&gt;Auth: Tr\u1ea3 th\u00f4ng tin user to\u00e0n c\u1ee5c\n    Auth--&gt;&gt;FE: Tr\u1ea3 JWT + profile\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#72-superadmin-tao-tenant-moi-phan-quyen","title":"7.2. \ud83c\udfeb Superadmin t\u1ea1o tenant m\u1edbi &amp; ph\u00e2n quy\u1ec1n","text":"<pre><code>sequenceDiagram\n    participant Superadmin\n    participant UserMaster as User Service Master\n    participant AllSubs as Sub Services\n\n    Superadmin-&gt;&gt;UserMaster: POST /tenants\n    UserMaster--&gt;&gt;AllSubs: Emit `tenant_created`\n\n    Superadmin-&gt;&gt;UserMaster: POST /user-tenant-assignments\n    UserMaster--&gt;&gt;AllSubs: Emit `tenant_user_assigned`\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#73-quan-tri-rbac-toan-cuc","title":"7.3. \ud83d\udd10 Qu\u1ea3n tr\u1ecb RBAC to\u00e0n c\u1ee5c","text":"<pre><code>sequenceDiagram\n    participant Admin\n    participant UserMaster as User Service Master\n    participant LMSSub as LMS Sub Service\n\n    Admin-&gt;&gt;UserMaster: POST /global-roles-templates\n    Admin-&gt;&gt;UserMaster: POST /global-permissions-templates\n    Admin-&gt;&gt;UserMaster: PATCH /global-roles-templates/{template_key}\n    UserMaster--&gt;&gt;LMSSub: Emit `rbac_template_updated`\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#74-ong-bo-user-cho-tenant-moi-qua-sub-service","title":"7.4. \ud83e\udde9 \u0110\u1ed3ng b\u1ed9 user cho tenant m\u1edbi (qua Sub Service)","text":"<pre><code>sequenceDiagram\n    participant TenantFE as Tenant Webapp\n    participant AuthSub as Auth Sub\n    participant UserSub as User Sub\n    participant UserMaster as User Service Master\n\n    TenantFE-&gt;&gt;AuthSub: \u0110\u0103ng nh\u1eadp\n    AuthSub-&gt;&gt;UserMaster: GET /users-global/by-email\n    AuthSub-&gt;&gt;UserMaster: GET /user-tenant-assignments\n    alt N\u1ebfu ch\u01b0a \u0111\u01b0\u1ee3c g\u00e1n\n        AuthSub-&gt;&gt;UserMaster: POST /user-tenant-assignments\n        UserMaster--&gt;&gt;UserSub: Emit `tenant_user_assigned`\n    end\n    UserSub--&gt;&gt;AuthSub: Sync th\u00f4ng tin user tenant\n    AuthSub--&gt;&gt;TenantFE: Tr\u1ea3 JWT theo context tenant\n</code></pre>"},{"location":"services/user-service/master/interface-contract/#ghi-chu","title":"\ud83d\udd0e Ghi ch\u00fa","text":"<ul> <li>M\u1ed7i lu\u1ed3ng \u0111\u1ec1u g\u1eafn ch\u1eb7t v\u1edbi c\u00e1c API \u0111\u00e3 \u0111\u1ecbnh ngh\u0129a v\u00e0 s\u1ef1 ki\u1ec7n ph\u00e1t ra t\u01b0\u01a1ng \u1ee9ng trong m\u1ee5c 5\u20136.</li> <li>Trace ID lu\u00f4n \u0111\u01b0\u1ee3c truy\u1ec1n theo to\u00e0n lu\u1ed3ng, ph\u1ee5c v\u1ee5 audit v\u00e0 debug.</li> <li>C\u00e1c lu\u1ed3ng lu\u00f4n \u0111i t\u1eeb d\u1ecbch v\u1ee5 trung t\u00e2m (<code>master</code>) xu\u1ed1ng d\u1ecbch v\u1ee5 con (<code>sub</code>), \u0111\u00fang v\u1edbi ki\u1ebfn tr\u00fac ph\u00e2n t\u1ea7ng multi-tenant \u0111\u00e3 \u0111\u1ecbnh ngh\u0129a trong <code>system-diagrams.md</code>.</li> </ul>"},{"location":"services/user-service/master/interface-contract/#8-phu-luc","title":"8. \ud83d\udcce Ph\u1ee5 l\u1ee5c","text":""},{"location":"services/user-service/master/interface-contract/#81-chuan-hoa-ma-loi-error-codes","title":"8.1. \ud83d\udcda Chu\u1ea9n h\u00f3a m\u00e3 l\u1ed7i (Error Codes)","text":"<p>T\u1ea5t c\u1ea3 c\u00e1c m\u00e3 l\u1ed7i (<code>error.code</code>) trong response ph\u1ea3i tu\u00e2n th\u1ee7 theo chu\u1ea9n \u0111\u1ecbnh danh namespace \u0111\u01b0\u1ee3c m\u00f4 t\u1ea3 t\u1ea1i:</p> <ul> <li>Error Codes</li> <li>ADR-011 Error Format</li> </ul> <p>Y\u00eau c\u1ea7u b\u1eaft bu\u1ed9c:</p> <ul> <li> <p>M\u00e3 l\u1ed7i ph\u1ea3i vi\u1ebft theo d\u1ea1ng snake_case, c\u00f3 namespace ph\u00e2n t\u00e1ch r\u00f5 r\u00e0ng, v\u00ed d\u1ee5:</p> </li> <li> <p><code>user.user_not_found</code></p> </li> <li><code>auth.invalid_token</code></li> <li><code>common.validation_failed</code></li> <li> <p>M\u1ed7i response l\u1ed7i (401, 403, 404, 422...) ph\u1ea3i tr\u1ea3 v\u1ec1 \u0111\u1ed1i t\u01b0\u1ee3ng <code>ErrorEnvelope</code>, g\u1ed3m 2 ph\u1ea7n:</p> </li> <li> <p><code>error</code> \u2013 ch\u1ee9a <code>code</code>, <code>message</code>, <code>details</code></p> </li> <li><code>meta</code> \u2013 ch\u1ee9a <code>trace_id</code>, <code>timestamp</code></li> </ul> <p>G\u1ee3i \u00fd th\u1ef1c h\u00e0nh:</p> <ul> <li>Kh\u00f4ng d\u00f9ng c\u00e1c m\u00e3 l\u1ed7i chung chung nh\u01b0 <code>\"BAD_REQUEST\"</code>, <code>\"NOT_FOUND\"</code>, <code>\"FORBIDDEN\"</code></li> <li>Lu\u00f4n khai b\u00e1o v\u00ed d\u1ee5 c\u1ee5 th\u1ec3 (v\u00ed d\u1ee5 trong <code>components/examples/</code> ho\u1eb7c inline OpenAPI) \u0111\u1ec3 gi\u00fap dev hi\u1ec3u nhanh</li> <li>T\u00e1i s\u1eed d\u1ee5ng error namespace c\u00f3 s\u1eb5n t\u1eeb <code>error-codes.md</code> ho\u1eb7c khai b\u00e1o namespace m\u1edbi n\u1ebfu c\u1ea7n</li> </ul>"},{"location":"services/user-service/master/interface-contract/#82-tai-lieu-lien-ket","title":"8.2. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean k\u1ebft","text":"<ul> <li>Design</li> <li>Data Model</li> <li>OpenAPI</li> <li>ADR-030 \u2013 Event Schema Governance</li> <li>ADR-011 Error Format</li> <li>ADR-027 Data Management Strategy</li> <li>Error Codes</li> </ul>"},{"location":"services/user-service/sub/data-model/","title":"\ud83d\uddc3\ufe0f User Service Sub - Data Model","text":""},{"location":"services/user-service/sub/data-model/#gioi-thieu","title":"\ud83d\udcd8 Gi\u1edbi thi\u1ec7u","text":"<p><code>user-service/sub/</code> l\u00e0 m\u1ed9t service ch\u1ec9 \u0111\u1ecdc (read-only) theo ki\u1ebfn tr\u00fac master/sub. Service n\u00e0y qu\u1ea3n l\u00fd d\u1eef li\u1ec7u ng\u01b0\u1eddi d\u00f9ng trong ph\u1ea1m vi m\u1ed9t tenant c\u1ee5 th\u1ec3. D\u1eef li\u1ec7u \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 m\u1ed9t chi\u1ec1u t\u1eeb <code>user-service/master</code> th\u00f4ng qua c\u00e1c s\u1ef1 ki\u1ec7n Pub/Sub, kh\u00f4ng cho ph\u00e9p ghi tr\u1ef1c ti\u1ebfp t\u1eeb ph\u00eda client.</p> <p>T\u00e0i li\u1ec7u n\u00e0y m\u00f4 t\u1ea3 to\u00e0n b\u1ed9 m\u00f4 h\u00ecnh d\u1eef li\u1ec7u n\u1ed9i b\u1ed9 c\u1ee7a Sub Service, bao g\u1ed3m c\u00e1c b\u1ea3ng: <code>UserLocal</code>, <code>UserTenantRole</code>, <code>RoleTemplateLite</code>, v\u00e0 <code>PermissionTemplateLite</code>. D\u1eef li\u1ec7u n\u00e0y kh\u00f4ng bao g\u1ed3m th\u00f4ng tin x\u00e1c th\u1ef1c (auth), c\u0169ng kh\u00f4ng qu\u1ea3n l\u00fd RBAC template g\u1ed1c (ch\u1ec9 gi\u1eef b\u1ea3n sao).</p>"},{"location":"services/user-service/sub/data-model/#1-so-o-erd-entity-relationship-diagram","title":"1. S\u01a1 \u0111\u1ed3 ERD (Entity Relationship Diagram)","text":"<pre><code>erDiagram\n  UserLocal ||--o{ UserTenantRole : has\n  UserTenantRole }o--|| RoleTemplateLite : references\n  RoleTemplateLite ||--o{ PermissionTemplateLite : includes\n\n  UserLocal {\n    UUID user_id PK\n    STRING email\n    STRING full_name\n    STRING auth_provider\n    STRING status\n    BOOLEAN is_active_in_tenant\n    DATETIME created_at\n    DATETIME updated_at\n  }\n\n  UserTenantRole {\n    UUID user_id FK\n    STRING role_code FK\n    STRING[] permissions\n  }\n\n  RoleTemplateLite {\n    STRING role_code PK\n    STRING name\n    STRING description\n  }\n\n  PermissionTemplateLite {\n    STRING code PK\n    STRING resource\n    STRING action\n    STRING description\n  }\n</code></pre> <p>\ud83d\udca1 Ghi ch\u00fa: M\u1ed1i quan h\u1ec7 <code>RoleTemplateLite \u2192 PermissionTemplateLite</code> l\u00e0 logic, th\u1ec3 hi\u1ec7n vi\u1ec7c m\u1ed9t role \"bao g\u1ed3m\" c\u00e1c permissions. RBACResolver s\u1ebd t\u1ef1 \u0111\u1ed9ng \"expand\" quy\u1ec1n d\u1ef1a tr\u00ean cache template \u2013 kh\u00f4ng c\u00f3 b\u1ea3ng join v\u1eadt l\u00fd gi\u1eefa 2 b\u1ea3ng n\u00e0y.</p>"},{"location":"services/user-service/sub/data-model/#2-chi-tiet-bang","title":"2. Chi ti\u1ebft B\u1ea3ng","text":""},{"location":"services/user-service/sub/data-model/#userlocal","title":"\ud83d\udccc <code>UserLocal</code>","text":"<p>B\u1ea3ng n\u00e0y ch\u1ee9a th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng n\u1ed9i b\u1ed9 \u0111\u00e3 \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 t\u1eeb Master. D\u00f9ng \u0111\u1ec3 truy xu\u1ea5t d\u1eef li\u1ec7u user v\u00e0 tr\u1ea1ng th\u00e1i k\u00edch ho\u1ea1t trong tenant hi\u1ec7n t\u1ea1i.</p> T\u00ean c\u1ed9t Ki\u1ec3u R\u00e0ng bu\u1ed9c M\u00f4 t\u1ea3 <code>user_id</code> UUID PK ID ng\u01b0\u1eddi d\u00f9ng n\u1ed9i b\u1ed9, mirror t\u1eeb Master <code>email</code> string NOT NULL Email c\u1ee7a ng\u01b0\u1eddi d\u00f9ng <code>full_name</code> string H\u1ecd t\u00ean \u0111\u1ea7y \u0111\u1ee7 <code>auth_provider</code> enum NOT NULL <code>local</code> ho\u1eb7c <code>google</code> <code>status</code> enum NOT NULL <code>active</code>, <code>suspended</code>, <code>invited</code>, <code>deleted</code>, mirror t\u1eeb UserGlobal <code>is_active_in_tenant</code> boolean NOT NULL Tr\u1ea1ng th\u00e1i assignment c\u00f2n hi\u1ec7u l\u1ef1c trong tenant <code>created_at</code> datetime DEFAULT NOW() Ng\u00e0y t\u1ea1o b\u1ea3n ghi <code>updated_at</code> datetime Ng\u00e0y c\u1eadp nh\u1eadt g\u1ea7n nh\u1ea5t <pre><code>CREATE TABLE user_local (\n  user_id UUID PRIMARY KEY,\n  email VARCHAR(255) NOT NULL,\n  full_name VARCHAR(255),\n  auth_provider VARCHAR(32) NOT NULL,\n  status VARCHAR(32) NOT NULL,\n  is_active_in_tenant BOOLEAN NOT NULL DEFAULT TRUE,\n  created_at TIMESTAMPTZ DEFAULT now(),\n  updated_at TIMESTAMPTZ\n);\n</code></pre>"},{"location":"services/user-service/sub/data-model/#usertenantrole","title":"\ud83d\udccc <code>UserTenantRole</code>","text":"<p>Li\u00ean k\u1ebft ng\u01b0\u1eddi d\u00f9ng v\u1edbi c\u00e1c role trong tenant, d\u00f9ng \u0111\u1ec3 expand quy\u1ec1n c\u1ee7a user trong RBACResolver.</p> T\u00ean c\u1ed9t Ki\u1ec3u R\u00e0ng bu\u1ed9c M\u00f4 t\u1ea3 <code>user_id</code> UUID FK \u2192 <code>UserLocal.user_id</code> Ng\u01b0\u1eddi d\u00f9ng \u0111\u01b0\u1ee3c g\u00e1n <code>role_code</code> string FK \u2192 <code>RoleTemplateLite.role_code</code> M\u00e3 role \u0111\u01b0\u1ee3c g\u00e1n <code>permissions</code> string[] Danh s\u00e1ch quy\u1ec1n m\u1edf r\u1ed9ng t\u1eeb role_code (cache local) <pre><code>CREATE TABLE user_tenant_role (\n  user_id UUID REFERENCES user_local(user_id) ON DELETE CASCADE,\n  role_code VARCHAR(64) REFERENCES role_template_lite(role_code),\n  permissions TEXT[],\n  PRIMARY KEY (user_id, role_code)\n);\n</code></pre>"},{"location":"services/user-service/sub/data-model/#roletemplatelite","title":"\ud83d\udccc <code>RoleTemplateLite</code>","text":"<p>B\u1ea3n sao role template \u0111\u00e3 \u0111\u1ed3ng b\u1ed9 t\u1eeb Master. Kh\u00f4ng ch\u1ec9nh s\u1eeda t\u1ea1i Sub.</p> T\u00ean c\u1ed9t Ki\u1ec3u R\u00e0ng bu\u1ed9c M\u00f4 t\u1ea3 <code>role_code</code> string PK M\u00e3 \u0111\u1ecbnh danh role (duy nh\u1ea5t trong h\u1ec7 th\u1ed1ng) <code>name</code> string T\u00ean hi\u1ec3n th\u1ecb c\u1ee7a role <code>description</code> string M\u00f4 t\u1ea3 chi ti\u1ebft role <pre><code>CREATE TABLE role_template_lite (\n  role_code VARCHAR(64) PRIMARY KEY,\n  name VARCHAR(255),\n  description TEXT\n);\n</code></pre>"},{"location":"services/user-service/sub/data-model/#permissiontemplatelite","title":"\ud83d\udccc <code>PermissionTemplateLite</code>","text":"<p>Danh s\u00e1ch c\u00e1c quy\u1ec1n c\u00f3 th\u1ec3 s\u1eed d\u1ee5ng t\u1ea1i tenant, \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 t\u1eeb Master.</p> T\u00ean c\u1ed9t Ki\u1ec3u R\u00e0ng bu\u1ed9c M\u00f4 t\u1ea3 <code>code</code> string PK M\u00e3 permission <code>resource</code> string T\u00e0i nguy\u00ean \u00e1p d\u1ee5ng (VD: <code>student</code>, <code>gradebook</code>) <code>action</code> string H\u00e0nh \u0111\u1ed9ng \u0111\u01b0\u1ee3c ph\u00e9p (VD: <code>view</code>, <code>edit</code>) <code>description</code> string M\u00f4 t\u1ea3 quy\u1ec1n n\u00e0y cho m\u1ee5c \u0111\u00edch UI/Admin <pre><code>CREATE TABLE permission_template_lite (\n  code VARCHAR(128) PRIMARY KEY,\n  resource VARCHAR(64),\n  action VARCHAR(64),\n  description TEXT\n);\n</code></pre>"},{"location":"services/user-service/sub/data-model/#3-rang-buoc-chi-muc-hanh-vi-cascade","title":"3. R\u00e0ng bu\u1ed9c, Ch\u1ec9 m\u1ee5c &amp; H\u00e0nh vi Cascade","text":""},{"location":"services/user-service/sub/data-model/#rang-buoc-hanh-vi-cascade","title":"\ud83d\udd10 R\u00e0ng bu\u1ed9c &amp; H\u00e0nh vi Cascade","text":"<ul> <li><code>UserTenantRole.user_id</code> c\u00f3 <code>ON DELETE CASCADE</code> \u2192 n\u1ebfu user b\u1ecb purge, c\u00e1c vai tr\u00f2 s\u1ebd t\u1ef1 \u0111\u1ed9ng b\u1ecb x\u00f3a.</li> <li><code>UserTenantRole.role_code</code> d\u00f9ng <code>ON DELETE RESTRICT</code> \u2192 tr\u00e1nh l\u1ed7i do m\u1ea5t role \u0111\u1ed3ng b\u1ed9.</li> <li>Kh\u00f4ng c\u00f3 b\u1ea3ng join gi\u1eefa role v\u00e0 permission \u2013 mapping logic n\u1eb1m trong memory (RBACResolver cache).</li> </ul>"},{"location":"services/user-service/sub/data-model/#chi-muc-indexes","title":"\ud83d\udccc Ch\u1ec9 m\u1ee5c (Indexes)","text":"B\u1ea3ng C\u1ed9t \u0111\u01b0\u1ee3c index Lo\u1ea1i index Ghi ch\u00fa <code>UserLocal</code> <code>user_id</code> PK (UUID) Lookup ch\u00ednh <code>UserTenantRole</code> <code>(user_id, role_code)</code> Composite PK Truy v\u1ea5n theo c\u1eb7p user-role <code>UserTenantRole</code> <code>user_id</code> Index Gi\u00fap truy v\u1ea5n nhanh vai tr\u00f2 c\u1ee7a m\u1ed9t user <code>RoleTemplateLite</code> <code>role_code</code> PK Lookup duy nh\u1ea5t theo m\u00e3 role <code>PermissionTemplateLite</code> <code>code</code> PK Lookup duy nh\u1ea5t theo m\u00e3 permission <p>\ud83d\udca1 C\u00e1c b\u1ea3ng template l\u00e0 d\u1eef li\u1ec7u t\u0129nh ch\u1ec9 \u0111\u1ecdc, th\u01b0\u1eddng kh\u00f4ng c\u1ea7n index b\u1ed5 sung ngo\u00e0i kh\u00f3a ch\u00ednh.</p>"},{"location":"services/user-service/sub/data-model/#4-enum-su-dung","title":"4. Enum s\u1eed d\u1ee5ng","text":""},{"location":"services/user-service/sub/data-model/#auth_provider","title":"<code>auth_provider</code>","text":"<ul> <li><code>local</code></li> <li><code>google</code></li> </ul>"},{"location":"services/user-service/sub/data-model/#status","title":"<code>status</code>","text":"<ul> <li><code>active</code></li> <li><code>invited</code></li> <li><code>suspended</code></li> <li><code>deleted</code></li> </ul>"},{"location":"services/user-service/sub/data-model/#5-tuan-thu-adr-chinh-sach","title":"5. Tu\u00e2n th\u1ee7 ADR &amp; Ch\u00ednh s\u00e1ch","text":"ADR M\u00f4 t\u1ea3 li\u00ean quan ADR-024 TTL d\u1eef li\u1ec7u n\u1ebfu user kh\u00f4ng c\u00f2n ho\u1ea1t \u0111\u1ed9ng ADR-026 Quy t\u1eafc x\u1eed l\u00fd <code>purge</code> user ADR-027 Ph\u00e2n quy\u1ec1n \u0111\u1ecdc/ghi theo master/sub ADR-023 Chi\u1ebfn l\u01b0\u1ee3c migration schema"},{"location":"services/user-service/sub/data-model/#6-lien-ket-tai-lieu","title":"6. Li\u00ean k\u1ebft t\u00e0i li\u1ec7u","text":"<ul> <li>Design Document</li> <li>Interface Contract</li> <li>OpenAPI Spec</li> </ul>"},{"location":"services/user-service/sub/design/","title":"\ud83d\udcd8 User Service Sub \u2013 Service Design Document","text":""},{"location":"services/user-service/sub/design/#1-pham-vi-va-trach-nhiem-scope-responsibilities","title":"1. \ud83e\udded Ph\u1ea1m vi v\u00e0 Tr\u00e1ch nhi\u1ec7m (Scope &amp; Responsibilities)","text":""},{"location":"services/user-service/sub/design/#muc-tieu","title":"\ud83c\udfaf M\u1ee5c ti\u00eau","text":"<ul> <li>Cung c\u1ea5p d\u1eef li\u1ec7u ng\u01b0\u1eddi d\u00f9ng n\u1ed9i b\u1ed9 cho frontend trong t\u1eebng tenant.</li> <li>Kh\u00f4ng th\u1ef1c hi\u1ec7n b\u1ea5t k\u1ef3 h\u00e0nh \u0111\u1ed9ng ghi n\u00e0o v\u00e0o d\u1eef li\u1ec7u ng\u01b0\u1eddi d\u00f9ng.</li> <li>To\u00e0n b\u1ed9 d\u1eef li\u1ec7u \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 t\u1eeb <code>user-service/master</code> th\u00f4ng qua c\u01a1 ch\u1ebf event-driven.</li> </ul>"},{"location":"services/user-service/sub/design/#cac-thuc-the-du-lieu-quan-ly","title":"\ud83d\udce6 C\u00e1c th\u1ef1c th\u1ec3 d\u1eef li\u1ec7u qu\u1ea3n l\u00fd","text":"Th\u1ef1c th\u1ec3 M\u00f4 t\u1ea3 <code>UserLocal</code> B\u1ea3n sao c\u1ee7a <code>UserGlobal</code>, l\u01b0u tr\u1ea1ng th\u00e1i ng\u01b0\u1eddi d\u00f9ng trong tenant <code>UserTenantRole</code> Vai tr\u00f2 m\u00e0 ng\u01b0\u1eddi d\u00f9ng \u0111\u01b0\u1ee3c g\u00e1n trong tenant <code>RoleTemplateLite</code> Danh s\u00e1ch role \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 t\u1eeb master <code>PermissionTemplateLite</code> Danh s\u00e1ch quy\u1ec1n \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 t\u1eeb master"},{"location":"services/user-service/sub/design/#ngoai-pham-vi-out-of-scope","title":"\ud83d\udd12 Ngo\u00e0i Ph\u1ea1m Vi (Out of Scope)","text":"<p>Service n\u00e0y kh\u00f4ng th\u1ef1c hi\u1ec7n c\u00e1c t\u00e1c v\u1ee5 sau:</p> <ul> <li>\u274c X\u00e1c th\u1ef1c (authentication): vi\u1ec7c x\u00e1c th\u1ef1c JWT \u0111\u00e3 \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n t\u1ea1i Gateway.</li> <li>\u274c Qu\u1ea3n l\u00fd v\u00f2ng \u0111\u1eddi RBAC template (t\u1ea1o/s\u1eeda/xo\u00e1 role/permission template): Sub ch\u1ec9 consume b\u1ea3n sao \u0111\u00e3 \u0111\u1ed3ng b\u1ed9.</li> <li>\u274c Ghi d\u1eef li\u1ec7u ng\u01b0\u1eddi d\u00f9ng: kh\u00f4ng t\u1ea1o/s\u1eeda/xo\u00e1 ng\u01b0\u1eddi d\u00f9ng ho\u1eb7c role tr\u1ef1c ti\u1ebfp \u2013 ch\u1ec9 nh\u1eadn qua event.</li> <li>\u274c Truy c\u1eadp ho\u1eb7c x\u1eed l\u00fd d\u1eef li\u1ec7u ngo\u00e0i ph\u1ea1m vi tenant \u0111\u01b0\u1ee3c g\u00e1n (\u0111\u1ea3m b\u1ea3o c\u00e1ch ly tenant tuy\u1ec7t \u0111\u1ed1i).</li> <li>\u274c G\u1ecdi sang <code>user-service/master</code> ho\u1eb7c c\u00e1c service kh\u00e1c: kh\u00f4ng c\u00f3 external HTTP call.</li> </ul>"},{"location":"services/user-service/sub/design/#2-thiet-ke-api-chi-tiet-interface-contract","title":"2. \ud83c\udf10 Thi\u1ebft k\u1ebf API chi ti\u1ebft (Interface Contract)","text":"Method Path T\u00e1c v\u1ee5 Y\u00eau c\u1ea7u permission GET <code>/users</code> Danh s\u00e1ch user trong tenant \u2705 <code>tenant.read_users</code> GET <code>/users/me</code> Th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng hi\u1ec7n t\u1ea1i \u274c GET <code>/users/me/permissions</code> Danh s\u00e1ch quy\u1ec1n c\u1ee7a user \u274c GET <code>/roles</code> Role template hi\u1ec7n c\u00f3 \u2705 <code>tenant.view_rbac_config</code> GET <code>/permissions</code> Permission template hi\u1ec7n c\u00f3 \u2705 <code>tenant.view_rbac_config</code> <p>\ud83d\udd27 API d\u00f9ng chu\u1ea9n OpenAPI, tu\u00e2n th\u1ee7 c\u1ea5u tr\u00fac response ADR-012, \u0111\u1ecbnh ngh\u0129a schema ri\u00eang cho t\u1ea5t c\u1ea3 response v\u00e0 error.</p>"},{"location":"services/user-service/sub/design/#vi-du-response-get-usersmepermissions","title":"\ud83d\udce6 V\u00ed d\u1ee5 response <code>GET /users/me/permissions</code>","text":"<pre><code>{\n  \"data\": [\n    \"student.view\",\n    \"attendance.mark\"\n  ],\n  \"meta\": {\n    \"request_id\": \"req-abc-123\",\n    \"timestamp\": \"2025-05-31T14:20:00Z\"\n  }\n}\n</code></pre>"},{"location":"services/user-service/sub/design/#3-mo-hinh-du-lieu-chi-tiet-data-model","title":"3. \ud83d\uddc3\ufe0f M\u00f4 h\u00ecnh d\u1eef li\u1ec7u chi ti\u1ebft (Data Model)","text":""},{"location":"services/user-service/sub/design/#so-o-erd-entity-relationship-diagram","title":"\ud83d\uddfa\ufe0f S\u01a1 \u0111\u1ed3 ERD (Entity Relationship Diagram)","text":"<pre><code>erDiagram\n  UserLocal ||--o{ UserTenantRole : has\n  UserTenantRole }o--|| RoleTemplateLite : references\n  RoleTemplateLite ||--o{ PermissionTemplateLite : includes\n\n  UserLocal {\n    UUID user_id PK\n    STRING email\n    STRING full_name\n    STRING auth_provider\n    STRING status\n    BOOLEAN is_active_in_tenant\n  }\n\n  UserTenantRole {\n    UUID user_id FK\n    STRING role_code FK\n    STRING[] permissions\n  }\n\n  RoleTemplateLite {\n    STRING role_code PK\n    STRING name\n    STRING description\n  }\n\n  PermissionTemplateLite {\n    STRING code PK\n    STRING resource\n    STRING action\n    STRING description\n  }\n</code></pre> <p>\ud83d\udca1 Ghi ch\u00fa: M\u1ed1i quan h\u1ec7 RoleTemplateLite \u2192 PermissionTemplateLite l\u00e0 m\u1ed1i quan h\u1ec7 logic, kh\u00f4ng \u0111\u01b0\u1ee3c bi\u1ec3u di\u1ec5n qua b\u1ea3ng join v\u1eadt l\u00fd. RBACResolver t\u1ea1i Sub s\u1ebd t\u1ef1 \u0111\u1ed9ng \"expand\" permissions d\u1ef1a tr\u00ean b\u1ea3n cache template t\u1eeb Master.</p>"},{"location":"services/user-service/sub/design/#bang-userlocal","title":"B\u1ea3ng: <code>UserLocal</code>","text":"C\u1ed9t Ki\u1ec3u Ghi ch\u00fa <code>user_id</code> UUID Primary key <code>email</code> string <code>full_name</code> string <code>auth_provider</code> enum [local, google] <code>status</code> enum Mirror t\u1eeb UserGlobal <code>is_active_in_tenant</code> boolean T\u00ednh t\u1eeb <code>assignment_status</code> &amp; <code>status</code> <code>created_at</code> datetime <code>updated_at</code> datetime"},{"location":"services/user-service/sub/design/#bang-usertenantrole","title":"B\u1ea3ng: <code>UserTenantRole</code>","text":"C\u1ed9t Ki\u1ec3u Ghi ch\u00fa <code>user_id</code> UUID <code>role_code</code> string <code>permissions</code> string[] Expand t\u1eeb <code>role_code</code>"},{"location":"services/user-service/sub/design/#bang-roletemplatelite","title":"B\u1ea3ng: <code>RoleTemplateLite</code>","text":"<p>| <code>role_code</code>   | string | Primary key | | <code>name</code>        | string |             | | <code>description</code> | string |             |</p>"},{"location":"services/user-service/sub/design/#bang-permissiontemplatelite","title":"B\u1ea3ng: <code>PermissionTemplateLite</code>","text":"<p>| <code>code</code>        | string | Primary key | | <code>resource</code>    | string |             | | <code>action</code>      | string |             | | <code>description</code> | string |             |</p>"},{"location":"services/user-service/sub/design/#4-luong-xu-ly-nghiep-vu-chinh-business-logic-flows","title":"4. \ud83d\udd04 Lu\u1ed3ng x\u1eed l\u00fd nghi\u1ec7p v\u1ee5 ch\u00ednh (Business Logic Flows)","text":""},{"location":"services/user-service/sub/design/#get-usersmepermissions","title":"<code>GET /users/me/permissions</code>","text":"<pre><code>sequenceDiagram\n  participant Frontend\n  participant API\n  participant RBACResolver\n  participant DB\n\n  Frontend-&gt;&gt;API: GET /users/me/permissions\n  API-&gt;&gt;RBACResolver: getPermissions(user_id)\n  RBACResolver-&gt;&gt;DB: Fetch role_code(s) for user\n  RBACResolver-&gt;&gt;DB: Expand role_code \u2192 permission list\n  RBACResolver--&gt;&gt;API: permission[]\n  API--&gt;&gt;Frontend: 200 OK + permissions\n</code></pre>"},{"location":"services/user-service/sub/design/#5-cac-su-kien-pubsub","title":"5. \ud83d\udce3 C\u00e1c s\u1ef1 ki\u1ec7n Pub/Sub","text":"S\u1ef1 ki\u1ec7n nh\u1eadn H\u00e0nh \u0111\u1ed9ng t\u1ea1i Sub Service <code>user_global_created</code> Insert <code>UserLocal</code> <code>user_updated</code> Update <code>UserLocal</code> <code>user_assigned_to_tenant</code> Insert/Update <code>UserTenantRole</code>, \u0111\u00e1nh d\u1ea5u <code>is_active_in_tenant = true</code> <code>user_removed_from_tenant</code> C\u1eadp nh\u1eadt <code>is_active_in_tenant = false</code> <code>purge_user_from_tenant</code> (tu\u1ef3 ch\u1ecdn) Xo\u00e1 v\u1eadt l\u00fd <code>UserLocal</code> n\u1ebfu ch\u00ednh s\u00e1ch cho ph\u00e9p <code>rbac_template_updated</code> C\u1eadp nh\u1eadt b\u1ea3ng <code>RoleTemplateLite</code>, <code>PermissionTemplateLite</code>"},{"location":"services/user-service/sub/design/#vi-du-payload-su-kien-tieu-bieu-event-payloads","title":"\ud83d\udce6 V\u00ed d\u1ee5 Payload S\u1ef1 Ki\u1ec7n Ti\u00eau Bi\u1ec3u (Event Payloads)","text":"<pre><code>// user_assigned_to_tenant\n{\n  \"event\": \"user_assigned_to_tenant\",\n  \"user_id\": \"uuid-1234\",\n  \"tenant_id\": \"tenant-abc\",\n  \"role_code\": \"teacher\",\n  \"assigned_by\": \"admin-user-999\",\n  \"assigned_at\": \"2025-05-01T10:00:00Z\"\n}\n</code></pre> <pre><code>// rbac_template_updated\n{\n  \"event\": \"rbac_template_updated\",\n  \"role_code\": \"teacher\",\n  \"permissions\": [\n    { \"code\": \"student.view\", \"resource\": \"student\", \"action\": \"view\" },\n    { \"code\": \"attendance.mark\", \"resource\": \"attendance\", \"action\": \"update\" }\n  ],\n  \"updated_at\": \"2025-05-01T09:30:00Z\"\n}\n</code></pre>"},{"location":"services/user-service/sub/design/#6-bao-mat-phan-quyen","title":"6. \ud83d\udd10 B\u1ea3o m\u1eadt &amp; Ph\u00e2n quy\u1ec1n","text":"<ul> <li>Auth: s\u1eed d\u1ee5ng JWT token c\u1ea5p tenant.</li> <li>C\u00e1c API <code>/users</code>, <code>/roles</code>, <code>/permissions</code> khai b\u00e1o <code>x-required-permission</code> r\u00f5 r\u00e0ng, nh\u01b0ng kh\u00f4ng t\u1ef1 ki\u1ec3m tra.</li> <li>Vi\u1ec7c th\u1ef1c thi (<code>enforce</code>) quy\u1ec1n s\u1ebd do API Gateway \u0111\u1ea3m nhi\u1ec7m d\u1ef1a tr\u00ean JWT v\u00e0 RBAC cache.</li> <li>C\u00e1c API <code>/me</code>, <code>/me/permissions</code> ch\u1ec9 c\u1ea7n token h\u1ee3p l\u1ec7, kh\u00f4ng c\u1ea7n th\u00eam permission.</li> </ul>"},{"location":"services/user-service/sub/design/#7-cau-hinh-phu-thuoc-dependencies","title":"7. \u2699\ufe0f C\u1ea5u h\u00ecnh &amp; Ph\u1ee5 thu\u1ed9c (Dependencies)","text":"Th\u00e0nh ph\u1ea7n M\u1ee5c \u0111\u00edch <code>PG_HOST</code>, <code>PG_DB</code> K\u1ebft n\u1ed1i database <code>KAFKA_BROKER</code> L\u1eafng nghe s\u1ef1 ki\u1ec7n t\u1eeb Master <code>TENANT_ID</code> G\u00e1n c\u1ee9ng trong m\u1ed7i instance c\u1ee7a Sub <code>JWT_SECRET</code> X\u00e1c th\u1ef1c token <p>Sub-service n\u00e0y kh\u00f4ng g\u1ecdi tr\u1ef1c ti\u1ebfp service kh\u00e1c, ch\u1ec9 consume event.</p>"},{"location":"services/user-service/sub/design/#8-testing","title":"8. \ud83e\uddea Testing","text":""},{"location":"services/user-service/sub/design/#unit-test","title":"\ud83d\udd39 Unit Test","text":"<ul> <li>RBACResolver.expand()</li> <li>Mappers &amp; converters DB \u2192 API response</li> <li>Schema validator cho OpenAPI</li> </ul>"},{"location":"services/user-service/sub/design/#integration-test","title":"\ud83d\udd39 Integration Test","text":"<ul> <li>Simulate event t\u1eeb Master \u2192 assert DB update</li> <li>Test endpoint <code>/me/permissions</code> tr\u1ea3 v\u1ec1 ch\u00ednh x\u00e1c v\u1edbi nhi\u1ec1u role</li> </ul> <p>\ud83e\uddea C\u00f3 th\u1ec3 s\u1eed d\u1ee5ng tools nh\u01b0 <code>pytest</code>, <code>testcontainers</code>, ho\u1eb7c <code>async-kafka</code> mock \u0111\u1ec3 ki\u1ec3m tra event flow</p>"},{"location":"services/user-service/sub/design/#9-kha-nang-giam-sat-observability","title":"9. \ud83d\udcc8 Kh\u1ea3 n\u0103ng Gi\u00e1m s\u00e1t (Observability)","text":"Metric M\u00f4 t\u1ea3 <code>sub_user_sync_total</code> T\u1ed5ng s\u1ed1 user \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 t\u1eeb master <code>sub_event_consume_latency</code> \u0110\u1ed9 tr\u1ec5 trung b\u00ecnh khi x\u1eed l\u00fd 1 event <code>sub_event_error_count</code> S\u1ed1 l\u01b0\u1ee3ng l\u1ed7i khi x\u1eed l\u00fd event (c\u00f3 th\u1ec3 chia theo type) <code>api_get_users_latency</code> Th\u1eddi gian x\u1eed l\u00fd <code>GET /users</code> trung b\u00ecnh <code>api_get_me_permissions_cache_hit_rate</code> T\u1ef7 l\u1ec7 cache hit n\u1ebfu s\u1eed d\u1ee5ng Redis cho permission cache <p>N\u00ean expose c\u00e1c metric n\u00e0y qua Prometheus n\u1ebfu c\u00f3 setup observability chung.</p>"},{"location":"services/user-service/sub/design/#10-o-tin-cay-phuc-hoi-reliability-resilience","title":"10. \ud83d\udd01 \u0110\u1ed9 tin c\u1eady &amp; Ph\u1ee5c h\u1ed3i (Reliability &amp; Resilience)","text":"<ul> <li>C\u01a1 ch\u1ebf retry event: T\u1ed1i thi\u1ec3u 3 l\u1ea7n n\u1ebfu event x\u1eed l\u00fd th\u1ea5t b\u1ea1i, sau \u0111\u00f3 ghi v\u00e0o Dead Letter Queue (DLQ).</li> <li>Idempotency key: D\u1ef1a tr\u00ean <code>user_id + tenant_id + event_type</code>, \u0111\u1ea3m b\u1ea3o vi\u1ec7c consume event kh\u00f4ng g\u00e2y tr\u00f9ng l\u1eb7p d\u1eef li\u1ec7u.</li> <li>Theo d\u00f5i offset Kafka: \u0110\u1ea3m b\u1ea3o event kh\u00f4ng b\u1ecb m\u1ea5t ho\u1eb7c x\u1eed l\u00fd tr\u1ec5.</li> </ul>"},{"location":"services/user-service/sub/design/#11-hieu-nang-kha-nang-mo-rong","title":"11. \u26a1\ufe0f Hi\u1ec7u n\u0103ng &amp; Kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng","text":"<ul> <li> <p>SLO \u0111\u1ec1 xu\u1ea5t:</p> </li> <li> <p><code>GET /users</code>: &lt;150ms v\u1edbi tenant \u2264 1000 ng\u01b0\u1eddi d\u00f9ng</p> </li> <li><code>GET /users/me/permissions</code>: &lt;100ms (cacheable)</li> <li>Scalability: sub-service c\u00f3 th\u1ec3 scale horizontally, m\u1ed7i instance g\u1eafn v\u1edbi 1 tenant.</li> <li>Caching (t\u00f9y ch\u1ecdn): <code>GET /users/me/permissions</code> c\u00f3 th\u1ec3 \u0111\u01b0\u1ee3c cache theo session.</li> </ul>"},{"location":"services/user-service/sub/design/#12-tai-lieu-lien-ket","title":"12. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean k\u1ebft","text":"<ul> <li>Interface Contract: \u0110\u1eb7c t\u1ea3 chi ti\u1ebft c\u00e1c API \u0111\u01b0\u1ee3c service cung c\u1ea5p</li> <li>Data Model: Thi\u1ebft k\u1ebf schema CSDL chi ti\u1ebft cho service</li> <li>OpenAPI: M\u00f4 t\u1ea3 chu\u1ea9n OpenAPI 3.1 cho c\u00e1c endpoint</li> <li>adr-012 - Response Structure: Chu\u1ea9n \u0111\u1ecbnh d\u1ea1ng API response to\u00e0n h\u1ec7 th\u1ed1ng</li> <li>adr-026 - Hard Delete Policy: Ch\u00ednh s\u00e1ch x\u00f3a c\u1ee9ng d\u1eef li\u1ec7u</li> <li>adr-027 - Data Management Strategy: Chi\u1ebfn l\u01b0\u1ee3c qu\u1ea3n l\u00fd d\u1eef li\u1ec7u gi\u1eefa Master/Sub </li> </ul>"},{"location":"services/user-service/sub/interface-contract/","title":"\ud83d\udcd8 User Service Sub \u2013 Interface Contract","text":""},{"location":"services/user-service/sub/interface-contract/#1-tong-quan","title":"1. \ud83c\udfaf T\u1ed5ng quan","text":""},{"location":"services/user-service/sub/interface-contract/#muc-ich","title":"M\u1ee5c \u0111\u00edch","text":"<p>Cung c\u1ea5p \u0111\u1eb7c t\u1ea3 chi ti\u1ebft cho c\u00e1c API \u0111\u01b0\u1ee3c exposed b\u1edfi <code>user-service/sub</code>, ph\u1ee5c v\u1ee5 frontend v\u00e0 c\u00e1c client thu\u1ed9c tenant. C\u00e1c API n\u00e0y ch\u1ee7 y\u1ebfu mang t\u00ednh read-only, s\u1eed d\u1ee5ng d\u1eef li\u1ec7u \u0111\u1ed3ng b\u1ed9 t\u1eeb <code>user-service/master</code>.</p>"},{"location":"services/user-service/sub/interface-contract/#oi-tuong-su-dung","title":"\u0110\u1ed1i t\u01b0\u1ee3ng s\u1eed d\u1ee5ng","text":"<ul> <li>Frontend Webapp n\u1ed9i b\u1ed9 cho tenant</li> <li>Gateway Service (th\u1ef1c thi RBAC)</li> </ul>"},{"location":"services/user-service/sub/interface-contract/#nguyen-tac-chung","title":"Nguy\u00ean t\u1eafc chung","text":"<ul> <li>Sub kh\u00f4ng x\u1eed l\u00fd x\u00e1c th\u1ef1c/\u1ee7y quy\u1ec1n tr\u1ef1c ti\u1ebfp, ch\u1ec9 nh\u1eadn JWT header t\u1eeb Gateway</li> <li>C\u00e1c API lu\u00f4n tr\u1ea3 v\u1ec1 theo chu\u1ea9n ADR-012 Response Structure</li> <li>C\u00e1c l\u1ed7i s\u1eed d\u1ee5ng theo ADR-011 Error Format</li> </ul>"},{"location":"services/user-service/sub/interface-contract/#2-api-summary-table","title":"2. \ud83d\udcdc API Summary Table","text":"Method Path M\u00f4 t\u1ea3 RBAC Permission GET <code>/users</code> Danh s\u00e1ch user trong tenant <code>tenant.read_users</code> GET <code>/users/me</code> Th\u00f4ng tin ng\u01b0\u1eddi d\u00f9ng hi\u1ec7n t\u1ea1i \u2013 GET <code>/users/me/permissions</code> Danh s\u00e1ch quy\u1ec1n c\u1ee7a user \u2013 GET <code>/roles</code> Role templates \u0111\u00e3 \u0111\u1ed3ng b\u1ed9 <code>tenant.view_rbac_config</code> GET <code>/permissions</code> Permission templates \u0111\u00e3 \u0111\u1ed3ng b\u1ed9 <code>tenant.view_rbac_config</code>"},{"location":"services/user-service/sub/interface-contract/#3-chi-tiet-tung-api","title":"3. \ud83d\udd0d Chi ti\u1ebft t\u1eebng API","text":""},{"location":"services/user-service/sub/interface-contract/#get-users","title":"GET <code>/users</code>","text":"<p>Tr\u1ea3 v\u1ec1 danh s\u00e1ch ng\u01b0\u1eddi d\u00f9ng trong tenant hi\u1ec7n t\u1ea1i.</p> <ul> <li>RBAC Required: <code>tenant.read_users</code></li> <li>Query Params:</li> <li><code>page</code>: integer (default: 1)</li> <li><code>limit</code>: integer (default: 20)</li> <li><code>search</code>: optional, t\u00ecm theo t\u00ean ho\u1eb7c email</li> <li> <p>Response: <pre><code>{\n  \"data\": [\n    {\n      \"user_id\": \"uuid-1234\",\n      \"full_name\": \"Nguyen Van A\",\n      \"email\": \"a@example.com\",\n      \"status\": \"active\",\n      \"is_active_in_tenant\": true\n    }\n  ],\n  \"meta\": {\n    \"page\": 1,\n    \"per_page\": 20,\n    \"total\": 1,\n    \"request_id\": \"req-abc\",\n    \"timestamp\": \"2025-06-01T10:00:00Z\"\n  }\n}\n</code></pre></p> </li> <li> <p>Status Codes:</p> </li> <li> <p><code>200 OK</code>: Th\u00e0nh c\u00f4ng</p> </li> <li><code>401 Unauthorized</code>: Thi\u1ebfu JWT ho\u1eb7c kh\u00f4ng h\u1ee3p l\u1ec7</li> <li><code>403 Forbidden</code>: Kh\u00f4ng \u0111\u1ee7 quy\u1ec1n truy c\u1eadp</li> <li><code>500 Internal Server Error</code>: L\u1ed7i h\u1ec7 th\u1ed1ng</li> </ul>"},{"location":"services/user-service/sub/interface-contract/#get-usersme","title":"GET <code>/users/me</code>","text":"<p>Tr\u1ea3 v\u1ec1 th\u00f4ng tin user hi\u1ec7n t\u1ea1i (theo JWT).</p> <ul> <li>RBAC: kh\u00f4ng y\u00eau c\u1ea7u</li> <li>Headers: <code>Authorization: Bearer &lt;JWT&gt;</code></li> <li>Response: nh\u01b0 <code>UserLocal</code></li> <li> <p>Status Codes:</p> </li> <li> <p><code>200 OK</code></p> </li> <li><code>401 Unauthorized</code></li> <li><code>500 Internal Server Error</code></li> </ul>"},{"location":"services/user-service/sub/interface-contract/#get-usersmepermissions","title":"GET <code>/users/me/permissions</code>","text":"<p>Tr\u1ea3 v\u1ec1 danh s\u00e1ch quy\u1ec1n ng\u01b0\u1eddi d\u00f9ng hi\u1ec7n t\u1ea1i \u0111\u00e3 \u0111\u01b0\u1ee3c expand.</p> <ul> <li>RBAC: kh\u00f4ng y\u00eau c\u1ea7u</li> <li>Response:</li> </ul> <pre><code>{\n  \"data\": [\n    \"student.view\",\n    \"attendance.mark\"\n  ],\n  \"meta\": {\n    \"request_id\": \"req-xyz\",\n    \"timestamp\": \"2025-06-01T11:00:00Z\"\n  }\n}\n</code></pre> <ul> <li> <p>Status Codes:</p> </li> <li> <p><code>200 OK</code></p> </li> <li><code>401 Unauthorized</code></li> <li><code>500 Internal Server Error</code></li> </ul>"},{"location":"services/user-service/sub/interface-contract/#get-roles","title":"GET <code>/roles</code>","text":"<p>Tr\u1ea3 v\u1ec1 danh s\u00e1ch role template \u0111\u00e3 \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9.</p> <ul> <li>RBAC Required: <code>tenant.view_rbac_config</code></li> <li>Response:</li> </ul> <pre><code>{\n  \"data\": [\n    {\n      \"role_code\": \"teacher\",\n      \"name\": \"Gi\u00e1o vi\u00ean\",\n      \"description\": \"Vai tr\u00f2 cho gi\u00e1o vi\u00ean\"\n    }\n  ],\n  \"meta\": { ... }\n}\n</code></pre> <ul> <li> <p>Status Codes:</p> </li> <li> <p><code>200 OK</code></p> </li> <li><code>401 Unauthorized</code></li> <li><code>403 Forbidden</code></li> <li><code>500 Internal Server Error</code></li> </ul>"},{"location":"services/user-service/sub/interface-contract/#get-permissions","title":"GET <code>/permissions</code>","text":"<p>Tr\u1ea3 v\u1ec1 danh s\u00e1ch permission template \u0111\u00e3 \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9.</p> <ul> <li>RBAC Required: <code>tenant.view_rbac_config</code></li> <li>Response:</li> </ul> <pre><code>{\n  \"data\": [\n    {\n      \"code\": \"student.view\",\n      \"resource\": \"student\",\n      \"action\": \"view\",\n      \"description\": \"Xem h\u1ed3 s\u01a1 h\u1ecdc sinh\"\n    }\n  ],\n  \"meta\": { ... }\n}\n</code></pre> <ul> <li> <p>Status Codes:</p> </li> <li> <p><code>200 OK</code></p> </li> <li><code>401 Unauthorized</code></li> <li><code>403 Forbidden</code></li> <li><code>500 Internal Server Error</code></li> </ul>"},{"location":"services/user-service/sub/interface-contract/#4-phu-luc-error-codes-enum-va-permission-code","title":"4. \ud83d\udcd1 Ph\u1ee5 l\u1ee5c: Error Codes, ENUM v\u00e0 Permission Code","text":""},{"location":"services/user-service/sub/interface-contract/#chuan-hoa-ma-loi-error-codes","title":"\ud83d\udcda Chu\u1ea9n h\u00f3a m\u00e3 l\u1ed7i (Error Codes)","text":"<p>T\u1ea5t c\u1ea3 c\u00e1c m\u00e3 l\u1ed7i (<code>error.code</code>) trong response ph\u1ea3i tu\u00e2n th\u1ee7 theo chu\u1ea9n \u0111\u1ecbnh danh namespace \u0111\u01b0\u1ee3c m\u00f4 t\u1ea3 t\u1ea1i:</p> <ul> <li>Error Codes</li> <li>ADR-011 Error Format</li> </ul> <p>Y\u00eau c\u1ea7u b\u1eaft bu\u1ed9c:</p> <ul> <li> <p>M\u00e3 l\u1ed7i ph\u1ea3i vi\u1ebft theo d\u1ea1ng snake_case, c\u00f3 namespace ph\u00e2n t\u00e1ch r\u00f5 r\u00e0ng, v\u00ed d\u1ee5:</p> </li> <li> <p><code>user_sub.user_not_found</code></p> </li> <li><code>auth.invalid_token</code></li> <li><code>common.validation_failed</code></li> <li> <p>M\u1ed7i response l\u1ed7i (401, 403, 404, 422...) ph\u1ea3i tr\u1ea3 v\u1ec1 \u0111\u1ed1i t\u01b0\u1ee3ng <code>ErrorEnvelope</code>, g\u1ed3m 2 ph\u1ea7n:</p> </li> <li> <p><code>error</code> \u2013 ch\u1ee9a <code>code</code>, <code>message</code>, <code>details</code></p> </li> <li><code>meta</code> \u2013 ch\u1ee9a <code>trace_id</code>, <code>timestamp</code></li> </ul> <p>G\u1ee3i \u00fd th\u1ef1c h\u00e0nh:</p> <ul> <li>Kh\u00f4ng d\u00f9ng c\u00e1c m\u00e3 l\u1ed7i chung chung nh\u01b0 <code>\"BAD_REQUEST\"</code>, <code>\"NOT_FOUND\"</code>, <code>\"FORBIDDEN\"</code></li> <li>Lu\u00f4n khai b\u00e1o v\u00ed d\u1ee5 c\u1ee5 th\u1ec3 (v\u00ed d\u1ee5 trong <code>components/examples/</code> ho\u1eb7c inline OpenAPI) \u0111\u1ec3 gi\u00fap dev hi\u1ec3u nhanh</li> <li>T\u00e1i s\u1eed d\u1ee5ng error namespace c\u00f3 s\u1eb5n t\u1eeb <code>error-codes.md</code> ho\u1eb7c khai b\u00e1o namespace m\u1edbi n\u1ebfu c\u1ea7n</li> </ul>"},{"location":"services/user-service/sub/interface-contract/#enum-status-userlocal","title":"\u2705 ENUM: <code>status</code> (UserLocal)","text":"<ul> <li><code>active</code></li> <li><code>invited</code></li> <li><code>suspended</code></li> <li><code>deleted</code></li> </ul>"},{"location":"services/user-service/sub/interface-contract/#enum-auth_provider","title":"\u2705 ENUM: <code>auth_provider</code>","text":"<ul> <li><code>local</code></li> <li><code>google</code></li> <li><code>otp</code></li> </ul>"},{"location":"services/user-service/sub/interface-contract/#permission-codes-su-dung","title":"\u2705 Permission Codes s\u1eed d\u1ee5ng","text":"<ul> <li><code>tenant.read_users</code></li> <li><code>tenant.view_rbac_config</code></li> </ul>"},{"location":"services/user-service/sub/interface-contract/#5-tai-lieu-lien-ket","title":"5. \ud83d\udcda T\u00e0i li\u1ec7u li\u00ean k\u1ebft","text":"<ul> <li>Design Document</li> <li>Data Model</li> <li>OpenAPI Spec</li> <li>ADR-012 Response Structure</li> <li>ADR-011 Error Format</li> <li>ADR-027 Data Management Strategy</li> <li>Error Codes</li> </ul>"},{"location":"standards/5s.contract.testing.standard/","title":"\u2705 CHECKLIST: Ti\u00eau chu\u1ea9n 5 Sao cho Contract Testing","text":""},{"location":"standards/5s.contract.testing.standard/#1-star-hop-ong-ton-tai-happy-path","title":"\u2b50 1-Star: H\u1ee3p \u0111\u1ed3ng T\u1ed3n t\u1ea1i &amp; \"Happy Path\"","text":"<ul> <li><code>[ ]</code> T\u1ed3n t\u1ea1i file contract: \u0110\u00e3 t\u1ea1o file contract (<code>*.pact.json</code>) cho c\u1eb7p consumer-provider.</li> <li><code>[ ]</code> Ki\u1ec3m tra lu\u1ed3ng th\u00e0nh c\u00f4ng: \u0110\u00e3 c\u00f3 \u00edt nh\u1ea5t m\u1ed9t \"interaction\" ki\u1ec3m tra k\u1ecbch b\u1ea3n th\u00e0nh c\u00f4ng c\u01a1 b\u1ea3n nh\u1ea5t.</li> <li><code>[ ]</code> X\u00e1c th\u1ef1c Method &amp; Path: Interaction \u0111\u00e3 x\u00e1c th\u1ef1c \u0111\u00fang ph\u01b0\u01a1ng th\u1ee9c HTTP v\u00e0 \u0111\u01b0\u1eddng d\u1eabn.</li> <li><code>[ ]</code> X\u00e1c th\u1ef1c m\u00e3 tr\u1ea1ng th\u00e1i HTTP th\u00e0nh c\u00f4ng: Interaction kh\u1eb3ng \u0111\u1ecbnh status code th\u00e0nh c\u00f4ng ch\u00ednh x\u00e1c (v\u00ed d\u1ee5: <code>200 OK</code>, <code>201 Created</code>).</li> <li><code>[ ]</code> X\u00e1c th\u1ef1c C\u1ea5u tr\u00fac Body: Body c\u1ee7a response \u0111\u01b0\u1ee3c x\u00e1c th\u1ef1c v\u1ec1 m\u1eb7t c\u1ea5u tr\u00fac b\u1eb1ng <code>matcher</code> c\u1ee7a Pact (kh\u00f4ng hardcode gi\u00e1 tr\u1ecb).</li> <li><code>[ ]</code> X\u00e1c th\u1ef1c Headers c\u01a1 b\u1ea3n: Interaction \u0111\u00e3 ki\u1ec3m tra s\u1ef1 t\u1ed3n t\u1ea1i v\u00e0 gi\u00e1 tr\u1ecb c\u1ee7a c\u00e1c header quan tr\u1ecdng nh\u01b0 <code>Content-Type</code>.</li> </ul>"},{"location":"standards/5s.contract.testing.standard/#2-star-bao-quat-kich-ban-loi-error-cases","title":"\u2b50\u2b50 2-Star: Bao qu\u00e1t K\u1ecbch b\u1ea3n L\u1ed7i (Error Cases)","text":"<ul> <li><code>[ ]</code> Ki\u1ec3m tra l\u1ed7i 404 (Not Found): \u0110\u00e3 c\u00f3 interaction cho tr\u01b0\u1eddng h\u1ee3p t\u00e0i nguy\u00ean kh\u00f4ng t\u1ed3n t\u1ea1i.</li> <li><code>[ ]</code> Ki\u1ec3m tra l\u1ed7i 401/403 (Unauthorized/Forbidden): \u0110\u00e3 c\u00f3 interaction cho tr\u01b0\u1eddng h\u1ee3p request thi\u1ebfu ho\u1eb7c sai th\u00f4ng tin x\u00e1c th\u1ef1c/ph\u00e2n quy\u1ec1n.</li> <li><code>[ ]</code> Ki\u1ec3m tra l\u1ed7i 400 (Bad Request): \u0110\u00e3 c\u00f3 interaction cho tr\u01b0\u1eddng h\u1ee3p request g\u1eedi l\u00ean v\u1edbi payload kh\u00f4ng h\u1ee3p l\u1ec7.</li> <li><code>[ ]</code> X\u00e1c th\u1ef1c \u0111\u1ecbnh d\u1ea1ng ErrorEnvelope: M\u1ecdi interaction l\u1ed7i \u0111\u1ec1u x\u00e1c th\u1ef1c r\u1eb1ng body c\u1ee7a response tu\u00e2n th\u1ee7 \u0111\u00fang c\u1ea5u tr\u00fac <code>ErrorEnvelope</code> trong <code>ADR-011</code>.</li> <li><code>[ ]</code> X\u00e1c th\u1ef1c M\u00e3 l\u1ed7i c\u1ee5 th\u1ec3: Interaction l\u1ed7i \u0111\u00e3 ki\u1ec3m tra <code>error.code</code> tr\u1ea3 v\u1ec1 l\u00e0 m\u1ed9t gi\u00e1 tr\u1ecb c\u1ee5 th\u1ec3 trong file <code>standards/error-codes.md</code>.</li> </ul>"},{"location":"standards/5s.contract.testing.standard/#3-star-xac-thuc-theo-ngu-canh-context-aware","title":"\u2b50\u2b50\u2b50 3-Star: X\u00e1c th\u1ef1c theo Ng\u1eef c\u1ea3nh (Context-Aware)","text":"<ul> <li><code>[ ]</code> Header Authorization s\u1eed d\u1ee5ng matcher: Contract \u0111\u00e3 bao g\u1ed3m header <code>Authorization</code> v\u00e0 s\u1eed d\u1ee5ng matcher (kh\u00f4ng hardcode token).</li> <li><code>[ ]</code> Bao g\u1ed3m Tenant Header: Interaction \u0111\u00e3 bao g\u1ed3m header <code>X-Tenant-ID</code> \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o t\u00ednh \u0111\u00fang \u0111\u1eafn trong m\u00f4i tr\u01b0\u1eddng multi-tenant.</li> <li><code>[ ]</code> S\u1eed d\u1ee5ng Provider States: \u0110\u00e3 s\u1eed d\u1ee5ng <code>providerState</code> \u0111\u1ec3 m\u00f4 t\u1ea3 \u0111i\u1ec1u ki\u1ec7n ti\u00ean quy\u1ebft ph\u00eda provider cho t\u1eebng interaction (v\u00ed d\u1ee5: <code>given('a user with id 123 exists')</code>, <code>given('the resource is not found')</code>).</li> </ul>"},{"location":"standards/5s.contract.testing.standard/#4-star-tich-hop-cicd-tu-ong-hoa","title":"\u2b50\u2b50\u2b50\u2b50 4-Star: T\u00edch h\u1ee3p CI/CD &amp; T\u1ef1 \u0111\u1ed9ng h\u00f3a","text":"<ul> <li><code>[ ]</code> Consumer t\u1ef1 \u0111\u1ed9ng publish: Pipeline CI/CD c\u1ee7a consumer t\u1ef1 \u0111\u1ed9ng publish contract l\u00ean Pact Broker.</li> <li><code>[ ]</code> Provider t\u1ef1 \u0111\u1ed9ng verify: Pipeline CI/CD c\u1ee7a provider t\u1ef1 \u0111\u1ed9ng l\u1ea5y v\u00e0 x\u00e1c th\u1ef1c c\u00e1c contract t\u1eeb Pact Broker.</li> <li><code>[ ]</code> Ch\u1eb7n build/release khi th\u1ea5t b\u1ea1i: Pipeline c\u1ee7a provider \u0111\u01b0\u1ee3c c\u1ea5u h\u00ecnh \u0111\u1ec3 B\u00c1O L\u1ed6I (fail) v\u00e0 ch\u1eb7n vi\u1ec7c release n\u1ebfu x\u00e1c th\u1ef1c contract kh\u00f4ng th\u00e0nh c\u00f4ng.</li> <li><code>[ ]</code> S\u1eed d\u1ee5ng Tagging: C\u00e1c contract v\u00e0 k\u1ebft qu\u1ea3 x\u00e1c th\u1ef1c \u0111\u01b0\u1ee3c g\u1eafn th\u1ebb (tag) v\u1edbi t\u00ean branch ho\u1eb7c phi\u00ean b\u1ea3n trong Pact Broker \u0111\u1ec3 h\u1ed7 tr\u1ee3 <code>can-i-deploy</code>.</li> </ul>"},{"location":"standards/5s.contract.testing.standard/#5-star-quan-tri-hop-ong-song","title":"\u2b50\u2b50\u2b50\u2b50\u2b50 5-Star: Qu\u1ea3n tr\u1ecb &amp; \"H\u1ee3p \u0111\u1ed3ng s\u1ed1ng\"","text":"<ul> <li><code>[ ]</code> M\u00f4 t\u1ea3 nghi\u1ec7p v\u1ee5 r\u00f5 r\u00e0ng: M\u1ed7i interaction trong contract c\u00f3 m\u1ed9t tr\u01b0\u1eddng <code>description</code> r\u00f5 r\u00e0ng, m\u00f4 t\u1ea3 m\u1ee5c \u0111\u00edch nghi\u1ec7p v\u1ee5.</li> <li><code>[ ]</code> Kh\u00f4ng hardcode gi\u00e1 tr\u1ecb \u0111\u1ed9ng: \u0110\u00e3 s\u1eed d\u1ee5ng <code>matchers</code> tri\u1ec7t \u0111\u1ec3 cho c\u00e1c gi\u00e1 tr\u1ecb \u0111\u1ed9ng nh\u01b0 <code>id</code>, <code>timestamp</code>, <code>tenant_id</code> \u0111\u1ec3 contract linh ho\u1ea1t, kh\u00f4ng b\u1ecb g\u00e3y v\u1ee1.</li> <li>`[ ]] Ki\u1ec3m tra T\u01b0\u01a1ng th\u00edch ng\u01b0\u1ee3c (Backward-Compatibility): (B\u1ed5 sung) Tr\u01b0\u1edbc khi publish contract m\u1edbi, pipeline c\u00f3 b\u01b0\u1edbc ki\u1ec3m tra \u0111\u1ec3 \u0111\u1ea3m b\u1ea3o n\u00f3 kh\u00f4ng ph\u00e1 v\u1ee1 t\u01b0\u01a1ng th\u00edch v\u1edbi phi\u00ean b\u1ea3n provider \u0111ang ch\u1ea1y tr\u00ean production.</li> <li><code>[ ]</code> Li\u00ean k\u1ebft t\u00e0i li\u1ec7u (Documentation Link): (B\u1ed5 sung) Ph\u1ea7n m\u00f4 t\u1ea3 c\u1ee7a contract ho\u1eb7c <code>README</code> c\u1ee7a th\u01b0 m\u1ee5c test c\u00f3 ch\u1ee9a li\u00ean k\u1ebft \u0111\u1ebfn t\u00e0i li\u1ec7u ADR ho\u1eb7c OpenAPI li\u00ean quan.</li> <li><code>[ ]</code> L\u00e0 m\u1ed9t ph\u1ea7n c\u1ee7a Code Review: File contract \u0111\u01b0\u1ee3c review c\u1ea9n th\u1eadn nh\u01b0 m\u1ed9t ph\u1ea7n c\u1ee7a m\u00e3 ngu\u1ed3n trong m\u1ed7i Pull Request, d\u1ef1a tr\u00ean checklist n\u00e0y.</li> </ul>"},{"location":"standards/5s.data.model.standard/","title":"5s.data.model.standard","text":""},{"location":"standards/5s.data.model.standard/#checklist-tieu-chuan-5-cho-file-data-modelmd-mo-hinh-du-lieu-service","title":"\u2705 Checklist Ti\u00eau Chu\u1ea9n 5\u2605 cho File <code>data-model.md</code> (M\u00f4 h\u00ecnh D\u1eef li\u1ec7u Service)","text":"<p>M\u1ed9t file <code>data-model.md</code> \u0111\u01b0\u1ee3c \u0111\u00e1nh gi\u00e1 5 sao c\u1ea7n \u0111\u1ea3m b\u1ea3o c\u00e1c y\u1ebfu t\u1ed1 sau, gi\u00fap \u0111\u1ed9i ng\u0169 ph\u00e1t tri\u1ec3n, DBA, v\u00e0 ki\u1ebfn tr\u00fac s\u01b0 c\u00f3 c\u00e1i nh\u00ecn r\u00f5 r\u00e0ng v\u00e0 ch\u00ednh x\u00e1c nh\u1ea5t v\u1ec1 c\u1ea5u tr\u00fac d\u1eef li\u1ec7u c\u1ee7a service:</p> <p>1. \ud83c\udfaf Gi\u1edbi thi\u1ec7u v\u00e0 Ph\u1ea1m vi R\u00f5 r\u00e0ng (Clear Introduction &amp; Scope):</p> <ul> <li> M\u1ee5c \u0111\u00edch c\u1ee7a Service v\u00e0 Vai tr\u00f2 M\u00f4 h\u00ecnh D\u1eef li\u1ec7u: Gi\u1edbi thi\u1ec7u ng\u1eafn g\u1ecdn v\u1ec1 service v\u00e0 t\u1ea7m quan tr\u1ecdng c\u1ee7a m\u00f4 h\u00ecnh d\u1eef li\u1ec7u n\u00e0y trong service \u0111\u00f3.</li> <li> Ph\u1ea1m vi D\u1eef li\u1ec7u Qu\u1ea3n l\u00fd: X\u00e1c \u0111\u1ecbnh r\u00f5 c\u00e1c th\u1ef1c th\u1ec3/lo\u1ea1i d\u1eef li\u1ec7u ch\u00ednh m\u00e0 service n\u00e0y ch\u1ecbu tr\u00e1ch nhi\u1ec7m qu\u1ea3n l\u00fd.</li> <li> Ngo\u00e0i ph\u1ea1m vi (Out of Scope): N\u00eau r\u00f5 nh\u1eefng th\u1ef1c th\u1ec3/lo\u1ea1i d\u1eef li\u1ec7u m\u00e0 service n\u00e0y kh\u00f4ng qu\u1ea3n l\u00fd ho\u1eb7c kh\u00f4ng ch\u1ecbu tr\u00e1ch nhi\u1ec7m (n\u1ebfu c\u1ea7n thi\u1ebft \u0111\u1ec3 tr\u00e1nh nh\u1ea7m l\u1eabn).</li> </ul> <p>2. \ud83d\uddfa\ufe0f S\u01a1 \u0111\u1ed3 ERD Tr\u1ef1c quan v\u00e0 Ch\u00ednh x\u00e1c (Accurate &amp; Visual ERD):</p> <ul> <li> S\u01a1 \u0111\u1ed3 ERD (Entity Relationship Diagram): Cung c\u1ea5p m\u1ed9t s\u01a1 \u0111\u1ed3 ERD tr\u1ef1c quan (v\u00ed d\u1ee5: s\u1eed d\u1ee5ng Mermaid, dbdiagram.io, ho\u1eb7c c\u00f4ng c\u1ee5 kh\u00e1c) th\u1ec3 hi\u1ec7n t\u1ea5t c\u1ea3 c\u00e1c b\u1ea3ng ch\u00ednh v\u00e0 m\u1ed1i quan h\u1ec7 gi\u1eefa ch\u00fang (one-to-one, one-to-many, many-to-many).</li> <li> T\u00ednh Ch\u00ednh x\u00e1c c\u1ee7a S\u01a1 \u0111\u1ed3: S\u01a1 \u0111\u1ed3 ERD ph\u1ea3i ph\u1ea3n \u00e1nh \u0111\u00fang c\u1ea5u tr\u00fac b\u1ea3ng v\u00e0 c\u00e1c m\u1ed1i quan h\u1ec7 \u0111\u01b0\u1ee3c m\u00f4 t\u1ea3 chi ti\u1ebft b\u00ean d\u01b0\u1edbi.</li> <li> Ghi ch\u00fa cho S\u01a1 \u0111\u1ed3 (n\u1ebfu c\u1ea7n): Gi\u1ea3i th\u00edch c\u00e1c quy \u01b0\u1edbc ho\u1eb7c \u0111i\u1ec3m \u0111\u1eb7c bi\u1ec7t trong s\u01a1 \u0111\u1ed3 (v\u00ed d\u1ee5: c\u00e1ch th\u1ec3 hi\u1ec7n ki\u1ec3u d\u1eef li\u1ec7u m\u1ea3ng, JSONB trong Mermaid).</li> </ul> <p>3. \ud83e\uddf1 Chi ti\u1ebft T\u1eebng B\u1ea3ng/Th\u1ef1c th\u1ec3 (Detailed Table/Entity Specification):</p> <ul> <li> Cho m\u1ed7i b\u1ea3ng/th\u1ef1c th\u1ec3:<ul> <li> T\u00ean b\u1ea3ng (Table Name): R\u00f5 r\u00e0ng v\u00e0 tu\u00e2n th\u1ee7 quy \u01b0\u1edbc \u0111\u1eb7t t\u00ean.</li> <li> M\u1ee5c \u0111\u00edch (Purpose): M\u00f4 t\u1ea3 ng\u1eafn g\u1ecdn vai tr\u00f2 v\u00e0 \u00fd ngh\u0129a c\u1ee7a b\u1ea3ng.</li> <li> C\u00e2u l\u1ec7nh <code>CREATE TABLE</code> (v\u00ed d\u1ee5): Cung c\u1ea5p v\u00ed d\u1ee5 c\u00e2u l\u1ec7nh SQL <code>CREATE TABLE</code> (ho\u1eb7c \u0111\u1ecbnh ngh\u0129a t\u01b0\u01a1ng \u0111\u01b0\u01a1ng cho NoSQL) \u0111\u1ec3 th\u1ec3 hi\u1ec7n r\u00f5 c\u1ea5u tr\u00fac.</li> <li> M\u00f4 t\u1ea3 Chi ti\u1ebft T\u1eebng C\u1ed9t (Column Details):<ul> <li> <code>T\u00ean c\u1ed9t (Column Name)</code>: Tu\u00e2n th\u1ee7 quy \u01b0\u1edbc.</li> <li> <code>Ki\u1ec3u d\u1eef li\u1ec7u (Data Type)</code>: Ch\u00ednh x\u00e1c v\u00e0 ph\u00f9 h\u1ee3p (v\u00ed d\u1ee5: UUID, TEXT, VARCHAR(255), INTEGER, BOOLEAN, TIMESTAMPTZ, JSONB, ENUM, TEXT[]).</li> <li> <code>Kh\u00f3a ch\u00ednh (Primary Key - PK)</code>: \u0110\u00e1nh d\u1ea5u r\u00f5.</li> <li> <code>Kh\u00f3a ngo\u1ea1i (Foreign Key - FK)</code>: N\u00eau r\u00f5 tham chi\u1ebfu \u0111\u1ebfn b\u1ea3ng v\u00e0 c\u1ed9t n\u00e0o.</li> <li> <code>R\u00e0ng bu\u1ed9c (Constraints)</code>: NOT NULL, UNIQUE, CHECK (v\u00ed d\u1ee5: gi\u00e1 tr\u1ecb ENUM h\u1ee3p l\u1ec7).</li> <li> <code>Gi\u00e1 tr\u1ecb m\u1eb7c \u0111\u1ecbnh (Default Value)</code>: N\u1ebfu c\u00f3.</li> <li> <code>M\u00f4 t\u1ea3 (Description)</code>: Gi\u1ea3i th\u00edch \u00fd ngh\u0129a nghi\u1ec7p v\u1ee5 c\u1ee7a c\u1ed9t.</li> </ul> </li> <li> Ch\u1ec9 m\u1ee5c (Indexes): Li\u1ec7t k\u00ea c\u00e1c ch\u1ec9 m\u1ee5c quan tr\u1ecdng (ngo\u00e0i PK, FK) v\u00e0 l\u00fd do t\u1ea1o (v\u00ed d\u1ee5: t\u1ed1i \u01b0u query th\u01b0\u1eddng xuy\u00ean, \u0111\u1ea3m b\u1ea3o unique).</li> <li> M\u1ed1i li\u00ean h\u1ec7 v\u00e0 S\u1eed d\u1ee5ng (Relationships &amp; Usage): M\u00f4 t\u1ea3 ng\u1eafn g\u1ecdn c\u00e1ch b\u1ea3ng n\u00e0y li\u00ean k\u1ebft v\u1edbi c\u00e1c b\u1ea3ng kh\u00e1c v\u00e0 \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng trong c\u00e1c lu\u1ed3ng nghi\u1ec7p v\u1ee5 ch\u00ednh c\u1ee7a service.</li> </ul> </li> </ul> <p>4. \ud83d\udd17 Qu\u1ea3n l\u00fd M\u1ed1i Quan H\u1ec7 v\u00e0 T\u00ednh To\u00e0n V\u1eb9n D\u1eef li\u1ec7u (Relationship Management &amp; Data Integrity):</p> <ul> <li> M\u00f4 t\u1ea3 r\u00f5 c\u00e1c m\u1ed1i quan h\u1ec7 ch\u00ednh: Gi\u1ea3i th\u00edch logic nghi\u1ec7p v\u1ee5 \u0111\u1eb1ng sau c\u00e1c m\u1ed1i quan h\u1ec7 one-to-many, many-to-many.</li> <li> Ch\u00ednh s\u00e1ch Cascade (n\u1ebfu c\u00f3): N\u00eau r\u00f5 h\u00e0nh vi <code>ON DELETE</code> ho\u1eb7c <code>ON UPDATE</code> cho c\u00e1c kh\u00f3a ngo\u1ea1i (v\u00ed d\u1ee5: CASCADE, SET NULL, RESTRICT).</li> <li> T\u00ednh to\u00e0n v\u1eb9n tham chi\u1ebfu: \u0110\u1ea3m b\u1ea3o c\u00e1c kh\u00f3a ngo\u1ea1i \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a \u0111\u00fang v\u00e0 logic.</li> </ul> <p>5. \ud83d\udd04 \u0110\u1ed3ng B\u1ed9 D\u1eef Li\u1ec7u v\u00e0 S\u1ef1 Ki\u1ec7n (Data Synchronization &amp; Events - n\u1ebfu c\u00f3):</p> <ul> <li> S\u1ef1 ki\u1ec7n li\u00ean quan \u0111\u1ebfn d\u1eef li\u1ec7u: N\u1ebfu vi\u1ec7c thay \u0111\u1ed5i d\u1eef li\u1ec7u trong c\u00e1c b\u1ea3ng n\u00e0y ph\u00e1t ra s\u1ef1 ki\u1ec7n (\u0111\u1ec3 c\u00e1c service kh\u00e1c consume), c\u1ea7n m\u00f4 t\u1ea3 t\u00ean s\u1ef1 ki\u1ec7n v\u00e0 m\u1ee5c \u0111\u00edch.</li> <li> D\u1eef li\u1ec7u \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 t\u1eeb ngu\u1ed3n kh\u00e1c: N\u1ebfu m\u1ed9t s\u1ed1 b\u1ea3ng/tr\u01b0\u1eddng l\u00e0 b\u1ea3n sao ho\u1eb7c \u0111\u01b0\u1ee3c \u0111\u1ed3ng b\u1ed9 t\u1eeb service kh\u00e1c (nh\u01b0 <code>UserLocal</code> trong <code>user-service/sub</code>), c\u1ea7n ghi r\u00f5 ngu\u1ed3n v\u00e0 c\u01a1 ch\u1ebf \u0111\u1ed3ng b\u1ed9.</li> </ul> <p>6. \ud83d\udcc4 Th\u00f4ng Tin B\u1ed5 Sung v\u00e0 Qu\u1ea3n Tr\u1ecb (Supplementary Information &amp; Governance):</p> <ul> <li> Ph\u1ee5 l\u1ee5c v\u1ec1 ENUMs v\u00e0 Gi\u00e1 tr\u1ecb \u0110\u1eb7c bi\u1ec7t: \u0110\u1ecbnh ngh\u0129a c\u00e1c gi\u00e1 tr\u1ecb ENUM \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng trong c\u00e1c b\u1ea3ng (nh\u01b0 <code>status</code>, <code>auth_provider</code>).</li> <li> Ch\u00ednh s\u00e1ch L\u01b0u tr\u1eef v\u00e0 X\u00f3a D\u1eef li\u1ec7u (Data Retention &amp; Deletion): Tham chi\u1ebfu \u0111\u1ebfn c\u00e1c ADRs li\u00ean quan (v\u00ed d\u1ee5: ADR-024, ADR-026) ho\u1eb7c t\u00f3m t\u1eaft ch\u00ednh s\u00e1ch \u00e1p d\u1ee5ng cho c\u00e1c b\u1ea3ng trong m\u00f4 h\u00ecnh n\u00e0y.</li> <li> Chi\u1ebfn l\u01b0\u1ee3c Migration Schema: Tham chi\u1ebfu \u0111\u1ebfn ADR-023 ho\u1eb7c m\u00f4 t\u1ea3 ng\u1eafn g\u1ecdn c\u00e1ch thay \u0111\u1ed5i schema s\u1ebd \u0111\u01b0\u1ee3c qu\u1ea3n l\u00fd.</li> <li> Li\u00ean k\u1ebft \u0111\u1ebfn t\u00e0i li\u1ec7u li\u00ean quan: V\u00ed d\u1ee5: file design chi ti\u1ebft c\u1ee7a service, interface contract, OpenAPI spec, c\u00e1c ADRs.</li> <li> Th\u00f4ng tin phi\u00ean b\u1ea3n t\u00e0i li\u1ec7u: Ghi r\u00f5 phi\u00ean b\u1ea3n, ng\u00e0y c\u1eadp nh\u1eadt cu\u1ed1i c\u00f9ng, t\u00e1c gi\u1ea3, ng\u01b0\u1eddi review.</li> </ul> <p>7. \ud83d\udcd6 T\u00ednh D\u1ec5 \u0110\u1ecdc, D\u1ec5 Tra C\u1ee9u v\u00e0 B\u1ea3o tr\u00ec (Readability, Navigability &amp; Maintainability):</p> <ul> <li> Markdown Formatting: S\u1eed d\u1ee5ng hi\u1ec7u qu\u1ea3 c\u00e1c t\u00ednh n\u0103ng c\u1ee7a Markdown (headings, tables, code blocks) \u0111\u1ec3 t\u00e0i li\u1ec7u s\u00e1ng s\u1ee7a, d\u1ec5 \u0111\u1ecdc.</li> <li> C\u1ea5u tr\u00fac logic: Ph\u00e2n chia t\u00e0i li\u1ec7u th\u00e0nh c\u00e1c m\u1ee5c, ti\u1ec3u m\u1ee5c m\u1ed9t c\u00e1ch h\u1ee3p l\u00fd.</li> <li> M\u1ee5c l\u1ee5c (Table of Contents): \u0110\u1ed1i v\u1edbi t\u00e0i li\u1ec7u d\u00e0i, c\u00f3 m\u1ee5c l\u1ee5c l\u00e0 c\u1ea7n thi\u1ebft.</li> <li> D\u1ec5 c\u1eadp nh\u1eadt: Thi\u1ebft k\u1ebf t\u00e0i li\u1ec7u theo c\u00e1ch d\u1ec5 d\u00e0ng ch\u1ec9nh s\u1eeda khi m\u00f4 h\u00ecnh d\u1eef li\u1ec7u c\u00f3 thay \u0111\u1ed5i.</li> </ul>"},{"location":"standards/5s.dev.guide.standard/","title":"5s.dev.guide.standard","text":""},{"location":"standards/5s.dev.guide.standard/#checklist-tieu-chuan-5-cho-bo-huong-dan-phat-trien-dev-guide","title":"\u2705 Checklist Ti\u00eau Chu\u1ea9n 5\u2605 cho B\u1ed9 H\u01b0\u1edbng d\u1eabn Ph\u00e1t tri\u1ec3n (<code>dev-guide</code>)","text":"<p>M\u1ed9t b\u1ed9 <code>dev-guide</code> \u0111\u01b0\u1ee3c \u0111\u00e1nh gi\u00e1 5 sao c\u1ea7n ph\u1ea3i l\u00e0 m\u1ed9t \"ngu\u1ed3n ch\u00e2n l\u00fd\" s\u1ed1ng \u0111\u1ed9ng, th\u1ef1c ti\u1ec5n v\u00e0 d\u1ec5 ti\u1ebfp c\u1eadn cho m\u1ecdi l\u1eadp tr\u00ecnh vi\u00ean. N\u00f3 ph\u1ea3i \u0111\u00e1p \u1ee9ng \u0111\u1ea7y \u0111\u1ee7 c\u00e1c ti\u00eau ch\u00ed sau:</p> <p>1. \ud83c\udfaf M\u1ee5c ti\u00eau &amp; Tri\u1ebft l\u00fd R\u00f5 r\u00e0ng (Purpose &amp; Philosophy):</p> <ul> <li> Gi\u1edbi thi\u1ec7u v\u00e0 T\u1ea7m nh\u00ecn: C\u00f3 m\u1ed9t trang <code>README.md</code> ch\u00ednh, gi\u1ea3i th\u00edch r\u00f5 m\u1ee5c \u0111\u00edch c\u1ee7a b\u1ed9 <code>dev-guide</code>, t\u1ea7m quan tr\u1ecdng c\u1ee7a vi\u1ec7c tu\u00e2n th\u1ee7 c\u00e1c ti\u00eau chu\u1ea9n, v\u00e0 vai tr\u00f2 c\u1ee7a n\u00f3 trong vi\u1ec7c \u0111\u1ea3m b\u1ea3o ch\u1ea5t l\u01b0\u1ee3ng cho d\u1ef1 \u00e1n DX-VAS.</li> <li> \u0110\u1ed1i t\u01b0\u1ee3ng \u0110\u1ecdc gi\u1ea3: X\u00e1c \u0111\u1ecbnh r\u00f5 \u0111\u1ed1i t\u01b0\u1ee3ng h\u01b0\u1edbng \u0111\u1ebfn (v\u00ed d\u1ee5: Backend Dev, Frontend Dev, DevOps, th\u00e0nh vi\u00ean m\u1edbi).</li> <li> C\u00e1c Nguy\u00ean t\u1eafc V\u00e0ng (Core Principles): Ph\u1ea3i c\u00f3 m\u1ed9t trang ri\u00eang v\u1ec1 c\u00e1c nguy\u00ean t\u1eafc c\u1ed1t l\u00f5i, l\u00e0 kim ch\u1ec9 nam cho m\u1ecdi quy\u1ebft \u0111\u1ecbnh k\u1ef9 thu\u1eadt. V\u00ed d\u1ee5:<ul> <li>Design First: Lu\u00f4n b\u1eaft \u0111\u1ea7u v\u1edbi t\u00e0i li\u1ec7u thi\u1ebft k\u1ebf.</li> <li>ADR-Driven: C\u00e1c quy\u1ebft \u0111\u1ecbnh ki\u1ebfn tr\u00fac ph\u1ea3i \u0111\u01b0\u1ee3c ghi l\u1ea1i v\u00e0 tu\u00e2n th\u1ee7.</li> <li>Security by Design: B\u1ea3o m\u1eadt l\u00e0 tr\u00e1ch nhi\u1ec7m c\u1ee7a m\u1ecdi ng\u01b0\u1eddi, ngay t\u1eeb d\u00f2ng code \u0111\u1ea7u ti\u00ean.</li> <li>Stateless Services: Thi\u1ebft k\u1ebf service \u0111\u1ec3 d\u1ec5 d\u00e0ng m\u1edf r\u1ed9ng theo chi\u1ec1u ngang.</li> <li>Contract First for APIs: <code>openapi.yaml</code> l\u00e0 h\u1ee3p \u0111\u1ed3ng kh\u00f4ng th\u1ec3 ph\u00e1 v\u1ee1.</li> <li>Test Everything: Cam k\u1ebft v\u1ec1 ch\u1ea5t l\u01b0\u1ee3ng th\u00f4ng qua ki\u1ec3m th\u1eed.</li> </ul> </li> </ul> <p>2. \ud83d\ude80 H\u01b0\u1edbng d\u1eabn B\u1eaft \u0111\u1ea7u &amp; Onboarding (Getting Started &amp; Onboarding):</p> <ul> <li> Y\u00eau c\u1ea7u C\u00f4ng c\u1ee5: Li\u1ec7t k\u00ea chi ti\u1ebft c\u00e1c c\u00f4ng c\u1ee5 c\u1ea7n thi\u1ebft v\u00e0 phi\u00ean b\u1ea3n khuy\u1ebfn ngh\u1ecb (Python, Node.js, Docker, Terraform, <code>poetry</code>, <code>npm</code>/<code>yarn</code>, gcloud CLI).</li> <li> H\u01b0\u1edbng d\u1eabn C\u00e0i \u0111\u1eb7t M\u00f4i tr\u01b0\u1eddng: Cung c\u1ea5p c\u00e1c b\u01b0\u1edbc c\u1ee5 th\u1ec3, tu\u1ea7n t\u1ef1 \u0111\u1ec3 m\u1ed9t l\u1eadp tr\u00ecnh vi\u00ean m\u1edbi c\u00f3 th\u1ec3 c\u00e0i \u0111\u1eb7t m\u00f4i tr\u01b0\u1eddng ph\u00e1t tri\u1ec3n local th\u00e0nh c\u00f4ng.</li> <li> Ch\u1ea1y D\u1ef1 \u00e1n L\u1ea7n \u0111\u1ea7u: C\u00f3 h\u01b0\u1edbng d\u1eabn chi ti\u1ebft c\u00e1ch ch\u1ea1y c\u00e1c service ph\u1ee5 thu\u1ed9c (qua Docker Compose) v\u00e0 ch\u1ea1y m\u1ed9t service c\u1ee5 th\u1ec3 tr\u00ean m\u00e1y local.</li> <li> C\u1ea5u h\u00ecnh Local (<code>.env</code>): H\u01b0\u1edbng d\u1eabn r\u00f5 c\u00e1ch t\u1ea1o v\u00e0 c\u1ea5u h\u00ecnh c\u00e1c file <code>.env</code> d\u1ef1a tr\u00ean file <code>.env.example</code>, tham chi\u1ebfu \u0111\u1ebfn <code>ADR-005</code>.</li> </ul> <p>3. \ud83d\udd04 Quy tr\u00ecnh &amp; Lu\u1ed3ng l\u00e0m vi\u1ec7c (Workflow &amp; Process):</p> <ul> <li> Chi\u1ebfn l\u01b0\u1ee3c Nh\u00e1nh (Git Branching Strategy): \u0110\u1ecbnh ngh\u0129a r\u00f5 quy \u01b0\u1edbc \u0111\u1eb7t t\u00ean nh\u00e1nh (<code>feature/DX-123-ten-tinh-nang</code>, <code>bugfix/*</code>, <code>hotfix/*</code>) v\u00e0 c\u00e1c nh\u00e1nh ch\u00ednh (<code>dev</code>, <code>main</code>).</li> <li> Quy \u01b0\u1edbc Commit Message: B\u1eaft bu\u1ed9c s\u1eed d\u1ee5ng Conventional Commits (<code>feat:</code>, <code>fix:</code>, <code>docs:</code>, <code>chore:</code>, <code>refactor:</code>, <code>test:</code>).</li> <li> Quy tr\u00ecnh Pull Request (PR):<ul> <li>C\u00f3 PR template chu\u1ea9n.</li> <li>Checklist trong PR (\u0111\u00e3 ch\u1ea1y test, \u0111\u00e3 c\u1eadp nh\u1eadt t\u00e0i li\u1ec7u, tu\u00e2n th\u1ee7 ADRs).</li> <li>Quy \u0111\u1ecbnh v\u1ec1 s\u1ed1 l\u01b0\u1ee3ng ng\u01b0\u1eddi review v\u00e0 quy tr\u00ecnh ph\u00ea duy\u1ec7t.</li> </ul> </li> <li> Lu\u1ed3ng CI/CD: Gi\u1ea3i th\u00edch ng\u1eafn g\u1ecdn v\u1ec1 c\u00e1c b\u01b0\u1edbc trong pipeline CI/CD (lint, test, build, deploy), tham chi\u1ebfu \u0111\u1ebfn <code>ADR-001</code>.</li> </ul> <p>4. \ud83d\udee0\ufe0f H\u01b0\u1edbng d\u1eabn K\u1ef9 thu\u1eadt Chi ti\u1ebft (Detailed Technical Guides):</p> <ul> <li> Ph\u00e1t tri\u1ec3n API (<code>api-development.md</code>):<ul> <li>H\u01b0\u1edbng d\u1eabn c\u00e1ch \u00e1p d\u1ee5ng <code>ADR-012</code> (Response Structure) v\u00e0 <code>ADR-013</code> (Path Naming).</li> <li>Quy tr\u00ecnh c\u1eadp nh\u1eadt file <code>openapi.yaml</code> khi c\u00f3 thay \u0111\u1ed5i API.</li> <li>C\u00e1ch s\u1eed d\u1ee5ng c\u00e1c custom extensions (<code>x-required-permission</code>, <code>x-audit-action</code>, <code>x-emits-event</code>).</li> </ul> </li> <li> L\u00e0m vi\u1ec7c v\u1edbi CSDL &amp; Migrations (<code>database-and-migrations.md</code>):<ul> <li>H\u01b0\u1edbng d\u1eabn s\u1eed d\u1ee5ng ORM (n\u1ebfu c\u00f3).</li> <li>Quy tr\u00ecnh t\u1ea1o m\u1ed9t file migration m\u1edbi (v\u00ed d\u1ee5: v\u1edbi Alembic).</li> <li>C\u00e1c quy t\u1eafc v\u1ec1 backward compatibility khi thay \u0111\u1ed5i schema (tham chi\u1ebfu <code>ADR-023</code>).</li> </ul> </li> <li> Ph\u00e1t tri\u1ec3n H\u01b0\u1edbng S\u1ef1 ki\u1ec7n (<code>event-driven-development.md</code>):<ul> <li>H\u01b0\u1edbng d\u1eabn \u0111\u1ecbnh ngh\u0129a schema cho m\u1ed9t s\u1ef1 ki\u1ec7n m\u1edbi (theo <code>ADR-030</code>).</li> <li>C\u00e1ch publish m\u1ed9t s\u1ef1 ki\u1ec7n l\u00ean Pub/Sub.</li> <li>C\u00e1ch vi\u1ebft m\u1ed9t consumer x\u1eed l\u00fd s\u1ef1 ki\u1ec7n m\u1ed9t c\u00e1ch idempotent.</li> </ul> </li> <li> Logging &amp; Tracing (<code>logging-and-tracing.md</code>):<ul> <li>H\u01b0\u1edbng d\u1eabn s\u1eed d\u1ee5ng th\u01b0 vi\u1ec7n logger chu\u1ea9n c\u1ee7a d\u1ef1 \u00e1n.</li> <li>Quy \u0111\u1ecbnh v\u1ec1 c\u00e1c m\u1ee9c \u0111\u1ed9 log (DEBUG, INFO, WARN, ERROR).</li> <li>C\u1ea5u tr\u00fac log JSON chu\u1ea9n (tham chi\u1ebfu <code>ADR-008</code>).</li> <li>Nh\u1ea5n m\u1ea1nh nh\u1eefng g\u00ec KH\u00d4NG \u0111\u01b0\u1ee3c log (PII, secrets).</li> </ul> </li> <li> X\u1eed l\u00fd L\u1ed7i (<code>error-handling.md</code>):<ul> <li>H\u01b0\u1edbng d\u1eabn c\u00e1ch throw c\u00e1c custom exceptions (v\u00ed d\u1ee5: <code>PermissionDeniedError</code>, <code>ValidationError</code>).</li> <li>C\u00e1ch c\u00e1c exception n\u00e0y \u0111\u01b0\u1ee3c middleware \u00e1nh x\u1ea1 th\u00e0nh response l\u1ed7i chu\u1ea9n theo <code>ADR-011</code>.</li> </ul> </li> <li> Qu\u1ea3n l\u00fd C\u1ea5u h\u00ecnh &amp; Secrets (<code>configuration-and-secrets.md</code>):<ul> <li>H\u01b0\u1edbng d\u1eabn c\u00e1ch truy c\u1eadp c\u00e1c bi\u1ebfn m\u00f4i tr\u01b0\u1eddng v\u00e0 secrets trong code (tham chi\u1ebfu <code>ADR-003</code> v\u00e0 <code>ADR-005</code>).</li> </ul> </li> </ul> <p>5. \ud83e\uddea H\u01b0\u1edbng d\u1eabn Ki\u1ec3m th\u1eed (Testing Guide):</p> <ul> <li> Chi\u1ebfn l\u01b0\u1ee3c Ki\u1ec3m th\u1eed: M\u00f4 t\u1ea3 \"Kim t\u1ef1 th\u00e1p Ki\u1ec3m th\u1eed\" c\u1ee7a d\u1ef1 \u00e1n (Unit, Integration, Contract, E2E).</li> <li> H\u01b0\u1edbng d\u1eabn Vi\u1ebft Test:<ul> <li>Cung c\u1ea5p v\u00ed d\u1ee5 v\u00e0 h\u01b0\u1edbng d\u1eabn chi ti\u1ebft cho t\u1eebng lo\u1ea1i test.</li> <li>Unit Test: C\u00e1ch mock dependencies.</li> <li>Integration Test: C\u00e1ch t\u01b0\u01a1ng t\u00e1c v\u1edbi CSDL test (d\u00f9ng <code>testcontainers</code>), Pub/Sub emulator.</li> <li>Contract Test: (N\u1ebfu c\u00f3) C\u00e1ch \u0111\u1ecbnh ngh\u0129a v\u00e0 ch\u1ea1y contract test (v\u00ed d\u1ee5: v\u1edbi Pact).</li> </ul> </li> <li> Code Coverage: N\u00eau r\u00f5 m\u1ee5c ti\u00eau v\u1ec1 t\u1ef7 l\u1ec7 bao ph\u1ee7 code v\u00e0 c\u00e1ch xem b\u00e1o c\u00e1o.</li> </ul> <p>6. \u270d\ufe0f Ch\u1ea5t l\u01b0\u1ee3ng Tr\u00ecnh b\u00e0y v\u00e0 T\u00ednh Th\u1ef1c ti\u1ec5n (Documentation Quality &amp; Practicality):</p> <ul> <li> V\u00ed d\u1ee5 Code Th\u1ef1c t\u1ebf: M\u1ed7i h\u01b0\u1edbng d\u1eabn k\u1ef9 thu\u1eadt ph\u1ea3i c\u00f3 c\u00e1c \u0111o\u1ea1n code m\u1eabu r\u00f5 r\u00e0ng, c\u00f3 th\u1ec3 sao ch\u00e9p v\u00e0 s\u1eed d\u1ee5ng \u0111\u01b0\u1ee3c.</li> <li> \"N\u00ean\" v\u00e0 \"Kh\u00f4ng n\u00ean\" (Best Practices &amp; Anti-patterns): C\u00f3 c\u00e1c ph\u1ea7n ghi ch\u00fa r\u00f5 r\u00e0ng v\u1ec1 nh\u1eefng th\u1ef1c h\u00e0nh t\u1ed1t v\u00e0 nh\u1eefng l\u1ed7i c\u1ea7n tr\u00e1nh.</li> <li> Tham chi\u1ebfu Ch\u00e9o (Cross-referencing): Lu\u00f4n li\u00ean k\u1ebft \u0111\u1ebfn c\u00e1c ADRs, t\u00e0i li\u1ec7u thi\u1ebft k\u1ebf, ho\u1eb7c c\u00e1c ph\u1ea7n kh\u00e1c trong <code>dev-guide</code> \u0111\u1ec3 cung c\u1ea5p ng\u1eef c\u1ea3nh \u0111\u1ea7y \u0111\u1ee7.</li> <li> Tooling Cheatsheet: C\u00f3 m\u1ed9t trang t\u1ed5ng h\u1ee3p c\u00e1c l\u1ec7nh th\u01b0\u1eddng d\u00f9ng (lint, format, test, run, build) \u0111\u1ec3 tra c\u1ee9u nhanh.</li> <li> Quy tr\u00ecnh C\u1eadp nh\u1eadt: \u0110\u1ecbnh ngh\u0129a r\u00f5 quy tr\u00ecnh \u0111\u1ec3 c\u1eadp nh\u1eadt <code>dev-guide</code> khi c\u00f3 ADR m\u1edbi ho\u1eb7c thay \u0111\u1ed5i quy \u01b0\u1edbc. T\u00e0i li\u1ec7u ph\u1ea3i \"s\u1ed1ng\" c\u00f9ng d\u1ef1 \u00e1n.</li> <li> C\u1ea5u tr\u00fac v\u00e0 \u0110\u1ecbnh d\u1ea1ng: S\u1eed d\u1ee5ng Markdown hi\u1ec7u qu\u1ea3, c\u00f3 m\u1ee5c l\u1ee5c, c\u1ea5u tr\u00fac r\u00f5 r\u00e0ng, d\u1ec5 \u0111\u1ecdc.</li> </ul>"},{"location":"standards/5s.interface.contract.doc.standard/","title":"5s.interface.contract.doc.standard","text":""},{"location":"standards/5s.interface.contract.doc.standard/#checklist-tieu-chuan-5-cho-file-interface-contractmd-markdown","title":"\u2705 Checklist Ti\u00eau Chu\u1ea9n 5\u2605 cho File <code>interface-contract.md</code> (Markdown)","text":"<p>1. \ud83c\udfaf T\u1ed5ng quan v\u00e0 Gi\u1edbi thi\u1ec7u R\u00f5 r\u00e0ng (Clear Overview and Introduction):</p> <ul> <li> M\u1ee5c \u0111\u00edch c\u1ee7a Service/API: Gi\u1edbi thi\u1ec7u ng\u1eafn g\u1ecdn v\u1ec1 service, c\u00e1c ch\u1ee9c n\u0103ng ch\u00ednh m\u00e0 API cung c\u1ea5p, v\u00e0 ph\u1ea1m vi c\u1ee7a n\u00f3.</li> <li> \u0110\u1ed1i t\u01b0\u1ee3ng s\u1eed d\u1ee5ng API: X\u00e1c \u0111\u1ecbnh r\u00f5 ai (v\u00ed d\u1ee5: Superadmin Webapp, Auth Service, Sub Service) s\u1ebd l\u00e0 consumer ch\u00ednh c\u1ee7a c\u00e1c API n\u00e0y.</li> <li> Nguy\u00ean t\u1eafc chung khi s\u1eed d\u1ee5ng API (General Principles): N\u00eau c\u00e1c quy \u01b0\u1edbc chung quan tr\u1ecdng, v\u00ed d\u1ee5: \u0111\u1ecbnh d\u1ea1ng <code>PATCH</code> tr\u1ea3 v\u1ec1 <code>204 No Content</code>, c\u00e1ch x\u1eed l\u00fd <code>trace_id</code>, ho\u1eb7c c\u00e1c header chung c\u1ea7n thi\u1ebft.</li> </ul> <p>2. \ud83d\udcdc \u0110\u1eb7c t\u1ea3 API Chi ti\u1ebft, D\u1ec5 Hi\u1ec3u v\u00e0 Ch\u00ednh X\u00e1c (Detailed, Understandable &amp; Accurate API Specification):</p> <ul> <li> B\u1ea3ng t\u00f3m t\u1eaft API (API Summary Table):<ul> <li>Cung c\u1ea5p m\u1ed9t c\u00e1i nh\u00ecn t\u1ed5ng quan nhanh v\u1edbi c\u00e1c c\u1ed9t: <code>Method</code>, <code>Path</code>, <code>M\u00f4 t\u1ea3 ng\u1eafn</code>, v\u00e0 <code>Quy\u1ec1n y\u00eau c\u1ea7u (RBAC Permission)</code>. \u0110\u00e2y l\u00e0 \u0111i\u1ec3m kh\u1edfi \u0111\u1ea7u tuy\u1ec7t v\u1eddi \u0111\u1ec3 ng\u01b0\u1eddi \u0111\u1ecdc n\u1eafm b\u1eaft c\u00e1c API.</li> </ul> </li> <li> Chi ti\u1ebft t\u1eebng API Endpoint:<ul> <li> \u0110\u01b0\u1eddng d\u1eabn (Path) v\u00e0 Ph\u01b0\u01a1ng th\u1ee9c (HTTP Method): Ghi r\u00f5 r\u00e0ng, tu\u00e2n th\u1ee7 ADR-013 Naming Convention.</li> <li> M\u00f4 t\u1ea3 chi ti\u1ebft (Detailed Description): Gi\u1ea3i th\u00edch m\u1ee5c \u0111\u00edch, h\u00e0nh vi, v\u00e0 c\u00e1c k\u1ecbch b\u1ea3n s\u1eed d\u1ee5ng c\u1ee7a API.</li> <li> Tham s\u1ed1 (Parameters - Path, Query, Headers):<ul> <li>Li\u1ec7t k\u00ea t\u1eebng tham s\u1ed1 v\u1edbi: T\u00ean, Ki\u1ec3u d\u1eef li\u1ec7u, B\u1eaft bu\u1ed9c/T\u00f9y ch\u1ecdn, M\u00f4 t\u1ea3 r\u00f5 r\u00e0ng.</li> </ul> </li> <li> N\u1ed9i dung Request (Request Body):<ul> <li>M\u00f4 t\u1ea3 c\u1ea5u tr\u00fac (v\u00ed d\u1ee5: JSON) v\u00e0 \u00fd ngh\u0129a c\u1ee7a t\u1eebng tr\u01b0\u1eddng.</li> <li>Ch\u1ec9 r\u00f5 c\u00e1c tr\u01b0\u1eddng b\u1eaft bu\u1ed9c, ki\u1ec3u d\u1eef li\u1ec7u, v\u00e0 c\u00e1c r\u00e0ng bu\u1ed9c (n\u1ebfu c\u00f3).</li> <li>V\u00ed d\u1ee5 Request Body c\u1ee5 th\u1ec3 (\u0111\u1eb7t trong code block).</li> </ul> </li> <li> N\u1ed9i dung Response (Response Body):<ul> <li>M\u00f4 t\u1ea3 c\u1ea5u tr\u00fac response cho c\u00e1c k\u1ecbch b\u1ea3n th\u00e0nh c\u00f4ng (v\u00ed d\u1ee5: 200 OK, 201 Created).</li> <li>Lu\u00f4n tu\u00e2n th\u1ee7 c\u1ea5u tr\u00fac response chu\u1ea9n c\u1ee7a h\u1ec7 th\u1ed1ng (v\u00ed d\u1ee5: <code>{ data, error, meta }</code> theo ADR-012).</li> <li>V\u00ed d\u1ee5 Response Body c\u1ee5 th\u1ec3 (\u0111\u1eb7t trong code block).</li> </ul> </li> <li> HTTP Status Codes: Li\u1ec7t k\u00ea c\u00e1c status code c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1 (c\u1ea3 th\u00e0nh c\u00f4ng v\u00e0 l\u1ed7i) c\u00f9ng v\u1edbi gi\u1ea3i th\u00edch ng\u1eafn g\u1ecdn.</li> <li> X\u1eed l\u00fd l\u1ed7i (Error Handling): M\u00f4 t\u1ea3 c\u00e1ch l\u1ed7i \u0111\u01b0\u1ee3c tr\u1ea3 v\u1ec1, tham chi\u1ebfu \u0111\u1ebfn chu\u1ea9n l\u1ed7i chung c\u1ee7a h\u1ec7 th\u1ed1ng (v\u00ed d\u1ee5 ADR-011) v\u00e0 c\u00f3 th\u1ec3 cung c\u1ea5p v\u00ed d\u1ee5 response l\u1ed7i.</li> <li> Quy\u1ec1n y\u00eau c\u1ea7u (Required Permissions): Ghi r\u00f5 permission code (RBAC) c\u1ea7n thi\u1ebft \u0111\u1ec3 g\u1ecdi API n\u00e0y.</li> <li> S\u1ef1 ki\u1ec7n ph\u00e1t ra (Emitted Events): N\u1ebfu API l\u00e0 ngu\u1ed3n trigger vi\u1ec7c ph\u00e1t ra s\u1ef1 ki\u1ec7n, c\u1ea7n m\u00f4 t\u1ea3 r\u00f5 t\u00ean s\u1ef1 ki\u1ec7n v\u00e0 c\u00f3 th\u1ec3 c\u1ea3 v\u00ed d\u1ee5 payload c\u1ee7a s\u1ef1 ki\u1ec7n \u0111\u00f3 (ho\u1eb7c tham chi\u1ebfu \u0111\u1ebfn n\u01a1i \u0111\u1ecbnh ngh\u0129a chi ti\u1ebft h\u01a1n).</li> </ul> </li> </ul> <p>3. \u2728 V\u00ed d\u1ee5 Minh H\u1ecda Th\u1ef1c T\u1ebf v\u00e0 Phong Ph\u00fa (Practical &amp; Rich Examples):</p> <ul> <li> Cung c\u1ea5p \u0111\u1ee7 v\u00ed d\u1ee5 JSON c\u1ee5 th\u1ec3 cho request body v\u00e0 response body, bao g\u1ed3m c\u1ea3 tr\u01b0\u1eddng h\u1ee3p th\u00e0nh c\u00f4ng v\u00e0 m\u1ed9t s\u1ed1 l\u1ed7i \u0111i\u1ec3n h\u00ecnh cho c\u00e1c API ph\u1ee9c t\u1ea1p ho\u1eb7c quan tr\u1ecdng. C\u00e1c v\u00ed d\u1ee5 n\u00e0y gi\u00fap ng\u01b0\u1eddi d\u00f9ng API hi\u1ec3u v\u00e0 t\u00edch h\u1ee3p nhanh ch\u00f3ng.</li> </ul> <p>4. \ud83d\udee0\ufe0f Tu\u00e2n th\u1ee7 Nguy\u00ean t\u1eafc Thi\u1ebft k\u1ebf v\u00e0 ADRs (Adherence to Design Principles &amp; ADRs):</p> <ul> <li> Nh\u1ea5t qu\u00e1n v\u1edbi c\u00e1c ADRs: N\u1ed9i dung \u0111\u1eb7c t\u1ea3 API ph\u1ea3i ph\u1ea3n \u00e1nh \u0111\u00fang c\u00e1c quy\u1ebft \u0111\u1ecbnh trong ADRs li\u00ean quan (API Naming, Response Structure, Error Format, Security Policies, RBAC Strategy, v.v.).</li> <li> S\u1eed d\u1ee5ng thu\u1eadt ng\u1eef th\u1ed1ng nh\u1ea5t: \u0110\u1ea3m b\u1ea3o c\u00e1c thu\u1eadt ng\u1eef k\u1ef9 thu\u1eadt, t\u00ean tr\u01b0\u1eddng, m\u00e3 l\u1ed7i \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng nh\u1ea5t qu\u00e1n trong to\u00e0n b\u1ed9 t\u00e0i li\u1ec7u v\u00e0 v\u1edbi c\u00e1c t\u00e0i li\u1ec7u kh\u00e1c c\u1ee7a h\u1ec7 th\u1ed1ng.</li> </ul> <p>5. \ud83d\udcc4 Th\u00f4ng Tin B\u1ed5 Sung v\u00e0 Qu\u1ea3n Tr\u1ecb (Supplementary Information &amp; Governance):</p> <ul> <li> Ph\u1ee5 l\u1ee5c (Appendices - n\u1ebfu c\u1ea7n):<ul> <li>\u0110\u1ecbnh ngh\u0129a c\u00e1c ENUMs, c\u00e1c gi\u00e1 tr\u1ecb h\u1eb1ng s\u1ed1 \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng trong API (nh\u01b0 b\u1ea1n \u0111\u00e3 l\u00e0m v\u1edbi <code>assignment_status</code>, <code>auth_provider</code> trong file <code>user-service/master/interface-contract.md</code>).</li> <li>B\u1ea3ng t\u00f3m t\u1eaft c\u00e1c Permission Code li\u00ean quan \u0111\u1ebfn c\u00e1c API c\u1ee7a service (nh\u01b0 b\u1ea1n \u0111\u00e3 l\u00e0m cho User Service Master).</li> </ul> </li> <li> Li\u00ean k\u1ebft \u0111\u1ebfn t\u00e0i li\u1ec7u li\u00ean quan:<ul> <li>Verlink \u0111\u1ebfn file design chi ti\u1ebft c\u1ee7a service, data model, file OpenAPI spec (n\u1ebfu c\u00f3), c\u00e1c ADRs quan tr\u1ecdng.</li> </ul> </li> <li> Th\u00f4ng tin phi\u00ean b\u1ea3n t\u00e0i li\u1ec7u: Ghi r\u00f5 phi\u00ean b\u1ea3n, ng\u00e0y c\u1eadp nh\u1eadt cu\u1ed1i c\u00f9ng, t\u00e1c gi\u1ea3, ng\u01b0\u1eddi review \u1edf \u0111\u1ea7u ho\u1eb7c cu\u1ed1i t\u00e0i li\u1ec7u.</li> </ul> <p>6. \ud83d\udcd6 T\u00ednh D\u1ec5 \u0110\u1ecdc, D\u1ec5 Tra C\u1ee9u v\u00e0 B\u1ea3o tr\u00ec (Readability, Navigability &amp; Maintainability):</p> <ul> <li> Markdown Formatting: S\u1eed d\u1ee5ng hi\u1ec7u qu\u1ea3 c\u00e1c t\u00ednh n\u0103ng c\u1ee7a Markdown (headings, tables, code blocks, blockquotes, lists) \u0111\u1ec3 t\u00e0i li\u1ec7u s\u00e1ng s\u1ee7a, d\u1ec5 \u0111\u1ecdc.</li> <li> C\u1ea5u tr\u00fac logic: Ph\u00e2n chia t\u00e0i li\u1ec7u th\u00e0nh c\u00e1c m\u1ee5c, ti\u1ec3u m\u1ee5c m\u1ed9t c\u00e1ch h\u1ee3p l\u00fd, gi\u00fap ng\u01b0\u1eddi \u0111\u1ecdc d\u1ec5 d\u00e0ng t\u00ecm th\u1ea5y th\u00f4ng tin h\u1ecd c\u1ea7n.</li> <li> M\u1ee5c l\u1ee5c (Table of Contents): \u0110\u1ed1i v\u1edbi c\u00e1c t\u00e0i li\u1ec7u d\u00e0i, c\u00f3 m\u1ee5c l\u1ee5c t\u1ef1 \u0111\u1ed9ng ho\u1eb7c th\u1ee7 c\u00f4ng l\u00e0 r\u1ea5t c\u1ea7n thi\u1ebft.</li> <li> D\u1ec5 c\u1eadp nh\u1eadt: Thi\u1ebft k\u1ebf t\u00e0i li\u1ec7u theo c\u00e1ch d\u1ec5 d\u00e0ng ch\u1ec9nh s\u1eeda v\u00e0 b\u1ed5 sung khi API c\u00f3 s\u1ef1 thay \u0111\u1ed5i.</li> </ul>"},{"location":"standards/5s.openapi.standard/","title":"5s.openapi.standard","text":""},{"location":"standards/5s.openapi.standard/#checklist-tieu-chuan-5-toan-dien-cho-file-openapi-service","title":"\u2705 Checklist Ti\u00eau Chu\u1ea9n 5\u2605 To\u00e0n Di\u1ec7n cho File <code>openapi</code> Service","text":"<p>M\u1ed9t file <code>openapi</code> (v\u00ed d\u1ee5: <code>openapi.yaml</code> ho\u1eb7c <code>openapi.json</code>) \u0111\u01b0\u1ee3c \u0111\u00e1nh gi\u00e1 5 sao c\u1ea7n \u0111\u1ea3m b\u1ea3o c\u00e1c y\u1ebfu t\u1ed1 sau, gi\u00fap \u0111\u1ecbnh ngh\u0129a h\u1ee3p \u0111\u1ed3ng API m\u1ed9t c\u00e1ch r\u00f5 r\u00e0ng, ch\u00ednh x\u00e1c, d\u1ec5 s\u1eed d\u1ee5ng v\u00e0 d\u1ec5 qu\u1ea3n l\u00fd:</p> <p>1. \ud83d\udcdc \u0110\u1eb7c T\u1ea3 API Ho\u00e0n Ch\u1ec9nh v\u00e0 Ch\u00ednh X\u00e1c (Completeness &amp; Accuracy of API Specification):</p> <ul> <li> Th\u00f4ng tin chung (Info Object):<ul> <li> <code>title</code>: T\u00ean c\u1ee7a API/Service, r\u00f5 r\u00e0ng v\u00e0 mang t\u00ednh m\u00f4 t\u1ea3.</li> <li> <code>version</code>: Phi\u00ean b\u1ea3n c\u1ee7a API \u0111ang \u0111\u01b0\u1ee3c \u0111\u1eb7c t\u1ea3 (v\u00ed d\u1ee5: <code>1.0.0</code>, <code>1.1-beta</code>).</li> <li> <code>description</code>: M\u00f4 t\u1ea3 chi ti\u1ebft v\u1ec1 API, m\u1ee5c \u0111\u00edch, c\u00e1c nh\u00f3m ch\u1ee9c n\u0103ng ch\u00ednh, v\u00e0 c\u00e1c l\u01b0u \u00fd quan tr\u1ecdng cho ng\u01b0\u1eddi d\u00f9ng.</li> <li> <code>contact</code> (t\u00f9y ch\u1ecdn): Th\u00f4ng tin li\u00ean h\u1ec7 c\u1ee7a \u0111\u1ed9i ng\u0169 ph\u00e1t tri\u1ec3n/ch\u1ee7 s\u1edf h\u1eefu API.</li> </ul> </li> <li> Th\u00f4ng tin Server &amp; Base Path: Khai b\u00e1o r\u00f5 r\u00e0ng c\u00e1c URL c\u01a1 s\u1edf (<code>servers</code>) cho c\u00e1c m\u00f4i tr\u01b0\u1eddng kh\u00e1c nhau (dev, staging, production).</li> <li> Endpoints (Paths &amp; Operations):<ul> <li> Li\u1ec7t k\u00ea \u0111\u1ea7y \u0111\u1ee7 t\u1ea5t c\u1ea3 c\u00e1c API endpoints.</li> <li> S\u1eed d\u1ee5ng \u0111\u00fang HTTP methods (<code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>PATCH</code>, <code>DELETE</code>) cho t\u1eebng operation, tu\u00e2n th\u1ee7 ng\u1eef ngh\u0129a RESTful.</li> <li> M\u1ed7i endpoint v\u00e0 operation c\u00f3 <code>summary</code> (ng\u1eafn g\u1ecdn) v\u00e0 <code>description</code> (chi ti\u1ebft) r\u00f5 r\u00e0ng v\u1ec1 m\u1ee5c \u0111\u00edch v\u00e0 h\u00e0nh vi.</li> <li> Tu\u00e2n th\u1ee7 quy \u01b0\u1edbc \u0111\u1eb7t t\u00ean \u0111\u01b0\u1eddng d\u1eabn (v\u00ed d\u1ee5 theo ADR-013).</li> </ul> </li> <li> Tham s\u1ed1 (Parameters):<ul> <li> \u0110\u1ecbnh ngh\u0129a chi ti\u1ebft t\u1ea5t c\u1ea3 tham s\u1ed1: path parameters, query parameters, header parameters.</li> <li> Cho m\u1ed7i tham s\u1ed1: <code>name</code>, v\u1ecb tr\u00ed (<code>in</code>), <code>description</code>, <code>required</code> (c\u00f3 b\u1eaft bu\u1ed9c hay kh\u00f4ng), <code>schema</code> (ki\u1ec3u d\u1eef li\u1ec7u, format, enum, default value), v\u00e0 <code>example</code>.</li> <li> H\u1ed7 tr\u1ee3 Pagination &amp; Filtering cho API GET danh s\u00e1ch:<ul> <li> Th\u00eam c\u00e1c query parameters chu\u1ea9n nh\u01b0 <code>page</code>, <code>limit</code> (cho pagination).</li> <li> C\u00e2n nh\u1eafc <code>search</code> (cho t\u00ecm ki\u1ebfm t\u1ef1 do), <code>sort_by</code> (t\u00ean tr\u01b0\u1eddng), <code>order</code> (<code>asc</code>/<code>desc</code>) (cho s\u1eafp x\u1ebfp).</li> </ul> </li> </ul> </li> <li> N\u1ed9i dung Request (Request Body):<ul> <li> M\u00f4 t\u1ea3 r\u00f5 c\u1ea5u tr\u00fac request body (s\u1eed d\u1ee5ng JSON Schema) cho c\u00e1c method nh\u01b0 <code>POST</code>, <code>PUT</code>, <code>PATCH</code>.</li> <li> Ch\u1ec9 r\u00f5 <code>content type</code> (v\u00ed d\u1ee5: <code>application/json</code>).</li> <li> C\u00f3 <code>description</code> v\u00e0 <code>required</code> cho request body.</li> <li> Schema c\u1ee7a request body m\u00f4 t\u1ea3 chi ti\u1ebft t\u1eebng tr\u01b0\u1eddng: t\u00ean, ki\u1ec3u d\u1eef li\u1ec7u, r\u00e0ng bu\u1ed9c, <code>description</code>, <code>example</code>, <code>readOnly</code>/<code>writeOnly</code> (n\u1ebfu ph\u00f9 h\u1ee3p).</li> </ul> </li> <li> N\u1ed9i dung Response (Responses):<ul> <li> \u0110\u1eb7c t\u1ea3 c\u1ea5u tr\u00fac response body chi ti\u1ebft (s\u1eed d\u1ee5ng JSON Schema) cho t\u1eebng HTTP status code c\u00f3 th\u1ec3 tr\u1ea3 v\u1ec1 (c\u1ea3 th\u00e0nh c\u00f4ng v\u00e0 l\u1ed7i).</li> <li> Tu\u00e2n th\u1ee7 c\u1ea5u tr\u00fac response chu\u1ea9n c\u1ee7a h\u1ec7 th\u1ed1ng (v\u00ed d\u1ee5: <code>{ data, error, meta }</code> theo ADR-012).</li> <li> Schema c\u1ee7a response body m\u00f4 t\u1ea3 chi ti\u1ebft t\u1eebng tr\u01b0\u1eddng.</li> <li> Ch\u1ec9 r\u00f5 <code>content type</code>.</li> <li> H\u1ed7 tr\u1ee3 Pagination cho API GET danh s\u00e1ch:<ul> <li> S\u1eed d\u1ee5ng schema <code>Paginated[T]</code> (ho\u1eb7c t\u01b0\u01a1ng \u0111\u01b0\u01a1ng) v\u1edbi c\u00e1c tr\u01b0\u1eddng metadata nh\u01b0 <code>meta.total_items</code>, <code>meta.page</code>, <code>meta.per_page</code>, <code>meta.total_pages</code> trong response.</li> </ul> </li> </ul> </li> <li> HTTP Status Codes &amp; M\u00e3 l\u1ed7i \u1ee8ng d\u1ee5ng:<ul> <li> Li\u1ec7t k\u00ea \u0111\u1ea7y \u0111\u1ee7 c\u00e1c HTTP status codes v\u00e0 \u00fd ngh\u0129a c\u1ee7a ch\u00fang trong context c\u1ee7a t\u1eebng API.</li> <li> S\u1eed d\u1ee5ng schema <code>ErrorResponse</code> chu\u1ea9n h\u00f3a (v\u00ed d\u1ee5: <code>{ error: { code, message, details }, meta: { ... } }</code>) cho c\u00e1c response l\u1ed7i, tu\u00e2n th\u1ee7 ADR-011, ADR-012.</li> </ul> </li> <li> Headers:<ul> <li> Khai b\u00e1o c\u00e1c request headers quan tr\u1ecdng (v\u00ed d\u1ee5: <code>Authorization</code>, <code>X-Tenant-ID</code>, <code>Idempotency-Key</code>).</li> <li> M\u00f4 t\u1ea3 c\u00e1c response headers \u0111\u1eb7c bi\u1ec7t (v\u00ed d\u1ee5: <code>X-Request-ID</code>, <code>ETag</code>, <code>RateLimit-Remaining</code>).</li> </ul> </li> <li> Tags:<ul> <li> S\u1eed d\u1ee5ng <code>tags</code> \u0111\u1ec3 nh\u00f3m c\u00e1c API m\u1ed9t c\u00e1ch logic (v\u00ed d\u1ee5: <code>users-global</code>, <code>tenants</code>, <code>rbac-templates</code>).</li> <li> Khai b\u00e1o m\u00f4 t\u1ea3 cho t\u1eebng tag \u1edf ph\u1ea7n \u0111\u1ea7u file (<code>tags:</code> object array).</li> </ul> </li> </ul> <p>2. \ud83e\udde9 \u0110\u1ecbnh ngh\u0129a Schema v\u00e0 T\u00e1i s\u1eed d\u1ee5ng (Schema Definitions &amp; Reusability - <code>components/schemas</code>):</p> <ul> <li> T\u1ed1i \u01b0u Schema v\u1edbi <code>$ref</code>: \u0110\u1ea3m b\u1ea3o to\u00e0n b\u1ed9 request/response body v\u00e0 c\u00e1c ph\u1ea7n l\u1eb7p l\u1ea1i c\u1ee7a schema s\u1eed d\u1ee5ng tham chi\u1ebfu <code>$ref</code> \u0111\u1ebfn c\u00e1c \u0111\u1ecbnh ngh\u0129a trong <code>components/schemas</code>, tr\u00e1nh \u0111\u1ecbnh ngh\u0129a inline l\u1eb7p \u0111i l\u1eb7p l\u1ea1i.</li> <li> M\u00f4 t\u1ea3 Schema Chi ti\u1ebft: M\u1ed7i schema trong <code>components/schemas</code> ph\u1ea3i c\u00f3 <code>description</code>, <code>type</code>, v\u00e0 <code>example</code> (n\u1ebfu ph\u00f9 h\u1ee3p). C\u00e1c thu\u1ed9c t\u00ednh (properties) c\u1ee7a schema c\u0169ng c\u1ea7n <code>description</code> v\u00e0 <code>example</code>.</li> <li> S\u1eed d\u1ee5ng <code>readOnly</code>/<code>writeOnly</code>: \u0110\u00e1nh d\u1ea5u c\u00e1c tr\u01b0\u1eddng ch\u1ec9 \u0111\u1ecdc ho\u1eb7c ch\u1ec9 ghi m\u1ed9t c\u00e1ch ch\u00ednh x\u00e1c.</li> <li> \u0110\u1ecbnh ngh\u0129a ENUM t\u1eadp trung: T\u1ea5t c\u1ea3 c\u00e1c ENUM n\u00ean \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a l\u00e0 c\u00e1c schema ri\u00eang bi\u1ec7t trong <code>components/schemas</code> v\u00e0 \u0111\u01b0\u1ee3c tham chi\u1ebfu, thay v\u00ec hardcode gi\u00e1 tr\u1ecb tr\u1ef1c ti\u1ebfp trong \u0111\u1eb7c t\u1ea3 endpoint.</li> <li> S\u1eed d\u1ee5ng <code>nullable: true</code> (cho OpenAPI 3.0) ho\u1eb7c <code>nullable</code> trong <code>type</code> array (cho OpenAPI 3.1+): Cho c\u00e1c tr\u01b0\u1eddng t\u00f9y ch\u1ecdn c\u00f3 th\u1ec3 nh\u1eadn gi\u00e1 tr\u1ecb <code>null</code>.</li> <li> S\u1eed d\u1ee5ng <code>oneOf</code>, <code>allOf</code>, <code>anyOf</code> (n\u1ebfu c\u1ea7n): Cho c\u00e1c schema ph\u1ee9c t\u1ea1p c\u00f3 nhi\u1ec1u bi\u1ebfn th\u1ec3 ho\u1eb7c c\u1ea7n k\u1ebft h\u1ee3p t\u1eeb c\u00e1c schema kh\u00e1c.</li> </ul> <p>3. \ud83d\udd10 B\u1ea3o M\u1eadt v\u00e0 Ph\u00e2n Quy\u1ec1n R\u00f5 R\u00e0ng (Clear Security &amp; Authorization Definition):</p> <ul> <li> C\u01a1 ch\u1ebf x\u00e1c th\u1ef1c (Authentication): \u0110\u1ecbnh ngh\u0129a r\u00f5 r\u00e0ng c\u00e1c <code>securitySchemes</code> \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng trong <code>components/securitySchemes</code> (v\u00ed d\u1ee5: <code>bearerAuth</code> cho JWT). \u00c1p d\u1ee5ng security scheme cho to\u00e0n b\u1ed9 API ho\u1eb7c t\u1eebng operation c\u1ee5 th\u1ec3.</li> <li> Y\u00eau c\u1ea7u quy\u1ec1n (Permissions/RBAC):<ul> <li> S\u1eed d\u1ee5ng custom extension nh\u01b0 <code>x-required-permission</code> \u0111\u1ec3 ch\u1ec9 \u0111\u1ecbnh permission c\u1ea7n thi\u1ebft cho t\u1eebng operation quan tr\u1ecdng.</li> <li> Permission code n\u00ean nh\u1ea5t qu\u00e1n v\u00e0 d\u1ec5 hi\u1ec3u, l\u00fd t\u01b0\u1edfng nh\u1ea5t l\u00e0 tr\u00f9ng v\u1edbi ENUM ho\u1eb7c h\u1eb1ng s\u1ed1 t\u1eeb h\u1ec7 th\u1ed1ng RBAC template.</li> </ul> </li> </ul> <p>4. \u2728 V\u00ed d\u1ee5 Minh H\u1ecda Th\u1ef1c T\u1ebf (Practical Examples):</p> <ul> <li> Cung c\u1ea5p c\u00e1c v\u00ed d\u1ee5 (<code>example</code> ho\u1eb7c <code>examples</code>) phong ph\u00fa cho request parameters, request body, v\u00e0 response body trong \u0111\u1eb7c t\u1ea3.</li> <li> V\u00ed d\u1ee5 n\u00ean bao g\u1ed3m c\u1ea3 k\u1ecbch b\u1ea3n th\u00e0nh c\u00f4ng v\u00e0 m\u1ed9t s\u1ed1 l\u1ed7i th\u01b0\u1eddng g\u1eb7p (n\u1ebfu c\u00f3 th\u1ec3, \u0111\u1eb7c bi\u1ec7t cho c\u00e1c API ph\u1ee9c t\u1ea1p).</li> </ul> <p>5. \ud83d\udee0\ufe0f Tu\u00e2n Th\u1ee7 Chu\u1ea9n v\u00e0 C\u00f4ng C\u1ee5 (Adherence to Standards &amp; Tooling):</p> <ul> <li> Chu\u1ea9n OpenAPI: Tu\u00e2n th\u1ee7 ch\u1eb7t ch\u1ebd phi\u00ean b\u1ea3n OpenAPI \u0111\u00e3 ch\u1ecdn (v\u00ed d\u1ee5: 3.0.3, 3.1.0).</li> <li> T\u00ednh h\u1ee3p l\u1ec7 (Validation): File \u0111\u1eb7c t\u1ea3 ph\u1ea3i h\u1ee3p l\u1ec7 v\u00e0 v\u01b0\u1ee3t qua ki\u1ec3m tra c\u1ee7a c\u00e1c c\u00f4ng c\u1ee5 linter/validator (v\u00ed d\u1ee5: Spectral).</li> <li> Kh\u1ea3 n\u0103ng Sinh Code/Docs: Vi\u1ebft theo c\u00e1ch d\u1ec5 d\u00e0ng cho vi\u1ec7c t\u1ef1 \u0111\u1ed9ng sinh client SDKs, server stubs, v\u00e0 t\u00e0i li\u1ec7u API t\u01b0\u01a1ng t\u00e1c (v\u00ed d\u1ee5: Swagger UI, Redoc).</li> <li> Nh\u1ea5t qu\u00e1n v\u1edbi ADRs h\u1ec7 th\u1ed1ng: Ph\u1ea3n \u00e1nh \u0111\u00fang c\u00e1c quy\u1ebft \u0111\u1ecbnh ki\u1ebfn tr\u00fac li\u00ean quan \u0111\u1ebfn API (v\u00ed d\u1ee5: ADR-009 API Governance, ADR-011 API Error Format, ADR-012 Response Structure, ADR-013 Path Naming Convention).</li> </ul> <p>6. \ud83d\udcc4 Th\u00f4ng Tin B\u1ed5 Sung v\u00e0 Qu\u1ea3n Tr\u1ecb (Supplementary Information &amp; Governance):</p> <ul> <li> Ch\u00ednh s\u00e1ch Versioning &amp; Deprecation: M\u00f4 t\u1ea3 c\u00e1ch API \u0111\u01b0\u1ee3c version h\u00f3a v\u00e0 ch\u00ednh s\u00e1ch lo\u1ea1i b\u1ecf phi\u00ean b\u1ea3n c\u0169 (c\u00f3 th\u1ec3 tham chi\u1ebfu \u0111\u1ebfn ADR li\u00ean quan).</li> <li> Th\u00f4ng tin Rate Limiting (n\u1ebfu c\u00f3): M\u00f4 t\u1ea3 gi\u1edbi h\u1ea1n s\u1ed1 l\u1ea7n g\u1ecdi API.</li> <li> Metadata qu\u1ea3n tr\u1ecb t\u00e0i li\u1ec7u:<ul> <li> Ghi ch\u00fa ng\u00e0y t\u1ea1o/c\u1eadp nh\u1eadt, phi\u00ean b\u1ea3n c\u1ee7a ch\u00ednh file OpenAPI (c\u00f3 th\u1ec3 qua version control c\u1ee7a Git).</li> <li> Th\u00f4ng tin t\u00e1c gi\u1ea3, ng\u01b0\u1eddi review (c\u00f3 th\u1ec3 qu\u1ea3n l\u00fd ngo\u00e0i file spec, v\u00ed d\u1ee5 trong commit history ho\u1eb7c t\u00e0i li\u1ec7u \u0111i k\u00e8m).</li> </ul> </li> <li> Li\u00ean k\u1ebft \u0111\u1ebfn t\u00e0i li\u1ec7u li\u00ean quan: Trong ph\u1ea7n <code>description</code> c\u1ee7a API ho\u1eb7c c\u1ee7a Info Object, c\u00f3 th\u1ec3 cung c\u1ea5p link \u0111\u1ebfn file design chi ti\u1ebft, data model, ho\u1eb7c c\u00e1c ADRs li\u00ean quan.</li> <li> Custom Extensions (<code>x-...</code>):<ul> <li> N\u1ebfu s\u1eed d\u1ee5ng c\u00e1c extension t\u00f9y ch\u1ec9nh (v\u00ed d\u1ee5: <code>x-required-permission</code>, <code>x-audit-action</code>, <code>x-emits-event</code>), ch\u00fang c\u1ea7n \u0111\u01b0\u1ee3c gi\u1ea3i th\u00edch r\u00f5 r\u00e0ng m\u1ee5c \u0111\u00edch v\u00e0 c\u00e1ch s\u1eed d\u1ee5ng (c\u00f3 th\u1ec3 trong ph\u1ea7n m\u00f4 t\u1ea3 chung ho\u1eb7c trong m\u1ed9t t\u00e0i li\u1ec7u h\u01b0\u1edbng d\u1eabn ri\u00eang).</li> </ul> </li> </ul>"},{"location":"standards/5s.openapi.standard/#x-extensions-chuan-hoa-cho-toan-he-thong-dx-vas","title":"\ud83c\udfaf <code>x-extensions</code> chu\u1ea9n h\u00f3a cho to\u00e0n h\u1ec7 th\u1ed1ng <code>dx-vas</code>","text":"<p>C\u00e1c <code>x-extensions</code> d\u01b0\u1edbi \u0111\u00e2y \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng \u0111\u1ec3 m\u00f4 t\u1ea3 c\u00e1c \u0111\u1eb7c \u0111i\u1ec3m logic n\u1ed9i b\u1ed9 (RBAC, \u0111i\u1ec1u ki\u1ec7n runtime, trace, v.v.) v\u00e0 s\u1ebd \u0111\u01b0\u1ee3c chu\u1ea9n h\u00f3a tr\u00ean to\u00e0n b\u1ed9 c\u00e1c OpenAPI spec c\u1ee7a h\u1ec7 th\u1ed1ng <code>dx-vas</code>. Nh\u1eefng extension n\u00e0y \u0111\u01b0\u1ee3c API Gateway s\u1eed d\u1ee5ng \u0111\u1ec3 th\u1ef1c hi\u1ec7n ph\u00e2n quy\u1ec1n, \u0111\u1ecbnh tuy\u1ebfn v\u00e0 quan s\u00e1t (observability) trong runtime.</p>"},{"location":"standards/5s.openapi.standard/#quy-tac-su-dung","title":"\u2705 Quy t\u1eafc s\u1eed d\u1ee5ng:","text":"<ul> <li>Ch\u1ec9 d\u00f9ng trong c\u00e1c field h\u1ee3p l\u1ec7 theo OpenAPI 3.x: <code>paths</code>, <code>operation</code>, <code>tags</code>, <code>info</code>, v.v.</li> <li>Kh\u00f4ng \u0111\u01b0\u1ee3c khai b\u00e1o d\u01b0\u1edbi block <code>components:</code></li> <li>Kh\u00f4ng d\u00f9ng nh\u01b0 schema \u0111\u1ec3 <code>$ref</code></li> <li>C\u1ea7n c\u00f3 v\u00ed d\u1ee5, m\u00f4 t\u1ea3 r\u00f5 r\u00e0ng, v\u00e0 th\u1ed1ng nh\u1ea5t to\u00e0n h\u1ec7 th\u1ed1ng</li> </ul>"},{"location":"standards/5s.openapi.standard/#x-required-permission","title":"\ud83d\udd12 <code>x-required-permission</code>","text":"<pre><code>x-required-permission: \"user.read\"\n</code></pre> <ul> <li>M\u00f4 t\u1ea3: M\u00e3 permission y\u00eau c\u1ea7u m\u00e0 ng\u01b0\u1eddi d\u00f9ng ph\u1ea3i c\u00f3 \u0111\u1ec3 truy c\u1eadp route n\u00e0y.</li> <li>X\u1eed l\u00fd: Gateway s\u1ebd ki\u1ec3m tra permission c\u00f3 n\u1eb1m trong Redis key <code>rbac:{user_id}:{tenant_id}</code> kh\u00f4ng.</li> <li>\u00c1p d\u1ee5ng t\u1ea1i: <code>paths</code>, <code>paths.[path].[method]</code></li> </ul>"},{"location":"standards/5s.openapi.standard/#x-condition","title":"\ud83e\udde9 <code>x-condition</code>","text":"<pre><code>x-condition:\n  user_id: \"{{X-User-ID}}\"\n  tenant_id: \"{{X-Tenant-ID}}\"\n</code></pre> <ul> <li>M\u00f4 t\u1ea3: \u0110i\u1ec1u ki\u1ec7n logic ng\u1eef c\u1ea3nh runtime. C\u00f3 th\u1ec3 d\u00f9ng placeholder d\u1ea1ng <code>{{HEADER_NAME}}</code>.</li> <li>X\u1eed l\u00fd: Gateway s\u1ebd so s\u00e1nh gi\u00e1 tr\u1ecb th\u1ef1c t\u1ebf v\u1edbi \u0111i\u1ec1u ki\u1ec7n n\u00e0y \u0111\u1ec3 cho ph\u00e9p/deny truy c\u1eadp.</li> <li>\u00c1p d\u1ee5ng t\u1ea1i: <code>paths</code>, <code>paths.[path].[method]</code></li> </ul>"},{"location":"standards/5s.openapi.standard/#x-gateway-enforced","title":"\u2705 <code>x-gateway-enforced</code>","text":"<pre><code>x-gateway-enforced: true\n</code></pre> <ul> <li>M\u00f4 t\u1ea3: \u0110\u00e1nh d\u1ea5u route n\u00e0y c\u00f3 \u0111\u01b0\u1ee3c ki\u1ec3m so\u00e1t b\u1edfi Gateway (RBAC, trace, condition) hay kh\u00f4ng.</li> <li>X\u1eed l\u00fd: N\u1ebfu <code>false</code>, route s\u1ebd \u0111\u01b0\u1ee3c forward raw, kh\u00f4ng ki\u1ec3m so\u00e1t.</li> <li>\u00c1p d\u1ee5ng t\u1ea1i: <code>paths</code>, <code>paths.[path].[method]</code></li> </ul>"},{"location":"standards/5s.openapi.standard/#x-route-evaluation","title":"\ud83d\udcca <code>x-route-evaluation</code>","text":"<pre><code>x-route-evaluation: \"check-permission + forward\"\n</code></pre> <ul> <li>M\u00f4 t\u1ea3: Ghi ch\u00fa logic x\u1eed l\u00fd c\u1ee7a route \u2013 ph\u1ee5c v\u1ee5 testing, observability, analytics.</li> <li>Gi\u00e1 tr\u1ecb g\u1ee3i \u00fd: <code>check-permission</code>, <code>check-condition</code>, <code>introspect-token</code>, <code>forward-only</code>, ...</li> <li>\u00c1p d\u1ee5ng t\u1ea1i: <code>paths</code>, <code>paths.[path].[method]</code></li> </ul>"},{"location":"standards/5s.openapi.standard/#x-internal-a-dung-trong-tags","title":"\ud83d\udd10 <code>x-internal</code> (\u0111\u00e3 d\u00f9ng trong tags)","text":"<pre><code>x-internal: true\n</code></pre> <ul> <li>M\u00f4 t\u1ea3: G\u1eafn nh\u00e3n nh\u00f3m API ch\u1ec9 d\u00e0nh cho n\u1ed9i b\u1ed9, kh\u00f4ng xu\u1ea5t hi\u1ec7n trong public docs.</li> <li>\u00c1p d\u1ee5ng t\u1ea1i: <code>tags[]</code></li> </ul> <p>\ud83d\udccc M\u1ecdi service khi s\u1eed d\u1ee5ng c\u00e1c <code>x-extensions</code> n\u00e0y c\u1ea7n tu\u00e2n th\u1ee7 ch\u00ednh t\u1ea3, format v\u00e0 ng\u1eef ngh\u0129a chu\u1ea9n nh\u01b0 tr\u00ean. Gateway v\u00e0 h\u1ec7 th\u1ed1ng ki\u1ec3m th\u1eed CI s\u1ebd reject n\u1ebfu kh\u00f4ng \u0111\u1ea1t chu\u1ea9n.</p>"},{"location":"standards/5s.service.design.standard/","title":"\u2705 Checklist Ti\u00eau Chu\u1ea9n 5\u2605 cho T\u00e0i Li\u1ec7u Thi\u1ebft K\u1ebf Service","text":""},{"location":"standards/5s.service.design.standard/#1-muc-tieu-va-pham-vi-ro-rang-scope-responsibilities","title":"1. \ud83c\udfaf M\u1ee5c ti\u00eau v\u00e0 Ph\u1ea1m vi R\u00f5 r\u00e0ng (Scope &amp; Responsibilities)","text":"<ul> <li> M\u1ee5c \u0111\u00edch t\u1ed3n t\u1ea1i (Purpose): N\u00eau r\u00f5 l\u00fd do service ra \u0111\u1eddi, v\u1ea5n \u0111\u1ec1 gi\u1ea3i quy\u1ebft.</li> <li> Ch\u1ee9c n\u0103ng ch\u00ednh (Core Responsibilities): Li\u1ec7t k\u00ea \u0111\u1ea7y \u0111\u1ee7 c\u00e1c tr\u00e1ch nhi\u1ec7m c\u1ed1t l\u00f5i c\u1ee7a service.</li> <li> Ngo\u00e0i ph\u1ea1m vi (Out of Scope): X\u00e1c \u0111\u1ecbnh r\u00f5 nh\u1eefng g\u00ec service KH\u00d4NG l\u00e0m \u0111\u1ec3 tr\u00e1nh hi\u1ec3u l\u1ea7m.</li> <li> \u0110\u1ed1i t\u01b0\u1ee3ng ng\u01b0\u1eddi d\u00f9ng/client c\u1ee7a service: X\u00e1c \u0111\u1ecbnh r\u00f5 ai/service n\u00e0o s\u1ebd s\u1eed d\u1ee5ng service n\u00e0y.</li> </ul>"},{"location":"standards/5s.service.design.standard/#2-thiet-ke-chi-tiet-va-hoan-chinh-comprehensive-detailed-design","title":"2. \ud83e\uddf1 Thi\u1ebft k\u1ebf Chi ti\u1ebft v\u00e0 Ho\u00e0n Ch\u1ec9nh (Comprehensive &amp; Detailed Design)","text":"<ul> <li> Th\u00e0nh ph\u1ea7n n\u1ed9i b\u1ed9 (Internal Components/Modules): M\u00f4 t\u1ea3 ki\u1ebfn tr\u00fac b\u00ean trong, c\u00e1c module ch\u00ednh v\u00e0 vai tr\u00f2 c\u1ee7a ch\u00fang.</li> <li> M\u00f4 h\u00ecnh d\u1eef li\u1ec7u (Data Model):<ul> <li> Chi ti\u1ebft c\u00e1c th\u1ef1c th\u1ec3 d\u1eef li\u1ec7u (b\u1ea3ng, tr\u01b0\u1eddng, ki\u1ec3u d\u1eef li\u1ec7u, r\u00e0ng bu\u1ed9c, PK, FK, index).</li> <li> C\u00f3 s\u01a1 \u0111\u1ed3 ERD tr\u1ef1c quan (n\u1ebfu \u00e1p d\u1ee5ng).</li> </ul> </li> <li> H\u1ee3p \u0111\u1ed3ng API (Interface Contract / OpenAPI):<ul> <li> \u0110\u1eb7c t\u1ea3 chi ti\u1ebft t\u1eebng API endpoint (HTTP method, path, version).</li> <li> C\u1ea5u tr\u00fac \u0111\u1ea7y \u0111\u1ee7 cho request (parameters, body) v\u00e0 response (body, status codes).</li> <li> V\u00ed d\u1ee5 request/response c\u1ee5 th\u1ec3.</li> <li> M\u00e3 l\u1ed7i (error codes) v\u00e0 \u00fd ngh\u0129a.</li> <li> Y\u00eau c\u1ea7u permission/quy\u1ec1n truy c\u1eadp cho t\u1eebng API.</li> <li> Tu\u00e2n th\u1ee7 chu\u1ea9n OpenAPI (n\u1ebfu c\u00f3).</li> </ul> </li> <li> Lu\u1ed3ng nghi\u1ec7p v\u1ee5 ch\u00ednh (Business Logic Flows):<ul> <li> M\u00f4 t\u1ea3/minh h\u1ecda c\u00e1c k\u1ecbch b\u1ea3n s\u1eed d\u1ee5ng quan tr\u1ecdng (v\u00ed d\u1ee5: sequence diagrams).</li> <li> Logic x\u1eed l\u00fd ch\u00ednh \u0111\u01b0\u1ee3c l\u00e0m r\u00f5.</li> </ul> </li> <li> T\u01b0\u01a1ng t\u00e1c v\u00e0 S\u1ef1 ki\u1ec7n (Interactions &amp; Events):<ul> <li> M\u00f4 t\u1ea3 c\u00e1ch service g\u1ecdi c\u00e1c service kh\u00e1c (n\u1ebfu c\u00f3).</li> <li> Chi ti\u1ebft c\u00e1c s\u1ef1 ki\u1ec7n service ph\u00e1t ra (publish) ho\u1eb7c l\u1eafng nghe (subscribe).</li> <li> C\u1ea5u tr\u00fac payload s\u1ef1 ki\u1ec7n \u0111\u01b0\u1ee3c \u0111\u1ecbnh ngh\u0129a r\u00f5 r\u00e0ng.</li> </ul> </li> </ul>"},{"location":"standards/5s.service.design.standard/#3-tuan-thu-kien-truc-va-nguyen-tac-chung-architectural-alignment-compliance","title":"3. \ud83d\udcdc Tu\u00e2n th\u1ee7 Ki\u1ebfn tr\u00fac v\u00e0 Nguy\u00ean t\u1eafc Chung (Architectural Alignment &amp; Compliance)","text":"<ul> <li> ADRs &amp; Ti\u00eau chu\u1ea9n h\u1ec7 th\u1ed1ng: Kh\u1eb3ng \u0111\u1ecbnh vi\u1ec7c tu\u00e2n th\u1ee7 c\u00e1c Quy\u1ebft \u0111\u1ecbnh Ki\u1ebfn tr\u00fac (ADRs) li\u00ean quan v\u00e0 c\u00e1c ti\u00eau chu\u1ea9n chung (logging, monitoring, error handling, response structure, naming conventions).</li> <li> T\u00ednh nh\u1ea5t qu\u00e1n v\u1edbi ki\u1ebfn tr\u00fac t\u1ed5ng th\u1ec3: Thi\u1ebft k\u1ebf ph\u00f9 h\u1ee3p, kh\u00f4ng m\u00e2u thu\u1eabn hay l\u1eb7p l\u1ea1i ch\u1ee9c n\u0103ng v\u1edbi c\u00e1c service kh\u00e1c.</li> </ul>"},{"location":"standards/5s.service.design.standard/#4-khia-canh-phi-chuc-nang-non-functional-requirements-nfrs","title":"4. \ud83d\ude80 Kh\u00eda c\u1ea1nh Phi ch\u1ee9c n\u0103ng (Non-Functional Requirements - NFRs)","text":"<ul> <li> B\u1ea3o m\u1eadt &amp; Ph\u00e2n quy\u1ec1n (Security &amp; Authorization):<ul> <li> C\u01a1 ch\u1ebf x\u00e1c th\u1ef1c (authentication).</li> <li> M\u00f4 h\u00ecnh ph\u00e2n quy\u1ec1n (authorization) cho API v\u00e0 c\u00e1c ch\u1ee9c n\u0103ng.</li> <li> C\u00e1ch x\u1eed l\u00fd d\u1eef li\u1ec7u nh\u1ea1y c\u1ea3m (PII).</li> </ul> </li> <li> C\u1ea5u h\u00ecnh &amp; Ph\u1ee5 thu\u1ed9c (Configuration &amp; Dependencies):<ul> <li> Li\u1ec7t k\u00ea c\u00e1c bi\u1ebfn m\u00f4i tr\u01b0\u1eddng, secrets c\u1ea7n thi\u1ebft v\u00e0 c\u00e1ch qu\u1ea3n l\u00fd.</li> <li> N\u00eau r\u00f5 c\u00e1c ph\u1ee5 thu\u1ed9c v\u00e0o service/th\u01b0 vi\u1ec7n b\u00ean ngo\u00e0i.</li> </ul> </li> <li> Hi\u1ec7u n\u0103ng &amp; Kh\u1ea3 n\u0103ng m\u1edf r\u1ed9ng (Performance &amp; Scalability):<ul> <li> C\u00e1c c\u00e2n nh\u1eafc v\u1ec1 hi\u1ec7u n\u0103ng (SLO latency, throughput).</li> <li> Chi\u1ebfn l\u01b0\u1ee3c caching (n\u1ebfu c\u00f3).</li> <li> Kh\u1ea3 n\u0103ng auto-scaling (n\u1ebfu \u00e1p d\u1ee5ng).</li> </ul> </li> <li> Kh\u1ea3 n\u0103ng gi\u00e1m s\u00e1t (Observability / Monitoring):<ul> <li> C\u00e1c metrics ch\u00ednh c\u1ea7n theo d\u00f5i.</li> <li> Chi\u1ebfn l\u01b0\u1ee3c logging (log nh\u1eefng g\u00ec, c\u1ea5u tr\u00fac log).</li> <li> Kh\u1ea3 n\u0103ng tracing request.</li> </ul> </li> <li> \u0110\u1ed9 tin c\u1eady &amp; Kh\u1ea3 n\u0103ng ph\u1ee5c h\u1ed3i (Reliability &amp; Resilience):<ul> <li> C\u00e1ch x\u1eed l\u00fd l\u1ed7i, c\u01a1 ch\u1ebf retry.</li> <li> T\u00ednh idempotency cho c\u00e1c thao t\u00e1c quan tr\u1ecdng (\u0111\u1eb7c bi\u1ec7t khi x\u1eed l\u00fd event).</li> </ul> </li> <li> Kh\u1ea3 n\u0103ng ki\u1ec3m th\u1eed (Testability):<ul> <li> \u0110\u1ec1 xu\u1ea5t chi\u1ebfn l\u01b0\u1ee3c testing (unit, integration, contract tests).</li> <li> C\u00e1c k\u1ecbch b\u1ea3n ki\u1ec3m th\u1eed quan tr\u1ecdng c\u1ea7n \u0111\u01b0\u1ee3c bao ph\u1ee7.</li> </ul> </li> </ul>"},{"location":"standards/5s.service.design.standard/#5-chat-luong-trinh-bay-va-tinh-thuc-tien-documentation-quality-practicality","title":"5. \u270d\ufe0f Ch\u1ea5t l\u01b0\u1ee3ng Tr\u00ecnh b\u00e0y v\u00e0 T\u00ednh Th\u1ef1c ti\u1ec5n (Documentation Quality &amp; Practicality)","text":"<ul> <li> C\u1ea5u tr\u00fac logic, d\u1ec5 \u0111i\u1ec1u h\u01b0\u1edbng: C\u00f3 m\u1ee5c l\u1ee5c, ph\u00e2n chia r\u00f5 r\u00e0ng.</li> <li> Ng\u00f4n ng\u1eef ch\u00ednh x\u00e1c, m\u1ea1ch l\u1ea1c: S\u1eed d\u1ee5ng thu\u1eadt ng\u1eef k\u1ef9 thu\u1eadt th\u1ed1ng nh\u1ea5t.</li> <li> Minh h\u1ecda tr\u1ef1c quan: S\u1eed d\u1ee5ng bi\u1ec3u \u0111\u1ed3 (architecture, sequence, ERD) khi c\u1ea7n.</li> <li> T\u00ednh th\u1ef1c ti\u1ec5n cao: \u0110\u1ee7 chi ti\u1ebft \u0111\u1ec3 \u0111\u1ed9i ng\u0169 ph\u00e1t tri\u1ec3n c\u00f3 th\u1ec3 tri\u1ec3n khai m\u00e0 kh\u00f4ng c\u1ea7n nhi\u1ec1u gi\u1ea3i th\u00edch th\u00eam.</li> <li> D\u1ec5 b\u1ea3o tr\u00ec: T\u00e0i li\u1ec7u \u0111\u01b0\u1ee3c vi\u1ebft theo c\u00e1ch d\u1ec5 c\u1eadp nh\u1eadt khi service c\u00f3 thay \u0111\u1ed5i.</li> <li> Ng\u00e0y th\u00e1ng v\u00e0 phi\u00ean b\u1ea3n t\u00e0i li\u1ec7u: Ghi r\u00f5 ng\u00e0y t\u1ea1o/c\u1eadp nh\u1eadt v\u00e0 phi\u00ean b\u1ea3n.</li> <li> T\u00e1c gi\u1ea3/Ng\u01b0\u1eddi review: Ghi r\u00f5 ng\u01b0\u1eddi ch\u1ecbu tr\u00e1ch nhi\u1ec7m v\u00e0 ng\u01b0\u1eddi \u0111\u00e3 review.</li> </ul>"},{"location":"standards/error-codes/","title":"\ud83d\udee1\ufe0f Chu\u1ea9n H\u00f3a M\u00e3 L\u1ed7i (Error Code Standards) - DX-VAS","text":"<p>T\u00e0i li\u1ec7u n\u00e0y \u0111\u1ecbnh ngh\u0129a chu\u1ea9n h\u00f3a c\u00e1c m\u00e3 l\u1ed7i (<code>error.code</code>) \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng th\u1ed1ng nh\u1ea5t trong to\u00e0n b\u1ed9 h\u1ec7 th\u1ed1ng DX-VAS, nh\u1eb1m \u0111\u1ea3m b\u1ea3o:</p> <ul> <li>\u2705 D\u1ec5 \u0111\u1ecdc \u2013 C\u00f3 c\u1ea5u tr\u00fac r\u00f5 r\u00e0ng theo nh\u00f3m (namespace).</li> <li>\ud83c\udf10 D\u1ec5 i18n \u2013 D\u1ec5 \u00e1nh x\u1ea1 sang message hi\u1ec3n th\u1ecb theo ng\u00f4n ng\u1eef.</li> <li>\ud83d\udcca D\u1ec5 ph\u00e2n t\u00edch \u2013 Log h\u1ec7 th\u1ed1ng c\u00f3 th\u1ec3 l\u1ecdc theo nh\u00f3m l\u1ed7i (<code>token.*</code>, <code>user.*</code>, ...).</li> <li>\ud83d\udd12 An to\u00e0n \u2013 Kh\u00f4ng \u0111\u1ec3 l\u1ed9 chi ti\u1ebft n\u1ed9i b\u1ed9 khi kh\u00f4ng c\u1ea7n thi\u1ebft.</li> </ul>"},{"location":"standards/error-codes/#quy-uoc-at-ten-errorcode","title":"\u2705 Quy \u01b0\u1edbc \u0110\u1eb7t t\u00ean <code>error.code</code>","text":"<ul> <li>C\u1ea5u tr\u00fac: <code>namespace.error_key</code></li> <li><code>namespace</code> l\u00e0 t\u00ean domain logic: <code>token</code>, <code>auth</code>, <code>session</code>, <code>user</code>, <code>common</code>, <code>jwks</code>, ...</li> <li><code>error_key</code> l\u00e0 t\u00ean l\u1ed7i c\u1ee5 th\u1ec3, vi\u1ebft <code>snake_case</code>.</li> </ul> <p>V\u00ed d\u1ee5: - <code>token.expired</code> - <code>session.not_found</code> - <code>common.validation_failed</code></p>"},{"location":"standards/error-codes/#nhom-loi-chinh-namespace","title":"\ud83d\udd12 Nh\u00f3m L\u1ed7i Ch\u00ednh (Namespace)","text":""},{"location":"standards/error-codes/#token-cac-loi-lien-quan-en-jwt-token","title":"<code>token.*</code> \u2014 C\u00e1c l\u1ed7i li\u00ean quan \u0111\u1ebfn JWT Token","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 <code>token.invalid</code> Token kh\u00f4ng h\u1ee3p l\u1ec7 ho\u1eb7c b\u1ecb ch\u1ec9nh s\u1eeda <code>token.expired</code> Token \u0111\u00e3 h\u1ebft h\u1ea1n <code>token.revoked</code> Token \u0111\u00e3 b\u1ecb thu h\u1ed3i <code>token.unknown_jti</code> Kh\u00f4ng t\u00ecm th\u1ea5y JTI token trong h\u1ec7 th\u1ed1ng"},{"location":"standards/error-codes/#session-loi-lien-quan-en-phien-ang-nhap","title":"<code>session.*</code> \u2014 L\u1ed7i li\u00ean quan \u0111\u1ebfn phi\u00ean \u0111\u0103ng nh\u1eadp","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 <code>session.not_found</code> Kh\u00f4ng t\u00ecm th\u1ea5y phi\u00ean \u0111\u0103ng nh\u1eadp <code>session.inactive</code> Phi\u00ean \u0111\u0103ng nh\u1eadp \u0111\u00e3 b\u1ecb \u0111\u00f3ng"},{"location":"standards/error-codes/#auth-loi-xac-thuc","title":"<code>auth.*</code> \u2014 L\u1ed7i x\u00e1c th\u1ef1c","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 <code>auth.invalid_credential</code> Email/password kh\u00f4ng \u0111\u00fang <code>auth.unauthorized</code> Thi\u1ebfu ho\u1eb7c sai token <code>auth.permission_denied</code> Kh\u00f4ng \u0111\u1ee7 quy\u1ec1n truy c\u1eadp"},{"location":"standards/error-codes/#jwks-loi-lien-quan-en-public-key-jwks","title":"<code>jwks.*</code> \u2014 L\u1ed7i li\u00ean quan \u0111\u1ebfn public key / jwks","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 <code>jwks.not_found</code> Kh\u00f4ng t\u00ecm th\u1ea5y JWKS ph\u00f9 h\u1ee3p"},{"location":"standards/error-codes/#user-loi-lien-quan-en-nguoi-dung","title":"<code>user.*</code> \u2014 L\u1ed7i li\u00ean quan \u0111\u1ebfn ng\u01b0\u1eddi d\u00f9ng","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 <code>user.not_found</code> Kh\u00f4ng t\u00ecm th\u1ea5y ng\u01b0\u1eddi d\u00f9ng <code>user.inactive</code> Ng\u01b0\u1eddi d\u00f9ng b\u1ecb kh\u00f3a <code>user.already_exists</code> Email/username \u0111\u00e3 t\u1ed3n t\u1ea1i"},{"location":"standards/error-codes/#common-loi-chung","title":"<code>common.*</code> \u2014 L\u1ed7i chung","text":"M\u00e3 l\u1ed7i M\u00f4 t\u1ea3 <code>common.validation_failed</code> Payload kh\u00f4ng \u0111\u00fang \u0111\u1ecbnh d\u1ea1ng ho\u1eb7c thi\u1ebfu field <code>common.missing_param</code> Thi\u1ebfu tham s\u1ed1 b\u1eaft bu\u1ed9c trong request <code>common.forbidden</code> Kh\u00f4ng \u0111\u01b0\u1ee3c ph\u00e9p truy c\u1eadp <code>common.internal_error</code> L\u1ed7i kh\u00f4ng x\u00e1c \u0111\u1ecbnh trong h\u1ec7 th\u1ed1ng"},{"location":"standards/error-codes/#huong-dan-tich-hop","title":"\ud83e\udde9 H\u01b0\u1edbng d\u1eabn t\u00edch h\u1ee3p","text":""},{"location":"standards/error-codes/#1-trong-openapi","title":"1. Trong OpenAPI","text":"<pre><code>components:\n  schemas:\n    ErrorEnvelope:\n      type: object\n      properties:\n        error:\n          type: object\n          properties:\n            code:\n              type: string\n              example: \"token.expired\"\n            message:\n              type: string\n              example: \"Token \u0111\u00e3 h\u1ebft h\u1ea1n\"\n</code></pre>"},{"location":"standards/error-codes/#2-trong-frontend-i18n","title":"2. Trong Frontend (i18n)","text":"<pre><code>{\n  \"token.expired\": \"Phi\u00ean \u0111\u0103ng nh\u1eadp \u0111\u00e3 h\u1ebft h\u1ea1n\",\n  \"auth.invalid_credential\": \"T\u00e0i kho\u1ea3n ho\u1eb7c m\u1eadt kh\u1ea9u kh\u00f4ng \u0111\u00fang\",\n  ...\n}\n</code></pre> <p>\ud83d\udccc M\u1ecdi service c\u1ea7n \u0111\u0103ng k\u00fd prefix <code>namespace.*</code> c\u1ee7a m\u00ecnh t\u1ea1i t\u00e0i li\u1ec7u n\u00e0y \u0111\u1ec3 tr\u00e1nh tr\u00f9ng l\u1eb7p.</p> <p>\u0110\u01b0\u1ee3c duy tr\u00ec b\u1edfi team DX Platform. M\u1ecdi \u0111\u1ec1 xu\u1ea5t b\u1ed5 sung namespace m\u1edbi, vui l\u00f2ng g\u1eedi PR c\u1eadp nh\u1eadt file n\u00e0y.</p>"},{"location":"standards/service-design-checklist/","title":"Service design checklist","text":""},{"location":"standards/service-design-checklist/#checklist-chuan-thiet-ke-service-dx-vas","title":"\u2705 Checklist Chu\u1ea9n Thi\u1ebft k\u1ebf Service DX-VAS","text":"H\u1ea1ng m\u1ee5c Tr\u1ea1ng th\u00e1i Ghi ch\u00fa 1. design.md \u2610 Tu\u00e2n theo <code>design.template.md</code> \u2013 M\u00f4 t\u1ea3 r\u00f5 use case, trigger ch\u00ednh \u2610 Business logic, external interaction \u2013 C\u00f3 module n\u1ed9i b\u1ed9 r\u00f5 r\u00e0ng (service view) \u2610 Dispatcher, Manager, Worker, v.v. \u2013 T\u01b0\u01a1ng t\u00e1c service kh\u00e1c (Pub/Sub, API call) \u2610 V\u1ebd flow ho\u1eb7c sequence diagram n\u1ebfu c\u1ea7n \u2013 K\u1ebf ho\u1ea1ch c\u1ea5u h\u00ecnh &amp; ph\u1ee5 thu\u1ed9c \u2610 .env, secret, external service \u2013 Chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed &amp; tri\u1ec3n khai \u2610 Unit, integration, migration \u2013 K\u1ebf ho\u1ea1ch gi\u00e1m s\u00e1t &amp; kh\u00f4i ph\u1ee5c l\u1ed7i \u2610 Logging, tracing, retry <p>| 2. interface-contract.md          | \u2610          | Tu\u00e2n theo <code>interface-contract.template.md</code> | | \u2013 \u0110\u1ea7y \u0111\u1ee7 t\u1ea5t c\u1ea3 endpoint ch\u00ednh        | \u2610          | CRUD + \u0111\u1eb7c th\u00f9 nghi\u1ec7p v\u1ee5 | | \u2013 C\u00f3 m\u00f4 t\u1ea3 request/response r\u00f5 r\u00e0ng   | \u2610          | Headers, params, body | | \u2013 \u00c1p d\u1ee5ng <code>x-required-permission</code>     | \u2610          | Chu\u1ea9n theo RBAC | | \u2013 M\u00f4 t\u1ea3 ENUM, permission mapping      | \u2610          | H\u1ed7 tr\u1ee3 frontend/dev hi\u1ec3u |</p> <p>| 3. data-model.md                  | \u2610          | Tu\u00e2n theo <code>data-model.template.md</code> | | \u2013 C\u00f3 s\u01a1 \u0111\u1ed3 ERD \u0111\u1ea7y \u0111\u1ee7                 | \u2610          | S\u1eed d\u1ee5ng Mermaid ho\u1eb7c tool kh\u00e1c | | \u2013 M\u00f4 t\u1ea3 r\u00f5 t\u1ea5t c\u1ea3 b\u1ea3ng v\u00e0 c\u1ed9t         | \u2610          | K\u00e8m ki\u1ec3u d\u1eef li\u1ec7u, m\u00f4 t\u1ea3 | | \u2013 C\u00f3 indexes, constraints             | \u2610          | Unique, FK, composite indexes | | \u2013 C\u00f3 chi\u1ebfn l\u01b0\u1ee3c Retention &amp; TTL       | \u2610          | Batch job, archive, auto-delete | | \u2013 C\u00f3 ph\u1ee5 l\u1ee5c ENUM, access control     | \u2610          | Enum m\u1edf r\u1ed9ng n\u1ebfu c\u1ea7n | | \u2013 C\u00f3 ph\u1ee5 l\u1ee5c chi\u1ebfn l\u01b0\u1ee3c ki\u1ec3m th\u1eed DB   | \u2610          | Seed, fixture, rollback logic |</p> <p>| 4. openapi.yaml                   | \u2610          | Tu\u00e2n theo <code>openapi.template.yaml</code> | | \u2013 D\u00f9ng <code>OpenAPI 3.0.3</code>, c\u00f3 <code>info</code>, <code>servers</code>, <code>tags</code> | \u2610 | Chu\u1ea9n h\u00f3a to\u00e0n c\u1ee5c | | \u2013 M\u1ed7i operation c\u00f3 <code>summary</code>, <code>operationId</code>, <code>x-required-permission</code> | \u2610 | R\u00f5 r\u00e0ng | | \u2013 T\u00e1i s\u1eed d\u1ee5ng <code>components.responses</code>, <code>parameters</code>, <code>headers</code>, <code>schemas</code> | \u2610 | Kh\u00f4ng l\u1eb7p l\u1ea1i | | \u2013 C\u00f3 <code>examples</code>, <code>readOnly</code>, <code>writeOnly</code> | \u2610        | \u0110\u1ee7 cho request/response | | \u2013 C\u00e1c l\u1ed7i <code>400</code>, <code>404</code>, <code>default</code> t\u00e1ch r\u00f5 | \u2610      | Chu\u1ea9n h\u00f3a l\u1ed7i theo <code>ADR-012</code> | | \u2013 C\u00f3 h\u1ed7 tr\u1ee3 pagination (n\u1ebfu \u00e1p d\u1ee5ng) | \u2610          | <code>page</code>, <code>limit</code> |</p>"},{"location":"standards/service-design-checklist/#tong-ket","title":"\ud83d\udea6 T\u1ed5ng k\u1ebft","text":"Giai \u0111o\u1ea1n Tr\u1ea1ng th\u00e1i Ghi ch\u00fa Thi\u1ebft k\u1ebf business v\u00e0 k\u1ef9 thu\u1eadt \u2610 design.md Thi\u1ebft k\u1ebf contract &amp; API \u2610 interface-contract.md + openapi.yaml Thi\u1ebft k\u1ebf c\u01a1 s\u1edf d\u1eef li\u1ec7u \u2610 data-model.md Chu\u1ea9n b\u1ecb cho ph\u00e1t tri\u1ec3n &amp; CI/CD \u2610 contract test-ready"},{"location":"standards/service-design-checklist/#san-sang-cho","title":"\ud83d\udce6 S\u1eb5n s\u00e0ng cho","text":"M\u1ee5c ti\u00eau Tr\u1ea1ng th\u00e1i Ghi ch\u00fa Contract Testing (<code>ADR-010</code>) \u2610 <code>openapi.yaml</code> \u0111\u1ea7y \u0111\u1ee7 schema, response, v\u00ed d\u1ee5 Mock Server / Auto-Generated SDK \u2610 C\u00f3 <code>examples</code>, <code>readOnly</code>, <code>operationId</code> CI/CD Integration (<code>ADR-001</code>) \u2610 C\u00f3 th\u1ec3 ki\u1ec3m tra qua linter, test runner \u0110\u1ed3ng b\u1ed9 RBAC (<code>ADR-007</code>) \u2610 <code>x-required-permission</code> c\u00f3 \u1edf t\u1ea5t c\u1ea3 endpoints Frontend Integration \u2610 Contract r\u00f5 r\u00e0ng, d\u00f9ng <code>ErrorEnvelope</code>, headers th\u1ed1ng nh\u1ea5t Ph\u00e1t tri\u1ec3n Backend \u2610 C\u00f3 \u0111\u1ee7 th\u00f4ng tin logic, DB, API, event flow T\u1ef1 \u0111\u1ed9ng sinh d\u1eef li\u1ec7u m\u1eabu (seeding) \u2610 <code>data-model.md</code> c\u00f3 v\u00ed d\u1ee5 m\u1eabu r\u00f5 r\u00e0ng Gi\u00e1m s\u00e1t &amp; Logging (<code>ADR-008</code>) \u2610 C\u00f3 ph\u1ea7n m\u00f4 t\u1ea3 <code>X-Request-ID</code>, tracing Tri\u1ec3n khai &amp; c\u1ea5u h\u00ecnh (<code>ADR-005</code>) \u2610 <code>.env</code>, secret, pubsub topic/DB \u0111\u00e3 \u0111\u1ecbnh ngh\u0129a"}]}