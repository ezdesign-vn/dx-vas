
<!doctype html>
<html lang="vi" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Tài liệu kiến trúc và phát triển cho dự án Chuyển đổi số Trường Việt Anh.">
      
      
        <meta name="author" content="DX VAS Security & Platform Team">
      
      
        <link rel="canonical" href="https://ezdesign-vn.github.io/dx-vas/ADR/adr-008-audit-logging/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>ADR-008 - Chiến lược Audit Logging cho hệ thống dx-vas - DX VAS - Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="pink">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#adr-008-audit-logging-nhat-ky-hoat-ong-va-giam-sat-an-ninh-he-thong" class="md-skip">
          Bỏ qua
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Đầu trang">
    <a href="../.." title="DX VAS - Docs" class="md-header__button md-logo" aria-label="DX VAS - Docs" data-md-component="logo">
      
  <img src="../../assets/images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DX VAS - Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ADR-008 - Chiến lược Audit Logging cho hệ thống dx-vas
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="pink"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Tìm kiếm" placeholder="Tìm kiếm" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Tìm kiếm">
        
        <button type="reset" class="md-search__icon md-icon" title="Xoá" aria-label="Xoá" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mã nguồn" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../architecture/system-diagrams/" class="md-tabs__link">
          
  
  
    
  
  Kiến trúc Hệ thống

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../dev-guide/" class="md-tabs__link">
        
  
  
    
  
  Hướng dẫn Phát triển

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../services/" class="md-tabs__link">
        
  
  
    
  
  Thiết kế Services

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../" class="md-tabs__link">
          
  
  
    
  
  Quyết định Kiến trúc (ADRs)

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Thanh điều hướng" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DX VAS - Docs" class="md-nav__button md-logo" aria-label="DX VAS - Docs" data-md-component="logo">
      
  <img src="../../assets/images/logo.png" alt="logo">

    </a>
    DX VAS - Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mã nguồn" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Kiến trúc Hệ thống
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Kiến trúc Hệ thống
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/system-diagrams/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sơ đồ Hệ thống
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/rbac-deep-dive/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RBAC Chi tiết
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dev-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hướng dẫn Phát triển
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Thiết kế Services
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Quyết định Kiến trúc (ADRs)
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Quyết định Kiến trúc (ADRs)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Mục lục">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Mục lục
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#boi-canh" class="md-nav__link">
    <span class="md-ellipsis">
      Bối cảnh
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quyet-inh" class="md-nav__link">
    <span class="md-ellipsis">
      Quyết định
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Quyết định">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-moi-hanh-ong-quan-trong-phai-uoc-ghi-log" class="md-nav__link">
    <span class="md-ellipsis">
      1. Mọi hành động quan trọng phải được ghi log
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-log-bat-buoc-phai-chua-cac-truong" class="md-nav__link">
    <span class="md-ellipsis">
      2. Log bắt buộc phải chứa các trường:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-giao-tiep-giua-service-phai-traceable" class="md-nav__link">
    <span class="md-ellipsis">
      3. Giao tiếp giữa service phải traceable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-notification-service-pubsub-option-b-ghi-log-nhu-sau" class="md-nav__link">
    <span class="md-ellipsis">
      4. Notification Service (Pub/Sub Option B) ghi log như sau:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-he-thong-log-tap-trung" class="md-nav__link">
    <span class="md-ellipsis">
      5. Hệ thống log tập trung
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-ghi-log-truy-cap-bao-cao-tu-reporting-service" class="md-nav__link">
    <span class="md-ellipsis">
      6. Ghi log truy cập báo cáo (từ Reporting Service)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#he-qua" class="md-nav__link">
    <span class="md-ellipsis">
      Hệ quả
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lien-ket-lien-quan" class="md-nav__link">
    <span class="md-ellipsis">
      Liên kết liên quan
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="adr-008-audit-logging-nhat-ky-hoat-ong-va-giam-sat-an-ninh-he-thong">ADR-008: Audit Logging – Nhật ký hoạt động và giám sát an ninh hệ thống<a class="headerlink" href="#adr-008-audit-logging-nhat-ky-hoat-ong-va-giam-sat-an-ninh-he-thong" title="Permanent link">¶</a></h1>
<h2 id="boi-canh">Bối cảnh<a class="headerlink" href="#boi-canh" title="Permanent link">¶</a></h2>
<p>Hệ thống dx-vas phục vụ nhiều tenant (trường thành viên), mỗi tenant có người dùng, phân quyền và thao tác riêng biệt. Việc theo dõi và ghi lại đầy đủ các hành vi quan trọng là thiết yếu để:</p>
<ul>
<li>Đảm bảo minh bạch trong thao tác phân quyền</li>
<li>Phát hiện sớm các hành vi đáng ngờ hoặc sai lệch</li>
<li>Hỗ trợ phân tích lỗi, truy vết sự cố và đối soát hoạt động</li>
<li>Đáp ứng yêu cầu bảo mật và kiểm toán theo từng tenant</li>
</ul>
<h2 id="quyet-inh">Quyết định<a class="headerlink" href="#quyet-inh" title="Permanent link">¶</a></h2>
<h3 id="1-moi-hanh-ong-quan-trong-phai-uoc-ghi-log">1. Mọi hành động quan trọng phải được ghi log<a class="headerlink" href="#1-moi-hanh-ong-quan-trong-phai-uoc-ghi-log" title="Permanent link">¶</a></h3>
<p>Bao gồm (nhưng không giới hạn):</p>
<ul>
<li>Đăng nhập / Đăng xuất (Google OAuth2, OTP, Local)</li>
<li>Gán quyền (user ↔ role ↔ permission)</li>
<li>Thay đổi trạng thái người dùng (<code>is_active</code>, <code>is_active_in_tenant</code>)</li>
<li>Gửi thông báo (qua Sub Notification Service hoặc từ Master)</li>
<li>Tạo / sửa / xoá role, permission, template</li>
<li>Bất kỳ hành động hệ thống liên quan tới tài chính, học sinh, hồ sơ</li>
</ul>
<h3 id="2-log-bat-buoc-phai-chua-cac-truong">2. Log bắt buộc phải chứa các trường:<a class="headerlink" href="#2-log-bat-buoc-phai-chua-cac-truong" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Trường</th>
<th>Ý nghĩa</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tenant_id</code></td>
<td>Tenant nơi xảy ra hành động</td>
</tr>
<tr>
<td><code>actor_user_id</code></td>
<td>ID người thực hiện hành động (user đăng nhập)</td>
</tr>
<tr>
<td><code>target_resource_type</code></td>
<td>Loại tài nguyên bị tác động (user, role, permission, notification, ...)</td>
</tr>
<tr>
<td><code>target_resource_id</code></td>
<td>ID tài nguyên bị tác động (nếu có)</td>
</tr>
<tr>
<td><code>action_type</code></td>
<td>Hành động cụ thể (assign_role, update_user, send_notification, ...)</td>
</tr>
<tr>
<td><code>action_scope</code></td>
<td>Phạm vi tác động (global / per-tenant)</td>
</tr>
<tr>
<td><code>trace_id</code></td>
<td>ID theo dõi xuyên suốt chuỗi sự kiện</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td>Thời điểm xảy ra</td>
</tr>
<tr>
<td><code>ip</code>, <code>user_agent</code></td>
<td>(nếu có thể lấy) từ request đầu vào</td>
</tr>
<tr>
<td><code>payload_before</code>, <code>payload_after</code></td>
<td>Ghi nhận giá trị trước/sau (cho audit thay đổi)</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Trong trường hợp audit RBAC hoặc notification, có thể log <code>target_resource_type = "user"</code>, <code>target_resource_id = &lt;user_id&gt;</code> để thể hiện user bị gán vai trò hoặc nhận thông báo.</p>
</blockquote>
<h3 id="3-giao-tiep-giua-service-phai-traceable">3. Giao tiếp giữa service phải traceable<a class="headerlink" href="#3-giao-tiep-giua-service-phai-traceable" title="Permanent link">¶</a></h3>
<ul>
<li>Các service (Auth, Gateway, Sub Service) gắn <code>trace_id</code> vào log</li>
<li>Nếu là call qua Pub/Sub → gắn <code>message_id</code>, <code>correlation_id</code></li>
</ul>
<h3 id="4-notification-service-pubsub-option-b-ghi-log-nhu-sau">4. Notification Service (Pub/Sub Option B) ghi log như sau:<a class="headerlink" href="#4-notification-service-pubsub-option-b-ghi-log-nhu-sau" title="Permanent link">¶</a></h3>
<ul>
<li>Mỗi Sub Notification Service:</li>
<li>Ghi log trạng thái gửi thông báo (<code>sent</code>, <code>failed</code>, <code>queued</code>, <code>skipped</code>)</li>
<li>Gắn: <code>tenant_id</code>, <code>notification_id</code>, <code>channel</code>, <code>receiver_count</code>, <code>error_detail</code> (nếu có)</li>
<li>
<p>Log có thể gắn <code>correlation_id</code> theo sự kiện từ Master</p>
</li>
<li>
<p>Notification Master:</p>
</li>
<li>Lắng nghe các sự kiện <code>tenant_notification_batch_status</code> để tổng hợp kết quả toàn hệ thống</li>
<li>Tổng hợp này cũng được ghi log dưới dạng audit, ví dụ:
    <div class="language-json highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">  </span><span class="nt">&quot;actor_user_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;superadmin_id&gt;&quot;</span><span class="p">,</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">  </span><span class="nt">&quot;action_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;global_notification_summary&quot;</span><span class="p">,</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span><span class="nt">&quot;target_resource_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;notification&quot;</span><span class="p">,</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">  </span><span class="nt">&quot;target_resource_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;notif-xyz&quot;</span><span class="p">,</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">  </span><span class="nt">&quot;success_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">  </span><span class="nt">&quot;fail_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">  </span><span class="nt">&quot;trace_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">  </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="p">}</span>
</span></code></pre></div></li>
<li>Ghi rõ tenant nào nhận thành công / thất bại (nếu cần đối soát)</li>
</ul>
<h3 id="5-he-thong-log-tap-trung">5. Hệ thống log tập trung<a class="headerlink" href="#5-he-thong-log-tap-trung" title="Permanent link">¶</a></h3>
<ul>
<li>Dùng Cloud Logging / Stackdriver</li>
<li>Tất cả log đều có cấu trúc JSON chuẩn → dễ phân tích bằng BigQuery</li>
<li>Cho phép filter theo <code>tenant_id</code>, <code>action_type</code>, <code>trace_id</code></li>
</ul>
<h3 id="6-ghi-log-truy-cap-bao-cao-tu-reporting-service">6. Ghi log truy cập báo cáo (từ Reporting Service)<a class="headerlink" href="#6-ghi-log-truy-cap-bao-cao-tu-reporting-service" title="Permanent link">¶</a></h3>
<ul>
<li>Mọi truy cập các API <code>/reports/*</code>, <code>/report-templates/*</code>, <code>/saved-reports/*</code> sẽ được ghi audit log.</li>
<li>Thông tin cần log:</li>
<li><code>actor_user_id</code>: người thực hiện truy cập</li>
<li><code>action_type</code>: <code>view_report</code>, <code>list_templates</code>, <code>generate_report</code>, <code>download_report</code>, ...</li>
<li><code>target_resource_type</code>: <code>"report_template"</code> hoặc <code>"report_result"</code></li>
<li><code>target_resource_id</code>: id của template hoặc report (nếu có)</li>
<li><code>input_parameters</code>: (nếu có) – được mask nếu chứa thông tin nhạy cảm</li>
<li><code>duration_ms</code>: thời gian thực thi truy vấn</li>
<li><code>tenant_id</code>, <code>trace_id</code>, <code>timestamp</code></li>
<li>Các trường nhạy cảm trong <code>input_parameters</code> như email, số điện thoại cần được mask hoặc loại trừ ra khỏi log.</li>
<li>Việc masking phải <strong>tuân thủ <code>ADR-024 - Data Anonymization &amp; Retention</code></strong>.</li>
<li>Cần xây dựng một danh sách whitelist hoặc pattern-based detection cho các tham số cần được ẩn/mask, và áp dụng nhất quán bằng middleware hoặc utility trước khi log.</li>
<li><code>target_resource_id</code>:</li>
<li>Với <code>generate_report</code>, đây thường là ID của <code>report_template</code>.</li>
<li>Nếu hệ thống sinh ra một <code>report_result_id</code> riêng (ví dụ khi export hoặc lưu báo cáo), thì có thể sử dụng <code>report_result_id</code> làm <code>target_resource_id</code>.</li>
</ul>
<p>Ví dụ:
<div class="language-json highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">  </span><span class="nt">&quot;actor_user_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;admin-001&quot;</span><span class="p">,</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">  </span><span class="nt">&quot;action_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;generate_report&quot;</span><span class="p">,</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">  </span><span class="nt">&quot;target_resource_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;report_template&quot;</span><span class="p">,</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">  </span><span class="nt">&quot;target_resource_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;login-by-tenant&quot;</span><span class="p">,</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">  </span><span class="nt">&quot;input_parameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="nt">&quot;start_date&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2024-01-01&quot;</span><span class="p">,</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="nt">&quot;end_date&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2024-01-31&quot;</span><span class="p">,</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="nt">&quot;tenant_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;vas-hn&quot;</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">  </span><span class="nt">&quot;duration_ms&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">142</span><span class="p">,</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">  </span><span class="nt">&quot;trace_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;abc-xyz-123&quot;</span><span class="p">,</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">  </span><span class="nt">&quot;tenant_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;vas-superadmin&quot;</span><span class="p">,</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">  </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-06-03T08:00:00Z&quot;</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="p">}</span>
</span></code></pre></div></p>
<h2 id="he-qua">Hệ quả<a class="headerlink" href="#he-qua" title="Permanent link">¶</a></h2>
<p>✅ Ưu điểm:</p>
<ul>
<li>Dễ theo dõi hoạt động của từng người dùng trong từng tenant</li>
<li>Giúp truy vết nhanh khi có lỗi, gian lận hoặc bất thường</li>
<li>Hỗ trợ quản trị tập trung nhưng phân quyền phân tích theo tenant</li>
</ul>
<p>⚠️ Lưu ý:</p>
<ul>
<li>Dữ liệu log cần được bảo vệ riêng, có retention phù hợp</li>
<li>Audit log quan trọng (RBAC, phân quyền) không được phép xóa</li>
<li>Cần cơ chế mask dữ liệu nhạy cảm khi export (email, số điện thoại)</li>
</ul>
<h2 id="lien-ket-lien-quan">Liên kết liên quan<a class="headerlink" href="#lien-ket-lien-quan" title="Permanent link">¶</a></h2>
<ul>
<li><a href="../adr-006-auth-strategy/">ADR-006 - Auth Strategy</a></li>
<li><a href="../adr-007-rbac/">ADR-007 - RBAC và phân quyền động</a></li>
<li><a href="../adr-012-response-structure/">ADR-012 - Response Structure</a></li>
<li><a href="../adr-028-reporting-architecture/">ADR-028 - Reporting Architecture</a></li>
<li><a href="../adr-029-report-template-schema/">ADR-029 - Report Template Schema</a></li>
<li><a href="../adr-030-event-schema-governance/">ADR-030 - Event Schema Governance</a></li>
<li><a href="../../architecture/rbac-deep-dive/#10-giám-sát--gỡ-lỗi">RBAC Deep Dive</a></li>
<li><a href="../../#17-bảo-mật--giám-sát">README - 17. Bảo mật &amp; giám sát</a></li>
</ul>
<hr />
<blockquote>
<p>“Nếu bạn không ghi lại hành vi của hệ thống – bạn sẽ không bao giờ biết điều gì đã xảy ra khi nó xảy ra.”</p>
</blockquote>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Trở lại mục lục
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>