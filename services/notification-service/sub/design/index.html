
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Tài liệu kiến trúc và phát triển cho dự án Chuyển đổi số Trường Việt Anh." name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://ezdesign-vn.github.io/dx-vas/services/notification-service/sub/design/" rel="canonical"/>
<link href="../../../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Thiết kế chi tiết Notification Sub Service - DX VAS - Docs</title>
<link href="../../../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#thiet-ke-chi-tiet-notification-sub-service">
          Bỏ qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Đầu trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Thiết kế chi tiết Notification Sub Service
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Tìm kiếm" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Tìm kiếm" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Tìm kiếm" class="md-search__options">
<button aria-label="Xoá" class="md-search__icon md-icon" tabindex="-1" title="Xoá" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mã nguồn">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../architecture/system-diagrams/">
          
  
  
    
  
  Kiến trúc Hệ thống

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../dev-guide/">
        
  
  
    
  
  Hướng dẫn Phát triển

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../">
        
  
  
    
  
  Thiết kế Services

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../ADR/">
          
  
  
    
  
  Quyết định Kiến trúc (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh điều hướng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mã nguồn">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Kiến trúc Hệ thống
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Kiến trúc Hệ thống
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../architecture/system-diagrams/">
<span class="md-ellipsis">
    Sơ đồ Hệ thống
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../architecture/rbac-deep-dive/">
<span class="md-ellipsis">
    RBAC Chi tiết
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../dev-guide/">
<span class="md-ellipsis">
    Hướng dẫn Phát triển
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../">
<span class="md-ellipsis">
    Thiết kế Services
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../../ADR/">
<span class="md-ellipsis">
    Quyết định Kiến trúc (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quyết định Kiến trúc (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Mục lục" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Mục lục
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-pham-vi-va-trach-nhiem">
<span class="md-ellipsis">
      1. 🧭 Phạm vi và Trách nhiệm
    </span>
</a>
<nav aria-label="1. 🧭 Phạm vi và Trách nhiệm" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#muc-tieu">
<span class="md-ellipsis">
      🎯 Mục tiêu
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cac-thuc-the-du-lieu-quan-ly">
<span class="md-ellipsis">
      📦 Các thực thể dữ liệu quản lý
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ngoai-pham-vi">
<span class="md-ellipsis">
      🔒 Ngoài Phạm Vi
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#oi-tuong-su-dung">
<span class="md-ellipsis">
      👥 Đối tượng sử dụng
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-thiet-ke-api-chi-tiet">
<span class="md-ellipsis">
      2. 🌐 Thiết kế API chi tiết
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-mo-hinh-du-lieu-chi-tiet">
<span class="md-ellipsis">
      3. 🗃️ Mô hình dữ liệu chi tiết
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-tuong-tac-su-kien">
<span class="md-ellipsis">
      5. 📣 Tương tác &amp; Sự kiện
    </span>
</a>
<nav aria-label="5. 📣 Tương tác &amp; Sự kiện" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-su-kien-nhan-vao-consumed-event">
<span class="md-ellipsis">
      5.1. Sự kiện nhận vào (Consumed Event)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-xu-ly-su-kien">
<span class="md-ellipsis">
      5.2. Xử lý sự kiện
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-khong-phat-sinh-su-kien-outbound">
<span class="md-ellipsis">
      5.3. Không phát sinh sự kiện outbound
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#54-bien-the-su-kien-kha-nang-mo-rong">
<span class="md-ellipsis">
      5.4. Biến thể sự kiện &amp; khả năng mở rộng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#55-chinh-sach-schema-versioning">
<span class="md-ellipsis">
      5.5. Chính sách Schema &amp; Versioning
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-bao-mat-rbac">
<span class="md-ellipsis">
      6. 🔐 Bảo mật &amp; RBAC
    </span>
</a>
<nav aria-label="6. 🔐 Bảo mật &amp; RBAC" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-authentication-xac-thuc">
<span class="md-ellipsis">
      6.1. Authentication – Xác thực
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-authorization-phan-quyen">
<span class="md-ellipsis">
      6.2. Authorization – Phân quyền
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-tenant-isolation-tach-biet-tenant">
<span class="md-ellipsis">
      6.3. Tenant Isolation – Tách biệt tenant
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-audit-logging-ghi-log-kiem-toan">
<span class="md-ellipsis">
      6.4. Audit Logging – Ghi log kiểm toán
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#65-data-protection-bao-ve-du-lieu-ca-nhan">
<span class="md-ellipsis">
      6.5. Data Protection – Bảo vệ dữ liệu cá nhân
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#66-cac-bien-phap-phong-ve-bo-sung">
<span class="md-ellipsis">
      6.6. Các biện pháp phòng vệ bổ sung
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-cau-hinh-phu-thuoc">
<span class="md-ellipsis">
      7. ⚙️ Cấu hình &amp; Phụ thuộc
    </span>
</a>
<nav aria-label="7. ⚙️ Cấu hình &amp; Phụ thuộc" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-bien-moi-truong-chinh-env-vars">
<span class="md-ellipsis">
      7.1. Biến môi trường chính (ENV VARS)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-cau-hinh-theo-tenant-dynamic-per-tenant">
<span class="md-ellipsis">
      7.2. Cấu hình theo tenant (Dynamic per-tenant)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-phu-thuoc-he-thong">
<span class="md-ellipsis">
      7.3. Phụ thuộc hệ thống
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-phan-biet-giua-cau-hinh-build-time-va-runtime">
<span class="md-ellipsis">
      7.4. Phân biệt giữa cấu hình "build-time" và "runtime"
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-kiem-thu">
<span class="md-ellipsis">
      8. 🧪 Kiểm thử
    </span>
</a>
<nav aria-label="8. 🧪 Kiểm thử" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-unit-tests">
<span class="md-ellipsis">
      8.1. 🧪 Unit Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-integration-tests">
<span class="md-ellipsis">
      8.2. 🔄 Integration Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-contract-tests-theo-adr-010">
<span class="md-ellipsis">
      8.3. 🤝 Contract Tests (theo ADR-010)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#84-rbac-security-tests">
<span class="md-ellipsis">
      8.4. 🛡️ RBAC &amp; Security Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#85-o-luong-bao-cao">
<span class="md-ellipsis">
      8.5. 📊 Đo lường &amp; Báo cáo
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#86-test-trong-moi-truong-staging">
<span class="md-ellipsis">
      8.6. 🧪 Test trong môi trường staging
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-giam-sat-audit">
<span class="md-ellipsis">
      9. 📈 Giám sát &amp; Audit
    </span>
</a>
<nav aria-label="9. 📈 Giám sát &amp; Audit" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#91-logging-ung-dung-gui-thong-bao">
<span class="md-ellipsis">
      9.1. 🔍 Logging (Ứng dụng &amp; Gửi thông báo)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#92-metrics-prometheus-opentelemetry">
<span class="md-ellipsis">
      9.2. 📊 Metrics (Prometheus / OpenTelemetry)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#93-slo-alerting">
<span class="md-ellipsis">
      9.3. 🎯 SLO &amp; Alerting
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#94-audit-log-tuan-thu-adr-008">
<span class="md-ellipsis">
      9.4. 📁 Audit Log (tuân thủ ADR-008)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#95-tracing-opentelemetry">
<span class="md-ellipsis">
      9.5. 🔁 Tracing (OpenTelemetry)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-trien-khai-migration">
<span class="md-ellipsis">
      10. 🚀 Triển khai &amp; Migration
    </span>
</a>
<nav aria-label="10. 🚀 Triển khai &amp; Migration" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#101-chien-luoc-trien-khai">
<span class="md-ellipsis">
      10.1. 🧭 Chiến lược triển khai
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#102-moi-truong-ranh-gioi-trien-khai-theo-adr-017">
<span class="md-ellipsis">
      10.2. ☁️ Môi trường &amp; ranh giới triển khai (theo ADR-017)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#103-tu-ong-hoa-trien-khai-cicd">
<span class="md-ellipsis">
      10.3. 🚀 Tự động hóa triển khai (CI/CD)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#104-migration-du-lieu-schema-du-lieu">
<span class="md-ellipsis">
      10.4. 📥 Migration dữ liệu (schema &amp; dữ liệu)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#105-rollback-strategy">
<span class="md-ellipsis">
      10.5. ⛑️ Rollback strategy
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#106-checklist-truoc-production">
<span class="md-ellipsis">
      10.6. 📋 Checklist trước production
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-kien-truc-noi-bo">
<span class="md-ellipsis">
      11. 🧩 Kiến trúc nội bộ
    </span>
</a>
<nav aria-label="11. 🧩 Kiến trúc nội bộ" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#111-muc-tieu-phan-lop">
<span class="md-ellipsis">
      11.1. Mục tiêu phân lớp
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#112-so-o-luong-xu-ly-noi-bo">
<span class="md-ellipsis">
      11.2. Sơ đồ luồng xử lý nội bộ
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#113-phan-tich-module-chinh">
<span class="md-ellipsis">
      11.3. Phân tích module chính
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#114-logging-tracing-luong-noi-bo">
<span class="md-ellipsis">
      11.4. Logging &amp; Tracing luồng nội bộ
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#115-kha-nang-mo-rong-plugin">
<span class="md-ellipsis">
      11.5. Khả năng mở rộng &amp; plugin
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-tai-lieu-lien-quan">
<span class="md-ellipsis">
      12. 📚 Tài liệu liên quan
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="thiet-ke-chi-tiet-notification-sub-service">📘 Thiết kế chi tiết Notification Sub Service<a class="headerlink" href="#thiet-ke-chi-tiet-notification-sub-service" title="Permanent link">¶</a></h1>
<h2 id="1-pham-vi-va-trach-nhiem">1. 🧭 Phạm vi và Trách nhiệm<a class="headerlink" href="#1-pham-vi-va-trach-nhiem" title="Permanent link">¶</a></h2>
<h3 id="muc-tieu">🎯 Mục tiêu<a class="headerlink" href="#muc-tieu" title="Permanent link">¶</a></h3>
<ul>
<li>Lắng nghe sự kiện <code>notification.triggered</code> từ Notification Master để gửi thông báo thực tế đến người dùng cuối trong từng tenant.</li>
<li>Quản lý cấu hình kênh gửi của tenant (email, SMS, push), mapping template và xử lý fallback logic.</li>
<li>Ghi nhận log gửi để phục vụ tra soát, thống kê, và audit.</li>
</ul>
<h3 id="cac-thuc-the-du-lieu-quan-ly">📦 Các thực thể dữ liệu quản lý<a class="headerlink" href="#cac-thuc-the-du-lieu-quan-ly" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Thực thể</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NotificationTemplate</code></td>
<td>Template được cấu hình riêng cho từng tenant, mapping theo trigger_event.</td>
</tr>
<tr>
<td><code>NotificationLog</code></td>
<td>Lưu lại lịch sử gửi thông báo, trạng thái gửi, lỗi, thời gian gửi.</td>
</tr>
<tr>
<td><code>NotificationChannelCfg</code></td>
<td>Cấu hình kênh gửi (SMTP, SMS provider...) do tenant quản lý.</td>
</tr>
</tbody>
</table>
<h3 id="ngoai-pham-vi">🔒 Ngoài Phạm Vi<a class="headerlink" href="#ngoai-pham-vi" title="Permanent link">¶</a></h3>
<p>Service này <strong>không</strong> thực hiện:
- ❌ Quản lý trigger business logic tạo ra notification – đã được tách riêng tại Notification Master.
- ❌ Tự generate nội dung hoặc cá nhân hóa sâu (việc đó do master thực hiện).
- ❌ Gửi thông báo vượt quyền tenant (cross-tenant broadcast).
- ❌ Xác thực user – được thực hiện tại Gateway.</p>
<h3 id="oi-tuong-su-dung">👥 Đối tượng sử dụng<a class="headerlink" href="#oi-tuong-su-dung" title="Permanent link">¶</a></h3>
<ul>
<li>Notification Master (qua Pub/Sub – async)</li>
<li>Superadmin Webapp (cho mục đích tra log, kiểm tra trạng thái – nếu cần)</li>
<li>Admin Webapp của tenant (truy cập nội bộ để chỉnh sửa cấu hình kênh)</li>
</ul>
<h2 id="2-thiet-ke-api-chi-tiet">2. 🌐 Thiết kế API chi tiết<a class="headerlink" href="#2-thiet-ke-api-chi-tiet" title="Permanent link">¶</a></h2>
<table>
<thead>
<tr>
<th>Method</th>
<th>Path</th>
<th>Tác vụ</th>
<th>Yêu cầu permission (RBAC)</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/notifications/logs</code></td>
<td>Lấy danh sách log gửi</td>
<td><code>notif.read.log</code></td>
</tr>
<tr>
<td>GET</td>
<td><code>/notifications/templates</code></td>
<td>Lấy danh sách template</td>
<td><code>notif.read.template</code></td>
</tr>
<tr>
<td>POST</td>
<td><code>/notifications/test</code></td>
<td>Gửi thử 1 notification tới người dùng test</td>
<td><code>notif.send.test</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>🔧 Tuân thủ:
- ADR-011: Error Format
- ADR-012: Response Envelope
- ADR-013: Path Naming
- ADR-030: Event Schema Governance (consume: <code>notification.triggered</code>)
- 📎 Chi tiết xem tại: <a href="../interface-contract/">Interface Contract</a> và <a href="../openapi.yaml">OpenAPI Spec</a></p>
</blockquote>
<h2 id="3-mo-hinh-du-lieu-chi-tiet">3. 🗃️ Mô hình dữ liệu chi tiết<a class="headerlink" href="#3-mo-hinh-du-lieu-chi-tiet" title="Permanent link">¶</a></h2>
<pre class="mermaid"><code>erDiagram
  NotificationTemplate ||--o{ NotificationLog : used_by
  NotificationChannelCfg ||--o{ NotificationTemplate : configures

  NotificationTemplate {
    UUID id PK
    STRING event_code
    STRING channel
    TEXT template_body
    JSONB default_params
    BOOLEAN is_active
    TIMESTAMPTZ updated_at
  }

  NotificationLog {
    UUID id PK
    UUID template_id FK
    STRING recipient
    STRING status
    TEXT error_message
    JSONB payload
    TIMESTAMPTZ sent_at
  }

  NotificationChannelCfg {
    STRING channel PK
    STRING provider
    JSONB config
    BOOLEAN is_enabled
    TIMESTAMPTZ updated_at
  }
````

&gt; 📎 Chi tiết xem tại: [Data Model](./data-model.md)

---

### 4. 🔄 Luồng nghiệp vụ chính – Chi tiết hóa

#### 4.1. Mục tiêu

Mỗi lần nhận được sự kiện `notification.triggered`, service phải:

1. Lấy đúng template phù hợp theo `event_code`, `channel`, `tenant_id`
2. Gửi notification qua kênh tương ứng (email, SMS, v.v.)
3. Log đầy đủ hành động gửi – trạng thái, lỗi nếu có, thời gian
4. Có fallback nếu gửi kênh chính thất bại (nếu được cấu hình)
5. Tuân thủ giới hạn (rate-limit, retry theo config nếu có)

---

#### 4.2. Mô tả logic đầy đủ

```mermaid
sequenceDiagram
    participant PubSub as Pub/Sub
    participant NotiSub as Notification Sub
    participant DB as Notification DB
    participant Email as Email/SMS Gateway
    participant Fallback as Fallback Channel

    PubSub--&gt;&gt;NotiSub: Nhận sự kiện `notification.triggered`
    Note right of NotiSub: Extract `tenant_id`, `event_code`, `channel`, `recipient`, `params`

    NotiSub-&gt;&gt;DB: Truy vấn NotificationTemplate (match theo `event_code`, `channel`, `tenant_id`)
    alt Không tìm thấy template
        NotiSub--&gt;&gt;DB: Ghi log lỗi "template not found"
        Note right of NotiSub: Dừng xử lý – không gửi
    else Template hợp lệ
        NotiSub-&gt;&gt;DB: Ghi log trạng thái `queued`, lưu payload
        NotiSub-&gt;&gt;Email: Gửi thông báo (render template + send)
        alt Gửi thành công
            Email--&gt;&gt;NotiSub: OK
            NotiSub-&gt;&gt;DB: Update log → status=`sent`
        else Gửi thất bại
            Email--&gt;&gt;NotiSub: Error
            alt Có fallback được cấu hình
                NotiSub-&gt;&gt;Fallback: Gửi lại qua kênh fallback
                Fallback--&gt;&gt;NotiSub: OK/Error
                NotiSub-&gt;&gt;DB: Update log → status=`sent_fallback` hoặc `failed`
            else Không có fallback
                NotiSub-&gt;&gt;DB: Update log → status=`failed`, lưu lỗi
            end
        end
    end
</code></pre>
<hr/>
<h4 id="43-chi-tiet-cac-buoc">4.3. Chi tiết các bước<a class="headerlink" href="#43-chi-tiet-cac-buoc" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Bước</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>1. Nhận sự kiện</strong></td>
<td>Service lắng nghe từ Pub/Sub <code>notification.triggered.v1</code> với payload có <code>event_code</code>, <code>channel</code>, <code>recipient</code>, <code>params</code>, <code>trace_id</code>, <code>tenant_id</code>.</td>
</tr>
<tr>
<td><strong>2. Tra cứu template</strong></td>
<td>Truy theo <code>event_code</code> + <code>channel</code> + <code>tenant_id</code>. Nếu không có template tương ứng → ghi log lỗi và dừng.</td>
</tr>
<tr>
<td><strong>3. Render &amp; Gửi</strong></td>
<td>Render <code>template_body</code> với <code>params</code> và gửi thực tế qua SMTP/SMS/...</td>
</tr>
<tr>
<td><strong>4. Ghi log gửi</strong></td>
<td>Tạo entry trong bảng <code>NotificationLog</code> trước khi gửi (status: <code>queued</code>), sau đó update thành <code>sent</code>, <code>sent_fallback</code>, hoặc <code>failed</code>.</td>
</tr>
<tr>
<td><strong>5. Xử lý fallback</strong></td>
<td>Nếu kênh gửi thất bại và có cấu hình fallback (VD: từ email → SMS), thực hiện gửi lại qua fallback.</td>
</tr>
<tr>
<td><strong>6. Audit &amp; Tracing</strong></td>
<td>Ghi đầy đủ trace_id và action <code>notification.sent</code> phục vụ audit (<code>adr-008</code>).</td>
</tr>
</tbody>
</table>
<hr/>
<h4 id="44-ghi-chu-luu-y-trien-khai">4.4. Ghi chú &amp; lưu ý triển khai<a class="headerlink" href="#44-ghi-chu-luu-y-trien-khai" title="Permanent link">¶</a></h4>
<ul>
<li><strong>Template Mapping</strong> phải đúng channel – tránh gửi email bằng SMS template hoặc ngược lại.</li>
<li><strong>Bảo vệ chống gửi lặp</strong> nếu Pub/Sub delivery bị trùng → cần xử lý idempotency qua <code>event_id</code>.</li>
<li><strong>Fallback policy</strong> có thể cấu hình ở level <code>NotificationChannelCfg</code>, ví dụ:</li>
</ul>
<p><div class="language-json highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p">{</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"email"</span><span class="p">,</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">"fallback"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"sms"</span><span class="p">],</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">"retry_limit"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="p">}</span>
</span></code></pre></div>
* <strong>Cần validate đầu vào kỹ</strong>: recipient không null, channel được hỗ trợ, params đủ để render template.
* <strong>Không block worker nếu gửi thất bại</strong> – chỉ cần log và tiếp tục.</p>
<hr/>
<h2 id="5-tuong-tac-su-kien">5. 📣 Tương tác &amp; Sự kiện<a class="headerlink" href="#5-tuong-tac-su-kien" title="Permanent link">¶</a></h2>
<h3 id="51-su-kien-nhan-vao-consumed-event">5.1. Sự kiện nhận vào (Consumed Event)<a class="headerlink" href="#51-su-kien-nhan-vao-consumed-event" title="Permanent link">¶</a></h3>
<h4 id="su-kien-notificationtriggeredv1">🔔 Sự kiện: <code>notification.triggered.v1</code><a class="headerlink" href="#su-kien-notificationtriggeredv1" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Thuộc tính</th>
<th>Bắt buộc</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>event_id</code></td>
<td>✅</td>
<td>UUID định danh sự kiện, phục vụ idempotency</td>
</tr>
<tr>
<td><code>tenant_id</code></td>
<td>✅</td>
<td>Tenant gửi thông báo</td>
</tr>
<tr>
<td><code>event_code</code></td>
<td>✅</td>
<td>Mã sự kiện trừu tượng (vd: <code>user.welcome</code>) để tra template</td>
</tr>
<tr>
<td><code>channel</code></td>
<td>✅</td>
<td>Kênh gửi (<code>email</code>, <code>sms</code>, <code>push</code>, etc.)</td>
</tr>
<tr>
<td><code>recipient</code></td>
<td>✅</td>
<td>Địa chỉ nhận (<code>email</code>, <code>phone</code>, <code>device_id</code>,…)</td>
</tr>
<tr>
<td><code>params</code></td>
<td>✅</td>
<td>Tham số động để render nội dung template (JSON)</td>
</tr>
<tr>
<td><code>trigger_by</code></td>
<td>⛔</td>
<td>ID người dùng kích hoạt sự kiện (nếu có)</td>
</tr>
<tr>
<td><code>trace_id</code></td>
<td>✅</td>
<td>Trace để tracking xuyên suốt toàn hệ thống</td>
</tr>
<tr>
<td><code>created_at</code></td>
<td>✅</td>
<td>Thời điểm phát sinh sự kiện (để log thống nhất)</td>
</tr>
</tbody>
</table>
<p>Ví dụ schema (JSON):</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nt">"event_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3a36f1d4-8fa7-4704-a94e-4c55e9142cb3"</span><span class="p">,</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tenant-vas-001"</span><span class="p">,</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">"event_code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user.welcome"</span><span class="p">,</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nt">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"email"</span><span class="p">,</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="nt">"recipient"</span><span class="p">:</span><span class="w"> </span><span class="s2">"student@example.edu.vn"</span><span class="p">,</span>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="nt">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="nt">"full_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Nguyễn Văn A"</span><span class="p">,</span>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="nt">"first_login_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-01T10:00:00Z"</span>
</span><span id="__span-1-10"><a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-1-11"><a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="nt">"trigger_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin_123"</span><span class="p">,</span>
</span><span id="__span-1-12"><a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">  </span><span class="nt">"trace_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"x-trace-abc-789"</span><span class="p">,</span>
</span><span id="__span-1-13"><a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">  </span><span class="nt">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-14T07:32:00Z"</span>
</span><span id="__span-1-14"><a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="p">}</span>
</span></code></pre></div>
<blockquote>
<p>✅ Schema này được quản lý và version hóa theo <code>ADR-030 – Event Schema Governance</code></p>
</blockquote>
<hr/>
<h3 id="52-xu-ly-su-kien">5.2. Xử lý sự kiện<a class="headerlink" href="#52-xu-ly-su-kien" title="Permanent link">¶</a></h3>
<ul>
<li>
<p>Notification Sub Service sẽ <strong>đăng ký lắng nghe</strong> topic tương ứng, ví dụ:</p>
</li>
<li>
<p>GCP Pub/Sub: <code>vas.notification.triggered.v1</code></p>
</li>
<li>Kafka: <code>notification.triggered.v1</code></li>
<li>
<p>Khi nhận event, service thực hiện pipeline:</p>
</li>
<li>
<p>Parse + Validate schema theo version</p>
</li>
<li>Check <code>event_id</code> đã xử lý chưa → để tránh gửi lặp (idempotency)</li>
<li>Render template</li>
<li>Gửi notification</li>
<li>Ghi log + kết quả gửi + <code>trace_id</code> + <code>status</code></li>
</ul>
<hr/>
<h3 id="53-khong-phat-sinh-su-kien-outbound">5.3. Không phát sinh sự kiện outbound<a class="headerlink" href="#53-khong-phat-sinh-su-kien-outbound" title="Permanent link">¶</a></h3>
<p>Notification Sub <strong>không phát event ngược ra ngoài</strong>. Tuy nhiên:</p>
<ul>
<li>Có thể log vào hệ thống Audit Logging (theo <code>adr-008</code>) bằng cách gọi nội bộ tới <code>audit-logging-service</code></li>
<li>Không có luồng đồng bộ đẩy ra Pub/Sub để tránh phát sinh spam hoặc loop</li>
</ul>
<hr/>
<h3 id="54-bien-the-su-kien-kha-nang-mo-rong">5.4. Biến thể sự kiện &amp; khả năng mở rộng<a class="headerlink" href="#54-bien-the-su-kien-kha-nang-mo-rong" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Biến thể</th>
<th>Mô tả</th>
<th>Cách xử lý</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>notification.triggered.v2</code></td>
<td>Phiên bản mới của schema (breaking change)</td>
<td>Service nên dual-consume nếu cần</td>
</tr>
<tr>
<td><code>notification.test.v1</code></td>
<td>Sự kiện gửi thử (từ Admin UI)</td>
<td>Có thể xử lý nội bộ, log riêng</td>
</tr>
<tr>
<td><code>notification.bulk.v1</code></td>
<td>Gửi nhiều người nhận một lúc</td>
<td><strong>Không xử lý</strong> – đã tách thành luồng riêng</td>
</tr>
</tbody>
</table>
<blockquote>
<p>📌 Các biến thể nên được định nghĩa rõ trong <code>event-schemas/registry</code> theo <code>ADR-030</code></p>
</blockquote>
<hr/>
<h3 id="55-chinh-sach-schema-versioning">5.5. Chính sách Schema &amp; Versioning<a class="headerlink" href="#55-chinh-sach-schema-versioning" title="Permanent link">¶</a></h3>
<p>Tuân thủ nghiêm ngặt <code>ADR-030</code>:</p>
<ul>
<li>Không thay đổi field bắt buộc trong version cũ</li>
<li>Nếu cần breaking change → tạo version mới (vd: <code>v2</code>) và dual-publish trong giai đoạn chuyển tiếp</li>
<li>Mỗi sự kiện đều mang <code>event_id</code>, <code>trace_id</code>, <code>version</code>, <code>tenant_id</code></li>
</ul>
<hr/>
<h2 id="6-bao-mat-rbac">6. 🔐 Bảo mật &amp; RBAC<a class="headerlink" href="#6-bao-mat-rbac" title="Permanent link">¶</a></h2>
<h3 id="61-authentication-xac-thuc">6.1. Authentication – Xác thực<a class="headerlink" href="#61-authentication-xac-thuc" title="Permanent link">¶</a></h3>
<ul>
<li><strong>Mọi API của Notification Sub</strong> đều yêu cầu người dùng đã xác thực qua <strong>API Gateway</strong>, dùng JWT chuẩn theo <code>ADR-006</code>.</li>
<li>
<p>Token sẽ được kiểm tra signature và claim gồm:</p>
</li>
<li>
<p><code>sub</code>: user ID</p>
</li>
<li><code>tenant_id</code>: mã tenant đang truy cập</li>
<li><code>permissions</code>: danh sách quyền có dạng <code>notif.read.log</code>, <code>notif.send.test</code>, v.v.</li>
<li><code>exp</code>: thời điểm hết hạn</li>
<li>Token được đính kèm qua header:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>Authorization: Bearer &lt;access_token&gt;
</span></code></pre></div>
<hr/>
<h3 id="62-authorization-phan-quyen">6.2. Authorization – Phân quyền<a class="headerlink" href="#62-authorization-phan-quyen" title="Permanent link">¶</a></h3>
<p>Áp dụng mô hình RBAC <strong>phân tầng theo tenant</strong>, theo chuẩn <code>ADR-007</code>.
Mỗi API đều khai báo permission yêu cầu qua <code>x-required-permission</code>, ví dụ:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nt">x-required-permission</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">notif.read.log</span>
</span></code></pre></div>
<h4 id="quy-tac-phan-quyen">Quy tắc phân quyền:<a class="headerlink" href="#quy-tac-phan-quyen" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Nhóm chức năng</th>
<th>Permission</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td>Xem log gửi</td>
<td><code>notif.read.log</code></td>
<td>Cho phép truy xuất danh sách notification đã gửi</td>
</tr>
<tr>
<td>Xem template</td>
<td><code>notif.read.template</code></td>
<td>Cho phép tra cứu các template hiện có</td>
</tr>
<tr>
<td>Gửi thử</td>
<td><code>notif.send.test</code></td>
<td>Gửi thử email/SMS đến địa chỉ kiểm tra</td>
</tr>
<tr>
<td>Cấu hình channel</td>
<td><code>notif.write.config</code></td>
<td>Sửa thông tin cấu hình kênh gửi của tenant</td>
</tr>
</tbody>
</table>
<blockquote>
<p>✅ Danh sách permission được cấp theo từng <code>user_role</code> gắn với <code>X-Tenant-ID</code></p>
</blockquote>
<hr/>
<h3 id="63-tenant-isolation-tach-biet-tenant">6.3. Tenant Isolation – Tách biệt tenant<a class="headerlink" href="#63-tenant-isolation-tach-biet-tenant" title="Permanent link">¶</a></h3>
<p>Theo yêu cầu của <code>CR-04</code>, mọi hành động (query, mutate, audit) đều phải:</p>
<ul>
<li><strong>Ràng buộc trong phạm vi <code>X-Tenant-ID</code></strong> (đọc từ JWT hoặc header)</li>
<li>Không cho phép truy cập chéo tenant (trừ <code>Superadmin</code>)</li>
<li>Có cấu trúc condition rõ trong OpenAPI:</li>
</ul>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nt">x-condition</span><span class="p">:</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="nt">tenant_id</span><span class="p">:</span><span class="w"> </span><span class="s">"{{X-Tenant-ID}}"</span>
</span></code></pre></div>
<hr/>
<h3 id="64-audit-logging-ghi-log-kiem-toan">6.4. Audit Logging – Ghi log kiểm toán<a class="headerlink" href="#64-audit-logging-ghi-log-kiem-toan" title="Permanent link">¶</a></h3>
<p>Tuân thủ <code>ADR-008</code>, mọi hành động quan trọng sẽ được log lại dưới dạng Audit Event, bao gồm:</p>
<table>
<thead>
<tr>
<th>Hành động</th>
<th>Audit Action</th>
<th>Ghi chú</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gửi một notification</td>
<td><code>notification.sent</code></td>
<td>Bao gồm recipient, template_id, status</td>
</tr>
<tr>
<td>Sửa cấu hình channel gửi</td>
<td><code>notification.config.updated</code></td>
<td>Lưu lại giá trị cũ và mới</td>
</tr>
<tr>
<td>Gửi thử</td>
<td><code>notification.test_sent</code></td>
<td>Lưu lại người gửi thử &amp; kết quả</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Audit log được đẩy async tới <code>audit-logging-service</code> hoặc ghi nội bộ tùy theo cấu hình môi trường</p>
</blockquote>
<hr/>
<h3 id="65-data-protection-bao-ve-du-lieu-ca-nhan">6.5. Data Protection – Bảo vệ dữ liệu cá nhân<a class="headerlink" href="#65-data-protection-bao-ve-du-lieu-ca-nhan" title="Permanent link">¶</a></h3>
<ul>
<li>Không lưu plaintext recipient hoặc payload nếu không cần thiết.</li>
<li>Trường nhạy cảm (<code>recipient</code>, <code>error_message</code>) có thể bị <strong>mask hoặc hash</strong> nếu được cấu hình.</li>
<li>Có thể dùng <code>ADR-024</code> để thiết lập thời gian <strong>anonymization hoặc retention policy</strong> theo từng tenant.</li>
</ul>
<hr/>
<h3 id="66-cac-bien-phap-phong-ve-bo-sung">6.6. Các biện pháp phòng vệ bổ sung<a class="headerlink" href="#66-cac-bien-phap-phong-ve-bo-sung" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Lớp bảo vệ</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td>Input validation</td>
<td>Kiểm tra recipient, template_id, channel có hợp lệ không</td>
</tr>
<tr>
<td>Rate limiting</td>
<td>Do API Gateway quản lý – tránh spam gửi</td>
</tr>
<tr>
<td>Idempotency</td>
<td>Dựa trên <code>event_id</code> để tránh gửi lặp nếu event bị retry</td>
</tr>
<tr>
<td>Fallback isolation</td>
<td>Nếu gửi thất bại và fallback, đảm bảo fallback không rò dữ liệu giữa tenant</td>
</tr>
<tr>
<td>CI/CD static scan</td>
<td>Kiểm tra dependency &amp; config secrets trước khi deploy</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="7-cau-hinh-phu-thuoc">7. ⚙️ Cấu hình &amp; Phụ thuộc<a class="headerlink" href="#7-cau-hinh-phu-thuoc" title="Permanent link">¶</a></h2>
<h3 id="71-bien-moi-truong-chinh-env-vars">7.1. Biến môi trường chính (<code>ENV VARS</code>)<a class="headerlink" href="#71-bien-moi-truong-chinh-env-vars" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Biến</th>
<th>Bắt buộc</th>
<th>Giá trị mẫu</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SERVICE_PORT</code></td>
<td>✅</td>
<td><code>8080</code></td>
<td>Cổng service sẽ mở cho HTTP API nội bộ</td>
</tr>
<tr>
<td><code>DATABASE_URL</code></td>
<td>✅</td>
<td><code>postgres://user:pass@host:5432/notif_sub</code></td>
<td>Kết nối tới CSDL Postgres chứa template/log</td>
</tr>
<tr>
<td><code>PUBSUB_TOPIC</code></td>
<td>✅</td>
<td><code>notification.triggered.v1</code></td>
<td>Tên topic Pub/Sub để subscribe sự kiện</td>
</tr>
<tr>
<td><code>GCP_PROJECT_ID</code></td>
<td>⛔</td>
<td><code>vas-prod-01</code></td>
<td>Dùng nếu chạy trên GCP – định danh project</td>
</tr>
<tr>
<td><code>TENANT_CONFIG_SECRET_PATH</code></td>
<td>✅</td>
<td><code>/secrets/tenant_config/</code></td>
<td>Trỏ tới thư mục chứa config từng tenant (template, fallback, channel)</td>
</tr>
<tr>
<td><code>SMTP_PROVIDER_SECRET</code></td>
<td>⛔</td>
<td><code>secret://smtp-notif</code></td>
<td>Secret chứa config SMTP provider mặc định</td>
</tr>
<tr>
<td><code>JWT_PUBLIC_KEY_PATH</code></td>
<td>✅</td>
<td><code>/etc/keys/jwt.pub</code></td>
<td>File public key để verify JWT</td>
</tr>
<tr>
<td><code>ENVIRONMENT</code></td>
<td>✅</td>
<td><code>production</code> / <code>staging</code> / <code>dev</code></td>
<td>Dùng để phân biệt môi trường khi gửi Audit log, alerting</td>
</tr>
<tr>
<td><code>AUDIT_SERVICE_ENDPOINT</code></td>
<td>⛔</td>
<td><code>http://audit-logging-service</code></td>
<td>Endpoint nội bộ gọi tới Audit Logging nếu bật</td>
</tr>
</tbody>
</table>
<blockquote>
<p>🔐 Secrets như SMTP credentials, access tokens không bao giờ hardcode – được mount từ Secret Manager hoặc Vault (theo <code>ADR-003</code> và <code>ADR-004</code>)</p>
</blockquote>
<hr/>
<h3 id="72-cau-hinh-theo-tenant-dynamic-per-tenant">7.2. Cấu hình theo tenant (Dynamic per-tenant)<a class="headerlink" href="#72-cau-hinh-theo-tenant-dynamic-per-tenant" title="Permanent link">¶</a></h3>
<p>Các tenant có thể có cấu hình khác nhau như:</p>
<table>
<thead>
<tr>
<th>Cấu hình</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td>Template riêng</td>
<td>Cùng một <code>event_code</code>, mỗi tenant có thể định nghĩa nội dung template khác nhau</td>
</tr>
<tr>
<td>Cấu hình kênh gửi</td>
<td>Email: SMTP riêng, SMS: key riêng theo provider</td>
</tr>
<tr>
<td>Fallback policy</td>
<td>Có thể chọn fallback hoặc không, theo logic riêng của tenant</td>
</tr>
<tr>
<td>Ngôn ngữ mặc định</td>
<td>Một số tenant gửi email bằng Tiếng Anh, số khác bằng Tiếng Việt</td>
</tr>
<tr>
<td>Opt-in / Opt-out</td>
<td>Cho phép user từ chối nhận một số loại thông báo (VD: quảng cáo)</td>
</tr>
</tbody>
</table>
<p>Thông tin này được nạp từ <code>TENANT_CONFIG_SECRET_PATH</code> theo mỗi tenant (<code>tenant_id</code>) trong runtime.</p>
<hr/>
<h3 id="73-phu-thuoc-he-thong">7.3. Phụ thuộc hệ thống<a class="headerlink" href="#73-phu-thuoc-he-thong" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Thành phần</th>
<th>Mục tiêu sử dụng</th>
<th>Giao thức</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PostgreSQL</code></td>
<td>Lưu trữ <code>NotificationTemplate</code>, <code>NotificationLog</code>, <code>ChannelCfg</code></td>
<td>SQL</td>
</tr>
<tr>
<td><code>Pub/Sub</code></td>
<td>Nhận sự kiện <code>notification.triggered</code> từ Master</td>
<td>PubSub/Kafka</td>
</tr>
<tr>
<td><code>Email/SMS Provider</code></td>
<td>Gửi email, SMS qua SMTP/HTTP API</td>
<td>SMTP / HTTPS</td>
</tr>
<tr>
<td><code>audit-logging-service</code></td>
<td>Ghi log hành vi gửi (nếu bật)</td>
<td>HTTP nội bộ</td>
</tr>
<tr>
<td><code>vault / secret-manager</code></td>
<td>Lưu config gửi riêng của tenant</td>
<td>Nạp khi runtime</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="74-phan-biet-giua-cau-hinh-build-time-va-runtime">7.4. Phân biệt giữa cấu hình "build-time" và "runtime"<a class="headerlink" href="#74-phan-biet-giua-cau-hinh-build-time-va-runtime" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Loại cấu hình</th>
<th>Ví dụ</th>
<th>Ghi chú</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Build-time</strong></td>
<td><code>ENVIRONMENT</code>, <code>SERVICE_PORT</code>, <code>GCP_PROJECT_ID</code></td>
<td>Dùng trong CI/CD, xác định behavior</td>
</tr>
<tr>
<td><strong>Runtime</strong></td>
<td><code>tenant_id</code>, <code>SMTP_PROVIDER_SECRET</code>, <code>ChannelCfg</code></td>
<td>Nạp động tùy tenant hoặc request</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="8-kiem-thu">8. 🧪 Kiểm thử<a class="headerlink" href="#8-kiem-thu" title="Permanent link">¶</a></h2>
<p>Việc kiểm thử <code>notification-service/sub/</code> được chia thành 4 lớp chính: <strong>Unit</strong>, <strong>Integration</strong>, <strong>Contract</strong>, và <strong>Security &amp; RBAC</strong>.
Tất cả các test đều cần <strong>tự động hóa</strong> và được tích hợp vào CI pipeline qua GitHub Actions (<code>adr-001</code>).</p>
<hr/>
<h3 id="81-unit-tests">8.1. 🧪 Unit Tests<a class="headerlink" href="#81-unit-tests" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Mục tiêu</th>
<th>Nội dung kiểm thử</th>
</tr>
</thead>
<tbody>
<tr>
<td>Xử lý sự kiện</td>
<td>Kiểm tra các nhánh xử lý khi nhận event: tìm thấy template, không tìm thấy, gửi thành công, gửi thất bại</td>
</tr>
<tr>
<td>Gửi thông báo</td>
<td>Mock SMTP/SMS provider để kiểm tra logic gửi</td>
</tr>
<tr>
<td>Template rendering</td>
<td>Xác minh <code>params</code> render đúng template hoặc lỗi rõ ràng khi thiếu biến</td>
</tr>
<tr>
<td>Fallback logic</td>
<td>Kiểm tra khi channel chính lỗi, service fallback đúng channel phụ</td>
</tr>
<tr>
<td>Logging logic</td>
<td>Log đúng trạng thái: <code>queued</code>, <code>sent</code>, <code>sent_fallback</code>, <code>failed</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>✅ Tỷ lệ coverage bắt buộc &gt; 80% (code coverage report tích hợp CI/CD)</p>
</blockquote>
<hr/>
<h3 id="82-integration-tests">8.2. 🔄 Integration Tests<a class="headerlink" href="#82-integration-tests" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Tầng tích hợp</th>
<th>Nội dung kiểm thử</th>
</tr>
</thead>
<tbody>
<tr>
<td>Với DB</td>
<td>Insert + query các bản ghi <code>NotificationLog</code>, <code>Template</code>, <code>ChannelCfg</code></td>
</tr>
<tr>
<td>Với Pub/Sub</td>
<td>Gửi giả lập sự kiện <code>notification.triggered.v1</code> và xác minh hành vi end-to-end</td>
</tr>
<tr>
<td>Với SMTP/SMS giả lập</td>
<td>Dùng fake server để test luồng gửi thật (smtp4dev, httpbin)</td>
</tr>
<tr>
<td>Với Audit Service</td>
<td>Kiểm tra audit log gửi đi đúng định dạng, đúng action</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="83-contract-tests-theo-adr-010">8.3. 🤝 Contract Tests (theo ADR-010)<a class="headerlink" href="#83-contract-tests-theo-adr-010" title="Permanent link">¶</a></h3>
<p>Tuân thủ kiểm thử giao diện (OpenAPI contract):</p>
<table>
<thead>
<tr>
<th>API</th>
<th>Kiểm thử</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET <code>/notifications/logs</code></td>
<td>Trả đúng định dạng <code>Envelope</code>, pagination</td>
</tr>
<tr>
<td>POST <code>/notifications/test</code></td>
<td>Gửi thử thành công và lỗi</td>
</tr>
<tr>
<td>GET <code>/notifications/templates</code></td>
<td>Trả danh sách template theo tenant</td>
</tr>
</tbody>
</table>
<p>Sử dụng:</p>
<ul>
<li><a href="https://github.com/stoplightio/prism">Prism</a> hoặc <a href="https://dredd.org">Dredd</a> để test OpenAPI spec</li>
<li>CI sẽ <strong>fail nếu sai contract</strong> (ví dụ đổi schema không báo trước)</li>
</ul>
<hr/>
<h3 id="84-rbac-security-tests">8.4. 🛡️ RBAC &amp; Security Tests<a class="headerlink" href="#84-rbac-security-tests" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Tình huống</th>
<th>Kiểm thử</th>
</tr>
</thead>
<tbody>
<tr>
<td>Không có token</td>
<td>Bị từ chối truy cập (<code>401</code>)</td>
</tr>
<tr>
<td>Token sai tenant</td>
<td>Không nhìn thấy dữ liệu tenant khác (<code>403</code>)</td>
</tr>
<tr>
<td>Thiếu permission</td>
<td>Trả lỗi <code>403</code>, có <code>error_code: permission_denied</code></td>
</tr>
<tr>
<td>Có đủ quyền</td>
<td>Truy cập được API tương ứng</td>
</tr>
<tr>
<td>JWT expired</td>
<td>Trả lỗi <code>401</code> rõ ràng</td>
</tr>
<tr>
<td>JWT không đúng định dạng</td>
<td>Trả <code>400</code> với mã lỗi <code>invalid_token</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>✅ Kết quả test phải khớp với <code>error-codes.md</code> theo <code>ADR-011</code></p>
</blockquote>
<hr/>
<h3 id="85-o-luong-bao-cao">8.5. 📊 Đo lường &amp; Báo cáo<a class="headerlink" href="#85-o-luong-bao-cao" title="Permanent link">¶</a></h3>
<ul>
<li>Báo cáo test coverage (<code>pytest-cov</code>, <code>jest</code>,...) gửi về CI/CD dashboard</li>
<li>
<p>Ghi rõ:</p>
</li>
<li>
<p>% coverage theo service/module</p>
</li>
<li>Tên test bị fail và lý do</li>
<li>Tự động chạy lại test nếu xảy ra race condition do message queue</li>
</ul>
<hr/>
<h3 id="86-test-trong-moi-truong-staging">8.6. 🧪 Test trong môi trường staging<a class="headerlink" href="#86-test-trong-moi-truong-staging" title="Permanent link">¶</a></h3>
<p>Mỗi release trước khi đưa lên production sẽ được kiểm tra trong staging với:</p>
<table>
<thead>
<tr>
<th>Môi trường</th>
<th>Mục tiêu</th>
</tr>
</thead>
<tbody>
<tr>
<td>DB độc lập</td>
<td>Không ảnh hưởng prod</td>
</tr>
<tr>
<td>Pub/Sub topic riêng</td>
<td>Tránh tiêu thụ nhầm message thật</td>
</tr>
<tr>
<td>SMTP test gateway</td>
<td>Không gửi thật, có log kiểm chứng</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="9-giam-sat-audit">9. 📈 Giám sát &amp; Audit<a class="headerlink" href="#9-giam-sat-audit" title="Permanent link">¶</a></h2>
<h3 id="91-logging-ung-dung-gui-thong-bao">9.1. 🔍 Logging (Ứng dụng &amp; Gửi thông báo)<a class="headerlink" href="#91-logging-ung-dung-gui-thong-bao" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Mục tiêu</th>
<th>Chi tiết</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mức log</td>
<td>Dùng các mức <code>info</code>, <code>warn</code>, <code>error</code>, <code>debug</code> đúng chuẩn</td>
</tr>
<tr>
<td>Tenant tagging</td>
<td>Mỗi log đều phải đính kèm <code>tenant_id</code>, <code>trace_id</code>, <code>event_id</code> nếu có</td>
</tr>
<tr>
<td>Nhân sự kiện</td>
<td>Log rõ event nhận được, template áp dụng, hành vi gửi</td>
</tr>
<tr>
<td>Thất bại</td>
<td>Log lý do lỗi gửi (<code>SMTP timeout</code>, <code>invalid recipient</code>, v.v.)</td>
</tr>
<tr>
<td>Fallback</td>
<td>Ghi nhận nếu gửi qua fallback channel</td>
</tr>
<tr>
<td>Log định dạng</td>
<td>JSON log structure, tuân chuẩn <code>12-factor app</code> để dễ gửi sang ELK/Grafana/Loki</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="92-metrics-prometheus-opentelemetry">9.2. 📊 Metrics (Prometheus / OpenTelemetry)<a class="headerlink" href="#92-metrics-prometheus-opentelemetry" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Kiểu</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>notif_event_received_total</code></td>
<td>Counter</td>
<td>Tổng số event <code>notification.triggered</code> đã nhận</td>
</tr>
<tr>
<td><code>notif_sent_success_total</code></td>
<td>Counter</td>
<td>Số lượng gửi thành công qua channel chính</td>
</tr>
<tr>
<td><code>notif_sent_failed_total</code></td>
<td>Counter</td>
<td>Số lượng gửi thất bại hoàn toàn</td>
</tr>
<tr>
<td><code>notif_sent_fallback_total</code></td>
<td>Counter</td>
<td>Số lượng gửi qua fallback</td>
</tr>
<tr>
<td><code>notif_delivery_duration_ms</code></td>
<td>Histogram</td>
<td>Thời gian từ lúc nhận event đến khi gửi xong</td>
</tr>
<tr>
<td><code>notif_queue_size</code></td>
<td>Gauge</td>
<td>Số lượng event đang chờ xử lý trong hàng đợi nội bộ (nếu dùng buffer)</td>
</tr>
<tr>
<td><code>notif_db_latency_ms</code></td>
<td>Histogram</td>
<td>Latency khi truy cập CSDL</td>
</tr>
<tr>
<td><code>notif_config_load_errors_total</code></td>
<td>Counter</td>
<td>Số lỗi nạp config channel/template không hợp lệ</td>
</tr>
</tbody>
</table>
<blockquote>
<p>✅ Tất cả metric đều được <strong>gắn nhãn (<code>labels</code>)</strong> gồm <code>tenant_id</code>, <code>channel</code>, <code>status</code>, <code>template_id</code> nếu có.</p>
</blockquote>
<hr/>
<h3 id="93-slo-alerting">9.3. 🎯 SLO &amp; Alerting<a class="headerlink" href="#93-slo-alerting" title="Permanent link">¶</a></h3>
<p>Tuân thủ <code>ADR-022</code> – thiết lập SLO cho service:</p>
<table>
<thead>
<tr>
<th>Mục tiêu</th>
<th>SLO</th>
<th>Alert khi</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tỷ lệ gửi thành công</td>
<td>≥ 99%</td>
<td>Trong 5 phút, tỉ lệ thất bại &gt; 5%</td>
</tr>
<tr>
<td>Độ trễ xử lý</td>
<td>&lt; 2s</td>
<td>Độ trễ gửi &gt; 5s với &gt;10% notification</td>
</tr>
<tr>
<td>Lỗi template</td>
<td>0</td>
<td>Có bất kỳ lỗi render hoặc thiếu template</td>
</tr>
<tr>
<td>Không có log</td>
<td>&lt; 1 min</td>
<td>Không có event mới được nhận trong ≥ 5 phút (prod)</td>
</tr>
</tbody>
</table>
<blockquote>
<p>✅ Alert được gửi về Email/Slack qua Alertmanager hoặc Grafana OnCall.</p>
</blockquote>
<hr/>
<h3 id="94-audit-log-tuan-thu-adr-008">9.4. 📁 Audit Log (tuân thủ ADR-008)<a class="headerlink" href="#94-audit-log-tuan-thu-adr-008" title="Permanent link">¶</a></h3>
<p>Các hành vi cần audit:</p>
<table>
<thead>
<tr>
<th>Hành vi</th>
<th><code>x-audit-action</code></th>
<th>Nội dung cần log</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gửi notification</td>
<td><code>notification.sent</code></td>
<td>event_id, channel, status, template_id, recipient (masked), actor</td>
</tr>
<tr>
<td>Gửi thử</td>
<td><code>notification.test_sent</code></td>
<td>test_target, actor</td>
</tr>
<tr>
<td>Cập nhật channel</td>
<td><code>notification.config.updated</code></td>
<td>diff config, actor, time</td>
</tr>
<tr>
<td>Cập nhật template</td>
<td><code>notification.template.updated</code></td>
<td>diff content, actor, trace_id</td>
</tr>
</tbody>
</table>
<ul>
<li>Audit log được đẩy async tới <code>audit-logging-service</code> qua HTTP nội bộ.</li>
<li>Log phải chứa: <code>actor_id</code>, <code>tenant_id</code>, <code>trace_id</code>, <code>action</code>, <code>timestamp</code>, <code>details</code>.</li>
</ul>
<hr/>
<h3 id="95-tracing-opentelemetry">9.5. 🔁 Tracing (OpenTelemetry)<a class="headerlink" href="#95-tracing-opentelemetry" title="Permanent link">¶</a></h3>
<p>Tích hợp <strong>OpenTelemetry</strong> để trace xuyên suốt hành trình notification:</p>
<table>
<thead>
<tr>
<th>Trace span</th>
<th>Ghi nhận</th>
</tr>
</thead>
<tbody>
<tr>
<td>Nhận event</td>
<td>timestamp nhận, message size</td>
</tr>
<tr>
<td>Tìm template</td>
<td>lookup time, cache hit/miss</td>
</tr>
<tr>
<td>Gửi email/SMS</td>
<td>duration, result</td>
</tr>
<tr>
<td>Log cập nhật</td>
<td>DB write status</td>
</tr>
</tbody>
</table>
<p>Tất cả trace được gắn với <code>trace_id</code> gốc từ sự kiện.
Dữ liệu gửi về <code>OTEL Collector</code> → <code>Grafana Tempo</code> hoặc <code>Jaeger</code>.</p>
<hr/>
<h2 id="10-trien-khai-migration">10. 🚀 Triển khai &amp; Migration<a class="headerlink" href="#10-trien-khai-migration" title="Permanent link">¶</a></h2>
<h3 id="101-chien-luoc-trien-khai">10.1. 🧭 Chiến lược triển khai<a class="headerlink" href="#101-chien-luoc-trien-khai" title="Permanent link">¶</a></h3>
<p>Việc triển khai <code>notification-service/sub/</code> được thiết kế để <strong>đảm bảo Zero Downtime</strong> theo <code>ADR-014</code> với các đặc điểm:</p>
<table>
<thead>
<tr>
<th>Yếu tố</th>
<th>Chi tiết</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mô hình deploy</td>
<td>Container-based (Docker)</td>
</tr>
<tr>
<td>Phân phối</td>
<td>Triển khai theo tenant hoặc cụm tenant, có thể dùng K8s namespace tách biệt</td>
</tr>
<tr>
<td>Quản lý phiên bản</td>
<td>Image versioning theo tag <code>vas-notif-sub:v1.x.x</code></td>
</tr>
<tr>
<td>Triển khai xanh/xám</td>
<td>Hỗ trợ blue-green và rolling update</td>
</tr>
<tr>
<td>Healthcheck</td>
<td>Tuân theo <code>/healthz</code>, <code>/readyz</code> cho liveness và readiness probe</td>
</tr>
<tr>
<td>Quản lý bí mật</td>
<td>Inject qua secret manager hoặc volume mount (<code>ADR-003</code>)</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="102-moi-truong-ranh-gioi-trien-khai-theo-adr-017">10.2. ☁️ Môi trường &amp; ranh giới triển khai (theo ADR-017)<a class="headerlink" href="#102-moi-truong-ranh-gioi-trien-khai-theo-adr-017" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Môi trường</th>
<th>Mục đích</th>
<th>Ranh giới</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dev</code></td>
<td>Phát triển</td>
<td>Có thể chia sẻ DB + PubSub với team khác</td>
</tr>
<tr>
<td><code>staging</code></td>
<td>Tiền sản xuất</td>
<td>Mỗi tenant chạy instance độc lập</td>
</tr>
<tr>
<td><code>prod</code></td>
<td>Vận hành thật</td>
<td>Mỗi tenant production có cluster riêng (hoặc namespace riêng)</td>
</tr>
</tbody>
</table>
<blockquote>
<p>🔐 Cấu hình <code>ENVIRONMENT</code> sẽ ảnh hưởng đến behavior gửi thật hay giả (ví dụ: <code>smtp-sandbox</code> trong dev)</p>
</blockquote>
<hr/>
<h3 id="103-tu-ong-hoa-trien-khai-cicd">10.3. 🚀 Tự động hóa triển khai (CI/CD)<a class="headerlink" href="#103-tu-ong-hoa-trien-khai-cicd" title="Permanent link">¶</a></h3>
<p>Tuân thủ <code>ADR-001</code>:</p>
<table>
<thead>
<tr>
<th>Bước</th>
<th>Công cụ</th>
</tr>
</thead>
<tbody>
<tr>
<td>Build Docker image</td>
<td><code>Dockerfile</code> chuẩn hóa</td>
</tr>
<tr>
<td>Push lên registry</td>
<td>GitHub Actions / GitLab CI</td>
</tr>
<tr>
<td>Deploy staging</td>
<td>Helm / ArgoCD</td>
</tr>
<tr>
<td>Run post-deploy tests</td>
<td><code>pytest</code> hoặc <code>dredd</code> (contract test)</td>
</tr>
<tr>
<td>Notify kết quả</td>
<td>Slack webhook / GitHub Status</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="104-migration-du-lieu-schema-du-lieu">10.4. 📥 Migration dữ liệu (schema &amp; dữ liệu)<a class="headerlink" href="#104-migration-du-lieu-schema-du-lieu" title="Permanent link">¶</a></h3>
<p>Tuân thủ <code>ADR-023 – Schema Migration Strategy</code></p>
<table>
<thead>
<tr>
<th>Bảng ảnh hưởng</th>
<th>Chi tiết</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NotificationTemplate</code></td>
<td>Dữ liệu mặc định cho từng <code>event_code</code> có thể seed khi khởi tạo tenant</td>
</tr>
<tr>
<td><code>NotificationLog</code></td>
<td>Không migration, tạo mới từng dòng</td>
</tr>
<tr>
<td><code>NotificationChannelCfg</code></td>
<td>Tùy tenant, có thể import từ file cấu hình YAML hoặc JSON</td>
</tr>
</tbody>
</table>
<h4 id="cong-cu-goi-y">Công cụ gợi ý<a class="headerlink" href="#cong-cu-goi-y" title="Permanent link">¶</a></h4>
<ul>
<li>Quản lý migration: <code>Alembic</code> hoặc <code>Sqlx</code> (nếu dùng Python / Go)</li>
<li>Kiểm tra forward/backward compatibility: <code>schemachange</code> hoặc <code>sqldiff</code></li>
</ul>
<hr/>
<h3 id="105-rollback-strategy">10.5. ⛑️ Rollback strategy<a class="headerlink" href="#105-rollback-strategy" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Trường hợp lỗi</th>
<th>Hành động rollback</th>
</tr>
</thead>
<tbody>
<tr>
<td>Service fail khởi động</td>
<td>Rollback image về phiên bản cũ</td>
</tr>
<tr>
<td>DB migration gây lỗi</td>
<td>Rollback bằng <code>downgrade</code> script</td>
</tr>
<tr>
<td>Audit log mất kết nối</td>
<td>Chuyển sang log file tạm thời (buffered log)</td>
</tr>
<tr>
<td>SMTP lỗi toàn cục</td>
<td>Bật chế độ <code>dry-run</code> tạm thời để không mất log</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="106-checklist-truoc-production">10.6. 📋 Checklist trước production<a class="headerlink" href="#106-checklist-truoc-production" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Mục</th>
<th>Xác nhận</th>
</tr>
</thead>
<tbody>
<tr>
<td>[ ] Đã kiểm tra healthcheck hoạt động</td>
<td>✅</td>
</tr>
<tr>
<td>[ ] Metrics có hiển thị trên Grafana</td>
<td>✅</td>
</tr>
<tr>
<td>[ ] Log gửi đúng audit format</td>
<td>✅</td>
</tr>
<tr>
<td>[ ] Tenant có config riêng đầy đủ</td>
<td>✅</td>
</tr>
<tr>
<td>[ ] Thử rollback không mất dữ liệu</td>
<td>✅</td>
</tr>
<tr>
<td>[ ] Alert hoạt động đúng</td>
<td>✅</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="11-kien-truc-noi-bo">11. 🧩 Kiến trúc nội bộ<a class="headerlink" href="#11-kien-truc-noi-bo" title="Permanent link">¶</a></h2>
<h3 id="111-muc-tieu-phan-lop">11.1. Mục tiêu phân lớp<a class="headerlink" href="#111-muc-tieu-phan-lop" title="Permanent link">¶</a></h3>
<p>Hệ thống được thiết kế theo hướng <strong>module hóa rõ ràng</strong>, tách biệt theo chức năng để dễ dàng mở rộng, kiểm thử và bảo trì.</p>
<table>
<thead>
<tr>
<th>Lớp</th>
<th>Trách nhiệm</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>consumer</code></td>
<td>Lắng nghe và xử lý sự kiện từ Pub/Sub hoặc message queue</td>
</tr>
<tr>
<td><code>processor</code></td>
<td>Thực thi nghiệp vụ gửi thông báo: tra template, render, gửi, fallback</td>
</tr>
<tr>
<td><code>notifier</code></td>
<td>Adapter gửi thông báo thực tế (SMTP, SMS, Push...)</td>
</tr>
<tr>
<td><code>repository</code></td>
<td>Truy xuất &amp; ghi dữ liệu từ/đến Postgres</td>
</tr>
<tr>
<td><code>config</code></td>
<td>Tải &amp; cache cấu hình riêng cho từng tenant</td>
</tr>
<tr>
<td><code>audit</code></td>
<td>Gửi log kiểm toán (nếu được bật)</td>
</tr>
<tr>
<td><code>api</code></td>
<td>Cung cấp API nội bộ cho việc kiểm tra, gửi thử, quản trị template</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="112-so-o-luong-xu-ly-noi-bo">11.2. Sơ đồ luồng xử lý nội bộ<a class="headerlink" href="#112-so-o-luong-xu-ly-noi-bo" title="Permanent link">¶</a></h3>
<pre class="mermaid"><code>flowchart TD
    PubSub[Event Listener]
    PubSub --&gt; Parser[Parse + Validate Event]
    Parser --&gt; TemplateLookup[Lookup Template]
    TemplateLookup --&gt; RenderEngine[Render Template]
    RenderEngine --&gt; Notifier[Send Notification]
    Notifier --&gt; Audit[Log Audit]
    Notifier --&gt; LogWriter[Ghi NotificationLog]

    subgraph Modules
      TemplateLookup
      RenderEngine
      Notifier
      Audit
      LogWriter
    end
</code></pre>
<hr/>
<h3 id="113-phan-tich-module-chinh">11.3. Phân tích module chính<a class="headerlink" href="#113-phan-tich-module-chinh" title="Permanent link">¶</a></h3>
<h4 id="consumer">🧩 <code>consumer/</code><a class="headerlink" href="#consumer" title="Permanent link">¶</a></h4>
<ul>
<li>Nhận sự kiện từ Pub/Sub</li>
<li>Parse &amp; validate schema (tuân theo <code>ADR-030</code>)</li>
<li>Bắt đầu trace (<code>trace_id</code>)</li>
<li>Gửi vào <code>processor</code></li>
</ul>
<h4 id="processor">🧩 <code>processor/</code><a class="headerlink" href="#processor" title="Permanent link">¶</a></h4>
<ul>
<li>Truy cập <code>tenant_id</code> để load cấu hình (<code>config/</code>)</li>
<li>Gọi <code>template_repository</code> để tìm template khớp <code>event_code</code> + <code>channel</code></li>
<li>Render nội dung</li>
<li>Gọi <code>notifier/</code> để gửi đi</li>
<li>Ghi log + fallback nếu thất bại</li>
<li>Gửi log audit nếu bật</li>
</ul>
<h4 id="notifier">🧩 <code>notifier/</code><a class="headerlink" href="#notifier" title="Permanent link">¶</a></h4>
<ul>
<li>
<p>Có các adapter theo kênh:</p>
</li>
<li>
<p><code>notifier/email.py</code></p>
</li>
<li><code>notifier/sms.py</code></li>
<li><code>notifier/push.py</code> <em>(chưa triển khai)</em></li>
<li>Giao diện thống nhất: <code>send(recipient, content, config)</code></li>
</ul>
<h4 id="repository">🧩 <code>repository/</code><a class="headerlink" href="#repository" title="Permanent link">¶</a></h4>
<ul>
<li>Truy cập Postgres: bảng <code>NotificationLog</code>, <code>Template</code>, <code>ChannelCfg</code></li>
<li>Được mock dễ dàng trong test</li>
</ul>
<h4 id="config">🧩 <code>config/</code><a class="headerlink" href="#config" title="Permanent link">¶</a></h4>
<ul>
<li>Load cấu hình theo <code>tenant_id</code> từ Secret Manager / mount path</li>
<li>Có cơ chế cache nội bộ (TTL: 5 phút)</li>
<li>Tự invalid cache khi có sự kiện <code>config.updated</code></li>
</ul>
<h4 id="audit">🧩 <code>audit/</code><a class="headerlink" href="#audit" title="Permanent link">¶</a></h4>
<ul>
<li>Tạo cấu trúc audit log (tuân theo <code>ADR-008</code>)</li>
<li>Gửi async sang <code>audit-logging-service</code></li>
</ul>
<h4 id="api">🧩 <code>api/</code><a class="headerlink" href="#api" title="Permanent link">¶</a></h4>
<ul>
<li>
<p>Expose REST API nội bộ:</p>
</li>
<li>
<p><code>GET /notifications/logs</code></p>
</li>
<li><code>POST /notifications/test</code></li>
<li><code>GET /notifications/templates</code></li>
</ul>
<hr/>
<h3 id="114-logging-tracing-luong-noi-bo">11.4. Logging &amp; Tracing luồng nội bộ<a class="headerlink" href="#114-logging-tracing-luong-noi-bo" title="Permanent link">¶</a></h3>
<ul>
<li>Mỗi bước trong luồng xử lý đều tạo 1 span nếu dùng OpenTelemetry</li>
<li>
<p>Toàn bộ log theo chuẩn JSON và đính kèm:</p>
</li>
<li>
<p><code>tenant_id</code></p>
</li>
<li><code>event_id</code></li>
<li><code>trace_id</code></li>
<li><code>template_id</code></li>
<li><code>channel</code></li>
</ul>
<hr/>
<h3 id="115-kha-nang-mo-rong-plugin">11.5. Khả năng mở rộng &amp; plugin<a class="headerlink" href="#115-kha-nang-mo-rong-plugin" title="Permanent link">¶</a></h3>
<p>Hệ thống có thể dễ dàng mở rộng thêm kênh gửi mới:</p>
<table>
<thead>
<tr>
<th>Kênh mới</th>
<th>Cách mở rộng</th>
</tr>
</thead>
<tbody>
<tr>
<td>Zalo</td>
<td>Thêm <code>notifier/zalo.py</code> với hàm <code>send(...)</code></td>
</tr>
<tr>
<td>App Notification</td>
<td>Tích hợp Firebase, dùng chung pipeline</td>
</tr>
<tr>
<td>Tương tác voice</td>
<td>Kết nối Twilio hoặc WebRTC SDK</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="12-tai-lieu-lien-quan">12. 📚 Tài liệu liên quan<a class="headerlink" href="#12-tai-lieu-lien-quan" title="Permanent link">¶</a></h2>
<ul>
<li><a href="../interface-contract/">Interface Contract</a></li>
<li><a href="../data-model/">Data Model</a></li>
<li><a href="../openapi.yaml">OpenAPI Spec</a></li>
<li><a href="../../../../ADR/adr-007-rbac/">ADR-007 – RBAC Strategy</a></li>
<li><a href="../../../../ADR/adr-008-audit-logging/">ADR-008 – Audit Logging</a></li>
<li><a href="../../../../ADR/adr-030-event-schema-governance/">ADR-030 – Event Schema Governance</a></li>
<li><a href="../../../requests/04-cr-tenant-system.md">Change Request 04 – Tenant Isolation</a></li>
<li><a href="../../../../">README.md – System Overview</a></li>
<li><a href="../../../../architecture/rbac-deep-dive/">RBAC Deep Dive</a></li>
<li><a href="../../../../architecture/system-diagrams/">System Diagram</a></li>
</ul>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Trở lại mục lục
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>