
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="TÃ i liá»‡u kiáº¿n trÃºc vÃ  phÃ¡t triá»ƒn cho dá»± Ã¡n Chuyá»ƒn Ä‘á»•i sá»‘ TrÆ°á»ng Viá»‡t Anh." name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://ezdesign-vn.github.io/dx-vas/services/notification-service/sub/design/" rel="canonical"/>
<link href="../../../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Thiáº¿t káº¿ chi tiáº¿t Notification Sub Service - DX VAS - Docs</title>
<link href="../../../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#thiet-ke-chi-tiet-notification-sub-service">
          Bá» qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Äáº§u trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Thiáº¿t káº¿ chi tiáº¿t Notification Sub Service
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="TÃ¬m kiáº¿m" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="TÃ¬m kiáº¿m" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="TÃ¬m kiáº¿m" class="md-search__options">
<button aria-label="XoÃ¡" class="md-search__icon md-icon" tabindex="-1" title="XoÃ¡" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../architecture/system-diagrams/">
          
  
  
    
  
  Kiáº¿n trÃºc Há»‡ thá»‘ng

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../dev-guide/">
        
  
  
    
  
  HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../">
        
  
  
    
  
  Thiáº¿t káº¿ Services

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../ADR/">
          
  
  
    
  
  Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh Ä‘iá»u hÆ°á»›ng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Kiáº¿n trÃºc Há»‡ thá»‘ng
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Kiáº¿n trÃºc Há»‡ thá»‘ng
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../architecture/system-diagrams/">
<span class="md-ellipsis">
    SÆ¡ Ä‘á»“ Há»‡ thá»‘ng
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../architecture/rbac-deep-dive/">
<span class="md-ellipsis">
    RBAC Chi tiáº¿t
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../dev-guide/">
<span class="md-ellipsis">
    HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../">
<span class="md-ellipsis">
    Thiáº¿t káº¿ Services
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../../ADR/">
<span class="md-ellipsis">
    Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Má»¥c lá»¥c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Má»¥c lá»¥c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-pham-vi-va-trach-nhiem">
<span class="md-ellipsis">
      1. ğŸ§­ Pháº¡m vi vÃ  TrÃ¡ch nhiá»‡m
    </span>
</a>
<nav aria-label="1. ğŸ§­ Pháº¡m vi vÃ  TrÃ¡ch nhiá»‡m" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#muc-tieu">
<span class="md-ellipsis">
      ğŸ¯ Má»¥c tiÃªu
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cac-thuc-the-du-lieu-quan-ly">
<span class="md-ellipsis">
      ğŸ“¦ CÃ¡c thá»±c thá»ƒ dá»¯ liá»‡u quáº£n lÃ½
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ngoai-pham-vi">
<span class="md-ellipsis">
      ğŸ”’ NgoÃ i Pháº¡m Vi
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#oi-tuong-su-dung">
<span class="md-ellipsis">
      ğŸ‘¥ Äá»‘i tÆ°á»£ng sá»­ dá»¥ng
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-thiet-ke-api-chi-tiet">
<span class="md-ellipsis">
      2. ğŸŒ Thiáº¿t káº¿ API chi tiáº¿t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-mo-hinh-du-lieu-chi-tiet">
<span class="md-ellipsis">
      3. ğŸ—ƒï¸ MÃ´ hÃ¬nh dá»¯ liá»‡u chi tiáº¿t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-tuong-tac-su-kien">
<span class="md-ellipsis">
      5. ğŸ“£ TÆ°Æ¡ng tÃ¡c &amp; Sá»± kiá»‡n
    </span>
</a>
<nav aria-label="5. ğŸ“£ TÆ°Æ¡ng tÃ¡c &amp; Sá»± kiá»‡n" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-su-kien-nhan-vao-consumed-event">
<span class="md-ellipsis">
      5.1. Sá»± kiá»‡n nháº­n vÃ o (Consumed Event)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-xu-ly-su-kien">
<span class="md-ellipsis">
      5.2. Xá»­ lÃ½ sá»± kiá»‡n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-khong-phat-sinh-su-kien-outbound">
<span class="md-ellipsis">
      5.3. KhÃ´ng phÃ¡t sinh sá»± kiá»‡n outbound
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#54-bien-the-su-kien-kha-nang-mo-rong">
<span class="md-ellipsis">
      5.4. Biáº¿n thá»ƒ sá»± kiá»‡n &amp; kháº£ nÄƒng má»Ÿ rá»™ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#55-chinh-sach-schema-versioning">
<span class="md-ellipsis">
      5.5. ChÃ­nh sÃ¡ch Schema &amp; Versioning
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-bao-mat-rbac">
<span class="md-ellipsis">
      6. ğŸ” Báº£o máº­t &amp; RBAC
    </span>
</a>
<nav aria-label="6. ğŸ” Báº£o máº­t &amp; RBAC" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-authentication-xac-thuc">
<span class="md-ellipsis">
      6.1. Authentication â€“ XÃ¡c thá»±c
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-authorization-phan-quyen">
<span class="md-ellipsis">
      6.2. Authorization â€“ PhÃ¢n quyá»n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-tenant-isolation-tach-biet-tenant">
<span class="md-ellipsis">
      6.3. Tenant Isolation â€“ TÃ¡ch biá»‡t tenant
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-audit-logging-ghi-log-kiem-toan">
<span class="md-ellipsis">
      6.4. Audit Logging â€“ Ghi log kiá»ƒm toÃ¡n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#65-data-protection-bao-ve-du-lieu-ca-nhan">
<span class="md-ellipsis">
      6.5. Data Protection â€“ Báº£o vá»‡ dá»¯ liá»‡u cÃ¡ nhÃ¢n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#66-cac-bien-phap-phong-ve-bo-sung">
<span class="md-ellipsis">
      6.6. CÃ¡c biá»‡n phÃ¡p phÃ²ng vá»‡ bá»• sung
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-cau-hinh-phu-thuoc">
<span class="md-ellipsis">
      7. âš™ï¸ Cáº¥u hÃ¬nh &amp; Phá»¥ thuá»™c
    </span>
</a>
<nav aria-label="7. âš™ï¸ Cáº¥u hÃ¬nh &amp; Phá»¥ thuá»™c" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-bien-moi-truong-chinh-env-vars">
<span class="md-ellipsis">
      7.1. Biáº¿n mÃ´i trÆ°á»ng chÃ­nh (ENV VARS)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-cau-hinh-theo-tenant-dynamic-per-tenant">
<span class="md-ellipsis">
      7.2. Cáº¥u hÃ¬nh theo tenant (Dynamic per-tenant)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-phu-thuoc-he-thong">
<span class="md-ellipsis">
      7.3. Phá»¥ thuá»™c há»‡ thá»‘ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-phan-biet-giua-cau-hinh-build-time-va-runtime">
<span class="md-ellipsis">
      7.4. PhÃ¢n biá»‡t giá»¯a cáº¥u hÃ¬nh "build-time" vÃ  "runtime"
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-kiem-thu">
<span class="md-ellipsis">
      8. ğŸ§ª Kiá»ƒm thá»­
    </span>
</a>
<nav aria-label="8. ğŸ§ª Kiá»ƒm thá»­" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-unit-tests">
<span class="md-ellipsis">
      8.1. ğŸ§ª Unit Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-integration-tests">
<span class="md-ellipsis">
      8.2. ğŸ”„ Integration Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-contract-tests-theo-adr-010">
<span class="md-ellipsis">
      8.3. ğŸ¤ Contract Tests (theo ADR-010)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#84-rbac-security-tests">
<span class="md-ellipsis">
      8.4. ğŸ›¡ï¸ RBAC &amp; Security Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#85-o-luong-bao-cao">
<span class="md-ellipsis">
      8.5. ğŸ“Š Äo lÆ°á»ng &amp; BÃ¡o cÃ¡o
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#86-test-trong-moi-truong-staging">
<span class="md-ellipsis">
      8.6. ğŸ§ª Test trong mÃ´i trÆ°á»ng staging
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-giam-sat-audit">
<span class="md-ellipsis">
      9. ğŸ“ˆ GiÃ¡m sÃ¡t &amp; Audit
    </span>
</a>
<nav aria-label="9. ğŸ“ˆ GiÃ¡m sÃ¡t &amp; Audit" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#91-logging-ung-dung-gui-thong-bao">
<span class="md-ellipsis">
      9.1. ğŸ” Logging (á»¨ng dá»¥ng &amp; Gá»­i thÃ´ng bÃ¡o)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#92-metrics-prometheus-opentelemetry">
<span class="md-ellipsis">
      9.2. ğŸ“Š Metrics (Prometheus / OpenTelemetry)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#93-slo-alerting">
<span class="md-ellipsis">
      9.3. ğŸ¯ SLO &amp; Alerting
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#94-audit-log-tuan-thu-adr-008">
<span class="md-ellipsis">
      9.4. ğŸ“ Audit Log (tuÃ¢n thá»§ ADR-008)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#95-tracing-opentelemetry">
<span class="md-ellipsis">
      9.5. ğŸ” Tracing (OpenTelemetry)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-trien-khai-migration">
<span class="md-ellipsis">
      10. ğŸš€ Triá»ƒn khai &amp; Migration
    </span>
</a>
<nav aria-label="10. ğŸš€ Triá»ƒn khai &amp; Migration" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#101-chien-luoc-trien-khai">
<span class="md-ellipsis">
      10.1. ğŸ§­ Chiáº¿n lÆ°á»£c triá»ƒn khai
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#102-moi-truong-ranh-gioi-trien-khai-theo-adr-017">
<span class="md-ellipsis">
      10.2. â˜ï¸ MÃ´i trÆ°á»ng &amp; ranh giá»›i triá»ƒn khai (theo ADR-017)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#103-tu-ong-hoa-trien-khai-cicd">
<span class="md-ellipsis">
      10.3. ğŸš€ Tá»± Ä‘á»™ng hÃ³a triá»ƒn khai (CI/CD)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#104-migration-du-lieu-schema-du-lieu">
<span class="md-ellipsis">
      10.4. ğŸ“¥ Migration dá»¯ liá»‡u (schema &amp; dá»¯ liá»‡u)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#105-rollback-strategy">
<span class="md-ellipsis">
      10.5. â›‘ï¸ Rollback strategy
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#106-checklist-truoc-production">
<span class="md-ellipsis">
      10.6. ğŸ“‹ Checklist trÆ°á»›c production
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-kien-truc-noi-bo">
<span class="md-ellipsis">
      11. ğŸ§© Kiáº¿n trÃºc ná»™i bá»™
    </span>
</a>
<nav aria-label="11. ğŸ§© Kiáº¿n trÃºc ná»™i bá»™" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#111-muc-tieu-phan-lop">
<span class="md-ellipsis">
      11.1. Má»¥c tiÃªu phÃ¢n lá»›p
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#112-so-o-luong-xu-ly-noi-bo">
<span class="md-ellipsis">
      11.2. SÆ¡ Ä‘á»“ luá»“ng xá»­ lÃ½ ná»™i bá»™
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#113-phan-tich-module-chinh">
<span class="md-ellipsis">
      11.3. PhÃ¢n tÃ­ch module chÃ­nh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#114-logging-tracing-luong-noi-bo">
<span class="md-ellipsis">
      11.4. Logging &amp; Tracing luá»“ng ná»™i bá»™
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#115-kha-nang-mo-rong-plugin">
<span class="md-ellipsis">
      11.5. Kháº£ nÄƒng má»Ÿ rá»™ng &amp; plugin
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-tai-lieu-lien-quan">
<span class="md-ellipsis">
      12. ğŸ“š TÃ i liá»‡u liÃªn quan
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="thiet-ke-chi-tiet-notification-sub-service">ğŸ“˜ Thiáº¿t káº¿ chi tiáº¿t Notification Sub Service<a class="headerlink" href="#thiet-ke-chi-tiet-notification-sub-service" title="Permanent link">Â¶</a></h1>
<h2 id="1-pham-vi-va-trach-nhiem">1. ğŸ§­ Pháº¡m vi vÃ  TrÃ¡ch nhiá»‡m<a class="headerlink" href="#1-pham-vi-va-trach-nhiem" title="Permanent link">Â¶</a></h2>
<h3 id="muc-tieu">ğŸ¯ Má»¥c tiÃªu<a class="headerlink" href="#muc-tieu" title="Permanent link">Â¶</a></h3>
<ul>
<li>Láº¯ng nghe sá»± kiá»‡n <code>notification.triggered</code> tá»« Notification Master Ä‘á»ƒ gá»­i thÃ´ng bÃ¡o thá»±c táº¿ Ä‘áº¿n ngÆ°á»i dÃ¹ng cuá»‘i trong tá»«ng tenant.</li>
<li>Quáº£n lÃ½ cáº¥u hÃ¬nh kÃªnh gá»­i cá»§a tenant (email, SMS, push), mapping template vÃ  xá»­ lÃ½ fallback logic.</li>
<li>Ghi nháº­n log gá»­i Ä‘á»ƒ phá»¥c vá»¥ tra soÃ¡t, thá»‘ng kÃª, vÃ  audit.</li>
</ul>
<h3 id="cac-thuc-the-du-lieu-quan-ly">ğŸ“¦ CÃ¡c thá»±c thá»ƒ dá»¯ liá»‡u quáº£n lÃ½<a class="headerlink" href="#cac-thuc-the-du-lieu-quan-ly" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Thá»±c thá»ƒ</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NotificationTemplate</code></td>
<td>Template Ä‘Æ°á»£c cáº¥u hÃ¬nh riÃªng cho tá»«ng tenant, mapping theo trigger_event.</td>
</tr>
<tr>
<td><code>NotificationLog</code></td>
<td>LÆ°u láº¡i lá»‹ch sá»­ gá»­i thÃ´ng bÃ¡o, tráº¡ng thÃ¡i gá»­i, lá»—i, thá»i gian gá»­i.</td>
</tr>
<tr>
<td><code>NotificationChannelCfg</code></td>
<td>Cáº¥u hÃ¬nh kÃªnh gá»­i (SMTP, SMS provider...) do tenant quáº£n lÃ½.</td>
</tr>
</tbody>
</table>
<h3 id="ngoai-pham-vi">ğŸ”’ NgoÃ i Pháº¡m Vi<a class="headerlink" href="#ngoai-pham-vi" title="Permanent link">Â¶</a></h3>
<p>Service nÃ y <strong>khÃ´ng</strong> thá»±c hiá»‡n:
- âŒ Quáº£n lÃ½ trigger business logic táº¡o ra notification â€“ Ä‘Ã£ Ä‘Æ°á»£c tÃ¡ch riÃªng táº¡i Notification Master.
- âŒ Tá»± generate ná»™i dung hoáº·c cÃ¡ nhÃ¢n hÃ³a sÃ¢u (viá»‡c Ä‘Ã³ do master thá»±c hiá»‡n).
- âŒ Gá»­i thÃ´ng bÃ¡o vÆ°á»£t quyá»n tenant (cross-tenant broadcast).
- âŒ XÃ¡c thá»±c user â€“ Ä‘Æ°á»£c thá»±c hiá»‡n táº¡i Gateway.</p>
<h3 id="oi-tuong-su-dung">ğŸ‘¥ Äá»‘i tÆ°á»£ng sá»­ dá»¥ng<a class="headerlink" href="#oi-tuong-su-dung" title="Permanent link">Â¶</a></h3>
<ul>
<li>Notification Master (qua Pub/Sub â€“ async)</li>
<li>Superadmin Webapp (cho má»¥c Ä‘Ã­ch tra log, kiá»ƒm tra tráº¡ng thÃ¡i â€“ náº¿u cáº§n)</li>
<li>Admin Webapp cá»§a tenant (truy cáº­p ná»™i bá»™ Ä‘á»ƒ chá»‰nh sá»­a cáº¥u hÃ¬nh kÃªnh)</li>
</ul>
<h2 id="2-thiet-ke-api-chi-tiet">2. ğŸŒ Thiáº¿t káº¿ API chi tiáº¿t<a class="headerlink" href="#2-thiet-ke-api-chi-tiet" title="Permanent link">Â¶</a></h2>
<table>
<thead>
<tr>
<th>Method</th>
<th>Path</th>
<th>TÃ¡c vá»¥</th>
<th>YÃªu cáº§u permission (RBAC)</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/notifications/logs</code></td>
<td>Láº¥y danh sÃ¡ch log gá»­i</td>
<td><code>notif.read.log</code></td>
</tr>
<tr>
<td>GET</td>
<td><code>/notifications/templates</code></td>
<td>Láº¥y danh sÃ¡ch template</td>
<td><code>notif.read.template</code></td>
</tr>
<tr>
<td>POST</td>
<td><code>/notifications/test</code></td>
<td>Gá»­i thá»­ 1 notification tá»›i ngÆ°á»i dÃ¹ng test</td>
<td><code>notif.send.test</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>ğŸ”§ TuÃ¢n thá»§:
- ADR-011: Error Format
- ADR-012: Response Envelope
- ADR-013: Path Naming
- ADR-030: Event Schema Governance (consume: <code>notification.triggered</code>)
- ğŸ“ Chi tiáº¿t xem táº¡i: <a href="../interface-contract/">Interface Contract</a> vÃ  <a href="../openapi.yaml">OpenAPI Spec</a></p>
</blockquote>
<h2 id="3-mo-hinh-du-lieu-chi-tiet">3. ğŸ—ƒï¸ MÃ´ hÃ¬nh dá»¯ liá»‡u chi tiáº¿t<a class="headerlink" href="#3-mo-hinh-du-lieu-chi-tiet" title="Permanent link">Â¶</a></h2>
<pre class="mermaid"><code>erDiagram
  NotificationTemplate ||--o{ NotificationLog : used_by
  NotificationChannelCfg ||--o{ NotificationTemplate : configures

  NotificationTemplate {
    UUID id PK
    STRING event_code
    STRING channel
    TEXT template_body
    JSONB default_params
    BOOLEAN is_active
    TIMESTAMPTZ updated_at
  }

  NotificationLog {
    UUID id PK
    UUID template_id FK
    STRING recipient
    STRING status
    TEXT error_message
    JSONB payload
    TIMESTAMPTZ sent_at
  }

  NotificationChannelCfg {
    STRING channel PK
    STRING provider
    JSONB config
    BOOLEAN is_enabled
    TIMESTAMPTZ updated_at
  }
````

&gt; ğŸ“ Chi tiáº¿t xem táº¡i: [Data Model](./data-model.md)

---

### 4. ğŸ”„ Luá»“ng nghiá»‡p vá»¥ chÃ­nh â€“ Chi tiáº¿t hÃ³a

#### 4.1. Má»¥c tiÃªu

Má»—i láº§n nháº­n Ä‘Æ°á»£c sá»± kiá»‡n `notification.triggered`, service pháº£i:

1. Láº¥y Ä‘Ãºng template phÃ¹ há»£p theo `event_code`, `channel`, `tenant_id`
2. Gá»­i notification qua kÃªnh tÆ°Æ¡ng á»©ng (email, SMS, v.v.)
3. Log Ä‘áº§y Ä‘á»§ hÃ nh Ä‘á»™ng gá»­i â€“ tráº¡ng thÃ¡i, lá»—i náº¿u cÃ³, thá»i gian
4. CÃ³ fallback náº¿u gá»­i kÃªnh chÃ­nh tháº¥t báº¡i (náº¿u Ä‘Æ°á»£c cáº¥u hÃ¬nh)
5. TuÃ¢n thá»§ giá»›i háº¡n (rate-limit, retry theo config náº¿u cÃ³)

---

#### 4.2. MÃ´ táº£ logic Ä‘áº§y Ä‘á»§

```mermaid
sequenceDiagram
    participant PubSub as Pub/Sub
    participant NotiSub as Notification Sub
    participant DB as Notification DB
    participant Email as Email/SMS Gateway
    participant Fallback as Fallback Channel

    PubSub--&gt;&gt;NotiSub: Nháº­n sá»± kiá»‡n `notification.triggered`
    Note right of NotiSub: Extract `tenant_id`, `event_code`, `channel`, `recipient`, `params`

    NotiSub-&gt;&gt;DB: Truy váº¥n NotificationTemplate (match theo `event_code`, `channel`, `tenant_id`)
    alt KhÃ´ng tÃ¬m tháº¥y template
        NotiSub--&gt;&gt;DB: Ghi log lá»—i "template not found"
        Note right of NotiSub: Dá»«ng xá»­ lÃ½ â€“ khÃ´ng gá»­i
    else Template há»£p lá»‡
        NotiSub-&gt;&gt;DB: Ghi log tráº¡ng thÃ¡i `queued`, lÆ°u payload
        NotiSub-&gt;&gt;Email: Gá»­i thÃ´ng bÃ¡o (render template + send)
        alt Gá»­i thÃ nh cÃ´ng
            Email--&gt;&gt;NotiSub: OK
            NotiSub-&gt;&gt;DB: Update log â†’ status=`sent`
        else Gá»­i tháº¥t báº¡i
            Email--&gt;&gt;NotiSub: Error
            alt CÃ³ fallback Ä‘Æ°á»£c cáº¥u hÃ¬nh
                NotiSub-&gt;&gt;Fallback: Gá»­i láº¡i qua kÃªnh fallback
                Fallback--&gt;&gt;NotiSub: OK/Error
                NotiSub-&gt;&gt;DB: Update log â†’ status=`sent_fallback` hoáº·c `failed`
            else KhÃ´ng cÃ³ fallback
                NotiSub-&gt;&gt;DB: Update log â†’ status=`failed`, lÆ°u lá»—i
            end
        end
    end
</code></pre>
<hr/>
<h4 id="43-chi-tiet-cac-buoc">4.3. Chi tiáº¿t cÃ¡c bÆ°á»›c<a class="headerlink" href="#43-chi-tiet-cac-buoc" title="Permanent link">Â¶</a></h4>
<table>
<thead>
<tr>
<th>BÆ°á»›c</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>1. Nháº­n sá»± kiá»‡n</strong></td>
<td>Service láº¯ng nghe tá»« Pub/Sub <code>notification.triggered.v1</code> vá»›i payload cÃ³ <code>event_code</code>, <code>channel</code>, <code>recipient</code>, <code>params</code>, <code>trace_id</code>, <code>tenant_id</code>.</td>
</tr>
<tr>
<td><strong>2. Tra cá»©u template</strong></td>
<td>Truy theo <code>event_code</code> + <code>channel</code> + <code>tenant_id</code>. Náº¿u khÃ´ng cÃ³ template tÆ°Æ¡ng á»©ng â†’ ghi log lá»—i vÃ  dá»«ng.</td>
</tr>
<tr>
<td><strong>3. Render &amp; Gá»­i</strong></td>
<td>Render <code>template_body</code> vá»›i <code>params</code> vÃ  gá»­i thá»±c táº¿ qua SMTP/SMS/...</td>
</tr>
<tr>
<td><strong>4. Ghi log gá»­i</strong></td>
<td>Táº¡o entry trong báº£ng <code>NotificationLog</code> trÆ°á»›c khi gá»­i (status: <code>queued</code>), sau Ä‘Ã³ update thÃ nh <code>sent</code>, <code>sent_fallback</code>, hoáº·c <code>failed</code>.</td>
</tr>
<tr>
<td><strong>5. Xá»­ lÃ½ fallback</strong></td>
<td>Náº¿u kÃªnh gá»­i tháº¥t báº¡i vÃ  cÃ³ cáº¥u hÃ¬nh fallback (VD: tá»« email â†’ SMS), thá»±c hiá»‡n gá»­i láº¡i qua fallback.</td>
</tr>
<tr>
<td><strong>6. Audit &amp; Tracing</strong></td>
<td>Ghi Ä‘áº§y Ä‘á»§ trace_id vÃ  action <code>notification.sent</code> phá»¥c vá»¥ audit (<code>adr-008</code>).</td>
</tr>
</tbody>
</table>
<hr/>
<h4 id="44-ghi-chu-luu-y-trien-khai">4.4. Ghi chÃº &amp; lÆ°u Ã½ triá»ƒn khai<a class="headerlink" href="#44-ghi-chu-luu-y-trien-khai" title="Permanent link">Â¶</a></h4>
<ul>
<li><strong>Template Mapping</strong> pháº£i Ä‘Ãºng channel â€“ trÃ¡nh gá»­i email báº±ng SMS template hoáº·c ngÆ°á»£c láº¡i.</li>
<li><strong>Báº£o vá»‡ chá»‘ng gá»­i láº·p</strong> náº¿u Pub/Sub delivery bá»‹ trÃ¹ng â†’ cáº§n xá»­ lÃ½ idempotency qua <code>event_id</code>.</li>
<li><strong>Fallback policy</strong> cÃ³ thá»ƒ cáº¥u hÃ¬nh á»Ÿ level <code>NotificationChannelCfg</code>, vÃ­ dá»¥:</li>
</ul>
<p><div class="language-json highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p">{</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"email"</span><span class="p">,</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">"fallback"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"sms"</span><span class="p">],</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">"retry_limit"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="p">}</span>
</span></code></pre></div>
* <strong>Cáº§n validate Ä‘áº§u vÃ o ká»¹</strong>: recipient khÃ´ng null, channel Ä‘Æ°á»£c há»— trá»£, params Ä‘á»§ Ä‘á»ƒ render template.
* <strong>KhÃ´ng block worker náº¿u gá»­i tháº¥t báº¡i</strong> â€“ chá»‰ cáº§n log vÃ  tiáº¿p tá»¥c.</p>
<hr/>
<h2 id="5-tuong-tac-su-kien">5. ğŸ“£ TÆ°Æ¡ng tÃ¡c &amp; Sá»± kiá»‡n<a class="headerlink" href="#5-tuong-tac-su-kien" title="Permanent link">Â¶</a></h2>
<h3 id="51-su-kien-nhan-vao-consumed-event">5.1. Sá»± kiá»‡n nháº­n vÃ o (Consumed Event)<a class="headerlink" href="#51-su-kien-nhan-vao-consumed-event" title="Permanent link">Â¶</a></h3>
<h4 id="su-kien-notificationtriggeredv1">ğŸ”” Sá»± kiá»‡n: <code>notification.triggered.v1</code><a class="headerlink" href="#su-kien-notificationtriggeredv1" title="Permanent link">Â¶</a></h4>
<table>
<thead>
<tr>
<th>Thuá»™c tÃ­nh</th>
<th>Báº¯t buá»™c</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>event_id</code></td>
<td>âœ…</td>
<td>UUID Ä‘á»‹nh danh sá»± kiá»‡n, phá»¥c vá»¥ idempotency</td>
</tr>
<tr>
<td><code>tenant_id</code></td>
<td>âœ…</td>
<td>Tenant gá»­i thÃ´ng bÃ¡o</td>
</tr>
<tr>
<td><code>event_code</code></td>
<td>âœ…</td>
<td>MÃ£ sá»± kiá»‡n trá»«u tÆ°á»£ng (vd: <code>user.welcome</code>) Ä‘á»ƒ tra template</td>
</tr>
<tr>
<td><code>channel</code></td>
<td>âœ…</td>
<td>KÃªnh gá»­i (<code>email</code>, <code>sms</code>, <code>push</code>, etc.)</td>
</tr>
<tr>
<td><code>recipient</code></td>
<td>âœ…</td>
<td>Äá»‹a chá»‰ nháº­n (<code>email</code>, <code>phone</code>, <code>device_id</code>,â€¦)</td>
</tr>
<tr>
<td><code>params</code></td>
<td>âœ…</td>
<td>Tham sá»‘ Ä‘á»™ng Ä‘á»ƒ render ná»™i dung template (JSON)</td>
</tr>
<tr>
<td><code>trigger_by</code></td>
<td>â›”</td>
<td>ID ngÆ°á»i dÃ¹ng kÃ­ch hoáº¡t sá»± kiá»‡n (náº¿u cÃ³)</td>
</tr>
<tr>
<td><code>trace_id</code></td>
<td>âœ…</td>
<td>Trace Ä‘á»ƒ tracking xuyÃªn suá»‘t toÃ n há»‡ thá»‘ng</td>
</tr>
<tr>
<td><code>created_at</code></td>
<td>âœ…</td>
<td>Thá»i Ä‘iá»ƒm phÃ¡t sinh sá»± kiá»‡n (Ä‘á»ƒ log thá»‘ng nháº¥t)</td>
</tr>
</tbody>
</table>
<p>VÃ­ dá»¥ schema (JSON):</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nt">"event_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3a36f1d4-8fa7-4704-a94e-4c55e9142cb3"</span><span class="p">,</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tenant-vas-001"</span><span class="p">,</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">"event_code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user.welcome"</span><span class="p">,</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nt">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"email"</span><span class="p">,</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="nt">"recipient"</span><span class="p">:</span><span class="w"> </span><span class="s2">"student@example.edu.vn"</span><span class="p">,</span>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="nt">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="nt">"full_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Nguyá»…n VÄƒn A"</span><span class="p">,</span>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="nt">"first_login_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-01T10:00:00Z"</span>
</span><span id="__span-1-10"><a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-1-11"><a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="nt">"trigger_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin_123"</span><span class="p">,</span>
</span><span id="__span-1-12"><a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">  </span><span class="nt">"trace_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"x-trace-abc-789"</span><span class="p">,</span>
</span><span id="__span-1-13"><a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">  </span><span class="nt">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-14T07:32:00Z"</span>
</span><span id="__span-1-14"><a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="p">}</span>
</span></code></pre></div>
<blockquote>
<p>âœ… Schema nÃ y Ä‘Æ°á»£c quáº£n lÃ½ vÃ  version hÃ³a theo <code>ADR-030 â€“ Event Schema Governance</code></p>
</blockquote>
<hr/>
<h3 id="52-xu-ly-su-kien">5.2. Xá»­ lÃ½ sá»± kiá»‡n<a class="headerlink" href="#52-xu-ly-su-kien" title="Permanent link">Â¶</a></h3>
<ul>
<li>
<p>Notification Sub Service sáº½ <strong>Ä‘Äƒng kÃ½ láº¯ng nghe</strong> topic tÆ°Æ¡ng á»©ng, vÃ­ dá»¥:</p>
</li>
<li>
<p>GCP Pub/Sub: <code>vas.notification.triggered.v1</code></p>
</li>
<li>Kafka: <code>notification.triggered.v1</code></li>
<li>
<p>Khi nháº­n event, service thá»±c hiá»‡n pipeline:</p>
</li>
<li>
<p>Parse + Validate schema theo version</p>
</li>
<li>Check <code>event_id</code> Ä‘Ã£ xá»­ lÃ½ chÆ°a â†’ Ä‘á»ƒ trÃ¡nh gá»­i láº·p (idempotency)</li>
<li>Render template</li>
<li>Gá»­i notification</li>
<li>Ghi log + káº¿t quáº£ gá»­i + <code>trace_id</code> + <code>status</code></li>
</ul>
<hr/>
<h3 id="53-khong-phat-sinh-su-kien-outbound">5.3. KhÃ´ng phÃ¡t sinh sá»± kiá»‡n outbound<a class="headerlink" href="#53-khong-phat-sinh-su-kien-outbound" title="Permanent link">Â¶</a></h3>
<p>Notification Sub <strong>khÃ´ng phÃ¡t event ngÆ°á»£c ra ngoÃ i</strong>. Tuy nhiÃªn:</p>
<ul>
<li>CÃ³ thá»ƒ log vÃ o há»‡ thá»‘ng Audit Logging (theo <code>adr-008</code>) báº±ng cÃ¡ch gá»i ná»™i bá»™ tá»›i <code>audit-logging-service</code></li>
<li>KhÃ´ng cÃ³ luá»“ng Ä‘á»“ng bá»™ Ä‘áº©y ra Pub/Sub Ä‘á»ƒ trÃ¡nh phÃ¡t sinh spam hoáº·c loop</li>
</ul>
<hr/>
<h3 id="54-bien-the-su-kien-kha-nang-mo-rong">5.4. Biáº¿n thá»ƒ sá»± kiá»‡n &amp; kháº£ nÄƒng má»Ÿ rá»™ng<a class="headerlink" href="#54-bien-the-su-kien-kha-nang-mo-rong" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Biáº¿n thá»ƒ</th>
<th>MÃ´ táº£</th>
<th>CÃ¡ch xá»­ lÃ½</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>notification.triggered.v2</code></td>
<td>PhiÃªn báº£n má»›i cá»§a schema (breaking change)</td>
<td>Service nÃªn dual-consume náº¿u cáº§n</td>
</tr>
<tr>
<td><code>notification.test.v1</code></td>
<td>Sá»± kiá»‡n gá»­i thá»­ (tá»« Admin UI)</td>
<td>CÃ³ thá»ƒ xá»­ lÃ½ ná»™i bá»™, log riÃªng</td>
</tr>
<tr>
<td><code>notification.bulk.v1</code></td>
<td>Gá»­i nhiá»u ngÆ°á»i nháº­n má»™t lÃºc</td>
<td><strong>KhÃ´ng xá»­ lÃ½</strong> â€“ Ä‘Ã£ tÃ¡ch thÃ nh luá»“ng riÃªng</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ğŸ“Œ CÃ¡c biáº¿n thá»ƒ nÃªn Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a rÃµ trong <code>event-schemas/registry</code> theo <code>ADR-030</code></p>
</blockquote>
<hr/>
<h3 id="55-chinh-sach-schema-versioning">5.5. ChÃ­nh sÃ¡ch Schema &amp; Versioning<a class="headerlink" href="#55-chinh-sach-schema-versioning" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ nghiÃªm ngáº·t <code>ADR-030</code>:</p>
<ul>
<li>KhÃ´ng thay Ä‘á»•i field báº¯t buá»™c trong version cÅ©</li>
<li>Náº¿u cáº§n breaking change â†’ táº¡o version má»›i (vd: <code>v2</code>) vÃ  dual-publish trong giai Ä‘oáº¡n chuyá»ƒn tiáº¿p</li>
<li>Má»—i sá»± kiá»‡n Ä‘á»u mang <code>event_id</code>, <code>trace_id</code>, <code>version</code>, <code>tenant_id</code></li>
</ul>
<hr/>
<h2 id="6-bao-mat-rbac">6. ğŸ” Báº£o máº­t &amp; RBAC<a class="headerlink" href="#6-bao-mat-rbac" title="Permanent link">Â¶</a></h2>
<h3 id="61-authentication-xac-thuc">6.1. Authentication â€“ XÃ¡c thá»±c<a class="headerlink" href="#61-authentication-xac-thuc" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>Má»i API cá»§a Notification Sub</strong> Ä‘á»u yÃªu cáº§u ngÆ°á»i dÃ¹ng Ä‘Ã£ xÃ¡c thá»±c qua <strong>API Gateway</strong>, dÃ¹ng JWT chuáº©n theo <code>ADR-006</code>.</li>
<li>
<p>Token sáº½ Ä‘Æ°á»£c kiá»ƒm tra signature vÃ  claim gá»“m:</p>
</li>
<li>
<p><code>sub</code>: user ID</p>
</li>
<li><code>tenant_id</code>: mÃ£ tenant Ä‘ang truy cáº­p</li>
<li><code>permissions</code>: danh sÃ¡ch quyá»n cÃ³ dáº¡ng <code>notif.read.log</code>, <code>notif.send.test</code>, v.v.</li>
<li><code>exp</code>: thá»i Ä‘iá»ƒm háº¿t háº¡n</li>
<li>Token Ä‘Æ°á»£c Ä‘Ã­nh kÃ¨m qua header:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>Authorization: Bearer &lt;access_token&gt;
</span></code></pre></div>
<hr/>
<h3 id="62-authorization-phan-quyen">6.2. Authorization â€“ PhÃ¢n quyá»n<a class="headerlink" href="#62-authorization-phan-quyen" title="Permanent link">Â¶</a></h3>
<p>Ãp dá»¥ng mÃ´ hÃ¬nh RBAC <strong>phÃ¢n táº§ng theo tenant</strong>, theo chuáº©n <code>ADR-007</code>.
Má»—i API Ä‘á»u khai bÃ¡o permission yÃªu cáº§u qua <code>x-required-permission</code>, vÃ­ dá»¥:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nt">x-required-permission</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">notif.read.log</span>
</span></code></pre></div>
<h4 id="quy-tac-phan-quyen">Quy táº¯c phÃ¢n quyá»n:<a class="headerlink" href="#quy-tac-phan-quyen" title="Permanent link">Â¶</a></h4>
<table>
<thead>
<tr>
<th>NhÃ³m chá»©c nÄƒng</th>
<th>Permission</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td>Xem log gá»­i</td>
<td><code>notif.read.log</code></td>
<td>Cho phÃ©p truy xuáº¥t danh sÃ¡ch notification Ä‘Ã£ gá»­i</td>
</tr>
<tr>
<td>Xem template</td>
<td><code>notif.read.template</code></td>
<td>Cho phÃ©p tra cá»©u cÃ¡c template hiá»‡n cÃ³</td>
</tr>
<tr>
<td>Gá»­i thá»­</td>
<td><code>notif.send.test</code></td>
<td>Gá»­i thá»­ email/SMS Ä‘áº¿n Ä‘á»‹a chá»‰ kiá»ƒm tra</td>
</tr>
<tr>
<td>Cáº¥u hÃ¬nh channel</td>
<td><code>notif.write.config</code></td>
<td>Sá»­a thÃ´ng tin cáº¥u hÃ¬nh kÃªnh gá»­i cá»§a tenant</td>
</tr>
</tbody>
</table>
<blockquote>
<p>âœ… Danh sÃ¡ch permission Ä‘Æ°á»£c cáº¥p theo tá»«ng <code>user_role</code> gáº¯n vá»›i <code>X-Tenant-ID</code></p>
</blockquote>
<hr/>
<h3 id="63-tenant-isolation-tach-biet-tenant">6.3. Tenant Isolation â€“ TÃ¡ch biá»‡t tenant<a class="headerlink" href="#63-tenant-isolation-tach-biet-tenant" title="Permanent link">Â¶</a></h3>
<p>Theo yÃªu cáº§u cá»§a <code>CR-04</code>, má»i hÃ nh Ä‘á»™ng (query, mutate, audit) Ä‘á»u pháº£i:</p>
<ul>
<li><strong>RÃ ng buá»™c trong pháº¡m vi <code>X-Tenant-ID</code></strong> (Ä‘á»c tá»« JWT hoáº·c header)</li>
<li>KhÃ´ng cho phÃ©p truy cáº­p chÃ©o tenant (trá»« <code>Superadmin</code>)</li>
<li>CÃ³ cáº¥u trÃºc condition rÃµ trong OpenAPI:</li>
</ul>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nt">x-condition</span><span class="p">:</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="nt">tenant_id</span><span class="p">:</span><span class="w"> </span><span class="s">"{{X-Tenant-ID}}"</span>
</span></code></pre></div>
<hr/>
<h3 id="64-audit-logging-ghi-log-kiem-toan">6.4. Audit Logging â€“ Ghi log kiá»ƒm toÃ¡n<a class="headerlink" href="#64-audit-logging-ghi-log-kiem-toan" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ <code>ADR-008</code>, má»i hÃ nh Ä‘á»™ng quan trá»ng sáº½ Ä‘Æ°á»£c log láº¡i dÆ°á»›i dáº¡ng Audit Event, bao gá»“m:</p>
<table>
<thead>
<tr>
<th>HÃ nh Ä‘á»™ng</th>
<th>Audit Action</th>
<th>Ghi chÃº</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gá»­i má»™t notification</td>
<td><code>notification.sent</code></td>
<td>Bao gá»“m recipient, template_id, status</td>
</tr>
<tr>
<td>Sá»­a cáº¥u hÃ¬nh channel gá»­i</td>
<td><code>notification.config.updated</code></td>
<td>LÆ°u láº¡i giÃ¡ trá»‹ cÅ© vÃ  má»›i</td>
</tr>
<tr>
<td>Gá»­i thá»­</td>
<td><code>notification.test_sent</code></td>
<td>LÆ°u láº¡i ngÆ°á»i gá»­i thá»­ &amp; káº¿t quáº£</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Audit log Ä‘Æ°á»£c Ä‘áº©y async tá»›i <code>audit-logging-service</code> hoáº·c ghi ná»™i bá»™ tÃ¹y theo cáº¥u hÃ¬nh mÃ´i trÆ°á»ng</p>
</blockquote>
<hr/>
<h3 id="65-data-protection-bao-ve-du-lieu-ca-nhan">6.5. Data Protection â€“ Báº£o vá»‡ dá»¯ liá»‡u cÃ¡ nhÃ¢n<a class="headerlink" href="#65-data-protection-bao-ve-du-lieu-ca-nhan" title="Permanent link">Â¶</a></h3>
<ul>
<li>KhÃ´ng lÆ°u plaintext recipient hoáº·c payload náº¿u khÃ´ng cáº§n thiáº¿t.</li>
<li>TrÆ°á»ng nháº¡y cáº£m (<code>recipient</code>, <code>error_message</code>) cÃ³ thá»ƒ bá»‹ <strong>mask hoáº·c hash</strong> náº¿u Ä‘Æ°á»£c cáº¥u hÃ¬nh.</li>
<li>CÃ³ thá»ƒ dÃ¹ng <code>ADR-024</code> Ä‘á»ƒ thiáº¿t láº­p thá»i gian <strong>anonymization hoáº·c retention policy</strong> theo tá»«ng tenant.</li>
</ul>
<hr/>
<h3 id="66-cac-bien-phap-phong-ve-bo-sung">6.6. CÃ¡c biá»‡n phÃ¡p phÃ²ng vá»‡ bá»• sung<a class="headerlink" href="#66-cac-bien-phap-phong-ve-bo-sung" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Lá»›p báº£o vá»‡</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td>Input validation</td>
<td>Kiá»ƒm tra recipient, template_id, channel cÃ³ há»£p lá»‡ khÃ´ng</td>
</tr>
<tr>
<td>Rate limiting</td>
<td>Do API Gateway quáº£n lÃ½ â€“ trÃ¡nh spam gá»­i</td>
</tr>
<tr>
<td>Idempotency</td>
<td>Dá»±a trÃªn <code>event_id</code> Ä‘á»ƒ trÃ¡nh gá»­i láº·p náº¿u event bá»‹ retry</td>
</tr>
<tr>
<td>Fallback isolation</td>
<td>Náº¿u gá»­i tháº¥t báº¡i vÃ  fallback, Ä‘áº£m báº£o fallback khÃ´ng rÃ² dá»¯ liá»‡u giá»¯a tenant</td>
</tr>
<tr>
<td>CI/CD static scan</td>
<td>Kiá»ƒm tra dependency &amp; config secrets trÆ°á»›c khi deploy</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="7-cau-hinh-phu-thuoc">7. âš™ï¸ Cáº¥u hÃ¬nh &amp; Phá»¥ thuá»™c<a class="headerlink" href="#7-cau-hinh-phu-thuoc" title="Permanent link">Â¶</a></h2>
<h3 id="71-bien-moi-truong-chinh-env-vars">7.1. Biáº¿n mÃ´i trÆ°á»ng chÃ­nh (<code>ENV VARS</code>)<a class="headerlink" href="#71-bien-moi-truong-chinh-env-vars" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Biáº¿n</th>
<th>Báº¯t buá»™c</th>
<th>GiÃ¡ trá»‹ máº«u</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SERVICE_PORT</code></td>
<td>âœ…</td>
<td><code>8080</code></td>
<td>Cá»•ng service sáº½ má»Ÿ cho HTTP API ná»™i bá»™</td>
</tr>
<tr>
<td><code>DATABASE_URL</code></td>
<td>âœ…</td>
<td><code>postgres://user:pass@host:5432/notif_sub</code></td>
<td>Káº¿t ná»‘i tá»›i CSDL Postgres chá»©a template/log</td>
</tr>
<tr>
<td><code>PUBSUB_TOPIC</code></td>
<td>âœ…</td>
<td><code>notification.triggered.v1</code></td>
<td>TÃªn topic Pub/Sub Ä‘á»ƒ subscribe sá»± kiá»‡n</td>
</tr>
<tr>
<td><code>GCP_PROJECT_ID</code></td>
<td>â›”</td>
<td><code>vas-prod-01</code></td>
<td>DÃ¹ng náº¿u cháº¡y trÃªn GCP â€“ Ä‘á»‹nh danh project</td>
</tr>
<tr>
<td><code>TENANT_CONFIG_SECRET_PATH</code></td>
<td>âœ…</td>
<td><code>/secrets/tenant_config/</code></td>
<td>Trá» tá»›i thÆ° má»¥c chá»©a config tá»«ng tenant (template, fallback, channel)</td>
</tr>
<tr>
<td><code>SMTP_PROVIDER_SECRET</code></td>
<td>â›”</td>
<td><code>secret://smtp-notif</code></td>
<td>Secret chá»©a config SMTP provider máº·c Ä‘á»‹nh</td>
</tr>
<tr>
<td><code>JWT_PUBLIC_KEY_PATH</code></td>
<td>âœ…</td>
<td><code>/etc/keys/jwt.pub</code></td>
<td>File public key Ä‘á»ƒ verify JWT</td>
</tr>
<tr>
<td><code>ENVIRONMENT</code></td>
<td>âœ…</td>
<td><code>production</code> / <code>staging</code> / <code>dev</code></td>
<td>DÃ¹ng Ä‘á»ƒ phÃ¢n biá»‡t mÃ´i trÆ°á»ng khi gá»­i Audit log, alerting</td>
</tr>
<tr>
<td><code>AUDIT_SERVICE_ENDPOINT</code></td>
<td>â›”</td>
<td><code>http://audit-logging-service</code></td>
<td>Endpoint ná»™i bá»™ gá»i tá»›i Audit Logging náº¿u báº­t</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ğŸ” Secrets nhÆ° SMTP credentials, access tokens khÃ´ng bao giá» hardcode â€“ Ä‘Æ°á»£c mount tá»« Secret Manager hoáº·c Vault (theo <code>ADR-003</code> vÃ  <code>ADR-004</code>)</p>
</blockquote>
<hr/>
<h3 id="72-cau-hinh-theo-tenant-dynamic-per-tenant">7.2. Cáº¥u hÃ¬nh theo tenant (Dynamic per-tenant)<a class="headerlink" href="#72-cau-hinh-theo-tenant-dynamic-per-tenant" title="Permanent link">Â¶</a></h3>
<p>CÃ¡c tenant cÃ³ thá»ƒ cÃ³ cáº¥u hÃ¬nh khÃ¡c nhau nhÆ°:</p>
<table>
<thead>
<tr>
<th>Cáº¥u hÃ¬nh</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td>Template riÃªng</td>
<td>CÃ¹ng má»™t <code>event_code</code>, má»—i tenant cÃ³ thá»ƒ Ä‘á»‹nh nghÄ©a ná»™i dung template khÃ¡c nhau</td>
</tr>
<tr>
<td>Cáº¥u hÃ¬nh kÃªnh gá»­i</td>
<td>Email: SMTP riÃªng, SMS: key riÃªng theo provider</td>
</tr>
<tr>
<td>Fallback policy</td>
<td>CÃ³ thá»ƒ chá»n fallback hoáº·c khÃ´ng, theo logic riÃªng cá»§a tenant</td>
</tr>
<tr>
<td>NgÃ´n ngá»¯ máº·c Ä‘á»‹nh</td>
<td>Má»™t sá»‘ tenant gá»­i email báº±ng Tiáº¿ng Anh, sá»‘ khÃ¡c báº±ng Tiáº¿ng Viá»‡t</td>
</tr>
<tr>
<td>Opt-in / Opt-out</td>
<td>Cho phÃ©p user tá»« chá»‘i nháº­n má»™t sá»‘ loáº¡i thÃ´ng bÃ¡o (VD: quáº£ng cÃ¡o)</td>
</tr>
</tbody>
</table>
<p>ThÃ´ng tin nÃ y Ä‘Æ°á»£c náº¡p tá»« <code>TENANT_CONFIG_SECRET_PATH</code> theo má»—i tenant (<code>tenant_id</code>) trong runtime.</p>
<hr/>
<h3 id="73-phu-thuoc-he-thong">7.3. Phá»¥ thuá»™c há»‡ thá»‘ng<a class="headerlink" href="#73-phu-thuoc-he-thong" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>ThÃ nh pháº§n</th>
<th>Má»¥c tiÃªu sá»­ dá»¥ng</th>
<th>Giao thá»©c</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PostgreSQL</code></td>
<td>LÆ°u trá»¯ <code>NotificationTemplate</code>, <code>NotificationLog</code>, <code>ChannelCfg</code></td>
<td>SQL</td>
</tr>
<tr>
<td><code>Pub/Sub</code></td>
<td>Nháº­n sá»± kiá»‡n <code>notification.triggered</code> tá»« Master</td>
<td>PubSub/Kafka</td>
</tr>
<tr>
<td><code>Email/SMS Provider</code></td>
<td>Gá»­i email, SMS qua SMTP/HTTP API</td>
<td>SMTP / HTTPS</td>
</tr>
<tr>
<td><code>audit-logging-service</code></td>
<td>Ghi log hÃ nh vi gá»­i (náº¿u báº­t)</td>
<td>HTTP ná»™i bá»™</td>
</tr>
<tr>
<td><code>vault / secret-manager</code></td>
<td>LÆ°u config gá»­i riÃªng cá»§a tenant</td>
<td>Náº¡p khi runtime</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="74-phan-biet-giua-cau-hinh-build-time-va-runtime">7.4. PhÃ¢n biá»‡t giá»¯a cáº¥u hÃ¬nh "build-time" vÃ  "runtime"<a class="headerlink" href="#74-phan-biet-giua-cau-hinh-build-time-va-runtime" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Loáº¡i cáº¥u hÃ¬nh</th>
<th>VÃ­ dá»¥</th>
<th>Ghi chÃº</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Build-time</strong></td>
<td><code>ENVIRONMENT</code>, <code>SERVICE_PORT</code>, <code>GCP_PROJECT_ID</code></td>
<td>DÃ¹ng trong CI/CD, xÃ¡c Ä‘á»‹nh behavior</td>
</tr>
<tr>
<td><strong>Runtime</strong></td>
<td><code>tenant_id</code>, <code>SMTP_PROVIDER_SECRET</code>, <code>ChannelCfg</code></td>
<td>Náº¡p Ä‘á»™ng tÃ¹y tenant hoáº·c request</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="8-kiem-thu">8. ğŸ§ª Kiá»ƒm thá»­<a class="headerlink" href="#8-kiem-thu" title="Permanent link">Â¶</a></h2>
<p>Viá»‡c kiá»ƒm thá»­ <code>notification-service/sub/</code> Ä‘Æ°á»£c chia thÃ nh 4 lá»›p chÃ­nh: <strong>Unit</strong>, <strong>Integration</strong>, <strong>Contract</strong>, vÃ  <strong>Security &amp; RBAC</strong>.
Táº¥t cáº£ cÃ¡c test Ä‘á»u cáº§n <strong>tá»± Ä‘á»™ng hÃ³a</strong> vÃ  Ä‘Æ°á»£c tÃ­ch há»£p vÃ o CI pipeline qua GitHub Actions (<code>adr-001</code>).</p>
<hr/>
<h3 id="81-unit-tests">8.1. ğŸ§ª Unit Tests<a class="headerlink" href="#81-unit-tests" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Má»¥c tiÃªu</th>
<th>Ná»™i dung kiá»ƒm thá»­</th>
</tr>
</thead>
<tbody>
<tr>
<td>Xá»­ lÃ½ sá»± kiá»‡n</td>
<td>Kiá»ƒm tra cÃ¡c nhÃ¡nh xá»­ lÃ½ khi nháº­n event: tÃ¬m tháº¥y template, khÃ´ng tÃ¬m tháº¥y, gá»­i thÃ nh cÃ´ng, gá»­i tháº¥t báº¡i</td>
</tr>
<tr>
<td>Gá»­i thÃ´ng bÃ¡o</td>
<td>Mock SMTP/SMS provider Ä‘á»ƒ kiá»ƒm tra logic gá»­i</td>
</tr>
<tr>
<td>Template rendering</td>
<td>XÃ¡c minh <code>params</code> render Ä‘Ãºng template hoáº·c lá»—i rÃµ rÃ ng khi thiáº¿u biáº¿n</td>
</tr>
<tr>
<td>Fallback logic</td>
<td>Kiá»ƒm tra khi channel chÃ­nh lá»—i, service fallback Ä‘Ãºng channel phá»¥</td>
</tr>
<tr>
<td>Logging logic</td>
<td>Log Ä‘Ãºng tráº¡ng thÃ¡i: <code>queued</code>, <code>sent</code>, <code>sent_fallback</code>, <code>failed</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>âœ… Tá»· lá»‡ coverage báº¯t buá»™c &gt; 80% (code coverage report tÃ­ch há»£p CI/CD)</p>
</blockquote>
<hr/>
<h3 id="82-integration-tests">8.2. ğŸ”„ Integration Tests<a class="headerlink" href="#82-integration-tests" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Táº§ng tÃ­ch há»£p</th>
<th>Ná»™i dung kiá»ƒm thá»­</th>
</tr>
</thead>
<tbody>
<tr>
<td>Vá»›i DB</td>
<td>Insert + query cÃ¡c báº£n ghi <code>NotificationLog</code>, <code>Template</code>, <code>ChannelCfg</code></td>
</tr>
<tr>
<td>Vá»›i Pub/Sub</td>
<td>Gá»­i giáº£ láº­p sá»± kiá»‡n <code>notification.triggered.v1</code> vÃ  xÃ¡c minh hÃ nh vi end-to-end</td>
</tr>
<tr>
<td>Vá»›i SMTP/SMS giáº£ láº­p</td>
<td>DÃ¹ng fake server Ä‘á»ƒ test luá»“ng gá»­i tháº­t (smtp4dev, httpbin)</td>
</tr>
<tr>
<td>Vá»›i Audit Service</td>
<td>Kiá»ƒm tra audit log gá»­i Ä‘i Ä‘Ãºng Ä‘á»‹nh dáº¡ng, Ä‘Ãºng action</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="83-contract-tests-theo-adr-010">8.3. ğŸ¤ Contract Tests (theo ADR-010)<a class="headerlink" href="#83-contract-tests-theo-adr-010" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ kiá»ƒm thá»­ giao diá»‡n (OpenAPI contract):</p>
<table>
<thead>
<tr>
<th>API</th>
<th>Kiá»ƒm thá»­</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET <code>/notifications/logs</code></td>
<td>Tráº£ Ä‘Ãºng Ä‘á»‹nh dáº¡ng <code>Envelope</code>, pagination</td>
</tr>
<tr>
<td>POST <code>/notifications/test</code></td>
<td>Gá»­i thá»­ thÃ nh cÃ´ng vÃ  lá»—i</td>
</tr>
<tr>
<td>GET <code>/notifications/templates</code></td>
<td>Tráº£ danh sÃ¡ch template theo tenant</td>
</tr>
</tbody>
</table>
<p>Sá»­ dá»¥ng:</p>
<ul>
<li><a href="https://github.com/stoplightio/prism">Prism</a> hoáº·c <a href="https://dredd.org">Dredd</a> Ä‘á»ƒ test OpenAPI spec</li>
<li>CI sáº½ <strong>fail náº¿u sai contract</strong> (vÃ­ dá»¥ Ä‘á»•i schema khÃ´ng bÃ¡o trÆ°á»›c)</li>
</ul>
<hr/>
<h3 id="84-rbac-security-tests">8.4. ğŸ›¡ï¸ RBAC &amp; Security Tests<a class="headerlink" href="#84-rbac-security-tests" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>TÃ¬nh huá»‘ng</th>
<th>Kiá»ƒm thá»­</th>
</tr>
</thead>
<tbody>
<tr>
<td>KhÃ´ng cÃ³ token</td>
<td>Bá»‹ tá»« chá»‘i truy cáº­p (<code>401</code>)</td>
</tr>
<tr>
<td>Token sai tenant</td>
<td>KhÃ´ng nhÃ¬n tháº¥y dá»¯ liá»‡u tenant khÃ¡c (<code>403</code>)</td>
</tr>
<tr>
<td>Thiáº¿u permission</td>
<td>Tráº£ lá»—i <code>403</code>, cÃ³ <code>error_code: permission_denied</code></td>
</tr>
<tr>
<td>CÃ³ Ä‘á»§ quyá»n</td>
<td>Truy cáº­p Ä‘Æ°á»£c API tÆ°Æ¡ng á»©ng</td>
</tr>
<tr>
<td>JWT expired</td>
<td>Tráº£ lá»—i <code>401</code> rÃµ rÃ ng</td>
</tr>
<tr>
<td>JWT khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng</td>
<td>Tráº£ <code>400</code> vá»›i mÃ£ lá»—i <code>invalid_token</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>âœ… Káº¿t quáº£ test pháº£i khá»›p vá»›i <code>error-codes.md</code> theo <code>ADR-011</code></p>
</blockquote>
<hr/>
<h3 id="85-o-luong-bao-cao">8.5. ğŸ“Š Äo lÆ°á»ng &amp; BÃ¡o cÃ¡o<a class="headerlink" href="#85-o-luong-bao-cao" title="Permanent link">Â¶</a></h3>
<ul>
<li>BÃ¡o cÃ¡o test coverage (<code>pytest-cov</code>, <code>jest</code>,...) gá»­i vá» CI/CD dashboard</li>
<li>
<p>Ghi rÃµ:</p>
</li>
<li>
<p>% coverage theo service/module</p>
</li>
<li>TÃªn test bá»‹ fail vÃ  lÃ½ do</li>
<li>Tá»± Ä‘á»™ng cháº¡y láº¡i test náº¿u xáº£y ra race condition do message queue</li>
</ul>
<hr/>
<h3 id="86-test-trong-moi-truong-staging">8.6. ğŸ§ª Test trong mÃ´i trÆ°á»ng staging<a class="headerlink" href="#86-test-trong-moi-truong-staging" title="Permanent link">Â¶</a></h3>
<p>Má»—i release trÆ°á»›c khi Ä‘Æ°a lÃªn production sáº½ Ä‘Æ°á»£c kiá»ƒm tra trong staging vá»›i:</p>
<table>
<thead>
<tr>
<th>MÃ´i trÆ°á»ng</th>
<th>Má»¥c tiÃªu</th>
</tr>
</thead>
<tbody>
<tr>
<td>DB Ä‘á»™c láº­p</td>
<td>KhÃ´ng áº£nh hÆ°á»Ÿng prod</td>
</tr>
<tr>
<td>Pub/Sub topic riÃªng</td>
<td>TrÃ¡nh tiÃªu thá»¥ nháº§m message tháº­t</td>
</tr>
<tr>
<td>SMTP test gateway</td>
<td>KhÃ´ng gá»­i tháº­t, cÃ³ log kiá»ƒm chá»©ng</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="9-giam-sat-audit">9. ğŸ“ˆ GiÃ¡m sÃ¡t &amp; Audit<a class="headerlink" href="#9-giam-sat-audit" title="Permanent link">Â¶</a></h2>
<h3 id="91-logging-ung-dung-gui-thong-bao">9.1. ğŸ” Logging (á»¨ng dá»¥ng &amp; Gá»­i thÃ´ng bÃ¡o)<a class="headerlink" href="#91-logging-ung-dung-gui-thong-bao" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Má»¥c tiÃªu</th>
<th>Chi tiáº¿t</th>
</tr>
</thead>
<tbody>
<tr>
<td>Má»©c log</td>
<td>DÃ¹ng cÃ¡c má»©c <code>info</code>, <code>warn</code>, <code>error</code>, <code>debug</code> Ä‘Ãºng chuáº©n</td>
</tr>
<tr>
<td>Tenant tagging</td>
<td>Má»—i log Ä‘á»u pháº£i Ä‘Ã­nh kÃ¨m <code>tenant_id</code>, <code>trace_id</code>, <code>event_id</code> náº¿u cÃ³</td>
</tr>
<tr>
<td>NhÃ¢n sá»± kiá»‡n</td>
<td>Log rÃµ event nháº­n Ä‘Æ°á»£c, template Ã¡p dá»¥ng, hÃ nh vi gá»­i</td>
</tr>
<tr>
<td>Tháº¥t báº¡i</td>
<td>Log lÃ½ do lá»—i gá»­i (<code>SMTP timeout</code>, <code>invalid recipient</code>, v.v.)</td>
</tr>
<tr>
<td>Fallback</td>
<td>Ghi nháº­n náº¿u gá»­i qua fallback channel</td>
</tr>
<tr>
<td>Log Ä‘á»‹nh dáº¡ng</td>
<td>JSON log structure, tuÃ¢n chuáº©n <code>12-factor app</code> Ä‘á»ƒ dá»… gá»­i sang ELK/Grafana/Loki</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="92-metrics-prometheus-opentelemetry">9.2. ğŸ“Š Metrics (Prometheus / OpenTelemetry)<a class="headerlink" href="#92-metrics-prometheus-opentelemetry" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Kiá»ƒu</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>notif_event_received_total</code></td>
<td>Counter</td>
<td>Tá»•ng sá»‘ event <code>notification.triggered</code> Ä‘Ã£ nháº­n</td>
</tr>
<tr>
<td><code>notif_sent_success_total</code></td>
<td>Counter</td>
<td>Sá»‘ lÆ°á»£ng gá»­i thÃ nh cÃ´ng qua channel chÃ­nh</td>
</tr>
<tr>
<td><code>notif_sent_failed_total</code></td>
<td>Counter</td>
<td>Sá»‘ lÆ°á»£ng gá»­i tháº¥t báº¡i hoÃ n toÃ n</td>
</tr>
<tr>
<td><code>notif_sent_fallback_total</code></td>
<td>Counter</td>
<td>Sá»‘ lÆ°á»£ng gá»­i qua fallback</td>
</tr>
<tr>
<td><code>notif_delivery_duration_ms</code></td>
<td>Histogram</td>
<td>Thá»i gian tá»« lÃºc nháº­n event Ä‘áº¿n khi gá»­i xong</td>
</tr>
<tr>
<td><code>notif_queue_size</code></td>
<td>Gauge</td>
<td>Sá»‘ lÆ°á»£ng event Ä‘ang chá» xá»­ lÃ½ trong hÃ ng Ä‘á»£i ná»™i bá»™ (náº¿u dÃ¹ng buffer)</td>
</tr>
<tr>
<td><code>notif_db_latency_ms</code></td>
<td>Histogram</td>
<td>Latency khi truy cáº­p CSDL</td>
</tr>
<tr>
<td><code>notif_config_load_errors_total</code></td>
<td>Counter</td>
<td>Sá»‘ lá»—i náº¡p config channel/template khÃ´ng há»£p lá»‡</td>
</tr>
</tbody>
</table>
<blockquote>
<p>âœ… Táº¥t cáº£ metric Ä‘á»u Ä‘Æ°á»£c <strong>gáº¯n nhÃ£n (<code>labels</code>)</strong> gá»“m <code>tenant_id</code>, <code>channel</code>, <code>status</code>, <code>template_id</code> náº¿u cÃ³.</p>
</blockquote>
<hr/>
<h3 id="93-slo-alerting">9.3. ğŸ¯ SLO &amp; Alerting<a class="headerlink" href="#93-slo-alerting" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ <code>ADR-022</code> â€“ thiáº¿t láº­p SLO cho service:</p>
<table>
<thead>
<tr>
<th>Má»¥c tiÃªu</th>
<th>SLO</th>
<th>Alert khi</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tá»· lá»‡ gá»­i thÃ nh cÃ´ng</td>
<td>â‰¥ 99%</td>
<td>Trong 5 phÃºt, tá»‰ lá»‡ tháº¥t báº¡i &gt; 5%</td>
</tr>
<tr>
<td>Äá»™ trá»… xá»­ lÃ½</td>
<td>&lt; 2s</td>
<td>Äá»™ trá»… gá»­i &gt; 5s vá»›i &gt;10% notification</td>
</tr>
<tr>
<td>Lá»—i template</td>
<td>0</td>
<td>CÃ³ báº¥t ká»³ lá»—i render hoáº·c thiáº¿u template</td>
</tr>
<tr>
<td>KhÃ´ng cÃ³ log</td>
<td>&lt; 1 min</td>
<td>KhÃ´ng cÃ³ event má»›i Ä‘Æ°á»£c nháº­n trong â‰¥ 5 phÃºt (prod)</td>
</tr>
</tbody>
</table>
<blockquote>
<p>âœ… Alert Ä‘Æ°á»£c gá»­i vá» Email/Slack qua Alertmanager hoáº·c Grafana OnCall.</p>
</blockquote>
<hr/>
<h3 id="94-audit-log-tuan-thu-adr-008">9.4. ğŸ“ Audit Log (tuÃ¢n thá»§ ADR-008)<a class="headerlink" href="#94-audit-log-tuan-thu-adr-008" title="Permanent link">Â¶</a></h3>
<p>CÃ¡c hÃ nh vi cáº§n audit:</p>
<table>
<thead>
<tr>
<th>HÃ nh vi</th>
<th><code>x-audit-action</code></th>
<th>Ná»™i dung cáº§n log</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gá»­i notification</td>
<td><code>notification.sent</code></td>
<td>event_id, channel, status, template_id, recipient (masked), actor</td>
</tr>
<tr>
<td>Gá»­i thá»­</td>
<td><code>notification.test_sent</code></td>
<td>test_target, actor</td>
</tr>
<tr>
<td>Cáº­p nháº­t channel</td>
<td><code>notification.config.updated</code></td>
<td>diff config, actor, time</td>
</tr>
<tr>
<td>Cáº­p nháº­t template</td>
<td><code>notification.template.updated</code></td>
<td>diff content, actor, trace_id</td>
</tr>
</tbody>
</table>
<ul>
<li>Audit log Ä‘Æ°á»£c Ä‘áº©y async tá»›i <code>audit-logging-service</code> qua HTTP ná»™i bá»™.</li>
<li>Log pháº£i chá»©a: <code>actor_id</code>, <code>tenant_id</code>, <code>trace_id</code>, <code>action</code>, <code>timestamp</code>, <code>details</code>.</li>
</ul>
<hr/>
<h3 id="95-tracing-opentelemetry">9.5. ğŸ” Tracing (OpenTelemetry)<a class="headerlink" href="#95-tracing-opentelemetry" title="Permanent link">Â¶</a></h3>
<p>TÃ­ch há»£p <strong>OpenTelemetry</strong> Ä‘á»ƒ trace xuyÃªn suá»‘t hÃ nh trÃ¬nh notification:</p>
<table>
<thead>
<tr>
<th>Trace span</th>
<th>Ghi nháº­n</th>
</tr>
</thead>
<tbody>
<tr>
<td>Nháº­n event</td>
<td>timestamp nháº­n, message size</td>
</tr>
<tr>
<td>TÃ¬m template</td>
<td>lookup time, cache hit/miss</td>
</tr>
<tr>
<td>Gá»­i email/SMS</td>
<td>duration, result</td>
</tr>
<tr>
<td>Log cáº­p nháº­t</td>
<td>DB write status</td>
</tr>
</tbody>
</table>
<p>Táº¥t cáº£ trace Ä‘Æ°á»£c gáº¯n vá»›i <code>trace_id</code> gá»‘c tá»« sá»± kiá»‡n.
Dá»¯ liá»‡u gá»­i vá» <code>OTEL Collector</code> â†’ <code>Grafana Tempo</code> hoáº·c <code>Jaeger</code>.</p>
<hr/>
<h2 id="10-trien-khai-migration">10. ğŸš€ Triá»ƒn khai &amp; Migration<a class="headerlink" href="#10-trien-khai-migration" title="Permanent link">Â¶</a></h2>
<h3 id="101-chien-luoc-trien-khai">10.1. ğŸ§­ Chiáº¿n lÆ°á»£c triá»ƒn khai<a class="headerlink" href="#101-chien-luoc-trien-khai" title="Permanent link">Â¶</a></h3>
<p>Viá»‡c triá»ƒn khai <code>notification-service/sub/</code> Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ <strong>Ä‘áº£m báº£o Zero Downtime</strong> theo <code>ADR-014</code> vá»›i cÃ¡c Ä‘áº·c Ä‘iá»ƒm:</p>
<table>
<thead>
<tr>
<th>Yáº¿u tá»‘</th>
<th>Chi tiáº¿t</th>
</tr>
</thead>
<tbody>
<tr>
<td>MÃ´ hÃ¬nh deploy</td>
<td>Container-based (Docker)</td>
</tr>
<tr>
<td>PhÃ¢n phá»‘i</td>
<td>Triá»ƒn khai theo tenant hoáº·c cá»¥m tenant, cÃ³ thá»ƒ dÃ¹ng K8s namespace tÃ¡ch biá»‡t</td>
</tr>
<tr>
<td>Quáº£n lÃ½ phiÃªn báº£n</td>
<td>Image versioning theo tag <code>vas-notif-sub:v1.x.x</code></td>
</tr>
<tr>
<td>Triá»ƒn khai xanh/xÃ¡m</td>
<td>Há»— trá»£ blue-green vÃ  rolling update</td>
</tr>
<tr>
<td>Healthcheck</td>
<td>TuÃ¢n theo <code>/healthz</code>, <code>/readyz</code> cho liveness vÃ  readiness probe</td>
</tr>
<tr>
<td>Quáº£n lÃ½ bÃ­ máº­t</td>
<td>Inject qua secret manager hoáº·c volume mount (<code>ADR-003</code>)</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="102-moi-truong-ranh-gioi-trien-khai-theo-adr-017">10.2. â˜ï¸ MÃ´i trÆ°á»ng &amp; ranh giá»›i triá»ƒn khai (theo ADR-017)<a class="headerlink" href="#102-moi-truong-ranh-gioi-trien-khai-theo-adr-017" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>MÃ´i trÆ°á»ng</th>
<th>Má»¥c Ä‘Ã­ch</th>
<th>Ranh giá»›i</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dev</code></td>
<td>PhÃ¡t triá»ƒn</td>
<td>CÃ³ thá»ƒ chia sáº» DB + PubSub vá»›i team khÃ¡c</td>
</tr>
<tr>
<td><code>staging</code></td>
<td>Tiá»n sáº£n xuáº¥t</td>
<td>Má»—i tenant cháº¡y instance Ä‘á»™c láº­p</td>
</tr>
<tr>
<td><code>prod</code></td>
<td>Váº­n hÃ nh tháº­t</td>
<td>Má»—i tenant production cÃ³ cluster riÃªng (hoáº·c namespace riÃªng)</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ğŸ” Cáº¥u hÃ¬nh <code>ENVIRONMENT</code> sáº½ áº£nh hÆ°á»Ÿng Ä‘áº¿n behavior gá»­i tháº­t hay giáº£ (vÃ­ dá»¥: <code>smtp-sandbox</code> trong dev)</p>
</blockquote>
<hr/>
<h3 id="103-tu-ong-hoa-trien-khai-cicd">10.3. ğŸš€ Tá»± Ä‘á»™ng hÃ³a triá»ƒn khai (CI/CD)<a class="headerlink" href="#103-tu-ong-hoa-trien-khai-cicd" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ <code>ADR-001</code>:</p>
<table>
<thead>
<tr>
<th>BÆ°á»›c</th>
<th>CÃ´ng cá»¥</th>
</tr>
</thead>
<tbody>
<tr>
<td>Build Docker image</td>
<td><code>Dockerfile</code> chuáº©n hÃ³a</td>
</tr>
<tr>
<td>Push lÃªn registry</td>
<td>GitHub Actions / GitLab CI</td>
</tr>
<tr>
<td>Deploy staging</td>
<td>Helm / ArgoCD</td>
</tr>
<tr>
<td>Run post-deploy tests</td>
<td><code>pytest</code> hoáº·c <code>dredd</code> (contract test)</td>
</tr>
<tr>
<td>Notify káº¿t quáº£</td>
<td>Slack webhook / GitHub Status</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="104-migration-du-lieu-schema-du-lieu">10.4. ğŸ“¥ Migration dá»¯ liá»‡u (schema &amp; dá»¯ liá»‡u)<a class="headerlink" href="#104-migration-du-lieu-schema-du-lieu" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ <code>ADR-023 â€“ Schema Migration Strategy</code></p>
<table>
<thead>
<tr>
<th>Báº£ng áº£nh hÆ°á»Ÿng</th>
<th>Chi tiáº¿t</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NotificationTemplate</code></td>
<td>Dá»¯ liá»‡u máº·c Ä‘á»‹nh cho tá»«ng <code>event_code</code> cÃ³ thá»ƒ seed khi khá»Ÿi táº¡o tenant</td>
</tr>
<tr>
<td><code>NotificationLog</code></td>
<td>KhÃ´ng migration, táº¡o má»›i tá»«ng dÃ²ng</td>
</tr>
<tr>
<td><code>NotificationChannelCfg</code></td>
<td>TÃ¹y tenant, cÃ³ thá»ƒ import tá»« file cáº¥u hÃ¬nh YAML hoáº·c JSON</td>
</tr>
</tbody>
</table>
<h4 id="cong-cu-goi-y">CÃ´ng cá»¥ gá»£i Ã½<a class="headerlink" href="#cong-cu-goi-y" title="Permanent link">Â¶</a></h4>
<ul>
<li>Quáº£n lÃ½ migration: <code>Alembic</code> hoáº·c <code>Sqlx</code> (náº¿u dÃ¹ng Python / Go)</li>
<li>Kiá»ƒm tra forward/backward compatibility: <code>schemachange</code> hoáº·c <code>sqldiff</code></li>
</ul>
<hr/>
<h3 id="105-rollback-strategy">10.5. â›‘ï¸ Rollback strategy<a class="headerlink" href="#105-rollback-strategy" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>TrÆ°á»ng há»£p lá»—i</th>
<th>HÃ nh Ä‘á»™ng rollback</th>
</tr>
</thead>
<tbody>
<tr>
<td>Service fail khá»Ÿi Ä‘á»™ng</td>
<td>Rollback image vá» phiÃªn báº£n cÅ©</td>
</tr>
<tr>
<td>DB migration gÃ¢y lá»—i</td>
<td>Rollback báº±ng <code>downgrade</code> script</td>
</tr>
<tr>
<td>Audit log máº¥t káº¿t ná»‘i</td>
<td>Chuyá»ƒn sang log file táº¡m thá»i (buffered log)</td>
</tr>
<tr>
<td>SMTP lá»—i toÃ n cá»¥c</td>
<td>Báº­t cháº¿ Ä‘á»™ <code>dry-run</code> táº¡m thá»i Ä‘á»ƒ khÃ´ng máº¥t log</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="106-checklist-truoc-production">10.6. ğŸ“‹ Checklist trÆ°á»›c production<a class="headerlink" href="#106-checklist-truoc-production" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Má»¥c</th>
<th>XÃ¡c nháº­n</th>
</tr>
</thead>
<tbody>
<tr>
<td>[ ] ÄÃ£ kiá»ƒm tra healthcheck hoáº¡t Ä‘á»™ng</td>
<td>âœ…</td>
</tr>
<tr>
<td>[ ] Metrics cÃ³ hiá»ƒn thá»‹ trÃªn Grafana</td>
<td>âœ…</td>
</tr>
<tr>
<td>[ ] Log gá»­i Ä‘Ãºng audit format</td>
<td>âœ…</td>
</tr>
<tr>
<td>[ ] Tenant cÃ³ config riÃªng Ä‘áº§y Ä‘á»§</td>
<td>âœ…</td>
</tr>
<tr>
<td>[ ] Thá»­ rollback khÃ´ng máº¥t dá»¯ liá»‡u</td>
<td>âœ…</td>
</tr>
<tr>
<td>[ ] Alert hoáº¡t Ä‘á»™ng Ä‘Ãºng</td>
<td>âœ…</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="11-kien-truc-noi-bo">11. ğŸ§© Kiáº¿n trÃºc ná»™i bá»™<a class="headerlink" href="#11-kien-truc-noi-bo" title="Permanent link">Â¶</a></h2>
<h3 id="111-muc-tieu-phan-lop">11.1. Má»¥c tiÃªu phÃ¢n lá»›p<a class="headerlink" href="#111-muc-tieu-phan-lop" title="Permanent link">Â¶</a></h3>
<p>Há»‡ thá»‘ng Ä‘Æ°á»£c thiáº¿t káº¿ theo hÆ°á»›ng <strong>module hÃ³a rÃµ rÃ ng</strong>, tÃ¡ch biá»‡t theo chá»©c nÄƒng Ä‘á»ƒ dá»… dÃ ng má»Ÿ rá»™ng, kiá»ƒm thá»­ vÃ  báº£o trÃ¬.</p>
<table>
<thead>
<tr>
<th>Lá»›p</th>
<th>TrÃ¡ch nhiá»‡m</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>consumer</code></td>
<td>Láº¯ng nghe vÃ  xá»­ lÃ½ sá»± kiá»‡n tá»« Pub/Sub hoáº·c message queue</td>
</tr>
<tr>
<td><code>processor</code></td>
<td>Thá»±c thi nghiá»‡p vá»¥ gá»­i thÃ´ng bÃ¡o: tra template, render, gá»­i, fallback</td>
</tr>
<tr>
<td><code>notifier</code></td>
<td>Adapter gá»­i thÃ´ng bÃ¡o thá»±c táº¿ (SMTP, SMS, Push...)</td>
</tr>
<tr>
<td><code>repository</code></td>
<td>Truy xuáº¥t &amp; ghi dá»¯ liá»‡u tá»«/Ä‘áº¿n Postgres</td>
</tr>
<tr>
<td><code>config</code></td>
<td>Táº£i &amp; cache cáº¥u hÃ¬nh riÃªng cho tá»«ng tenant</td>
</tr>
<tr>
<td><code>audit</code></td>
<td>Gá»­i log kiá»ƒm toÃ¡n (náº¿u Ä‘Æ°á»£c báº­t)</td>
</tr>
<tr>
<td><code>api</code></td>
<td>Cung cáº¥p API ná»™i bá»™ cho viá»‡c kiá»ƒm tra, gá»­i thá»­, quáº£n trá»‹ template</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="112-so-o-luong-xu-ly-noi-bo">11.2. SÆ¡ Ä‘á»“ luá»“ng xá»­ lÃ½ ná»™i bá»™<a class="headerlink" href="#112-so-o-luong-xu-ly-noi-bo" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>flowchart TD
    PubSub[Event Listener]
    PubSub --&gt; Parser[Parse + Validate Event]
    Parser --&gt; TemplateLookup[Lookup Template]
    TemplateLookup --&gt; RenderEngine[Render Template]
    RenderEngine --&gt; Notifier[Send Notification]
    Notifier --&gt; Audit[Log Audit]
    Notifier --&gt; LogWriter[Ghi NotificationLog]

    subgraph Modules
      TemplateLookup
      RenderEngine
      Notifier
      Audit
      LogWriter
    end
</code></pre>
<hr/>
<h3 id="113-phan-tich-module-chinh">11.3. PhÃ¢n tÃ­ch module chÃ­nh<a class="headerlink" href="#113-phan-tich-module-chinh" title="Permanent link">Â¶</a></h3>
<h4 id="consumer">ğŸ§© <code>consumer/</code><a class="headerlink" href="#consumer" title="Permanent link">Â¶</a></h4>
<ul>
<li>Nháº­n sá»± kiá»‡n tá»« Pub/Sub</li>
<li>Parse &amp; validate schema (tuÃ¢n theo <code>ADR-030</code>)</li>
<li>Báº¯t Ä‘áº§u trace (<code>trace_id</code>)</li>
<li>Gá»­i vÃ o <code>processor</code></li>
</ul>
<h4 id="processor">ğŸ§© <code>processor/</code><a class="headerlink" href="#processor" title="Permanent link">Â¶</a></h4>
<ul>
<li>Truy cáº­p <code>tenant_id</code> Ä‘á»ƒ load cáº¥u hÃ¬nh (<code>config/</code>)</li>
<li>Gá»i <code>template_repository</code> Ä‘á»ƒ tÃ¬m template khá»›p <code>event_code</code> + <code>channel</code></li>
<li>Render ná»™i dung</li>
<li>Gá»i <code>notifier/</code> Ä‘á»ƒ gá»­i Ä‘i</li>
<li>Ghi log + fallback náº¿u tháº¥t báº¡i</li>
<li>Gá»­i log audit náº¿u báº­t</li>
</ul>
<h4 id="notifier">ğŸ§© <code>notifier/</code><a class="headerlink" href="#notifier" title="Permanent link">Â¶</a></h4>
<ul>
<li>
<p>CÃ³ cÃ¡c adapter theo kÃªnh:</p>
</li>
<li>
<p><code>notifier/email.py</code></p>
</li>
<li><code>notifier/sms.py</code></li>
<li><code>notifier/push.py</code> <em>(chÆ°a triá»ƒn khai)</em></li>
<li>Giao diá»‡n thá»‘ng nháº¥t: <code>send(recipient, content, config)</code></li>
</ul>
<h4 id="repository">ğŸ§© <code>repository/</code><a class="headerlink" href="#repository" title="Permanent link">Â¶</a></h4>
<ul>
<li>Truy cáº­p Postgres: báº£ng <code>NotificationLog</code>, <code>Template</code>, <code>ChannelCfg</code></li>
<li>ÄÆ°á»£c mock dá»… dÃ ng trong test</li>
</ul>
<h4 id="config">ğŸ§© <code>config/</code><a class="headerlink" href="#config" title="Permanent link">Â¶</a></h4>
<ul>
<li>Load cáº¥u hÃ¬nh theo <code>tenant_id</code> tá»« Secret Manager / mount path</li>
<li>CÃ³ cÆ¡ cháº¿ cache ná»™i bá»™ (TTL: 5 phÃºt)</li>
<li>Tá»± invalid cache khi cÃ³ sá»± kiá»‡n <code>config.updated</code></li>
</ul>
<h4 id="audit">ğŸ§© <code>audit/</code><a class="headerlink" href="#audit" title="Permanent link">Â¶</a></h4>
<ul>
<li>Táº¡o cáº¥u trÃºc audit log (tuÃ¢n theo <code>ADR-008</code>)</li>
<li>Gá»­i async sang <code>audit-logging-service</code></li>
</ul>
<h4 id="api">ğŸ§© <code>api/</code><a class="headerlink" href="#api" title="Permanent link">Â¶</a></h4>
<ul>
<li>
<p>Expose REST API ná»™i bá»™:</p>
</li>
<li>
<p><code>GET /notifications/logs</code></p>
</li>
<li><code>POST /notifications/test</code></li>
<li><code>GET /notifications/templates</code></li>
</ul>
<hr/>
<h3 id="114-logging-tracing-luong-noi-bo">11.4. Logging &amp; Tracing luá»“ng ná»™i bá»™<a class="headerlink" href="#114-logging-tracing-luong-noi-bo" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»—i bÆ°á»›c trong luá»“ng xá»­ lÃ½ Ä‘á»u táº¡o 1 span náº¿u dÃ¹ng OpenTelemetry</li>
<li>
<p>ToÃ n bá»™ log theo chuáº©n JSON vÃ  Ä‘Ã­nh kÃ¨m:</p>
</li>
<li>
<p><code>tenant_id</code></p>
</li>
<li><code>event_id</code></li>
<li><code>trace_id</code></li>
<li><code>template_id</code></li>
<li><code>channel</code></li>
</ul>
<hr/>
<h3 id="115-kha-nang-mo-rong-plugin">11.5. Kháº£ nÄƒng má»Ÿ rá»™ng &amp; plugin<a class="headerlink" href="#115-kha-nang-mo-rong-plugin" title="Permanent link">Â¶</a></h3>
<p>Há»‡ thá»‘ng cÃ³ thá»ƒ dá»… dÃ ng má»Ÿ rá»™ng thÃªm kÃªnh gá»­i má»›i:</p>
<table>
<thead>
<tr>
<th>KÃªnh má»›i</th>
<th>CÃ¡ch má»Ÿ rá»™ng</th>
</tr>
</thead>
<tbody>
<tr>
<td>Zalo</td>
<td>ThÃªm <code>notifier/zalo.py</code> vá»›i hÃ m <code>send(...)</code></td>
</tr>
<tr>
<td>App Notification</td>
<td>TÃ­ch há»£p Firebase, dÃ¹ng chung pipeline</td>
</tr>
<tr>
<td>TÆ°Æ¡ng tÃ¡c voice</td>
<td>Káº¿t ná»‘i Twilio hoáº·c WebRTC SDK</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="12-tai-lieu-lien-quan">12. ğŸ“š TÃ i liá»‡u liÃªn quan<a class="headerlink" href="#12-tai-lieu-lien-quan" title="Permanent link">Â¶</a></h2>
<ul>
<li><a href="../interface-contract/">Interface Contract</a></li>
<li><a href="../data-model/">Data Model</a></li>
<li><a href="../openapi.yaml">OpenAPI Spec</a></li>
<li><a href="../../../../ADR/adr-007-rbac/">ADR-007 â€“ RBAC Strategy</a></li>
<li><a href="../../../../ADR/adr-008-audit-logging/">ADR-008 â€“ Audit Logging</a></li>
<li><a href="../../../../ADR/adr-030-event-schema-governance/">ADR-030 â€“ Event Schema Governance</a></li>
<li><a href="../../../requests/04-cr-tenant-system.md">Change Request 04 â€“ Tenant Isolation</a></li>
<li><a href="../../../../">README.md â€“ System Overview</a></li>
<li><a href="../../../../architecture/rbac-deep-dive/">RBAC Deep Dive</a></li>
<li><a href="../../../../architecture/system-diagrams/">System Diagram</a></li>
</ul>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Trá»Ÿ láº¡i má»¥c lá»¥c
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>