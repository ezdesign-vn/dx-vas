
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="TÃ i liá»‡u kiáº¿n trÃºc vÃ  phÃ¡t triá»ƒn cho dá»± Ã¡n Chuyá»ƒn Ä‘á»•i sá»‘ TrÆ°á»ng Viá»‡t Anh." name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://ezdesign-vn.github.io/dx-vas/services/audit-logging-service/design/" rel="canonical"/>
<link href="../../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Thiáº¿t káº¿ chi tiáº¿t Audit Logging Service - DX VAS - Docs</title>
<link href="../../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#thiet-ke-chi-tiet-audit-logging-service">
          Bá» qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Äáº§u trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Thiáº¿t káº¿ chi tiáº¿t Audit Logging Service
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="TÃ¬m kiáº¿m" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="TÃ¬m kiáº¿m" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="TÃ¬m kiáº¿m" class="md-search__options">
<button aria-label="XoÃ¡" class="md-search__icon md-icon" tabindex="-1" title="XoÃ¡" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../architecture/system-diagrams/">
          
  
  
    
  
  Kiáº¿n trÃºc Há»‡ thá»‘ng

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../dev-guide/">
        
  
  
    
  
  HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../">
        
  
  
    
  
  Thiáº¿t káº¿ Services

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../ADR/">
          
  
  
    
  
  Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh Ä‘iá»u hÆ°á»›ng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Kiáº¿n trÃºc Há»‡ thá»‘ng
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Kiáº¿n trÃºc Há»‡ thá»‘ng
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/system-diagrams/">
<span class="md-ellipsis">
    SÆ¡ Ä‘á»“ Há»‡ thá»‘ng
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/rbac-deep-dive/">
<span class="md-ellipsis">
    RBAC Chi tiáº¿t
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../dev-guide/">
<span class="md-ellipsis">
    HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    Thiáº¿t káº¿ Services
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ADR/">
<span class="md-ellipsis">
    Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Má»¥c lá»¥c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Má»¥c lá»¥c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-pham-vi-va-trach-nhiem-scope-responsibilities">
<span class="md-ellipsis">
      1. ğŸ§­ Pháº¡m vi vÃ  TrÃ¡ch nhiá»‡m (Scope &amp; Responsibilities)
    </span>
</a>
<nav aria-label="1. ğŸ§­ Pháº¡m vi vÃ  TrÃ¡ch nhiá»‡m (Scope &amp; Responsibilities)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#11-muc-tieu">
<span class="md-ellipsis">
      1.1. ğŸ¯ Má»¥c tiÃªu
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-trach-nhiem-chinh">
<span class="md-ellipsis">
      1.2. ğŸ“Œ TrÃ¡ch nhiá»‡m chÃ­nh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#13-ngoai-pham-vi-out-of-scope">
<span class="md-ellipsis">
      1.3. âŒ NgoÃ i pháº¡m vi (Out of Scope)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#14-nguoi-dung-va-client">
<span class="md-ellipsis">
      1.4. ğŸ‘¥ NgÆ°á»i dÃ¹ng vÃ  client
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-kien-truc-noi-bo-internal-architecture">
<span class="md-ellipsis">
      2. ğŸ§± Kiáº¿n trÃºc ná»™i bá»™ (Internal Architecture)
    </span>
</a>
<nav aria-label="2. ğŸ§± Kiáº¿n trÃºc ná»™i bá»™ (Internal Architecture)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#21-tong-quan">
<span class="md-ellipsis">
      2.1. ğŸ§  Tá»•ng quan
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#22-cac-thanh-phan-chinh">
<span class="md-ellipsis">
      2.2. ğŸ—ï¸ CÃ¡c thÃ nh pháº§n chÃ­nh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#23-flow-xu-ly-tong-quat">
<span class="md-ellipsis">
      2.3. ğŸ” Flow xá»­ lÃ½ tá»•ng quÃ¡t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#24-bao-mat-noi-bo">
<span class="md-ellipsis">
      2.4. ğŸ”’ Báº£o máº­t ná»™i bá»™
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#25-trien-khai-va-mo-rong">
<span class="md-ellipsis">
      2.5. âš™ï¸ Triá»ƒn khai vÃ  Má»Ÿ rá»™ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#26-lien-ket-adr-va-kien-truc">
<span class="md-ellipsis">
      2.6. ğŸ“Œ LiÃªn káº¿t ADR vÃ  Kiáº¿n trÃºc
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-mo-hinh-du-lieu-data-model">
<span class="md-ellipsis">
      3. ğŸ§© MÃ´ hÃ¬nh Dá»¯ liá»‡u (Data Model)
    </span>
</a>
<nav aria-label="3. ğŸ§© MÃ´ hÃ¬nh Dá»¯ liá»‡u (Data Model)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#31-bang-chinh-audit_logs">
<span class="md-ellipsis">
      3.1. ğŸ“Œ Báº£ng chÃ­nh: audit_logs
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#32-quy-tac-bao-mat-masking-du-lieu">
<span class="md-ellipsis">
      3.2. ğŸ”’ Quy táº¯c Báº£o máº­t &amp; Masking Dá»¯ liá»‡u
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#33-chinh-sach-luu-tru-va-phan-vung-bigquery">
<span class="md-ellipsis">
      3.3. â³ ChÃ­nh sÃ¡ch lÆ°u trá»¯ vÃ  phÃ¢n vÃ¹ng (BigQuery)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#34-cac-chi-muc-va-truy-van-ien-hinh">
<span class="md-ellipsis">
      3.4. ğŸ” CÃ¡c chá»‰ má»¥c vÃ  truy váº¥n Ä‘iá»ƒn hÃ¬nh
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-luong-nghiep-vu-chinh-main-flow">
<span class="md-ellipsis">
      4. ğŸ”„ Luá»“ng nghiá»‡p vá»¥ chÃ­nh (Main Flow)
    </span>
</a>
<nav aria-label="4. ğŸ”„ Luá»“ng nghiá»‡p vá»¥ chÃ­nh (Main Flow)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#41-luong-1-nhan-su-kien-log-qua-pubsub-auditeventsv1">
<span class="md-ellipsis">
      4.1. ğŸ” Luá»“ng 1: Nháº­n sá»± kiá»‡n log qua Pub/Sub (audit.events.v1)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#42-luong-2-ghi-log-truc-tiep-qua-http-api-chi-noi-bo">
<span class="md-ellipsis">
      4.2. ğŸ” Luá»“ng 2: Ghi log trá»±c tiáº¿p qua HTTP API (chá»‰ ná»™i bá»™)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#43-luong-3-truy-van-audit-log-tu-webapp-hoac-devops">
<span class="md-ellipsis">
      4.3. ğŸ§  Luá»“ng 3: Truy váº¥n Audit Log tá»« WebApp hoáº·c DevOps
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#44-cac-hanh-ong-pho-bien-uoc-log">
<span class="md-ellipsis">
      4.4. ğŸ§© CÃ¡c hÃ nh Ä‘á»™ng phá»• biáº¿n Ä‘Æ°á»£c log
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-tuong-tac-voi-cac-service-khac-luong-su-kien">
<span class="md-ellipsis">
      5. ğŸ“£ TÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c Service khÃ¡c &amp; Luá»“ng sá»± kiá»‡n
    </span>
</a>
<nav aria-label="5. ğŸ“£ TÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c Service khÃ¡c &amp; Luá»“ng sá»± kiá»‡n" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-tuong-tac-ong-bo-http">
<span class="md-ellipsis">
      5.1. ğŸ” TÆ°Æ¡ng tÃ¡c Ä‘á»“ng bá»™ (HTTP)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-lang-nghe-su-kien-pubsub">
<span class="md-ellipsis">
      5.2. ğŸ“¥ Láº¯ng nghe sá»± kiá»‡n (Pub/Sub)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-phat-su-kien-thu-cap-tuy-chon">
<span class="md-ellipsis">
      5.3. ğŸ“¤ PhÃ¡t sá»± kiá»‡n thá»© cáº¥p (tÃ¹y chá»n)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-bao-mat-phan-quyen">
<span class="md-ellipsis">
      6. ğŸ” Báº£o máº­t &amp; PhÃ¢n quyá»n
    </span>
</a>
<nav aria-label="6. ğŸ” Báº£o máº­t &amp; PhÃ¢n quyá»n" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-xac-thuc-authentication">
<span class="md-ellipsis">
      6.1. ğŸ”‘ XÃ¡c thá»±c (Authentication)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-phan-quyen-authorization-rbac">
<span class="md-ellipsis">
      6.2. ğŸ§­ PhÃ¢n quyá»n (Authorization â€“ RBAC)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-bao-ve-du-lieu-data-protection">
<span class="md-ellipsis">
      6.3. ğŸ”’ Báº£o vá»‡ dá»¯ liá»‡u (Data Protection)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-giam-sat-va-bao-ve-runtime">
<span class="md-ellipsis">
      6.4. ğŸš¨ GiÃ¡m sÃ¡t vÃ  báº£o vá»‡ runtime
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-cau-hinh-trien-khai-configuration-deployment">
<span class="md-ellipsis">
      7. âš™ï¸ Cáº¥u hÃ¬nh &amp; Triá»ƒn khai (Configuration &amp; Deployment)
    </span>
</a>
<nav aria-label="7. âš™ï¸ Cáº¥u hÃ¬nh &amp; Triá»ƒn khai (Configuration &amp; Deployment)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-mo-hinh-trien-khai">
<span class="md-ellipsis">
      7.1. ğŸ§± MÃ´ hÃ¬nh triá»ƒn khai
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-bien-moi-truong-chinh-tuan-theo-adr-005">
<span class="md-ellipsis">
      7.2. âš™ï¸ Biáº¿n mÃ´i trÆ°á»ng chÃ­nh (TuÃ¢n theo ADR-005)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-trien-khai-cicd-tuan-thu-adr-001-adr-014">
<span class="md-ellipsis">
      7.3. ğŸš€ Triá»ƒn khai CI/CD (TuÃ¢n thá»§ ADR-001 &amp; ADR-014)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-chien-luoc-autoscaling-adr-016">
<span class="md-ellipsis">
      7.4. ğŸ“ˆ Chiáº¿n lÆ°á»£c Autoscaling (ADR-016)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#75-luu-tru-quan-ly-du-lieu-adr-027">
<span class="md-ellipsis">
      7.5. ğŸ“¦ LÆ°u trá»¯ &amp; Quáº£n lÃ½ dá»¯ liá»‡u (ADR-027)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#76-chinh-sach-xoa-du-lieu-hard-delete">
<span class="md-ellipsis">
      7.6. ğŸ“Œ ChÃ­nh sÃ¡ch xoÃ¡ dá»¯ liá»‡u (Hard Delete)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#77-cau-hinh-lien-quan-en-phat-su-kien">
<span class="md-ellipsis">
      7.7. Cáº¥u hÃ¬nh liÃªn quan Ä‘áº¿n phÃ¡t sá»± kiá»‡n
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-chien-luoc-kiem-thu-testing-strategy">
<span class="md-ellipsis">
      8. ğŸ§ª Chiáº¿n lÆ°á»£c Kiá»ƒm thá»­ (Testing Strategy)
    </span>
</a>
<nav aria-label="8. ğŸ§ª Chiáº¿n lÆ°á»£c Kiá»ƒm thá»­ (Testing Strategy)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-unit-tests">
<span class="md-ellipsis">
      8.1. âœ… Unit Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-integration-tests">
<span class="md-ellipsis">
      8.2. ğŸ” Integration Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-contract-testing-adr-010">
<span class="md-ellipsis">
      8.3. ğŸ¤ Contract Testing (ADR-010)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#84-load-testing-resilience">
<span class="md-ellipsis">
      8.4. ğŸ“Š Load Testing &amp; Resilience
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#85-security-testing">
<span class="md-ellipsis">
      8.5. ğŸ” Security Testing
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#86-regression-testing-ci-automation">
<span class="md-ellipsis">
      8.6. ğŸ” Regression Testing &amp; CI Automation
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-observability-monitoring">
<span class="md-ellipsis">
      9. ğŸ” Observability &amp; Monitoring
    </span>
</a>
<nav aria-label="9. ğŸ” Observability &amp; Monitoring" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#91-logging-nhat-ky-dich-vu">
<span class="md-ellipsis">
      9.1. ğŸ“„ Logging (Nháº­t kÃ½ dá»‹ch vá»¥)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#92-metrics-giam-sat-hieu-nang-so-luong">
<span class="md-ellipsis">
      9.2. ğŸ“ˆ Metrics (GiÃ¡m sÃ¡t hiá»‡u nÄƒng &amp; sá»‘ lÆ°á»£ng)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#93-tracing-theo-doi-hanh-trinh-request">
<span class="md-ellipsis">
      9.3. ğŸ” Tracing (Theo dÃµi hÃ nh trÃ¬nh request)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#94-alerting-canh-bao-tu-ong">
<span class="md-ellipsis">
      9.4. ğŸš¨ Alerting (Cáº£nh bÃ¡o tá»± Ä‘á»™ng)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-o-tin-cay-phuc-hoi-reliability-resilience">
<span class="md-ellipsis">
      10. ğŸš€ Äá»™ tin cáº­y &amp; Phá»¥c há»“i (Reliability &amp; Resilience)
    </span>
</a>
<nav aria-label="10. ğŸš€ Äá»™ tin cáº­y &amp; Phá»¥c há»“i (Reliability &amp; Resilience)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#101-co-che-retry-thong-minh">
<span class="md-ellipsis">
      10.1. ğŸ” CÆ¡ cháº¿ Retry thÃ´ng minh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#102-bao-ve-idempotency-chong-log-trung">
<span class="md-ellipsis">
      10.2. ğŸ§¾ Báº£o vá»‡ idempotency (chá»‘ng log trÃ¹ng)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#103-phuc-hoi-sau-loi-he-thong">
<span class="md-ellipsis">
      10.3. ğŸ§  Phá»¥c há»“i sau lá»—i há»‡ thá»‘ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#104-kiem-thu-resilience">
<span class="md-ellipsis">
      10.4. ğŸ§ª Kiá»ƒm thá»­ resilience
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-kien-truc-service-service-architecture-overview">
<span class="md-ellipsis">
      11. ğŸ§© Kiáº¿n trÃºc Service (Service Architecture Overview)
    </span>
</a>
<nav aria-label="11. ğŸ§© Kiáº¿n trÃºc Service (Service Architecture Overview)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#111-so-o-kien-truc-tong-the">
<span class="md-ellipsis">
      11.1. ğŸ–¼ SÆ¡ Ä‘á»“ Kiáº¿n trÃºc Tá»•ng thá»ƒ
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#112-ghi-chu-kien-truc">
<span class="md-ellipsis">
      11.2. ğŸ“Œ Ghi chÃº Kiáº¿n trÃºc
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#113-trien-khai-dang-tach-lop">
<span class="md-ellipsis">
      11.3. ğŸŒ Triá»ƒn khai dáº¡ng tÃ¡ch lá»›p
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-tai-lieu-lien-quan">
<span class="md-ellipsis">
      12. ğŸ“š TÃ i liá»‡u liÃªn quan
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="thiet-ke-chi-tiet-audit-logging-service">ğŸ“˜ Thiáº¿t káº¿ chi tiáº¿t Audit Logging Service<a class="headerlink" href="#thiet-ke-chi-tiet-audit-logging-service" title="Permanent link">Â¶</a></h1>
<h2 id="1-pham-vi-va-trach-nhiem-scope-responsibilities">1. ğŸ§­ Pháº¡m vi vÃ  TrÃ¡ch nhiá»‡m (Scope &amp; Responsibilities)<a class="headerlink" href="#1-pham-vi-va-trach-nhiem-scope-responsibilities" title="Permanent link">Â¶</a></h2>
<h3 id="11-muc-tieu">1.1. ğŸ¯ Má»¥c tiÃªu<a class="headerlink" href="#11-muc-tieu" title="Permanent link">Â¶</a></h3>
<p>Audit Logging Service (ALS) lÃ  má»™t core service thuá»™c nhÃ³m Platform Stack, chá»‹u trÃ¡ch nhiá»‡m <strong>ghi nháº­n toÃ n bá»™ hÃ nh vi cÃ³ áº£nh hÆ°á»Ÿng Ä‘áº¿n tráº¡ng thÃ¡i há»‡ thá»‘ng</strong>, bao gá»“m:</p>
<ul>
<li>CÃ¡c thay Ä‘á»•i dá»¯ liá»‡u quan trá»ng (create/update/delete)</li>
<li>CÃ¡c hÃ nh Ä‘á»™ng nháº¡y cáº£m (Ä‘Äƒng nháº­p, phÃ¢n quyá»n, thanh toÃ¡n, xuáº¥t dá»¯ liá»‡u)</li>
<li>CÃ¡c thao tÃ¡c quáº£n trá»‹ (cáº¥u hÃ¬nh há»‡ thá»‘ng, phÃª duyá»‡t yÃªu cáº§u, Ä‘Äƒng kÃ½ tenant má»›i)</li>
<li>TÆ°Æ¡ng tÃ¡c cá»§a ngÆ°á»i dÃ¹ng thÃ´ng qua cÃ¡c API cÃ³ side-effect</li>
</ul>
<p>ALS Ä‘Ã³ng vai trÃ² nhÆ° â€œhá»™p Ä‘enâ€ (blackbox) cá»§a há»‡ thá»‘ng, giÃºp truy váº¿t vÃ  Ä‘iá»u tra cÃ¡c sá»± cá»‘, Ä‘áº£m báº£o tuÃ¢n thá»§ chÃ­nh sÃ¡ch báº£o máº­t, vÃ  lÃ  ná»n táº£ng quan trá»ng cho phÃ¢n tÃ­ch hÃ nh vi ngÆ°á»i dÃ¹ng hoáº·c Ä‘iá»u tra vi pháº¡m.</p>
<hr/>
<h3 id="12-trach-nhiem-chinh">1.2. ğŸ“Œ TrÃ¡ch nhiá»‡m chÃ­nh<a class="headerlink" href="#12-trach-nhiem-chinh" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>NhÃ³m chá»©c nÄƒng</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Ingest log</strong></td>
<td>Nháº­n log tá»« cÃ¡c service khÃ¡c qua HTTP hoáº·c Pub/Sub, xÃ¡c thá»±c nguá»“n vÃ  Ä‘á»‹nh dáº¡ng</td>
</tr>
<tr>
<td><strong>Chuáº©n hoÃ¡ &amp; báº£o vá»‡ dá»¯ liá»‡u</strong></td>
<td>TuÃ¢n thá»§ <code>ADR-008</code> vá» Ä‘á»‹nh dáº¡ng log vÃ  <code>ADR-024</code> vá» áº©n danh hÃ³a dá»¯ liá»‡u PII</td>
</tr>
<tr>
<td><strong>LÆ°u trá»¯ dÃ i háº¡n</strong></td>
<td>Ghi dá»¯ liá»‡u vÃ o BigQuery hoáº·c Firestore theo schema chuáº©n, cÃ³ partition theo thá»i gian vÃ  tenant</td>
</tr>
<tr>
<td><strong>Há»— trá»£ truy váº¥n</strong></td>
<td>Cung cáº¥p API Ä‘á»ƒ tra cá»©u audit log theo tiÃªu chÃ­: thá»i gian, hÃ nh Ä‘á»™ng, ngÆ°á»i dÃ¹ng, tenantâ€¦</td>
</tr>
<tr>
<td><strong>TÆ°Æ¡ng thÃ­ch Ä‘a tenant</strong></td>
<td>Má»—i báº£n ghi log gáº¯n <code>tenant_id</code> rÃµ rÃ ng, Ä‘áº£m báº£o phÃ¢n quyá»n truy cáº­p á»Ÿ cáº¥p tenant</td>
</tr>
<tr>
<td><strong>Quan sÃ¡t &amp; phÃ¢n tÃ­ch</strong></td>
<td>Cung cáº¥p metric, tracing, alerting theo <code>ADR-021</code> Ä‘á»ƒ giÃ¡m sÃ¡t cháº¥t lÆ°á»£ng ghi log</td>
</tr>
<tr>
<td><strong>Äáº£m báº£o compliance</strong></td>
<td>Há»— trá»£ thá»i gian lÆ°u trá»¯ (retention), masking PII, export phá»¥c vá»¥ audit ná»™i bá»™ hoáº·c bÃªn ngoÃ i</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="13-ngoai-pham-vi-out-of-scope">1.3. âŒ NgoÃ i pháº¡m vi (Out of Scope)<a class="headerlink" href="#13-ngoai-pham-vi-out-of-scope" title="Permanent link">Â¶</a></h3>
<ul>
<li>KhÃ´ng lÆ°u log há»‡ thá»‘ng nhÆ° stdout/stderr hoáº·c log á»©ng dá»¥ng thÃ´ng thÆ°á»ng</li>
<li>KhÃ´ng thay tháº¿ há»‡ thá»‘ng monitoring nhÆ° Stackdriver, Prometheus</li>
<li>KhÃ´ng thá»±c hiá»‡n alerting, auto-block hay trigger xá»­ lÃ½ tá»« log â€“ cÃ¡c há»‡ thá»‘ng khÃ¡c cÃ³ thá»ƒ phÃ¢n tÃ­ch log Ä‘á»ƒ thá»±c hiá»‡n hÃ nh Ä‘á»™ng</li>
</ul>
<hr/>
<h3 id="14-nguoi-dung-va-client">1.4. ğŸ‘¥ NgÆ°á»i dÃ¹ng vÃ  client<a class="headerlink" href="#14-nguoi-dung-va-client" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Vai trÃ²</th>
<th>Má»¥c Ä‘Ã­ch sá»­ dá»¥ng</th>
</tr>
</thead>
<tbody>
<tr>
<td>Core Services (Auth, User, API Gateway, Notification...)</td>
<td>Gá»­i audit log khi cÃ³ hÃ nh Ä‘á»™ng quan trá»ng</td>
</tr>
<tr>
<td>DevOps / Security Team</td>
<td>Tra cá»©u hÃ nh vi báº¥t thÆ°á»ng, Ä‘iá»u tra sá»± cá»‘ báº£o máº­t</td>
</tr>
<tr>
<td>Tenant Admin</td>
<td>Truy váº¥n log trong pháº¡m vi tenant Ä‘á»ƒ kiá»ƒm tra hÃ nh Ä‘á»™ng ngÆ°á»i dÃ¹ng</td>
</tr>
<tr>
<td>Auditor (ná»™i bá»™ hoáº·c bÃªn thá»© ba)</td>
<td>Táº£i export log phá»¥c vá»¥ kiá»ƒm toÃ¡n Ä‘á»‹nh ká»³</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="2-kien-truc-noi-bo-internal-architecture">2. ğŸ§± Kiáº¿n trÃºc ná»™i bá»™ (Internal Architecture)<a class="headerlink" href="#2-kien-truc-noi-bo-internal-architecture" title="Permanent link">Â¶</a></h2>
<h3 id="21-tong-quan">2.1. ğŸ§  Tá»•ng quan<a class="headerlink" href="#21-tong-quan" title="Permanent link">Â¶</a></h3>
<p>Audit Logging Service (ALS) Ä‘Æ°á»£c thiáº¿t káº¿ theo mÃ´ hÃ¬nh stateless microservice, váº­n hÃ nh trong Core Stack cá»§a há»‡ thá»‘ng <code>dx-vas</code>. Service nÃ y tiáº¿p nháº­n log thÃ´ng qua cáº£ hai cÆ¡ cháº¿: HTTP API vÃ  Pub/Sub, xá»­ lÃ½ vÃ  ghi nháº­n log vÃ o há»‡ thá»‘ng lÆ°u trá»¯ trung tÃ¢m, Ä‘á»“ng thá»i cung cáº¥p API Ä‘á»ƒ truy váº¥n log theo tenant vÃ  Ä‘iá»u kiá»‡n lá»c.</p>
<hr/>
<h3 id="22-cac-thanh-phan-chinh">2.2. ğŸ—ï¸ CÃ¡c thÃ nh pháº§n chÃ­nh<a class="headerlink" href="#22-cac-thanh-phan-chinh" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>ThÃ nh pháº§n</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Ingestion API</strong></td>
<td>HTTP endpoint ná»™i bá»™ dÃ¹ng Ä‘á»ƒ cÃ¡c service gá»i trá»±c tiáº¿p gá»­i log. XÃ¡c thá»±c báº±ng JWT, kiá»ƒm tra <code>x-tenant-id</code>, Ã¡p dá»¥ng RBAC (náº¿u cáº§n)</td>
</tr>
<tr>
<td><strong>Pub/Sub Consumer</strong></td>
<td>Láº¯ng nghe topic <code>audit.events.v1</code> (chuáº©n hoÃ¡ theo <code>ADR-030</code>). DÃ¹ng Ä‘á»ƒ xá»­ lÃ½ log phÃ¡t ra dÆ°á»›i dáº¡ng sá»± kiá»‡n tá»« cÃ¡c service khÃ¡c</td>
</tr>
<tr>
<td><strong>Parser &amp; Validator</strong></td>
<td>Kiá»ƒm tra schema cá»§a audit event (theo <code>ADR-008</code>), lá»c cÃ¡c trÆ°á»ng khÃ´ng há»£p lá»‡, kiá»ƒm tra backward compatibility náº¿u cáº§n</td>
</tr>
<tr>
<td><strong>PII Masker</strong></td>
<td>Ãp dá»¥ng chÃ­nh sÃ¡ch áº©n danh hoÃ¡ trÆ°á»›c khi lÆ°u log (xem <code>ADR-024</code>). CÃ³ thá»ƒ cáº¥u hÃ¬nh báº­t/táº¯t masking theo mÃ´i trÆ°á»ng</td>
</tr>
<tr>
<td><strong>Storage Layer</strong></td>
<td>Ghi log vÃ o BigQuery (máº·c Ä‘á»‹nh). CÃ³ thá»ƒ cáº¥u hÃ¬nh lÆ°u vÃ o Firestore hoáº·c Cold Storage cho log lÃ¢u nÄƒm</td>
</tr>
<tr>
<td><strong>Query API</strong></td>
<td>Cung cáº¥p REST API Ä‘á»ƒ truy váº¥n log theo <code>tenant_id</code>, <code>actor_user_id</code>, <code>resource</code>, <code>action</code>, <code>date_range</code>, <code>trace_id</code>...</td>
</tr>
<tr>
<td><strong>Retention Cron</strong></td>
<td>Tá»± Ä‘á»™ng xÃ³a log theo chÃ­nh sÃ¡ch thá»i gian lÆ°u trá»¯ (<code>retention_days</code>) cáº¥u hÃ¬nh trong biáº¿n mÃ´i trÆ°á»ng hoáº·c metadata</td>
</tr>
<tr>
<td><strong>Observability Hooks</strong></td>
<td>TÃ­ch há»£p logging, metrics (Prometheus), tracing (OpenTelemetry) vÃ  alerting (Stackdriver Alerting) theo <code>ADR-021</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="23-flow-xu-ly-tong-quat">2.3. ğŸ” Flow xá»­ lÃ½ tá»•ng quÃ¡t<a class="headerlink" href="#23-flow-xu-ly-tong-quat" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>flowchart TD
    subgraph Ingestion
        A1[HTTP Request]
        A2[Pub/Sub Message]
    end
    A1 --&gt; P[Parse &amp; Validate]
    A2 --&gt; P
    P --&gt; M[Mask Sensitive Fields (ADR-024)]
    M --&gt; S[Store to BigQuery]
    S --&gt; E[Emit audit_log_persisted.v1]
</code></pre>
<hr/>
<h3 id="24-bao-mat-noi-bo">2.4. ğŸ”’ Báº£o máº­t ná»™i bá»™<a class="headerlink" href="#24-bao-mat-noi-bo" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»i HTTP request pháº£i Ä‘i qua API Gateway, cÃ³ xÃ¡c thá»±c JWT vÃ  <code>x-tenant-id</code></li>
<li>Consumer Pub/Sub chá»‰ nháº­n tá»« topic <code>audit.events.v1</code> Ä‘Ã£ Ä‘Äƒng kÃ½ theo Ä‘Ãºng schema (xÃ¡c minh tá»« <code>event-registry</code>)</li>
<li>Táº¥t cáº£ log Ä‘Æ°á»£c gáº¯n <code>tenant_id</code>, khÃ´ng bao giá» cÃ³ log â€œchungâ€ khÃ´ng Ä‘á»‹nh danh tenant</li>
<li>Truy cáº­p log chá»‰ cho phÃ©p ngÆ°á»i dÃ¹ng hoáº·c service cÃ³ quyá»n <code>audit.read</code></li>
</ul>
<hr/>
<h3 id="25-trien-khai-va-mo-rong">2.5. âš™ï¸ Triá»ƒn khai vÃ  Má»Ÿ rá»™ng<a class="headerlink" href="#25-trien-khai-va-mo-rong" title="Permanent link">Â¶</a></h3>
<ul>
<li>Service triá»ƒn khai trÃªn Google Cloud Run, autoscale theo load</li>
<li>Má»—i báº£n ghi log lÆ°u kÃ¨m <code>trace_id</code>, há»— trá»£ liÃªn káº¿t vá»›i observability toÃ n há»‡ thá»‘ng</li>
<li>Trong tÆ°Æ¡ng lai cÃ³ thá»ƒ há»— trá»£ dual storage (BigQuery realtime + Firestore archive)</li>
</ul>
<hr/>
<h3 id="26-lien-ket-adr-va-kien-truc">2.6. ğŸ“Œ LiÃªn káº¿t ADR vÃ  Kiáº¿n trÃºc<a class="headerlink" href="#26-lien-ket-adr-va-kien-truc" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>ThÃ nh pháº§n</th>
<th>ADR liÃªn quan</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ingestion API</td>
<td>ADR-008, ADR-006</td>
</tr>
<tr>
<td>Pub/Sub Consumer</td>
<td>ADR-030, ADR-008</td>
</tr>
<tr>
<td>Masking</td>
<td>ADR-024</td>
</tr>
<tr>
<td>Storage</td>
<td>ADR-027, ADR-020</td>
</tr>
<tr>
<td>Tracing &amp; Metrics</td>
<td>ADR-021</td>
</tr>
<tr>
<td>Retention Policy</td>
<td>ADR-026</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Chi tiáº¿t:</strong> <a href="../interface-contract/">Interface Contract</a> &amp; <a href="../openapi.yaml">OpenAPI</a></p>
</blockquote>
<hr/>
<h2 id="3-mo-hinh-du-lieu-data-model">3. ğŸ§© MÃ´ hÃ¬nh Dá»¯ liá»‡u (Data Model)<a class="headerlink" href="#3-mo-hinh-du-lieu-data-model" title="Permanent link">Â¶</a></h2>
<p>Audit Logging Service sá»­ dá»¥ng mÃ´ hÃ¬nh dá»¯ liá»‡u dáº¡ng <strong>append-only</strong>, lÆ°u trá»¯ má»—i hÃ nh Ä‘á»™ng (event) thÃ nh má»™t báº£n ghi khÃ´ng sá»­a Ä‘á»•i. Dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u trong <strong>BigQuery</strong> (máº·c Ä‘á»‹nh) hoáº·c cÃ³ thá»ƒ cáº¥u hÃ¬nh lÆ°u trá»¯ song song á»Ÿ <strong>Firestore</strong> cho má»¥c Ä‘Ã­ch truy xuáº¥t nhanh theo ID.</p>
<hr/>
<h3 id="31-bang-chinh-audit_logs">3.1. ğŸ“Œ Báº£ng chÃ­nh: <code>audit_logs</code><a class="headerlink" href="#31-bang-chinh-audit_logs" title="Permanent link">Â¶</a></h3>
<h4 id="muc-ich">ğŸ”– Má»¥c Ä‘Ã­ch<a class="headerlink" href="#muc-ich" title="Permanent link">Â¶</a></h4>
<p>LÆ°u trá»¯ toÃ n bá»™ hÃ nh vi ngÆ°á»i dÃ¹ng hoáº·c há»‡ thá»‘ng cÃ³ tÃ¡c Ä‘á»™ng Ä‘áº¿n tráº¡ng thÃ¡i hoáº·c cáº¥u hÃ¬nh há»‡ thá»‘ng, Ä‘Æ°á»£c ghi nháº­n theo chuáº©n schema sá»± kiá»‡n <code>*.audit.v1</code>.</p>
<h4 id="cau-truc-bang">ğŸ“ Cáº¥u trÃºc báº£ng<a class="headerlink" href="#cau-truc-bang" title="Permanent link">Â¶</a></h4>
<table>
<thead>
<tr>
<th>TrÆ°á»ng</th>
<th>Kiá»ƒu dá»¯ liá»‡u</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td><code>STRING</code></td>
<td>ID duy nháº¥t cá»§a báº£n ghi (UUID v4)</td>
</tr>
<tr>
<td><code>tenant_id</code></td>
<td><code>STRING</code></td>
<td>Tenant nÆ¡i hÃ nh Ä‘á»™ng xáº£y ra</td>
</tr>
<tr>
<td><code>actor_user_id</code></td>
<td><code>STRING</code></td>
<td>ID ngÆ°á»i thá»±c hiá»‡n hÃ nh Ä‘á»™ng (cÃ³ thá»ƒ lÃ  system hoáº·c service)</td>
</tr>
<tr>
<td><code>resource_type</code></td>
<td><code>STRING</code></td>
<td>Loáº¡i Ä‘á»‘i tÆ°á»£ng bá»‹ tÃ¡c Ä‘á»™ng (e.g. <code>user</code>, <code>template</code>, <code>config</code>)</td>
</tr>
<tr>
<td><code>resource_id</code></td>
<td><code>STRING</code></td>
<td>ID Ä‘á»‘i tÆ°á»£ng bá»‹ tÃ¡c Ä‘á»™ng</td>
</tr>
<tr>
<td><code>action</code></td>
<td><code>STRING</code></td>
<td>Loáº¡i hÃ nh Ä‘á»™ng (<code>create</code>, <code>update</code>, <code>delete</code>, <code>login</code>, etc.)</td>
</tr>
<tr>
<td><code>action_scope</code></td>
<td><code>STRING</code></td>
<td>Pháº¡m vi hÃ nh Ä‘á»™ng (<code>global</code>, <code>tenant</code>, <code>internal</code>)</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td><code>TIMESTAMP</code></td>
<td>Thá»i Ä‘iá»ƒm xáº£y ra hÃ nh Ä‘á»™ng (UTC)</td>
</tr>
<tr>
<td><code>trace_id</code></td>
<td><code>STRING</code></td>
<td>MÃ£ trace toÃ n cá»¥c Ä‘á»ƒ liÃªn káº¿t log giá»¯a cÃ¡c service</td>
</tr>
<tr>
<td><code>ip_address</code></td>
<td><code>STRING</code></td>
<td>IP cá»§a ngÆ°á»i thá»±c hiá»‡n (cÃ³ thá»ƒ Ä‘Ã£ mask)</td>
</tr>
<tr>
<td><code>user_agent</code></td>
<td><code>STRING</code></td>
<td>TrÃ¬nh duyá»‡t hoáº·c cÃ´ng cá»¥ thá»±c hiá»‡n hÃ nh Ä‘á»™ng</td>
</tr>
<tr>
<td><code>payload_before</code></td>
<td><code>JSON</code></td>
<td>Tráº¡ng thÃ¡i Ä‘á»‘i tÆ°á»£ng trÆ°á»›c khi thay Ä‘á»•i (náº¿u cÃ³)</td>
</tr>
<tr>
<td><code>payload_after</code></td>
<td><code>JSON</code></td>
<td>Tráº¡ng thÃ¡i Ä‘á»‘i tÆ°á»£ng sau khi thay Ä‘á»•i (náº¿u cÃ³)</td>
</tr>
<tr>
<td><code>input_parameters</code></td>
<td><code>JSON</code></td>
<td>Tham sá»‘ Ä‘áº§u vÃ o cá»§a API táº¡i thá»i Ä‘iá»ƒm hÃ nh Ä‘á»™ng</td>
</tr>
<tr>
<td><code>duration_ms</code></td>
<td><code>INTEGER</code></td>
<td>Thá»i gian thá»±c hiá»‡n hÃ nh Ä‘á»™ng (náº¿u cÃ³ thá»ƒ Ä‘o)</td>
</tr>
<tr>
<td><code>source_service</code></td>
<td><code>STRING</code></td>
<td>TÃªn service phÃ¡t sinh hÃ nh Ä‘á»™ng (e.g. <code>user-service</code>, <code>auth-service</code>)</td>
</tr>
<tr>
<td><code>event_version</code></td>
<td><code>STRING</code></td>
<td>PhiÃªn báº£n schema sá»± kiá»‡n (e.g. <code>v1</code>, <code>v2</code>)</td>
</tr>
<tr>
<td><code>is_masked</code></td>
<td><code>BOOLEAN</code></td>
<td>Cá» cho biáº¿t trÆ°á»ng nháº¡y cáº£m Ä‘Ã£ Ä‘Æ°á»£c áº©n danh hÃ³a chÆ°a</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="32-quy-tac-bao-mat-masking-du-lieu">3.2. ğŸ”’ Quy táº¯c Báº£o máº­t &amp; Masking Dá»¯ liá»‡u<a class="headerlink" href="#32-quy-tac-bao-mat-masking-du-lieu" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ <code>ADR-024 - Data Anonymization &amp; Retention</code>:
- TrÆ°á»ng <code>ip_address</code> â†’ Ä‘Æ°á»£c rÃºt gá»n <code>/24</code> hoáº·c SHA256 khi cáº§n.
- TrÆ°á»ng <code>input_parameters</code>, <code>payload_*</code> â†’ lá»c theo whitelist field hoáº·c pattern-based masking.
- TrÆ°á»ng <code>actor_user_id</code> cÃ³ thá»ƒ Ä‘Æ°á»£c thay báº±ng dáº¡ng alias (e.g. <code>u_x7f8d123</code>) náº¿u xuáº¥t ra public logs.</p>
<hr/>
<h3 id="33-chinh-sach-luu-tru-va-phan-vung-bigquery">3.3. â³ ChÃ­nh sÃ¡ch lÆ°u trá»¯ vÃ  phÃ¢n vÃ¹ng (BigQuery)<a class="headerlink" href="#33-chinh-sach-luu-tru-va-phan-vung-bigquery" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Thuá»™c tÃ­nh</th>
<th>GiÃ¡ trá»‹</th>
</tr>
</thead>
<tbody>
<tr>
<td>Partition</td>
<td>Theo <code>timestamp</code></td>
</tr>
<tr>
<td>Clustering</td>
<td><code>tenant_id</code>, <code>source_service</code></td>
</tr>
<tr>
<td>Retention máº·c Ä‘á»‹nh</td>
<td>365 ngÃ y (cáº¥u hÃ¬nh qua env)</td>
</tr>
<tr>
<td>Policy xÃ³a</td>
<td>TuÃ¢n theo <code>ADR-026 - Hard Delete Policy</code> vÃ  <code>ADR-027 - Data Management Strategy</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="34-cac-chi-muc-va-truy-van-ien-hinh">3.4. ğŸ” CÃ¡c chá»‰ má»¥c vÃ  truy váº¥n Ä‘iá»ƒn hÃ¬nh<a class="headerlink" href="#34-cac-chi-muc-va-truy-van-ien-hinh" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Use case</th>
<th>Field filter</th>
</tr>
</thead>
<tbody>
<tr>
<td>Truy váº¿t hÃ nh Ä‘á»™ng cá»§a ngÆ°á»i dÃ¹ng</td>
<td><code>actor_user_id</code>, <code>tenant_id</code>, <code>timestamp</code></td>
</tr>
<tr>
<td>Kiá»ƒm tra thay Ä‘á»•i config há»‡ thá»‘ng</td>
<td><code>resource_type = 'config'</code></td>
</tr>
<tr>
<td>Xem toÃ n bá»™ hÃ nh Ä‘á»™ng tá»« má»™t service</td>
<td><code>source_service</code>, <code>trace_id</code></td>
</tr>
<tr>
<td>Truy xuáº¥t theo trace cho incident</td>
<td><code>trace_id</code></td>
</tr>
</tbody>
</table>
<p>ğŸ‘‰ <strong>Chi tiáº¿t sÆ¡ Ä‘á»“ ERD, Ä‘á»‹nh nghÄ©a báº£ng vÃ  chiáº¿n lÆ°á»£c kiá»ƒm thá»­ dá»¯ liá»‡u Ä‘Æ°á»£c trÃ¬nh bÃ y táº¡i</strong>:<br/>
ğŸ“‚ <a href="../data-model/">Data Model</a></p>
<hr/>
<h2 id="4-luong-nghiep-vu-chinh-main-flow">4. ğŸ”„ Luá»“ng nghiá»‡p vá»¥ chÃ­nh (Main Flow)<a class="headerlink" href="#4-luong-nghiep-vu-chinh-main-flow" title="Permanent link">Â¶</a></h2>
<p>Audit Logging Service (ALS) há»— trá»£ hai luá»“ng chÃ­nh Ä‘á»ƒ ghi nháº­n log má»™t cÃ¡ch toÃ n diá»‡n vÃ  linh hoáº¡t: (1) qua Pub/Sub theo cÆ¡ cháº¿ sá»± kiá»‡n báº¥t Ä‘á»“ng bá»™, vÃ  (2) qua HTTP API dÃ nh cho cÃ¡c trÆ°á»ng há»£p cáº§n ghi log tá»©c thá»i hoáº·c ná»™i bá»™. Dá»¯ liá»‡u sau khi nháº­n Ä‘Æ°á»£c sáº½ Ä‘Æ°á»£c chuáº©n hoÃ¡, xá»­ lÃ½ báº£o máº­t vÃ  lÆ°u trá»¯ an toÃ n.</p>
<hr/>
<h3 id="41-luong-1-nhan-su-kien-log-qua-pubsub-auditeventsv1">4.1. ğŸ” Luá»“ng 1: Nháº­n sá»± kiá»‡n log qua Pub/Sub (<code>audit.events.v1</code>)<a class="headerlink" href="#41-luong-1-nhan-su-kien-log-qua-pubsub-auditeventsv1" title="Permanent link">Â¶</a></h3>
<p>Luá»“ng phá»• biáº¿n vÃ  Ä‘Æ°á»£c khuyáº¿n nghá»‹ cho cÃ¡c core service phÃ¡t hÃ nh log hÃ nh vi dÆ°á»›i dáº¡ng sá»± kiá»‡n chuáº©n hÃ³a.</p>
<pre class="mermaid"><code>sequenceDiagram
  participant ServiceX as Core Service (e.g. user-service)
  participant PubSub as Pub/Sub Topic
  participant ALS as Audit Logging Service
  participant DB as BigQuery Storage

  ServiceX-&gt;&gt;PubSub: Publish `audit.*.v1` JSON
  PubSub--&gt;&gt;ALS: Consume &amp; parse event
  ALS-&gt;&gt;ALS: Validate schema (ADR-008) + Mask sensitive fields (ADR-024)
  ALS-&gt;&gt;DB: Persist log entry
  ALS--&gt;&gt;PubSub: Emit `audit_log_persisted.v1`
</code></pre>
<p><strong>Äáº·c Ä‘iá»ƒm</strong>:</p>
<ul>
<li><strong>KhÃ´ng blocking</strong> service phÃ¡t.</li>
<li>Äáº£m báº£o loosely-coupled vÃ  resilient.</li>
<li>Báº¯t buá»™c tuÃ¢n theo schema trong <code>event-registry/</code>.</li>
</ul>
<hr/>
<h3 id="42-luong-2-ghi-log-truc-tiep-qua-http-api-chi-noi-bo">4.2. ğŸ” Luá»“ng 2: Ghi log trá»±c tiáº¿p qua HTTP API (chá»‰ ná»™i bá»™)<a class="headerlink" href="#42-luong-2-ghi-log-truc-tiep-qua-http-api-chi-noi-bo" title="Permanent link">Â¶</a></h3>
<p>DÃ nh cho cÃ¡c service khÃ´ng tÃ­ch há»£p Pub/Sub hoáº·c muá»‘n ghi log trong cÃ¹ng transaction.</p>
<pre class="mermaid"><code>sequenceDiagram
  participant ServiceY as Internal Service
  participant Gateway as API Gateway
  participant ALS as Audit Logging Service
  participant DB as BigQuery

  ServiceY-&gt;&gt;Gateway: POST /audit-log (JWT + X-Tenant-ID)
  Gateway-&gt;&gt;ALS: Forward request
  ALS-&gt;&gt;ALS: Validate + Mask + Attach trace_id
  ALS-&gt;&gt;DB: Store log
  ALS--&gt;&gt;ServiceY: 204 No Content
</code></pre>
<p><strong>Äáº·c Ä‘iá»ƒm</strong>:</p>
<ul>
<li>YÃªu cáº§u JWT há»£p lá»‡ vá»›i scope <code>audit.write</code>.</li>
<li>DÃ nh cho log ná»™i bá»™ hoáº·c dev tool (e.g. RBAC editor, import tools).</li>
<li>CÃ³ thá»ƒ báº­t/táº¯t per-environment qua config.</li>
</ul>
<hr/>
<h3 id="43-luong-3-truy-van-audit-log-tu-webapp-hoac-devops">4.3. ğŸ§  Luá»“ng 3: Truy váº¥n Audit Log tá»« WebApp hoáº·c DevOps<a class="headerlink" href="#43-luong-3-truy-van-audit-log-tu-webapp-hoac-devops" title="Permanent link">Â¶</a></h3>
<p>Cho phÃ©p ngÆ°á»i dÃ¹ng cÃ³ vai trÃ² phÃ¹ há»£p truy xuáº¥t log trong pháº¡m vi tenant Ä‘á»ƒ kiá»ƒm tra hÃ nh vi.</p>
<pre class="mermaid"><code>sequenceDiagram
  participant Admin as Tenant Admin
  participant WebApp as Superadmin UI
  participant Gateway as API Gateway
  participant ALS as Audit Logging Service
  participant DB as BigQuery

  Admin-&gt;&gt;WebApp: Chá»n thá»i gian, hÃ nh Ä‘á»™ng, user
  WebApp-&gt;&gt;Gateway: GET /audit-log?filters... (JWT + Tenant)
  Gateway-&gt;&gt;ALS: Forward request
  ALS-&gt;&gt;DB: Query log with tenant + filters
  ALS--&gt;&gt;WebApp: Paginated Result
</code></pre>
<p><strong>Äáº·c Ä‘iá»ƒm</strong>:</p>
<ul>
<li>YÃªu cáº§u scope <code>audit.read</code> + kiá»ƒm tra tenant ID.</li>
<li>Káº¿t quáº£ Ä‘Æ°á»£c tráº£ dÆ°á»›i dáº¡ng <code>AuditLogEnvelope</code> (tuÃ¢n theo <code>ADR-012</code>).</li>
</ul>
<hr/>
<h3 id="44-cac-hanh-ong-pho-bien-uoc-log">4.4. ğŸ§© CÃ¡c hÃ nh Ä‘á»™ng phá»• biáº¿n Ä‘Æ°á»£c log<a class="headerlink" href="#44-cac-hanh-ong-pho-bien-uoc-log" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>HÃ nh Ä‘á»™ng</th>
<th>MÃ´ táº£</th>
<th>Nguá»“n</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user.created</code></td>
<td>NgÆ°á»i dÃ¹ng má»›i Ä‘Æ°á»£c táº¡o</td>
<td>user-service</td>
</tr>
<tr>
<td><code>user.login.success</code></td>
<td>ÄÄƒng nháº­p thÃ nh cÃ´ng</td>
<td>auth-service</td>
</tr>
<tr>
<td><code>role.updated</code></td>
<td>Thay Ä‘á»•i role hoáº·c permission</td>
<td>user-service</td>
</tr>
<tr>
<td><code>template.deleted</code></td>
<td>XoÃ¡ máº«u bÃ¡o cÃ¡o / cáº¥u hÃ¬nh</td>
<td>reporting-service</td>
</tr>
<tr>
<td><code>notification.sent</code></td>
<td>Gá»­i email/SMS thÃ nh cÃ´ng</td>
<td>notification-service</td>
</tr>
<tr>
<td><code>tenant.created</code></td>
<td>Táº¡o má»›i tenant</td>
<td>sms-service</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="5-tuong-tac-voi-cac-service-khac-luong-su-kien">5. ğŸ“£ TÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c Service khÃ¡c &amp; Luá»“ng sá»± kiá»‡n<a class="headerlink" href="#5-tuong-tac-voi-cac-service-khac-luong-su-kien" title="Permanent link">Â¶</a></h2>
<p>Audit Logging Service (ALS) hoáº¡t Ä‘á»™ng nhÆ° má»™t <strong>dá»‹ch vá»¥ thá»¥ Ä‘á»™ng (passive listener)</strong>, chá»§ yáº¿u tiÃªu thá»¥ sá»± kiá»‡n hoáº·c nháº­n lá»‡nh ghi log tá»« cÃ¡c core service khÃ¡c.</p>
<p>Máº·c Ä‘á»‹nh, ALS khÃ´ng phÃ¡t sinh sá»± kiá»‡n thá»© cáº¥p, tuy nhiÃªn trong cÃ¡c mÃ´i trÆ°á»ng phÃ¢n tÃ­ch hoáº·c tÃ­ch há»£p nÃ¢ng cao, nÃ³ <strong>cÃ³ thá»ƒ phÃ¡t sá»± kiá»‡n</strong> <code>audit_log_persisted.v1</code> tá»›i cÃ¡c topic ná»™i bá»™ Ä‘á»ƒ phá»¥c vá»¥ há»‡ thá»‘ng downstream (e.g. thá»‘ng kÃª realtime, xá»­ lÃ½ batch).</p>
<blockquote>
<p>ğŸ§­ Má»i tÆ°Æ¡ng tÃ¡c chÃ­nh váº«n lÃ  <em>one-way ingestion</em> tá»« bÃªn ngoÃ i â†’ ALS â†’ BigQuery/Firestore.</p>
</blockquote>
<hr/>
<h3 id="51-tuong-tac-ong-bo-http">5.1. ğŸ” TÆ°Æ¡ng tÃ¡c Ä‘á»“ng bá»™ (HTTP)<a class="headerlink" href="#51-tuong-tac-ong-bo-http" title="Permanent link">Â¶</a></h3>
<h4 id="ingestion-noi-bo">âœ… Ingestion ná»™i bá»™<a class="headerlink" href="#ingestion-noi-bo" title="Permanent link">Â¶</a></h4>
<ul>
<li>CÃ¡c service cÃ³ thá»ƒ gá»i trá»±c tiáº¿p endpoint <code>POST /audit-log</code> (ná»™i bá»™) khi muá»‘n ghi log ngay láº­p tá»©c, Ä‘i kÃ¨m trace ID.</li>
<li>CÆ¡ cháº¿ nÃ y thÆ°á»ng dÃ¹ng cho cÃ¡c admin tool, há»‡ thá»‘ng batch import, hoáº·c khi khÃ´ng tÃ­ch há»£p Pub/Sub.</li>
</ul>
<table>
<thead>
<tr>
<th>Service Gá»i</th>
<th>Endpoint</th>
<th>Ghi chÃº</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user-service</code></td>
<td><code>POST /audit-log</code></td>
<td>Khi cáº­p nháº­t role, xÃ³a user</td>
</tr>
<tr>
<td><code>auth-service/sub</code></td>
<td><code>POST /audit-log</code></td>
<td>Ghi nháº­n Ä‘Äƒng nháº­p qua OTP</td>
</tr>
<tr>
<td><code>reporting-service</code></td>
<td><code>POST /audit-log</code></td>
<td>Ghi nháº­n hÃ nh vi truy xuáº¥t bÃ¡o cÃ¡o</td>
</tr>
</tbody>
</table>
<h4 id="bao-mat-http">ğŸ” Báº£o máº­t HTTP<a class="headerlink" href="#bao-mat-http" title="Permanent link">Â¶</a></h4>
<ul>
<li>Táº¥t cáº£ request pháº£i Ä‘i qua API Gateway.</li>
<li>YÃªu cáº§u JWT chá»©a scope <code>audit.write</code>.</li>
<li>Kiá»ƒm tra <code>x-tenant-id</code> vÃ  RBAC (náº¿u cáº§n).</li>
</ul>
<hr/>
<h3 id="52-lang-nghe-su-kien-pubsub">5.2. ğŸ“¥ Láº¯ng nghe sá»± kiá»‡n (Pub/Sub)<a class="headerlink" href="#52-lang-nghe-su-kien-pubsub" title="Permanent link">Â¶</a></h3>
<p>ALS lÃ  <strong>consumer chÃ­nh</strong> cá»§a topic <code>audit.events.v1</code> trÃªn Pub/Sub.</p>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Schema</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>audit.events.v1</code></td>
<td><code>vas.&lt;domain&gt;.&lt;event&gt;.v1</code></td>
<td>CÃ¡c sá»± kiá»‡n hÃ nh Ä‘á»™ng do cÃ¡c service phÃ¡t hÃ nh</td>
</tr>
</tbody>
</table>
<h4 id="vi-du-su-kien-tiep-nhan">VÃ­ dá»¥ sá»± kiá»‡n tiáº¿p nháº­n:<a class="headerlink" href="#vi-du-su-kien-tiep-nhan" title="Permanent link">Â¶</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p">{</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">"event"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vas.user.updated.v1"</span><span class="p">,</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t_1234"</span><span class="p">,</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">"trace_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc-xyz"</span><span class="p">,</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">"actor_user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"u_789"</span><span class="p">,</span>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="nt">"resource_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="nt">"resource_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"u_456"</span><span class="p">,</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"update"</span><span class="p">,</span>
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span><span class="nt">"payload_before"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">},</span>
</span><span id="__span-0-10"><a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">  </span><span class="nt">"payload_after"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">},</span>
</span><span id="__span-0-11"><a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">  </span><span class="err">...</span>
</span><span id="__span-0-12"><a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="service-phat-su-kien-audit">Service phÃ¡t sá»± kiá»‡n audit:<a class="headerlink" href="#service-phat-su-kien-audit" title="Permanent link">Â¶</a></h4>
<table>
<thead>
<tr>
<th>Service Nguá»“n</th>
<th>Sá»± kiá»‡n tiÃªu biá»ƒu</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user-service</code></td>
<td><code>vas.user.created.v1</code>, <code>vas.role.updated.v1</code></td>
</tr>
<tr>
<td><code>auth-service/master</code></td>
<td><code>vas.auth.login_success.v1</code></td>
</tr>
<tr>
<td><code>notification-service/sub</code></td>
<td><code>vas.notification.sent.v1</code></td>
</tr>
<tr>
<td><code>reporting-service</code></td>
<td><code>vas.report.query_executed.v1</code></td>
</tr>
<tr>
<td><code>api-gateway</code></td>
<td><code>vas.api.request.audit.v1</code> (náº¿u báº­t logging toÃ n cá»¥c)</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="53-phat-su-kien-thu-cap-tuy-chon">5.3. ğŸ“¤ PhÃ¡t sá»± kiá»‡n thá»© cáº¥p (tÃ¹y chá»n)<a class="headerlink" href="#53-phat-su-kien-thu-cap-tuy-chon" title="Permanent link">Â¶</a></h3>
<p>Audit Logging Service cÃ³ thá»ƒ phÃ¡t sá»± kiá»‡n <strong><code>vas.audit.persisted.v1</code></strong> sau khi má»™t báº£n ghi log Ä‘Æ°á»£c lÆ°u thÃ nh cÃ´ng, nháº±m phá»¥c vá»¥ cÃ¡c há»‡ thá»‘ng downstream nhÆ°:</p>
<ul>
<li><strong>ETL pipeline</strong> hoáº·c <strong>AI analytics</strong></li>
<li><strong>Alerting / Data Lake indexing</strong></li>
<li><strong>Realtime security event bus</strong></li>
</ul>
<p>ğŸ”’ <strong>TÃ­nh nÄƒng nÃ y hiá»‡n Ä‘ang Ä‘Æ°á»£c táº¯t trong production.</strong>
PhÃ¡t sá»± kiá»‡n Ä‘Æ°á»£c Ä‘iá»u khiá»ƒn bá»Ÿi cáº¥u hÃ¬nh:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nt">emit_audit_event_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nt">audit_event_topic</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audit.log.persisted.v1</span>
</span></code></pre></div>
<p>Viá»‡c phÃ¡t sá»± kiá»‡n khÃ´ng áº£nh hÆ°á»Ÿng luá»“ng xá»­ lÃ½ chÃ­nh, khÃ´ng yÃªu cáº§u ACK tá»« phÃ­a downstream, vÃ  chá»‰ thá»±c hiá»‡n náº¿u cáº¥u hÃ¬nh báº­t.</p>
<h4 id="vi-du-payload">ğŸ“¦ VÃ­ dá»¥ payload:<a class="headerlink" href="#vi-du-payload" title="Permanent link">Â¶</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="p">{</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">  </span><span class="nt">"event"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vas.audit.persisted.v1"</span><span class="p">,</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"log_abc123"</span><span class="p">,</span>
</span><span id="__span-2-4"><a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vas-sch-01"</span><span class="p">,</span>
</span><span id="__span-2-5"><a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-14T08:00:00Z"</span><span class="p">,</span>
</span><span id="__span-2-6"><a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="nt">"source_service"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user-service"</span><span class="p">,</span>
</span><span id="__span-2-7"><a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"delete"</span>
</span><span id="__span-2-8"><a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="p">}</span>
</span></code></pre></div>
<hr/>
<h2 id="6-bao-mat-phan-quyen">6. ğŸ” Báº£o máº­t &amp; PhÃ¢n quyá»n<a class="headerlink" href="#6-bao-mat-phan-quyen" title="Permanent link">Â¶</a></h2>
<p>Audit Logging Service xá»­ lÃ½ dá»¯ liá»‡u nháº¡y cáº£m vÃ  quan trá»ng, nÃªn pháº£i tuÃ¢n thá»§ nghiÃªm ngáº·t cÃ¡c chiáº¿n lÆ°á»£c xÃ¡c thá»±c, phÃ¢n quyá»n vÃ  báº£o vá»‡ dá»¯ liá»‡u theo toÃ n há»‡ thá»‘ng. DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c lá»›p báº£o máº­t chÃ­nh:</p>
<hr/>
<h3 id="61-xac-thuc-authentication">6.1. ğŸ”‘ XÃ¡c thá»±c (Authentication)<a class="headerlink" href="#61-xac-thuc-authentication" title="Permanent link">Â¶</a></h3>
<ul>
<li>Táº¥t cáº£ cÃ¡c endpoint cá»§a ALS Ä‘á»u yÃªu cáº§u xÃ¡c thá»±c JWT há»£p lá»‡.</li>
<li>Token pháº£i Ä‘Æ°á»£c phÃ¡t hÃ nh bá»Ÿi há»‡ thá»‘ng <code>auth-service</code> (master hoáº·c sub), tuÃ¢n thá»§ <code>ADR-006</code>.</li>
<li>Token báº¯t buá»™c chá»©a cÃ¡c claims:</li>
<li><code>sub</code>: Ä‘á»‹nh danh ngÆ°á»i dÃ¹ng/service</li>
<li><code>aud</code>: <code>api.truongvietanh.edu.vn</code></li>
<li><code>x-tenant-id</code>: ID cá»§a tenant Ä‘ang thao tÃ¡c</li>
<li>Äá»‘i vá»›i Pub/Sub consumer, xÃ¡c thá»±c Ä‘Æ°á»£c thá»±c hiá»‡n qua <strong>IAM binding</strong> giá»¯a ALS vÃ  Pub/Sub service account.</li>
</ul>
<hr/>
<h3 id="62-phan-quyen-authorization-rbac">6.2. ğŸ§­ PhÃ¢n quyá»n (Authorization â€“ RBAC)<a class="headerlink" href="#62-phan-quyen-authorization-rbac" title="Permanent link">Â¶</a></h3>
<p>Audit Logging Service thá»±c thi RBAC á»Ÿ 2 má»©c:</p>
<h4 id="khi-ghi-log-write">ğŸ“¥ Khi ghi log (write)<a class="headerlink" href="#khi-ghi-log-write" title="Permanent link">Â¶</a></h4>
<ul>
<li><strong>Pub/Sub</strong>: chá»‰ xá»­ lÃ½ log Ä‘áº¿n tá»« topic <code>audit.events.v1</code> Ä‘Ã£ Ä‘Äƒng kÃ½, khÃ´ng yÃªu cáº§u RBAC.</li>
<li><strong>HTTP API</strong>: yÃªu cáº§u scope <code>audit.write</code>. Chá»‰ dÃ nh cho call ná»™i bá»™ (cÃ³ kiá»ƒm tra <code>x-internal-request: true</code>).</li>
</ul>
<h4 id="khi-truy-van-log-read">ğŸ“¤ Khi truy váº¥n log (read)<a class="headerlink" href="#khi-truy-van-log-read" title="Permanent link">Â¶</a></h4>
<ul>
<li>Báº¯t buá»™c cÃ³ scope <code>audit.read</code>.</li>
<li>Thá»±c hiá»‡n phÃ¢n quyá»n theo template RBAC nhÆ° sau:</li>
</ul>
<table>
<thead>
<tr>
<th>Resource</th>
<th>Action</th>
<th>Äiá»u kiá»‡n báº¯t buá»™c</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>audit_log_entry</code></td>
<td><code>read</code></td>
<td><code>tenant_id == {{X-Tenant-ID}}</code></td>
</tr>
</tbody>
</table>
<ul>
<li>CÃ¡c field trong log nhÆ° <code>actor_user_id</code>, <code>payload_*</code>, <code>input_parameters</code> sáº½ Ä‘Æ°á»£c <strong>mask Ä‘á»™ng</strong> náº¿u ngÆ°á»i gá»i khÃ´ng cÃ³ quyá»n cao (e.g. khÃ´ng pháº£i Superadmin hoáº·c TenantAdmin).</li>
</ul>
<hr/>
<h3 id="63-bao-ve-du-lieu-data-protection">6.3. ğŸ”’ Báº£o vá»‡ dá»¯ liá»‡u (Data Protection)<a class="headerlink" href="#63-bao-ve-du-lieu-data-protection" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»i báº£n ghi log Ä‘á»u Ä‘Æ°á»£c mÃ£ hoÃ¡ á»Ÿ tráº¡ng thÃ¡i lÆ°u trá»¯:</li>
<li>BigQuery: sá»­ dá»¥ng encryption máº·c Ä‘á»‹nh hoáº·c CMEK theo <code>ADR-005</code></li>
<li>Firestore (náº¿u dÃ¹ng): tá»± Ä‘á»™ng mÃ£ hoÃ¡ theo GCP</li>
<li>Dá»¯ liá»‡u truyá»n qua HTTP Ä‘á»u sá»­ dá»¥ng HTTPS (TLS 1.3)</li>
<li>TrÆ°á»ng nháº¡y cáº£m (PII) nhÆ° <code>ip_address</code>, <code>user_agent</code>, <code>payload_*</code> Ä‘á»u Ä‘Æ°á»£c xá»­ lÃ½ theo <code>ADR-024</code>:</li>
<li>Mask cá»‘ Ä‘á»‹nh hoáº·c báº±ng SHA256</li>
<li>XÃ¡c Ä‘á»‹nh field cáº§n áº©n báº±ng cáº¥u hÃ¬nh hoáº·c pattern</li>
</ul>
<hr/>
<h3 id="64-giam-sat-va-bao-ve-runtime">6.4. ğŸš¨ GiÃ¡m sÃ¡t vÃ  báº£o vá»‡ runtime<a class="headerlink" href="#64-giam-sat-va-bao-ve-runtime" title="Permanent link">Â¶</a></h3>
<ul>
<li>TÃ­ch há»£p OpenTelemetry Ä‘á»ƒ trace toÃ n bá»™ request â†’ ghi log â†’ lÆ°u trá»¯</li>
<li>Ghi log má»i request bá»‹ tá»« chá»‘i truy cáº­p hoáº·c vi pháº¡m quyá»n</li>
<li>CÃ³ cáº£nh bÃ¡o náº¿u phÃ¡t hiá»‡n truy váº¥n vÆ°á»£t giá»›i háº¡n tenant, sai scope hoáº·c láº·p láº¡i báº¥t thÆ°á»ng</li>
</ul>
<hr/>
<h2 id="7-cau-hinh-trien-khai-configuration-deployment">7. âš™ï¸ Cáº¥u hÃ¬nh &amp; Triá»ƒn khai (Configuration &amp; Deployment)<a class="headerlink" href="#7-cau-hinh-trien-khai-configuration-deployment" title="Permanent link">Â¶</a></h2>
<p>Audit Logging Service (ALS) Ä‘Æ°á»£c triá»ƒn khai nhÆ° má»™t dá»‹ch vá»¥ Ä‘á»™c láº­p trong <strong>Core Stack</strong> cá»§a há»‡ thá»‘ng <code>dx-vas</code>. Má»¥c tiÃªu lÃ  Ä‘áº£m báº£o kháº£ nÄƒng hoáº¡t Ä‘á»™ng á»•n Ä‘á»‹nh, tÃ¡ch biá»‡t tenant, báº£o máº­t cao vÃ  dá»… dÃ ng má»Ÿ rá»™ng khi lÆ°á»£ng log tÄƒng.</p>
<hr/>
<h3 id="71-mo-hinh-trien-khai">7.1. ğŸ§± MÃ´ hÃ¬nh triá»ƒn khai<a class="headerlink" href="#71-mo-hinh-trien-khai" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>Ná»n táº£ng</strong>: Google Cloud Run</li>
<li><strong>MÃ´i trÆ°á»ng</strong>: <code>staging</code>, <code>production</code>, <code>sandbox</code> (tuÃ¢n thá»§ <code>ADR-017</code>)</li>
<li><strong>VÃ¹ng triá»ƒn khai</strong>: <code>asia-southeast1</code> (máº·c Ä‘á»‹nh), cÃ³ thá»ƒ má»Ÿ rá»™ng multi-region</li>
<li><strong>IAM binding</strong>: chá»‰ cho phÃ©p service account tá»« <code>core</code> services gá»i API hoáº·c push Pub/Sub</li>
</ul>
<hr/>
<h3 id="72-bien-moi-truong-chinh-tuan-theo-adr-005">7.2. âš™ï¸ Biáº¿n mÃ´i trÆ°á»ng chÃ­nh (TuÃ¢n theo ADR-005)<a class="headerlink" href="#72-bien-moi-truong-chinh-tuan-theo-adr-005" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>TÃªn biáº¿n</th>
<th>MÃ´ táº£</th>
<th>VÃ­ dá»¥</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LOG_RETENTION_DAYS</code></td>
<td>Sá»‘ ngÃ y lÆ°u log trÆ°á»›c khi xoÃ¡ (náº¿u báº­t auto-delete)</td>
<td><code>365</code></td>
</tr>
<tr>
<td><code>AUDIT_STORAGE_BACKEND</code></td>
<td>Lá»±a chá»n backend lÆ°u log (<code>bigquery</code> / <code>firestore</code>)</td>
<td><code>bigquery</code></td>
</tr>
<tr>
<td><code>ENABLE_PII_MASKING</code></td>
<td>Báº­t/Táº¯t chá»©c nÄƒng áº©n danh dá»¯ liá»‡u Ä‘áº§u vÃ o</td>
<td><code>true</code></td>
</tr>
<tr>
<td><code>PUBSUB_SUBSCRIPTION_ID</code></td>
<td>ID subscription cá»§a <code>audit.events.v1</code></td>
<td><code>audit-events-sub</code></td>
</tr>
<tr>
<td><code>PROJECT_ID</code></td>
<td>GCP project code chá»©a BigQuery dataset</td>
<td><code>vas-core</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="73-trien-khai-cicd-tuan-thu-adr-001-adr-014">7.3. ğŸš€ Triá»ƒn khai CI/CD (TuÃ¢n thá»§ ADR-001 &amp; ADR-014)<a class="headerlink" href="#73-trien-khai-cicd-tuan-thu-adr-001-adr-014" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»—i láº§n commit vÃ o nhÃ¡nh <code>main</code> sáº½ trigger pipeline build vÃ  deploy (zero-downtime).</li>
<li>Sá»­ dá»¥ng <code>canary deployment</code> cho mÃ´i trÆ°á»ng <code>staging</code>.</li>
<li>Smoke test kiá»ƒm tra sau khi triá»ƒn khai: gá»­i audit log máº«u, kiá»ƒm tra kháº£ nÄƒng lÆ°u vÃ  truy váº¥n.</li>
</ul>
<hr/>
<h3 id="74-chien-luoc-autoscaling-adr-016">7.4. ğŸ“ˆ Chiáº¿n lÆ°á»£c Autoscaling (ADR-016)<a class="headerlink" href="#74-chien-luoc-autoscaling-adr-016" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>Min instances</strong>: <code>1</code> (Ä‘áº£m báº£o cold start tháº¥p)</li>
<li><strong>Max instances</strong>: <code>10</code> (cáº¥u hÃ¬nh ban Ä‘áº§u, cÃ³ thá»ƒ má»Ÿ rá»™ng)</li>
<li><strong>Scaling policy</strong>: theo QPS hoáº·c CPU threshold &gt; 60%</li>
<li>Pub/Sub consumer cÃ³ thá»ƒ tÃ¡ch container riÃªng náº¿u cáº§n scale Ä‘á»™c láº­p</li>
</ul>
<hr/>
<h3 id="75-luu-tru-quan-ly-du-lieu-adr-027">7.5. ğŸ“¦ LÆ°u trá»¯ &amp; Quáº£n lÃ½ dá»¯ liá»‡u (ADR-027)<a class="headerlink" href="#75-luu-tru-quan-ly-du-lieu-adr-027" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>Primary storage</strong>: BigQuery, phÃ¢n vÃ¹ng theo <code>timestamp</code>, clustering theo <code>tenant_id</code></li>
<li><strong>Backup / Archive</strong>: cÃ³ thá»ƒ báº­t lÆ°u song song sang Firestore hoáº·c GCS coldline bucket</li>
<li><strong>Retention</strong>: cháº¡y cron job hÃ ng ngÃ y Ä‘á»ƒ xoÃ¡ log cÅ© vÆ°á»£t <code>LOG_RETENTION_DAYS</code></li>
</ul>
<hr/>
<h3 id="76-chinh-sach-xoa-du-lieu-hard-delete">7.6. ğŸ“Œ ChÃ­nh sÃ¡ch xoÃ¡ dá»¯ liá»‡u (Hard Delete)<a class="headerlink" href="#76-chinh-sach-xoa-du-lieu-hard-delete" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ <code>ADR-026</code>, ALS sá»­ dá»¥ng chÃ­nh sÃ¡ch:
- <strong>Hard delete</strong> dá»¯ liá»‡u khi vÆ°á»£t thá»i gian retention
- XoÃ¡ theo batch nhá», ghi log má»—i láº§n xÃ³a
- KhÃ´ng há»— trá»£ xoÃ¡ selective thá»§ cÃ´ng (trá»« khi cÃ³ yÃªu cáº§u audit ná»™i bá»™ vá»›i policy riÃªng)</p>
<h3 id="77-cau-hinh-lien-quan-en-phat-su-kien">7.7. Cáº¥u hÃ¬nh liÃªn quan Ä‘áº¿n phÃ¡t sá»± kiá»‡n<a class="headerlink" href="#77-cau-hinh-lien-quan-en-phat-su-kien" title="Permanent link">Â¶</a></h3>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1"># config.yaml</span>
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="nt">emit_audit_event_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">         </span><span class="c1"># Báº­t phÃ¡t event thá»© cáº¥p `audit_log_persisted.v1`</span>
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="nt">audit_event_topic</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audit.log.persisted.v1</span><span class="w">  </span><span class="c1"># TÃªn topic phÃ¡t sá»± kiá»‡n</span>
</span></code></pre></div>
<blockquote>
<p>ğŸ“Œ <strong>LÆ°u Ã½:</strong> TÃ­nh nÄƒng phÃ¡t sá»± kiá»‡n thá»© cáº¥p hiá»‡n <strong>chÆ°a Ä‘Æ°á»£c báº­t trong mÃ´i trÆ°á»ng production</strong>.
  Chá»‰ nÃªn kÃ­ch hoáº¡t khi Ä‘Ã£ cÃ³ há»‡ thá»‘ng downstream tiáº¿p nháº­n vÃ  kiá»ƒm soÃ¡t volume event phÃ¡t sinh.</p>
</blockquote>
<hr/>
<h2 id="8-chien-luoc-kiem-thu-testing-strategy">8. ğŸ§ª Chiáº¿n lÆ°á»£c Kiá»ƒm thá»­ (Testing Strategy)<a class="headerlink" href="#8-chien-luoc-kiem-thu-testing-strategy" title="Permanent link">Â¶</a></h2>
<p>Audit Logging Service Ä‘Ã³ng vai trÃ² trung tÃ¢m trong viá»‡c ghi nháº­n vÃ  báº£o vá»‡ hÃ nh vi cá»§a há»‡ thá»‘ng. Do Ä‘Ã³, chiáº¿n lÆ°á»£c kiá»ƒm thá»­ pháº£i Ä‘áº£m báº£o tÃ­nh <strong>Ä‘Ãºng Ä‘áº¯n, an toÃ n, vÃ  tin cáº­y</strong> cá»§a má»—i báº£n ghi audit, trong má»i Ä‘iá»u kiá»‡n táº£i vÃ  mÃ´i trÆ°á»ng váº­n hÃ nh.</p>
<hr/>
<h3 id="81-unit-tests">8.1. âœ… Unit Tests<a class="headerlink" href="#81-unit-tests" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>ThÃ nh pháº§n</th>
<th>Ná»™i dung kiá»ƒm thá»­</th>
</tr>
</thead>
<tbody>
<tr>
<td>Schema Validator</td>
<td>Kiá»ƒm tra tÃ­nh há»£p lá»‡ cá»§a payload theo <code>ADR-008</code></td>
</tr>
<tr>
<td>PII Masker</td>
<td>XÃ¡c minh dá»¯ liá»‡u nháº¡y cáº£m Ä‘Æ°á»£c áº©n Ä‘Ãºng cÃ¡ch</td>
</tr>
<tr>
<td>Query Filter Builder</td>
<td>Kiá»ƒm tra logic lá»c theo <code>actor_id</code>, <code>tenant_id</code>, <code>trace_id</code>, etc.</td>
</tr>
<tr>
<td>JWT Claims Parser</td>
<td>Kiá»ƒm tra cÃ¡c trÆ°á»ng <code>sub</code>, <code>aud</code>, <code>tenant_id</code> Ä‘Æ°á»£c trÃ­ch xuáº¥t chÃ­nh xÃ¡c</td>
</tr>
</tbody>
</table>
<blockquote>
<p>âœ… YÃªu cáº§u Ä‘á»™ bao phá»§ test â‰¥ 90% cho core logic (<code>mask</code>, <code>validate</code>, <code>store</code>).</p>
</blockquote>
<hr/>
<h3 id="82-integration-tests">8.2. ğŸ” Integration Tests<a class="headerlink" href="#82-integration-tests" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Luá»“ng</th>
<th>Kiá»ƒm thá»­</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gá»­i log HTTP â†’ lÆ°u</td>
<td>Gá»­i request ghi log, xÃ¡c minh log tá»“n táº¡i trong BigQuery</td>
</tr>
<tr>
<td>Nháº­n log tá»« Pub/Sub â†’ lÆ°u</td>
<td>Gá»­i message test vÃ o topic <code>audit.events.v1</code>, xÃ¡c minh lÆ°u thÃ nh cÃ´ng</td>
</tr>
<tr>
<td>Truy váº¥n log</td>
<td>Gá»i <code>GET /audit-log</code>, kiá»ƒm tra phÃ¢n trang, lá»c, vÃ  RBAC</td>
</tr>
<tr>
<td>Truy cáº­p sai scope</td>
<td>Gá»­i request tá»« ngÆ°á»i dÃ¹ng khÃ´ng cÃ³ quyá»n, kiá»ƒm tra lá»—i 403</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="83-contract-testing-adr-010">8.3. ğŸ¤ Contract Testing (ADR-010)<a class="headerlink" href="#83-contract-testing-adr-010" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>ThÃ nh pháº§n</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td>HTTP API</td>
<td>Kiá»ƒm tra báº±ng Pactflow Ä‘á»ƒ Ä‘áº£m báº£o há»£p Ä‘á»“ng giá»¯a ALS vÃ  cÃ¡c client (e.g. reporting-service, admin UI) khÃ´ng bá»‹ phÃ¡ vá»¡</td>
</tr>
<tr>
<td>Pub/Sub Schema</td>
<td>DÃ¹ng JSON Schema Registry hoáº·c Spectral Ä‘á»ƒ xÃ¡c thá»±c cáº¥u trÃºc <code>audit.*.v1</code> theo <code>ADR-030</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>âœ… Má»—i consumer service sáº½ cÃ³ báº£n há»£p Ä‘á»“ng riÃªng Ä‘á»ƒ mÃ´ phá»ng dá»¯ liá»‡u gá»­i vÃ  assert káº¿t quáº£ mong Ä‘á»£i.</p>
</blockquote>
<hr/>
<h3 id="84-load-testing-resilience">8.4. ğŸ“Š Load Testing &amp; Resilience<a class="headerlink" href="#84-load-testing-resilience" title="Permanent link">Â¶</a></h3>
<ul>
<li>DÃ¹ng Locust hoáº·c k6 Ä‘á»ƒ kiá»ƒm tra:</li>
<li>Kháº£ nÄƒng xá»­ lÃ½ 1000â€“10000 log/giÃ¢y (qua HTTP + Pub/Sub)</li>
<li>Äá»™ trá»… trung bÃ¬nh vÃ  P95/P99 dÆ°á»›i 300ms</li>
<li>Kháº£ nÄƒng scale theo policy Cloud Run (<code>ADR-016</code>)</li>
<li>MÃ´ phá»ng lá»—i BigQuery táº¡m thá»i Ä‘á»ƒ kiá»ƒm tra fallback hoáº·c retry logic</li>
</ul>
<hr/>
<h3 id="85-security-testing">8.5. ğŸ” Security Testing<a class="headerlink" href="#85-security-testing" title="Permanent link">Â¶</a></h3>
<ul>
<li>Fuzz test trÆ°á»ng <code>payload_*</code> Ä‘á»ƒ kiá»ƒm tra lá»— há»•ng xá»­ lÃ½ JSON</li>
<li>Kiá»ƒm tra báº£o vá»‡ field <code>tenant_id</code>, khÃ´ng Ä‘á»ƒ user truy cáº­p chÃ©o tenant</li>
<li>Kiá»ƒm tra injection hoáº·c bypass thÃ´ng qua trÆ°á»ng <code>user_agent</code>, <code>trace_id</code></li>
</ul>
<hr/>
<h3 id="86-regression-testing-ci-automation">8.6. ğŸ” Regression Testing &amp; CI Automation<a class="headerlink" href="#86-regression-testing-ci-automation" title="Permanent link">Â¶</a></h3>
<ul>
<li>TÃ­ch há»£p toÃ n bá»™ test suite vÃ o pipeline GitHub Actions</li>
<li>Má»—i PR báº¯t buá»™c pass toÃ n bá»™ test trÆ°á»›c khi deploy staging</li>
<li>Truy váº¿t lá»—i vÃ  coverage vá»›i badge trong README repo</li>
</ul>
<hr/>
<h2 id="9-observability-monitoring">9. ğŸ” Observability &amp; Monitoring<a class="headerlink" href="#9-observability-monitoring" title="Permanent link">Â¶</a></h2>
<p>Audit Logging Service (ALS) lÃ  thÃ nh pháº§n trá»ng yáº¿u vá» báº£o máº­t vÃ  truy váº¿t, do Ä‘Ã³ pháº£i cÃ³ kháº£ nÄƒng quan sÃ¡t vÃ  giÃ¡m sÃ¡t toÃ n diá»‡n á»Ÿ cáº¥p Ä‘á»™ <strong>há»‡ thá»‘ng, á»©ng dá»¥ng vÃ  hÃ nh vi dá»¯ liá»‡u</strong>. Thiáº¿t káº¿ observability cá»§a ALS tuÃ¢n thá»§ <code>ADR-021</code> vÃ  Ä‘Æ°á»£c triá»ƒn khai theo 4 lá»›p: logging, metrics, tracing vÃ  alerting.</p>
<hr/>
<h3 id="91-logging-nhat-ky-dich-vu">9.1. ğŸ“„ Logging (Nháº­t kÃ½ dá»‹ch vá»¥)<a class="headerlink" href="#91-logging-nhat-ky-dich-vu" title="Permanent link">Â¶</a></h3>
<ul>
<li>ToÃ n bá»™ log há»‡ thá»‘ng vÃ  á»©ng dá»¥ng Ä‘á»u Ä‘Æ°á»£c ghi á»Ÿ Ä‘á»‹nh dáº¡ng <strong>structured JSON</strong>.</li>
<li>CÃ¡c trÆ°á»ng báº¯t buá»™c trong má»—i dÃ²ng log:</li>
<li><code>timestamp</code>, <code>trace_id</code>, <code>tenant_id</code>, <code>actor_user_id</code>, <code>action</code>, <code>status</code>, <code>duration_ms</code></li>
<li>CÃ¡c tÃ¬nh huá»‘ng log:</li>
<li>Log tiáº¿p nháº­n thÃ nh cÃ´ng sá»± kiá»‡n audit</li>
<li>Log tá»« chá»‘i do vi pháº¡m RBAC hoáº·c thiáº¿u JWT</li>
<li>Log lá»—i ghi dá»¯ liá»‡u xuá»‘ng BigQuery</li>
<li>Log masking trÆ°á»ng PII (kÃ¨m cÃ¡c trÆ°á»ng Ä‘Ã£ bá»‹ mask)</li>
</ul>
<blockquote>
<p>âœ… Táº¥t cáº£ log Ä‘Æ°á»£c gá»­i vá» Cloud Logging (Stackdriver) vÃ  cÃ³ thá»ƒ xuáº¥t sang BigQuery Ä‘á»ƒ phÃ¢n tÃ­ch sÃ¢u.</p>
</blockquote>
<hr/>
<h3 id="92-metrics-giam-sat-hieu-nang-so-luong">9.2. ğŸ“ˆ Metrics (GiÃ¡m sÃ¡t hiá»‡u nÄƒng &amp; sá»‘ lÆ°á»£ng)<a class="headerlink" href="#92-metrics-giam-sat-hieu-nang-so-luong" title="Permanent link">Â¶</a></h3>
<p>Audit Logging Service xuáº¥t cÃ¡c chá»‰ sá»‘ Prometheus tiÃªu chuáº©n Ä‘á»ƒ theo dÃµi hiá»‡u nÄƒng vÃ  Ä‘á»™ á»•n Ä‘á»‹nh:</p>
<table>
<thead>
<tr>
<th>TÃªn metric</th>
<th>NhÃ£n</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auditlog_ingest_total</code></td>
<td><code>source</code>, <code>status</code></td>
<td>Sá»‘ lÆ°á»£ng log tiáº¿p nháº­n theo nguá»“n vÃ  tráº¡ng thÃ¡i</td>
</tr>
<tr>
<td><code>auditlog_ingest_failed_total</code></td>
<td><code>error_type</code></td>
<td>Sá»‘ log tiáº¿p nháº­n tháº¥t báº¡i (e.g. schema_invalid, rbac_denied)</td>
</tr>
<tr>
<td><code>auditlog_latency_ms</code></td>
<td><code>operation</code>, <code>status</code></td>
<td>Thá»i gian xá»­ lÃ½ ghi log vÃ  truy váº¥n log</td>
</tr>
<tr>
<td><code>auditlog_query_count</code></td>
<td><code>tenant_id</code>, <code>actor_user_id</code></td>
<td>Sá»‘ lÆ°á»£t truy váº¥n log qua API</td>
</tr>
<tr>
<td><code>auditlog_mask_applied_total</code></td>
<td><code>field</code></td>
<td>Sá»‘ láº§n Ã¡p dá»¥ng masking cho má»—i field nháº¡y cáº£m</td>
</tr>
</tbody>
</table>
<blockquote>
<p>âœ… Metrics Ä‘Æ°á»£c scrape Ä‘á»‹nh ká»³ vÃ  hiá»ƒn thá»‹ qua Grafana dashboard chuyÃªn biá»‡t cho audit-log.</p>
</blockquote>
<hr/>
<h3 id="93-tracing-theo-doi-hanh-trinh-request">9.3. ğŸ” Tracing (Theo dÃµi hÃ nh trÃ¬nh request)<a class="headerlink" href="#93-tracing-theo-doi-hanh-trinh-request" title="Permanent link">Â¶</a></h3>
<ul>
<li>ALS tÃ­ch há»£p <strong>OpenTelemetry</strong> Ä‘á»ƒ trace toÃ n bá»™ hÃ nh trÃ¬nh tá»« khi nháº­n request Ä‘áº¿n khi ghi log thÃ nh cÃ´ng.</li>
<li>Má»—i request pháº£i cÃ³ <code>trace_id</code>, vÃ  trace Ä‘Æ°á»£c gá»­i Ä‘áº¿n backend nhÆ° Cloud Trace hoáº·c Jaeger.</li>
<li>CÃ¡c span chÃ­nh:</li>
<li><code>receive_event</code></li>
<li><code>validate_and_mask</code></li>
<li><code>write_to_storage</code></li>
<li><code>emit_persisted_event</code></li>
<li><code>serve_query_result</code></li>
</ul>
<blockquote>
<p>âœ… Dá»… dÃ ng truy váº¿t cÃ¡c bottleneck khi há»‡ thá»‘ng scale lá»›n hoáº·c khi cÃ³ log ghi cháº­m.</p>
</blockquote>
<hr/>
<h3 id="94-alerting-canh-bao-tu-ong">9.4. ğŸš¨ Alerting (Cáº£nh bÃ¡o tá»± Ä‘á»™ng)<a class="headerlink" href="#94-alerting-canh-bao-tu-ong" title="Permanent link">Â¶</a></h3>
<p>Äá»‹nh nghÄ©a cáº£nh bÃ¡o chá»§ Ä‘á»™ng Ä‘á»ƒ Ä‘áº£m báº£o ALS váº­n hÃ nh á»•n Ä‘á»‹nh vÃ  phÃ¡t hiá»‡n sá»›m sá»± cá»‘:</p>
<table>
<thead>
<tr>
<th>Cáº£nh bÃ¡o</th>
<th>Äiá»u kiá»‡n</th>
<th>Má»©c Ä‘á»™</th>
</tr>
</thead>
<tbody>
<tr>
<td>Lá»—i ingest tÄƒng báº¥t thÆ°á»ng</td>
<td><code>auditlog_ingest_failed_total &gt; 100</code> trong 5 phÃºt</td>
<td>âš ï¸ Warning</td>
</tr>
<tr>
<td>Latency tÄƒng cao</td>
<td><code>auditlog_latency_ms{operation="write"}</code> P95 &gt; 500ms</td>
<td>ğŸ”¥ Critical</td>
</tr>
<tr>
<td>KhÃ´ng cÃ³ log nÃ o trong 10 phÃºt</td>
<td><code>auditlog_ingest_total</code> = 0</td>
<td>â— Warning</td>
</tr>
<tr>
<td>Masking failed</td>
<td>KhÃ´ng cÃ³ metric <code>auditlog_mask_applied_total</code> &gt; 0 trong 1h</td>
<td>ğŸš¨ Security</td>
</tr>
</tbody>
</table>
<blockquote>
<p>âœ… Cáº£nh bÃ¡o Ä‘Æ°á»£c cáº¥u hÃ¬nh qua Cloud Monitoring Alerting hoáº·c Prometheus + Alertmanager tÃ¹y mÃ´i trÆ°á»ng.</p>
</blockquote>
<hr/>
<h2 id="10-o-tin-cay-phuc-hoi-reliability-resilience">10. ğŸš€ Äá»™ tin cáº­y &amp; Phá»¥c há»“i (Reliability &amp; Resilience)<a class="headerlink" href="#10-o-tin-cay-phuc-hoi-reliability-resilience" title="Permanent link">Â¶</a></h2>
<p>Audit Logging Service (ALS) Ä‘Æ°á»£c thiáº¿t káº¿ vá»›i má»¥c tiÃªu <strong>khÃ´ng Ä‘Ã¡nh máº¥t báº£n ghi nÃ o</strong>, ngay cáº£ trong Ä‘iá»u kiá»‡n máº¡ng khÃ´ng á»•n Ä‘á»‹nh, lá»—i há»‡ thá»‘ng táº¡m thá»i, hoáº·c táº£i cao báº¥t ngá». Kháº£ nÄƒng phá»¥c há»“i vÃ  tá»± Ä‘á»™ng Ä‘áº£m báº£o tÃ­nh toÃ n váº¹n dá»¯ liá»‡u lÃ  Æ°u tiÃªn hÃ ng Ä‘áº§u.</p>
<hr/>
<h3 id="101-co-che-retry-thong-minh">10.1. ğŸ” CÆ¡ cháº¿ Retry thÃ´ng minh<a class="headerlink" href="#101-co-che-retry-thong-minh" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Luá»“ng</th>
<th>CÆ¡ cháº¿ Retry</th>
</tr>
</thead>
<tbody>
<tr>
<td>HTTP Ingestion</td>
<td>Náº¿u ghi BigQuery tháº¥t báº¡i (e.g. lá»—i máº¡ng, quota), retry tá»‘i Ä‘a 3 láº§n vá»›i backoff</td>
</tr>
<tr>
<td>Pub/Sub Consumer</td>
<td>Sá»­ dá»¥ng ack deadline má»Ÿ rá»™ng, vÃ  chá»‰ ack khi ghi log thÃ nh cÃ´ng. Náº¿u tháº¥t báº¡i â†’ tá»± Ä‘á»™ng redeliver sau 10s</td>
</tr>
<tr>
<td>Emit sá»± kiá»‡n <code>audit_log_persisted.v1</code></td>
<td>Gá»­i láº¡i náº¿u tháº¥t báº¡i táº¡m thá»i, log warning náº¿u fail vÄ©nh viá»…n</td>
</tr>
</tbody>
</table>
<blockquote>
<p>âœ… Äáº£m báº£o khÃ´ng máº¥t log do lá»—i táº¡m thá»i vÃ  khÃ´ng double-count nhá» <code>id</code> duy nháº¥t.</p>
</blockquote>
<hr/>
<h3 id="102-bao-ve-idempotency-chong-log-trung">10.2. ğŸ§¾ Báº£o vá»‡ idempotency (chá»‘ng log trÃ¹ng)<a class="headerlink" href="#102-bao-ve-idempotency-chong-log-trung" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»—i log mang <code>id</code> duy nháº¥t (UUID v4 hoáº·c hash(trace_id + action))</li>
<li>Khi ghi xuá»‘ng BigQuery/Firestore, ALS kiá»ƒm tra tá»“n táº¡i <code>id</code> trÆ°á»›c khi ghi</li>
<li>CÆ¡ cháº¿ nÃ y Ä‘áº£m báº£o:</li>
<li>TrÃ¡nh trÃ¹ng log do retry</li>
<li>Cho phÃ©p cÃ¡c client <code>at-least-once</code> mÃ  khÃ´ng áº£nh hÆ°á»Ÿng tá»›i tÃ­nh toÃ n váº¹n dá»¯ liá»‡u</li>
</ul>
<hr/>
<h3 id="103-phuc-hoi-sau-loi-he-thong">10.3. ğŸ§  Phá»¥c há»“i sau lá»—i há»‡ thá»‘ng<a class="headerlink" href="#103-phuc-hoi-sau-loi-he-thong" title="Permanent link">Â¶</a></h3>
<ul>
<li>Táº¥t cáº£ Pub/Sub consumer Ä‘á»u <strong>stateless</strong>, cÃ³ thá»ƒ restart khÃ´ng máº¥t offset</li>
<li>BigQuery vÃ  Firestore lÃ  <strong>managed storage</strong> vá»›i Ä‘áº£m báº£o HA/DR bá»Ÿi GCP</li>
<li>Trong trÆ°á»ng há»£p máº¥t káº¿t ná»‘i BigQuery:</li>
<li>Táº¡m thá»i ghi vÃ o hÃ ng Ä‘á»£i ná»™i bá»™ (memory ring buffer hoáº·c Firestore cache)</li>
<li>Log warning â†’ gá»­i alert â†’ retry sau</li>
</ul>
<hr/>
<h3 id="104-kiem-thu-resilience">10.4. ğŸ§ª Kiá»ƒm thá»­ resilience<a class="headerlink" href="#104-kiem-thu-resilience" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Ká»‹ch báº£n</th>
<th>MÃ´ phá»ng kiá»ƒm thá»­</th>
</tr>
</thead>
<tbody>
<tr>
<td>BigQuery timeout</td>
<td>Cáº¯t máº¡ng tá»›i BigQuery trong 30s</td>
</tr>
<tr>
<td>Pub/Sub redelivery</td>
<td>Gá»­i duplicate event trong Pub/Sub</td>
</tr>
<tr>
<td>Client retry</td>
<td>Gá»­i 5 request ghi log giá»‘ng nhau trong 1 giÃ¢y</td>
</tr>
<tr>
<td>Process crash</td>
<td>Kill container giá»¯a chá»«ng khi Ä‘ang ghi log</td>
</tr>
<tr>
<td>High load burst</td>
<td>Gá»­i 50k log trong 1 phÃºt, quan sÃ¡t P99 latency</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="11-kien-truc-service-service-architecture-overview">11. ğŸ§© Kiáº¿n trÃºc Service (Service Architecture Overview)<a class="headerlink" href="#11-kien-truc-service-service-architecture-overview" title="Permanent link">Â¶</a></h2>
<p>Audit Logging Service (ALS) Ä‘Æ°á»£c triá»ƒn khai dÆ°á»›i dáº¡ng <strong>stateless microservice</strong> vÃ  lÃ  má»™t thÃ nh pháº§n Ä‘á»™c láº­p trong <code>core stack</code> cá»§a há»‡ thá»‘ng <code>dx-vas</code>. Service nÃ y váº­n hÃ nh theo mÃ´ hÃ¬nh event-driven káº¿t há»£p REST, há»— trá»£ ghi nháº­n log Ä‘a nguá»“n, Ä‘a hÃ¬nh thá»©c vÃ  Ä‘áº£m báº£o toÃ n váº¹n trong mÃ´i trÆ°á»ng multi-tenant.</p>
<hr/>
<h3 id="111-so-o-kien-truc-tong-the">11.1. ğŸ–¼ SÆ¡ Ä‘á»“ Kiáº¿n trÃºc Tá»•ng thá»ƒ<a class="headerlink" href="#111-so-o-kien-truc-tong-the" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>flowchart TD
    subgraph Platform[Platform Core]
      GW[API Gateway]
    end

    subgraph ExternalSources[External Sources]
      UI[Admin WebApp]
    end

    subgraph CoreServices[Core Services]
      US(UserService)
      AS(AuthService)
      RS(ReportingService)
      NS(NotificationService)
    end

    subgraph ALS["Audit Logging Service"]
      ALSAPI[HTTP Ingestion API]
      ALSPS[Pub/Sub Consumer]
      MASK[PII Masker]
      STORE[Storage EngineBigQuery/Firestore]
      QUERY[Query API]
      METRIC[Metrics Exporter]
      TRACER[OpenTelemetry Agent]
    end

    subgraph Infra
      PUBSUB["Topic: audit.events.v1"]
      BIGQUERY["BigQuery Dataset"]
      FIRESTORE["Firestore (Optional)"]
      PROM[Prometheus/Grafana]
      TRACE[Cloud Trace / Jaeger]
    end

    %% Ingestion Paths
    UI --&gt;|Gá»­i request| GW
    GW --&gt;|POST /audit-log| ALSAPI
    CoreServices --&gt;|Emit audit.*.v1| PUBSUB
    PUBSUB --&gt; ALSPS
    ALSAPI --&gt; MASK
    ALSPS --&gt; MASK
    MASK --&gt; STORE

    %% Storage
    STORE --&gt; BIGQUERY
    STORE --&gt; FIRESTORE

    %% Observability
    ALS --&gt; METRIC --&gt; PROM
    ALS --&gt; TRACER --&gt; TRACE

    %% Query
    UI --&gt;|GET /audit-log| GW
    GW --&gt; QUERY
    QUERY --&gt; BIGQUERY
</code></pre>
<hr/>
<h3 id="112-ghi-chu-kien-truc">11.2. ğŸ“Œ Ghi chÃº Kiáº¿n trÃºc<a class="headerlink" href="#112-ghi-chu-kien-truc" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>ThÃ nh pháº§n</th>
<th>Vai trÃ²</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>HTTP Ingestion API</strong></td>
<td>Nháº­n log tá»« cÃ¡c service ná»™i bá»™ khÃ´ng dÃ¹ng Pub/Sub</td>
</tr>
<tr>
<td><strong>Pub/Sub Consumer</strong></td>
<td>Xá»­ lÃ½ sá»± kiá»‡n <code>audit.events.v1</code> phÃ¡t tá»« core services</td>
</tr>
<tr>
<td><strong>PII Masker</strong></td>
<td>Ãp dá»¥ng chÃ­nh sÃ¡ch masking (ADR-024) trÆ°á»›c khi lÆ°u</td>
</tr>
<tr>
<td><strong>Storage Engine</strong></td>
<td>Ghi log vÃ o BigQuery (máº·c Ä‘á»‹nh) hoáº·c Firestore</td>
</tr>
<tr>
<td><strong>Query API</strong></td>
<td>Cho phÃ©p Admin, DevOps truy váº¥n log Ä‘a Ä‘iá»u kiá»‡n</td>
</tr>
<tr>
<td><strong>Observability</strong></td>
<td>Káº¿t ná»‘i OpenTelemetry + Prometheus theo <code>ADR-021</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="113-trien-khai-dang-tach-lop">11.3. ğŸŒ Triá»ƒn khai dáº¡ng tÃ¡ch lá»›p<a class="headerlink" href="#113-trien-khai-dang-tach-lop" title="Permanent link">Â¶</a></h3>
<p>Äá»ƒ tá»‘i Æ°u hoÃ¡ hiá»‡u suáº¥t vÃ  kháº£ nÄƒng má»Ÿ rá»™ng, cÃ¡c thÃ nh pháº§n cÃ³ thá»ƒ Ä‘Æ°á»£c tÃ¡ch riÃªng:</p>
<table>
<thead>
<tr>
<th>Module</th>
<th>Triá»ƒn khai riÃªng?</th>
<th>Ghi chÃº</th>
</tr>
</thead>
<tbody>
<tr>
<td>HTTP API &amp; Query API</td>
<td>âœ…</td>
<td>CÃ¹ng má»™t container</td>
</tr>
<tr>
<td>Pub/Sub Consumer</td>
<td>âœ…</td>
<td>CÃ³ thá»ƒ scale Ä‘á»™c láº­p khi lÆ°á»£ng log tÄƒng</td>
</tr>
<tr>
<td>Storage Adapter</td>
<td>â›”</td>
<td>KhÃ´ng cáº§n tÃ¡ch (gá»i sync tá»« masker)</td>
</tr>
<tr>
<td>Metrics + Tracer</td>
<td>â›”</td>
<td>DÃ¹ng sidecar hoáº·c thÆ° viá»‡n nhÃºng</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="12-tai-lieu-lien-quan">12. ğŸ“š TÃ i liá»‡u liÃªn quan<a class="headerlink" href="#12-tai-lieu-lien-quan" title="Permanent link">Â¶</a></h2>
<ul>
<li><a href="../interface-contract/">Interface Contract</a></li>
<li><a href="../data-model/">Data Model</a></li>
<li><a href="../openapi.yaml">OpenAPI Spec</a></li>
<li><a href="./">Design</a></li>
<li><a href="../../../ADR/adr-001-ci-cd/">ADR-001 CI/CD Pipeline</a>: Quy trÃ¬nh build, test vÃ  deploy dá»‹ch vá»¥ ALS theo pipeline tá»± Ä‘á»™ng.</li>
<li><a href="../../../ADR/adr-003-secrets/">ADR-003 Secrets Management</a>: Quy trÃ¬nh lÆ°u trá»¯ &amp; xoay khÃ³a bÃ­ máº­t an toÃ n, Ã¡p dá»¥ng cho JWT signing vÃ  GCP credentials.</li>
<li><a href="../../../ADR/adr-004-security/">ADR-004 Security Policy</a>: ChÃ­nh sÃ¡ch báº£o máº­t tá»•ng thá»ƒ cho há»‡ thá»‘ng dx-vas.</li>
<li><a href="../../../ADR/adr-005-env-config/">ADR-005 Environment Config</a>: Cáº¥u hÃ¬nh mÃ´i trÆ°á»ng vÃ  danh sÃ¡ch biáº¿n mÃ´i trÆ°á»ng cáº§n thiáº¿t cho ALS.</li>
<li><a href="../../../ADR/adr-006-auth-strategy/">ADR-006 Auth Strategy</a>: CÃ¡ch xÃ¡c thá»±c ngÆ°á»i dÃ¹ng vÃ  service tÆ°Æ¡ng tÃ¡c vá»›i Audit Logging API.</li>
<li><a href="../../../ADR/adr-007-rbac/">ADR-007 RBAC Strategy</a>: CÆ¡ cháº¿ kiá»ƒm soÃ¡t quyá»n truy váº¥n log theo tenant vÃ  vai trÃ².</li>
<li><a href="../../../ADR/adr-008-audit-logging/">ADR-008 Audit Logging</a>: Äá»‹nh nghÄ©a Ä‘á»‹nh dáº¡ng báº£n ghi, trace ID vÃ  hÃ nh vi logging chuáº©n.</li>
<li><a href="../../../ADR/adr-010-contract-testing/">ADR-010 Contract Testing</a>: HÆ°á»›ng dáº«n kiá»ƒm thá»­ há»£p Ä‘á»“ng API vÃ  Pub/Sub giá»¯a ALS vÃ  cÃ¡c client.</li>
<li><a href="../../../ADR/adr-014-zero-downtime/">ADR-014 Zero Downtime Deployment</a>: CÆ¡ cháº¿ triá»ƒn khai khÃ´ng giÃ¡n Ä‘oáº¡n cho cÃ¡c thay Ä‘á»•i dá»‹ch vá»¥ audit.</li>
<li><a href="../../../ADR/adr-015-deployment-strategy/">ADR-015 Deployment Strategy</a>: Chiáº¿n lÆ°á»£c rollout, canary vÃ  rollback Ã¡p dá»¥ng cho ALS.</li>
<li><a href="../../../ADR/adr-016-auto-scaling/">ADR-016 Auto Scaling</a>: Cáº¥u hÃ¬nh autoscale Cloud Run dá»±a trÃªn QPS vÃ  CPU threshold.</li>
<li><a href="../../../ADR/adr-017-env-deploy-boundary/">ADR-017 Environment Deployment Boundary</a>: PhÃ¢n tÃ¡ch mÃ´i trÆ°á»ng audit giá»¯a staging/production.</li>
<li><a href="../../../ADR/adr-021-external-observability/">ADR-021 External Observability</a>: Chiáº¿n lÆ°á»£c quan sÃ¡t há»‡ thá»‘ng audit tá»« bÃªn ngoÃ i.</li>
<li><a href="../../../ADR/adr-024-data-anonymization-retention/">ADR-024 Data Anonymization &amp; Retention</a>: Masking PII vÃ  chÃ­nh sÃ¡ch retention dá»¯ liá»‡u audit.</li>
<li><a href="../../../ADR/adr-026-hard-delete-policy/">ADR-026 Hard Delete Policy</a>: ChÃ­nh sÃ¡ch xÃ³a vÄ©nh viá»…n dá»¯ liá»‡u log sau thá»i gian lÆ°u trá»¯.</li>
<li><a href="../../../ADR/adr-027-data-management-strategy/">ADR-027 Data Management Strategy</a>: Quáº£n lÃ½ vÃ²ng Ä‘á»i dá»¯ liá»‡u log, phÃ¢n vÃ¹ng vÃ  clustering.</li>
<li><a href="../../../ADR/adr-030-event-schema-governance/">ADR-030 Event Schema Governance</a>: Quáº£n lÃ½ schema sá»± kiá»‡n <code>audit.events.v1</code> cho Pub/Sub.</li>
</ul>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Trá»Ÿ láº¡i má»¥c lá»¥c
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>