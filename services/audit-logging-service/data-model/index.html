
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Tài liệu kiến trúc và phát triển cho dự án Chuyển đổi số Trường Việt Anh." name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://ezdesign-vn.github.io/dx-vas/services/audit-logging-service/data-model/" rel="canonical"/>
<link href="../../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Audit Logging Service - Data Model - DX VAS - Docs</title>
<link href="../../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#audit-logging-service-data-model">
          Bỏ qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Đầu trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Audit Logging Service - Data Model
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Tìm kiếm" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Tìm kiếm" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Tìm kiếm" class="md-search__options">
<button aria-label="Xoá" class="md-search__icon md-icon" tabindex="-1" title="Xoá" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mã nguồn">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../architecture/system-diagrams/">
          
  
  
    
  
  Kiến trúc Hệ thống

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../dev-guide/">
        
  
  
    
  
  Hướng dẫn Phát triển

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../">
        
  
  
    
  
  Thiết kế Services

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../ADR/">
          
  
  
    
  
  Quyết định Kiến trúc (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh điều hướng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mã nguồn">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Kiến trúc Hệ thống
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Kiến trúc Hệ thống
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/system-diagrams/">
<span class="md-ellipsis">
    Sơ đồ Hệ thống
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/rbac-deep-dive/">
<span class="md-ellipsis">
    RBAC Chi tiết
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../dev-guide/">
<span class="md-ellipsis">
    Hướng dẫn Phát triển
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    Thiết kế Services
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ADR/">
<span class="md-ellipsis">
    Quyết định Kiến trúc (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quyết định Kiến trúc (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Mục lục" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Mục lục
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-pham-vi-du-lieu-quan-ly-scope">
<span class="md-ellipsis">
      1. Phạm vi Dữ liệu Quản lý (Scope)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-ngoai-pham-vi-out-of-scope">
<span class="md-ellipsis">
      2. Ngoài Phạm Vi (Out of Scope)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-muc-tieu-cua-tai-lieu-mo-hinh-du-lieu">
<span class="md-ellipsis">
      3. Mục tiêu của Tài liệu Mô hình Dữ liệu
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-so-o-erd">
<span class="md-ellipsis">
      4. Sơ đồ ERD
    </span>
</a>
<nav aria-label="4. Sơ đồ ERD" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#41-so-o-tong-the">
<span class="md-ellipsis">
      4.1. Sơ đồ tổng thể
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#42-ghi-chu-mo-hinh">
<span class="md-ellipsis">
      4.2. Ghi chú mô hình
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#43-tuong-quan-thuc-te-voi-he-thong">
<span class="md-ellipsis">
      4.3. Tương quan thực tế với hệ thống
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-chi-tiet-tung-bang">
<span class="md-ellipsis">
      5. Chi tiết Từng Bảng
    </span>
</a>
<nav aria-label="5. Chi tiết Từng Bảng" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-bang-audit_logs">
<span class="md-ellipsis">
      5.1. 📌 Bảng: audit_logs
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-bang-processed_events">
<span class="md-ellipsis">
      5.2. 📌 Bảng: processed_events
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-indexes-constraints">
<span class="md-ellipsis">
      6. Indexes &amp; Constraints
    </span>
</a>
<nav aria-label="6. Indexes &amp; Constraints" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-bang-audit_logs">
<span class="md-ellipsis">
      6.1. Bảng: audit_logs
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-bang-processed_events">
<span class="md-ellipsis">
      6.2. Bảng: processed_events
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#goi-y-nang-cao">
<span class="md-ellipsis">
      🔧 Gợi ý nâng cao
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-chinh-sach-luu-tru-xoa">
<span class="md-ellipsis">
      7. Chính sách Lưu trữ &amp; Xóa
    </span>
</a>
<nav aria-label="7. Chính sách Lưu trữ &amp; Xóa" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-thoi-gian-luu-tru-retention-period">
<span class="md-ellipsis">
      7.1. ⏳ Thời gian lưu trữ (Retention Period)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-chien-luoc-xoa-du-lieu-deletion-strategy">
<span class="md-ellipsis">
      7.2. 🧹 Chiến lược Xóa Dữ liệu (Deletion Strategy)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-chinh-sach-anonymization-an-danh-du-lieu">
<span class="md-ellipsis">
      7.3. 🔐 Chính sách Anonymization (Ẩn danh dữ liệu)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-du-lieu-tam-thoi">
<span class="md-ellipsis">
      7.4. ✈️ Dữ liệu tạm thời
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#75-kiem-thu-quan-sat-retention">
<span class="md-ellipsis">
      7.5. 🧪 Kiểm thử &amp; Quan sát Retention
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-phan-quyen-truy-cap-du-lieu">
<span class="md-ellipsis">
      8. Phân quyền Truy cập Dữ liệu
    </span>
</a>
<nav aria-label="8. Phân quyền Truy cập Dữ liệu" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-pham-vi-truy-cap-theo-vai-tro-role-based-access">
<span class="md-ellipsis">
      8.1. Phạm vi truy cập theo vai trò (Role-based Access)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-masking-ong-du-lieu">
<span class="md-ellipsis">
      8.2. Masking động dữ liệu
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-ieu-kien-rang-buoc-theo-tenant">
<span class="md-ellipsis">
      8.3. Điều kiện ràng buộc theo Tenant
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#84-scope-bat-buoc-trong-jwt">
<span class="md-ellipsis">
      8.4. Scope bắt buộc trong JWT
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#85-policy-trien-khai-tren-api-gateway">
<span class="md-ellipsis">
      8.5. Policy triển khai trên API Gateway
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-mo-rong-trong-tuong-lai">
<span class="md-ellipsis">
      9. Mở rộng trong Tương Lai
    </span>
</a>
<nav aria-label="9. Mở rộng trong Tương Lai" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#91-phat-su-kien-thu-cap-vasauditpersistedv1">
<span class="md-ellipsis">
      9.1. 🚀 Phát sự kiện thứ cấp vas.audit.persisted.v1
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#92-tu-ong-phat-hien-hanh-vi-bat-thuong-anomaly-detection">
<span class="md-ellipsis">
      9.2. 🧠 Tự động phát hiện hành vi bất thường (Anomaly Detection)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#93-ho-tro-nhieu-backend-luu-tru">
<span class="md-ellipsis">
      9.3. 📦 Hỗ trợ nhiều backend lưu trữ
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#94-truy-van-nang-cao-cho-bao-cao">
<span class="md-ellipsis">
      9.4. 🧾 Truy vấn nâng cao cho báo cáo
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#95-retry-co-che-tieu-thu-pubsub">
<span class="md-ellipsis">
      9.5. 🔁 Retry cơ chế tiêu thụ Pub/Sub
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#96-kiem-toan-cac-truy-van-nhay-cam">
<span class="md-ellipsis">
      9.6. 🔒 Kiểm toán các truy vấn nhạy cảm
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#97-admin-dashboard-mini">
<span class="md-ellipsis">
      9.7. 🛠 Admin Dashboard Mini
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-enums">
<span class="md-ellipsis">
      10. ENUMs
    </span>
</a>
<nav aria-label="10. ENUMs" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#101-truong-status">
<span class="md-ellipsis">
      10.1. 📌 Trường status
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#102-truong-resource_type">
<span class="md-ellipsis">
      10.2. 📌 Trường resource_type
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#103-truong-action">
<span class="md-ellipsis">
      10.3. 📌 Trường action
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ghi-chu-ve-quan-ly-enums">
<span class="md-ellipsis">
      🔎 Ghi chú về quản lý ENUMs
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-lien-ket-tai-lieu">
<span class="md-ellipsis">
      11. 📚 Liên kết Tài liệu
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="audit-logging-service-data-model">🗃️ Audit Logging Service - Data Model<a class="headerlink" href="#audit-logging-service-data-model" title="Permanent link">¶</a></h1>
<p>Tài liệu này mô tả chi tiết mô hình dữ liệu của <strong>Audit Logging Service</strong> – một service <strong>cốt lõi</strong> trong hệ thống <code>dx-vas</code>, hoạt động theo kiến trúc <strong>event-driven + REST hybrid</strong>, đa tenant.</p>
<p><strong>Audit Logging Service</strong> chịu trách nhiệm quản lý các loại dữ liệu chính sau:
- Bản ghi hành vi người dùng (<code>audit_logs</code>)
- Sự kiện đã xử lý (<code>processed_events</code>) – phục vụ kiểm soát idempotency
- Các bảng ENUM mở rộng (trạng thái, loại tài nguyên, v.v.)</p>
<hr/>
<h2 id="1-pham-vi-du-lieu-quan-ly-scope">1. Phạm vi Dữ liệu Quản lý (Scope)<a class="headerlink" href="#1-pham-vi-du-lieu-quan-ly-scope" title="Permanent link">¶</a></h2>
<p>Audit Logging Service bao gồm việc quản lý:
- Bản ghi hành vi người dùng hoặc hệ thống từ các nguồn event hoặc HTTP nội bộ
- Metadata liên quan như <code>trace_id</code>, <code>actor_user_id</code>, <code>resource_type</code>, <code>action</code>, <code>input_parameters</code>
- Các bảng phụ để hỗ trợ lưu dấu <code>event_id</code> đã xử lý (Pub/Sub)
- Masking dữ liệu đầu vào theo quyền hạn</p>
<hr/>
<h2 id="2-ngoai-pham-vi-out-of-scope">2. Ngoài Phạm Vi (Out of Scope)<a class="headerlink" href="#2-ngoai-pham-vi-out-of-scope" title="Permanent link">¶</a></h2>
<p>Audit Logging Service <strong>không</strong> chịu trách nhiệm quản lý:
- ❌ Log hệ thống ứng dụng (debug/error logs)
- ❌ Quản lý người dùng, vai trò (user/role/permission)
- ❌ Trực tiếp alerting (chỉ phục vụ observability downstream)
- ❌ Phân tích dữ liệu (do hệ thống downstream xử lý)</p>
<hr/>
<h2 id="3-muc-tieu-cua-tai-lieu-mo-hinh-du-lieu">3. Mục tiêu của Tài liệu Mô hình Dữ liệu<a class="headerlink" href="#3-muc-tieu-cua-tai-lieu-mo-hinh-du-lieu" title="Permanent link">¶</a></h2>
<ul>
<li>Trình bày cấu trúc các bảng dữ liệu cốt lõi (<code>audit_logs</code>, <code>processed_events</code>)</li>
<li>Mô tả khóa chính/phụ, chỉ mục, ENUM</li>
<li>Tuân thủ các nguyên tắc và ràng buộc đã được định nghĩa trong các ADR liên quan:</li>
<li>RBAC: <a href="../../../ADR/adr-007-rbac/">ADR-007</a></li>
<li>Retention &amp; anonymization: <a href="../../../ADR/adr-024-data-anonymization-retention/">ADR-024</a></li>
<li>Chính sách không xóa vật lý: <a href="../../../ADR/adr-026-hard-delete-policy/">ADR-026</a></li>
<li>Quản lý schema sự kiện: <a href="../../../ADR/adr-030-event-schema-governance/">ADR-030</a></li>
<li>Cung cấp cơ sở dữ liệu cho việc thiết kế OpenAPI, cấu hình migration, auditing, observability, và tracing</li>
<li>Phục vụ kiểm thử dữ liệu và tracing</li>
</ul>
<hr/>
<h2 id="4-so-o-erd">4. Sơ đồ ERD<a class="headerlink" href="#4-so-o-erd" title="Permanent link">¶</a></h2>
<h3 id="41-so-o-tong-the">4.1. Sơ đồ tổng thể<a class="headerlink" href="#41-so-o-tong-the" title="Permanent link">¶</a></h3>
<pre class="mermaid"><code>erDiagram
  audit_logs {
    UUID id PK
    TEXT tenant_id
    TEXT trace_id
    TEXT actor_user_id
    TEXT action
    TEXT source_service
    TEXT resource_id
    TEXT resource_type
    TEXT status
    JSONB input_parameters
    TEXT ip_address
    TEXT user_agent
    TIMESTAMPTZ created_at
  }

  processed_events {
    UUID event_id PK
    TEXT consumer_group_name
    TIMESTAMPTZ processed_at
  }
</code></pre>
<hr/>
<h3 id="42-ghi-chu-mo-hinh">4.2. Ghi chú mô hình<a class="headerlink" href="#42-ghi-chu-mo-hinh" title="Permanent link">¶</a></h3>
<h4 id="audit_logs">🔹 <code>audit_logs</code><a class="headerlink" href="#audit_logs" title="Permanent link">¶</a></h4>
<ul>
<li>Là bảng chính của hệ thống, chứa toàn bộ bản ghi hành vi người dùng và hệ thống.</li>
<li>
<p>Dữ liệu được ghi nhận qua hai nguồn:</p>
</li>
<li>
<p>API nội bộ (<code>POST /audit-log</code>)</p>
</li>
<li>Consumer Pub/Sub (<code>audit.events.v1</code>)</li>
<li>Dữ liệu được <strong>partition theo <code>created_at</code></strong>, phục vụ mục đích retention (xem ADR-024).</li>
<li>Trường <code>input_parameters</code>, <code>ip_address</code>, <code>user_agent</code> có thể được <strong>mask động</strong> theo role.</li>
</ul>
<h4 id="processed_events">🔹 <code>processed_events</code><a class="headerlink" href="#processed_events" title="Permanent link">¶</a></h4>
<ul>
<li>Dùng để ghi nhận các sự kiện đã xử lý từ Pub/Sub, giúp đảm bảo <strong>idempotency</strong> và tránh ghi log trùng.</li>
<li><code>event_id</code> là UUID duy nhất phát sinh bởi producer, lấy từ metadata của event schema (tuân theo ADR-030).</li>
<li><code>consumer_group_name</code> là tên nhóm consumer định danh cho từng instance hoặc môi trường.</li>
<li>Không có quan hệ khóa ngoại vật lý đến <code>audit_logs</code> do mỗi event có thể ghi nhiều log hoặc không ghi gì (bị reject do validate schema sai).</li>
</ul>
<hr/>
<h3 id="43-tuong-quan-thuc-te-voi-he-thong">4.3. Tương quan thực tế với hệ thống<a class="headerlink" href="#43-tuong-quan-thuc-te-voi-he-thong" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Thành phần</th>
<th>Vai trò liên quan đến dữ liệu</th>
</tr>
</thead>
<tbody>
<tr>
<td>API Gateway</td>
<td>Gửi log HTTP qua <code>POST /audit-log</code>, tạo <code>audit_logs</code></td>
</tr>
<tr>
<td>Pub/Sub Consumer</td>
<td>Ghi log từ event → <code>audit_logs</code>, đồng thời ghi <code>processed_events</code></td>
</tr>
<tr>
<td>BigQuery</td>
<td>Hệ quản trị lưu trữ chính, dùng cho truy vấn và phân tích</td>
</tr>
<tr>
<td>Firestore (optional)</td>
<td>Lưu log tạm thời, phục vụ các dashboard nhỏ hoặc backup</td>
</tr>
<tr>
<td>Admin WebApp</td>
<td>Truy vấn dữ liệu từ bảng <code>audit_logs</code> qua API</td>
</tr>
<tr>
<td>Reporting Service</td>
<td>Đọc <code>audit_logs</code> theo <code>trace_id</code> để sinh báo cáo bảo mật</td>
</tr>
</tbody>
</table>
<hr/>
<p>📌 <strong>Lưu ý:</strong> Nếu trong tương lai triển khai tính năng phát sự kiện thứ cấp (<code>vas.audit.persisted.v1</code>), log ID từ <code>audit_logs</code> sẽ là thành phần chính của payload, nhưng không tạo ràng buộc khóa ngoại vật lý.</p>
<hr/>
<h2 id="5-chi-tiet-tung-bang">5. Chi tiết Từng Bảng<a class="headerlink" href="#5-chi-tiet-tung-bang" title="Permanent link">¶</a></h2>
<h3 id="51-bang-audit_logs">5.1. 📌 Bảng: <code>audit_logs</code><a class="headerlink" href="#51-bang-audit_logs" title="Permanent link">¶</a></h3>
<h4 id="muc-ich">🧾 Mục đích<a class="headerlink" href="#muc-ich" title="Permanent link">¶</a></h4>
<p>Lưu trữ các hành vi (audit log) phát sinh từ người dùng hoặc hệ thống nhằm phục vụ các mục tiêu:</p>
<ul>
<li>Truy vết hoạt động người dùng &amp; hệ thống</li>
<li>Phục vụ kiểm toán nội bộ và bên ngoài</li>
<li>Kết nối với báo cáo bảo mật, cảnh báo hành vi bất thường</li>
<li>Hỗ trợ hệ thống quan sát (observability), thống kê và AI phân tích</li>
</ul>
<p>Bảng này là trung tâm của <strong>Audit Logging Service</strong>, tiếp nhận dữ liệu từ 2 nguồn:</p>
<ul>
<li>HTTP API (<code>POST /audit-log</code>)</li>
<li>Consumer Pub/Sub (<code>audit.events.v1</code>)</li>
</ul>
<hr/>
<h4 id="cau-truc-sql">🧬 Cấu trúc SQL<a class="headerlink" href="#cau-truc-sql" title="Permanent link">¶</a></h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">audit_logs</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="n">tenant_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="n">trace_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="n">actor_user_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="n">action</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="n">source_service</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="n">resource_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="n">resource_type</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-10"><a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">'success'</span><span class="p">,</span><span class="w"> </span><span class="s1">'failure'</span><span class="p">,</span><span class="w"> </span><span class="s1">'warning'</span><span class="p">))</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-11"><a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="n">input_parameters</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
</span><span id="__span-0-12"><a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="n">ip_address</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-0-13"><a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="n">user_agent</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-0-14"><a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-0-15"><a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="p">);</span>
</span></code></pre></div>
<hr/>
<h4 id="giai-thich-cac-cot">📋 Giải thích các cột<a class="headerlink" href="#giai-thich-cac-cot" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Cột</th>
<th>Kiểu dữ liệu</th>
<th>Ràng buộc</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>UUID</td>
<td>PRIMARY KEY</td>
<td>Mã định danh duy nhất cho bản ghi log</td>
</tr>
<tr>
<td><code>tenant_id</code></td>
<td>TEXT</td>
<td>NOT NULL</td>
<td>Tenant tạo ra hành vi (RBAC được kiểm theo trường này)</td>
</tr>
<tr>
<td><code>trace_id</code></td>
<td>TEXT</td>
<td></td>
<td>ID truy vết toàn hệ thống (có thể trùng giữa nhiều log)</td>
</tr>
<tr>
<td><code>actor_user_id</code></td>
<td>TEXT</td>
<td></td>
<td>User ID gây ra hành vi (nếu có)</td>
</tr>
<tr>
<td><code>action</code></td>
<td>TEXT</td>
<td>NOT NULL</td>
<td>Mã hành động (e.g. <code>user.login.success</code>)</td>
</tr>
<tr>
<td><code>source_service</code></td>
<td>TEXT</td>
<td>NOT NULL</td>
<td>Tên service phát sinh hành động (e.g. <code>user-service</code>, <code>auth-service</code>)</td>
</tr>
<tr>
<td><code>resource_id</code></td>
<td>TEXT</td>
<td></td>
<td>ID đối tượng bị tác động (e.g. <code>u_123</code>, <code>t_123</code>)</td>
</tr>
<tr>
<td><code>resource_type</code></td>
<td>TEXT</td>
<td>NOT NULL</td>
<td>Loại đối tượng bị tác động (e.g. <code>user</code>, <code>tenant</code>)</td>
</tr>
<tr>
<td><code>status</code></td>
<td>TEXT</td>
<td>CHECK ENUM</td>
<td>Trạng thái kết quả (<code>success</code>, <code>failure</code>, <code>warning</code>)</td>
</tr>
<tr>
<td><code>input_parameters</code></td>
<td>JSONB</td>
<td></td>
<td>Payload ban đầu, có thể bị mask theo role</td>
</tr>
<tr>
<td><code>ip_address</code></td>
<td>TEXT</td>
<td></td>
<td>IP của actor (nếu có)</td>
</tr>
<tr>
<td><code>user_agent</code></td>
<td>TEXT</td>
<td></td>
<td>User Agent của actor</td>
</tr>
<tr>
<td><code>created_at</code></td>
<td>TIMESTAMPTZ</td>
<td>DEFAULT now()</td>
<td>Thời điểm ghi nhận hành vi</td>
</tr>
</tbody>
</table>
<hr/>
<h4 id="masking-ong-theo-quyen-truy-cap">🔐 Masking động theo quyền truy cập<a class="headerlink" href="#masking-ong-theo-quyen-truy-cap" title="Permanent link">¶</a></h4>
<p>Các trường sau có thể bị <strong>ẩn đi</strong> tùy theo vai trò người xem (<code>RBAC + masking</code>):</p>
<ul>
<li><code>input_parameters</code></li>
<li><code>ip_address</code></li>
<li><code>user_agent</code></li>
</ul>
<p>Chi tiết về masking được mô tả trong <code>design.md &gt; #6 Bảo mật</code>.</p>
<hr/>
<h4 id="luong-du-lieu-ghi-log">🔁 Luồng dữ liệu ghi log<a class="headerlink" href="#luong-du-lieu-ghi-log" title="Permanent link">¶</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>HTTP /audit-log
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>      └──&gt; Validate + Mask
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>            └──&gt; INSERT INTO audit_logs
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>Pub/Sub Consumer
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>      └──&gt; Validate + Mask
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>            └──&gt; INSERT INTO audit_logs
</span></code></pre></div>
<hr/>
<h4 id="goi-y-kiem-thu">🧪 Gợi ý kiểm thử<a class="headerlink" href="#goi-y-kiem-thu" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Tình huống</th>
<th>Kết quả mong đợi</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ghi log từ HTTP</td>
<td>Log lưu đúng tenant, đúng actor</td>
</tr>
<tr>
<td>Ghi log từ Pub/Sub</td>
<td>Có bản ghi log, status hợp lệ</td>
</tr>
<tr>
<td>User không có quyền cao → xem log bị mask</td>
<td><code>input_parameters</code> trả về <code>"masked"</code></td>
</tr>
<tr>
<td>Dữ liệu thiếu field bắt buộc</td>
<td>Bị reject trước khi insert</td>
</tr>
<tr>
<td>Ghi log nhiều tenant khác nhau</td>
<td>Partition đúng <code>tenant_id</code>, truy vấn tách biệt</td>
</tr>
<tr>
<td>Truy vấn <code>trace_id</code> → nhiều log liên quan</td>
<td>OK, hỗ trợ truy xuất trace full flow</td>
</tr>
</tbody>
</table>
<hr/>
<h4 id="ghi-chu-ac-biet">🧠 Ghi chú đặc biệt<a class="headerlink" href="#ghi-chu-ac-biet" title="Permanent link">¶</a></h4>
<ul>
<li>Không nên đặt FK tới <code>users</code>, <code>tenants</code>, <code>roles</code> → tránh coupling schema chặt.</li>
<li>Nên có <strong>policy partition theo <code>created_at</code></strong> (BigQuery / Postgres partition by time).</li>
<li>Có thể thêm cột <code>source</code> nếu cần phân biệt log từ <code>http</code>, <code>pubsub</code>, <code>batch</code>, v.v.</li>
</ul>
<hr/>
<h4 id="e-xuat-index">📊 Đề xuất Index<a class="headerlink" href="#e-xuat-index" title="Permanent link">¶</a></h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_audit_logs_trace_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">audit_logs</span><span class="p">(</span><span class="n">trace_id</span><span class="p">);</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_audit_logs_created_at</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">audit_logs</span><span class="p">(</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">);</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_audit_logs_actor</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">audit_logs</span><span class="p">(</span><span class="n">actor_user_id</span><span class="p">);</span>
</span></code></pre></div>
<hr/>
<p>📌 Đây là bảng duy nhất được expose qua <code>GET /audit-log</code>, <code>GET /audit-log/{id}</code> trong OpenAPI.</p>
<hr/>
<h3 id="52-bang-processed_events">5.2. 📌 Bảng: <code>processed_events</code><a class="headerlink" href="#52-bang-processed_events" title="Permanent link">¶</a></h3>
<h4 id="muc-ich_1">🧾 Mục đích<a class="headerlink" href="#muc-ich_1" title="Permanent link">¶</a></h4>
<p>Ghi nhận <strong>danh sách các sự kiện đã xử lý</strong> từ Pub/Sub nhằm:</p>
<ul>
<li>Đảm bảo <strong>idempotency</strong>: một sự kiện chỉ được xử lý đúng một lần.</li>
<li>Giúp <strong>debug</strong> luồng xử lý event: biết event nào đã được xử lý, event nào chưa.</li>
<li>Phục vụ audit nội bộ và phân tích downtime/retry khi cần.</li>
</ul>
<h4 id="cau-truc">🧬 Cấu trúc<a class="headerlink" href="#cau-truc" title="Permanent link">¶</a></h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">processed_events</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="n">event_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="n">consumer_group_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">processed_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-3-5"><a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="p">);</span>
</span></code></pre></div>
<h4 id="mo-ta-cac-cot">🧾 Mô tả các cột<a class="headerlink" href="#mo-ta-cac-cot" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Cột</th>
<th>Kiểu dữ liệu</th>
<th>Ràng buộc</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>event_id</code></td>
<td>UUID</td>
<td>PRIMARY KEY</td>
<td>ID sự kiện nhận từ metadata (<code>event_metadata.event_id</code>)</td>
</tr>
<tr>
<td><code>consumer_group_name</code></td>
<td>TEXT</td>
<td>NOT NULL</td>
<td>Tên consumer (theo service + env) giúp phân biệt source</td>
</tr>
<tr>
<td><code>processed_at</code></td>
<td>TIMESTAMPTZ</td>
<td>DEFAULT now()</td>
<td>Thời điểm ALS xử lý thành công sự kiện (ghi log hoặc bỏ qua có lý do)</td>
</tr>
</tbody>
</table>
<h4 id="chinh-sach-bao-mat-xoa">🔐 Chính sách bảo mật &amp; xóa<a class="headerlink" href="#chinh-sach-bao-mat-xoa" title="Permanent link">¶</a></h4>
<ul>
<li>Bảng chỉ ghi – không có API public, không expose qua REST.</li>
<li>Truy cập chỉ dành cho <strong>internal operator</strong> hoặc background task.</li>
<li>Dữ liệu có thể bị xoá theo retention 90 ngày, hoặc xoá thủ công nếu <code>event_id</code> không còn dùng để đối chiếu trace.</li>
</ul>
<h4 id="luong-hoat-ong">🔁 Luồng hoạt động<a class="headerlink" href="#luong-hoat-ong" title="Permanent link">¶</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>Pub/Sub → Consumer → Validate → Ghi log vào `audit_logs` → Ghi event_id vào `processed_events`
</span></code></pre></div>
<h4 id="goi-y-kiem-thu_1">🧪 Gợi ý kiểm thử<a class="headerlink" href="#goi-y-kiem-thu_1" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Tình huống</th>
<th>Kết quả mong đợi</th>
</tr>
</thead>
<tbody>
<tr>
<td>Consumer xử lý event hợp lệ</td>
<td>Có bản ghi <code>event_id</code> trong bảng</td>
</tr>
<tr>
<td>Consumer xử lý lại cùng <code>event_id</code> (duplicate)</td>
<td>Bị bỏ qua – idempotent, không xử lý lại</td>
</tr>
<tr>
<td>Gửi sự kiện giả <code>event_id</code> nhưng schema sai</td>
<td>Không tạo <code>processed_events</code>, log lỗi nội bộ</td>
</tr>
<tr>
<td>Bảng không có index</td>
<td>Truy vấn chậm – nên có index ở <code>processed_at</code> (nếu phân tích theo thời gian)</td>
</tr>
</tbody>
</table>
<h4 id="e-xuat-index_1">⚙️ Đề xuất Index<a class="headerlink" href="#e-xuat-index_1" title="Permanent link">¶</a></h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_processed_events_time</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">processed_events</span><span class="p">(</span><span class="n">processed_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">);</span>
</span></code></pre></div>
<h4 id="ghi-chu-ac-biet_1">📎 Ghi chú đặc biệt<a class="headerlink" href="#ghi-chu-ac-biet_1" title="Permanent link">¶</a></h4>
<ul>
<li>
<p>Không có quan hệ FK với <code>audit_logs</code> vì một sự kiện có thể:</p>
</li>
<li>
<p>Không tạo log (do bị reject hoặc chỉ ping)</p>
</li>
<li>Tạo nhiều log cùng lúc (vd: batch import)</li>
<li>Phần <code>consumer_group_name</code> nên chuẩn hóa theo format:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>als-sub.&lt;env&gt;.&lt;region&gt;
</span></code></pre></div>
<p>Ví dụ: <code>als-sub.prod.ap-southeast1</code></p>
<hr/>
<h2 id="6-indexes-constraints">6. Indexes &amp; Constraints<a class="headerlink" href="#6-indexes-constraints" title="Permanent link">¶</a></h2>
<p>Các chỉ mục (indexes) và ràng buộc (constraints) đóng vai trò then chốt trong việc đảm bảo:</p>
<ul>
<li>Tốc độ truy vấn nhanh chóng theo nhiều chiều (<code>trace_id</code>, <code>actor_user_id</code>, <code>tenant_id</code>, <code>created_at</code>)</li>
<li>Tính toàn vẹn dữ liệu</li>
<li>Hạn chế trùng lặp hoặc sai định dạng</li>
</ul>
<hr/>
<h3 id="61-bang-audit_logs">6.1. Bảng: <code>audit_logs</code><a class="headerlink" href="#61-bang-audit_logs" title="Permanent link">¶</a></h3>
<h4 id="cac-chi-muc-chinh-indexes">🔎 Các chỉ mục chính (Indexes)<a class="headerlink" href="#cac-chi-muc-chinh-indexes" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Index Name</th>
<th>Cột</th>
<th>Mục đích chính</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>idx_audit_logs_trace_id</code></td>
<td><code>trace_id</code></td>
<td>Truy vết theo luồng tương tác</td>
</tr>
<tr>
<td><code>idx_audit_logs_created_at</code></td>
<td><code>created_at DESC</code></td>
<td>Truy vấn thời gian gần nhất (phân trang)</td>
</tr>
<tr>
<td><code>idx_audit_logs_actor_user_id</code></td>
<td><code>actor_user_id</code></td>
<td>Truy xuất log theo người dùng cụ thể</td>
</tr>
<tr>
<td><code>idx_audit_logs_tenant_id</code></td>
<td><code>tenant_id</code></td>
<td>Phân lập dữ liệu theo tenant (RBAC filter)</td>
</tr>
<tr>
<td><code>idx_audit_logs_action_resource</code></td>
<td><code>(action, resource_type)</code></td>
<td>Truy vấn theo loại hành vi và đối tượng</td>
</tr>
</tbody>
</table>
<blockquote>
<p>💡 Nếu sử dụng BigQuery: nên phân vùng (<code>partition</code>) theo <code>DATE(created_at)</code> và tạo <code>cluster</code> theo <code>tenant_id, trace_id</code>.</p>
</blockquote>
<h4 id="rang-buoc-du-lieu-constraints">🛡️ Ràng buộc dữ liệu (Constraints)<a class="headerlink" href="#rang-buoc-du-lieu-constraints" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Tên Constraint</th>
<th>Cột / Kiểu</th>
<th>Ý nghĩa</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pk_audit_logs</code></td>
<td><code>id</code> (PK)</td>
<td>Mỗi bản ghi log là duy nhất</td>
</tr>
<tr>
<td><code>ck_audit_logs_status_enum</code></td>
<td><code>status</code></td>
<td>Chỉ cho phép: <code>success</code>, <code>failure</code>, <code>warning</code></td>
</tr>
<tr>
<td><code>nn_audit_logs_tenant_id</code></td>
<td><code>tenant_id</code></td>
<td>Bắt buộc có tenant</td>
</tr>
<tr>
<td><code>nn_audit_logs_action</code></td>
<td><code>action</code></td>
<td>Bắt buộc ghi rõ hành động</td>
</tr>
<tr>
<td><code>nn_audit_logs_resource_type</code></td>
<td><code>resource_type</code></td>
<td>Bắt buộc có loại đối tượng liên quan</td>
</tr>
<tr>
<td><code>df_created_at_now</code></td>
<td><code>created_at</code></td>
<td>Mặc định là <code>now()</code> nếu không được truyền từ producer</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="62-bang-processed_events">6.2. Bảng: <code>processed_events</code><a class="headerlink" href="#62-bang-processed_events" title="Permanent link">¶</a></h3>
<h4 id="index">🔎 Index<a class="headerlink" href="#index" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Index Name</th>
<th>Cột</th>
<th>Mục đích</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>idx_processed_events_time</code></td>
<td><code>processed_at DESC</code></td>
<td>Truy vấn sự kiện mới nhất</td>
</tr>
<tr>
<td><em>(PK mặc định)</em></td>
<td><code>event_id</code></td>
<td>Đảm bảo duy nhất – hỗ trợ idempotency</td>
</tr>
</tbody>
</table>
<h4 id="rang-buoc">🛡️ Ràng buộc<a class="headerlink" href="#rang-buoc" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Tên Constraint</th>
<th>Cột / Kiểu</th>
<th>Ý nghĩa</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pk_processed_events</code></td>
<td><code>event_id</code></td>
<td>Chống xử lý lặp từ cùng 1 sự kiện</td>
</tr>
<tr>
<td><code>nn_processed_consumer_group</code></td>
<td><code>consumer_group_name</code></td>
<td>Bắt buộc ghi rõ tên consumer xử lý</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="goi-y-nang-cao">🔧 Gợi ý nâng cao<a class="headerlink" href="#goi-y-nang-cao" title="Permanent link">¶</a></h3>
<ul>
<li>✅ Sử dụng <code>covering index</code> nếu hệ thống hỗ trợ (e.g. PostgreSQL 12+)</li>
<li>✅ Trong môi trường có hàng triệu bản ghi mỗi ngày: cân nhắc tạo view phân vùng theo tenant để dễ audit/debug</li>
<li>⚠️ Không tạo index trên <code>input_parameters</code> (JSONB) nếu không dùng truy vấn filter phức tạp → tốn chi phí</li>
</ul>
<hr/>
<blockquote>
<p>📌 Toàn bộ index và constraint đều phải được mô tả rõ trong migration script, kèm unit test nếu thao tác schema phức tạp (tuân theo <code>ADR-023 Schema Migration Strategy</code>)</p>
</blockquote>
<hr/>
<h2 id="7-chinh-sach-luu-tru-xoa">7. Chính sách Lưu trữ &amp; Xóa<a class="headerlink" href="#7-chinh-sach-luu-tru-xoa" title="Permanent link">¶</a></h2>
<p>Chính sách này nhằm đảm bảo dữ liệu trong bảng <code>audit_logs</code> và <code>processed_events</code> được lưu trữ đúng thời gian cần thiết, tuân thủ các tiêu chuẩn bảo mật và pháp lý (compliance), đồng thời tối ưu chi phí vận hành.</p>
<hr/>
<h3 id="71-thoi-gian-luu-tru-retention-period">7.1. ⏳ Thời gian lưu trữ (Retention Period)<a class="headerlink" href="#71-thoi-gian-luu-tru-retention-period" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Bảng</th>
<th>Mặc định Retention</th>
<th>Ghi chú</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>audit_logs</code></td>
<td>365 ngày</td>
<td>Dữ liệu hành vi người dùng và hệ thống</td>
</tr>
<tr>
<td><code>processed_events</code></td>
<td>90 ngày</td>
<td>Chỉ dùng để idempotency và tracking kỹ thuật</td>
</tr>
</tbody>
</table>
<blockquote>
<p>📌 Các mốc thời gian có thể điều chỉnh cấu hình theo tenant hoặc môi trường (staging vs production)</p>
</blockquote>
<hr/>
<h3 id="72-chien-luoc-xoa-du-lieu-deletion-strategy">7.2. 🧹 Chiến lược Xóa Dữ liệu (Deletion Strategy)<a class="headerlink" href="#72-chien-luoc-xoa-du-lieu-deletion-strategy" title="Permanent link">¶</a></h3>
<p>Theo <strong>ADR-026</strong>, hệ thống <strong>không sử dụng hard-delete mặc định</strong> với dữ liệu có thể liên quan đến auditing hoặc forensic analysis. Do đó:</p>
<h4 id="bang-audit_logs">🔸 Bảng <code>audit_logs</code>:<a class="headerlink" href="#bang-audit_logs" title="Permanent link">¶</a></h4>
<ul>
<li>Không xóa bản ghi bằng <code>DELETE</code> vật lý.</li>
<li>Sử dụng chiến lược <strong>partition expiration</strong> (BigQuery) hoặc batch archival (Firestore/Postgres).</li>
<li>Khi đến hạn retention:</li>
<li>Dữ liệu có thể được:<ul>
<li>Chuyển sang BigQuery Cold Storage hoặc Data Lake</li>
<li>Xóa mềm thông qua <code>archived_at</code> timestamp (nếu cần)</li>
</ul>
</li>
<li>Một số trường hợp tuân thủ đặc biệt (e.g. yêu cầu của phụ huynh/học sinh theo luật) có thể kích hoạt pipeline <strong>data anonymization</strong> theo ADR-024.</li>
</ul>
<h4 id="bang-processed_events">🔸 Bảng <code>processed_events</code>:<a class="headerlink" href="#bang-processed_events" title="Permanent link">¶</a></h4>
<ul>
<li>Có thể <strong>xóa vật lý hoàn toàn</strong> sau <code>processed_at + 90 ngày</code> vì không ảnh hưởng đến compliance.</li>
</ul>
<hr/>
<h3 id="73-chinh-sach-anonymization-an-danh-du-lieu">7.3. 🔐 Chính sách Anonymization (Ẩn danh dữ liệu)<a class="headerlink" href="#73-chinh-sach-anonymization-an-danh-du-lieu" title="Permanent link">¶</a></h3>
<p>Áp dụng theo ADR-024:</p>
<ul>
<li>Với các field nhạy cảm trong <code>audit_logs</code>:</li>
<li><code>input_parameters</code></li>
<li><code>ip_address</code></li>
<li><code>user_agent</code></li>
</ul>
<p>Có thể được <strong>mask động theo vai trò người dùng (RBAC)</strong> khi truy vấn, hoặc <strong>anonymize toàn bộ</strong> sau thời gian retention:</p>
<table>
<thead>
<tr>
<th>Phương án</th>
<th>Khi nào áp dụng</th>
<th>Cơ chế thực thi</th>
</tr>
</thead>
<tbody>
<tr>
<td>Masking</td>
<td>Khi query API</td>
<td>Thực hiện trong service layer (<code>design.md &gt; #6</code>)</td>
</tr>
<tr>
<td>Anonymize</td>
<td>Sau 12 tháng (config)</td>
<td>Batch job chạy hằng tuần xóa nội dung field</td>
</tr>
</tbody>
</table>
<blockquote>
<p>🔎 Audit log không bao giờ ghi <code>password</code>, <code>OTP</code>, <code>JWT</code>, hoặc các credential nhạy cảm – được loại bỏ ngay từ bước validate đầu vào.</p>
</blockquote>
<hr/>
<h3 id="74-du-lieu-tam-thoi">7.4. ✈️ Dữ liệu tạm thời<a class="headerlink" href="#74-du-lieu-tam-thoi" title="Permanent link">¶</a></h3>
<ul>
<li>Các dữ liệu debug/log có TTL &lt; 7 ngày (e.g. draft logs, schema error) được lưu trong Firestore hoặc memory store, và tự xóa theo TTL.</li>
<li>Không đi vào audit_logs chính.</li>
</ul>
<hr/>
<h3 id="75-kiem-thu-quan-sat-retention">7.5. 🧪 Kiểm thử &amp; Quan sát Retention<a class="headerlink" href="#75-kiem-thu-quan-sat-retention" title="Permanent link">¶</a></h3>
<ul>
<li>Viết job giả lập log đã quá hạn → kiểm tra có bị xóa hoặc anonymize đúng</li>
<li>Viết câu truy vấn validate:
<div class="language-sql highlight"><pre><span></span><code><span id="__span-7-1"><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">audit_logs</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">'1 year'</span><span class="p">;</span>
</span></code></pre></div></li>
</ul>
<blockquote>
<p>Log về hành vi anonymization nên được ghi lại với action = audit.anonymized</p>
</blockquote>
<hr/>
<h2 id="8-phan-quyen-truy-cap-du-lieu">8. Phân quyền Truy cập Dữ liệu<a class="headerlink" href="#8-phan-quyen-truy-cap-du-lieu" title="Permanent link">¶</a></h2>
<p>Dữ liệu trong bảng <code>audit_logs</code> chứa nhiều trường nhạy cảm liên quan đến hành vi người dùng, IP truy cập, thông tin hành động... Do đó, hệ thống áp dụng chính sách phân quyền chặt chẽ theo mô hình RBAC đa tầng (xem <code>ADR-007</code>).</p>
<hr/>
<h3 id="81-pham-vi-truy-cap-theo-vai-tro-role-based-access">8.1. Phạm vi truy cập theo vai trò (Role-based Access)<a class="headerlink" href="#81-pham-vi-truy-cap-theo-vai-tro-role-based-access" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Vai trò (<code>role</code>)</th>
<th>Truy cập log tenant khác</th>
<th>Nhận dữ liệu không bị mask</th>
<th>Truy vấn nâng cao (<code>trace_id</code>, <code>resource_type</code>)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>superadmin</code></td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td><code>tenant_admin</code></td>
<td>❌</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td><code>tenant_auditor</code></td>
<td>❌</td>
<td>❌ <em>(1)</em></td>
<td>✅</td>
</tr>
<tr>
<td><code>teacher</code>, <code>staff</code></td>
<td>❌</td>
<td>❌</td>
<td>❌ <em>(giới hạn theo actor_user_id)</em></td>
</tr>
</tbody>
</table>
<blockquote>
<p><em>(1)</em> Các role thấp hơn <code>tenant_admin</code> chỉ thấy các trường đã được <strong>mask động</strong> (e.g. <code>input_parameters: "masked"</code>)</p>
</blockquote>
<hr/>
<h3 id="82-masking-ong-du-lieu">8.2. Masking động dữ liệu<a class="headerlink" href="#82-masking-ong-du-lieu" title="Permanent link">¶</a></h3>
<p>Các trường sau sẽ được che khuất (mask) nếu user không có quyền cao:</p>
<table>
<thead>
<tr>
<th>Trường bị mask</th>
<th>Khi nào áp dụng</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>input_parameters</code></td>
<td>Nếu không có <code>view_sensitive_payload</code></td>
</tr>
<tr>
<td><code>ip_address</code></td>
<td>Nếu không có <code>view_ip</code></td>
</tr>
<tr>
<td><code>user_agent</code></td>
<td>Nếu không có <code>view_device_info</code></td>
</tr>
</tbody>
</table>
<p>Ví dụ sau phản ánh kết quả truy vấn đối với 2 vai trò khác nhau:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="c1">// Truy cập với quyền thấp</span>
</span><span id="__span-8-2"><a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="p">{</span>
</span><span id="__span-8-3"><a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span><span class="nt">"input_parameters"</span><span class="p">:</span><span class="w"> </span><span class="s2">"masked"</span><span class="p">,</span>
</span><span id="__span-8-4"><a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">  </span><span class="nt">"ip_address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"masked"</span><span class="p">,</span>
</span><span id="__span-8-5"><a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">  </span><span class="nt">"user_agent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"masked"</span>
</span><span id="__span-8-6"><a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="p">}</span>
</span><span id="__span-8-7"><a href="#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a>
</span><span id="__span-8-8"><a href="#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="c1">// Truy cập với quyền cao</span>
</span><span id="__span-8-9"><a href="#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="p">{</span>
</span><span id="__span-8-10"><a href="#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">  </span><span class="nt">"input_parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-11"><a href="#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">    </span><span class="nt">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"john@example.com"</span><span class="p">,</span>
</span><span id="__span-8-12"><a href="#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John"</span>
</span><span id="__span-8-13"><a href="#__codelineno-8-13" id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-8-14"><a href="#__codelineno-8-14" id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">  </span><span class="nt">"ip_address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192.168.1.2"</span><span class="p">,</span>
</span><span id="__span-8-15"><a href="#__codelineno-8-15" id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">  </span><span class="nt">"user_agent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mozilla/5.0"</span>
</span><span id="__span-8-16"><a href="#__codelineno-8-16" id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="p">}</span>
</span></code></pre></div>
<hr/>
<h3 id="83-ieu-kien-rang-buoc-theo-tenant">8.3. Điều kiện ràng buộc theo Tenant<a class="headerlink" href="#83-ieu-kien-rang-buoc-theo-tenant" title="Permanent link">¶</a></h3>
<p>Mọi truy vấn từ client đều phải có header <code>X-Tenant-ID</code>. Điều kiện bắt buộc:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="p">{</span><span class="w"> </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{X-Tenant-ID}}"</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>Quản trị viên cấp tenant chỉ được thấy log trong phạm vi tenant của mình.</p>
<hr/>
<h3 id="84-scope-bat-buoc-trong-jwt">8.4. Scope bắt buộc trong JWT<a class="headerlink" href="#84-scope-bat-buoc-trong-jwt" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>API</th>
<th>Scope yêu cầu</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GET /audit-log</code></td>
<td><code>audit.read.log</code></td>
</tr>
<tr>
<td><code>GET /audit-log/{id}</code></td>
<td><code>audit.read.log</code></td>
</tr>
<tr>
<td><code>POST /audit-log</code></td>
<td><code>audit.write</code> <em>(internal only)</em></td>
</tr>
</tbody>
</table>
<blockquote>
<p>⚠️ Không bao giờ cấp <code>audit.write</code> cho ứng dụng người dùng (frontend/mobile).</p>
</blockquote>
<hr/>
<h3 id="85-policy-trien-khai-tren-api-gateway">8.5. Policy triển khai trên API Gateway<a class="headerlink" href="#85-policy-trien-khai-tren-api-gateway" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Thành phần</th>
<th>Policy</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gateway filter</td>
<td>Kiểm tra <code>scope</code>, <code>tenant_id</code></td>
</tr>
<tr>
<td>Middleware ALS</td>
<td>Check RBAC theo role</td>
</tr>
<tr>
<td>Query Layer (DB)</td>
<td>Gắn filter theo <code>tenant_id</code>, mask nếu cần</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="9-mo-rong-trong-tuong-lai">9. Mở rộng trong Tương Lai<a class="headerlink" href="#9-mo-rong-trong-tuong-lai" title="Permanent link">¶</a></h2>
<p>Audit Logging Service (ALS) được thiết kế theo nguyên tắc modular &amp; event-driven, sẵn sàng mở rộng trong các giai đoạn sau này. Dưới đây là các hướng mở rộng quan trọng đã được xác định:</p>
<hr/>
<h3 id="91-phat-su-kien-thu-cap-vasauditpersistedv1">9.1. 🚀 Phát sự kiện thứ cấp <code>vas.audit.persisted.v1</code><a class="headerlink" href="#91-phat-su-kien-thu-cap-vasauditpersistedv1" title="Permanent link">¶</a></h3>
<ul>
<li>Cho phép ALS phát Pub/Sub event mỗi khi một bản ghi log được lưu thành công.</li>
<li>Hữu ích cho:</li>
<li><strong>Downstream processing</strong> (ETL → Data Lake, Data Mart)</li>
<li><strong>Phân tích AI behavior</strong></li>
<li><strong>Realtime monitoring</strong> (như suspicious behavior)</li>
<li><strong>Trạng thái hiện tại:</strong> Đã thiết kế schema &amp; flow (xem <code>design.md &gt; 5.3</code>)<br/>
  🔒 <strong>Chưa bật mặc định</strong> – cần bật <code>emit_audit_event_enabled = true</code> theo môi trường</li>
</ul>
<blockquote>
<p>Xem thêm: <a href="../../../ADR/adr-030-event-schema-governance/">ADR-030 - Event Schema Governance</a></p>
</blockquote>
<hr/>
<h3 id="92-tu-ong-phat-hien-hanh-vi-bat-thuong-anomaly-detection">9.2. 🧠 Tự động phát hiện hành vi bất thường (Anomaly Detection)<a class="headerlink" href="#92-tu-ong-phat-hien-hanh-vi-bat-thuong-anomaly-detection" title="Permanent link">¶</a></h3>
<ul>
<li>Kết hợp ALS với AI pipeline để phát hiện:</li>
<li>Truy cập bất thường vào dữ liệu học sinh</li>
<li>Hành vi đăng nhập trái phép hoặc brute-force</li>
<li>Yêu cầu: tích hợp ALS log với Data Lake + hệ thống cảnh báo (ADR-021)</li>
</ul>
<hr/>
<h3 id="93-ho-tro-nhieu-backend-luu-tru">9.3. 📦 Hỗ trợ nhiều backend lưu trữ<a class="headerlink" href="#93-ho-tro-nhieu-backend-luu-tru" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Storage</th>
<th>Trạng thái hiện tại</th>
<th>Ghi chú</th>
</tr>
</thead>
<tbody>
<tr>
<td>BigQuery</td>
<td>✅ Production</td>
<td>Phân tích &amp; truy vấn</td>
</tr>
<tr>
<td>Firestore</td>
<td>🅾 Optional</td>
<td>Dùng cho dashboard nhỏ, backup</td>
</tr>
<tr>
<td>PostgreSQL/Clickhouse</td>
<td>🔜 Giai đoạn sau</td>
<td>Phù hợp self-hosted hoặc latency thấp</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="94-truy-van-nang-cao-cho-bao-cao">9.4. 🧾 Truy vấn nâng cao cho báo cáo<a class="headerlink" href="#94-truy-van-nang-cao-cho-bao-cao" title="Permanent link">¶</a></h3>
<ul>
<li>Hỗ trợ các API nâng cao theo truy vấn:</li>
<li><code>GET /audit-log/by-trace/{trace_id}</code></li>
<li><code>GET /audit-log/stats?group_by=action</code></li>
<li>Phục vụ trực tiếp cho báo cáo bảo mật (<code>Reporting Service</code>) và dashboard.</li>
</ul>
<hr/>
<h3 id="95-retry-co-che-tieu-thu-pubsub">9.5. 🔁 Retry cơ chế tiêu thụ Pub/Sub<a class="headerlink" href="#95-retry-co-che-tieu-thu-pubsub" title="Permanent link">¶</a></h3>
<ul>
<li>Hiện tại: ALS <strong>bỏ qua các event không valid schema</strong></li>
<li>Tương lai:</li>
<li>Lưu các event lỗi vào hàng chờ tạm thời</li>
<li>Cho phép debug &amp; replay event lỗi</li>
<li>Tích hợp với alerting system (Grafana Alert, Slack webhook...)</li>
</ul>
<hr/>
<h3 id="96-kiem-toan-cac-truy-van-nhay-cam">9.6. 🔒 Kiểm toán các truy vấn nhạy cảm<a class="headerlink" href="#96-kiem-toan-cac-truy-van-nhay-cam" title="Permanent link">¶</a></h3>
<ul>
<li>Ghi lại cả hành vi <strong>truy vấn log</strong> (ai truy cập log gì, khi nào) như một dạng “meta-audit”</li>
<li>Cho phép truy vấn theo <code>trace_id</code> của truy vấn</li>
<li>Cần triển khai song song trong Admin WebApp &amp; ALS</li>
</ul>
<hr/>
<h3 id="97-admin-dashboard-mini">9.7. 🛠 Admin Dashboard Mini<a class="headerlink" href="#97-admin-dashboard-mini" title="Permanent link">¶</a></h3>
<ul>
<li>Tạo 1 dashboard nội bộ gọn nhẹ để:</li>
<li>Xem log gần nhất theo trace/user</li>
<li>Kiểm tra sự kiện nào đã được ghi vào ALS</li>
<li>Xem trạng thái masking theo vai trò</li>
<li>Có thể dùng Firestore + Firebase Hosting + Tailwind CSS</li>
</ul>
<hr/>
<p>📌 Các hướng mở rộng trên đều nằm trong tầm kiểm soát hiện tại nhờ thiết kế tuân thủ ADR, modular, và có thể bật/tắt theo môi trường bằng <code>feature flag</code>.</p>
<p>📎 Gợi ý chi tiết cho triển khai sau này: xem <a href="../design/#11-🧩-Kiến-trúc-Service">design.md &gt; 11. Kiến trúc Service</a></p>
<hr/>
<h2 id="10-enums">10. ENUMs<a class="headerlink" href="#10-enums" title="Permanent link">¶</a></h2>
<p>Danh sách các giá trị liệt kê (<code>enum</code>) được chuẩn hóa để đảm bảo tính nhất quán xuyên suốt hệ thống. Tất cả giá trị enum đều nên được quản lý tập trung trong schema và OpenAPI, có thể dùng cho codegen và tự động kiểm tra tính hợp lệ.</p>
<hr/>
<h3 id="101-truong-status">10.1. 📌 Trường <code>status</code><a class="headerlink" href="#101-truong-status" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Giá trị</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>success</code></td>
<td>Hành động hoàn tất thành công</td>
</tr>
<tr>
<td><code>failure</code></td>
<td>Hành động bị lỗi hoặc không hoàn tất</td>
</tr>
<tr>
<td><code>warning</code></td>
<td>Thành công một phần, hoặc có điều kiện cảnh báo (e.g. timeout, retry)</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="102-truong-resource_type">10.2. 📌 Trường <code>resource_type</code><a class="headerlink" href="#102-truong-resource_type" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Giá trị</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user</code></td>
<td>Người dùng hoặc tài khoản</td>
</tr>
<tr>
<td><code>tenant</code></td>
<td>Tenant / trường / đơn vị</td>
</tr>
<tr>
<td><code>role</code></td>
<td>Vai trò trong RBAC</td>
</tr>
<tr>
<td><code>permission</code></td>
<td>Quyền được gán hoặc thu hồi</td>
</tr>
<tr>
<td><code>token</code></td>
<td>JWT hoặc OAuth token</td>
</tr>
<tr>
<td><code>report</code></td>
<td>Báo cáo sinh ra từ Reporting Service</td>
</tr>
<tr>
<td><code>notification</code></td>
<td>Thông báo được gửi qua Notification Service</td>
</tr>
<tr>
<td><code>system</code></td>
<td>Các tác vụ hệ thống không thuộc thực thể cụ thể</td>
</tr>
</tbody>
</table>
<blockquote>
<p>📎 Danh sách này có thể mở rộng nhưng cần cập nhật đồng bộ OpenAPI và schema BQ</p>
</blockquote>
<hr/>
<h3 id="103-truong-action">10.3. 📌 Trường <code>action</code><a class="headerlink" href="#103-truong-action" title="Permanent link">¶</a></h3>
<p>Hệ thống không giới hạn cố định <code>action</code>, nhưng có thể gợi ý các giá trị phổ biến dùng để thống kê và sinh báo cáo:</p>
<table>
<thead>
<tr>
<th>Giá trị mẫu</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user.login.success</code></td>
<td>Đăng nhập thành công</td>
</tr>
<tr>
<td><code>user.login.failed</code></td>
<td>Đăng nhập thất bại</td>
</tr>
<tr>
<td><code>user.created</code></td>
<td>Tạo người dùng</td>
</tr>
<tr>
<td><code>user.updated</code></td>
<td>Cập nhật thông tin</td>
</tr>
<tr>
<td><code>user.deleted</code></td>
<td>Xóa người dùng</td>
</tr>
<tr>
<td><code>role.assigned</code></td>
<td>Gán role cho người dùng</td>
</tr>
<tr>
<td><code>token.exchanged</code></td>
<td>Đổi token qua refresh</td>
</tr>
<tr>
<td><code>report.viewed</code></td>
<td>Xem báo cáo</td>
</tr>
<tr>
<td><code>notification.sent</code></td>
<td>Gửi thông báo thành công</td>
</tr>
<tr>
<td><code>notification.failed</code></td>
<td>Gửi thông báo thất bại</td>
</tr>
<tr>
<td><code>audit.anonymized</code></td>
<td>Log đã được ẩn danh hóa (batch masking)</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="ghi-chu-ve-quan-ly-enums">🔎 Ghi chú về quản lý ENUMs<a class="headerlink" href="#ghi-chu-ve-quan-ly-enums" title="Permanent link">¶</a></h3>
<ul>
<li>Với các enum có <strong>phạm vi giới hạn và dùng filter</strong> (như <code>status</code>, <code>resource_type</code>), nên lưu trong schema và OpenAPI.</li>
<li>Với các giá trị <strong>mở rộng linh hoạt</strong> như <code>action</code>, nên quản lý theo <code>dictionary</code> nội bộ để hỗ trợ phân tích và báo cáo.</li>
<li>Các enum cần mô tả kỹ càng trong <code>event schema</code> nếu được sử dụng làm field trong Pub/Sub event.</li>
</ul>
<hr/>
<h2 id="11-lien-ket-tai-lieu">11. 📚 Liên kết Tài liệu<a class="headerlink" href="#11-lien-ket-tai-lieu" title="Permanent link">¶</a></h2>
<ul>
<li><a href="../interface-contract/">Interface Contract</a></li>
<li><a href="../openapi.yaml">OpenAPI Spec</a></li>
<li><a href="../design/">Design</a></li>
<li><a href="../../../ADR/adr-023-schema-migration-strategy/"><code>adr-023-schema-migration-strategy</code></a></li>
<li><a href="../../../ADR/adr-024-data-anonymization-retention/"><code>adr-024-data-anonymization-retention</code></a></li>
<li><a href="../../../ADR/adr-026-hard-delete-policy/"><code>adr-026-hard-delete-policy</code></a></li>
<li><a href="../../../ADR/adr-030-event-schema-governance/"><code>adr-030-event-schema-governance</code></a></li>
</ul>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Trở lại mục lục
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>