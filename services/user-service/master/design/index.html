
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Service Design Document cho SPA quáº£n trá»‹ há»‡ thá»‘ng VAS DX" name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://ezdesign-vn.github.io/dx-vas/services/user-service/master/design/" rel="canonical"/>
<link href="../../../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>User Service Master â€“ Service Design Document - DX VAS - Docs</title>
<link href="../../../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#user-service-master-service-design-document">
          Bá» qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Äáº§u trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              User Service Master â€“ Service Design Document
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="TÃ¬m kiáº¿m" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="TÃ¬m kiáº¿m" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="TÃ¬m kiáº¿m" class="md-search__options">
<button aria-label="XoÃ¡" class="md-search__icon md-icon" tabindex="-1" title="XoÃ¡" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../architecture/system-diagrams/">
          
  
  
    
  
  Kiáº¿n trÃºc Há»‡ thá»‘ng

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../dev-guide/">
        
  
  
    
  
  HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../">
        
  
  
    
  
  Thiáº¿t káº¿ Services

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../ADR/">
          
  
  
    
  
  Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh Ä‘iá»u hÆ°á»›ng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Kiáº¿n trÃºc Há»‡ thá»‘ng
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Kiáº¿n trÃºc Há»‡ thá»‘ng
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../architecture/system-diagrams/">
<span class="md-ellipsis">
    SÆ¡ Ä‘á»“ Há»‡ thá»‘ng
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../architecture/rbac-deep-dive/">
<span class="md-ellipsis">
    RBAC Chi tiáº¿t
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../dev-guide/">
<span class="md-ellipsis">
    HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../">
<span class="md-ellipsis">
    Thiáº¿t káº¿ Services
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../../ADR/">
<span class="md-ellipsis">
    Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Má»¥c lá»¥c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Má»¥c lá»¥c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-muc-ich-scope">
<span class="md-ellipsis">
      1. Má»¥c Ä‘Ã­ch (Scope)
    </span>
</a>
<nav aria-label="1. Má»¥c Ä‘Ã­ch (Scope)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#khong-chiu-trach-nhiem-out-of-scope">
<span class="md-ellipsis">
      ğŸš« KhÃ´ng chá»‹u trÃ¡ch nhiá»‡m (Out of Scope)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-trach-nhiem-chinh-responsibilities">
<span class="md-ellipsis">
      2. TrÃ¡ch nhiá»‡m chÃ­nh (Responsibilities)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-luong-nghiep-vu-chinh-business-flows">
<span class="md-ellipsis">
      3. Luá»“ng nghiá»‡p vá»¥ chÃ­nh (Business Flows)
    </span>
</a>
<nav aria-label="3. Luá»“ng nghiá»‡p vá»¥ chÃ­nh (Business Flows)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ang-nhap-google-oauth2-qua-auth-master">
<span class="md-ellipsis">
      ğŸ”¹ ÄÄƒng nháº­p Google OAuth2 (qua Auth Master)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#gan-nguoi-dung-vao-tenant">
<span class="md-ellipsis">
      ğŸ”¹ GÃ¡n ngÆ°á»i dÃ¹ng vÃ o tenant
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-mo-hinh-du-lieu">
<span class="md-ellipsis">
      4. MÃ´ hÃ¬nh dá»¯ liá»‡u
    </span>
</a>
<nav aria-label="4. MÃ´ hÃ¬nh dá»¯ liá»‡u" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#so-o-erd-tong-quan">
<span class="md-ellipsis">
      ğŸ§© SÆ¡ Ä‘á»“ ERD tá»•ng quan
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-api">
<span class="md-ellipsis">
      5. API
    </span>
</a>
<nav aria-label="5. API" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#bang-tom-tat-api-chinh">
<span class="md-ellipsis">
      ğŸ“š Báº£ng tÃ³m táº¯t API chÃ­nh
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-su-kien-phat-ra-events">
<span class="md-ellipsis">
      6. Sá»± kiá»‡n phÃ¡t ra (Events)
    </span>
</a>
<nav aria-label="6. Sá»± kiá»‡n phÃ¡t ra (Events)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#danh-sach-su-kien">
<span class="md-ellipsis">
      ğŸ“¢ Danh sÃ¡ch sá»± kiá»‡n
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-bao-mat-phan-quyen">
<span class="md-ellipsis">
      7. ğŸ” Báº£o máº­t &amp; PhÃ¢n quyá»n
    </span>
</a>
<nav aria-label="7. ğŸ” Báº£o máº­t &amp; PhÃ¢n quyá»n" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-authentication-xac-thuc">
<span class="md-ellipsis">
      ğŸ›¡ï¸ 7.1. Authentication (XÃ¡c thá»±c)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-authorization-phan-quyen-ong">
<span class="md-ellipsis">
      ğŸ§© 7.2. Authorization (PhÃ¢n quyá»n Ä‘á»™ng)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-bao-ve-du-lieu-nhay-cam">
<span class="md-ellipsis">
      ğŸ” 7.3. Báº£o vá»‡ dá»¯ liá»‡u nháº¡y cáº£m
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-audit-logging">
<span class="md-ellipsis">
      ğŸ” 7.4. Audit Logging
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#75-internal-auth">
<span class="md-ellipsis">
      ğŸ”’ 7.5. Internal Auth
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#76-rate-limiting-abuse-prevention">
<span class="md-ellipsis">
      ğŸš« 7.6. Rate Limiting &amp; Abuse Prevention
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-cau-hinh-trien-khai">
<span class="md-ellipsis">
      8. âš™ï¸ Cáº¥u hÃ¬nh &amp; Triá»ƒn khai
    </span>
</a>
<nav aria-label="8. âš™ï¸ Cáº¥u hÃ¬nh &amp; Triá»ƒn khai" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#bien-moi-truong">
<span class="md-ellipsis">
      ğŸ”§ Biáº¿n mÃ´i trÆ°á»ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cau-truc-thu-muc-cau-hinh">
<span class="md-ellipsis">
      ğŸ›  Cáº¥u trÃºc thÆ° má»¥c cáº¥u hÃ¬nh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cicd-trien-khai">
<span class="md-ellipsis">
      ğŸš€ CI/CD &amp; Triá»ƒn khai
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-chien-luoc-test">
<span class="md-ellipsis">
      9. ğŸ§ª Chiáº¿n lÆ°á»£c Test
    </span>
</a>
<nav aria-label="9. ğŸ§ª Chiáº¿n lÆ°á»£c Test" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#91-unit-test">
<span class="md-ellipsis">
      âœ… 9.1. Unit Test
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#92-contract-test-consumer-driven">
<span class="md-ellipsis">
      âœ… 9.2. Contract Test (Consumer-Driven)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#93-integration-test-service-level">
<span class="md-ellipsis">
      âœ… 9.3. Integration Test (Service level)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#94-load-performance-test-tuy-chon">
<span class="md-ellipsis">
      âœ… 9.4. Load &amp; Performance Test (TÃ¹y chá»n)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#95-security-test">
<span class="md-ellipsis">
      âœ… 9.5. Security Test
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#bao-cao-tich-hop-ci">
<span class="md-ellipsis">
      ğŸ§ª BÃ¡o cÃ¡o &amp; TÃ­ch há»£p CI
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-quan-sat-giam-sat">
<span class="md-ellipsis">
      10. ğŸ“ˆ Quan sÃ¡t &amp; GiÃ¡m sÃ¡t
    </span>
</a>
<nav aria-label="10. ğŸ“ˆ Quan sÃ¡t &amp; GiÃ¡m sÃ¡t" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#101-logging">
<span class="md-ellipsis">
      ğŸ“Š 10.1. Logging
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#102-metrics">
<span class="md-ellipsis">
      ğŸ“ˆ 10.2. Metrics
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#103-audit-logging">
<span class="md-ellipsis">
      ğŸ” 10.3. Audit Logging
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#104-cost-observability-billing">
<span class="md-ellipsis">
      ğŸ’° 10.4. Cost Observability (Billing)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#105-health-check-alert">
<span class="md-ellipsis">
      ğŸ§ª 10.5. Health Check &amp; Alert
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-o-tin-cay-phuc-hoi">
<span class="md-ellipsis">
      11. ğŸš€ Äá»™ tin cáº­y &amp; Phá»¥c há»“i
    </span>
</a>
<nav aria-label="11. ğŸš€ Äá»™ tin cáº­y &amp; Phá»¥c há»“i" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#111-trien-khai-khong-gian-oan-zero-downtime">
<span class="md-ellipsis">
      ğŸ§± 11.1. Triá»ƒn khai khÃ´ng giÃ¡n Ä‘oáº¡n (Zero Downtime)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#112-chinh-sach-trien-khai">
<span class="md-ellipsis">
      âš™ï¸ 11.2. ChÃ­nh sÃ¡ch triá»ƒn khai
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#113-auto-scaling">
<span class="md-ellipsis">
      â™»ï¸ 11.3. Auto Scaling
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#114-du-phong-du-lieu-recovery">
<span class="md-ellipsis">
      ğŸ’¾ 11.4. Dá»± phÃ²ng dá»¯ liá»‡u &amp; recovery
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#115-retry-timeouts">
<span class="md-ellipsis">
      âš¡ 11.5. Retry &amp; Timeouts
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#116-rollback-observability">
<span class="md-ellipsis">
      ğŸ”„ 11.6. Rollback &amp; Observability
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-hieu-nang-kha-nang-mo-rong">
<span class="md-ellipsis">
      12. âš¡ï¸ Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng
    </span>
</a>
<nav aria-label="12. âš¡ï¸ Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#121-truy-van-toi-uu-indexing">
<span class="md-ellipsis">
      âš¡ 12.1. Truy váº¥n tá»‘i Æ°u &amp; indexing
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#122-caching-thong-minh">
<span class="md-ellipsis">
      ğŸ§  12.2. Caching thÃ´ng minh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#123-ho-tro-phan-trang-lon-deep-pagination">
<span class="md-ellipsis">
      ğŸš€ 12.3. Há»— trá»£ phÃ¢n trang lá»›n (deep pagination)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#124-horizontal-scaling">
<span class="md-ellipsis">
      âš™ï¸ 12.4. Horizontal Scaling
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#125-theo-doi-hieu-nang">
<span class="md-ellipsis">
      ğŸ“‰ 12.5. Theo dÃµi hiá»‡u nÄƒng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#126-benchmark-load-test">
<span class="md-ellipsis">
      ğŸ§ª 12.6. Benchmark &amp; Load test
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#13-kien-truc-service">
<span class="md-ellipsis">
      13. ğŸ§© Kiáº¿n trÃºc Service
    </span>
</a>
<nav aria-label="13. ğŸ§© Kiáº¿n trÃºc Service" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#131-so-o-kien-truc-cap-nhat-tuan-cr-04">
<span class="md-ellipsis">
      ğŸ§­ 13.1. SÆ¡ Ä‘á»“ kiáº¿n trÃºc cáº­p nháº­t (tuÃ¢n CR-04)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#132-thanh-phan-chinh">
<span class="md-ellipsis">
      ğŸ§© 13.2. ThÃ nh pháº§n chÃ­nh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#133-cau-truc-thu-muc">
<span class="md-ellipsis">
      âš™ï¸ 13.3. Cáº¥u trÃºc thÆ° má»¥c
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#134-giao-tiep-tich-hop">
<span class="md-ellipsis">
      ğŸ”„ 13.4. Giao tiáº¿p &amp; tÃ­ch há»£p
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#135-cac-su-kien-phat-ra">
<span class="md-ellipsis">
      ğŸ“£ 13.5. CÃ¡c sá»± kiá»‡n phÃ¡t ra
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#14-tai-lieu-lien-quan">
<span class="md-ellipsis">
      14. TÃ i liá»‡u liÃªn quan
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="user-service-master-service-design-document">ğŸ“˜ User Service Master â€“ Service Design Document<a class="headerlink" href="#user-service-master-service-design-document" title="Permanent link">Â¶</a></h1>
<h2 id="1-muc-ich-scope">1. Má»¥c Ä‘Ã­ch (Scope)<a class="headerlink" href="#1-muc-ich-scope" title="Permanent link">Â¶</a></h2>
<p>User Service Master chá»‹u trÃ¡ch nhiá»‡m quáº£n lÃ½ Ä‘á»‹nh danh ngÆ°á»i dÃ¹ng toÃ n cá»¥c (<code>users_global</code>), danh sÃ¡ch tenant (<code>tenants</code>) vÃ  viá»‡c gÃ¡n ngÆ°á»i dÃ¹ng vÃ o tenant cá»¥ thá»ƒ (<code>user_tenant_assignments</code>). NgoÃ i ra, service nÃ y cÅ©ng cung cáº¥p cÃ¡c template RBAC toÃ n cá»¥c (<code>global_roles_templates</code>, <code>global_permissions_templates</code>) Ä‘á»ƒ cÃ¡c Sub User Service cÃ³ thá»ƒ Ä‘á»“ng bá»™ vÃ  khá»Ÿi táº¡o RBAC cá»¥c bá»™ cho tá»«ng tenant.</p>
<p>Service nÃ y lÃ  ná»n táº£ng cá»‘t lÃµi cho toÃ n bá»™ há»‡ thá»‘ng phÃ¢n quyá»n Ä‘a tenant, Ä‘áº£m báº£o tÃ­nh nháº¥t quÃ¡n trong quáº£n lÃ½ ngÆ°á»i dÃ¹ng vÃ  há»— trá»£ cÃ¡c luá»“ng xÃ¡c thá»±c tá»« Auth Master/Sub.</p>
<h3 id="khong-chiu-trach-nhiem-out-of-scope">ğŸš« KhÃ´ng chá»‹u trÃ¡ch nhiá»‡m (Out of Scope)<a class="headerlink" href="#khong-chiu-trach-nhiem-out-of-scope" title="Permanent link">Â¶</a></h3>
<p>User Service Master <strong>khÃ´ng</strong> chá»‹u trÃ¡ch nhiá»‡m Ä‘á»‘i vá»›i cÃ¡c chá»©c nÄƒng sau:</p>
<ul>
<li>âŒ Quáº£n lÃ½ RBAC chi tiáº¿t á»Ÿ cáº¥p tenant (bao gá»“m roles, permissions, vÃ  user-role mapping cá»¥c bá»™) â€“ Ä‘Ã¢y lÃ  trÃ¡ch nhiá»‡m cá»§a Sub User Service tÆ°Æ¡ng á»©ng.</li>
<li>âŒ Thá»±c hiá»‡n xÃ¡c thá»±c ngÆ°á»i dÃ¹ng (Google OAuth2, OTP, Local login) â€“ do Auth Service Master/Sub xá»­ lÃ½.</li>
<li>âŒ LÆ°u trá»¯ hoáº·c xá»­ lÃ½ cÃ¡c dá»¯ liá»‡u nghiá»‡p vá»¥ chi tiáº¿t cá»§a tá»«ng tenant (vÃ­ dá»¥: há»c sinh, giÃ¡o viÃªn, lá»›p há»c, há»c phÃ­...) â€“ cÃ¡c adapter CRM/SIS/LMS Ä‘áº£m nhiá»‡m pháº§n nÃ y.</li>
<li>âŒ Cung cáº¥p cÃ¡c giao diá»‡n frontend â€“ vÃ­ dá»¥ Superadmin Webapp chá»‰ gá»i API tá»« Gateway, chá»© khÃ´ng truy cáº­p trá»±c tiáº¿p vÃ o service nÃ y.</li>
</ul>
<hr/>
<h2 id="2-trach-nhiem-chinh-responsibilities">2. TrÃ¡ch nhiá»‡m chÃ­nh (Responsibilities)<a class="headerlink" href="#2-trach-nhiem-chinh-responsibilities" title="Permanent link">Â¶</a></h2>
<ul>
<li>Quáº£n lÃ½ báº£ng Ä‘á»‹nh danh ngÆ°á»i dÃ¹ng toÃ n há»‡ thá»‘ng (<code>users_global</code>)</li>
<li>Cho phÃ©p táº¡o, cáº­p nháº­t, tra cá»©u thÃ´ng tin ngÆ°á»i dÃ¹ng toÃ n cá»¥c</li>
<li>Quáº£n lÃ½ danh sÃ¡ch tenant Ä‘ang hoáº¡t Ä‘á»™ng vÃ  tráº¡ng thÃ¡i</li>
<li>GÃ¡n quyá»n ngÆ°á»i dÃ¹ng vÃ o cÃ¡c tenant cá»¥ thá»ƒ (<code>user_tenant_assignments</code>)</li>
<li>Cung cáº¥p bá»™ template <code>roles</code> vÃ  <code>permissions</code> dÃ¹ng Ä‘á»ƒ seed xuá»‘ng cÃ¡c tenant</li>
<li>PhÃ¡t sá»± kiá»‡n <code>user_created</code>, <code>tenant_user_assigned</code>, <code>rbac_template_updated</code> phá»¥c vá»¥ Sub Services</li>
</ul>
<hr/>
<h2 id="3-luong-nghiep-vu-chinh-business-flows">3. Luá»“ng nghiá»‡p vá»¥ chÃ­nh (Business Flows)<a class="headerlink" href="#3-luong-nghiep-vu-chinh-business-flows" title="Permanent link">Â¶</a></h2>
<h3 id="ang-nhap-google-oauth2-qua-auth-master">ğŸ”¹ ÄÄƒng nháº­p Google OAuth2 (qua Auth Master)<a class="headerlink" href="#ang-nhap-google-oauth2-qua-auth-master" title="Permanent link">Â¶</a></h3>
<ol>
<li>Auth Master xÃ¡c thá»±c thÃ nh cÃ´ng user Google â†’ gá»i <code>GET /users-global/by-email</code></li>
<li>Náº¿u chÆ°a tá»“n táº¡i â†’ gá»i <code>POST /users-global</code> Ä‘á»ƒ táº¡o má»›i</li>
<li>Gá»i <code>GET /user-tenant-assignments?user_id=...</code> Ä‘á»ƒ láº¥y danh sÃ¡ch tenant ngÆ°á»i dÃ¹ng thuá»™c vá»</li>
<li>NgÆ°á»i dÃ¹ng chá»n tenant â†’ chuyá»ƒn qua luá»“ng Auth tiáº¿p theo</li>
</ol>
<h3 id="gan-nguoi-dung-vao-tenant">ğŸ”¹ GÃ¡n ngÆ°á»i dÃ¹ng vÃ o tenant<a class="headerlink" href="#gan-nguoi-dung-vao-tenant" title="Permanent link">Â¶</a></h3>
<ul>
<li>Admin há»‡ thá»‘ng (qua Superadmin Webapp) cÃ³ thá»ƒ gÃ¡n ngÆ°á»i dÃ¹ng vÃ o 1 hoáº·c nhiá»u tenant</li>
<li>Gá»i <code>POST /user-tenant-assignments</code></li>
<li>PhÃ¡t sá»± kiá»‡n <code>tenant_user_assigned</code> Ä‘á»ƒ Sub User Service táº¡o báº£n ghi cá»¥c bá»™</li>
</ul>
<h4 id="luong-1-superadmin-gan-nguoi-dung-vao-tenant">ğŸ”„ Luá»“ng 1: Superadmin gÃ¡n ngÆ°á»i dÃ¹ng vÃ o tenant<a class="headerlink" href="#luong-1-superadmin-gan-nguoi-dung-vao-tenant" title="Permanent link">Â¶</a></h4>
<pre class="mermaid"><code>sequenceDiagram
    participant FE as Superadmin Webapp
    participant GW as API Gateway
    participant USM as User Service Master
    participant DB as PostgreSQL (users_global + user_tenant_assignments)
    participant PUB as Google Pub/Sub

    FE-&gt;&gt;GW: POST /user-tenant-assignments
    GW-&gt;&gt;USM: POST /user-tenant-assignments
    USM-&gt;&gt;DB: Ghi user_id, tenant_id, role_codes vÃ o báº£ng user_tenant_assignments
    USM--&gt;&gt;PUB: PhÃ¡t sá»± kiá»‡n tenant_user_assigned (chá»©a user_id, tenant_id, role_codes)
    USM--&gt;&gt;GW: 200 OK (status: success)
    GW--&gt;&gt;FE: Hiá»ƒn thá»‹ káº¿t quáº£ gÃ¡n thÃ nh cÃ´ng
</code></pre>
<p><strong>ğŸ“ Giáº£i thÃ­ch chi tiáº¿t:</strong></p>
<ol>
<li>Superadmin gá»­i yÃªu cáº§u gÃ¡n ngÆ°á»i dÃ¹ng (<code>user_id</code>) vÃ o má»™t <code>tenant_id</code>, kÃ¨m danh sÃ¡ch <code>role_codes</code>.</li>
<li>API Gateway Ä‘á»‹nh tuyáº¿n request tá»›i User Service Master.</li>
<li>User Service Master ghi thÃ´ng tin vÃ o báº£ng <code>user_tenant_assignments</code>.</li>
<li>Sau khi ghi thÃ nh cÃ´ng, service phÃ¡t má»™t sá»± kiá»‡n <code>tenant_user_assigned</code> lÃªn Pub/Sub, giÃºp Sub User Service cá»§a tenant tÆ°Æ¡ng á»©ng cÃ³ thá»ƒ Ä‘á»“ng bá»™ RBAC.</li>
<li>Káº¿t quáº£ tráº£ vá» cho frontend xÃ¡c nháº­n hÃ nh Ä‘á»™ng Ä‘Ã£ thÃ nh cÃ´ng.</li>
</ol>
<p><strong>ğŸ” TrÆ°á»ng há»£p lá»—i tiá»m áº©n:</strong></p>
<ul>
<li><code>user_id</code> khÃ´ng tá»“n táº¡i trong <code>users_global</code> â†’ 404.</li>
<li><code>tenant_id</code> khÃ´ng há»£p lá»‡ hoáº·c khÃ´ng tá»“n táº¡i â†’ 400.</li>
<li>Lá»—i logic: ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n vÃ o tenant Ä‘Ã³ â†’ 409 Conflict.</li>
</ul>
<h4 id="luong-2-ang-nhap-google-oauth2-yeu-cau-tu-auth-master">ğŸ” Luá»“ng 2: ÄÄƒng nháº­p Google OAuth2 â€“ yÃªu cáº§u tá»« Auth Master<a class="headerlink" href="#luong-2-ang-nhap-google-oauth2-yeu-cau-tu-auth-master" title="Permanent link">Â¶</a></h4>
<pre class="mermaid"><code>sequenceDiagram
    participant FE as Frontend (Superadmin Webapp)
    participant AuthM as Auth Service Master
    participant UserM as User Service Master

    FE-&gt;&gt;AuthM: ÄÄƒng nháº­p Google (OAuth2)
    AuthM-&gt;&gt;Google: Trao Ä‘á»•i token
    Google--&gt;&gt;AuthM: Tráº£ vá» user info (email, name,...)

    AuthM-&gt;&gt;UserM: GET /users-global/by-email?email=...
    alt KhÃ´ng tÃ¬m tháº¥y
        AuthM-&gt;&gt;UserM: POST /users-global (táº¡o user)
    end

    AuthM-&gt;&gt;UserM: GET /user-tenant-assignments?user_id=...
    UserM--&gt;&gt;AuthM: Tráº£ vá» danh sÃ¡ch tenant Ä‘Ã£ gÃ¡n

    AuthM--&gt;&gt;FE: Tráº£ vá» danh sÃ¡ch tenant Ä‘á»ƒ chá»n
</code></pre>
<p>â¡ï¸ Sau bÆ°á»›c nÃ y, AuthM sáº½ tiáº¿p tá»¥c gá»i Sub User Service tÆ°Æ¡ng á»©ng Ä‘á»ƒ láº¥y RBAC vÃ  phÃ¡t hÃ nh JWT.</p>
<hr/>
<h4 id="luong-3-taocap-nhat-rbac-template">ğŸ§© Luá»“ng 3: Táº¡o/Cáº­p nháº­t RBAC Template<a class="headerlink" href="#luong-3-taocap-nhat-rbac-template" title="Permanent link">Â¶</a></h4>
<pre class="mermaid"><code>sequenceDiagram
    participant FE as Superadmin Webapp
    participant Gateway as API Gateway
    participant UserM as User Service Master
    participant PubSub as GCP Pub/Sub

    FE-&gt;&gt;Gateway: POST /rbac/templates (role/permission)
    Gateway-&gt;&gt;UserM: POST /rbac/templates
    UserM-&gt;&gt;DB: Táº¡o hoáº·c cáº­p nháº­t báº£ng templates
    UserM-&gt;&gt;PubSub: Publish event rbac_template_updated
    PubSub--&gt;&gt;SubUser: Trigger Ä‘á»“ng bá»™ template
</code></pre>
<p>â¡ï¸ CÃ¡c Sub User Service cÃ³ thá»ƒ tá»± Ä‘á»“ng bá»™ hoáº·c hiá»ƒn thá»‹ gá»£i Ã½ cáº­p nháº­t template.</p>
<hr/>
<h4 id="luong-4-sub-auth-service-tao-user-local-moi-va-cap-user_id_global">ğŸ‘¤ Luá»“ng 4: Sub Auth Service táº¡o user local má»›i vÃ  cáº¥p <code>user_id_global</code><a class="headerlink" href="#luong-4-sub-auth-service-tao-user-local-moi-va-cap-user_id_global" title="Permanent link">Â¶</a></h4>
<pre class="mermaid"><code>sequenceDiagram
    participant AuthT as Sub Auth Service
    participant Gateway as API Gateway
    participant UserM as User Service Master

    AuthT-&gt;&gt;Gateway: POST /users-global (táº¡o user local)
    Gateway-&gt;&gt;UserM: POST /users-global
    UserM-&gt;&gt;DB: Táº¡o user (auth_provider = 'local')
    UserM--&gt;&gt;Gateway: Tráº£ vá» user_id_global
    Gateway--&gt;&gt;AuthT: Tráº£ vá» user_id_global
</code></pre>
<p>â¡ï¸ AuthT sau Ä‘Ã³ sáº½ gÃ¡n user vÃ o tenant cá»§a mÃ¬nh vÃ  phÃ¡t hÃ nh JWT theo chuáº©n Ä‘a tenant.</p>
<hr/>
<h2 id="4-mo-hinh-du-lieu">4. MÃ´ hÃ¬nh dá»¯ liá»‡u<a class="headerlink" href="#4-mo-hinh-du-lieu" title="Permanent link">Â¶</a></h2>
<p>CÃ¡c báº£ng chÃ­nh do User Service Master quáº£n lÃ½ bao gá»“m:</p>
<ul>
<li><code>users_global</code>: danh sÃ¡ch ngÆ°á»i dÃ¹ng toÃ n cá»¥c, gáº¯n vá»›i auth_provider.</li>
<li><code>tenants</code>: thÃ´ng tin tá»«ng tenant (trÆ°á»ng thÃ nh viÃªn).</li>
<li><code>user_tenant_assignments</code>: liÃªn káº¿t ngÆ°á»i dÃ¹ng vá»›i tá»«ng tenant cá»¥ thá»ƒ.</li>
<li><code>global_roles_templates</code>: danh sÃ¡ch template vai trÃ² toÃ n cá»¥c.</li>
<li><code>global_permissions_templates</code>: danh sÃ¡ch template quyá»n toÃ n cá»¥c.</li>
</ul>
<h3 id="so-o-erd-tong-quan">ğŸ§© SÆ¡ Ä‘á»“ ERD tá»•ng quan<a class="headerlink" href="#so-o-erd-tong-quan" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>erDiagram

    USERS_GLOBAL {
        UUID user_id PK
        TEXT full_name
        TEXT email
        TEXT auth_provider
    }

    TENANTS {
        TEXT tenant_id PK
        TEXT tenant_name
        TEXT status
    }

    USER_TENANT_ASSIGNMENTS {
        UUID id PK
        UUID user_id_global FK
        TEXT tenant_id FK
        TEXT role_codes
        BOOLEAN is_active
    }

    GLOBAL_ROLES_TEMPLATES {
        UUID template_id PK
        TEXT template_code
        TEXT description
    }

    GLOBAL_PERMISSIONS_TEMPLATES {
        UUID template_id PK
        TEXT permission_code
        TEXT action
        TEXT resource
        TEXT default_condition
    }

    USERS_GLOBAL ||--o{ USER_TENANT_ASSIGNMENTS : has
    TENANTS ||--o{ USER_TENANT_ASSIGNMENTS : includes
    GLOBAL_ROLES_TEMPLATES ||--o{ GLOBAL_PERMISSIONS_TEMPLATES : defines
</code></pre>
<p>ğŸ“ <strong>Ghi chÃº quan trá»ng cho sÆ¡ Ä‘á»“ ERD:</strong></p>
<ul>
<li><code>USER_TENANT_ASSIGNMENTS.role_codes</code>: LÃ  má»™t <strong>máº£ng TEXT</strong>. Mermaid khÃ´ng há»— trá»£ kiá»ƒu <code>TEXT[]</code>, nÃªn Ä‘Æ°á»£c ghi lÃ  <code>TEXT</code> cho Ä‘Æ¡n giáº£n.</li>
<li><code>GLOBAL_PERMISSIONS_TEMPLATES.default_condition</code>: LÃ  má»™t <strong>trÆ°á»ng JSONB</strong> dÃ¹ng Ä‘á»ƒ Ä‘á»‹nh nghÄ©a Ä‘iá»u kiá»‡n RBAC. Mermaid chá»‰ há»— trá»£ <code>TEXT</code>, nÃªn cáº§n hiá»ƒu <code>TEXT default_condition</code> á»Ÿ Ä‘Ã¢y lÃ  biá»ƒu diá»…n cá»§a JSONB.</li>
<li><code>email</code>, <code>template_code</code>, <code>permission_code</code>: CÃ³ rÃ ng buá»™c <code>UNIQUE</code> trong thiáº¿t káº¿ thá»±c táº¿ â€“ khÃ´ng thá»ƒ hiá»‡n trong sÆ¡ Ä‘á»“ Mermaid nhÆ°ng Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong migration script hoáº·c tÃ i liá»‡u <code>data-model.md</code>.</li>
</ul>
<p>ğŸ‘‰ Xem chi tiáº¿t Ä‘á»‹nh nghÄ©a báº£ng táº¡i: <a href="../data-model/"><code>data-model.md</code></a></p>
<hr/>
<h2 id="5-api">5. API<a class="headerlink" href="#5-api" title="Permanent link">Â¶</a></h2>
<p>User Service Master cung cáº¥p cÃ¡c API phá»¥c vá»¥ cho:</p>
<ul>
<li>Superadmin Webapp: quáº£n lÃ½ Ä‘á»‹nh danh ngÆ°á»i dÃ¹ng vÃ  RBAC toÃ n cá»¥c.</li>
<li>Auth Service Master/Sub: tra cá»©u, táº¡o ngÆ°á»i dÃ¹ng toÃ n cá»¥c.</li>
<li>Sub User Service: Ä‘á»“ng bá»™ danh sÃ¡ch assignment, template RBAC.</li>
</ul>
<p>Chi tiáº¿t Ä‘á»‹nh nghÄ©a tham kháº£o táº¡i <a href="../interface-contract/"><code>interface-contract.md</code></a> vÃ  <a href="../openapi.yaml"><code>openapi.yaml</code></a>.</p>
<h3 id="bang-tom-tat-api-chinh">ğŸ“š Báº£ng tÃ³m táº¯t API chÃ­nh<a class="headerlink" href="#bang-tom-tat-api-chinh" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Path</th>
<th>MÃ´ táº£ ngáº¯n</th>
<th>YÃªu cáº§u quyá»n</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/users-global/by-email</code></td>
<td>Tra cá»©u ngÆ°á»i dÃ¹ng toÃ n cá»¥c theo email</td>
<td>Authenticated (Google)</td>
</tr>
<tr>
<td>POST</td>
<td><code>/users-global</code></td>
<td>Táº¡o ngÆ°á»i dÃ¹ng toÃ n cá»¥c má»›i</td>
<td>Authenticated (Google, OTP)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/tenants</code></td>
<td>Liá»‡t kÃª danh sÃ¡ch cÃ¡c tenant hiá»‡n cÃ³</td>
<td>Superadmin</td>
</tr>
<tr>
<td>GET</td>
<td><code>/user-tenant-assignments</code></td>
<td>Tra cá»©u cÃ¡c tenant mÃ  ngÆ°á»i dÃ¹ng thuá»™c vá»</td>
<td>Auth Service / Admin Tenant</td>
</tr>
<tr>
<td>POST</td>
<td><code>/user-tenant-assignments</code></td>
<td>GÃ¡n ngÆ°á»i dÃ¹ng vÃ o tenant cá»¥ thá»ƒ</td>
<td>Superadmin</td>
</tr>
<tr>
<td>GET</td>
<td><code>/global-roles-templates</code></td>
<td>Tra cá»©u template vai trÃ² toÃ n cá»¥c</td>
<td>Superadmin</td>
</tr>
<tr>
<td>POST</td>
<td><code>/global-roles-templates</code></td>
<td>Táº¡o má»›i template vai trÃ² toÃ n cá»¥c</td>
<td>Superadmin</td>
</tr>
<tr>
<td>GET</td>
<td><code>/global-permissions-templates</code></td>
<td>Tra cá»©u template quyá»n toÃ n cá»¥c</td>
<td>Superadmin</td>
</tr>
<tr>
<td>POST</td>
<td><code>/global-permissions-templates</code></td>
<td>Táº¡o má»›i template quyá»n toÃ n cá»¥c</td>
<td>Superadmin</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="6-su-kien-phat-ra-events">6. Sá»± kiá»‡n phÃ¡t ra (Events)<a class="headerlink" href="#6-su-kien-phat-ra-events" title="Permanent link">Â¶</a></h2>
<p>User Service Master phÃ¡t cÃ¡c sá»± kiá»‡n lÃªn Google Cloud Pub/Sub Ä‘á»ƒ:</p>
<ul>
<li>ThÃ´ng bÃ¡o cho cÃ¡c Sub User Services vá» thay Ä‘á»•i RBAC.</li>
<li>Cho phÃ©p cÃ¡c service khÃ¡c Ä‘á»“ng bá»™ Ä‘á»‹nh danh ngÆ°á»i dÃ¹ng vÃ  cáº¥u hÃ¬nh tenant.</li>
</ul>
<h3 id="danh-sach-su-kien">ğŸ“¢ Danh sÃ¡ch sá»± kiá»‡n<a class="headerlink" href="#danh-sach-su-kien" title="Permanent link">Â¶</a></h3>
<h4 id="1-tenant_user_assigned">1. <code>tenant_user_assigned</code><a class="headerlink" href="#1-tenant_user_assigned" title="Permanent link">Â¶</a></h4>
<blockquote>
<p>Khi má»™t ngÆ°á»i dÃ¹ng Ä‘Æ°á»£c gÃ¡n vÃ o má»™t tenant má»›i.</p>
</blockquote>
<div class="language-json highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p">{</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">"event_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"evt_7a3a8b40"</span><span class="p">,</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">"event_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tenant_user_assigned"</span><span class="p">,</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">"user_id_global"</span><span class="p">:</span><span class="w"> </span><span class="s2">"usr_12345678"</span><span class="p">,</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vas-truong-a"</span><span class="p">,</span>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="nt">"role_codes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"teacher"</span><span class="p">,</span><span class="w"> </span><span class="s2">"homeroom"</span><span class="p">],</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="nt">"assignment_status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-01T08:30:00Z"</span>
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><strong>Consumer:</strong> Sub User Service cá»§a tenant tÆ°Æ¡ng á»©ng</li>
<li><strong>TÃ¡c dá»¥ng:</strong> Tá»± Ä‘á»™ng táº¡o <code>users_in_tenant</code> vÃ  mapping role cho user trong tenant Ä‘Ã³</li>
<li><strong>YÃªu cáº§u idempotency:</strong> Sub Service pháº£i kiá»ƒm tra <code>event_id</code> hoáº·c <code>user_id + tenant_id</code> Ä‘Ã£ xá»­ lÃ½ hay chÆ°a.</li>
</ul>
<hr/>
<h4 id="2-rbac_template_updated">2. <code>rbac_template_updated</code><a class="headerlink" href="#2-rbac_template_updated" title="Permanent link">Â¶</a></h4>
<blockquote>
<p>Khi má»™t template vai trÃ² hoáº·c quyá»n toÃ n cá»¥c Ä‘Æ°á»£c cáº­p nháº­t.</p>
</blockquote>
<div class="language-json highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nt">"event_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"evt_5baf6c2d"</span><span class="p">,</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nt">"event_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rbac_template_updated"</span><span class="p">,</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">"template_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"permission"</span><span class="p">,</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nt">"template_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"perm_tpl_001"</span><span class="p">,</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"create_or_update"</span><span class="p">,</span>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="nt">"updated_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"superadmin@vas.edu.vn"</span><span class="p">,</span>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-01T09:00:00Z"</span>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><strong>Consumer:</strong> Sub User Services cÃ³ nhu cáº§u Ä‘á»“ng bá»™ template</li>
<li><strong>TÃ¡c dá»¥ng:</strong> Cho phÃ©p Sub Service quyáº¿t Ä‘á»‹nh cÃ³ nÃªn cáº­p nháº­t local template khÃ´ng (hoáº·c gá»£i Ã½ cho admin cáº­p nháº­t thá»§ cÃ´ng)</li>
<li><strong>Gá»£i Ã½ thá»±c thi:</strong> CÃ³ thá»ƒ lÆ°u láº¡i trong báº£ng <code>rbac_template_sync_log</code> táº¡i Sub Service Ä‘á»ƒ kiá»ƒm soÃ¡t phiÃªn báº£n.</li>
</ul>
<hr/>
<h2 id="7-bao-mat-phan-quyen">7. ğŸ” Báº£o máº­t &amp; PhÃ¢n quyá»n<a class="headerlink" href="#7-bao-mat-phan-quyen" title="Permanent link">Â¶</a></h2>
<p><code>user-service/master</code> xá»­ lÃ½ thÃ´ng tin Ä‘á»‹nh danh toÃ n cá»¥c (Global User Identity), do Ä‘Ã³ yÃªu cáº§u chÃ­nh sÃ¡ch báº£o máº­t vÃ  kiá»ƒm soÃ¡t phÃ¢n quyá»n cháº·t cháº½ theo kiáº¿n trÃºc RBAC phÃ¢n táº§ng (xem chi tiáº¿t táº¡i <a href="../../architecture/rbac-deep-dive.md"><code>rbac-deep-dive.md</code></a>).</p>
<hr/>
<h3 id="71-authentication-xac-thuc">ğŸ›¡ï¸ 7.1. Authentication (XÃ¡c thá»±c)<a class="headerlink" href="#71-authentication-xac-thuc" title="Permanent link">Â¶</a></h3>
<ul>
<li>Táº¥t cáº£ cÃ¡c endpoint Ä‘á»u yÃªu cáº§u <strong>JWT access token há»£p lá»‡</strong>, do <code>auth-service/master</code> cáº¥p phÃ¡t.</li>
<li>Token Ä‘Æ°á»£c xÃ¡c thá»±c táº¡i API Gateway, sá»­ dá»¥ng public key tá»« <code>JWKS</code> endpoint.</li>
<li>Service khÃ´ng decode token mÃ  dá»±a vÃ o gateway Ä‘á»ƒ inject <code>X-User-ID</code>, <code>X-User-Role</code>, <code>X-Tenant-ID</code>.</li>
</ul>
<hr/>
<h3 id="72-authorization-phan-quyen-ong">ğŸ§© 7.2. Authorization (PhÃ¢n quyá»n Ä‘á»™ng)<a class="headerlink" href="#72-authorization-phan-quyen-ong" title="Permanent link">Â¶</a></h3>
<ul>
<li>Há»‡ thá»‘ng Ã¡p dá»¥ng <strong>RBAC 3 táº§ng</strong>: <code>global</code>, <code>tenant</code>, vÃ  <code>scoped-role</code>.</li>
<li>Má»—i endpoint Ä‘á»‹nh nghÄ©a <code>x-required-permission</code>, vÃ­ dá»¥:</li>
</ul>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nt">x-required-permission</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user.read:any</span>
</span></code></pre></div>
<ul>
<li>CÃ¡c permission Ä‘Æ°á»£c mapping theo báº£ng sau:</li>
</ul>
<table>
<thead>
<tr>
<th>Permission</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user.read:any</code></td>
<td>Truy cáº­p thÃ´ng tin báº¥t ká»³ user nÃ o</td>
</tr>
<tr>
<td><code>user.read:self</code></td>
<td>Truy cáº­p chá»‰ thÃ´ng tin cá»§a chÃ­nh mÃ¬nh</td>
</tr>
<tr>
<td><code>user.create</code></td>
<td>Táº¡o user má»›i toÃ n cá»¥c</td>
</tr>
<tr>
<td><code>user.update:any</code></td>
<td>Sá»­a thÃ´ng tin user báº¥t ká»³</td>
</tr>
<tr>
<td><code>user.update:self</code></td>
<td>Sá»­a thÃ´ng tin cá»§a chÃ­nh mÃ¬nh</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="73-bao-ve-du-lieu-nhay-cam">ğŸ” 7.3. Báº£o vá»‡ dá»¯ liá»‡u nháº¡y cáº£m<a class="headerlink" href="#73-bao-ve-du-lieu-nhay-cam" title="Permanent link">Â¶</a></h3>
<ul>
<li>
<p>TrÆ°á»ng <code>password</code>, <code>token</code>, <code>email_verified_at</code> Ä‘á»u Ä‘Æ°á»£c báº£o vá»‡:</p>
</li>
<li>
<p><code>password</code> chá»‰ ghi, khÃ´ng bao giá» tráº£ vá» (gáº¯n <code>writeOnly: true</code>)</p>
</li>
<li>Email Ä‘Æ°á»£c xÃ¡c minh á»Ÿ <code>auth/master</code>, khÃ´ng lÆ°u láº¡i trong <code>user/master</code></li>
<li>
<p>CÃ¡c trÆ°á»ng cÃ³ thá»ƒ bá»‹ giá»›i háº¡n truy cáº­p tuá»³ theo vai trÃ²:</p>
</li>
<li>
<p><code>internal_notes</code> chá»‰ hiá»‡n vá»›i <code>admin</code>, khÃ´ng hiá»‡n vá»›i <code>self</code></p>
</li>
</ul>
<hr/>
<h3 id="74-audit-logging">ğŸ” 7.4. Audit Logging<a class="headerlink" href="#74-audit-logging" title="Permanent link">Â¶</a></h3>
<ul>
<li>
<p>Má»i thao tÃ¡c ghi (<code>POST</code>, <code>PATCH</code>, <code>DELETE</code>) Ä‘á»u emit sá»± kiá»‡n audit:</p>
</li>
<li>
<p><code>user.created</code>, <code>user.updated</code>, <code>user.merged</code></p>
</li>
<li>Log audit Ä‘Æ°á»£c gá»­i qua Pub/Sub â†’ <code>audit-logging-service</code>, tuÃ¢n thá»§ <a href="../../../../ADR/adr-008-audit-logging/">ADR-008</a></li>
</ul>
<hr/>
<h3 id="75-internal-auth">ğŸ”’ 7.5. Internal Auth<a class="headerlink" href="#75-internal-auth" title="Permanent link">Â¶</a></h3>
<ul>
<li>CÃ¡c call ná»™i bá»™ (vÃ­ dá»¥: tá»« <code>auth-service/master</code>) sá»­ dá»¥ng <code>SERVICE_AUTH_TOKEN</code> vÃ  Ä‘Æ°á»£c kiá»ƒm tra táº¡i gateway.</li>
<li>Nhá»¯ng API khÃ´ng dÃ nh cho public (seed role, fetch global profile) cÃ³ gáº¯n:</li>
</ul>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nt">x-internal-only</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nt">x-service-auth-required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></code></pre></div>
<hr/>
<h3 id="76-rate-limiting-abuse-prevention">ğŸš« 7.6. Rate Limiting &amp; Abuse Prevention<a class="headerlink" href="#76-rate-limiting-abuse-prevention" title="Permanent link">Â¶</a></h3>
<ul>
<li>Gateway cáº¥u hÃ¬nh limit máº·c Ä‘á»‹nh: <code>100 req/min/user</code></li>
<li>CÃ¡c endpoint nháº¡y cáº£m (tÃ¬m theo email, táº¡o user) cÃ³ thá»ƒ gáº¯n limit riÃªng.</li>
</ul>
<hr/>
<h2 id="8-cau-hinh-trien-khai">8. âš™ï¸ Cáº¥u hÃ¬nh &amp; Triá»ƒn khai<a class="headerlink" href="#8-cau-hinh-trien-khai" title="Permanent link">Â¶</a></h2>
<h3 id="bien-moi-truong">ğŸ”§ Biáº¿n mÃ´i trÆ°á»ng<a class="headerlink" href="#bien-moi-truong" title="Permanent link">Â¶</a></h3>
<p>Service sá»­ dá»¥ng cáº¥u hÃ¬nh tá»« file <code>.env</code> (hoáº·c <code>settings/.env.&lt;env&gt;.template</code>) theo chuáº©n hÃ³a tá»« <a href="../../../../ADR/adr-005-env-config/">ADR-005: Env Config</a>. Má»™t sá»‘ biáº¿n chÃ­nh:</p>
<table>
<thead>
<tr>
<th>TÃªn biáº¿n</th>
<th>MÃ´ táº£</th>
<th>VÃ­ dá»¥</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ENVIRONMENT</code></td>
<td>MÃ´i trÆ°á»ng cháº¡y (<code>local</code>, <code>staging</code>, <code>production</code>)</td>
<td><code>staging</code></td>
</tr>
<tr>
<td><code>SERVICE_PORT</code></td>
<td>Cá»•ng cháº¡y service</td>
<td><code>8000</code></td>
</tr>
<tr>
<td><code>DATABASE_URL</code></td>
<td>Káº¿t ná»‘i PostgreSQL</td>
<td><code>postgresql://user:pass@host/db</code></td>
</tr>
<tr>
<td><code>REDIS_URL</code></td>
<td>Káº¿t ná»‘i Redis (cache session/token)</td>
<td><code>redis://localhost:6379/0</code></td>
</tr>
<tr>
<td><code>SERVICE_AUTH_TOKEN</code></td>
<td>Token dÃ¹ng Ä‘á»ƒ gá»i ná»™i bá»™ giá»¯a cÃ¡c service (Auth Master â†’ User Master)</td>
<td><code>secret-key</code></td>
</tr>
<tr>
<td><code>JWT_PUBLIC_KEY</code></td>
<td>Public key Ä‘á»ƒ validate access token (dáº¡ng PEM)</td>
<td>â€“</td>
</tr>
<tr>
<td><code>GOOGLE_CLOUD_PROJECT</code></td>
<td>Project ID dÃ¹ng cho Pub/Sub (náº¿u báº­t audit)</td>
<td><code>dxvas-dev</code></td>
</tr>
<tr>
<td><code>LOG_LEVEL</code></td>
<td>Má»©c log (<code>DEBUG</code>, <code>INFO</code>, ...)</td>
<td><code>INFO</code></td>
</tr>
</tbody>
</table>
<p>ğŸ‘‰ ToÃ n bá»™ cÃ¡c biáº¿n Ä‘Æ°á»£c liá»‡t kÃª vÃ  version hÃ³a táº¡i: <code>settings/.env.template</code>.</p>
<hr/>
<h3 id="cau-truc-thu-muc-cau-hinh">ğŸ›  Cáº¥u trÃºc thÆ° má»¥c cáº¥u hÃ¬nh<a class="headerlink" href="#cau-truc-thu-muc-cau-hinh" title="Permanent link">Â¶</a></h3>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>settings/
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>â”œâ”€â”€<span class="w"> </span>.env.template<span class="w">              </span><span class="c1"># Biáº¿n mÃ´i trÆ°á»ng chuáº©n (dÃ¹ng cho má»i mÃ´i trÆ°á»ng)</span>
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>â”œâ”€â”€<span class="w"> </span>env.staging.yaml<span class="w">          </span><span class="c1"># Override cho mÃ´i trÆ°á»ng staging</span>
</span><span id="__span-4-4"><a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>â”œâ”€â”€<span class="w"> </span>env.production.yaml<span class="w">       </span><span class="c1"># Override cho mÃ´i trÆ°á»ng production</span>
</span><span id="__span-4-5"><a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>â””â”€â”€<span class="w"> </span>secrets.yaml<span class="w">              </span><span class="c1"># Chá»‰ chá»©a key nháº¡y cáº£m, inject tá»« Vault/SecretManager</span>
</span></code></pre></div>
<ul>
<li>ToÃ n bá»™ file <code>yaml</code> Ä‘á»u Ä‘Æ°á»£c load tá»± Ä‘á»™ng bá»Ÿi module config chuáº©n trong <code>dx-core</code>.</li>
<li>Secrets nhÆ° <code>JWT_PRIVATE_KEY</code> KHÃ”NG Ä‘Æ°á»£c ghi trá»±c tiáº¿p vÃ o <code>.env</code>, mÃ  Ä‘Æ°á»£c mount vÃ o volume hoáº·c láº¥y tá»« SecretManager (theo <a href="../../../../ADR/adr-003-secrets/">ADR-003: Secrets</a>).</li>
</ul>
<hr/>
<h3 id="cicd-trien-khai">ğŸš€ CI/CD &amp; Triá»ƒn khai<a class="headerlink" href="#cicd-trien-khai" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ <a href="../../../../ADR/adr-001-ci-cd/">ADR-001: CI/CD Pipeline</a>:</p>
<table>
<thead>
<tr>
<th>ThÃ nh pháº§n</th>
<th>CÃ´ng cá»¥</th>
<th>Ghi chÃº</th>
</tr>
</thead>
<tbody>
<tr>
<td>Build &amp; test</td>
<td>GitHub Actions</td>
<td><code>test.yaml</code>, <code>lint.yaml</code> trong <code>.github/workflows/</code></td>
</tr>
<tr>
<td>Build image</td>
<td>Docker, Poetry</td>
<td>Image tá»‘i Æ°u tá»« <code>python:slim</code>, khÃ´ng include dev deps</td>
</tr>
<tr>
<td>Scan báº£o máº­t</td>
<td><code>trivy</code>, <code>semgrep</code></td>
<td>TÃ­ch há»£p vÃ o CI</td>
</tr>
<tr>
<td>Deploy</td>
<td>ArgoCD</td>
<td>Tá»± Ä‘á»™ng rollout náº¿u merge vÃ o <code>main</code></td>
</tr>
<tr>
<td>Observability</td>
<td>OpenTelemetry, Grafana, Sentry</td>
<td>Default gáº¯n theo dx-core</td>
</tr>
<tr>
<td>Migration</td>
<td>Alembic, trigger qua Argo Job</td>
<td>TÃ¡ch step migrate vÃ  deploy rÃµ rÃ ng</td>
</tr>
</tbody>
</table>
<hr/>
<p>ğŸ“Œ Äá»ƒ cháº¡y service cá»¥c bá»™:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>cp<span class="w"> </span>settings/.env.template<span class="w"> </span>.env
</span><span id="__span-5-2"><a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>docker-compose<span class="w"> </span>up<span class="w"> </span>-d<span class="w"> </span>postgres<span class="w"> </span>redis
</span><span id="__span-5-3"><a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>make<span class="w"> </span>run
</span></code></pre></div>
<hr/>
<h2 id="9-chien-luoc-test">9. ğŸ§ª Chiáº¿n lÆ°á»£c Test<a class="headerlink" href="#9-chien-luoc-test" title="Permanent link">Â¶</a></h2>
<p>Viá»‡c kiá»ƒm thá»­ <code>user-service/master</code> Ä‘Æ°á»£c tá»• chá»©c theo <strong>chiáº¿n lÆ°á»£c kiá»ƒm thá»­ Ä‘a táº§ng</strong>, Ä‘áº£m báº£o cháº¥t lÆ°á»£ng tá»« má»©c Ä‘á»™ logic ná»™i bá»™ Ä‘áº¿n tÃ­ch há»£p liÃªn service, Ä‘á»“ng thá»i cÃ³ thá»ƒ cháº¡y hiá»‡u quáº£ trong CI/CD pipeline.</p>
<hr/>
<h3 id="91-unit-test">âœ… 9.1. Unit Test<a class="headerlink" href="#91-unit-test" title="Permanent link">Â¶</a></h3>
<ul>
<li>
<p>Pháº¡m vi:</p>
</li>
<li>
<p>Xá»­ lÃ½ logic nghiá»‡p vá»¥: táº¡o user, validate dá»¯ liá»‡u, phÃ¢n quyá»n Ä‘á»™ng</p>
</li>
<li>Format hÃ³a response vÃ  mÃ£ lá»—i theo ADR-012</li>
<li>CÃ´ng cá»¥: <code>pytest + pytest-mock</code></li>
<li>Má»—i PR má»›i Ä‘á»u báº¯t buá»™c cháº¡y qua test suite nÃ y trong GitHub Actions (<code>test.yaml</code>)</li>
<li>YÃªu cáº§u coverage â‰¥ <strong>85%</strong></li>
</ul>
<hr/>
<h3 id="92-contract-test-consumer-driven">âœ… 9.2. Contract Test (Consumer-Driven)<a class="headerlink" href="#92-contract-test-consumer-driven" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ <a href="../../../../ADR/adr-010-contract-testing/">ADR-010: Contract Testing</a></p>
<ul>
<li>Kiá»ƒm thá»­ tÆ°Æ¡ng thÃ­ch giá»¯a <code>user-service/master</code> vÃ  cÃ¡c consumer (vÃ­ dá»¥: <code>auth/master</code>, <code>api-gateway</code>)</li>
<li>DÃ¹ng <code>pact-python</code>, publish pact file lÃªn <code>pact-broker</code></li>
<li>CI sáº½ <strong>fail náº¿u producer lÃ m gÃ£y contract</strong></li>
<li>
<p>Báº¯t buá»™c cÃ³ contract test cho cÃ¡c API:</p>
</li>
<li>
<p><code>GET /users-global/{id}</code></p>
</li>
<li><code>POST /users-global</code></li>
<li><code>GET /users-global/by-email</code></li>
</ul>
<hr/>
<h3 id="93-integration-test-service-level">âœ… 9.3. Integration Test (Service level)<a class="headerlink" href="#93-integration-test-service-level" title="Permanent link">Â¶</a></h3>
<ul>
<li>Spin-up toÃ n bá»™ stack (PostgreSQL, Redis, user-service) trong Docker Compose</li>
<li>Cháº¡y cÃ¡c test query + mutation logic Ä‘áº§y Ä‘á»§ (bao gá»“m validate RBAC, phÃ¢n quyá»n)</li>
<li>DÃ¹ng <code>httpx</code> hoáº·c <code>pytest-httpx</code> Ä‘á»ƒ test end-to-end response format</li>
<li>Äáº£m báº£o emit Ä‘Ãºng cÃ¡c sá»± kiá»‡n (<code>user.created</code>, <code>user.duplicated</code>, <code>user.updated</code>) qua Pub/Sub mock</li>
</ul>
<hr/>
<h3 id="94-load-performance-test-tuy-chon">âœ… 9.4. Load &amp; Performance Test (TÃ¹y chá»n)<a class="headerlink" href="#94-load-performance-test-tuy-chon" title="Permanent link">Â¶</a></h3>
<ul>
<li>DÃ¹ng <code>locust</code> hoáº·c <code>k6</code> Ä‘á»ƒ test throughput cá»§a cÃ¡c API truy xuáº¥t hÃ ng loáº¡t (pagination, filter)</li>
<li>Æ¯á»›c lÆ°á»£ng ngÆ°á»¡ng tá»‘i Æ°u: 1000 req/s vá»›i latency P95 &lt; 200ms</li>
<li>GiÃºp tune indexing, limit-offset, caching Redis user_id â†’ full profile</li>
</ul>
<hr/>
<h3 id="95-security-test">âœ… 9.5. Security Test<a class="headerlink" href="#95-security-test" title="Permanent link">Â¶</a></h3>
<ul>
<li><code>pytest</code> vá»›i cÃ¡c case Ä‘áº·c biá»‡t: khÃ´ng cÃ³ token, token sai scope, sai tenant</li>
<li>Káº¿t há»£p <code>semgrep</code> Ä‘á»ƒ phÃ¡t hiá»‡n hardcoded secrets, lá»—i injection</li>
<li>Test <code>user.read:self</code> vs <code>user.read:any</code> Ä‘á»ƒ xÃ¡c minh phÃ¢n quyá»n Ä‘á»™ng</li>
</ul>
<hr/>
<h3 id="bao-cao-tich-hop-ci">ğŸ§ª BÃ¡o cÃ¡o &amp; TÃ­ch há»£p CI<a class="headerlink" href="#bao-cao-tich-hop-ci" title="Permanent link">Â¶</a></h3>
<ul>
<li>Test cháº¡y qua <code>make test</code>, <code>make test-contract</code>, <code>make test-int</code></li>
<li>Káº¿t quáº£ publish lÃªn <code>coverage.xml</code>, <code>junit.xml</code>, tÃ­ch há»£p GitHub Checks</li>
<li>Pact Broker: <code>https://pact.dxvas.vn</code></li>
<li>Allure Report: TÃ¹y chá»n publish khi cháº¡y full test suite</li>
</ul>
<blockquote>
<p>ğŸ§  Má»i ká»‹ch báº£n test cáº§n bao gá»“m trÆ°á»ng há»£p thÃ nh cÃ´ng, lá»—i logic, vÃ  lá»—i há»‡ thá»‘ng (timeout, lá»—i DB, lá»—i Pub/Sub...).</p>
</blockquote>
<hr/>
<h2 id="10-quan-sat-giam-sat">10. ğŸ“ˆ Quan sÃ¡t &amp; GiÃ¡m sÃ¡t<a class="headerlink" href="#10-quan-sat-giam-sat" title="Permanent link">Â¶</a></h2>
<p>Há»‡ thá»‘ng quan sÃ¡t (observability) cá»§a <code>user-service/master</code> giÃºp Ä‘áº£m báº£o kháº£ nÄƒng phÃ¡t hiá»‡n lá»—i sá»›m, Ä‘o lÆ°á»ng sá»©c khá»e há»‡ thá»‘ng vÃ  há»— trá»£ phÃ¢n tÃ­ch hÃ nh vi ngÆ°á»i dÃ¹ng phá»¥c vá»¥ váº­n hÃ nh Ä‘a tenant hiá»‡u quáº£.</p>
<hr/>
<h3 id="101-logging">ğŸ“Š 10.1. Logging<a class="headerlink" href="#101-logging" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>Chuáº©n log JSON</strong> theo <code>dx-core</code>, Ä‘á»‹nh dáº¡ng:
  <code>{ timestamp, level, service, trace_id, span_id, user_id, tenant_id, msg, extra... }</code></li>
<li>TÃ­ch há»£p OpenTelemetry Ä‘á»ƒ Ä‘Ã­nh kÃ¨m <code>trace_id</code>, <code>span_id</code> theo chuáº©n OTEL.</li>
<li>
<p>Log Ä‘Æ°á»£c gá»­i vá»:</p>
</li>
<li>
<p>Dev: <code>stdout</code> â†’ Loki/Grafana</p>
</li>
<li>Prod: GCP Logging hoáº·c OpenObserve</li>
</ul>
<table>
<thead>
<tr>
<th>Level</th>
<th>Má»¥c Ä‘Ã­ch</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>INFO</code></td>
<td>Thao tÃ¡c thÃ´ng thÆ°á»ng</td>
</tr>
<tr>
<td><code>WARN</code></td>
<td>Thao tÃ¡c sai, khÃ´ng lÃ m crash</td>
</tr>
<tr>
<td><code>ERROR</code></td>
<td>Exception, database lá»—i, sá»± cá»‘ nghiÃªm trá»ng</td>
</tr>
<tr>
<td><code>DEBUG</code></td>
<td>Gá»¡ lá»—i (chá»‰ báº­t khi local/dev)</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="102-metrics">ğŸ“ˆ 10.2. Metrics<a class="headerlink" href="#102-metrics" title="Permanent link">Â¶</a></h3>
<ul>
<li>Sá»­ dá»¥ng <code>Prometheus</code> exporter thÃ´ng qua <code>dx-core.metrics</code>.</li>
<li>Má»™t sá»‘ metrics quan trá»ng:</li>
</ul>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Loáº¡i</th>
<th>NhÃ£n</th>
<th>Ghi chÃº</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>http_requests_total</code></td>
<td>Counter</td>
<td>path, method, status</td>
<td>Tá»•ng sá»‘ request</td>
</tr>
<tr>
<td><code>http_request_duration_seconds</code></td>
<td>Histogram</td>
<td>path, method</td>
<td>Äá»™ trá»…</td>
</tr>
<tr>
<td><code>user_create_success_total</code></td>
<td>Counter</td>
<td>tenant_id</td>
<td>Táº¡o user thÃ nh cÃ´ng</td>
</tr>
<tr>
<td><code>user_lookup_by_email_miss_total</code></td>
<td>Counter</td>
<td>â€“</td>
<td>KhÃ´ng tÃ¬m tháº¥y user theo email</td>
</tr>
<tr>
<td><code>db_query_duration_seconds</code></td>
<td>Histogram</td>
<td>model, operation</td>
<td>Theo dÃµi hiá»‡u nÄƒng DB</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="103-audit-logging">ğŸ” 10.3. Audit Logging<a class="headerlink" href="#103-audit-logging" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ <a href="../../../../ADR/adr-008-audit-logging/">ADR-008</a>:</p>
<ul>
<li>
<p>Emit cÃ¡c sá»± kiá»‡n audit dáº¡ng Pub/Sub:</p>
</li>
<li>
<p><code>user.created</code></p>
</li>
<li><code>user.updated</code></li>
<li><code>user.duplicated</code></li>
<li>Má»—i event bao gá»“m: <code>actor_id</code>, <code>target_user_id</code>, <code>tenant_id</code>, <code>action</code>, <code>changes</code></li>
<li>
<p>ÄÆ°á»£c forward sang <code>audit-logging-service</code> Ä‘á»ƒ lÆ°u DB riÃªng (GCP BigQuery hoáº·c PostgreSQL phÃ¢n vÃ¹ng)</p>
</li>
<li>
<p>Táº¥t cáº£ cÃ¡c thao tÃ¡c thay Ä‘á»•i dá»¯ liá»‡u liÃªn quan Ä‘áº¿n ngÆ°á»i dÃ¹ng vÃ  tenant Ä‘á»u Ä‘Æ°á»£c ghi láº¡i thÃ´ng qua Audit Logging Service, bao gá»“m:</p>
<ul>
<li><code>user.created</code>, <code>user.updated</code>, <code>user.deleted</code></li>
<li><code>user_tenant_assignment.created</code></li>
<li><code>tenant.created</code>, <code>tenant.status_changed</code></li>
<li><code>role_template.updated</code>, <code>permission_template.updated</code></li>
</ul>
</li>
<li>
<p>Log bao gá»“m:</p>
<ul>
<li><code>actor_id</code>, <code>tenant_id</code>, <code>action</code>, <code>target_table</code>, <code>before</code>, <code>after</code>, <code>timestamp</code></li>
<li>Request <code>X-Request-ID</code> Ä‘á»ƒ truy váº¿t qua toÃ n há»‡ thá»‘ng</li>
</ul>
</li>
</ul>
<hr/>
<h3 id="104-cost-observability-billing">ğŸ’° 10.4. Cost Observability (Billing)<a class="headerlink" href="#104-cost-observability-billing" title="Permanent link">Â¶</a></h3>
<p>Ãp dá»¥ng <a href="../../../../ADR/adr-020-cost-observability/">ADR-020</a>:</p>
<ul>
<li>Tá»± Ä‘á»™ng emit sá»± kiá»‡n <code>usage.user.query</code> vÃ  <code>usage.user.create</code></li>
<li>Há»— trá»£ billing theo sá»‘ láº§n truy cáº­p dá»¯ liá»‡u <code>global user</code> cá»§a má»—i tenant</li>
<li>CÃ¡c service khÃ¡c (nhÆ° SIS, CRM) cÃ³ thá»ƒ tÃ­ch há»£p cÃ¡c sá»± kiá»‡n nÃ y Ä‘á»ƒ Æ°á»›c lÆ°á»£ng chi phÃ­</li>
</ul>
<hr/>
<h3 id="105-health-check-alert">ğŸ§ª 10.5. Health Check &amp; Alert<a class="headerlink" href="#105-health-check-alert" title="Permanent link">Â¶</a></h3>
<ul>
<li>Endpoint: <code>GET /healthz</code> (cÃ³ thá»ƒ bá»• sung <code>/readyz</code>)</li>
<li>
<p>TÃ­ch há»£p:</p>
</li>
<li>
<p>Argo Rollout â†’ kiá»ƒm tra trÆ°á»›c khi scale</p>
</li>
<li>GCP Cloud Monitoring â†’ alert theo latency vÃ  error rate</li>
</ul>
<hr/>
<h2 id="11-o-tin-cay-phuc-hoi">11. ğŸš€ Äá»™ tin cáº­y &amp; Phá»¥c há»“i<a class="headerlink" href="#11-o-tin-cay-phuc-hoi" title="Permanent link">Â¶</a></h2>
<p><code>user-service/master</code> Ä‘Ã³ng vai trÃ² then chá»‘t trong há»‡ thá»‘ng Ä‘á»‹nh danh toÃ n cá»¥c, do Ä‘Ã³ Ä‘Æ°á»£c thiáº¿t káº¿ vá»›i má»¥c tiÃªu <strong>kháº£ dá»¥ng cao (HA)</strong>, Ä‘áº£m báº£o <strong>khÃ´ng máº¥t dá»¯ liá»‡u</strong> vÃ  <strong>khÃ´ng giÃ¡n Ä‘oáº¡n khi cáº­p nháº­t</strong>.</p>
<hr/>
<h3 id="111-trien-khai-khong-gian-oan-zero-downtime">ğŸ§± 11.1. Triá»ƒn khai khÃ´ng giÃ¡n Ä‘oáº¡n (Zero Downtime)<a class="headerlink" href="#111-trien-khai-khong-gian-oan-zero-downtime" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ <a href="../../../../ADR/adr-014-zero-downtime/">ADR-014: Zero Downtime</a>:</p>
<ul>
<li>Sá»­ dá»¥ng chiáº¿n lÆ°á»£c rollout <code>blue-green</code> hoáº·c <code>canary</code> qua Argo Rollouts.</li>
<li>Endpoint <code>GET /healthz</code> + probe readiness kiá»ƒm tra DB + Redis + Pub/Sub.</li>
<li>Thá»±c hiá»‡n shadow traffic test trÆ°á»›c khi 100% chuyá»ƒn route.</li>
</ul>
<hr/>
<h3 id="112-chinh-sach-trien-khai">âš™ï¸ 11.2. ChÃ­nh sÃ¡ch triá»ƒn khai<a class="headerlink" href="#112-chinh-sach-trien-khai" title="Permanent link">Â¶</a></h3>
<p>Theo <a href="../../../../ADR/adr-015-deployment-strategy/">ADR-015: Deployment Strategy</a> vÃ  <a href="../../../../ADR/adr-018-release-approval-policy/">ADR-018: Release Approval</a>:</p>
<ul>
<li>
<p>Má»i release Ä‘á»u yÃªu cáº§u:</p>
</li>
<li>
<p>Pass CI (<code>unit</code>, <code>contract</code>, <code>integration</code>)</p>
</li>
<li>ÄÆ°á»£c duyá»‡t bá»Ÿi reviewer ká»¹ thuáº­t</li>
<li>Gáº¯n tag version (<code>v2.x.x</code>)</li>
<li>Tá»± Ä‘á»™ng deploy náº¿u PR merge vÃ o <code>main</code> vÃ  cÃ³ tag.</li>
</ul>
<hr/>
<h3 id="113-auto-scaling">â™»ï¸ 11.3. Auto Scaling<a class="headerlink" href="#113-auto-scaling" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ <a href="../../../../ADR/adr-016-auto-scaling/">ADR-016: Auto Scaling</a>:</p>
<ul>
<li>
<p>Sá»­ dá»¥ng HPA (Horizontal Pod Autoscaler) theo:</p>
</li>
<li>
<p>CPU: â‰¥ 70%</p>
</li>
<li>Request QPS: â‰¥ 500 req/s</li>
<li>Giá»›i háº¡n min 2 replica, max 10 (cÃ³ thá»ƒ override theo tenant load)</li>
</ul>
<hr/>
<h3 id="114-du-phong-du-lieu-recovery">ğŸ’¾ 11.4. Dá»± phÃ²ng dá»¯ liá»‡u &amp; recovery<a class="headerlink" href="#114-du-phong-du-lieu-recovery" title="Permanent link">Â¶</a></h3>
<ul>
<li>ToÃ n bá»™ dá»¯ liá»‡u lÆ°u táº¡i PostgreSQL phÃ¢n vÃ¹ng theo tenant_id.</li>
<li>Backup qua Cloud SQL export Ä‘á»‹nh ká»³ (6 giá»/láº§n).</li>
<li>Má»—i thay Ä‘á»•i ngÆ°á»i dÃ¹ng Ä‘á»u phÃ¡t <code>user.updated</code> â†’ cÃ³ thá»ƒ sync vÃ o há»‡ thá»‘ng phá»¥ nhÆ° CRM/LMS/SIS Ä‘á»ƒ Ä‘áº£m báº£o redundancy.</li>
</ul>
<hr/>
<h3 id="115-retry-timeouts">âš¡ 11.5. Retry &amp; Timeouts<a class="headerlink" href="#115-retry-timeouts" title="Permanent link">Â¶</a></h3>
<ul>
<li>Giao tiáº¿p ná»™i bá»™ giá»¯a services cÃ³ timeout 3s + retry 2 láº§n (exponential backoff).</li>
<li>
<p>Náº¿u <code>user.master</code> khÃ´ng pháº£n há»“i:</p>
</li>
<li>
<p>Gateway tráº£ lá»—i <code>503</code> vá»›i mÃ£ <code>user.service_unavailable</code></p>
</li>
<li>Ghi log + emit alert</li>
</ul>
<hr/>
<h3 id="116-rollback-observability">ğŸ”„ 11.6. Rollback &amp; Observability<a class="headerlink" href="#116-rollback-observability" title="Permanent link">Â¶</a></h3>
<ul>
<li>Náº¿u rollout lá»—i (readiness probe fail &gt; 20s), tá»± Ä‘á»™ng rollback vá» version trÆ°á»›c.</li>
<li>TÃ­ch há»£p OpenTelemetry Ä‘á»ƒ debug lá»—i multi-hop: tá»« gateway â†’ auth â†’ user.</li>
</ul>
<hr/>
<h2 id="12-hieu-nang-kha-nang-mo-rong">12. âš¡ï¸ Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng<a class="headerlink" href="#12-hieu-nang-kha-nang-mo-rong" title="Permanent link">Â¶</a></h2>
<p><code>user-service/master</code> Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ phá»¥c vá»¥ truy váº¥n user toÃ n cá»¥c Ä‘a tenant, vá»›i kháº£ nÄƒng scale linh hoáº¡t vÃ  Ä‘Ã¡p á»©ng hÃ ng triá»‡u báº£n ghi. Má»i thÃ nh pháº§n tá»« lÆ°u trá»¯, cache Ä‘áº¿n API Ä‘á»u Ä‘Æ°á»£c tá»‘i Æ°u Ä‘á»ƒ Ä‘áº£m báº£o throughput cao, latency tháº¥p vÃ  há»— trá»£ má»Ÿ rá»™ng theo chiá»u ngang.</p>
<hr/>
<h3 id="121-truy-van-toi-uu-indexing">âš¡ 12.1. Truy váº¥n tá»‘i Æ°u &amp; indexing<a class="headerlink" href="#121-truy-van-toi-uu-indexing" title="Permanent link">Â¶</a></h3>
<ul>
<li>
<p>CÃ¡c API thÆ°á»ng xuyÃªn sá»­ dá»¥ng nhÆ°:</p>
</li>
<li>
<p><code>GET /users-global/by-email</code></p>
</li>
<li><code>GET /users-global/by-phone</code></li>
<li><code>GET /users-global/{id}</code>
    Ä‘á»u Ä‘Æ°á»£c tá»‘i Æ°u thÃ´ng qua <strong>index phá»©c há»£p</strong> (<code>email, tenant_id</code>, <code>phone_number, tenant_id</code>).</li>
<li>CÆ¡ cháº¿ filter sá»­ dá»¥ng <code>tenant_id</code> nhÆ° Ä‘iá»u kiá»‡n báº¯t buá»™c Ä‘á»ƒ Ä‘áº£m báº£o query nhanh vÃ  cÃ¡ch ly dá»¯ liá»‡u.</li>
</ul>
<hr/>
<h3 id="122-caching-thong-minh">ğŸ§  12.2. Caching thÃ´ng minh<a class="headerlink" href="#122-caching-thong-minh" title="Permanent link">Â¶</a></h3>
<ul>
<li>Redis layer Ä‘á»ƒ cache cÃ¡c báº£n ghi ngÆ°á»i dÃ¹ng phá»• biáº¿n (dá»±a vÃ o LRU hoáº·c Top-K queries).</li>
<li>TTL máº·c Ä‘á»‹nh: 15 phÃºt. CÃ³ cÆ¡ cháº¿ invalidate khi cÃ³ <code>user.updated</code>.</li>
<li>
<p>Dá»¯ liá»‡u cache:</p>
</li>
<li>
<p><code>user_id â†’ profile</code></p>
</li>
<li><code>email/phone â†’ user_id</code></li>
<li>CÆ¡ cháº¿ warming cache khi khá»Ÿi Ä‘á»™ng Ä‘á»ƒ tÄƒng cold-start performance.</li>
</ul>
<hr/>
<h3 id="123-ho-tro-phan-trang-lon-deep-pagination">ğŸš€ 12.3. Há»— trá»£ phÃ¢n trang lá»›n (deep pagination)<a class="headerlink" href="#123-ho-tro-phan-trang-lon-deep-pagination" title="Permanent link">Â¶</a></h3>
<ul>
<li>DÃ¹ng cÆ¡ cháº¿ <strong>seek-based pagination</strong> (trang theo <code>created_at</code> hoáº·c <code>user_id</code>) Ä‘á»ƒ trÃ¡nh hiá»‡u nÄƒng kÃ©m khi offset lá»›n.</li>
<li>Default limit: 20. Max limit: 1000.</li>
<li>CÃ³ há»— trá»£ cáº£ offset pagination cho use-case quáº£n trá»‹ viÃªn.</li>
</ul>
<hr/>
<h3 id="124-horizontal-scaling">âš™ï¸ 12.4. Horizontal Scaling<a class="headerlink" href="#124-horizontal-scaling" title="Permanent link">Â¶</a></h3>
<ul>
<li>Service stateless â†’ cÃ³ thá»ƒ scale theo replica (tuÃ¢n thá»§ <a href="../../../../ADR/adr-016-auto-scaling/">ADR-016</a>)</li>
<li>
<p>Redis + PostgreSQL cÃ³ thá»ƒ tÃ¡ch cá»¥m theo workload:</p>
</li>
<li>
<p>Redis: scale theo sá»‘ lÆ°á»£ng hot user</p>
</li>
<li>Postgres: cÃ³ thá»ƒ sharding theo <code>tenant_id</code> náº¿u vÆ°á»£t quÃ¡ ngÆ°á»¡ng</li>
</ul>
<hr/>
<h3 id="125-theo-doi-hieu-nang">ğŸ“‰ 12.5. Theo dÃµi hiá»‡u nÄƒng<a class="headerlink" href="#125-theo-doi-hieu-nang" title="Permanent link">Â¶</a></h3>
<ul>
<li>
<p>Metrics Prometheus:</p>
</li>
<li>
<p><code>http_request_duration_seconds</code></p>
</li>
<li><code>user.lookup_latency_p95</code></li>
<li><code>db_user_query_duration_seconds</code></li>
<li>
<p>Cáº£nh bÃ¡o náº¿u:</p>
</li>
<li>
<p><code>P95 &gt; 200ms</code> trong 5 phÃºt</p>
</li>
<li><code>cache_miss_rate &gt; 30%</code> trong 10 phÃºt</li>
</ul>
<hr/>
<h3 id="126-benchmark-load-test">ğŸ§ª 12.6. Benchmark &amp; Load test<a class="headerlink" href="#126-benchmark-load-test" title="Permanent link">Â¶</a></h3>
<ul>
<li>
<p>DÃ¹ng <code>k6</code> Ä‘á»ƒ test vá»›i 1 triá»‡u user, 1000 req/s trong 10 phÃºt:</p>
</li>
<li>
<p><code>P95 &lt; 150ms</code>, <code>success_rate &gt; 99.9%</code></p>
</li>
<li>
<p>Test profile:</p>
</li>
<li>
<p>90% <code>GET</code></p>
</li>
<li>8% <code>POST</code></li>
<li>2% <code>PATCH</code></li>
</ul>
<hr/>
<h2 id="13-kien-truc-service">13. ğŸ§© Kiáº¿n trÃºc Service<a class="headerlink" href="#13-kien-truc-service" title="Permanent link">Â¶</a></h2>
<p><code>user-service/master</code> lÃ  má»™t thÃ nh pháº§n <strong>core multi-tenant</strong>, chá»‹u trÃ¡ch nhiá»‡m quáº£n lÃ½ danh tÃ­nh toÃ n cá»¥c cho ngÆ°á»i dÃ¹ng trÃªn toÃ n há»‡ thá»‘ng VAS, bao gá»“m: ID Ä‘á»‹nh danh, tÃ i khoáº£n gá»‘c, vÃ  thÃ´ng tin liÃªn káº¿t giá»¯a ngÆ°á»i dÃ¹ng vá»›i cÃ¡c tenant. Service nÃ y hoáº¡t Ä‘á»™ng Ä‘á»™c láº­p vá»›i cÃ¡c sub-service tenant-specific, vÃ  lÃ  nguá»“n dá»¯ liá»‡u gá»‘c phá»¥c vá»¥ <code>auth-service/master</code>, <code>token-service</code> vÃ  há»‡ thá»‘ng SMS má»›i tÃ­ch há»£p.</p>
<hr/>
<h3 id="131-so-o-kien-truc-cap-nhat-tuan-cr-04">ğŸ§­ 13.1. SÆ¡ Ä‘á»“ kiáº¿n trÃºc cáº­p nháº­t (tuÃ¢n CR-04)<a class="headerlink" href="#131-so-o-kien-truc-cap-nhat-tuan-cr-04" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>flowchart TD
  subgraph Core Services
    GATEWAY[API Gateway]
    AUTH_MASTER[Auth Service - Master]
    USER_MASTER[User Service - Master]
    TOKEN[Token Service]
    AUDIT[Audit Logging Service]
  end

  subgraph Data Layer
    PG_GLOBAL[(PostgreSQL - Global)]
    REDIS[(Redis)]
  end

  subgraph Tenant System
    SMS[(School Management System)]
  end

  GATEWAY --&gt;|JWT + RBAC + X-Tenant-ID| AUTH_MASTER
  GATEWAY --&gt;|RBAC + Route| USER_MASTER

  AUTH_MASTER --&gt;|Lookup user| USER_MASTER
  USER_MASTER --&gt;|Read/write| PG_GLOBAL
  USER_MASTER --&gt;|Cache email/user_id| REDIS
  USER_MASTER --&gt;|Emit user.created/updated| PUBSUB[(Pub/Sub)]
  USER_MASTER --&gt; AUDIT

  PUBSUB --&gt; SMS
</code></pre>
<hr/>
<h3 id="132-thanh-phan-chinh">ğŸ§© 13.2. ThÃ nh pháº§n chÃ­nh<a class="headerlink" href="#132-thanh-phan-chinh" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>ThÃ nh pháº§n</th>
<th>Vai trÃ²</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>FastAPI</code></td>
<td>Framework triá»ƒn khai HTTP API</td>
</tr>
<tr>
<td><code>PostgreSQL</code> (global)</td>
<td>LÆ°u trá»¯ chÃ­nh thÃ´ng tin ngÆ°á»i dÃ¹ng toÃ n cá»¥c</td>
</tr>
<tr>
<td><code>Redis</code></td>
<td>TÄƒng tá»‘c truy xuáº¥t <code>email â†’ user_id</code>, <code>user_id â†’ profile</code></td>
</tr>
<tr>
<td><code>Pub/Sub</code></td>
<td>PhÃ¡t sá»± kiá»‡n cho cÃ¡c há»‡ thá»‘ng downstream nhÆ° <code>SMS</code></td>
</tr>
<tr>
<td><code>Audit Logging</code></td>
<td>Ghi nháº­n thay Ä‘á»•i user phá»¥c vá»¥ kiá»ƒm tra vÃ  compliance</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="133-cau-truc-thu-muc">âš™ï¸ 13.3. Cáº¥u trÃºc thÆ° má»¥c<a class="headerlink" href="#133-cau-truc-thu-muc" title="Permanent link">Â¶</a></h3>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>user-service/
</span><span id="__span-6-2"><a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>â”œâ”€â”€<span class="w"> </span>main.py<span class="w">                  </span><span class="c1"># Entry point chÃ­nh</span>
</span><span id="__span-6-3"><a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>â”œâ”€â”€<span class="w"> </span>api/<span class="w">                     </span><span class="c1"># Router FastAPI</span>
</span><span id="__span-6-4"><a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>â”‚<span class="w">   </span>â”œâ”€â”€<span class="w"> </span>global_users.py<span class="w">      </span><span class="c1"># Äá»‹nh nghÄ©a endpoint /users-global/*</span>
</span><span id="__span-6-5"><a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>â”œâ”€â”€<span class="w"> </span>models/<span class="w">                  </span><span class="c1"># ORM models</span>
</span><span id="__span-6-6"><a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>â”œâ”€â”€<span class="w"> </span>schemas/<span class="w">                 </span><span class="c1"># Request/response schemas</span>
</span><span id="__span-6-7"><a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>â”œâ”€â”€<span class="w"> </span>services/<span class="w">                </span><span class="c1"># Business logic: user creation, update, conflict detection</span>
</span><span id="__span-6-8"><a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a>â”œâ”€â”€<span class="w"> </span>events/<span class="w">                  </span><span class="c1"># Emit Pub/Sub events</span>
</span><span id="__span-6-9"><a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a>â”œâ”€â”€<span class="w"> </span>core/<span class="w">                    </span><span class="c1"># Cáº¥u hÃ¬nh, middleware, utils</span>
</span><span id="__span-6-10"><a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a>â””â”€â”€<span class="w"> </span>tests/<span class="w">                   </span><span class="c1"># Kiá»ƒm thá»­ unit &amp; integration</span>
</span></code></pre></div>
<hr/>
<h3 id="134-giao-tiep-tich-hop">ğŸ”„ 13.4. Giao tiáº¿p &amp; tÃ­ch há»£p<a class="headerlink" href="#134-giao-tiep-tich-hop" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Dá»‹ch vá»¥</th>
<th>Má»¥c Ä‘Ã­ch</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth-service/master</code></td>
<td>XÃ¡c thá»±c ngÆ°á»i dÃ¹ng, gá»i <code>GET /users-global/by-email</code></td>
</tr>
<tr>
<td><code>token-service</code></td>
<td>Cung cáº¥p JWT token vá»›i <code>user_id</code> toÃ n cá»¥c</td>
</tr>
<tr>
<td><code>API Gateway</code></td>
<td>Ãp dá»¥ng RBAC &amp; inject cÃ¡c header (<code>X-User-ID</code>, <code>X-Permissions</code>, <code>X-Tenant-ID</code>)</td>
</tr>
<tr>
<td><code>SMS (Tenant)</code></td>
<td>TiÃªu thá»¥ sá»± kiá»‡n <code>user.created</code>, <code>user.updated</code> Ä‘á»ƒ sync user profile</td>
</tr>
<tr>
<td><code>audit-logging-service</code></td>
<td>Nháº­n log tá»« má»i hÃ nh Ä‘á»™ng cáº­p nháº­t, táº¡o user</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="135-cac-su-kien-phat-ra">ğŸ“£ 13.5. CÃ¡c sá»± kiá»‡n phÃ¡t ra<a class="headerlink" href="#135-cac-su-kien-phat-ra" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n chuáº©n Ä‘á»‹nh danh sá»± kiá»‡n tá»« [ADR-030: Event Schema Governance]:</p>
<table>
<thead>
<tr>
<th>Sá»± kiá»‡n</th>
<th>Khi nÃ o phÃ¡t</th>
<th>Payload</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user.created</code></td>
<td>Khi táº¡o user má»›i toÃ n cá»¥c</td>
<td><code>{ user_id, email, created_by, timestamp }</code></td>
</tr>
<tr>
<td><code>user.updated</code></td>
<td>Khi cáº­p nháº­t thÃ´ng tin ngÆ°á»i dÃ¹ng</td>
<td><code>{ user_id, fields_changed, updated_by }</code></td>
</tr>
<tr>
<td><code>user.duplicated</code></td>
<td>Khi phÃ¡t hiá»‡n trÃ¹ng thÃ´ng tin Ä‘á»‹nh danh</td>
<td><code>{ conflict_user_ids, resolution_strategy }</code></td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="14-tai-lieu-lien-quan">14. TÃ i liá»‡u liÃªn quan<a class="headerlink" href="#14-tai-lieu-lien-quan" title="Permanent link">Â¶</a></h2>
<table>
<thead>
<tr>
<th>TÃªn tÃ i liá»‡u</th>
<th>MÃ´ táº£ ngáº¯n gá»n</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="../../../../architecture/rbac-deep-dive/">rbac-deep-dive.md</a></td>
<td>MÃ´ táº£ chi tiáº¿t kiáº¿n trÃºc RBAC, cÃ¡c báº£ng liÃªn quan vÃ  sÆ¡ Ä‘á»“ quyá»n</td>
</tr>
<tr>
<td><a href="../../../../ADR/adr-007-rbac/">adr-007-rbac.md</a></td>
<td>Quyáº¿t Ä‘á»‹nh thiáº¿t káº¿ kiáº¿n trÃºc RBAC phÃ¢n táº§ng theo mÃ´ hÃ¬nh Master-Sub</td>
</tr>
<tr>
<td><a href="../../../../ADR/adr-006-auth-strategy/">adr-006-auth-strategy.md</a></td>
<td>MÃ´ táº£ chiáº¿n lÆ°á»£c xÃ¡c thá»±c, JWT vÃ  vai trÃ² cá»§a User Service Master/Sub</td>
</tr>
<tr>
<td><a href="../data-model/">Data Model</a></td>
<td>Chi tiáº¿t cÃ¡c báº£ng CSDL Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi User Service Master</td>
</tr>
<tr>
<td><a href="../interface-contract/">Interface Contract</a></td>
<td>Há»£p Ä‘á»“ng API Ä‘á»‹nh nghÄ©a rÃµ input/output, auth, mÃ£ lá»—i cá»§a cÃ¡c endpoint</td>
</tr>
<tr>
<td><a href="../openapi.yaml">OpenAPI</a></td>
<td>File Ä‘áº·c táº£ OpenAPI ká»¹ thuáº­t dÃ¹ng Ä‘á»ƒ táº¡o SDK/Client/Docs tá»± Ä‘á»™ng</td>
</tr>
<tr>
<td><a href="../../../../architecture/system-diagrams/">system-diagrams.md</a></td>
<td>SÆ¡ Ä‘á»“ kiáº¿n trÃºc tá»•ng thá»ƒ há»‡ thá»‘ng, cÃ¡c service vÃ  dÃ²ng tÆ°Æ¡ng tÃ¡c</td>
</tr>
<tr>
<td><a href="../../../../">README.md</a></td>
<td>TÃ i liá»‡u kiáº¿n trÃºc tá»•ng quan, má»¥c tiÃªu tá»•ng thá»ƒ vÃ  cÃ¡c nguyÃªn lÃ½ thiáº¿t káº¿</td>
</tr>
</tbody>
</table>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Trá»Ÿ láº¡i má»¥c lá»¥c
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>