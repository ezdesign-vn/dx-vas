
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="TÃ i liá»‡u kiáº¿n trÃºc vÃ  phÃ¡t triá»ƒn cho dá»± Ã¡n Chuyá»ƒn Ä‘á»•i sá»‘ TrÆ°á»ng Viá»‡t Anh." name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://ezdesign-vn.github.io/dx-vas/services/auth-service/sub/design/" rel="canonical"/>
<link href="../../../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Thiáº¿t káº¿ chi tiáº¿t Auth Service - Sub - DX VAS - Docs</title>
<link href="../../../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#thiet-ke-chi-tiet-auth-service-sub">
          Bá» qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Äáº§u trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Thiáº¿t káº¿ chi tiáº¿t Auth Service - Sub
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="TÃ¬m kiáº¿m" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="TÃ¬m kiáº¿m" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="TÃ¬m kiáº¿m" class="md-search__options">
<button aria-label="XoÃ¡" class="md-search__icon md-icon" tabindex="-1" title="XoÃ¡" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../architecture/system-diagrams/">
          
  
  
    
  
  Kiáº¿n trÃºc Há»‡ thá»‘ng

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../dev-guide/">
        
  
  
    
  
  HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../">
        
  
  
    
  
  Thiáº¿t káº¿ Services

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../ADR/">
          
  
  
    
  
  Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh Ä‘iá»u hÆ°á»›ng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Kiáº¿n trÃºc Há»‡ thá»‘ng
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Kiáº¿n trÃºc Há»‡ thá»‘ng
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../architecture/system-diagrams/">
<span class="md-ellipsis">
    SÆ¡ Ä‘á»“ Há»‡ thá»‘ng
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../architecture/rbac-deep-dive/">
<span class="md-ellipsis">
    RBAC Chi tiáº¿t
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../dev-guide/">
<span class="md-ellipsis">
    HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../">
<span class="md-ellipsis">
    Thiáº¿t káº¿ Services
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../../ADR/">
<span class="md-ellipsis">
    Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Má»¥c lá»¥c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Má»¥c lá»¥c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-pham-vi-va-trach-nhiem">
<span class="md-ellipsis">
      1. ğŸ§­ Pháº¡m vi vÃ  TrÃ¡ch nhiá»‡m
    </span>
</a>
<nav aria-label="1. ğŸ§­ Pháº¡m vi vÃ  TrÃ¡ch nhiá»‡m" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#chuc-nang-chinh">
<span class="md-ellipsis">
      âœ… Chá»©c nÄƒng chÃ­nh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#khong-thuoc-pham-vi">
<span class="md-ellipsis">
      ğŸš« KhÃ´ng thuá»™c pháº¡m vi
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vai-tro-trong-kien-truc-tong-the">
<span class="md-ellipsis">
      ğŸ§© Vai trÃ² trong kiáº¿n trÃºc tá»•ng thá»ƒ
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tom-tat-vai-tro">
<span class="md-ellipsis">
      ğŸ§ª TÃ³m táº¯t vai trÃ²
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-thiet-ke-api-chi-tiet-interface-contract">
<span class="md-ellipsis">
      2. ğŸŒ Thiáº¿t káº¿ API chi tiáº¿t (Interface Contract)
    </span>
</a>
<nav aria-label="2. ğŸŒ Thiáº¿t káº¿ API chi tiáº¿t (Interface Contract)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#danh-sach-endpoint-chinh">
<span class="md-ellipsis">
      ğŸ” Danh sÃ¡ch endpoint chÃ­nh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cau-truc-requestresponse">
<span class="md-ellipsis">
      ğŸ“¦ Cáº¥u trÃºc request/response
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#truyen-thong-tin-session-session_metadata">
<span class="md-ellipsis">
      ğŸ§  Truyá»n thÃ´ng tin session (session_metadata)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luu-y-trien-khai">
<span class="md-ellipsis">
      ğŸ“Œ LÆ°u Ã½ triá»ƒn khai
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-mo-hinh-du-lieu-chi-tiet">
<span class="md-ellipsis">
      3. ğŸ—ƒï¸ MÃ´ hÃ¬nh dá»¯ liá»‡u chi tiáº¿t
    </span>
</a>
<nav aria-label="3. ğŸ—ƒï¸ MÃ´ hÃ¬nh dá»¯ liá»‡u chi tiáº¿t" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#bang-auth_sessions-postgresql">
<span class="md-ellipsis">
      ğŸ” Báº£ng auth_sessions (PostgreSQL)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cache-revoked_tokens-redis">
<span class="md-ellipsis">
      ğŸ§Š Cache revoked_tokens (Redis)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#event-log-pubsub">
<span class="md-ellipsis">
      ğŸ”„ Event Log (Pub/Sub)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ghi-chu">
<span class="md-ellipsis">
      âœ¨ Ghi chÃº
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-luong-xu-ly-nghiep-vu-chinh">
<span class="md-ellipsis">
      4. ğŸ”„ Luá»“ng xá»­ lÃ½ nghiá»‡p vá»¥ chÃ­nh
    </span>
</a>
<nav aria-label="4. ğŸ”„ Luá»“ng xá»­ lÃ½ nghiá»‡p vá»¥ chÃ­nh" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#luong-1-ang-nhap-bang-otp">
<span class="md-ellipsis">
      ğŸ” Luá»“ng 1: ÄÄƒng nháº­p báº±ng OTP
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luong-2-ang-nhap-local-usernamepassword">
<span class="md-ellipsis">
      ğŸ‘¤ Luá»“ng 2: ÄÄƒng nháº­p Local (username/password)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luong-3-logout-thu-hoi-phien">
<span class="md-ellipsis">
      ğŸ” Luá»“ng 3: Logout (Thu há»“i phiÃªn)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luong-4-ong-bo-user">
<span class="md-ellipsis">
      ğŸ”„ Luá»“ng 4: Äá»“ng bá»™ user
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mo-hinh-phan-tang">
<span class="md-ellipsis">
      âœ… MÃ´ hÃ¬nh phÃ¢n táº§ng
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-tuong-tac-voi-cac-service-khac-luong-su-kien">
<span class="md-ellipsis">
      5. ğŸ“£ TÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c Service khÃ¡c &amp; Luá»“ng sá»± kiá»‡n
    </span>
</a>
<nav aria-label="5. ğŸ“£ TÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c Service khÃ¡c &amp; Luá»“ng sá»± kiá»‡n" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#giao-tiep-noi-bo-internal-api-calls">
<span class="md-ellipsis">
      ğŸ”— Giao tiáº¿p ná»™i bá»™ (Internal API Calls)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luong-su-kien-bat-ong-bo-pubsub">
<span class="md-ellipsis">
      ğŸ“£ Luá»“ng sá»± kiá»‡n báº¥t Ä‘á»“ng bá»™ (Pub/Sub)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#nguyen-tac-thiet-ke-tich-hop">
<span class="md-ellipsis">
      ğŸ¯ NguyÃªn táº¯c thiáº¿t káº¿ tÃ­ch há»£p
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-bao-mat-phan-quyen">
<span class="md-ellipsis">
      6. ğŸ” Báº£o máº­t &amp; PhÃ¢n quyá»n
    </span>
</a>
<nav aria-label="6. ğŸ” Báº£o máº­t &amp; PhÃ¢n quyá»n" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#co-che-bao-mat-chinh">
<span class="md-ellipsis">
      ğŸ” CÆ¡ cháº¿ báº£o máº­t chÃ­nh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phan-quyen-va-rbac-ap-dung-gian-tiep">
<span class="md-ellipsis">
      ğŸ” PhÃ¢n quyá»n vÃ  RBAC (Ã¡p dá»¥ng giÃ¡n tiáº¿p)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#token-session-lifecycle">
<span class="md-ellipsis">
      ğŸ”’ Token &amp; session lifecycle
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chinh-sach-bao-ve-api">
<span class="md-ellipsis">
      ğŸ§¯ ChÃ­nh sÃ¡ch báº£o vá»‡ API
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-cau-hinh-phu-thuoc">
<span class="md-ellipsis">
      7. âš™ï¸ Cáº¥u hÃ¬nh &amp; Phá»¥ thuá»™c
    </span>
</a>
<nav aria-label="7. âš™ï¸ Cáº¥u hÃ¬nh &amp; Phá»¥ thuá»™c" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cau-hinh-moi-truong-env">
<span class="md-ellipsis">
      ğŸ”§ Cáº¥u hÃ¬nh mÃ´i trÆ°á»ng (ENV)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#secrets-bat-buoc">
<span class="md-ellipsis">
      ğŸ” Secrets báº¯t buá»™c
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phu-thuoc-vao-cac-dich-vu-khac">
<span class="md-ellipsis">
      ğŸ§© Phá»¥ thuá»™c vÃ o cÃ¡c dá»‹ch vá»¥ khÃ¡c
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tach-biet-cau-hinh-theo-tenant">
<span class="md-ellipsis">
      ğŸ—‚ TÃ¡ch biá»‡t cáº¥u hÃ¬nh theo tenant
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cac-rang-buoc">
<span class="md-ellipsis">
      âš ï¸ CÃ¡c rÃ ng buá»™c
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-chien-luoc-kiem-thu">
<span class="md-ellipsis">
      8. ğŸ§ª Chiáº¿n lÆ°á»£c kiá»ƒm thá»­
    </span>
</a>
<nav aria-label="8. ğŸ§ª Chiáº¿n lÆ°á»£c kiá»ƒm thá»­" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-unit-tests">
<span class="md-ellipsis">
      ğŸ”¬ 8.1. Unit Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-contract-tests">
<span class="md-ellipsis">
      ğŸ”— 8.2. Contract Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-integration-tests">
<span class="md-ellipsis">
      ğŸ§ª 8.3. Integration Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#84-e2e-tests-qua-api-gateway">
<span class="md-ellipsis">
      ğŸŒ 8.4. E2E Tests (qua API Gateway)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#85-coverage-cicd">
<span class="md-ellipsis">
      ğŸ“ˆ 8.5. Coverage &amp; CI/CD
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tong-hop-muc-tieu-kiem-thu">
<span class="md-ellipsis">
      ğŸ§© Tá»•ng há»£p má»¥c tiÃªu kiá»ƒm thá»­
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-quan-sat-giam-sat">
<span class="md-ellipsis">
      9. ğŸ“ˆ Quan sÃ¡t &amp; GiÃ¡m sÃ¡t
    </span>
</a>
<nav aria-label="9. ğŸ“ˆ Quan sÃ¡t &amp; GiÃ¡m sÃ¡t" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#91-logging-structured-log">
<span class="md-ellipsis">
      ğŸªµ 9.1. Logging (Structured Log)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#92-metrics-prometheus">
<span class="md-ellipsis">
      ğŸ“Š 9.2. Metrics (Prometheus)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#93-tracing-distributed-trace">
<span class="md-ellipsis">
      ğŸ” 9.3. Tracing (Distributed Trace)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#94-audit-logging">
<span class="md-ellipsis">
      ğŸ“š 9.4. Audit Logging
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#95-observability-by-tenant">
<span class="md-ellipsis">
      ğŸ§ª 9.5. Observability by tenant
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-o-tin-cay-phuc-hoi">
<span class="md-ellipsis">
      10. ğŸš€ Äá»™ tin cáº­y &amp; Phá»¥c há»“i
    </span>
</a>
<nav aria-label="10. ğŸš€ Äá»™ tin cáº­y &amp; Phá»¥c há»“i" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#101-stateless-va-scale-ngang">
<span class="md-ellipsis">
      ğŸ§± 10.1. Stateless vÃ  Scale ngang
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#102-retry-idempotency">
<span class="md-ellipsis">
      â™»ï¸ 10.2. Retry &amp; Idempotency
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#103-gioi-han-loi-co-lap-tenant">
<span class="md-ellipsis">
      ğŸ’¥ 10.3. Giá»›i háº¡n lá»—i &amp; cÃ´ láº­p tenant
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#104-circuit-breaker-timeout">
<span class="md-ellipsis">
      ğŸ›  10.4. Circuit Breaker &amp; Timeout
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#105-slaslo">
<span class="md-ellipsis">
      â± 10.5. SLA/SLO
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#106-rollback-zero-downtime">
<span class="md-ellipsis">
      ğŸš¨ 10.6. Rollback &amp; Zero Downtime
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#107-recovery-tu-loi-nghiem-trong">
<span class="md-ellipsis">
      ğŸ§¯ 10.7. Recovery tá»« lá»—i nghiÃªm trá»ng
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-hieu-nang-kha-nang-mo-rong">
<span class="md-ellipsis">
      11. âš¡ï¸ Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng
    </span>
</a>
<nav aria-label="11. âš¡ï¸ Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#kien-truc-hieu-nang-cao">
<span class="md-ellipsis">
      âš™ï¸ Kiáº¿n trÃºc hiá»‡u nÄƒng cao
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kha-nang-mo-rong-theo-tenant">
<span class="md-ellipsis">
      ğŸš€ Kháº£ nÄƒng má»Ÿ rá»™ng theo tenant
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cac-chi-so-theo-doi-hieu-nang">
<span class="md-ellipsis">
      ğŸ“ˆ CÃ¡c chá»‰ sá»‘ theo dÃµi hiá»‡u nÄƒng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#gioi-han-va-bao-ve">
<span class="md-ellipsis">
      â›“ Giá»›i háº¡n vÃ  báº£o vá»‡
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#benchmark-e-xuat">
<span class="md-ellipsis">
      ğŸ§ª Benchmark Ä‘á» xuáº¥t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inh-huong-toi-uu-tiep-theo">
<span class="md-ellipsis">
      ğŸ§© Äá»‹nh hÆ°á»›ng tá»‘i Æ°u tiáº¿p theo
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-ke-hoach-trien-khai-migration">
<span class="md-ellipsis">
      12. ğŸ›  Káº¿ hoáº¡ch Triá»ƒn khai &amp; Migration
    </span>
</a>
<nav aria-label="12. ğŸ›  Káº¿ hoáº¡ch Triá»ƒn khai &amp; Migration" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#chien-luoc-trien-khai">
<span class="md-ellipsis">
      ğŸš€ Chiáº¿n lÆ°á»£c triá»ƒn khai
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chinh-sach-versioning-theo-tenant">
<span class="md-ellipsis">
      ğŸ§© ChÃ­nh sÃ¡ch versioning theo tenant
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ke-hoach-migration-schema">
<span class="md-ellipsis">
      ğŸ” Káº¿ hoáº¡ch migration schema
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phuc-hoi-neu-deployment-loi">
<span class="md-ellipsis">
      â›‘ Phá»¥c há»“i náº¿u deployment lá»—i
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#checklist-trien-khai-tenant-moi">
<span class="md-ellipsis">
      ğŸ“‹ Checklist triá»ƒn khai tenant má»›i
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mo-phong-deploy-mass-multi-tenant">
<span class="md-ellipsis">
      ğŸ§ª MÃ´ phá»ng deploy mass multi-tenant
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#13-kien-truc-service">
<span class="md-ellipsis">
      13. ğŸ§© Kiáº¿n trÃºc Service
    </span>
</a>
<nav aria-label="13. ğŸ§© Kiáº¿n trÃºc Service" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#kien-truc-noi-tai-internal-architecture">
<span class="md-ellipsis">
      ğŸ— Kiáº¿n trÃºc ná»™i táº¡i (Internal Architecture)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kien-truc-trien-khai-deployment-architecture">
<span class="md-ellipsis">
      ğŸ§± Kiáº¿n trÃºc triá»ƒn khai (Deployment Architecture)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#quy-tac-thiet-ke">
<span class="md-ellipsis">
      ğŸ§  Quy táº¯c thiáº¿t káº¿
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#thu-muc-ma-nguon-goi-y">
<span class="md-ellipsis">
      ğŸ“¦ ThÆ° má»¥c mÃ£ nguá»“n (gá»£i Ã½)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#14-tai-lieu-lien-quan">
<span class="md-ellipsis">
      14. ğŸ“š TÃ i liá»‡u liÃªn quan
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="thiet-ke-chi-tiet-auth-service-sub">ğŸ“˜ Thiáº¿t káº¿ chi tiáº¿t Auth Service - Sub<a class="headerlink" href="#thiet-ke-chi-tiet-auth-service-sub" title="Permanent link">Â¶</a></h1>
<h2 id="1-pham-vi-va-trach-nhiem">1. ğŸ§­ Pháº¡m vi vÃ  TrÃ¡ch nhiá»‡m<a class="headerlink" href="#1-pham-vi-va-trach-nhiem" title="Permanent link">Â¶</a></h2>
<p><code>auth-service/sub</code> lÃ  dá»‹ch vá»¥ xÃ¡c thá»±c Ä‘Æ°á»£c thiáº¿t káº¿ theo mÃ´ hÃ¬nh <strong>per-tenant deployment</strong>, phá»¥c vá»¥ riÃªng biá»‡t cho tá»«ng tenant (trÆ°á»ng há»c) trong há»‡ thá»‘ng <code>dx-vas</code>. Má»—i tenant cÃ³ má»™t instance riÃªng, Ä‘á»™c láº­p vá» cÆ¡ sá»Ÿ dá»¯ liá»‡u, cáº¥u hÃ¬nh, vÃ  lifecycle váº­n hÃ nh.</p>
<p>Dá»‹ch vá»¥ nÃ y Ä‘áº£m nhiá»‡m xÃ¡c thá»±c Ä‘áº§u vÃ o cho ngÆ°á»i dÃ¹ng cuá»‘i (student, teacher, employee) thuá»™c tenant tÆ°Æ¡ng á»©ng, thÃ´ng qua cÃ¡c phÆ°Æ¡ng thá»©c <strong>OTP</strong> vÃ  <strong>Local Login</strong>.</p>
<hr/>
<h3 id="chuc-nang-chinh">âœ… Chá»©c nÄƒng chÃ­nh<a class="headerlink" href="#chuc-nang-chinh" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>NhÃ³m chá»©c nÄƒng</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>XÃ¡c thá»±c OTP</strong></td>
<td>Gá»­i vÃ  xÃ¡c minh mÃ£ OTP qua SMS/email</td>
</tr>
<tr>
<td><strong>XÃ¡c thá»±c Local</strong></td>
<td>ÄÄƒng nháº­p báº±ng username/password Ä‘Ã£ mÃ£ hÃ³a</td>
</tr>
<tr>
<td><strong>Khá»Ÿi táº¡o phiÃªn</strong></td>
<td>Gá»i <code>token-service</code> Ä‘á»ƒ cáº¥p JWT; lÆ°u <code>auth_sessions</code></td>
</tr>
<tr>
<td><strong>Logout</strong></td>
<td>Gá»i <code>token-service</code> thu há»“i token; cáº­p nháº­t Redis</td>
</tr>
<tr>
<td><strong>Äá»“ng bá»™ user</strong></td>
<td>Náº¿u user chÆ°a tá»“n táº¡i sau xÃ¡c thá»±c, gá»­i yÃªu cáº§u sync Ä‘áº¿n <code>user-service</code></td>
</tr>
<tr>
<td><strong>Audit log</strong></td>
<td>Gá»­i log hÃ nh vi xÃ¡c thá»±c (success/failure) Ä‘áº¿n <code>audit-logging-service</code></td>
</tr>
<tr>
<td><strong>PhÃ¡t sá»± kiá»‡n</strong></td>
<td>Gá»­i sá»± kiá»‡n <code>auth.token.issued</code>, <code>auth.token.revoked</code>, <code>auth.login.failed</code>, <code>user.sync.triggered</code> lÃªn Pub/Sub</td>
</tr>
<tr>
<td><strong>Gáº¯n session metadata</strong></td>
<td>TrÃ­ch xuáº¥t IP, thiáº¿t bá»‹, user-agent Ä‘á»ƒ phá»¥c vá»¥ báº£o máº­t vÃ  giÃ¡m sÃ¡t</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="khong-thuoc-pham-vi">ğŸš« KhÃ´ng thuá»™c pháº¡m vi<a class="headerlink" href="#khong-thuoc-pham-vi" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Má»¥c</th>
<th>Ghi chÃº</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>XÃ¡c thá»±c Google OAuth2</strong></td>
<td>Thá»±c hiá»‡n táº¡i <code>auth-service/master</code> theo <code>adr-006-auth-strategy.md</code></td>
</tr>
<tr>
<td><strong>Quáº£n lÃ½ ngÆ°á»i dÃ¹ng</strong></td>
<td>ÄÆ°á»£c xá»­ lÃ½ bá»Ÿi <code>user-service</code></td>
</tr>
<tr>
<td><strong>Cáº¥p phÃ¡t token trá»±c tiáº¿p</strong></td>
<td>Chuyá»ƒn giao cho <code>token-service</code> Ä‘á»ƒ quáº£n lÃ½ táº­p trung</td>
</tr>
<tr>
<td><strong>RBAC &amp; PhÃ¢n quyá»n</strong></td>
<td>Kiá»ƒm tra táº¡i <code>api-gateway</code>, khÃ´ng thá»±c hiá»‡n trong <code>auth-service/sub</code></td>
</tr>
<tr>
<td><strong>Xá»­ lÃ½ liÃªn-tenant</strong></td>
<td>KhÃ´ng há»— trá»£ login chÃ©o tenant; má»—i instance chá»‰ phá»¥c vá»¥ má»™t tenant duy nháº¥t</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="vai-tro-trong-kien-truc-tong-the">ğŸ§© Vai trÃ² trong kiáº¿n trÃºc tá»•ng thá»ƒ<a class="headerlink" href="#vai-tro-trong-kien-truc-tong-the" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>flowchart TD
    FE[Frontend]
    GW[API Gateway]
    AS[Auth Service Sub]
    TS[Token Service]
    US[User Service]
    AUD[Audit Logging]

    FE --&gt; GW
    GW --&gt; AS
    AS --&gt; TS
    AS --&gt; US
    AS --&gt; AUD
</code></pre>
<ul>
<li><code>api-gateway</code> Ä‘á»‹nh tuyáº¿n request login Ä‘áº¿n <code>auth-service/sub</code> dá»±a trÃªn header <code>X-Tenant-ID</code></li>
<li><code>auth-service/sub</code> xÃ¡c thá»±c thÃ´ng tin, gá»i <code>token-service</code>, gá»­i sá»± kiá»‡n audit, Ä‘á»“ng bá»™ user náº¿u cáº§n</li>
<li>Má»i token, permission, RBAC Ä‘á»u Ä‘Æ°á»£c quáº£n lÃ½ bÃªn ngoÃ i <code>auth-service/sub</code>, Ä‘áº£m báº£o service giá»¯ vai trÃ² <strong>nháº¹, táº­p trung, cÃ³ thá»ƒ scale Ä‘á»™c láº­p</strong></li>
</ul>
<hr/>
<h3 id="tom-tat-vai-tro">ğŸ§ª TÃ³m táº¯t vai trÃ²<a class="headerlink" href="#tom-tat-vai-tro" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>KhÃ­a cáº¡nh</th>
<th>TrÃ¡ch nhiá»‡m</th>
</tr>
</thead>
<tbody>
<tr>
<td>Authentication</td>
<td>âœ… OTP + Local</td>
</tr>
<tr>
<td>Authorization</td>
<td>âŒ (thá»±c hiá»‡n táº¡i gateway)</td>
</tr>
<tr>
<td>Token lifecycle</td>
<td>ğŸ” Gá»i <code>token-service</code></td>
</tr>
<tr>
<td>Session tracking</td>
<td>âœ… LÆ°u <code>auth_sessions</code></td>
</tr>
<tr>
<td>Logging &amp; audit</td>
<td>âœ… Gá»­i log chi tiáº¿t</td>
</tr>
<tr>
<td>Tenant isolation</td>
<td>âœ… Má»—i instance Ä‘á»™c láº­p theo tenant</td>
</tr>
<tr>
<td>Observability</td>
<td>âœ… Gáº¯n <code>trace_id</code>, <code>session_metadata</code> Ä‘áº§y Ä‘á»§</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ğŸ’¡ <code>auth-service/sub</code> khÃ´ng xá»­ lÃ½ xÃ¡c thá»±c liÃªn tenant (nhÆ° admin login tá»« há»‡ thá»‘ng khÃ¡c); cÃ¡c luá»“ng Ä‘Ã³ Ä‘Æ°á»£c Ä‘á»‹nh tuyáº¿n Ä‘áº¿n <code>auth-service/master</code>.</p>
</blockquote>
<hr/>
<h2 id="2-thiet-ke-api-chi-tiet-interface-contract">2. ğŸŒ Thiáº¿t káº¿ API chi tiáº¿t (Interface Contract)<a class="headerlink" href="#2-thiet-ke-api-chi-tiet-interface-contract" title="Permanent link">Â¶</a></h2>
<p><code>Auth Service (Sub)</code> cung cáº¥p cÃ¡c API xÃ¡c thá»±c OTP vÃ  Local login, Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a rÃµ rÃ ng trong <code>interface-contract.md</code>. CÃ¡c API tuÃ¢n thá»§ chuáº©n thiáº¿t káº¿ chung toÃ n há»‡ thá»‘ng:</p>
<ul>
<li>Cáº¥u trÃºc response theo <code>SuccessEnvelope</code> / <code>ErrorEnvelope</code> (ADR-012, ADR-011)</li>
<li>CÃ³ trÆ°á»ng <code>meta</code> Ä‘i kÃ¨m má»i response</li>
<li>ÄÆ°á»£c báº£o vá»‡ báº±ng RBAC vÃ  Ä‘iá»u kiá»‡n Ä‘á»™ng <code>x-condition</code> (ADR-007)</li>
<li>Truy váº¿t theo <code>X-Trace-ID</code>, audit qua <code>audit-logging-service</code></li>
</ul>
<hr/>
<h3 id="danh-sach-endpoint-chinh">ğŸ” Danh sÃ¡ch endpoint chÃ­nh<a class="headerlink" href="#danh-sach-endpoint-chinh" title="Permanent link">Â¶</a></h3>
<p>Auth Service - Sub cung cáº¥p 4 endpoint chÃ­nh phá»¥c vá»¥ xÃ¡c thá»±c ngÆ°á»i dÃ¹ng vÃ  quáº£n lÃ½ phiÃªn Ä‘Äƒng nháº­p. Thiáº¿t káº¿ tuÃ¢n thá»§ chuáº©n OpenAPI vÃ  thá»‘ng nháº¥t vá»›i cÃ¡c tÃ i liá»‡u interface-contract vÃ  mÃ´ hÃ¬nh dá»¯ liá»‡u.</p>
<table>
<thead>
<tr>
<th>API Endpoint</th>
<th>PhÆ°Æ¡ng thá»©c</th>
<th>MÃ´ táº£</th>
<th>PhÃ¢n quyá»n</th>
<th>Ghi chÃº</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>POST /auth/login</code></td>
<td><code>POST</code></td>
<td>XÃ¡c thá»±c ngÆ°á»i dÃ¹ng qua OTP hoáº·c tÃ i khoáº£n ná»™i bá»™</td>
<td><code>auth.login</code></td>
<td>Gá»™p chung xá»­ lÃ½ login OTP vÃ  Local</td>
</tr>
<tr>
<td><code>POST /auth/logout</code></td>
<td><code>POST</code></td>
<td>Thu há»“i token hiá»‡n táº¡i (self logout)</td>
<td><code>auth.logout</code></td>
<td>Thu há»“i session vÃ  Ä‘Ã¡nh dáº¥u token revoked</td>
</tr>
<tr>
<td><code>GET /auth/sessions</code></td>
<td><code>GET</code></td>
<td>Liá»‡t kÃª cÃ¡c phiÃªn Ä‘Äƒng nháº­p</td>
<td><code>session.read:any</code></td>
<td>Há»— trá»£ lá»c theo <code>user_id</code>, <code>status</code>, phÃ¢n trang</td>
</tr>
<tr>
<td><code>POST /auth/sessions/{id}/revoke</code></td>
<td><code>POST</code></td>
<td>Thu há»“i má»™t phiÃªn Ä‘Äƒng nháº­p cá»¥ thá»ƒ</td>
<td><code>session.revoke:any</code></td>
<td>DÃ nh cho admin thu há»“i session báº¥t ká»³</td>
</tr>
</tbody>
</table>
<p>ğŸ“Œ LÆ°u Ã½:</p>
<ul>
<li>API <code>/auth/login</code> sá»­ dá»¥ng <code>oneOf</code> Ä‘á»ƒ phÃ¢n biá»‡t giá»¯a OTP vÃ  Local login thÃ´ng qua <code>login_type</code>, khÃ´ng tÃ¡ch thÃ nh cÃ¡c route riÃªng nhÆ° <code>/auth/otp/request</code> hay <code>/auth/local</code>.</li>
<li>Táº¥t cáº£ cÃ¡c API Ä‘á»u sá»­ dá»¥ng <code>X-Tenant-ID</code> trong <code>x-condition</code> Ä‘á»ƒ Ä‘áº£m báº£o phÃ¢n vÃ¹ng tenant.</li>
<li>Header <code>Authorization: Bearer &lt;token&gt;</code> Ã¡p dá»¥ng cho cÃ¡c API báº£o vá»‡, trá»« <code>POST /auth/login</code>.</li>
</ul>
<hr/>
<h3 id="cau-truc-requestresponse">ğŸ“¦ Cáº¥u trÃºc request/response<a class="headerlink" href="#cau-truc-requestresponse" title="Permanent link">Â¶</a></h3>
<h4 id="request-schema">âœ… Request Schema<a class="headerlink" href="#request-schema" title="Permanent link">Â¶</a></h4>
<ul>
<li>
<p><code>LoginRequest</code>: <code>oneOf</code> 2 loáº¡i:</p>
</li>
<li>
<p><code>LoginRequestOTP</code>: <code>{ login_type: otp, phone_number, otp_code }</code></p>
</li>
<li><code>LoginRequestLocal</code>: <code>{ login_type: local, username, password (writeOnly) }</code></li>
<li><code>LogoutRequest</code>: <code>{ reason: string }</code> (tuá»³ chá»n)</li>
</ul>
<h4 id="response-schema">âœ… Response Schema<a class="headerlink" href="#response-schema" title="Permanent link">Â¶</a></h4>
<ul>
<li><code>TokenEnvelope</code>: <code>{ access_token, refresh_token, expires_in, session_id, token_type }</code></li>
<li><code>SessionOut</code>: <code>{ session_id, user_id, auth_method, created_at, revoked_at, device_type, ip_address, location, user_agent, status }</code></li>
<li><code>PaginatedSessions</code>: <code>{ meta: ResponseMeta, data: [SessionOut] }</code></li>
<li><code>ErrorEnvelope</code>: <code>{ error: { code, message, data }, meta: ResponseMeta }</code></li>
<li><code>ResponseMeta</code>: <code>{ request_id, timestamp, pagination? }</code></li>
</ul>
<h4 id="ma-loi-chuan">ğŸ¯ MÃ£ lá»—i chuáº©n<a class="headerlink" href="#ma-loi-chuan" title="Permanent link">Â¶</a></h4>
<table>
<thead>
<tr>
<th>HTTP</th>
<th>MÃ£ lá»—i</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td>400</td>
<td><code>auth.invalid_payload</code></td>
<td>Payload khÃ´ng há»£p lá»‡</td>
</tr>
<tr>
<td>401</td>
<td><code>auth.invalid_credentials</code></td>
<td>Sai OTP hoáº·c máº­t kháº©u</td>
</tr>
<tr>
<td>403</td>
<td><code>auth.forbidden</code></td>
<td>KhÃ´ng Ä‘á»§ quyá»n</td>
</tr>
<tr>
<td>404</td>
<td><code>session.not_found</code></td>
<td>KhÃ´ng tÃ¬m tháº¥y session</td>
</tr>
<tr>
<td>200</td>
<td>â€“</td>
<td>Response dáº¡ng <code>TokenEnvelope</code>, <code>SuccessBoolean</code>, <code>PaginatedSessions</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>ğŸ“Œ Táº¥t cáº£ schema vÃ  mÃ£ lá»—i Ä‘á»u tuÃ¢n thá»§ Ä‘á»‹nh nghÄ©a trong <code>components/schemas</code> vÃ  <code>components/responses</code> cá»§a <code>openapi.yaml</code>, Ä‘á»“ng thá»i thá»‘ng nháº¥t vá»›i <code>data-model.md</code>.</p>
</blockquote>
<hr/>
<h3 id="truyen-thong-tin-session-session_metadata">ğŸ§  Truyá»n thÃ´ng tin session (<code>session_metadata</code>)<a class="headerlink" href="#truyen-thong-tin-session-session_metadata" title="Permanent link">Â¶</a></h3>
<p>Má»—i láº§n xÃ¡c thá»±c thÃ nh cÃ´ng, dá»‹ch vá»¥ sáº½ thu tháº­p metadata liÃªn quan Ä‘áº¿n phiÃªn Ä‘Äƒng nháº­p vÃ  gá»­i kÃ¨m trong yÃªu cáº§u Ä‘áº¿n <code>token-service</code>:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p">{</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc123"</span><span class="p">,</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">"login_method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"otp"</span><span class="p">,</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">"session_metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="nt">"ip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192.168.1.1"</span><span class="p">,</span>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="nt">"user_agent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mozilla/5.0"</span><span class="p">,</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="nt">"device"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Android; Pixel 6"</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>ThÃ´ng tin nÃ y sáº½ Ä‘Æ°á»£c ghi láº¡i táº¡i báº£ng <code>auth_sessions</code> vÃ  hiá»ƒn thá»‹ trong há»‡ thá»‘ng quáº£n trá»‹.</p>
<hr/>
<h3 id="luu-y-trien-khai">ğŸ“Œ LÆ°u Ã½ triá»ƒn khai<a class="headerlink" href="#luu-y-trien-khai" title="Permanent link">Â¶</a></h3>
<ul>
<li>Táº¥t cáº£ API Ä‘á»u Ä‘á»‹nh danh tenant thÃ´ng qua header <code>X-Tenant-ID</code></li>
<li>RBAC Ä‘Æ°á»£c kiá»ƒm tra bá»Ÿi <code>api-gateway</code>, khÃ´ng pháº£i trong <code>auth-service/sub</code></li>
<li>CÃ¡c API khÃ´ng yÃªu cáº§u xÃ¡c thá»±c Ä‘áº§u vÃ o (vÃ¬ lÃ  entrypoint cá»§a login) nhÆ°ng Ä‘Æ°á»£c kiá»ƒm soÃ¡t qua <code>rate-limit</code>, <code>captcha</code>, <code>otp max-attempt</code></li>
<li>CÃ³ thá»ƒ test API thÃ´ng qua Swagger UI tÃ­ch há»£p ná»™i bá»™ (<code>/docs/</code>)</li>
</ul>
<blockquote>
<p>ğŸ‘‰ Xem chi tiáº¿t: <a href="../interface-contract/">Interface Contract.md</a> â€“ <a href="../openapi.yaml">OpenAPI</a></p>
</blockquote>
<hr/>
<h2 id="3-mo-hinh-du-lieu-chi-tiet">3. ğŸ—ƒï¸ MÃ´ hÃ¬nh dá»¯ liá»‡u chi tiáº¿t<a class="headerlink" href="#3-mo-hinh-du-lieu-chi-tiet" title="Permanent link">Â¶</a></h2>
<p><code>Auth Service (Sub)</code> khÃ´ng lÆ°u trá»¯ thÃ´ng tin ngÆ°á»i dÃ¹ng hay token, nhÆ°ng váº«n duy trÃ¬ má»™t sá»‘ dá»¯ liá»‡u liÃªn quan Ä‘áº¿n phiÃªn Ä‘Äƒng nháº­p vÃ  há»— trá»£ xÃ¡c thá»±c.</p>
<hr/>
<h3 id="bang-auth_sessions-postgresql">ğŸ” Báº£ng <code>auth_sessions</code> (PostgreSQL)<a class="headerlink" href="#bang-auth_sessions-postgresql" title="Permanent link">Â¶</a></h3>
<p>LÆ°u thÃ´ng tin phiÃªn Ä‘Äƒng nháº­p sau má»—i láº§n xÃ¡c thá»±c thÃ nh cÃ´ng.<br/>
Dá»¯ liá»‡u nÃ y phá»¥c vá»¥ má»¥c Ä‘Ã­ch kiá»ƒm toÃ¡n, phÃ¢n tÃ­ch hÃ nh vi vÃ  há»— trá»£ thu há»“i phiÃªn (logout).</p>
<table>
<thead>
<tr>
<th>TrÆ°á»ng</th>
<th>Kiá»ƒu dá»¯ liá»‡u</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>session_id</code></td>
<td><code>uuid</code></td>
<td>Äá»‹nh danh duy nháº¥t cá»§a phiÃªn</td>
</tr>
<tr>
<td><code>user_id</code></td>
<td><code>uuid</code></td>
<td>ID ngÆ°á»i dÃ¹ng Ä‘Ã£ xÃ¡c thá»±c</td>
</tr>
<tr>
<td><code>login_method</code></td>
<td><code>enum('otp', 'local')</code></td>
<td>PhÆ°Æ¡ng thá»©c xÃ¡c thá»±c</td>
</tr>
<tr>
<td><code>session_metadata</code></td>
<td><code>jsonb</code></td>
<td>ThÃ´ng tin metadata nhÆ° IP, user-agent, thiáº¿t bá»‹</td>
</tr>
<tr>
<td><code>created_at</code></td>
<td><code>timestamp</code></td>
<td>Thá»i Ä‘iá»ƒm phiÃªn Ä‘Æ°á»£c táº¡o</td>
</tr>
<tr>
<td><code>revoked_at</code></td>
<td><code>timestamp</code> | <code>null</code></td>
<td>Náº¿u phiÃªn bá»‹ logout hoáº·c thu há»“i</td>
</tr>
<tr>
<td><code>tenant_id</code></td>
<td><code>text</code></td>
<td>Äá»‹nh danh tenant, láº¥y tá»« <code>X-Tenant-ID</code></td>
</tr>
</tbody>
</table>
<p>ğŸ“Œ TrÆ°á»ng <code>session_metadata</code> thÆ°á»ng chá»©a:
<div class="language-json highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nt">"ip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192.168.1.1"</span><span class="p">,</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nt">"user_agent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mozilla/5.0"</span><span class="p">,</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">"device"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Android; Pixel 6"</span><span class="p">,</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nt">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HCMC"</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="p">}</span>
</span></code></pre></div></p>
<hr/>
<h3 id="cache-revoked_tokens-redis">ğŸ§Š Cache <code>revoked_tokens</code> (Redis)<a class="headerlink" href="#cache-revoked_tokens-redis" title="Permanent link">Â¶</a></h3>
<p>Äá»ƒ Ä‘áº£m báº£o hiá»‡u quáº£ khi xÃ¡c thá»±c JWT táº¡i <code>api-gateway</code>, Auth Service Sub há»— trá»£ ghi token bá»‹ thu há»“i vÃ o Redis (dÃ¹ng chung cluster Redis cá»§a há»‡ thá»‘ng).</p>
<ul>
<li><strong>Key format:</strong> <code>revoked:{token_id}</code></li>
<li><strong>TTL:</strong> báº±ng thá»i háº¡n cÃ²n láº¡i cá»§a JWT</li>
<li><strong>GiÃ¡ trá»‹:</strong> JSON gá»“m <code>revoked_at</code>, <code>user_id</code>, <code>reason</code></li>
</ul>
<p>VÃ­ dá»¥:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>revoked:3fa85f64-5717-4562-b3fc-2c963f66afa6
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>â†’
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="o">{</span>
</span><span id="__span-2-4"><a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="s2">"revoked_at"</span>:<span class="w"> </span><span class="s2">"2025-06-13T10:03:00Z"</span>,
</span><span id="__span-2-5"><a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="s2">"user_id"</span>:<span class="w"> </span><span class="s2">"abc123"</span>,
</span><span id="__span-2-6"><a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="s2">"reason"</span>:<span class="w"> </span><span class="s2">"manual_logout"</span>
</span><span id="__span-2-7"><a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="o">}</span>
</span></code></pre></div></p>
<hr/>
<h3 id="event-log-pubsub">ğŸ”„ Event Log (Pub/Sub)<a class="headerlink" href="#event-log-pubsub" title="Permanent link">Â¶</a></h3>
<p>Má»—i sá»± kiá»‡n xÃ¡c thá»±c Ä‘á»u Ä‘Æ°á»£c phÃ¡t Ä‘i theo chuáº©n schema <code>adr-030</code>, phá»¥c vá»¥ há»‡ thá»‘ng <code>audit-log</code> vÃ  cÃ¡c adapter bÃªn ngoÃ i.</p>
<table>
<thead>
<tr>
<th>Sá»± kiá»‡n</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth.token.issued</code></td>
<td>Sau khi xÃ¡c thá»±c thÃ nh cÃ´ng</td>
</tr>
<tr>
<td><code>auth.token.revoked</code></td>
<td>Khi logout hoáº·c thu há»“i</td>
</tr>
<tr>
<td><code>auth.login.failed</code></td>
<td>Tháº¥t báº¡i khi xÃ¡c thá»±c OTP hoáº·c local</td>
</tr>
<tr>
<td><code>user.sync.triggered</code></td>
<td>Khi cáº§n táº¡o má»›i user trong láº§n login Ä‘áº§u tiÃªn</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="ghi-chu">âœ¨ Ghi chÃº<a class="headerlink" href="#ghi-chu" title="Permanent link">Â¶</a></h3>
<ul>
<li>Dá»¯ liá»‡u Ä‘Æ°á»£c partition theo <code>tenant_id</code> Ä‘á»ƒ phá»¥c vá»¥ triá»ƒn khai Ä‘a tenant hiá»‡u quáº£</li>
<li>Chá»‰ lÆ°u session sau khi token Ä‘Æ°á»£c cáº¥p tá»« <code>token-service</code></li>
<li>KhÃ´ng lÆ°u token plaintext â€” chá»‰ lÆ°u metadata vÃ  mapping session</li>
</ul>
<blockquote>
<p>Xem thÃªm cÃ¡c chi tiáº¿t ká»¹ thuáº­t nhÆ° <strong>indexing</strong>, <strong>constraints</strong>, <strong>ENUMs</strong>, <strong>retention policy</strong> vÃ  <strong>chiáº¿n lÆ°á»£c kiá»ƒm thá»­ dá»¯ liá»‡u</strong> táº¡i <a href="../data-model/">Data Model</a></p>
</blockquote>
<hr/>
<h2 id="4-luong-xu-ly-nghiep-vu-chinh">4. ğŸ”„ Luá»“ng xá»­ lÃ½ nghiá»‡p vá»¥ chÃ­nh<a class="headerlink" href="#4-luong-xu-ly-nghiep-vu-chinh" title="Permanent link">Â¶</a></h2>
<p>DÆ°á»›i Ä‘Ã¢y lÃ  mÃ´ táº£ chi tiáº¿t cÃ¡c luá»“ng xá»­ lÃ½ chÃ­nh cá»§a <code>auth-service/sub</code>, bao gá»“m: Ä‘Äƒng nháº­p báº±ng OTP, Ä‘Äƒng nháº­p Local, logout vÃ  Ä‘á»“ng bá»™ ngÆ°á»i dÃ¹ng. Táº¥t cáº£ Ä‘á»u diá»…n ra trong ngá»¯ cáº£nh cá»§a tá»«ng tenant (per-tenant).</p>
<hr/>
<h3 id="luong-1-ang-nhap-bang-otp">ğŸ” Luá»“ng 1: ÄÄƒng nháº­p báº±ng OTP<a class="headerlink" href="#luong-1-ang-nhap-bang-otp" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant FE as Frontend
    participant GW as API Gateway
    participant AS as Auth Sub
    participant TS as Token Service
    participant US as User Service
    participant AL as Audit Logging

    FE-&gt;&gt;GW: POST /auth/otp/verify
    GW-&gt;&gt;AS: Forward request + headers
    AS-&gt;&gt;AS: Kiá»ƒm tra mÃ£ OTP há»£p lá»‡
    AS-&gt;&gt;TS: Gá»­i yÃªu cáº§u cáº¥p token + session_metadata
    TS--&gt;&gt;AS: Tráº£ vá» access_token + refresh_token
    AS-&gt;&gt;US: Gá»­i yÃªu cáº§u Ä‘á»“ng bá»™ user (náº¿u chÆ°a cÃ³)
    AS-&gt;&gt;AL: Gá»­i sá»± kiá»‡n `auth.token.issued`
    AS--&gt;&gt;GW: Tráº£ JWT cho FE
</code></pre>
<p>ğŸ“ Ghi chÃº:
- Náº¿u OTP sai â†’ tráº£ lá»—i <code>auth.otp.invalid</code> (namespace <code>auth</code>, theo <code>ErrorEnvelope</code>)
- Náº¿u chÆ°a cÃ³ user â†’ gá»­i yÃªu cáº§u POST <code>user.sync</code> tá»›i <code>user-service</code> (async)
- Session Ä‘Æ°á»£c ghi láº¡i táº¡i báº£ng <code>auth_sessions</code> sau khi nháº­n token</p>
<hr/>
<h3 id="luong-2-ang-nhap-local-usernamepassword">ğŸ‘¤ Luá»“ng 2: ÄÄƒng nháº­p Local (username/password)<a class="headerlink" href="#luong-2-ang-nhap-local-usernamepassword" title="Permanent link">Â¶</a></h3>
<ul>
<li>TÆ°Æ¡ng tá»± luá»“ng OTP, nhÆ°ng thay kiá»ƒm tra OTP báº±ng xÃ¡c thá»±c credential:
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>- Kiá»ƒm tra username/password
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>- Gá»i token-service
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>- Ghi session
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>- Audit log
</span><span id="__span-3-5"><a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>- Äá»“ng bá»™ user náº¿u chÆ°a tá»“n táº¡i
</span></code></pre></div></li>
</ul>
<p>ğŸ“Œ YÃªu cáº§u dÃ¹ng chuáº©n bcrypt cho password hash; khÃ´ng lÆ°u plaintext hoáº·c so sÃ¡nh trá»±c tiáº¿p.</p>
<hr/>
<h3 id="luong-3-logout-thu-hoi-phien">ğŸ” Luá»“ng 3: Logout (Thu há»“i phiÃªn)<a class="headerlink" href="#luong-3-logout-thu-hoi-phien" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant FE
    participant GW
    participant AS
    participant TS
    participant AL

    FE-&gt;&gt;GW: POST /auth/logout (kÃ¨m JWT)
    GW-&gt;&gt;AS: Forward token
    AS-&gt;&gt;TS: Gá»i token-service thu há»“i token
    AS-&gt;&gt;AL: Ghi sá»± kiá»‡n `auth.token.revoked`
    AS--&gt;&gt;GW: Tráº£ success envelope
</code></pre>
<p>Ghi chÃº:
- Token bá»‹ thu há»“i sáº½ Ä‘Æ°á»£c Ä‘áº©y vÃ o Redis (<code>revoked_tokens</code>) vá»›i TTL tÆ°Æ¡ng á»©ng
- Dá»¯ liá»‡u thu há»“i cÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ kiá»ƒm tra chÃ©o á»Ÿ <code>api-gateway</code></p>
<hr/>
<h3 id="luong-4-ong-bo-user">ğŸ”„ Luá»“ng 4: Äá»“ng bá»™ user<a class="headerlink" href="#luong-4-ong-bo-user" title="Permanent link">Â¶</a></h3>
<ul>
<li>Náº¿u token Ä‘Æ°á»£c cáº¥p há»£p lá»‡ nhÆ°ng <code>user_id</code> chÆ°a cÃ³ trong tenant DB, <code>auth-service/sub</code> sáº½:</li>
<li>Gá»­i request Ä‘á»“ng bá»™ async tá»›i <code>user-service</code></li>
<li>Ghi log <code>user.sync.triggered</code></li>
<li>Cho phÃ©p hoÃ n táº¥t phiÃªn xÃ¡c thá»±c, khÃ´ng cháº·n ngÆ°á»i dÃ¹ng</li>
</ul>
<hr/>
<h3 id="mo-hinh-phan-tang">âœ… MÃ´ hÃ¬nh phÃ¢n táº§ng<a class="headerlink" href="#mo-hinh-phan-tang" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Táº§ng</th>
<th>Vai trÃ²</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>api-gateway</code></td>
<td>Kiá»ƒm tra JWT + RBAC, forward request Ä‘áº¿n <code>auth-service/sub</code></td>
</tr>
<tr>
<td><code>auth-service/sub</code></td>
<td>Kiá»ƒm tra thÃ´ng tin xÃ¡c thá»±c &amp; xá»­ lÃ½ login/logout</td>
</tr>
<tr>
<td><code>token-service</code></td>
<td>Cáº¥p phÃ¡t / thu há»“i JWT</td>
</tr>
<tr>
<td><code>user-service</code></td>
<td>Äá»“ng bá»™ hoáº·c táº¡o user náº¿u chÆ°a tá»“n táº¡i</td>
</tr>
<tr>
<td><code>audit-log</code></td>
<td>Ghi láº¡i táº¥t cáº£ sá»± kiá»‡n xÃ¡c thá»±c</td>
</tr>
</tbody>
</table>
<hr/>
<p>ğŸ‘‰ CÃ¡c luá»“ng nÃ y tuÃ¢n thá»§ nguyÃªn táº¯c <strong>stateless</strong>, cÃ³ thá»ƒ má»Ÿ rá»™ng theo tá»«ng tenant, vÃ  dá»… dÃ ng theo dÃµi qua audit log + trace ID tá»« <code>api-gateway</code>.</p>
<hr/>
<h2 id="5-tuong-tac-voi-cac-service-khac-luong-su-kien">5. ğŸ“£ TÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c Service khÃ¡c &amp; Luá»“ng sá»± kiá»‡n<a class="headerlink" href="#5-tuong-tac-voi-cac-service-khac-luong-su-kien" title="Permanent link">Â¶</a></h2>
<p><code>auth-service/sub</code> khÃ´ng hoáº¡t Ä‘á»™ng Ä‘á»™c láº­p mÃ  tÆ°Æ¡ng tÃ¡c cháº·t cháº½ vá»›i cÃ¡c thÃ nh pháº§n khÃ¡c trong há»‡ thá»‘ng thÃ´ng qua API ná»™i bá»™ vÃ  cÆ¡ cháº¿ sá»± kiá»‡n báº¥t Ä‘á»“ng bá»™ (Pub/Sub). Má»¥c tiÃªu lÃ  Ä‘áº£m báº£o xÃ¡c thá»±c an toÃ n, thá»‘ng nháº¥t token lifecycle, vÃ  ghi nháº­n Ä‘áº§y Ä‘á»§ dáº¥u váº¿t phá»¥c vá»¥ kiá»ƒm toÃ¡n &amp; phÃ¢n tÃ­ch.</p>
<hr/>
<h3 id="giao-tiep-noi-bo-internal-api-calls">ğŸ”— Giao tiáº¿p ná»™i bá»™ (Internal API Calls)<a class="headerlink" href="#giao-tiep-noi-bo-internal-api-calls" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>ÄÃ­ch Ä‘áº¿n</th>
<th>API</th>
<th>Má»¥c Ä‘Ã­ch</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>token-service</code></td>
<td><code>POST /token/issue</code>, <code>POST /token/revoke</code></td>
<td>YÃªu cáº§u cáº¥p vÃ  thu há»“i JWT</td>
</tr>
<tr>
<td><code>user-service</code></td>
<td><code>POST /users/sync</code></td>
<td>Äá»“ng bá»™ user khi xÃ¡c thá»±c láº§n Ä‘áº§u</td>
</tr>
<tr>
<td><code>audit-logging-service</code></td>
<td><code>POST /events/audit</code></td>
<td>Ghi nháº­n sá»± kiá»‡n xÃ¡c thá»±c</td>
</tr>
<tr>
<td><code>notification-service</code></td>
<td><code>POST /otp/send</code></td>
<td>Gá»­i mÃ£ OTP qua SMS/email</td>
</tr>
</tbody>
</table>
<p>ğŸ“Œ Táº¥t cáº£ cÃ¡c call Ä‘á»u cÃ³ gáº¯n <code>X-Tenant-ID</code>, <code>X-Trace-ID</code>, vÃ  truyá»n metadata nhÆ° IP, thiáº¿t bá»‹, phÆ°Æ¡ng thá»©c login.</p>
<hr/>
<h3 id="luong-su-kien-bat-ong-bo-pubsub">ğŸ“£ Luá»“ng sá»± kiá»‡n báº¥t Ä‘á»“ng bá»™ (Pub/Sub)<a class="headerlink" href="#luong-su-kien-bat-ong-bo-pubsub" title="Permanent link">Â¶</a></h3>
<p>Sau má»—i hÃ nh Ä‘á»™ng xÃ¡c thá»±c quan trá»ng, <code>auth-service/sub</code> phÃ¡t sá»± kiá»‡n Ä‘áº¿n há»‡ thá»‘ng Pub/Sub cá»§a tenant tÆ°Æ¡ng á»©ng.</p>
<h4 id="danh-sach-su-kien-phat-hanh">ğŸ”„ Danh sÃ¡ch sá»± kiá»‡n phÃ¡t hÃ nh<a class="headerlink" href="#danh-sach-su-kien-phat-hanh" title="Permanent link">Â¶</a></h4>
<table>
<thead>
<tr>
<th>Sá»± kiá»‡n</th>
<th>Khi nÃ o phÃ¡t?</th>
<th>Payload</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth.token.issued</code></td>
<td>Sau khi xÃ¡c thá»±c thÃ nh cÃ´ng vÃ  nháº­n JWT tá»« token-service</td>
<td>Gá»“m <code>user_id</code>, <code>login_method</code>, <code>session_id</code>, <code>tenant_id</code></td>
</tr>
<tr>
<td><code>auth.token.revoked</code></td>
<td>Khi logout hoáº·c thu há»“i token</td>
<td>Gá»“m <code>token_id</code>, <code>revoked_by</code>, <code>reason</code></td>
</tr>
<tr>
<td><code>auth.login.failed</code></td>
<td>Khi xÃ¡c thá»±c tháº¥t báº¡i do OTP/credential khÃ´ng Ä‘Ãºng</td>
<td>Gá»“m <code>login_method</code>, <code>reason</code>, <code>user_input</code>, <code>ip</code></td>
</tr>
<tr>
<td><code>user.sync.triggered</code></td>
<td>Khi xÃ¡c thá»±c thÃ nh cÃ´ng nhÆ°ng user chÆ°a tá»“n táº¡i</td>
<td>Gá»“m <code>external_user_id</code>, <code>login_method</code>, <code>tenant_id</code></td>
</tr>
</tbody>
</table>
<h4 id="vi-du-payload-authtokenissued">ğŸ“‹ VÃ­ dá»¥ payload <code>auth.token.issued</code><a class="headerlink" href="#vi-du-payload-authtokenissued" title="Permanent link">Â¶</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="p">{</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="nt">"event"</span><span class="p">:</span><span class="w"> </span><span class="s2">"auth.token.issued"</span><span class="p">,</span>
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-13T10:00:00Z"</span><span class="p">,</span>
</span><span id="__span-4-4"><a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"school-abc"</span><span class="p">,</span>
</span><span id="__span-4-5"><a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">  </span><span class="nt">"session_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc123"</span><span class="p">,</span>
</span><span id="__span-4-6"><a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user-001"</span><span class="p">,</span>
</span><span id="__span-4-7"><a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">  </span><span class="nt">"login_method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"otp"</span><span class="p">,</span>
</span><span id="__span-4-8"><a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">  </span><span class="nt">"session_metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-9"><a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="nt">"ip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192.168.1.1"</span><span class="p">,</span>
</span><span id="__span-4-10"><a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="nt">"user_agent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mozilla/5.0"</span><span class="p">,</span>
</span><span id="__span-4-11"><a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="nt">"device"</span><span class="p">:</span><span class="w"> </span><span class="s2">"iPhone 12"</span>
</span><span id="__span-4-12"><a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-4-13"><a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="p">}</span>
</span></code></pre></div>
<hr/>
<h3 id="nguyen-tac-thiet-ke-tich-hop">ğŸ¯ NguyÃªn táº¯c thiáº¿t káº¿ tÃ­ch há»£p<a class="headerlink" href="#nguyen-tac-thiet-ke-tich-hop" title="Permanent link">Â¶</a></h3>
<ul>
<li>Táº¥t cáº£ cÃ¡c sá»± kiá»‡n tuÃ¢n theo schema chuáº©n Ä‘á»‹nh nghÄ©a trong <a href="../ADR/adr-030-event-schema-governance.md"><code>adr-030-event-schema-governance.md</code></a></li>
<li>KhÃ´ng cÃ³ dá»¯ liá»‡u nháº¡y cáº£m (máº­t kháº©u, OTP) Ä‘Æ°á»£c truyá»n trong payload</li>
<li>Má»—i sá»± kiá»‡n Ä‘á»u chá»©a <code>tenant_id</code> vÃ  <code>trace_id</code> Ä‘á»ƒ phá»¥c vá»¥ viá»‡c theo dÃµi chÃ©o há»‡ thá»‘ng</li>
<li>CÃ¡c há»‡ thá»‘ng tiÃªu thá»¥ sá»± kiá»‡n (CRM, LMS, Dashboard) sáº½ dá»±a vÃ o cÃ¡c sá»± kiá»‡n nÃ y Ä‘á»ƒ trigger hÃ nh vi phÃ¹ há»£p (vÃ­ dá»¥: táº¡o há»c sinh má»›i sau login)</li>
</ul>
<hr/>
<p>ğŸ‘‰ Viá»‡c triá»ƒn khai Pub/Sub lÃ  báº¯t buá»™c Ä‘á»ƒ Ä‘áº£m báº£o há»‡ thá»‘ng cÃ³ kháº£ nÄƒng <strong>observability toÃ n diá»‡n</strong>, <strong>scale Ä‘á»™c láº­p</strong> vÃ  dá»… dÃ ng tÃ­ch há»£p vá»›i cÃ¡c module kinh doanh khÃ¡c.</p>
<hr/>
<h2 id="6-bao-mat-phan-quyen">6. ğŸ” Báº£o máº­t &amp; PhÃ¢n quyá»n<a class="headerlink" href="#6-bao-mat-phan-quyen" title="Permanent link">Â¶</a></h2>
<p><code>auth-service/sub</code> lÃ  entrypoint xÃ¡c thá»±c ngÆ°á»i dÃ¹ng cuá»‘i (student, teacher, employee) trong tá»«ng tenant. Máº·c dÃ¹ báº£n thÃ¢n dá»‹ch vá»¥ <strong>khÃ´ng trá»±c tiáº¿p kiá»ƒm tra phÃ¢n quyá»n</strong>, nÃ³ váº«n tuÃ¢n thá»§ nghiÃªm ngáº·t cÃ¡c yÃªu cáº§u báº£o máº­t vÃ  phá»‘i há»£p cháº·t cháº½ vá»›i táº§ng <code>api-gateway</code> Ä‘á»ƒ thá»±c thi RBAC &amp; cÃ¡c chÃ­nh sÃ¡ch báº£o vá»‡ há»‡ thá»‘ng.</p>
<hr/>
<h3 id="co-che-bao-mat-chinh">ğŸ” CÆ¡ cháº¿ báº£o máº­t chÃ­nh<a class="headerlink" href="#co-che-bao-mat-chinh" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Biá»‡n phÃ¡p</th>
<th>Má»¥c tiÃªu</th>
<th>Thá»±c hiá»‡n táº¡i Ä‘Ã¢u?</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>XÃ¡c thá»±c OTP / Local login</strong></td>
<td>Äáº£m báº£o danh tÃ­nh ngÆ°á»i dÃ¹ng</td>
<td><code>auth-service/sub</code></td>
</tr>
<tr>
<td><strong>Gáº¯n trace_id &amp; audit</strong></td>
<td>Theo dÃµi truy váº¿t xÃ¡c thá»±c</td>
<td><code>api-gateway</code>, <code>auth-service/sub</code>, <code>audit-log</code></td>
</tr>
<tr>
<td><strong>PhÃ¢n quyá»n Ä‘á»™ng (RBAC + x-condition)</strong></td>
<td>Cháº·n truy cáº­p trÃ¡i phÃ©p vÃ o tÃ i nguyÃªn</td>
<td><code>api-gateway</code></td>
</tr>
<tr>
<td><strong>JWT Validation</strong></td>
<td>Kiá»ƒm tra token ngÆ°á»i dÃ¹ng</td>
<td><code>api-gateway</code></td>
</tr>
<tr>
<td><strong>Token Revocation</strong></td>
<td>Thu há»“i token khi logout</td>
<td><code>token-service</code> + Redis revoked cache</td>
</tr>
<tr>
<td><strong>Rate limit + OTP throttle</strong></td>
<td>Chá»‘ng brute-force, spam OTP</td>
<td>Gateway + internal OTP limiter</td>
</tr>
<tr>
<td><strong>Header Signature (ná»™i bá»™)</strong></td>
<td>Báº£o vá»‡ API ná»™i bá»™ khá»i giáº£ máº¡o</td>
<td><code>HMAC</code> hoáº·c <code>mTLS</code> tuá»³ mÃ´i trÆ°á»ng</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="phan-quyen-va-rbac-ap-dung-gian-tiep">ğŸ” PhÃ¢n quyá»n vÃ  RBAC (Ã¡p dá»¥ng giÃ¡n tiáº¿p)<a class="headerlink" href="#phan-quyen-va-rbac-ap-dung-gian-tiep" title="Permanent link">Â¶</a></h3>
<p>Máº·c dÃ¹ <code>auth-service/sub</code> khÃ´ng tá»± phÃ¢n quyá»n, nÃ³ cÃ³ trÃ¡ch nhiá»‡m <strong>gáº¯n permission code</strong> vÃ  <code>x-condition</code> phÃ¹ há»£p Ä‘á»ƒ <code>api-gateway</code> kiá»ƒm tra trÆ°á»›c khi gá»i.</p>
<ul>
<li>Má»—i endpoint Ä‘Æ°á»£c annotate bá»Ÿi:</li>
<li><code>x-required-permission</code>: MÃ£ quyá»n logic (vd: <code>auth.otp.verify</code>)</li>
<li><code>x-condition</code>: Äiá»u kiá»‡n Ä‘á»™ng dá»±a trÃªn request (<code>tenant_id</code>, <code>login_method</code>, ...)</li>
</ul>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nt">/auth/otp/verify</span><span class="p">:</span>
</span><span id="__span-5-2"><a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">  </span><span class="nt">post</span><span class="p">:</span>
</span><span id="__span-5-3"><a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">XÃ¡c thá»±c OTP</span>
</span><span id="__span-5-4"><a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="nt">x-required-permission</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">auth.otp.verify</span>
</span><span id="__span-5-5"><a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="nt">x-condition</span><span class="p">:</span>
</span><span id="__span-5-6"><a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">      </span><span class="nt">tenant_id</span><span class="p">:</span><span class="w"> </span><span class="s">"{{X-Tenant-ID}}"</span>
</span><span id="__span-5-7"><a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">      </span><span class="nt">login_method</span><span class="p">:</span><span class="w"> </span><span class="s">"otp"</span>
</span></code></pre></div>
<p>CÃ¡c giÃ¡ trá»‹ <code>x-condition</code> nÃ y sáº½ Ä‘Æ°á»£c <code>api-gateway</code> sá»­ dá»¥ng Ä‘á»ƒ tra báº£ng role-permission trong Redis vÃ  quyáº¿t Ä‘á»‹nh cÃ³ forward hay khÃ´ng.</p>
<hr/>
<h3 id="token-session-lifecycle">ğŸ”’ Token &amp; session lifecycle<a class="headerlink" href="#token-session-lifecycle" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Váº¥n Ä‘á»</th>
<th>CÃ¡ch xá»­ lÃ½</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Token bá»‹ thu há»“i</strong></td>
<td>Ghi vÃ o Redis <code>revoked:{token_id}</code> vÃ  TTL báº±ng thá»i gian cÃ²n láº¡i</td>
</tr>
<tr>
<td><strong>Token Ä‘Æ°á»£c cáº¥p</strong></td>
<td>Gá»­i sá»± kiá»‡n <code>auth.token.issued</code>, lÆ°u session vÃ o <code>auth_sessions</code></td>
</tr>
<tr>
<td><strong>Logout</strong></td>
<td>Gá»i <code>token-service/revoke</code>, phÃ¡t <code>auth.token.revoked</code></td>
</tr>
<tr>
<td><strong>Lá»—i xÃ¡c thá»±c</strong></td>
<td>Ghi sá»± kiá»‡n <code>auth.login.failed</code>, khÃ´ng tráº£ chi tiáº¿t lá»—i ká»¹ thuáº­t Ä‘á»ƒ trÃ¡nh dÃ² thÃ´ng tin</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="chinh-sach-bao-ve-api">ğŸ§¯ ChÃ­nh sÃ¡ch báº£o vá»‡ API<a class="headerlink" href="#chinh-sach-bao-ve-api" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Táº§ng</th>
<th>CÆ¡ cháº¿</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>api-gateway</code></td>
<td>Rate limit theo IP, CAPTCHA (náº¿u cáº§n), kiá»ƒm tra JWT</td>
</tr>
<tr>
<td><code>auth-service/sub</code></td>
<td>Giá»›i háº¡n OTP attempt theo IP/user/device, báº£o vá»‡ replay</td>
</tr>
<tr>
<td><code>Redis</code></td>
<td>TTL cho OTP + revoked token Ä‘á»ƒ giáº£m rÃ² rá»‰ thÃ´ng tin</td>
</tr>
</tbody>
</table>
<hr/>
<p>ğŸ‘‰ Trong mÃ´i trÆ°á»ng production, nÃªn sá»­ dá»¥ng <code>mTLS</code> hoáº·c <code>HMAC signature</code> Ä‘á»ƒ xÃ¡c thá»±c giá»¯a cÃ¡c service ná»™i bá»™ (auth-service/sub â†’ token-service, user-service...).</p>
<p>NgoÃ i ra, cáº§n liÃªn tá»¥c monitor cÃ¡c sá»± kiá»‡n báº¥t thÆ°á»ng nhÆ°:
- OTP gá»­i quÃ¡ má»©c
- login_failed tÄƒng Ä‘á»™t biáº¿n
- user chÆ°a tá»“n táº¡i sau login â†’ dáº¥u hiá»‡u táº¥n cÃ´ng thÄƒm dÃ²</p>
<hr/>
<h2 id="7-cau-hinh-phu-thuoc">7. âš™ï¸ Cáº¥u hÃ¬nh &amp; Phá»¥ thuá»™c<a class="headerlink" href="#7-cau-hinh-phu-thuoc" title="Permanent link">Â¶</a></h2>
<p><code>auth-service/sub</code> Ä‘Æ°á»£c thiáº¿t káº¿ theo mÃ´ hÃ¬nh <strong>per-tenant deployment</strong>, má»—i tenant cháº¡y má»™t instance Ä‘á»™c láº­p vá»›i cáº¥u hÃ¬nh riÃªng biá»‡t, Ä‘áº£m báº£o cÃ´ láº­p dá»¯ liá»‡u, kháº£ nÄƒng tÃ¹y chá»‰nh linh hoáº¡t vÃ  dá»… má»Ÿ rá»™ng. Dá»‹ch vá»¥ hoáº¡t Ä‘á»™ng theo kiáº¿n trÃºc stateless vÃ  phá»¥ thuá»™c vÃ o má»™t sá»‘ dá»‹ch vá»¥ lÃµi trong há»‡ sinh thÃ¡i.</p>
<hr/>
<h3 id="cau-hinh-moi-truong-env">ğŸ”§ Cáº¥u hÃ¬nh mÃ´i trÆ°á»ng (ENV)<a class="headerlink" href="#cau-hinh-moi-truong-env" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Biáº¿n mÃ´i trÆ°á»ng</th>
<th>MÃ´ táº£</th>
<th>VÃ­ dá»¥</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TENANT_ID</code></td>
<td>Äá»‹nh danh tenant tÆ°Æ¡ng á»©ng</td>
<td><code>school-abc</code></td>
</tr>
<tr>
<td><code>OTP_PROVIDER</code></td>
<td>Loáº¡i gá»­i OTP (<code>email</code>, <code>sms</code>)</td>
<td><code>sms</code></td>
</tr>
<tr>
<td><code>OTP_TTL_SECONDS</code></td>
<td>Thá»i gian sá»‘ng cá»§a OTP</td>
<td><code>300</code></td>
</tr>
<tr>
<td><code>REDIS_URL</code></td>
<td>Redis Ä‘á»ƒ lÆ°u revoked token, OTP attempt</td>
<td><code>redis://...</code></td>
</tr>
<tr>
<td><code>TOKEN_SERVICE_URL</code></td>
<td>Endpoint ná»™i bá»™ token-service</td>
<td><code>http://token-service/api/...</code></td>
</tr>
<tr>
<td><code>USER_SERVICE_URL</code></td>
<td>Endpoint Ä‘á»“ng bá»™ user</td>
<td><code>http://user-service/api/...</code></td>
</tr>
<tr>
<td><code>AUDIT_SERVICE_URL</code></td>
<td>Gá»­i log xÃ¡c thá»±c</td>
<td><code>http://audit-log/api/...</code></td>
</tr>
<tr>
<td><code>JWT_ISSUER</code></td>
<td>Issuer dÃ¹ng Ä‘á»ƒ Ä‘á»‘i chiáº¿u vá»›i token-service</td>
<td><code>dx.vas.vn</code></td>
</tr>
<tr>
<td><code>LOG_LEVEL</code></td>
<td>Má»©c Ä‘á»™ log (<code>info</code>, <code>debug</code>, <code>error</code>)</td>
<td><code>info</code></td>
</tr>
</tbody>
</table>
<p>Táº¥t cáº£ biáº¿n mÃ´i trÆ°á»ng pháº£i Ä‘Æ°á»£c quáº£n lÃ½ qua <code>ConfigMap</code> vÃ  <code>Secret</code> (Xem <code>adr-005</code> vÃ  <code>adr-003</code>).</p>
<hr/>
<h3 id="secrets-bat-buoc">ğŸ” Secrets báº¯t buá»™c<a class="headerlink" href="#secrets-bat-buoc" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Secret</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>JWT_SIGNING_SECRET</code></td>
<td>DÃ¹ng Ä‘á»ƒ xÃ¡c minh JWT tráº£ vá» tá»« <code>token-service</code></td>
</tr>
<tr>
<td><code>REDIS_PASSWORD</code></td>
<td>Máº­t kháº©u Redis (náº¿u dÃ¹ng password mode)</td>
</tr>
<tr>
<td><code>OTP_PROVIDER_KEY</code></td>
<td>API key gá»­i OTP náº¿u dÃ¹ng bÃªn thá»© ba</td>
</tr>
</tbody>
</table>
<p>Secrets Ä‘Æ°á»£c mount qua <code>Kubernetes Secret</code> hoáº·c <code>Vault Agent Sidecar</code>, tuyá»‡t Ä‘á»‘i khÃ´ng commit vÃ o mÃ£ nguá»“n.</p>
<hr/>
<h3 id="phu-thuoc-vao-cac-dich-vu-khac">ğŸ§© Phá»¥ thuá»™c vÃ o cÃ¡c dá»‹ch vá»¥ khÃ¡c<a class="headerlink" href="#phu-thuoc-vao-cac-dich-vu-khac" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Dá»‹ch vá»¥</th>
<th>Má»¥c Ä‘Ã­ch</th>
<th>Giao tiáº¿p</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>token-service</code></td>
<td>Cáº¥p vÃ  thu há»“i JWT</td>
<td>HTTP ná»™i bá»™, cÃ³ HMAC kÃ½ header</td>
</tr>
<tr>
<td><code>user-service</code></td>
<td>Äá»“ng bá»™ user</td>
<td>HTTP ná»™i bá»™</td>
</tr>
<tr>
<td><code>notification-service</code></td>
<td>Gá»­i OTP</td>
<td>HTTP ná»™i bá»™</td>
</tr>
<tr>
<td><code>audit-logging-service</code></td>
<td>Ghi log xÃ¡c thá»±c</td>
<td>Pub/Sub hoáº·c HTTP</td>
</tr>
<tr>
<td><code>Redis</code></td>
<td>LÆ°u OTP, revoked token, limiter</td>
<td>Redis cluster riÃªng theo tenant</td>
</tr>
<tr>
<td><code>PostgreSQL</code></td>
<td>LÆ°u báº£ng <code>auth_sessions</code></td>
<td>CÆ¡ sá»Ÿ dá»¯ liá»‡u riÃªng cá»§a tenant</td>
</tr>
</tbody>
</table>
<p>Táº¥t cáº£ service Ä‘á»u dÃ¹ng chung há»‡ thá»‘ng <code>service discovery</code> ná»™i bá»™ thÃ´ng qua tÃªn DNS Kubernetes.</p>
<hr/>
<h3 id="tach-biet-cau-hinh-theo-tenant">ğŸ—‚ TÃ¡ch biá»‡t cáº¥u hÃ¬nh theo tenant<a class="headerlink" href="#tach-biet-cau-hinh-theo-tenant" title="Permanent link">Â¶</a></h3>
<p>Cáº¥u hÃ¬nh cÃ³ thá»ƒ Ä‘Æ°á»£c quáº£n lÃ½ qua cÃ¡c khá»‘i <code>values.yaml</code> riÃªng biá»‡t trong Helm Chart hoáº·c file <code>.env</code> theo folder:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>env/
</span><span id="__span-6-2"><a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>â”œâ”€â”€<span class="w"> </span>school-abc/
</span><span id="__span-6-3"><a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>â”‚<span class="w">   </span>â”œâ”€â”€<span class="w"> </span>.env
</span><span id="__span-6-4"><a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>â”‚<span class="w">   </span>â””â”€â”€<span class="w"> </span>secrets.env
</span><span id="__span-6-5"><a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>â”œâ”€â”€<span class="w"> </span>school-xyz/
</span><span id="__span-6-6"><a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>â”‚<span class="w">   </span>â”œâ”€â”€<span class="w"> </span>.env
</span><span id="__span-6-7"><a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>â”‚<span class="w">   </span>â””â”€â”€<span class="w"> </span>secrets.env
</span></code></pre></div>
<hr/>
<h3 id="cac-rang-buoc">âš ï¸ CÃ¡c rÃ ng buá»™c<a class="headerlink" href="#cac-rang-buoc" title="Permanent link">Â¶</a></h3>
<ul>
<li>KhÃ´ng Ä‘Æ°á»£c hard-code endpoint hoáº·c secret trong mÃ£ nguá»“n</li>
<li>Má»i thÃ´ng tin nháº¡y cáº£m Ä‘á»u cáº§n Ä‘Æ°á»£c quáº£n lÃ½ theo <code>adr-003-secrets.md</code></li>
<li>Náº¿u triá»ƒn khai multi-tenant trÃªn cÃ¹ng 1 instance (khÃ´ng khuyáº¿n khÃ­ch), cáº§n dÃ¹ng <code>X-Tenant-ID</code> Ä‘á»ƒ Ä‘á»‹nh tuyáº¿n vÃ  phÃ¢n vÃ¹ng session â€” tuy nhiÃªn Ä‘iá»u nÃ y lÃ m tÄƒng Ä‘á»™ phá»©c táº¡p báº£o máº­t vÃ  quan sÃ¡t</li>
</ul>
<p>ğŸ‘‰ Äáº£m báº£o má»i cáº¥u hÃ¬nh Ä‘á»u cÃ³ kiá»ƒm tra tÃ­nh há»£p lá»‡ khi service khá»Ÿi Ä‘á»™ng, sá»­ dá»¥ng thÆ° viá»‡n cáº¥u hÃ¬nh chuáº©n (VD: <code>pydantic.BaseSettings</code>, <code>dynaconf</code>, <code>dotenv</code>, v.v.)</p>
<hr/>
<h2 id="8-chien-luoc-kiem-thu">8. ğŸ§ª Chiáº¿n lÆ°á»£c kiá»ƒm thá»­<a class="headerlink" href="#8-chien-luoc-kiem-thu" title="Permanent link">Â¶</a></h2>
<p><code>auth-service/sub</code> Ä‘Ã³ng vai trÃ² cá»‘t lÃµi trong quÃ¡ trÃ¬nh xÃ¡c thá»±c ngÆ°á»i dÃ¹ng Ä‘áº§u vÃ o há»‡ thá»‘ng. Do Ä‘Ã³, cáº§n triá»ƒn khai chiáº¿n lÆ°á»£c kiá»ƒm thá»­ toÃ n diá»‡n tá»« Ä‘Æ¡n vá»‹ (unit) Ä‘áº¿n tÃ­ch há»£p há»‡ thá»‘ng (E2E), bao gá»“m cáº£ kiá»ƒm thá»­ há»£p Ä‘á»“ng vá»›i cÃ¡c service liÃªn káº¿t nhÆ° <code>token-service</code>, <code>user-service</code>, <code>notification-service</code>.</p>
<hr/>
<h3 id="81-unit-tests">ğŸ”¬ 8.1. Unit Tests<a class="headerlink" href="#81-unit-tests" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Pháº¡m vi</th>
<th>MÃ´ táº£</th>
<th>CÃ´ng cá»¥</th>
</tr>
</thead>
<tbody>
<tr>
<td>OTP validation</td>
<td>Kiá»ƒm tra logic OTP há»£p lá»‡ / háº¿t háº¡n / sai mÃ£ / vÆ°á»£t giá»›i háº¡n</td>
<td><code>pytest</code></td>
</tr>
<tr>
<td>Local login</td>
<td>Kiá»ƒm tra hash password, xÃ¡c thá»±c thÃ nh cÃ´ng/tháº¥t báº¡i</td>
<td><code>pytest</code>, <code>bcrypt</code></td>
</tr>
<tr>
<td>Token request builder</td>
<td>Kiá»ƒm tra payload gá»­i sang <code>token-service</code></td>
<td><code>pytest</code>, mock HTTP</td>
</tr>
<tr>
<td>Audit logger</td>
<td>Gá»­i Ä‘Ãºng event + metadata</td>
<td><code>pytest</code>, <code>mock pubsub</code></td>
</tr>
<tr>
<td>Metadata extractor</td>
<td>Tá»« IP, user-agent header</td>
<td>Unit test thuáº§n</td>
</tr>
</tbody>
</table>
<p>âœ… ToÃ n bá»™ unit test Ä‘Æ°á»£c cháº¡y Ä‘á»™c láº­p vá»›i cÃ¡c service khÃ¡c.</p>
<hr/>
<h3 id="82-contract-tests">ğŸ”— 8.2. Contract Tests<a class="headerlink" href="#82-contract-tests" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ theo <code>adr-010</code>, táº¥t cáº£ cÃ¡c HTTP call outbound Ä‘á»u cÃ³ há»£p Ä‘á»“ng rÃµ rÃ ng vÃ  Ä‘Æ°á»£c kiá»ƒm thá»­ contract Ä‘á»‹nh ká»³.</p>
<table>
<thead>
<tr>
<th>Service</th>
<th>PhÆ°Æ¡ng phÃ¡p</th>
<th>Tool</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>token-service</code></td>
<td>Kiá»ƒm tra JSON schema cá»§a <code>/token/issue</code>, <code>/token/revoke</code></td>
<td><code>pact</code>, <code>schemathesis</code></td>
</tr>
<tr>
<td><code>user-service</code></td>
<td>Contract: <code>POST /users/sync</code></td>
<td><code>pact</code></td>
</tr>
<tr>
<td><code>notification-service</code></td>
<td>Contract: <code>POST /otp/send</code></td>
<td><code>pact</code></td>
</tr>
<tr>
<td><code>audit-service</code></td>
<td>Kiá»ƒm tra event schema <code>auth.token.issued</code>, <code>auth.token.revoked</code></td>
<td>JSON Schema validation</td>
</tr>
</tbody>
</table>
<p>ğŸ”’ CÃ¡c contract test Ä‘Æ°á»£c trigger tá»± Ä‘á»™ng trong CI má»—i khi cÃ³ thay Ä‘á»•i API liÃªn quan.</p>
<hr/>
<h3 id="83-integration-tests">ğŸ§ª 8.3. Integration Tests<a class="headerlink" href="#83-integration-tests" title="Permanent link">Â¶</a></h3>
<p>MÃ´ phá»ng toÃ n bá»™ flow xÃ¡c thá»±c giá»¯a cÃ¡c service.</p>
<table>
<thead>
<tr>
<th>Ká»‹ch báº£n</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td>ÄÄƒng nháº­p OTP há»£p lá»‡</td>
<td>Táº¡o OTP â†’ gá»­i â†’ xÃ¡c thá»±c â†’ nháº­n JWT â†’ sync user</td>
</tr>
<tr>
<td>ÄÄƒng nháº­p OTP sai mÃ£</td>
<td>Thá»­ mÃ£ sai nhiá»u láº§n â†’ bá»‹ cháº·n</td>
</tr>
<tr>
<td>ÄÄƒng nháº­p Local</td>
<td>Gá»­i username/password Ä‘Ãºng vÃ  sai</td>
</tr>
<tr>
<td>Logout</td>
<td>Gá»­i refresh token â†’ thu há»“i token â†’ kiá»ƒm tra Redis revoked</td>
</tr>
<tr>
<td>Äá»“ng bá»™ user</td>
<td>Khi user chÆ°a tá»“n táº¡i â†’ trigger event sync</td>
</tr>
</tbody>
</table>
<p>ğŸ“¦ DÃ¹ng docker-compose hoáº·c test container mock Ä‘á»ƒ cháº¡y test mÃ´i trÆ°á»ng staging.</p>
<hr/>
<h3 id="84-e2e-tests-qua-api-gateway">ğŸŒ 8.4. E2E Tests (qua API Gateway)<a class="headerlink" href="#84-e2e-tests-qua-api-gateway" title="Permanent link">Â¶</a></h3>
<ul>
<li>Gá»­i request tá»« frontend giáº£ láº­p qua <code>api-gateway</code></li>
<li>Test rate-limit, RBAC, header <code>X-Tenant-ID</code>, trace ID</li>
<li>Kiá»ƒm tra toÃ n chuá»—i: login â†’ get token â†’ logout â†’ revoked check</li>
</ul>
<p>ğŸ’¡ CÃ¡c E2E test quan trá»ng nháº¥t sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o <code>smoke test suite</code> khi rollout má»—i tenant má»›i.</p>
<hr/>
<h3 id="85-coverage-cicd">ğŸ“ˆ 8.5. Coverage &amp; CI/CD<a class="headerlink" href="#85-coverage-cicd" title="Permanent link">Â¶</a></h3>
<ul>
<li>YÃªu cáº§u coverage &gt; 90% cho domain logic</li>
<li>CÃ³ cÃ¡c tá»‡p test Ä‘á»™c láº­p theo tá»«ng táº§ng: <code>tests/unit/</code>, <code>tests/integration/</code>, <code>tests/contracts/</code></li>
<li>CÃ¡c test Ä‘Æ°á»£c cháº¡y trÃªn pipeline GitLab CI hoáº·c GitHub Actions, cÃ³ kiá»ƒm tra rollback náº¿u fail</li>
</ul>
<hr/>
<h3 id="tong-hop-muc-tieu-kiem-thu">ğŸ§© Tá»•ng há»£p má»¥c tiÃªu kiá»ƒm thá»­<a class="headerlink" href="#tong-hop-muc-tieu-kiem-thu" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Má»¥c tiÃªu</th>
<th>CÃ³ kiá»ƒm thá»­?</th>
</tr>
</thead>
<tbody>
<tr>
<td>TÃ­nh Ä‘Ãºng Ä‘áº¯n (correctness)</td>
<td>âœ…</td>
</tr>
<tr>
<td>Kháº£ nÄƒng má»Ÿ rá»™ng</td>
<td>âœ… qua test song song tenant</td>
</tr>
<tr>
<td>Äá»™c láº­p tenant</td>
<td>âœ… test per-tenant config</td>
</tr>
<tr>
<td>PhÃ¡t hiá»‡n lá»—i giao tiáº¿p</td>
<td>âœ… qua contract tests</td>
</tr>
<tr>
<td>Quan sÃ¡t hÃ nh vi báº¥t thÆ°á»ng</td>
<td>âœ… thÃ´ng qua log &amp; mock audit</td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="9-quan-sat-giam-sat">9. ğŸ“ˆ Quan sÃ¡t &amp; GiÃ¡m sÃ¡t<a class="headerlink" href="#9-quan-sat-giam-sat" title="Permanent link">Â¶</a></h2>
<p><code>auth-service/sub</code> lÃ  entrypoint xÃ¡c thá»±c quan trá»ng, cáº§n Ä‘Æ°á»£c quan sÃ¡t vÃ  giÃ¡m sÃ¡t toÃ n diá»‡n Ä‘á»ƒ Ä‘áº£m báº£o Ä‘á»™ tin cáº­y, báº£o máº­t vÃ  hiá»‡u suáº¥t. Chiáº¿n lÆ°á»£c observability cá»§a service tuÃ¢n thá»§ triáº¿t lÃ½ â€œ4 trá»¥ cá»™tâ€:</p>
<ul>
<li><strong>Logging</strong> (Ghi log chuáº©n vÃ  cÃ³ cáº¥u trÃºc)</li>
<li><strong>Metrics</strong> (Äo lÆ°á»ng Ä‘á»‹nh lÆ°á»£ng, dÃ¹ng cho cáº£nh bÃ¡o)</li>
<li><strong>Tracing</strong> (Theo dÃµi chuá»—i request xuyÃªn service)</li>
<li><strong>Audit Logging</strong> (LÆ°u dáº¥u váº¿t hÃ nh vi ngÆ°á»i dÃ¹ng)</li>
</ul>
<hr/>
<h3 id="91-logging-structured-log">ğŸªµ 9.1. Logging (Structured Log)<a class="headerlink" href="#91-logging-structured-log" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»i log pháº£i á»Ÿ Ä‘á»‹nh dáº¡ng JSON Ä‘á»ƒ cÃ³ thá»ƒ phÃ¢n tÃ­ch táº­p trung</li>
<li>Log pháº£i bao gá»“m Ã­t nháº¥t cÃ¡c trÆ°á»ng sau:</li>
</ul>
<div class="language-json highlight"><pre><span></span><code><span id="__span-7-1"><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="p">{</span>
</span><span id="__span-7-2"><a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-13T10:00:00Z"</span><span class="p">,</span>
</span><span id="__span-7-3"><a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">  </span><span class="nt">"level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"INFO"</span><span class="p">,</span>
</span><span id="__span-7-4"><a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"school-abc"</span><span class="p">,</span>
</span><span id="__span-7-5"><a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">  </span><span class="nt">"trace_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc123"</span><span class="p">,</span>
</span><span id="__span-7-6"><a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">  </span><span class="nt">"module"</span><span class="p">:</span><span class="w"> </span><span class="s2">"otp_login"</span><span class="p">,</span>
</span><span id="__span-7-7"><a href="#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">  </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"OTP verified successfully"</span><span class="p">,</span>
</span><span id="__span-7-8"><a href="#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user-xyz"</span>
</span><span id="__span-7-9"><a href="#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>ğŸ“ DÃ¹ng <code>loguru</code>, <code>structlog</code> hoáº·c tÆ°Æ¡ng Ä‘Æ°Æ¡ng, log táº­p trung qua <code>Fluent Bit â†’ Loki / ELK</code>.</p>
<hr/>
<h3 id="92-metrics-prometheus">ğŸ“Š 9.2. Metrics (Prometheus)<a class="headerlink" href="#92-metrics-prometheus" title="Permanent link">Â¶</a></h3>
<p>Dá»‹ch vá»¥ expose <code>/metrics</code> theo chuáº©n Prometheus, gá»“m cÃ¡c metric chÃ­nh:</p>
<table>
<thead>
<tr>
<th>TÃªn Metric</th>
<th>MÃ´ táº£</th>
<th>NhÃ£n kÃ¨m theo</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth_login_total</code></td>
<td>Tá»•ng sá»‘ lÆ°á»£t login (OTP + Local)</td>
<td><code>tenant_id</code>, <code>method</code>, <code>status</code></td>
</tr>
<tr>
<td><code>otp_sent_total</code></td>
<td>Sá»‘ lÆ°á»£ng OTP gá»­i Ä‘i</td>
<td><code>channel=email/sms</code>, <code>tenant_id</code></td>
</tr>
<tr>
<td><code>session_created_total</code></td>
<td>PhiÃªn Ä‘Äƒng nháº­p thÃ nh cÃ´ng</td>
<td><code>tenant_id</code>, <code>method</code></td>
</tr>
<tr>
<td><code>login_failed_total</code></td>
<td>Login tháº¥t báº¡i</td>
<td><code>reason</code>, <code>tenant_id</code></td>
</tr>
<tr>
<td><code>external_call_latency_seconds</code></td>
<td>Thá»i gian gá»i cÃ¡c service khÃ¡c</td>
<td><code>target=token/user/audit</code></td>
</tr>
</tbody>
</table>
<p>ğŸš¨ Cáº£nh bÃ¡o Ä‘i kÃ¨m (Alert Rules):
- TÄƒng Ä‘á»™t biáº¿n <code>login_failed_total</code>
- Sá»‘ OTP gá»­i vÆ°á»£t ngÆ°á»¡ng trong thá»i gian ngáº¯n
- Token issue latency vÆ°á»£t SLA (&gt;300ms)</p>
<hr/>
<h3 id="93-tracing-distributed-trace">ğŸ” 9.3. Tracing (Distributed Trace)<a class="headerlink" href="#93-tracing-distributed-trace" title="Permanent link">Â¶</a></h3>
<ul>
<li>TÃ­ch há»£p OpenTelemetry Ä‘á»ƒ trace toÃ n bá»™ chuá»—i login</li>
<li>Má»—i request Ä‘á»u Ä‘Ã­nh kÃ¨m:</li>
<li><code>X-Trace-ID</code>: UUID toÃ n chuá»—i</li>
<li><code>X-Span-ID</code>: ID riÃªng cho má»—i dá»‹ch vá»¥</li>
<li>Trace gá»­i vá» há»‡ thá»‘ng nhÆ° <code>Jaeger</code>, <code>Tempo</code>, <code>Honeycomb</code></li>
</ul>
<p>VÃ­ dá»¥ trace:
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>FE â†’ Gateway â†’ AuthSub â†’ TokenService â†’ UserService â†’ AuditLog
</span></code></pre></div></p>
<hr/>
<h3 id="94-audit-logging">ğŸ“š 9.4. Audit Logging<a class="headerlink" href="#94-audit-logging" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n theo <code>adr-008</code>, má»i hÃ nh vi xÃ¡c thá»±c Ä‘á»u ghi log vÃ o há»‡ thá»‘ng <code>audit-logging-service</code>.</p>
<table>
<thead>
<tr>
<th>Sá»± kiá»‡n audit</th>
<th>Khi nÃ o ghi?</th>
<th>TrÆ°á»ng báº¯t buá»™c</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth.token.issued</code></td>
<td>Khi login thÃ nh cÃ´ng</td>
<td><code>user_id</code>, <code>login_method</code>, <code>ip</code>, <code>device</code>, <code>trace_id</code></td>
</tr>
<tr>
<td><code>auth.token.revoked</code></td>
<td>Khi logout</td>
<td><code>session_id</code>, <code>revoked_by</code>, <code>reason</code></td>
</tr>
<tr>
<td><code>auth.login.failed</code></td>
<td>Khi login sai</td>
<td><code>reason</code>, <code>tenant_id</code>, <code>trace_id</code></td>
</tr>
</tbody>
</table>
<p>âš ï¸ Audit log cÃ³ thá»ƒ Ä‘Æ°á»£c xuáº¥t sang file riÃªng biá»‡t hoáº·c stream qua Pub/Sub tÃ¹y theo thiáº¿t láº­p tenant.</p>
<hr/>
<h3 id="95-observability-by-tenant">ğŸ§ª 9.5. Observability by tenant<a class="headerlink" href="#95-observability-by-tenant" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»—i tenant cÃ³ thá»ƒ cÃ³ dashboard Prometheus/Grafana riÃªng</li>
<li>Má»i alert rule Ä‘á»u gáº¯n <code>tenant_id</code> Ä‘á»ƒ tÃ¡ch biá»‡t kÃªnh cáº£nh bÃ¡o</li>
<li>CÃ¡c dashboard gá»“m:</li>
<li>Tá»‰ lá»‡ thÃ nh cÃ´ng OTP/Login</li>
<li>Sá»‘ lÆ°á»£ng login theo ngÃ y</li>
<li>Thá»i gian trung bÃ¬nh cáº¥p token</li>
</ul>
<p>ğŸ‘‰ Äáº£m báº£o observability khÃ´ng chá»‰ phá»¥c vá»¥ váº­n hÃ nh, mÃ  cÃ²n lÃ  má»™t pháº§n quan trá»ng Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ báº£o máº­t vÃ  cháº¥t lÆ°á»£ng tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng.</p>
<hr/>
<h2 id="10-o-tin-cay-phuc-hoi">10. ğŸš€ Äá»™ tin cáº­y &amp; Phá»¥c há»“i<a class="headerlink" href="#10-o-tin-cay-phuc-hoi" title="Permanent link">Â¶</a></h2>
<p><code>auth-service/sub</code> Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ Ä‘áº¡t Ä‘á»™ tin cáº­y cao trong mÃ´i trÆ°á»ng multi-tenant, Ä‘áº£m báº£o dá»‹ch vá»¥ luÃ´n sáºµn sÃ ng phá»¥c vá»¥ ngÆ°á»i dÃ¹ng Ä‘áº§u cuá»‘i nhÆ° há»c sinh, giÃ¡o viÃªn vÃ  nhÃ¢n viÃªn trong cÃ¡c trÆ°á»ng thÃ nh viÃªn cá»§a há»‡ thá»‘ng VAS.</p>
<hr/>
<h3 id="101-stateless-va-scale-ngang">ğŸ§± 10.1. Stateless vÃ  Scale ngang<a class="headerlink" href="#101-stateless-va-scale-ngang" title="Permanent link">Â¶</a></h3>
<ul>
<li>Dá»‹ch vá»¥ hoÃ n toÃ n <strong>stateless</strong> â€“ má»i tráº¡ng thÃ¡i ngÆ°á»i dÃ¹ng (token, session) Ä‘Æ°á»£c lÆ°u táº¡i Redis hoáº·c PostgreSQL</li>
<li>Há»— trá»£ <strong>horizontal scaling</strong> thÃ´ng qua autoscaler (HPA), phÃ¹ há»£p vá»›i mÃ´ hÃ¬nh burst load nhÆ° Ä‘Äƒng nháº­p giá» cao Ä‘iá»ƒm</li>
</ul>
<hr/>
<h3 id="102-retry-idempotency">â™»ï¸ 10.2. Retry &amp; Idempotency<a class="headerlink" href="#102-retry-idempotency" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>TÃ¡c vá»¥</th>
<th>CÆ¡ cháº¿ phá»¥c há»“i</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gá»i <code>token-service</code></td>
<td>Tá»± Ä‘á»™ng retry 3 láº§n (backoff: 200ms â†’ 500ms)</td>
</tr>
<tr>
<td>Gá»­i audit log</td>
<td>Retry qua hÃ ng chá» ná»™i bá»™ (async background task)</td>
</tr>
<tr>
<td>Äá»“ng bá»™ user</td>
<td>Gá»­i 1 láº§n, náº¿u lá»—i ghi vÃ o dead-letter queue Ä‘á»ƒ xá»­ lÃ½ sau</td>
</tr>
<tr>
<td>Gá»­i OTP</td>
<td>Náº¿u lá»—i nhÃ  cung cáº¥p, cho retry tá»‘i Ä‘a 2 láº§n qua kÃªnh khÃ¡c</td>
</tr>
</tbody>
</table>
<p>ğŸ§ª CÃ¡c API gá»i outbound pháº£i <strong>idempotent</strong>, Ä‘áº·c biá»‡t lÃ  <code>user.sync</code>, <code>token.issue</code>, Ä‘áº£m báº£o khÃ´ng táº¡o session trÃ¹ng náº¿u frontend resend request.</p>
<hr/>
<h3 id="103-gioi-han-loi-co-lap-tenant">ğŸ’¥ 10.3. Giá»›i háº¡n lá»—i &amp; cÃ´ láº­p tenant<a class="headerlink" href="#103-gioi-han-loi-co-lap-tenant" title="Permanent link">Â¶</a></h3>
<ul>
<li>Náº¿u má»™t tenant gáº·p lá»—i (vÃ­ dá»¥ cáº¥u hÃ¬nh sai Redis), chá»‰ tenant Ä‘Ã³ bá»‹ áº£nh hÆ°á»Ÿng â†’ khÃ´ng lan sang tenant khÃ¡c</li>
<li>Má»—i tenant cháº¡y instance riÃªng hoáº·c phÃ¢n vÃ¹ng theo namespace</li>
</ul>
<hr/>
<h3 id="104-circuit-breaker-timeout">ğŸ›  10.4. Circuit Breaker &amp; Timeout<a class="headerlink" href="#104-circuit-breaker-timeout" title="Permanent link">Â¶</a></h3>
<ul>
<li>Circuit breaker báº­t náº¿u tá»· lá»‡ lá»—i vÆ°á»£t 20% trong 1 phÃºt cho tá»«ng external service</li>
<li>Timeout tiÃªu chuáº©n:</li>
<li><code>token-service</code>: 3s</li>
<li><code>user-service</code>: 2s</li>
<li><code>notification-service</code>: 2s</li>
<li>Náº¿u quÃ¡ timeout â†’ ghi log vÃ  tráº£ lá»—i chuáº©n <code>auth.external_timeout</code> (ErrorEnvelope)</li>
</ul>
<hr/>
<h3 id="105-slaslo">â± 10.5. SLA/SLO<a class="headerlink" href="#105-slaslo" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Loáº¡i</th>
<th>Má»©c cam káº¿t</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>SLA uptime</strong></td>
<td>â‰¥ 99.95%/thÃ¡ng</td>
</tr>
<tr>
<td><strong>Token issue latency (p95)</strong></td>
<td>â‰¤ 300ms</td>
</tr>
<tr>
<td><strong>OTP delivery time (p95)</strong></td>
<td>â‰¤ 5s</td>
</tr>
<tr>
<td><strong>Login success rate</strong></td>
<td>â‰¥ 98% (vá»›i OTP Ä‘Ãºng)</td>
</tr>
</tbody>
</table>
<p>CÃ¡c chá»‰ sá»‘ nÃ y Ä‘Æ°á»£c monitor qua Prometheus, vÃ  bÃ¡o cÃ¡o theo tenant.</p>
<hr/>
<h3 id="106-rollback-zero-downtime">ğŸš¨ 10.6. Rollback &amp; Zero Downtime<a class="headerlink" href="#106-rollback-zero-downtime" title="Permanent link">Â¶</a></h3>
<ul>
<li>TuÃ¢n thá»§ <code>adr-014</code>: sá»­ dá»¥ng rolling update, khÃ´ng xÃ³a container cÅ© cho Ä‘áº¿n khi container má»›i sáºµn sÃ ng</li>
<li>Sá»­ dá»¥ng <code>readinessProbe</code>, <code>livenessProbe</code> Ä‘á»ƒ Ä‘áº£m báº£o chá»‰ phá»¥c vá»¥ request khi sáºµn sÃ ng</li>
<li>Náº¿u phiÃªn báº£n má»›i bá»‹ lá»—i:</li>
<li>Rollback tá»± Ä‘á»™ng trong 30s</li>
<li>Alert cho DevOps náº¿u 3 láº§n rollout liÃªn tiáº¿p tháº¥t báº¡i</li>
</ul>
<hr/>
<h3 id="107-recovery-tu-loi-nghiem-trong">ğŸ§¯ 10.7. Recovery tá»« lá»—i nghiÃªm trá»ng<a class="headerlink" href="#107-recovery-tu-loi-nghiem-trong" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>TÃ¬nh huá»‘ng</th>
<th>Phá»¥c há»“i</th>
</tr>
</thead>
<tbody>
<tr>
<td>Redis cache down</td>
<td>Dá»‹ch vá»¥ váº«n hoáº¡t Ä‘á»™ng nhÆ°ng khÃ´ng kiá»ƒm tra revoked token; bÃ¡o Ä‘á»™ng cáº£nh bÃ¡o</td>
</tr>
<tr>
<td>PostgreSQL downtime</td>
<td>KhÃ´ng thá»ƒ ghi session â†’ váº«n cáº¥p JWT â†’ Ä‘á»“ng bá»™ láº¡i khi DB trá»Ÿ láº¡i</td>
</tr>
<tr>
<td>Gá»i audit-service fail</td>
<td>LÆ°u log cá»¥c bá»™ Ä‘á»ƒ gá»­i láº¡i sau</td>
</tr>
<tr>
<td>Token-service khÃ´ng pháº£n há»“i</td>
<td>Tráº£ lá»—i <code>token.issuer_unavailable</code>, hiá»ƒn thá»‹ UI retry cho ngÆ°á»i dÃ¹ng</td>
</tr>
</tbody>
</table>
<hr/>
<p>âœ… TÃ³m láº¡i, <code>auth-service/sub</code> Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ <strong>chá»‹u lá»—i</strong>, <strong>khÃ´i phá»¥c tá»± Ä‘á»™ng</strong>, <strong>cÃ´ láº­p tenant</strong> vÃ  Ä‘áº£m báº£o hoáº¡t Ä‘á»™ng liÃªn tá»¥c trong Ä‘iá»u kiá»‡n thá»±c táº¿ nhiá»u biáº¿n Ä‘á»™ng.</p>
<hr/>
<h2 id="11-hieu-nang-kha-nang-mo-rong">11. âš¡ï¸ Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng<a class="headerlink" href="#11-hieu-nang-kha-nang-mo-rong" title="Permanent link">Â¶</a></h2>
<p><code>auth-service/sub</code> Ä‘Æ°á»£c thiáº¿t káº¿ vá»›i má»¥c tiÃªu <strong>hiá»‡u nÄƒng cao</strong>, <strong>Ä‘á»™ trá»… tháº¥p</strong> vÃ  cÃ³ thá»ƒ <strong>scale Ä‘á»™c láº­p theo tá»«ng tenant</strong>. Dá»‹ch vá»¥ hoáº¡t Ä‘á»™ng hoÃ n toÃ n stateless, táº­n dá»¥ng caching, pub/sub vÃ  cáº¥u trÃºc microservice Ä‘á»ƒ Ä‘áº£m báº£o kháº£ nÄƒng phá»¥c vá»¥ Ä‘á»“ng thá»i hÃ ng ngÃ n phiÃªn Ä‘Äƒng nháº­p má»—i phÃºt.</p>
<hr/>
<h3 id="kien-truc-hieu-nang-cao">âš™ï¸ Kiáº¿n trÃºc hiá»‡u nÄƒng cao<a class="headerlink" href="#kien-truc-hieu-nang-cao" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>ThÃ nh pháº§n</th>
<th>Tá»‘i Æ°u hiá»‡u nÄƒng</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Stateless design</strong></td>
<td>Cho phÃ©p scale ngang dá»… dÃ ng qua HPA</td>
</tr>
<tr>
<td><strong>Redis cache</strong></td>
<td>LÆ°u OTP, token revoked, limiter â†’ giáº£m táº£i DB</td>
</tr>
<tr>
<td><strong>Background task</strong></td>
<td>Gá»­i log, audit, sync user thá»±c hiá»‡n báº¥t Ä‘á»“ng bá»™</td>
</tr>
<tr>
<td><strong>Timeout &amp; Circuit Breaker</strong></td>
<td>Giáº£m táº¯c ngháº½n do dependency ngoáº¡i vi</td>
</tr>
<tr>
<td><strong>KhÃ´ng Ä‘á»“ng bá»™ hoÃ¡ user blocking</strong></td>
<td>XÃ¡c thá»±c khÃ´ng bá»‹ cháº·n khi chÆ°a cÃ³ user (sync async)</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="kha-nang-mo-rong-theo-tenant">ğŸš€ Kháº£ nÄƒng má»Ÿ rá»™ng theo tenant<a class="headerlink" href="#kha-nang-mo-rong-theo-tenant" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»—i tenant Ä‘Æ°á»£c deploy theo instance hoáº·c namespace riÃªng</li>
<li>CÃ³ thá»ƒ Ä‘iá»u chá»‰nh autoscale, resource limit theo nhu cáº§u tá»«ng tenant</li>
<li>TÃ¡ch queue Pub/Sub vÃ  cache Redis riÃªng â†’ trÃ¡nh â€œnoisy neighborâ€</li>
</ul>
<pre class="mermaid"><code>graph TD
  Tenant1(AuthSub1) --&gt;|Redis1| RedisCluster
  Tenant2(AuthSub2) --&gt;|Redis2| RedisCluster
  Tenant3(AuthSub3) --&gt;|Redis3| RedisCluster
</code></pre>
<p>ğŸ“Œ CÃ³ thá»ƒ gom nhiá»u tenant cÃ³ traffic tháº¥p vÃ o má»™t cá»¥m náº¿u cáº§n tá»‘i Æ°u tÃ i nguyÃªn, nhÆ°ng pháº£i báº£o Ä‘áº£m <code>tenant_id</code> Ä‘Æ°á»£c cÃ¡ch ly logic.</p>
<hr/>
<h3 id="cac-chi-so-theo-doi-hieu-nang">ğŸ“ˆ CÃ¡c chá»‰ sá»‘ theo dÃµi hiá»‡u nÄƒng<a class="headerlink" href="#cac-chi-so-theo-doi-hieu-nang" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>NgÆ°á»¡ng Ä‘á» xuáº¥t (p95)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>otp_delivery_duration_seconds</code></td>
<td>â‰¤ 5s</td>
</tr>
<tr>
<td><code>token_issue_duration_seconds</code></td>
<td>â‰¤ 300ms</td>
</tr>
<tr>
<td><code>session_write_duration_seconds</code></td>
<td>â‰¤ 200ms</td>
</tr>
<tr>
<td><code>auth_login_total</code></td>
<td>â‰¥ 2000 req/minute (burst)</td>
</tr>
</tbody>
</table>
<p>Táº¥t cáº£ cÃ¡c chá»‰ sá»‘ Ä‘Æ°á»£c theo dÃµi qua Prometheus vÃ  dashboard riÃªng cho tá»«ng tenant.</p>
<hr/>
<h3 id="gioi-han-va-bao-ve">â›“ Giá»›i háº¡n vÃ  báº£o vá»‡<a class="headerlink" href="#gioi-han-va-bao-ve" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>CÆ¡ cháº¿</th>
<th>Má»¥c tiÃªu</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Rate-limit theo IP / user</strong></td>
<td>TrÃ¡nh brute-force</td>
</tr>
<tr>
<td><strong>OTP resend throttle</strong></td>
<td>Giáº£m spam qua notification service</td>
</tr>
<tr>
<td><strong>Retry + backoff</strong></td>
<td>TrÃ¡nh overloading backend (token/user service)</td>
</tr>
<tr>
<td><strong>Liveness &amp; readiness probe</strong></td>
<td>Äáº£m báº£o chá»‰ nháº­n request khi sáºµn sÃ ng</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="benchmark-e-xuat">ğŸ§ª Benchmark Ä‘á» xuáº¥t<a class="headerlink" href="#benchmark-e-xuat" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Ká»‹ch báº£n</th>
<th>MÃ´i trÆ°á»ng test</th>
<th>Káº¿t quáº£</th>
</tr>
</thead>
<tbody>
<tr>
<td>1,000 OTP requests/min</td>
<td>2 pods, Redis local</td>
<td>97% request â‰¤ 500ms</td>
</tr>
<tr>
<td>500 concurrent login</td>
<td>PostgreSQL shard per tenant</td>
<td>99.9% success</td>
</tr>
<tr>
<td>Redis máº¥t káº¿t ná»‘i</td>
<td>Fallback ghi log, audit async</td>
<td>KhÃ´ng máº¥t session</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="inh-huong-toi-uu-tiep-theo">ğŸ§© Äá»‹nh hÆ°á»›ng tá»‘i Æ°u tiáº¿p theo<a class="headerlink" href="#inh-huong-toi-uu-tiep-theo" title="Permanent link">Â¶</a></h3>
<ul>
<li>DÃ¹ng JWT vá»›i short TTL + sliding session Ä‘á»ƒ giáº£m revoked lookup</li>
<li>Caching result cá»§a OTP validate Ä‘á»ƒ giáº£m DB hit náº¿u resend</li>
<li>Gom luá»“ng audit log thÃ nh batch Ä‘á»ƒ gá»­i hiá»‡u quáº£ hÆ¡n</li>
</ul>
<hr/>
<p>âœ… Tá»•ng káº¿t: <code>auth-service/sub</code> cÃ³ thá»ƒ má»Ÿ rá»™ng linh hoáº¡t theo tenant, Ä‘áº£m báº£o phá»¥c vá»¥ tá»‘t cÃ¡c há»‡ thá»‘ng trÆ°á»ng lá»›n nhá» vá»›i chi phÃ­ háº¡ táº§ng tá»‘i Æ°u, Ä‘á»™ trá»… tháº¥p vÃ  Ä‘á»™ sáºµn sÃ ng cao.</p>
<hr/>
<h2 id="12-ke-hoach-trien-khai-migration">12. ğŸ›  Káº¿ hoáº¡ch Triá»ƒn khai &amp; Migration<a class="headerlink" href="#12-ke-hoach-trien-khai-migration" title="Permanent link">Â¶</a></h2>
<p>Viá»‡c triá»ƒn khai <code>auth-service/sub</code> tuÃ¢n theo chiáº¿n lÆ°á»£c <strong>triá»ƒn khai theo tenant Ä‘á»™c láº­p</strong>, káº¿t há»£p versioning linh hoáº¡t vÃ  kháº£ nÄƒng migration an toÃ n nháº±m Ä‘áº£m báº£o <strong>zero downtime</strong> vÃ  <strong>khÃ´ng áº£nh hÆ°á»Ÿng dá»¯ liá»‡u xÃ¡c thá»±c</strong>.</p>
<hr/>
<h3 id="chien-luoc-trien-khai">ğŸš€ Chiáº¿n lÆ°á»£c triá»ƒn khai<a class="headerlink" href="#chien-luoc-trien-khai" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Äáº·c Ä‘iá»ƒm</th>
<th>CÃ¡ch triá»ƒn khai</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Per-tenant deployment</strong></td>
<td>Má»—i tenant Ä‘Æ°á»£c deploy dÆ°á»›i namespace riÃªng hoáº·c chart release riÃªng</td>
</tr>
<tr>
<td><strong>Rolling update</strong></td>
<td>Ãp dá»¥ng trÃªn tá»«ng tenant Ä‘á»ƒ giáº£m rá»§i ro áº£nh hÆ°á»Ÿng diá»‡n rá»™ng</td>
</tr>
<tr>
<td><strong>Blue/Green hoáº·c Canary (tuá»³ tenant lá»›n)</strong></td>
<td>Äáº·c biá»‡t vá»›i trÆ°á»ng lá»›n cÃ³ hÆ¡n 5,000 ngÆ°á»i dÃ¹ng</td>
</tr>
<tr>
<td><strong>Helm chart</strong></td>
<td>DÃ¹ng Helm vá»›i giÃ¡ trá»‹ riÃªng theo tenant (<code>values/tenant-name.yaml</code>)</td>
</tr>
<tr>
<td><strong>Auto-scaling báº­t sau deploy thÃ nh cÃ´ng</strong></td>
<td>TrÃ¡nh scale sá»›m gÃ¢y táº¡o pod chÆ°a sáºµn sÃ ng</td>
</tr>
</tbody>
</table>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>helm<span class="w"> </span>upgrade<span class="w"> </span>--install<span class="w"> </span>auth-sub-school-abc<span class="w"> </span>./charts/auth-sub<span class="w"> </span>-f<span class="w"> </span>values/school-abc.yaml
</span></code></pre></div>
<hr/>
<h3 id="chinh-sach-versioning-theo-tenant">ğŸ§© ChÃ­nh sÃ¡ch versioning theo tenant<a class="headerlink" href="#chinh-sach-versioning-theo-tenant" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ <code>adr-025</code>, má»—i tenant cÃ³ thá»ƒ sá»­ dá»¥ng <strong>phiÃªn báº£n service khÃ¡c nhau</strong>, Ä‘Æ°á»£c quáº£n lÃ½ theo semver:</p>
<table>
<thead>
<tr>
<th>Tenant</th>
<th>Version</th>
<th>LÃ½ do khÃ¡c biá»‡t</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>school-abc</code></td>
<td>v1.2.0</td>
<td>Sá»­ dá»¥ng tÃ­nh nÄƒng multi-factor</td>
</tr>
<tr>
<td><code>school-xyz</code></td>
<td>v1.1.5</td>
<td>Dá»«ng á»Ÿ phiÃªn báº£n á»•n Ä‘á»‹nh</td>
</tr>
<tr>
<td><code>school-test</code></td>
<td>v1.3.0-beta</td>
<td>Triá»ƒn khai thá»­ nghiá»‡m tÃ­nh nÄƒng má»›i</td>
</tr>
</tbody>
</table>
<p>CÃ¡c version Ä‘Æ°á»£c quáº£n lÃ½ qua Helm tag + image tag, Ä‘Æ°á»£c kiá»ƒm tra tá»± Ä‘á»™ng trÆ°á»›c khi cáº­p nháº­t diá»‡n rá»™ng.</p>
<hr/>
<h3 id="ke-hoach-migration-schema">ğŸ” Káº¿ hoáº¡ch migration schema<a class="headerlink" href="#ke-hoach-migration-schema" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>ThÃ nh pháº§n</th>
<th>CÆ¡ cháº¿ migration</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth_sessions</code> table</td>
<td>Flyway / Alembic / Prisma</td>
</tr>
<tr>
<td><code>revoked_tokens</code> cache</td>
<td>KhÃ´ng cáº§n migration, TTL tá»± quáº£n lÃ½</td>
</tr>
<tr>
<td><code>OTP config</code></td>
<td>DÃ¹ng giÃ¡ trá»‹ máº·c Ä‘á»‹nh náº¿u chÆ°a cÃ³</td>
</tr>
<tr>
<td><code>Secrets</code></td>
<td>Inject qua Vault hoáº·c Kubernetes Secret, khÃ´ng cáº§n thay Ä‘á»•i</td>
</tr>
</tbody>
</table>
<p>TuÃ¢n thá»§ <code>adr-023</code>, má»i migration Ä‘á»u pháº£i:
- CÃ³ version kiá»ƒm soÃ¡t
- CÃ³ backup snapshot trÆ°á»›c khi apply
- CÃ³ rollback script Ä‘i kÃ¨m</p>
<hr/>
<h3 id="phuc-hoi-neu-deployment-loi">â›‘ Phá»¥c há»“i náº¿u deployment lá»—i<a class="headerlink" href="#phuc-hoi-neu-deployment-loi" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Giai Ä‘oáº¡n</th>
<th>Biá»‡n phÃ¡p phá»¥c há»“i</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sau apply Helm lá»—i</td>
<td>Rollback chart <code>helm rollback</code></td>
</tr>
<tr>
<td>DB migration lá»—i</td>
<td>Rollback schema báº±ng snapshot</td>
</tr>
<tr>
<td>Token-service hoáº·c Redis khÃ´ng sáºµn sÃ ng</td>
<td>KhÃ´ng khá»Ÿi cháº¡y pod (fail readiness probe)</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="checklist-trien-khai-tenant-moi">ğŸ“‹ Checklist triá»ƒn khai tenant má»›i<a class="headerlink" href="#checklist-trien-khai-tenant-moi" title="Permanent link">Â¶</a></h3>
<ol>
<li>Táº¡o file cáº¥u hÃ¬nh <code>values/tenant-id.yaml</code></li>
<li>Táº¡o secret Vault hoáº·c Kubernetes tÆ°Æ¡ng á»©ng</li>
<li>Khá»Ÿi táº¡o DB vá»›i <code>auth_sessions</code> table</li>
<li>Apply Helm chart</li>
<li>Kiá»ƒm thá»­ login flow (OTP &amp; Local)</li>
<li>KÃ­ch hoáº¡t autoscaler náº¿u load thá»±c táº¿ cao</li>
<li>GiÃ¡m sÃ¡t metrics &amp; alert trong 24h Ä‘áº§u</li>
<li>BÃ n giao cho quáº£n trá»‹ viÃªn tenant</li>
</ol>
<hr/>
<h3 id="mo-phong-deploy-mass-multi-tenant">ğŸ§ª MÃ´ phá»ng deploy mass multi-tenant<a class="headerlink" href="#mo-phong-deploy-mass-multi-tenant" title="Permanent link">Â¶</a></h3>
<ul>
<li>Ká»‹ch báº£n: deploy 50 tenants song song</li>
<li>Má»—i tenant deploy máº¥t ~8s</li>
<li>Tá»•ng thá»i gian rollout &lt; 7 phÃºt</li>
<li>KhÃ´ng cÃ³ downtime á»Ÿ cÃ¡c tenant Ä‘ang hoáº¡t Ä‘á»™ng</li>
</ul>
<hr/>
<p>âœ… Káº¿t luáº­n: <code>auth-service/sub</code> há»— trá»£ triá»ƒn khai linh hoáº¡t, cÃ´ láº­p rá»§i ro, rollback dá»… dÃ ng, vÃ  má»Ÿ rá»™ng tá»«ng tenant theo nhu cáº§u thá»±c táº¿.</p>
<hr/>
<h2 id="13-kien-truc-service">13. ğŸ§© Kiáº¿n trÃºc Service<a class="headerlink" href="#13-kien-truc-service" title="Permanent link">Â¶</a></h2>
<p><code>auth-service/sub</code> Ä‘Æ°á»£c thiáº¿t káº¿ theo mÃ´ hÃ¬nh microservice hiá»‡n Ä‘áº¡i, hoÃ n toÃ n stateless, tá»‘i Æ°u cho triá»ƒn khai Ä‘a tenant vÃ  kháº£ nÄƒng má»Ÿ rá»™ng Ä‘á»™c láº­p theo tá»«ng tenant.</p>
<hr/>
<h3 id="kien-truc-noi-tai-internal-architecture">ğŸ— Kiáº¿n trÃºc ná»™i táº¡i (Internal Architecture)<a class="headerlink" href="#kien-truc-noi-tai-internal-architecture" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>graph LR
  GW[API Gateway] --&gt; SRV(Auth Service Sub)
  SRV --&gt; OTP[OTP Module]
  SRV --&gt; LOCAL[Local Login Module]
  SRV --&gt; TS[Token Service]
  SRV --&gt; US[User Service]
  SRV --&gt; AUD[Audit Logging]
  SRV --&gt; REDIS[Redis Cache]
  SRV --&gt; PG[PostgreSQLauth_sessions]
</code></pre>
<h4 id="cac-thanh-phan-chinh">ğŸ§© CÃ¡c thÃ nh pháº§n chÃ­nh<a class="headerlink" href="#cac-thanh-phan-chinh" title="Permanent link">Â¶</a></h4>
<table>
<thead>
<tr>
<th>ThÃ nh pháº§n</th>
<th>Vai trÃ²</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OTP Module</code></td>
<td>XÃ¡c minh OTP, giá»›i háº¡n sá»‘ láº§n, tracking resend</td>
</tr>
<tr>
<td><code>Local Login Module</code></td>
<td>Kiá»ƒm tra username/password báº±ng bcrypt</td>
</tr>
<tr>
<td><code>Session Tracker</code></td>
<td>Ghi láº¡i phiÃªn Ä‘Äƒng nháº­p vÃ o DB</td>
</tr>
<tr>
<td><code>Token Proxy</code></td>
<td>Gá»i <code>token-service</code> Ä‘á»ƒ issue/revoke token</td>
</tr>
<tr>
<td><code>User Sync Agent</code></td>
<td>Trigger sync náº¿u user chÆ°a tá»“n táº¡i</td>
</tr>
<tr>
<td><code>Audit Logger</code></td>
<td>Gá»­i sá»± kiá»‡n Ä‘Äƒng nháº­p vÃ o Pub/Sub hoáº·c audit-log</td>
</tr>
<tr>
<td><code>Redis Adapter</code></td>
<td>LÆ°u OTP, revoked token, rate-limit counter</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="kien-truc-trien-khai-deployment-architecture">ğŸ§± Kiáº¿n trÃºc triá»ƒn khai (Deployment Architecture)<a class="headerlink" href="#kien-truc-trien-khai-deployment-architecture" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>flowchart TD
  subgraph Tenant A
    A1[auth-service/sub:v1.2.0]
    A2[Postgres A]
    A3[Redis A]
  end

  subgraph Tenant B
    B1[auth-service/sub:v1.1.5]
    B2[Postgres B]
    B3[Redis B]
  end

  GW[API Gateway] --&gt;|X-Tenant-ID: A| A1
  GW --&gt;|X-Tenant-ID: B| B1
</code></pre>
<ul>
<li>Má»—i tenant cÃ³ thá»ƒ cháº¡y má»™t phiÃªn báº£n khÃ¡c nhau</li>
<li>Redis vÃ  Postgres cÃ³ thá»ƒ tÃ¡ch riÃªng hoáº·c dÃ¹ng cÃ¹ng Redis cluster phÃ¢n vÃ¹ng theo <code>tenant_id</code></li>
<li>Táº¥t cáº£ giao tiáº¿p ra bÃªn ngoÃ i Ä‘á»u dÃ¹ng ná»™i bá»™ (<code>cluster.local</code>) vÃ  báº£o vá»‡ báº±ng HMAC hoáº·c mTLS</li>
</ul>
<hr/>
<h3 id="quy-tac-thiet-ke">ğŸ§  Quy táº¯c thiáº¿t káº¿<a class="headerlink" href="#quy-tac-thiet-ke" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>NguyÃªn táº¯c</th>
<th>Ãp dá»¥ng</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Separation of Concern</strong></td>
<td>XÃ¡c thá»±c logic tÃ¡ch khá»i token issuance</td>
</tr>
<tr>
<td><strong>Single Responsibility</strong></td>
<td>KhÃ´ng kiá»ƒm tra RBAC, khÃ´ng lÆ°u user detail</td>
</tr>
<tr>
<td><strong>Observability First</strong></td>
<td>Gáº¯n trace_id, audit má»i hÃ nh vi</td>
</tr>
<tr>
<td><strong>Per-tenant Isolation</strong></td>
<td>Cáº¥u hÃ¬nh, secret, DB tÃ¡ch biá»‡t</td>
</tr>
<tr>
<td><strong>Zero Downtime Ready</strong></td>
<td>readinessProbe, rolling update chuáº©n ADR-014</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="thu-muc-ma-nguon-goi-y">ğŸ“¦ ThÆ° má»¥c mÃ£ nguá»“n (gá»£i Ã½)<a class="headerlink" href="#thu-muc-ma-nguon-goi-y" title="Permanent link">Â¶</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>auth-service-sub/
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>â”œâ”€â”€ main.py
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>â”œâ”€â”€ config/          # Load cáº¥u hÃ¬nh theo tenant
</span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>â”œâ”€â”€ routes/          # OTP, local login, logout
</span><span id="__span-10-5"><a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>â”œâ”€â”€ services/        # Giao tiáº¿p token, user, audit
</span><span id="__span-10-6"><a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a>â”œâ”€â”€ models/          # DB model cho auth_sessions
</span><span id="__span-10-7"><a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>â”œâ”€â”€ schemas/         # Request/response schema
</span><span id="__span-10-8"><a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a>â”œâ”€â”€ utils/           # Helper extract metadata, hashing
</span><span id="__span-10-9"><a href="#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a>â”œâ”€â”€ tests/
</span><span id="__span-10-10"><a href="#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a>â”‚   â”œâ”€â”€ unit/
</span><span id="__span-10-11"><a href="#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a>â”‚   â”œâ”€â”€ integration/
</span><span id="__span-10-12"><a href="#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a>â”‚   â””â”€â”€ contract/
</span></code></pre></div>
<hr/>
<p>âœ… Káº¿t luáº­n: Kiáº¿n trÃºc cá»§a <code>auth-service/sub</code> Ä‘Æ°á»£c tá»‘i Æ°u Ä‘á»ƒ váº­n hÃ nh tin cáº­y, tÃ¡ch biá»‡t rá»§i ro, dá»… quan sÃ¡t vÃ  scale hiá»‡u quáº£ trÃªn mÃ´i trÆ°á»ng multi-tenant.</p>
<hr/>
<h2 id="14-tai-lieu-lien-quan">14. ğŸ“š TÃ i liá»‡u liÃªn quan<a class="headerlink" href="#14-tai-lieu-lien-quan" title="Permanent link">Â¶</a></h2>
<ul>
<li><a href="../interface-contract/">Interface Contract</a></li>
<li><a href="../data-model/">Data Model</a></li>
<li><a href="../openapi.yaml">OpenAPI Spec</a></li>
<li><a href="../../../../ADR/adr-006-auth-strategy/">ADR-006 - Auth Strategy</a></li>
<li><a href="../../../../ADR/adr-007-rbac/">ADR-007 - RBAC</a></li>
<li><a href="../../architecture/rbac-deep-dive.md">rbac-deep-dive.md</a></li>
</ul>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Trá»Ÿ láº¡i má»¥c lá»¥c
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>