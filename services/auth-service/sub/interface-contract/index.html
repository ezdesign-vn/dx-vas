
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Tài liệu kiến trúc và phát triển cho dự án Chuyển đổi số Trường Việt Anh." name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://ezdesign-vn.github.io/dx-vas/services/auth-service/sub/interface-contract/" rel="canonical"/>
<link href="../../../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Auth Service (Sub) - Interface Contract - DX VAS - Docs</title>
<link href="../../../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#auth-service-sub-interface-contract">
          Bỏ qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Đầu trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Auth Service (Sub) - Interface Contract
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Tìm kiếm" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Tìm kiếm" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Tìm kiếm" class="md-search__options">
<button aria-label="Xoá" class="md-search__icon md-icon" tabindex="-1" title="Xoá" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mã nguồn">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../architecture/system-diagrams/">
          
  
  
    
  
  Kiến trúc Hệ thống

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../dev-guide/">
        
  
  
    
  
  Hướng dẫn Phát triển

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../">
        
  
  
    
  
  Thiết kế Services

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../ADR/">
          
  
  
    
  
  Quyết định Kiến trúc (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh điều hướng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mã nguồn">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Kiến trúc Hệ thống
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Kiến trúc Hệ thống
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../architecture/system-diagrams/">
<span class="md-ellipsis">
    Sơ đồ Hệ thống
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../architecture/rbac-deep-dive/">
<span class="md-ellipsis">
    RBAC Chi tiết
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../dev-guide/">
<span class="md-ellipsis">
    Hướng dẫn Phát triển
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../">
<span class="md-ellipsis">
    Thiết kế Services
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../../ADR/">
<span class="md-ellipsis">
    Quyết định Kiến trúc (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quyết định Kiến trúc (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Mục lục" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Mục lục
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-muc-tieu-pham-vi-tai-lieu">
<span class="md-ellipsis">
      1. 🎯 Mục tiêu &amp; Phạm vi tài liệu
    </span>
</a>
<nav aria-label="1. 🎯 Mục tiêu &amp; Phạm vi tài liệu" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#muc-tieu-chinh">
<span class="md-ellipsis">
      🎯 Mục tiêu chính
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cac-api-uoc-inh-nghia-tai-ay">
<span class="md-ellipsis">
      📦 Các API được định nghĩa tại đây
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ngoai-pham-vi-out-of-scope">
<span class="md-ellipsis">
      🚫 Ngoài phạm vi (Out of Scope)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inh-huong-kien-truc">
<span class="md-ellipsis">
      🧭 Định hướng kiến trúc
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-chinh-sach-bao-mat-phan-quyen">
<span class="md-ellipsis">
      2. 🔐 Chính sách Bảo mật &amp; Phân quyền
    </span>
</a>
<nav aria-label="2. 🔐 Chính sách Bảo mật &amp; Phân quyền" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#21-security-scheme">
<span class="md-ellipsis">
      2.1. 🛡 Security Scheme
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#22-co-che-kiem-soat-phan-quyen">
<span class="md-ellipsis">
      2.2. 🧩 Cơ chế kiểm soát phân quyền
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#23-bang-mapping-permission">
<span class="md-ellipsis">
      2.3. 📋 Bảng mapping permission
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#24-bao-ve-du-lieu-nhay-cam">
<span class="md-ellipsis">
      2.4. 🔐 Bảo vệ dữ liệu nhạy cảm
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#25-goi-y-trien-khai">
<span class="md-ellipsis">
      2.5. 🧠 Gợi ý triển khai
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-tong-quan-api-luong-nghiep-vu">
<span class="md-ellipsis">
      3. 📌 Tổng quan API &amp; Luồng nghiệp vụ
    </span>
</a>
<nav aria-label="3. 📌 Tổng quan API &amp; Luồng nghiệp vụ" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#31-cac-nhom-chuc-nang-chinh">
<span class="md-ellipsis">
      3.1. 🔁 Các nhóm chức năng chính
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#32-luong-xu-ly-chinh">
<span class="md-ellipsis">
      3.2. 🧭 Luồng xử lý chính
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#33-moi-lien-he-voi-cac-service-khac">
<span class="md-ellipsis">
      3.3. 🌐 Mối liên hệ với các service khác
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#34-su-kien-uoc-phat-ra">
<span class="md-ellipsis">
      3.4. 📣 Sự kiện được phát ra
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-chi-tiet-cac-endpoint">
<span class="md-ellipsis">
      4. 📬 Chi tiết các Endpoint
    </span>
</a>
<nav aria-label="4. 📬 Chi tiết các Endpoint" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#41-post-authlogin">
<span class="md-ellipsis">
      4.1. POST /auth/login
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#42-post-authlogout">
<span class="md-ellipsis">
      4.2. POST /auth/logout
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#43-get-authsessions">
<span class="md-ellipsis">
      4.3. GET /auth/sessions
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#44-post-authsessionsidrevoke">
<span class="md-ellipsis">
      4.4. POST /auth/sessions/{id}/revoke
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-schema-su-dung-trong-requestresponse">
<span class="md-ellipsis">
      5. 📦 Schema sử dụng trong request/response
    </span>
</a>
<nav aria-label="5. 📦 Schema sử dụng trong request/response" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-loginrequest">
<span class="md-ellipsis">
      5.1. 📨 LoginRequest
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-tokenenvelope">
<span class="md-ellipsis">
      5.2. 📤 TokenEnvelope
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-logoutrequest">
<span class="md-ellipsis">
      5.3. 📥 LogoutRequest
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#54-sessionout">
<span class="md-ellipsis">
      5.4. 📜 SessionOut
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#55-errorenvelope">
<span class="md-ellipsis">
      5.5. 🛑 ErrorEnvelope
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#56-responsemeta">
<span class="md-ellipsis">
      5.6. 📦 ResponseMeta
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-quy-uoc-response-ma-loi">
<span class="md-ellipsis">
      6. 🎯 Quy ước response &amp; mã lỗi
    </span>
</a>
<nav aria-label="6. 🎯 Quy ước response &amp; mã lỗi" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-cau-truc-phan-hoi-thanh-cong">
<span class="md-ellipsis">
      6.1. 📦 Cấu trúc phản hồi thành công
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-cau-truc-phan-hoi-loi">
<span class="md-ellipsis">
      6.2. 🛑 Cấu trúc phản hồi lỗi
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-danh-sach-ma-loi-pho-bien">
<span class="md-ellipsis">
      6.3. 📋 Danh sách mã lỗi phổ biến
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-contract-testing-yeu-cau">
<span class="md-ellipsis">
      6.4. 🧪 Contract testing yêu cầu
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-ho-tro-kiem-thu-tich-hop">
<span class="md-ellipsis">
      7. 🧪 Hỗ trợ kiểm thử &amp; tích hợp
    </span>
</a>
<nav aria-label="7. 🧪 Hỗ trợ kiểm thử &amp; tích hợp" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-mau-request-thuc-te">
<span class="md-ellipsis">
      7.1. ✅ Mẫu request thực tế
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-contract-testing">
<span class="md-ellipsis">
      7.2. 🧪 Contract Testing
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-kiem-thu-phan-quyen-ieu-kien">
<span class="md-ellipsis">
      7.3. 🧪 Kiểm thử phân quyền &amp; điều kiện
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-tich-hop-cicd">
<span class="md-ellipsis">
      7.4. 🛠 Tích hợp CI/CD
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#75-tich-hop-observability">
<span class="md-ellipsis">
      7.5. 📡 Tích hợp observability
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-tai-lieu-lien-quan">
<span class="md-ellipsis">
      8. 📚 Tài liệu liên quan
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="auth-service-sub-interface-contract">📘 Auth Service Sub – Interface Contract<a class="headerlink" href="#auth-service-sub-interface-contract" title="Permanent link">¶</a></h1>
<h2 id="1-muc-tieu-pham-vi-tai-lieu">1. 🎯 Mục tiêu &amp; Phạm vi tài liệu<a class="headerlink" href="#1-muc-tieu-pham-vi-tai-lieu" title="Permanent link">¶</a></h2>
<p>Tài liệu này định nghĩa rõ các <strong>hợp đồng giao tiếp (interface contract)</strong> của <code>auth-service/sub</code> – một service chịu trách nhiệm xác thực người dùng theo từng tenant, bao gồm:</p>
<ul>
<li>Đăng nhập qua OTP hoặc tài khoản nội bộ (Local login)</li>
<li>Quản lý vòng đời phiên đăng nhập (<code>auth_sessions</code>)</li>
<li>Thu hồi phiên hoặc token đã cấp</li>
<li>Cung cấp metadata và audit cho các service khác</li>
</ul>
<hr/>
<h3 id="muc-tieu-chinh">🎯 Mục tiêu chính<a class="headerlink" href="#muc-tieu-chinh" title="Permanent link">¶</a></h3>
<ul>
<li>Là cơ sở chính thức cho việc <strong>triển khai backend</strong> và <strong>frontend tích hợp</strong></li>
<li>Chuẩn hoá request/response theo OpenAPI</li>
<li>Áp dụng các quy tắc phân quyền và bảo mật theo chuẩn <code>RBAC động</code></li>
<li>Làm cơ sở cho contract testing, CI/CD và monitoring</li>
</ul>
<hr/>
<h3 id="cac-api-uoc-inh-nghia-tai-ay">📦 Các API được định nghĩa tại đây<a class="headerlink" href="#cac-api-uoc-inh-nghia-tai-ay" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Nhóm chức năng</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>POST /auth/login</code></td>
<td>Đăng nhập người dùng (OTP / Local)</td>
</tr>
<tr>
<td><code>POST /auth/logout</code></td>
<td>Đăng xuất và thu hồi token</td>
</tr>
<tr>
<td><code>GET /auth/sessions</code></td>
<td>Truy vấn lịch sử phiên đăng nhập</td>
</tr>
<tr>
<td><code>POST /auth/sessions/{id}/revoke</code></td>
<td>Thu hồi một phiên cụ thể</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="ngoai-pham-vi-out-of-scope">🚫 Ngoài phạm vi (Out of Scope)<a class="headerlink" href="#ngoai-pham-vi-out-of-scope" title="Permanent link">¶</a></h3>
<p>Các chức năng sau <strong>không nằm trong tài liệu này</strong> và được định nghĩa ở nơi khác:</p>
<table>
<thead>
<tr>
<th>Chức năng</th>
<th>Nơi định nghĩa</th>
</tr>
</thead>
<tbody>
<tr>
<td>Xác thực Google (OAuth2)</td>
<td><code>auth-service/master</code></td>
</tr>
<tr>
<td>Cấp phát JWT token</td>
<td><code>token-service</code></td>
</tr>
<tr>
<td>Kiểm tra RBAC động</td>
<td><code>api-gateway</code></td>
</tr>
<tr>
<td>Quản lý người dùng</td>
<td><code>user-service</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="inh-huong-kien-truc">🧭 Định hướng kiến trúc<a class="headerlink" href="#inh-huong-kien-truc" title="Permanent link">¶</a></h3>
<p>Tài liệu này được xây dựng dựa trên nguyên lý:</p>
<ul>
<li><strong>Stateless Service</strong>: mọi trạng thái phiên đều externalized</li>
<li><strong>Multi-tenant per-instance</strong>: mọi request bắt buộc đi kèm <code>X-Tenant-ID</code></li>
<li><strong>RBAC Externalized</strong>: mọi permission và điều kiện truy cập được xử lý tại gateway hoặc middleware</li>
<li><strong>Auditability</strong>: mọi hành vi phát sinh đều gửi sự kiện để trace và giám sát</li>
</ul>
<blockquote>
<p>📌 Mọi API trong tài liệu đều đồng bộ 100% với file OpenAPI (<code>openapi.yaml</code>) của <code>auth-service/sub</code>.</p>
</blockquote>
<hr/>
<h2 id="2-chinh-sach-bao-mat-phan-quyen">2. 🔐 Chính sách Bảo mật &amp; Phân quyền<a class="headerlink" href="#2-chinh-sach-bao-mat-phan-quyen" title="Permanent link">¶</a></h2>
<p>Toàn bộ các endpoint trong <code>auth-service/sub</code> yêu cầu xác thực và phân quyền chặt chẽ dựa trên:</p>
<ul>
<li><strong>JWT token</strong> được cấp từ <code>token-service</code></li>
<li><strong>X-Tenant-ID</strong> để định danh tenant hiện hành</li>
<li><strong>Permission động (RBAC)</strong> để giới hạn quyền truy cập theo vai trò và ngữ cảnh</li>
</ul>
<hr/>
<h3 id="21-security-scheme">2.1. 🛡 Security Scheme<a class="headerlink" href="#21-security-scheme" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Thành phần</th>
<th>Bắt buộc</th>
<th>Ghi chú</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Authorization</code> header</td>
<td>✅</td>
<td>Dạng Bearer JWT</td>
</tr>
<tr>
<td><code>X-Tenant-ID</code> header</td>
<td>✅</td>
<td>Mọi request đều phải xác định tenant</td>
</tr>
<tr>
<td>JWT payload</td>
<td>✅</td>
<td>Chứa <code>user_id</code>, <code>roles</code>, <code>tenant_id</code>… theo chuẩn hệ thống</td>
</tr>
</tbody>
</table>
<blockquote>
<p>⚠️ Token phải được cấp hợp lệ từ <code>token-service</code>, ký bằng khóa <code>RS256</code>.</p>
</blockquote>
<hr/>
<h3 id="22-co-che-kiem-soat-phan-quyen">2.2. 🧩 Cơ chế kiểm soát phân quyền<a class="headerlink" href="#22-co-che-kiem-soat-phan-quyen" title="Permanent link">¶</a></h3>
<p>Hệ thống RBAC theo mô hình <code>permission + condition</code>, được xử lý <strong>ngoài service</strong> (tại <code>api-gateway</code> hoặc middleware) và được kiểm tra lại trong audit/logic nếu cần.</p>
<h4 id="vi-du">Ví dụ:<a class="headerlink" href="#vi-du" title="Permanent link">¶</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">"x-permissions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"session.read:self"</span><span class="p">],</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">"x-condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{current_user.id}}"</span><span class="p">,</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{X-Tenant-ID}}"</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="p">}</span>
</span></code></pre></div>
<hr/>
<h3 id="23-bang-mapping-permission">2.3. 📋 Bảng mapping permission<a class="headerlink" href="#23-bang-mapping-permission" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Permission</th>
<th>x-condition</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>POST /auth/login</code></td>
<td><code>auth.login</code></td>
<td><code>{ "tenant_id": "{{X-Tenant-ID}}" }</code></td>
</tr>
<tr>
<td><code>POST /auth/logout</code></td>
<td><code>auth.logout</code></td>
<td><code>{ "tenant_id": "{{X-Tenant-ID}}" }</code></td>
</tr>
<tr>
<td><code>GET /auth/sessions</code></td>
<td><code>session.read:self</code> | <code>session.read:any</code></td>
<td><code>{ "user_id": ..., "tenant_id": ... }</code></td>
</tr>
<tr>
<td><code>POST /auth/sessions/{id}/revoke</code></td>
<td><code>session.revoke:any</code></td>
<td><code>{ "tenant_id": ... }</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>Nếu user không thoả <code>x-condition</code>, hệ thống sẽ trả lỗi <code>403 Forbidden</code>.</p>
</blockquote>
<hr/>
<h3 id="24-bao-ve-du-lieu-nhay-cam">2.4. 🔐 Bảo vệ dữ liệu nhạy cảm<a class="headerlink" href="#24-bao-ve-du-lieu-nhay-cam" title="Permanent link">¶</a></h3>
<ul>
<li>Các trường như <code>ip_address</code>, <code>user_agent</code>, <code>location</code> trong session chỉ trả về nếu có quyền <code>session.read:any</code></li>
<li>Với quyền <code>session.read:self</code>, một số trường có thể bị cắt bỏ để bảo vệ quyền riêng tư</li>
</ul>
<hr/>
<h3 id="25-goi-y-trien-khai">2.5. 🧠 Gợi ý triển khai<a class="headerlink" href="#25-goi-y-trien-khai" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Vấn đề</th>
<th>Giải pháp</th>
</tr>
</thead>
<tbody>
<tr>
<td>Người dùng quên gửi <code>X-Tenant-ID</code></td>
<td>Gateway trả lỗi 400 với lỗi <code>missing_tenant_id</code></td>
</tr>
<tr>
<td>Quản trị viên muốn xem session của user khác</td>
<td>Cần <code>session.read:any</code> và điều kiện tenant match</td>
</tr>
<tr>
<td>Hạn chế truy cập chéo giữa tenant</td>
<td>Mọi truy vấn đều bắt buộc <code>tenant_id = {{X-Tenant-ID}}</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>✅ Cơ chế bảo mật và phân quyền được thiết kế để hoạt động an toàn trong môi trường multi-tenant, đồng thời linh hoạt cho quản trị hệ thống trên từng tenant cụ thể.</p>
</blockquote>
<hr/>
<h2 id="3-tong-quan-api-luong-nghiep-vu">3. 📌 Tổng quan API &amp; Luồng nghiệp vụ<a class="headerlink" href="#3-tong-quan-api-luong-nghiep-vu" title="Permanent link">¶</a></h2>
<p>Các API trong <code>auth-service/sub</code> tập trung phục vụ việc xác thực người dùng theo từng tenant. Tất cả đều tuân thủ kiến trúc phân tầng rõ ràng, hoạt động theo luồng chuẩn xác thực – phát token – quản lý session – thu hồi token.</p>
<hr/>
<h3 id="31-cac-nhom-chuc-nang-chinh">3.1. 🔁 Các nhóm chức năng chính<a class="headerlink" href="#31-cac-nhom-chuc-nang-chinh" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Nhóm API</th>
<th>Mô tả</th>
<th>Endpoint</th>
</tr>
</thead>
<tbody>
<tr>
<td>🧑‍💼 Xác thực</td>
<td>Đăng nhập bằng OTP hoặc Local login</td>
<td><code>POST /auth/login</code></td>
</tr>
<tr>
<td>🚪 Đăng xuất</td>
<td>Thu hồi token đang dùng (logout)</td>
<td><code>POST /auth/logout</code></td>
</tr>
<tr>
<td>📜 Lịch sử phiên</td>
<td>Liệt kê các phiên đăng nhập trước đó</td>
<td><code>GET /auth/sessions</code></td>
</tr>
<tr>
<td>🔒 Thu hồi phiên</td>
<td>Huỷ bỏ session cụ thể (manual revoke)</td>
<td><code>POST /auth/sessions/{id}/revoke</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="32-luong-xu-ly-chinh">3.2. 🧭 Luồng xử lý chính<a class="headerlink" href="#32-luong-xu-ly-chinh" title="Permanent link">¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
  participant Frontend
  participant API Gateway
  participant Auth Sub
  participant Token Service
  participant Redis

  Frontend-&gt;&gt;+API Gateway: /auth/login (OTP/local)
  API Gateway-&gt;&gt;+Auth Sub: chuyển tiếp login
  Auth Sub-&gt;&gt;+Token Service: yêu cầu cấp JWT
  Token Service--&gt;&gt;-Auth Sub: access_token + refresh_token
  Auth Sub-&gt;&gt;Redis: ghi revoked cache (nếu logout)
  Auth Sub--&gt;&gt;-API Gateway: trả về JWT
  API Gateway--&gt;&gt;-Frontend: JWT

  note over Auth Sub,Redis: Emit: auth.token.issued
</code></pre>
<hr/>
<h3 id="33-moi-lien-he-voi-cac-service-khac">3.3. 🌐 Mối liên hệ với các service khác<a class="headerlink" href="#33-moi-lien-he-voi-cac-service-khac" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Service liên quan</th>
<th>Vai trò</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>token-service</code></td>
<td>Sinh &amp; thu hồi access/refresh token</td>
</tr>
<tr>
<td><code>api-gateway</code></td>
<td>Enforce RBAC, forward <code>x-condition</code>, kiểm tra revoked token</td>
</tr>
<tr>
<td><code>user-service</code></td>
<td>Đồng bộ thông tin user (id, trạng thái) nếu cần</td>
</tr>
<tr>
<td><code>notification-service</code></td>
<td>Gửi OTP (trong tương lai nếu tách khỏi frontend)</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="34-su-kien-uoc-phat-ra">3.4. 📣 Sự kiện được phát ra<a class="headerlink" href="#34-su-kien-uoc-phat-ra" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Tên sự kiện</th>
<th>Khi nào?</th>
<th>Payload</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth.token.issued</code></td>
<td>Sau khi login thành công</td>
<td>Thông tin session, token, user metadata</td>
</tr>
<tr>
<td><code>auth.token.revoked</code></td>
<td>Khi logout hoặc bị revoke</td>
<td>Session ID, user ID, lý do</td>
</tr>
<tr>
<td><code>user.sync.triggered</code></td>
<td>(optional) Khi cần đồng bộ user qua tenant khác</td>
<td>user_id, tenant_id</td>
</tr>
</tbody>
</table>
<blockquote>
<p>📌 Luồng nghiệp vụ trong <code>auth-service/sub</code> được thiết kế đơn giản, dễ mở rộng, và phù hợp tuyệt đối với mô hình multi-tenant per-instance của <code>dx-vas</code>.</p>
</blockquote>
<hr/>
<h2 id="4-chi-tiet-cac-endpoint">4. 📬 Chi tiết các Endpoint<a class="headerlink" href="#4-chi-tiet-cac-endpoint" title="Permanent link">¶</a></h2>
<h3 id="41-post-authlogin">4.1. <code>POST /auth/login</code><a class="headerlink" href="#41-post-authlogin" title="Permanent link">¶</a></h3>
<p>Đây là endpoint chính để xác thực người dùng thông qua OTP hoặc tài khoản nội bộ (local). Sau khi xác thực thành công, hệ thống sẽ tạo session, phát JWT, lưu metadata và phát sự kiện <code>auth.token.issued</code>.</p>
<hr/>
<h4 id="request">📥 Request<a class="headerlink" href="#request" title="Permanent link">¶</a></h4>
<p><strong>Header yêu cầu</strong>:</p>
<table>
<thead>
<tr>
<th>Header</th>
<th>Bắt buộc</th>
<th>Ghi chú</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Authorization</code></td>
<td>❌</td>
<td>Không cần (chưa login)</td>
</tr>
<tr>
<td><code>X-Tenant-ID</code></td>
<td>✅</td>
<td>Xác định tenant đang xử lý</td>
</tr>
</tbody>
</table>
<p><strong>Body</strong> (<code>LoginRequest</code>, dùng discriminator <code>login_type</code>):</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nt">"login_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"otp"</span><span class="p">,</span><span class="w">  </span><span class="c1">// hoặc "local"</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nt">"phone_number"</span><span class="p">:</span><span class="w"> </span><span class="s2">"+84901234567"</span><span class="p">,</span><span class="w"> </span><span class="c1">// OTP</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">"otp_code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123456"</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>Hoặc:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="p">{</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">  </span><span class="nt">"login_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"local"</span><span class="p">,</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="nt">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin"</span><span class="p">,</span>
</span><span id="__span-2-4"><a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="nt">"password"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123456"</span>
</span><span id="__span-2-5"><a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="p">}</span>
</span></code></pre></div>
<blockquote>
<p>Các field cụ thể phụ thuộc vào <code>login_type</code>. Tài liệu <code>schemas/LoginRequest</code> sẽ định nghĩa cụ thể.</p>
</blockquote>
<hr/>
<h4 id="response">📤 Response<a class="headerlink" href="#response" title="Permanent link">¶</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="p">{</span>
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">  </span><span class="nt">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="nt">"request_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"xyz"</span><span class="p">,</span>
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span>
</span><span id="__span-3-5"><a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-3-6"><a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-7"><a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="nt">"access_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;JWT&gt;"</span><span class="p">,</span>
</span><span id="__span-3-8"><a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="nt">"refresh_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;JWT&gt;"</span><span class="p">,</span>
</span><span id="__span-3-9"><a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="nt">"expires_in"</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span><span class="p">,</span>
</span><span id="__span-3-10"><a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="nt">"session_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"f2b9c6ae-...95c"</span><span class="p">,</span>
</span><span id="__span-3-11"><a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span><span class="nt">"token_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bearer"</span>
</span><span id="__span-3-12"><a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-13"><a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>Response luôn bọc trong <code>ResponseMeta + TokenEnvelope</code></li>
<li><code>session_id</code> là UUID phiên login được lưu trong <code>auth_sessions</code></li>
<li>Token được phát từ <code>token-service</code>, không phải nội bộ auth-sub</li>
</ul>
<hr/>
<h4 id="phan-quyen-ieu-kien">🔐 Phân quyền &amp; Điều kiện<a class="headerlink" href="#phan-quyen-ieu-kien" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Yếu tố</th>
<th>Giá trị</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>x-required-permission</code></td>
<td><code>auth.login</code></td>
</tr>
<tr>
<td><code>x-condition</code></td>
<td><code>{ "tenant_id": "{{X-Tenant-ID}}" }</code></td>
</tr>
</tbody>
</table>
<hr/>
<h4 id="su-kien-phat-ra">📣 Sự kiện phát ra<a class="headerlink" href="#su-kien-phat-ra" title="Permanent link">¶</a></h4>
<ul>
<li><code>auth.token.issued</code></li>
<li>Payload gồm: <code>user_id</code>, <code>tenant_id</code>, <code>auth_method</code>, <code>session_id</code>, <code>ip_address</code>, <code>user_agent</code>, <code>device_type</code>, <code>location</code></li>
</ul>
<hr/>
<h4 id="ma-loi-co-the-tra-ve">❌ Mã lỗi có thể trả về<a class="headerlink" href="#ma-loi-co-the-tra-ve" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>error.code</th>
<th>HTTP</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth.invalid_credentials</code></td>
<td>401</td>
<td>Sai username/password</td>
</tr>
<tr>
<td><code>auth.otp.invalid</code></td>
<td>400</td>
<td>Mã OTP không đúng</td>
</tr>
<tr>
<td><code>auth.otp.expired</code></td>
<td>400</td>
<td>Mã OTP đã hết hạn</td>
</tr>
<tr>
<td><code>auth.rate_limited</code></td>
<td>429</td>
<td>Gửi OTP quá nhiều lần</td>
</tr>
<tr>
<td><code>auth.tenant_not_found</code></td>
<td>400</td>
<td>Thiếu hoặc sai <code>X-Tenant-ID</code></td>
</tr>
</tbody>
</table>
<hr/>
<h4 id="goi-y-kiem-thu">🧪 Gợi ý kiểm thử<a class="headerlink" href="#goi-y-kiem-thu" title="Permanent link">¶</a></h4>
<ul>
<li>Đăng nhập đúng/sai OTP</li>
<li>Đăng nhập local đúng/sai</li>
<li>Thiếu <code>X-Tenant-ID</code> → lỗi</li>
<li>Session phải được ghi vào bảng <code>auth_sessions</code></li>
<li>Token phải có claim đúng (<code>sub</code>, <code>session_id</code>, <code>tenant_id</code>, <code>exp</code>...)</li>
</ul>
<blockquote>
<p>📌 Đây là endpoint duy nhất tạo JWT trong <code>auth-service/sub</code>. Mọi cấp phát token đều được uỷ quyền sang <code>token-service</code>.</p>
</blockquote>
<hr/>
<h3 id="42-post-authlogout">4.2. <code>POST /auth/logout</code><a class="headerlink" href="#42-post-authlogout" title="Permanent link">¶</a></h3>
<p>Endpoint này cho phép người dùng hoặc hệ thống <strong>thu hồi token hiện tại</strong> (access hoặc refresh) và đánh dấu session tương ứng là đã bị huỷ. Đồng thời phát sự kiện <code>auth.token.revoked</code> để các service khác cập nhật trạng thái.</p>
<hr/>
<h4 id="request_1">📥 Request<a class="headerlink" href="#request_1" title="Permanent link">¶</a></h4>
<p><strong>Header yêu cầu</strong>:</p>
<table>
<thead>
<tr>
<th>Header</th>
<th>Bắt buộc</th>
<th>Ghi chú</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Authorization</code></td>
<td>✅</td>
<td>JWT hiện tại</td>
</tr>
<tr>
<td><code>X-Tenant-ID</code></td>
<td>✅</td>
<td>Tenant tương ứng với token</td>
</tr>
</tbody>
</table>
<p><strong>Body</strong> (<code>LogoutRequest</code>, optional):</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="p">{</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="nt">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_logout"</span>
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="p">}</span>
</span></code></pre></div>
<blockquote>
<p>Nếu không truyền <code>reason</code>, mặc định là <code>"user_logout"</code>.</p>
</blockquote>
<hr/>
<h4 id="response_1">📤 Response<a class="headerlink" href="#response_1" title="Permanent link">¶</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="p">{</span>
</span><span id="__span-5-2"><a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">  </span><span class="nt">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-3"><a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="nt">"request_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="p">,</span>
</span><span id="__span-5-4"><a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span>
</span><span id="__span-5-5"><a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-5-6"><a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">  </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-7"><a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">    </span><span class="nt">"success"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-5-8"><a href="#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-5-9"><a href="#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>Trả về 200 OK với success flag</li>
<li>Không cần trả lại token</li>
</ul>
<hr/>
<h4 id="phan-quyen-ieu-kien_1">🔐 Phân quyền &amp; Điều kiện<a class="headerlink" href="#phan-quyen-ieu-kien_1" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Yếu tố</th>
<th>Giá trị</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>x-required-permission</code></td>
<td><code>auth.logout</code></td>
</tr>
<tr>
<td><code>x-condition</code></td>
<td><code>{ "tenant_id": "{{X-Tenant-ID}}" }</code></td>
</tr>
</tbody>
</table>
<hr/>
<h4 id="hanh-vi-noi-bo">🧩 Hành vi nội bộ<a class="headerlink" href="#hanh-vi-noi-bo" title="Permanent link">¶</a></h4>
<ul>
<li>Token hiện tại được decode → lấy <code>jti</code> (JWT ID), <code>session_id</code>, <code>user_id</code></li>
<li>Tạo key <code>revoked:&lt;jti&gt;</code> trong Redis với TTL đúng bằng thời gian còn lại</li>
<li>Cập nhật bản ghi <code>auth_sessions</code> tương ứng: <code>revoked_at</code>, <code>revoked_reason</code></li>
<li>Ghi log audit và phát sự kiện <code>auth.token.revoked</code></li>
</ul>
<hr/>
<h4 id="su-kien-phat-ra_1">📣 Sự kiện phát ra<a class="headerlink" href="#su-kien-phat-ra_1" title="Permanent link">¶</a></h4>
<ul>
<li><code>auth.token.revoked</code></li>
<li>Payload gồm: <code>session_id</code>, <code>user_id</code>, <code>tenant_id</code>, <code>revoked_reason</code>, <code>revoked_at</code>, <code>ip_address</code>, <code>device_type</code></li>
</ul>
<hr/>
<h4 id="ma-loi-co-the-tra-ve_1">❌ Mã lỗi có thể trả về<a class="headerlink" href="#ma-loi-co-the-tra-ve_1" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>error.code</th>
<th>HTTP</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth.token.invalid</code></td>
<td>401</td>
<td>Token không hợp lệ hoặc đã hết hạn</td>
</tr>
<tr>
<td><code>auth.token.already_revoked</code></td>
<td>400</td>
<td>Token đã bị thu hồi trước đó</td>
</tr>
<tr>
<td><code>auth.tenant_mismatch</code></td>
<td>403</td>
<td>Token không thuộc tenant đang gửi</td>
</tr>
</tbody>
</table>
<hr/>
<h4 id="goi-y-kiem-thu_1">🧪 Gợi ý kiểm thử<a class="headerlink" href="#goi-y-kiem-thu_1" title="Permanent link">¶</a></h4>
<ul>
<li>Logout access token đang dùng → Redis có key <code>revoked:&lt;jti&gt;</code></li>
<li>Logout refresh token → cũng phải bị revoke</li>
<li>Check Redis TTL và dữ liệu</li>
<li>Truy vấn <code>GET /auth/sessions</code> → session đổi trạng thái</li>
<li>Replay token sau logout → phải bị từ chối tại Gateway</li>
</ul>
<blockquote>
<p>📌 Đây là cơ chế chính để thực hiện session termination chủ động, phục vụ cả frontend và admin console. Các revoke xảy ra tại đây là <strong>soft revoke</strong> (qua Redis), không xóa token vật lý.</p>
</blockquote>
<hr/>
<h3 id="43-get-authsessions">4.3. <code>GET /auth/sessions</code><a class="headerlink" href="#43-get-authsessions" title="Permanent link">¶</a></h3>
<p>Endpoint này cho phép người dùng truy vấn danh sách phiên đăng nhập trước đó của chính mình, hoặc truy xuất của người dùng khác (nếu có quyền). Hỗ trợ lọc theo <code>user_id</code>, <code>trạng thái</code>, phân trang.</p>
<hr/>
<h4 id="request_2">📥 Request<a class="headerlink" href="#request_2" title="Permanent link">¶</a></h4>
<p><strong>Header yêu cầu</strong>:</p>
<table>
<thead>
<tr>
<th>Header</th>
<th>Bắt buộc</th>
<th>Ghi chú</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Authorization</code></td>
<td>✅</td>
<td>JWT hợp lệ</td>
</tr>
<tr>
<td><code>X-Tenant-ID</code></td>
<td>✅</td>
<td>Tenant hiện hành</td>
</tr>
</tbody>
</table>
<p><strong>Query Parameters</strong> (tùy chọn):</p>
<table>
<thead>
<tr>
<th>Tham số</th>
<th>Kiểu</th>
<th>Ghi chú</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user_id</code></td>
<td>UUID</td>
<td>Chỉ định user cụ thể (chỉ khi có quyền <code>read:any</code>)</td>
</tr>
<tr>
<td><code>status</code></td>
<td>ENUM</td>
<td><code>active</code>, <code>revoked</code>, <code>expired</code>, <code>locked</code></td>
</tr>
<tr>
<td><code>limit</code></td>
<td>Integer</td>
<td>Số dòng mỗi trang (default: 20)</td>
</tr>
<tr>
<td><code>offset</code></td>
<td>Integer</td>
<td>Bỏ qua bao nhiêu dòng đầu tiên</td>
</tr>
</tbody>
</table>
<hr/>
<h4 id="response_2">📤 Response<a class="headerlink" href="#response_2" title="Permanent link">¶</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="p">{</span>
</span><span id="__span-6-2"><a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">  </span><span class="nt">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-3"><a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">    </span><span class="nt">"request_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="p">,</span>
</span><span id="__span-6-4"><a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">    </span><span class="nt">"pagination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-5"><a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">      </span><span class="nt">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">82</span><span class="p">,</span>
</span><span id="__span-6-6"><a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">      </span><span class="nt">"limit"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span>
</span><span id="__span-6-7"><a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">      </span><span class="nt">"offset"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-6-8"><a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-9"><a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-6-10"><a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">  </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-6-11"><a href="#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-6-12"><a href="#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">      </span><span class="nt">"session_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"f2b9c6ae-..."</span><span class="p">,</span>
</span><span id="__span-6-13"><a href="#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">      </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"de56..."</span><span class="p">,</span>
</span><span id="__span-6-14"><a href="#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">      </span><span class="nt">"auth_method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"otp"</span><span class="p">,</span>
</span><span id="__span-6-15"><a href="#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">      </span><span class="nt">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-01T10:45:00Z"</span><span class="p">,</span>
</span><span id="__span-6-16"><a href="#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">      </span><span class="nt">"revoked_at"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-6-17"><a href="#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">      </span><span class="nt">"ip_address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"203.113.12.1"</span><span class="p">,</span>
</span><span id="__span-6-18"><a href="#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">      </span><span class="nt">"device_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"web"</span><span class="p">,</span>
</span><span id="__span-6-19"><a href="#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="w">      </span><span class="nt">"user_agent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mozilla/5.0 ..."</span><span class="p">,</span>
</span><span id="__span-6-20"><a href="#__codelineno-6-20" id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">      </span><span class="nt">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ho Chi Minh, VN"</span><span class="p">,</span>
</span><span id="__span-6-21"><a href="#__codelineno-6-21" id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">      </span><span class="nt">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span>
</span><span id="__span-6-22"><a href="#__codelineno-6-22" id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-23"><a href="#__codelineno-6-23" id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">  </span><span class="p">]</span>
</span><span id="__span-6-24"><a href="#__codelineno-6-24" id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>Trả về mảng <code>SessionOut</code> theo chuẩn schema</li>
<li>Metadata gồm pagination info và <code>request_id</code></li>
</ul>
<hr/>
<h4 id="phan-quyen-ieu-kien_2">🔐 Phân quyền &amp; Điều kiện<a class="headerlink" href="#phan-quyen-ieu-kien_2" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Yếu tố</th>
<th>Giá trị</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>x-required-permission</code></td>
<td><code>session.read:self</code> hoặc <code>session.read:any</code></td>
</tr>
<tr>
<td><code>x-condition</code></td>
<td><code>{ "user_id": "{{current_user.id}}", "tenant_id": "{{X-Tenant-ID}}" }</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>Nếu user gửi <code>user_id</code> ≠ chính họ → cần <code>session.read:any</code>.</p>
</blockquote>
<hr/>
<h4 id="luu-y-ve-bao-mat">🔎 Lưu ý về bảo mật<a class="headerlink" href="#luu-y-ve-bao-mat" title="Permanent link">¶</a></h4>
<ul>
<li>Nếu chỉ có <code>read:self</code>, hệ thống sẽ <strong>ẩn</strong> hoặc <strong>mask</strong> một số metadata (<code>ip_address</code>, <code>location</code>, <code>user_agent</code>)</li>
<li>Nếu có <code>read:any</code>, sẽ thấy đầy đủ thông tin các session</li>
</ul>
<hr/>
<h4 id="ma-loi-co-the-tra-ve_2">❌ Mã lỗi có thể trả về<a class="headerlink" href="#ma-loi-co-the-tra-ve_2" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>error.code</th>
<th>HTTP</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth.forbidden</code></td>
<td>403</td>
<td>Không đủ quyền truy cập dữ liệu</td>
</tr>
<tr>
<td><code>auth.invalid_query</code></td>
<td>400</td>
<td>Truy vấn không hợp lệ (sai user_id, offset âm...)</td>
</tr>
</tbody>
</table>
<hr/>
<h4 id="goi-y-kiem-thu_2">🧪 Gợi ý kiểm thử<a class="headerlink" href="#goi-y-kiem-thu_2" title="Permanent link">¶</a></h4>
<ul>
<li>Gọi không truyền <code>user_id</code> → trả session chính mình</li>
<li>Gọi <code>user_id = self</code> nhưng thiếu quyền → 403</li>
<li>Phân trang: limit/offset hoạt động chính xác</li>
<li>So sánh số lượng session khớp DB <code>auth_sessions</code></li>
<li>Mask metadata khi dùng quyền <code>read:self</code></li>
</ul>
<blockquote>
<p>📌 Đây là API quan trọng để người dùng tự kiểm tra lịch sử hoạt động hoặc để quản trị viên giám sát đăng nhập trong tenant của họ.</p>
</blockquote>
<hr/>
<h3 id="44-post-authsessionsidrevoke">4.4. <code>POST /auth/sessions/{id}/revoke</code><a class="headerlink" href="#44-post-authsessionsidrevoke" title="Permanent link">¶</a></h3>
<p>Endpoint này cho phép quản trị viên thu hồi một phiên đăng nhập cụ thể của người dùng trong tenant. Hành động này vô hiệu hóa token tương ứng nếu còn hiệu lực, cập nhật trạng thái session và phát sự kiện <code>auth.token.revoked</code>.</p>
<hr/>
<h4 id="request_3">📥 Request<a class="headerlink" href="#request_3" title="Permanent link">¶</a></h4>
<p><strong>Header yêu cầu</strong>:</p>
<table>
<thead>
<tr>
<th>Header</th>
<th>Bắt buộc</th>
<th>Ghi chú</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Authorization</code></td>
<td>✅</td>
<td>JWT có quyền quản trị</td>
</tr>
<tr>
<td><code>X-Tenant-ID</code></td>
<td>✅</td>
<td>Tenant của phiên cần revoke</td>
</tr>
</tbody>
</table>
<p><strong>Path Parameter</strong>:</p>
<table>
<thead>
<tr>
<th>Param</th>
<th>Kiểu</th>
<th>Ghi chú</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>UUID</td>
<td>ID của session (<code>session_id</code>) cần thu hồi</td>
</tr>
</tbody>
</table>
<p><strong>Body</strong> (<code>RevokeSessionRequest</code>, optional):</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-7-1"><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="p">{</span>
</span><span id="__span-7-2"><a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">  </span><span class="nt">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin_forced"</span>
</span><span id="__span-7-3"><a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="p">}</span>
</span></code></pre></div>
<blockquote>
<p>Nếu không cung cấp <code>reason</code>, hệ thống dùng mặc định <code>"manual"</code>.</p>
</blockquote>
<hr/>
<h4 id="response_3">📤 Response<a class="headerlink" href="#response_3" title="Permanent link">¶</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="p">{</span>
</span><span id="__span-8-2"><a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">  </span><span class="nt">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-3"><a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="nt">"request_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="p">,</span>
</span><span id="__span-8-4"><a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">    </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span>
</span><span id="__span-8-5"><a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-8-6"><a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">  </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-7"><a href="#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="nt">"success"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-8-8"><a href="#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-8-9"><a href="#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>Trả về 200 OK nếu thu hồi thành công hoặc đã bị thu hồi trước đó</li>
</ul>
<hr/>
<h4 id="phan-quyen-ieu-kien_3">🔐 Phân quyền &amp; Điều kiện<a class="headerlink" href="#phan-quyen-ieu-kien_3" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Yếu tố</th>
<th>Giá trị</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>x-required-permission</code></td>
<td><code>session.revoke:any</code></td>
</tr>
<tr>
<td><code>x-condition</code></td>
<td><code>{ "tenant_id": "{{X-Tenant-ID}}" }</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>Chỉ cho phép thao tác với các session thuộc tenant hiện tại.</p>
</blockquote>
<hr/>
<h4 id="hanh-vi-noi-bo_1">🧩 Hành vi nội bộ<a class="headerlink" href="#hanh-vi-noi-bo_1" title="Permanent link">¶</a></h4>
<ul>
<li>Truy vấn <code>auth_sessions</code> để xác định session hợp lệ</li>
<li>Nếu session đã bị revoke → trả success idempotent</li>
<li>Nếu session còn hoạt động:</li>
<li>Ghi <code>revoked_at</code>, <code>revoked_reason</code></li>
<li>Ghi Redis key <code>revoked:&lt;jti&gt;</code> nếu token còn hiệu lực</li>
<li>Emit sự kiện <code>auth.token.revoked</code></li>
</ul>
<hr/>
<h4 id="su-kien-phat-ra_2">📣 Sự kiện phát ra<a class="headerlink" href="#su-kien-phat-ra_2" title="Permanent link">¶</a></h4>
<ul>
<li><code>auth.token.revoked</code></li>
<li>Payload gồm: <code>session_id</code>, <code>user_id</code>, <code>tenant_id</code>, <code>revoked_reason</code>, <code>revoked_by</code>, <code>ip_address</code></li>
</ul>
<hr/>
<h4 id="ma-loi-co-the-tra-ve_3">❌ Mã lỗi có thể trả về<a class="headerlink" href="#ma-loi-co-the-tra-ve_3" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>error.code</th>
<th>HTTP</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>session.not_found</code></td>
<td>404</td>
<td>Không tìm thấy session</td>
</tr>
<tr>
<td><code>auth.forbidden</code></td>
<td>403</td>
<td>Không đủ quyền hoặc sai tenant</td>
</tr>
<tr>
<td><code>session.already_revoked</code></td>
<td>400</td>
<td>Phiên đã bị thu hồi từ trước (có thể cho phép idempotent success)</td>
</tr>
</tbody>
</table>
<hr/>
<h4 id="goi-y-kiem-thu_3">🧪 Gợi ý kiểm thử<a class="headerlink" href="#goi-y-kiem-thu_3" title="Permanent link">¶</a></h4>
<ul>
<li>Revoke một session chưa bị thu hồi → cập nhật DB, Redis</li>
<li>Revoke lại cùng session → không lỗi (idempotent)</li>
<li>Truy vấn <code>GET /auth/sessions</code> → thấy trạng thái <code>revoked</code></li>
<li>Xác minh sự kiện <code>auth.token.revoked</code> được phát đúng metadata</li>
<li>Check token tương ứng → bị từ chối khi dùng lại</li>
</ul>
<blockquote>
<p>📌 Đây là API quản trị quan trọng cho phép vô hiệu hóa các phiên nghi ngờ hoặc chấm dứt truy cập ngay lập tức trong các tình huống khẩn cấp về bảo mật.</p>
</blockquote>
<hr/>
<h2 id="5-schema-su-dung-trong-requestresponse">5. 📦 Schema sử dụng trong request/response<a class="headerlink" href="#5-schema-su-dung-trong-requestresponse" title="Permanent link">¶</a></h2>
<p>Tài liệu này mô tả các schema dữ liệu chính được sử dụng trong body của các request và response của <code>auth-service/sub</code>. Tất cả schema đều được định nghĩa và version hóa rõ ràng trong file OpenAPI (<code>openapi.yaml</code>) đi kèm.</p>
<hr/>
<h3 id="51-loginrequest">5.1. 📨 <code>LoginRequest</code><a class="headerlink" href="#51-loginrequest" title="Permanent link">¶</a></h3>
<div class="language-json highlight"><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="p">{</span>
</span><span id="__span-9-2"><a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">  </span><span class="nt">"login_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"otp"</span><span class="p">,</span><span class="w">  </span><span class="c1">// hoặc "local"</span>
</span><span id="__span-9-3"><a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">  </span><span class="nt">"phone_number"</span><span class="p">:</span><span class="w"> </span><span class="s2">"+84901234567"</span><span class="p">,</span>
</span><span id="__span-9-4"><a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">  </span><span class="nt">"otp_code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123456"</span>
</span><span id="__span-9-5"><a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><code>login_type</code>: <code>enum</code> (<code>otp</code>, <code>local</code>)</li>
<li>Nếu <code>otp</code> → yêu cầu <code>phone_number</code> và <code>otp_code</code></li>
<li>Nếu <code>local</code> → yêu cầu <code>username</code> và <code>password</code></li>
<li>Được định nghĩa bằng <code>oneOf</code> trong OpenAPI với discriminator <code>login_type</code></li>
</ul>
<hr/>
<h3 id="52-tokenenvelope">5.2. 📤 <code>TokenEnvelope</code><a class="headerlink" href="#52-tokenenvelope" title="Permanent link">¶</a></h3>
<div class="language-json highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="p">{</span>
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">  </span><span class="nt">"access_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eyJhbGciOiJSUzI1NiIsIn..."</span><span class="p">,</span>
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">  </span><span class="nt">"refresh_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eyJhbGciOiJSUzI1NiIsIn..."</span><span class="p">,</span>
</span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">  </span><span class="nt">"expires_in"</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span><span class="p">,</span>
</span><span id="__span-10-5"><a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">  </span><span class="nt">"session_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3b61237d-..."</span><span class="p">,</span>
</span><span id="__span-10-6"><a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">  </span><span class="nt">"token_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bearer"</span>
</span><span id="__span-10-7"><a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>Bao gói thông tin token được cấp</li>
<li>Trả về trong mọi response <code>login</code></li>
</ul>
<hr/>
<h3 id="53-logoutrequest">5.3. 📥 <code>LogoutRequest</code><a class="headerlink" href="#53-logoutrequest" title="Permanent link">¶</a></h3>
<div class="language-json highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="p">{</span>
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">  </span><span class="nt">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_logout"</span>
</span><span id="__span-11-3"><a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><code>reason</code>: string, optional, các giá trị gợi ý: <code>user_logout</code>, <code>expired</code>, <code>device_lost</code>, <code>admin_forced</code></li>
</ul>
<hr/>
<h3 id="54-sessionout">5.4. 📜 <code>SessionOut</code><a class="headerlink" href="#54-sessionout" title="Permanent link">¶</a></h3>
<div class="language-json highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="p">{</span>
</span><span id="__span-12-2"><a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">  </span><span class="nt">"session_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"b6a1d437-..."</span><span class="p">,</span>
</span><span id="__span-12-3"><a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1e332..."</span><span class="p">,</span>
</span><span id="__span-12-4"><a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">  </span><span class="nt">"auth_method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"local"</span><span class="p">,</span>
</span><span id="__span-12-5"><a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">  </span><span class="nt">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-01T10:45:00Z"</span><span class="p">,</span>
</span><span id="__span-12-6"><a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">  </span><span class="nt">"revoked_at"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-12-7"><a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">  </span><span class="nt">"ip_address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192.168.1.1"</span><span class="p">,</span>
</span><span id="__span-12-8"><a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">  </span><span class="nt">"device_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"web"</span><span class="p">,</span>
</span><span id="__span-12-9"><a href="#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">  </span><span class="nt">"user_agent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mozilla/5.0 ..."</span><span class="p">,</span>
</span><span id="__span-12-10"><a href="#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">  </span><span class="nt">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ho Chi Minh, VN"</span><span class="p">,</span>
</span><span id="__span-12-11"><a href="#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">  </span><span class="nt">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span>
</span><span id="__span-12-12"><a href="#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>Trả về trong <code>GET /auth/sessions</code></li>
<li>Có thể bị ẩn/mask bớt nếu quyền chỉ là <code>session.read:self</code></li>
</ul>
<hr/>
<h3 id="55-errorenvelope">5.5. 🛑 <code>ErrorEnvelope</code><a class="headerlink" href="#55-errorenvelope" title="Permanent link">¶</a></h3>
<div class="language-json highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="p">{</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="nt">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"auth.invalid_credentials"</span><span class="p">,</span>
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">    </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tên đăng nhập hoặc mật khẩu không đúng"</span><span class="p">,</span>
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-6"><a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">      </span><span class="nt">"attempts_left"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-13-7"><a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-8"><a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-13-9"><a href="#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">  </span><span class="nt">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-10"><a href="#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">    </span><span class="nt">"request_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"xyz"</span><span class="p">,</span>
</span><span id="__span-13-11"><a href="#__codelineno-13-11" id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">    </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-13T07:22:30Z"</span>
</span><span id="__span-13-12"><a href="#__codelineno-13-12" id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-13-13"><a href="#__codelineno-13-13" id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>Được chuẩn hóa theo <code>adr-011-api-error-format.md</code></li>
<li>Tất cả response lỗi đều bọc trong <code>ErrorEnvelope</code></li>
</ul>
<hr/>
<h3 id="56-responsemeta">5.6. 📦 <code>ResponseMeta</code><a class="headerlink" href="#56-responsemeta" title="Permanent link">¶</a></h3>
<div class="language-json highlight"><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="p">{</span>
</span><span id="__span-14-2"><a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">  </span><span class="nt">"request_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"req_abc123"</span><span class="p">,</span>
</span><span id="__span-14-3"><a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-13T07:22:30Z"</span><span class="p">,</span>
</span><span id="__span-14-4"><a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">  </span><span class="nt">"pagination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-5"><a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">    </span><span class="nt">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span>
</span><span id="__span-14-6"><a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">    </span><span class="nt">"limit"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span>
</span><span id="__span-14-7"><a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">    </span><span class="nt">"offset"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-14-8"><a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-14-9"><a href="#__codelineno-14-9" id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>Có mặt trong mọi response thành công</li>
<li><code>pagination</code> chỉ có khi dùng response dạng danh sách</li>
</ul>
<blockquote>
<p>📌 Tất cả schema đều versioned và test tự động bằng contract testing tools (<code>schemathesis</code>, <code>dredd</code>, etc.) trong CI pipeline.</p>
</blockquote>
<hr/>
<h2 id="6-quy-uoc-response-ma-loi">6. 🎯 Quy ước response &amp; mã lỗi<a class="headerlink" href="#6-quy-uoc-response-ma-loi" title="Permanent link">¶</a></h2>
<p>Mọi API trong <code>auth-service/sub</code> tuân thủ nghiêm ngặt định dạng phản hồi chuẩn hoá của hệ thống VAS DX. Điều này đảm bảo tính nhất quán, dễ debug và khả năng mở rộng các công cụ tự động hoá (contract testing, monitoring, tracing).</p>
<hr/>
<h3 id="61-cau-truc-phan-hoi-thanh-cong">6.1. 📦 Cấu trúc phản hồi thành công<a class="headerlink" href="#61-cau-truc-phan-hoi-thanh-cong" title="Permanent link">¶</a></h3>
<p>Mỗi response thành công đều phải bọc trong:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-15-1"><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="p">{</span>
</span><span id="__span-15-2"><a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">  </span><span class="nt">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-3"><a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="nt">"request_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc123"</span><span class="p">,</span>
</span><span id="__span-15-4"><a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-13T08:00:00Z"</span>
</span><span id="__span-15-5"><a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-15-6"><a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">  </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-7"><a href="#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">    </span><span class="c1">// Nội dung tuỳ API</span>
</span><span id="__span-15-8"><a href="#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-15-9"><a href="#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><code>meta</code>: luôn có <code>request_id</code> (traceable), <code>timestamp</code>, và optional <code>pagination</code></li>
<li><code>data</code>: chứa payload thực tế (token, session list, success flag...)</li>
</ul>
<blockquote>
<p>Cấu trúc này được chuẩn hóa theo <code>adr-012-response-structure.md</code></p>
</blockquote>
<hr/>
<h3 id="62-cau-truc-phan-hoi-loi">6.2. 🛑 Cấu trúc phản hồi lỗi<a class="headerlink" href="#62-cau-truc-phan-hoi-loi" title="Permanent link">¶</a></h3>
<p>Tất cả lỗi đều trả về định dạng chuẩn <code>ErrorEnvelope</code>:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-16-1"><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="p">{</span>
</span><span id="__span-16-2"><a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-3"><a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">    </span><span class="nt">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"auth.invalid_credentials"</span><span class="p">,</span>
</span><span id="__span-16-4"><a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">    </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Sai tên đăng nhập hoặc mật khẩu"</span><span class="p">,</span>
</span><span id="__span-16-5"><a href="#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">    </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-6"><a href="#__codelineno-16-6" id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">      </span><span class="nt">"attempts_left"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-16-7"><a href="#__codelineno-16-7" id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-16-8"><a href="#__codelineno-16-8" id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-16-9"><a href="#__codelineno-16-9" id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="w">  </span><span class="nt">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-10"><a href="#__codelineno-16-10" id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="w">    </span><span class="nt">"request_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc123"</span><span class="p">,</span>
</span><span id="__span-16-11"><a href="#__codelineno-16-11" id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="w">    </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-13T08:01:30Z"</span>
</span><span id="__span-16-12"><a href="#__codelineno-16-12" id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-16-13"><a href="#__codelineno-16-13" id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><code>code</code>: mã lỗi dạng snake-case (bắt buộc)</li>
<li><code>message</code>: mô tả ngắn gọn, có thể dùng đa ngôn ngữ</li>
<li><code>data</code>: optional – dùng để truyền thêm context (ví dụ: <code>attempts_left</code>, <code>lockout_duration</code>)</li>
</ul>
<hr/>
<h3 id="63-danh-sach-ma-loi-pho-bien">6.3. 📋 Danh sách mã lỗi phổ biến<a class="headerlink" href="#63-danh-sach-ma-loi-pho-bien" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Mã lỗi</th>
<th>HTTP</th>
<th>Mô tả</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth.invalid_credentials</code></td>
<td>401</td>
<td>Sai username/password</td>
</tr>
<tr>
<td><code>auth.otp.invalid</code></td>
<td>400</td>
<td>Mã OTP sai</td>
</tr>
<tr>
<td><code>auth.otp.expired</code></td>
<td>400</td>
<td>OTP đã hết hạn</td>
</tr>
<tr>
<td><code>auth.token.invalid</code></td>
<td>401</td>
<td>Token không hợp lệ hoặc đã thu hồi</td>
</tr>
<tr>
<td><code>auth.token.already_revoked</code></td>
<td>400</td>
<td>Token đã bị thu hồi từ trước</td>
</tr>
<tr>
<td><code>session.not_found</code></td>
<td>404</td>
<td>Không tìm thấy phiên</td>
</tr>
<tr>
<td><code>auth.forbidden</code></td>
<td>403</td>
<td>Không đủ quyền theo RBAC</td>
</tr>
<tr>
<td><code>auth.tenant_mismatch</code></td>
<td>403</td>
<td>Tenant không khớp</td>
</tr>
<tr>
<td><code>auth.rate_limited</code></td>
<td>429</td>
<td>Gửi OTP/quá nhiều yêu cầu</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Danh sách đầy đủ được định nghĩa trong file <code>error-codes.md</code> và <code>adr-011-api-error-format.md</code></p>
</blockquote>
<hr/>
<h3 id="64-contract-testing-yeu-cau">6.4. 🧪 Contract testing yêu cầu<a class="headerlink" href="#64-contract-testing-yeu-cau" title="Permanent link">¶</a></h3>
<ul>
<li>Mỗi mã lỗi đều phải có test tương ứng</li>
<li>Hành vi sai phải trả đúng mã HTTP + <code>error.code</code></li>
<li>CI pipeline không cho phép thay đổi <code>error.code</code> hoặc <code>ResponseMeta</code> format nếu không có migration</li>
</ul>
<blockquote>
<p>✅ Cách tiếp cận nhất quán giúp tăng khả năng giám sát tự động, phân tích lỗi chính xác, hỗ trợ frontend hiển thị rõ ràng và giảm thiểu lỗi tích hợp giữa các đội.</p>
</blockquote>
<hr/>
<h2 id="7-ho-tro-kiem-thu-tich-hop">7. 🧪 Hỗ trợ kiểm thử &amp; tích hợp<a class="headerlink" href="#7-ho-tro-kiem-thu-tich-hop" title="Permanent link">¶</a></h2>
<p>Tài liệu này hỗ trợ đầy đủ cho các hoạt động kiểm thử thủ công, kiểm thử tự động, tích hợp CI/CD và contract testing nhằm đảm bảo độ tin cậy và tính đúng đắn của <code>auth-service/sub</code>.</p>
<hr/>
<h3 id="71-mau-request-thuc-te">7.1. ✅ Mẫu request thực tế<a class="headerlink" href="#71-mau-request-thuc-te" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Mục đích</th>
<th>Method &amp; URL</th>
<th>Gợi ý curl</th>
</tr>
</thead>
<tbody>
<tr>
<td>Đăng nhập OTP</td>
<td><code>POST /auth/login</code></td>
<td><code>curl -X POST ... -H "X-Tenant-ID: t1" -d '{...}'</code></td>
</tr>
<tr>
<td>Logout</td>
<td><code>POST /auth/logout</code></td>
<td><code>curl -H "Authorization: Bearer ..."</code></td>
</tr>
<tr>
<td>Liệt kê session</td>
<td><code>GET /auth/sessions</code></td>
<td><code>curl -G ... --data-urlencode 'user_id=...'</code></td>
</tr>
<tr>
<td>Thu hồi phiên</td>
<td><code>POST /auth/sessions/{id}/revoke</code></td>
<td><code>curl -X POST ... -d '{ "reason": "admin_forced" }'</code></td>
</tr>
</tbody>
</table>
<p>📎 Gợi ý: Sử dụng [Postman Collection] hoặc [Insomnia Export] đính kèm dự án.</p>
<hr/>
<h3 id="72-contract-testing">7.2. 🧪 Contract Testing<a class="headerlink" href="#72-contract-testing" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Mục tiêu</th>
<th>Công cụ đề xuất</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kiểm tra schema đúng với OpenAPI</td>
<td><code>Dredd</code>, <code>Schemathesis</code>, <code>Stoplight Prism</code></td>
</tr>
<tr>
<td>Kiểm tra định dạng lỗi &amp; mã lỗi</td>
<td><code>pytest + snapshot test</code>, <code>jest + supertest</code></td>
</tr>
<tr>
<td>So khớp <code>response.meta</code> &amp; pagination</td>
<td>Tích hợp test CI/CD</td>
</tr>
<tr>
<td>Đảm bảo backward compatibility</td>
<td>Contract test snapshot lockfile</td>
</tr>
</tbody>
</table>
<blockquote>
<p>✅ Tài liệu này đồng bộ 100% với <code>openapi.yaml</code> – có thể dùng để sinh test auto.</p>
</blockquote>
<hr/>
<h3 id="73-kiem-thu-phan-quyen-ieu-kien">7.3. 🧪 Kiểm thử phân quyền &amp; điều kiện<a class="headerlink" href="#73-kiem-thu-phan-quyen-ieu-kien" title="Permanent link">¶</a></h3>
<ul>
<li>Test thiếu <code>X-Tenant-ID</code> → trả lỗi 400</li>
<li>Test <code>session.read:self</code> vs <code>read:any</code> → khác nhau về metadata</li>
<li>Test <code>session.revoke:any</code> → không được phép thu hồi phiên tenant khác</li>
<li>Test <code>auth.token.revoked</code> → emit event đúng metadata</li>
</ul>
<hr/>
<h3 id="74-tich-hop-cicd">7.4. 🛠 Tích hợp CI/CD<a class="headerlink" href="#74-tich-hop-cicd" title="Permanent link">¶</a></h3>
<ul>
<li>Mỗi PR bắt buộc chạy test schema → không cho phép thay đổi <code>ErrorEnvelope</code>, <code>ResponseMeta</code></li>
<li>Có rule YAML kiểm tra presence của <code>x-required-permission</code>, <code>x-condition</code> trong mỗi path</li>
</ul>
<hr/>
<h3 id="75-tich-hop-observability">7.5. 📡 Tích hợp observability<a class="headerlink" href="#75-tich-hop-observability" title="Permanent link">¶</a></h3>
<ul>
<li>Mỗi request được gán <code>request_id</code> và trace ID để debug xuyên service</li>
<li>Response chuẩn hóa hỗ trợ APM/monitoring như Datadog, Grafana Tempo, OpenTelemetry</li>
</ul>
<blockquote>
<p>✅ Với tài liệu này, đội frontend, backend, QA, và devops đều có thể tự động hoá quá trình kiểm thử và kiểm tra hợp đồng tích hợp xuyên tầng một cách chính xác và hiệu quả.</p>
</blockquote>
<hr/>
<h2 id="8-tai-lieu-lien-quan">8. 📚 Tài liệu liên quan<a class="headerlink" href="#8-tai-lieu-lien-quan" title="Permanent link">¶</a></h2>
<ul>
<li><a href="../data-model/">Data Model</a></li>
<li><a href="../openapi.yaml">OpenAPI Spec</a></li>
<li><a href="../design/">Design</a></li>
</ul>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Trở lại mục lục
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>