
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="T√†i li·ªáu ki·∫øn tr√∫c v√† ph√°t tri·ªÉn cho d·ª± √°n Chuy·ªÉn ƒë·ªïi s·ªë Tr∆∞·ªùng Vi·ªát Anh." name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://ezdesign-vn.github.io/dx-vas/services/token-service/data-model/" rel="canonical"/>
<link href="../../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Token Service - Data Model - DX VAS - Docs</title>
<link href="../../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#token-service-data-model">
          B·ªè qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="ƒê·∫ßu trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Token Service - Data Model
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="T√¨m ki·∫øm" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="T√¨m ki·∫øm" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="T√¨m ki·∫øm" class="md-search__options">
<button aria-label="Xo√°" class="md-search__icon md-icon" tabindex="-1" title="Xo√°" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem m√£ ngu·ªìn">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../architecture/system-diagrams/">
          
  
  
    
  
  Ki·∫øn tr√∫c H·ªá th·ªëng

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../dev-guide/">
        
  
  
    
  
  H∆∞·ªõng d·∫´n Ph√°t tri·ªÉn

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../">
        
  
  
    
  
  Thi·∫øt k·∫ø Services

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../ADR/">
          
  
  
    
  
  Quy·∫øt ƒë·ªãnh Ki·∫øn tr√∫c (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh ƒëi·ªÅu h∆∞·ªõng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem m√£ ngu·ªìn">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Ki·∫øn tr√∫c H·ªá th·ªëng
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Ki·∫øn tr√∫c H·ªá th·ªëng
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/system-diagrams/">
<span class="md-ellipsis">
    S∆° ƒë·ªì H·ªá th·ªëng
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/rbac-deep-dive/">
<span class="md-ellipsis">
    RBAC Chi ti·∫øt
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../dev-guide/">
<span class="md-ellipsis">
    H∆∞·ªõng d·∫´n Ph√°t tri·ªÉn
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    Thi·∫øt k·∫ø Services
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ADR/">
<span class="md-ellipsis">
    Quy·∫øt ƒë·ªãnh Ki·∫øn tr√∫c (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quy·∫øt ƒë·ªãnh Ki·∫øn tr√∫c (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="M·ª•c l·ª•c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      M·ª•c l·ª•c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-pham-vi-du-lieu-quan-ly-scope">
<span class="md-ellipsis">
      1. Ph·∫°m vi D·ªØ li·ªáu Qu·∫£n l√Ω (Scope)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-ngoai-pham-vi-out-of-scope">
<span class="md-ellipsis">
      2. Ngo√†i Ph·∫°m Vi (Out of Scope)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-muc-tieu-cua-tai-lieu-mo-hinh-du-lieu">
<span class="md-ellipsis">
      3. M·ª•c ti√™u c·ªßa T√†i li·ªáu M√¥ h√¨nh D·ªØ li·ªáu
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-so-o-erd-entity-relationship-diagram">
<span class="md-ellipsis">
      4. S∆° ƒë·ªì ERD (Entity Relationship Diagram)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-chi-tiet-tung-bang">
<span class="md-ellipsis">
      5. Chi ti·∫øt T·ª´ng B·∫£ng
    </span>
</a>
<nav aria-label="5. Chi ti·∫øt T·ª´ng B·∫£ng" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-bang-jwks_keys">
<span class="md-ellipsis">
      5.1 B·∫£ng jwks_keys
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-bang-auth_sessions">
<span class="md-ellipsis">
      5.2 B·∫£ng auth_sessions
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-bang-revoked_tokens">
<span class="md-ellipsis">
      5.3 B·∫£ng revoked_tokens
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#54-bang-token_stats">
<span class="md-ellipsis">
      5.4 B·∫£ng token_stats
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-indexes-constraints">
<span class="md-ellipsis">
      6. Indexes &amp; Constraints
    </span>
</a>
<nav aria-label="6. Indexes &amp; Constraints" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#chi-tiet-best-practices">
<span class="md-ellipsis">
      Chi ti·∫øt &amp; Best Practices
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-chinh-sach-luu-tru-xoa-du-lieu">
<span class="md-ellipsis">
      7. Ch√≠nh s√°ch L∆∞u tr·ªØ &amp; X√≥a D·ªØ li·ªáu
    </span>
</a>
<nav aria-label="7. Ch√≠nh s√°ch L∆∞u tr·ªØ &amp; X√≥a D·ªØ li·ªáu" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-ttl-job-purge">
<span class="md-ellipsis">
      7.1 TTL &amp; Job Purge
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-audit-event-notification">
<span class="md-ellipsis">
      7.2 Audit &amp; Event Notification
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-hard-delete-rollback">
<span class="md-ellipsis">
      7.3 Hard-Delete &amp; Rollback
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-kiem-soat-giam-sat">
<span class="md-ellipsis">
      7.4 Ki·ªÉm so√°t &amp; Gi√°m s√°t
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-data-synchronization-events">
<span class="md-ellipsis">
      8. Data Synchronization &amp; Events
    </span>
</a>
<nav aria-label="8. Data Synchronization &amp; Events" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-pubsub-topic-event-names">
<span class="md-ellipsis">
      8.1 Pub/Sub Topic &amp; Event Names
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-json-schema-registry">
<span class="md-ellipsis">
      8.2 JSON Schema &amp; Registry
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-payload-examples">
<span class="md-ellipsis">
      8.3 Payload Examples
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#84-consumers-subscriptions">
<span class="md-ellipsis">
      8.4 Consumers &amp; Subscriptions
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#85-delivery-semantics-ordering">
<span class="md-ellipsis">
      8.5 Delivery Semantics &amp; Ordering
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#86-governance-versioning">
<span class="md-ellipsis">
      8.6 Governance &amp; Versioning
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-data-access-control">
<span class="md-ellipsis">
      9. Data Access Control
    </span>
</a>
<nav aria-label="9. Data Access Control" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#91-authentication-database-users">
<span class="md-ellipsis">
      9.1 Authentication &amp; Database Users
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#92-network-encryption">
<span class="md-ellipsis">
      9.2 Network &amp; Encryption
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#93-privilege-matrix-least-privilege">
<span class="md-ellipsis">
      9.3 Privilege Matrix (Least Privilege)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-mo-rong-trong-tuong-lai">
<span class="md-ellipsis">
      10. M·ªü r·ªông trong T∆∞∆°ng lai
    </span>
</a>
<nav aria-label="10. M·ªü r·ªông trong T∆∞∆°ng lai" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#101-embedded-rbac-claims">
<span class="md-ellipsis">
      10.1 Embedded RBAC Claims
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#102-key-usage-logging">
<span class="md-ellipsis">
      10.2 Key Usage Logging
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#103-partitioning-sharding">
<span class="md-ellipsis">
      10.3 Partitioning &amp; Sharding
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#104-cross-region-replication">
<span class="md-ellipsis">
      10.4 Cross-Region Replication
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#105-real-time-analytics-feed">
<span class="md-ellipsis">
      10.5 Real-time Analytics Feed
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#106-audit-history-versioning">
<span class="md-ellipsis">
      10.6 Audit History &amp; Versioning
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-enums">
<span class="md-ellipsis">
      11. ENUMs
    </span>
</a>
<nav aria-label="11. ENUMs" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#111-reason-trong-revoked_tokens">
<span class="md-ellipsis">
      11.1 reason trong revoked_tokens
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#112-tuy-chon-event-trong-pubsub">
<span class="md-ellipsis">
      11.2 (T√πy ch·ªçn) event trong Pub/Sub
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#113-best-practices">
<span class="md-ellipsis">
      11.3 Best Practices
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-phu-luc-kiem-thu">
<span class="md-ellipsis">
      12. Ph·ª• l·ª•c Ki·ªÉm th·ª≠
    </span>
</a>
<nav aria-label="12. Ph·ª• l·ª•c Ki·ªÉm th·ª≠" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#121-unit-tests">
<span class="md-ellipsis">
      12.1 Unit Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#122-integration-tests">
<span class="md-ellipsis">
      12.2 Integration Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#123-retention-purge-tests">
<span class="md-ellipsis">
      12.3 Retention &amp; Purge Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#124-performance-tests">
<span class="md-ellipsis">
      12.4 Performance Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#125-security-privilege-tests">
<span class="md-ellipsis">
      12.5 Security &amp; Privilege Tests
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#126-concurrency-consistency">
<span class="md-ellipsis">
      12.6 Concurrency &amp; Consistency
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#127-cicd-integration">
<span class="md-ellipsis">
      12.7 CI/CD Integration
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#13-lien-ket-tai-lieu">
<span class="md-ellipsis">
      13. üìö Li√™n k·∫øt T√†i li·ªáu
    </span>
</a>
<nav aria-label="13. üìö Li√™n k·∫øt T√†i li·ªáu" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cac-quyet-inh-kien-truc-adr">
<span class="md-ellipsis">
      üîñ C√°c Quy·∫øt ƒë·ªãnh Ki·∫øn tr√∫c (ADR)
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="token-service-data-model">üóÉÔ∏è Token Service - Data Model<a class="headerlink" href="#token-service-data-model" title="Permanent link">¬∂</a></h1>
<!-- toc -->
<blockquote>
<p><strong>Token Service</strong> l√† th√†nh ph·∫ßn trung t√¢m trong ki·∫øn tr√∫c DX-VAS, ch·ªãu tr√°ch nhi·ªám qu·∫£n l√Ω c√°c d·ªØ li·ªáu sau:
- <strong>JWKS keys</strong> (<code>jwks_keys</code>) ‚Äì l∆∞u metadata key ƒë·ªÉ API Gateway x√°c th·ª±c JWT offline (RS256) theo ADR-006.<br/>
- <strong>Auth sessions</strong> (<code>auth_sessions</code>) ‚Äì session_id, user_id, tenant_id, TTL refresh token.<br/>
- <strong>Revoked tokens</strong> (<code>revoked_tokens</code>) ‚Äì jti, tenant_id, revoked_at, reason (CR-03).<br/>
- <strong>Token stats</strong> (<code>token_stats</code>) ‚Äì latency, ip_address, device, ch·ªâ khi <code>enable_token_stats=true</code>.  </p>
</blockquote>
<hr/>
<h2 id="1-pham-vi-du-lieu-quan-ly-scope">1. Ph·∫°m vi D·ªØ li·ªáu Qu·∫£n l√Ω (Scope)<a class="headerlink" href="#1-pham-vi-du-lieu-quan-ly-scope" title="Permanent link">¬∂</a></h2>
<p><strong>Token Service</strong> qu·∫£n l√Ω d·ªØ li·ªáu li√™n quan ƒë·∫øn lu·ªìng ph√°t h√†nh, thu h·ªìi v√† introspect JWT, bao g·ªìm:
- C·∫•u h√¨nh v√† metadata JWKS.
- L·ªãch s·ª≠ phi√™n (session) cho refresh token.
- Danh s√°ch token ƒë√£ b·ªã thu h·ªìi ƒë·ªÉ ch·∫∑n offline.
- Th·ªëng k√™ (tu·ª≥ ch·ªçn) cho m·ªói token (latency, IP, v.v.).</p>
<h2 id="2-ngoai-pham-vi-out-of-scope">2. Ngo√†i Ph·∫°m Vi (Out of Scope)<a class="headerlink" href="#2-ngoai-pham-vi-out-of-scope" title="Permanent link">¬∂</a></h2>
<p><strong>Token Service</strong> <strong>kh√¥ng</strong> qu·∫£n l√Ω:
- ‚ùå Th√¥ng tin ng∆∞·ªùi d√πng / role / permission (thu·ªôc User Service).<br/>
- ‚ùå D·ªØ li·ªáu SMS / Email (thu·ªôc Notification Service).<br/>
- ‚ùå L·ªãch s·ª≠ audit chi ti·∫øt ngo√†i c√°c s·ª± ki·ªán token.*.v1 (ƒë√£ publish Pub/Sub).</p>
<h2 id="3-muc-tieu-cua-tai-lieu-mo-hinh-du-lieu">3. M·ª•c ti√™u c·ªßa T√†i li·ªáu M√¥ h√¨nh D·ªØ li·ªáu<a class="headerlink" href="#3-muc-tieu-cua-tai-lieu-mo-hinh-du-lieu" title="Permanent link">¬∂</a></h2>
<ul>
<li>M√¥ t·∫£ chi ti·∫øt c·∫•u tr√∫c b·∫£ng ph·ª•c v·ª• Issuance, Revocation, Introspection.  </li>
<li>Th·ªÉ hi·ªán r√µ r√†ng r√†ng bu·ªôc PK/FK, index, ENUM (n·∫øu c√≥).  </li>
<li>ƒê·∫£m b·∫£o tu√¢n th·ªß c√°c ADR quan tr·ªçng:  </li>
<li>ADR-023 (Schema Migration Strategy)  </li>
<li>ADR-024 (Data Anonymization &amp; Retention)  </li>
<li>ADR-026 (Hard Delete Policy)  </li>
</ul>
<hr/>
<h2 id="4-so-o-erd-entity-relationship-diagram">4. S∆° ƒë·ªì ERD (Entity Relationship Diagram)<a class="headerlink" href="#4-so-o-erd-entity-relationship-diagram" title="Permanent link">¬∂</a></h2>
<p><strong>S∆° ƒë·ªì s∆° b·ªô</strong></p>
<pre class="mermaid"><code>erDiagram
  jwks_keys {
    UUID kid PK
    JSON public_key
    BOOLEAN active
    TIMESTAMPTZ created_at
    TIMESTAMPTZ rotated_at
  }
  auth_sessions {
    UUID session_id PK
    UUID user_id
    TEXT tenant_id
    TIMESTAMPTZ created_at
    TIMESTAMPTZ last_active_at
  }
  revoked_tokens {
    UUID jti PK
    TEXT tenant_id
    TIMESTAMPTZ revoked_at
    TEXT reason
    UUID revoked_by
  }
  token_stats {
    UUID stat_id PK
    UUID jti FK
    INTEGER latency_ms
    TEXT ip_address
    JSON device_info
    TIMESTAMPTZ recorded_at
  }

  jwks_keys ||--o{ auth_sessions : "signs sessions"
  auth_sessions ||--o{ revoked_tokens : "may be revoked"
  revoked_tokens ||--o| token_stats : "0..1 stats"
</code></pre>
<blockquote>
<p><strong>Ch√∫ th√≠ch:</strong></p>
<ul>
<li><code>revoked_tokens ‚Üí token_stats</code> l√† quan h·ªá 1-to-0..1 (m·ªôt revoke c√≥ th·ªÉ kh√¥ng c√≥ stat).</li>
<li><code>jwks_keys.active</code> ch·ªâ one-hot active key; c√°c key c≈© gi·ªØ ƒë·ªÉ verify until TTL.</li>
</ul>
</blockquote>
<p><strong>S∆° ƒë·ªì ERD chi ti·∫øt</strong></p>
<pre class="mermaid"><code>erDiagram
  jwks_keys {
    UUID    kid PK              "Key ID"
    JSONB   public_key NOT_NULL JWK public key
    BOOLEAN active DEFAULT FALSE
    TIMESTAMPTZ created_at NOT_NULL DEFAULT now()
    TIMESTAMPTZ rotated_at NOT_NULL
  }
  auth_sessions {
    UUID        session_id PK           "Session ID (refresh token)"
    UUID        user_id NOT_NULL        Global user_id
    TEXT        tenant_id NOT_NULL      "Tenant context"
    TIMESTAMPTZ created_at NOT_NULL DEFAULT now()
    TIMESTAMPTZ last_active_at DEFAULT now() NOT_NULL
  }
  revoked_tokens {
    UUID        jti PK                  "JWT ID"
    TEXT        tenant_id NOT_NULL
    TIMESTAMPTZ revoked_at NOT_NULL DEFAULT now()
    TEXT        reason
    UUID        revoked_by
  }
  token_stats {
    UUID    stat_id PK                  "Stats record ID"
    UUID    jti FK NOT_NULL             References "revoked_tokens.jti"
    INT     latency_ms NOT_NULL
    TEXT    ip_address
    JSONB   device_info
    TIMESTAMPTZ recorded_at NOT_NULL DEFAULT now()
  }

  jwks_keys   ||--o{ auth_sessions   : "signs sessions"
  auth_sessions ||--o{ revoked_tokens  : "may be revoked"
  revoked_tokens ||--o| token_stats    : "0..1 stats"
</code></pre>
<blockquote>
<p><strong>Ch√∫ th√≠ch &amp; Best Practices</strong></p>
<ul>
<li>
<p><strong>Cardinality</strong></p>
</li>
<li>
<p><code>jwks_keys (1) ‚Üí auth_sessions (0..*)</code> ‚Äì m·ªôt key c√≥ th·ªÉ sign nhi·ªÅu phi√™n.</p>
</li>
<li><code>auth_sessions (1) ‚Üí revoked_tokens (0..*)</code> ‚Äì kh√¥ng ph·∫£i m·ªçi session ƒë·ªÅu b·ªã revoke.</li>
<li><code>revoked_tokens (1) ‚Üí token_stats (0..1)</code> ‚Äì stats ch·ªâ sinh khi <code>enable_token_stats=true</code>.</li>
<li>
<p><strong>Indexes</strong></p>
</li>
<li>
<p><code>jwks_keys(active)</code> for fast lookup of current key.</p>
</li>
<li><code>auth_sessions(user_id, tenant_id)</code> for session validation.</li>
<li><code>revoked_tokens(tenant_id)</code> ƒë·ªÉ Gateway check revoked nhanh.</li>
<li>
<p><strong>Retention &amp; Delete</strong></p>
</li>
<li>
<p><code>jwks_keys</code>: gi·ªØ 30 ng√†y sau rotation ‚Üí Cron purge (ADR-024/026).</p>
</li>
<li><code>revoked_tokens</code>: TTL 30d ‚Üí auto-purge (ADR-024/026).</li>
<li><code>token_stats</code>: TTL 90d ‚Üí anonymize &amp; delete (ADR-024).</li>
</ul>
</blockquote>
<hr/>
<h2 id="5-chi-tiet-tung-bang">5. Chi ti·∫øt T·ª´ng B·∫£ng<a class="headerlink" href="#5-chi-tiet-tung-bang" title="Permanent link">¬∂</a></h2>
<h3 id="51-bang-jwks_keys">5.1 B·∫£ng <code>jwks_keys</code><a class="headerlink" href="#51-bang-jwks_keys" title="Permanent link">¬∂</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">jwks_keys</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="n">kid</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="n">public_key</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="n">active</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">FALSE</span><span class="p">,</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">(),</span>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="n">rotated_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="p">);</span>
</span></code></pre></div>
<table>
<thead>
<tr>
<th>C·ªôt</th>
<th>Ki·ªÉu d·ªØ li·ªáu</th>
<th>R√†ng bu·ªôc</th>
<th>Default</th>
<th>M√¥ t·∫£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kid</code></td>
<td><code>UUID</code></td>
<td><code>PRIMARY KEY</code></td>
<td></td>
<td>Key ID, kh·ªõp JWT header <code>kid</code></td>
</tr>
<tr>
<td><code>public_key</code></td>
<td><code>JSONB</code></td>
<td><code>NOT NULL</code></td>
<td></td>
<td>JWK Public Key</td>
</tr>
<tr>
<td><code>active</code></td>
<td><code>BOOLEAN</code></td>
<td><code>NOT NULL</code></td>
<td><code>FALSE</code></td>
<td>True n·∫øu ƒëang d√πng ƒë·ªÉ verify</td>
</tr>
<tr>
<td><code>created_at</code></td>
<td><code>TIMESTAMPTZ</code></td>
<td><code>NOT NULL</code></td>
<td><code>now()</code></td>
<td>Th·ªùi ƒëi·ªÉm t·∫°o key</td>
</tr>
<tr>
<td><code>rotated_at</code></td>
<td><code>TIMESTAMPTZ</code></td>
<td></td>
<td></td>
<td>Th·ªùi ƒëi·ªÉm key ƒë∆∞·ª£c rotate l·∫ßn cu·ªëi</td>
</tr>
</tbody>
</table>
<h4 id="indexes-constraints">Indexes &amp; Constraints<a class="headerlink" href="#indexes-constraints" title="Permanent link">¬∂</a></h4>
<ul>
<li><strong>Primary Key:</strong> <code>pk_jwks_keys</code> on <code>(kid)</code></li>
<li><strong>Unique Constraint:</strong> <code>uq_jwks_keys_active</code> on <code>(active)</code> ‚Äì ch·ªâ m·ªôt key ƒë∆∞·ª£c active t·∫°i m·ªôt th·ªùi ƒëi·ªÉm</li>
<li><strong>B-tree Index:</strong> <code>idx_jwks_created_at</code> on <code>(created_at)</code> ‚Äì t·ªëi ∆∞u truy v·∫•n key m·ªõi nh·∫•t</li>
</ul>
<h3 id="52-bang-auth_sessions">5.2 B·∫£ng <code>auth_sessions</code><a class="headerlink" href="#52-bang-auth_sessions" title="Permanent link">¬∂</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">auth_sessions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="n">session_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="n">user_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="n">tenant_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="n">created_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">(),</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="n">last_active_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">()</span>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="p">);</span>
</span></code></pre></div>
<table>
<thead>
<tr>
<th>C·ªôt</th>
<th>Ki·ªÉu d·ªØ li·ªáu</th>
<th>R√†ng bu·ªôc</th>
<th>Default</th>
<th>M√¥ t·∫£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>session_id</code></td>
<td><code>UUID</code></td>
<td><code>PRIMARY KEY</code></td>
<td></td>
<td>ID phi√™n d√πng cho refresh token</td>
</tr>
<tr>
<td><code>user_id</code></td>
<td><code>UUID</code></td>
<td><code>NOT NULL</code></td>
<td></td>
<td><code>user_id_global</code> t·ª´ User Service</td>
</tr>
<tr>
<td><code>tenant_id</code></td>
<td><code>TEXT</code></td>
<td><code>NOT NULL</code></td>
<td></td>
<td>Tenant context</td>
</tr>
<tr>
<td><code>created_at</code></td>
<td><code>TIMESTAMPTZ</code></td>
<td><code>NOT NULL</code></td>
<td><code>now()</code></td>
<td>Th·ªùi ƒëi·ªÉm phi√™n ƒë∆∞·ª£c t·∫°o</td>
</tr>
<tr>
<td><code>last_active_at</code></td>
<td><code>TIMESTAMPTZ</code></td>
<td><code>NOT NULL</code></td>
<td><code>now()</code></td>
<td>Th·ªùi ƒëi·ªÉm phi√™n ho·∫°t ƒë·ªông cu·ªëi c√πng</td>
</tr>
</tbody>
</table>
<h4 id="indexes-constraints_1">Indexes &amp; Constraints<a class="headerlink" href="#indexes-constraints_1" title="Permanent link">¬∂</a></h4>
<ul>
<li><strong>Primary Key:</strong> <code>pk_auth_sessions</code> tr√™n (<code>session_id</code>)</li>
<li><strong>B-tree Index:</strong> <code>idx_auth_sessions_user_tenant</code> tr√™n (<code>user_id</code>, <code>tenant_id</code>) ‚Äì t·ªëi ∆∞u lookup session theo user &amp; tenant</li>
<li><strong>B-tree Index:</strong> <code>idx_auth_sessions_last_active</code> tr√™n (<code>last_active_at</code>) ‚Äì h·ªó tr·ª£ purge phi√™n c≈© v√† th·ªëng k√™ session c√≤n s·ªëng</li>
</ul>
<h3 id="53-bang-revoked_tokens">5.3 B·∫£ng <code>revoked_tokens</code><a class="headerlink" href="#53-bang-revoked_tokens" title="Permanent link">¬∂</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">revoked_tokens</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">  </span><span class="n">jti</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="n">tenant_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-2-4"><a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="n">revoked_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">(),</span>
</span><span id="__span-2-5"><a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="n">reason</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-2-6"><a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="n">revoked_by</span><span class="w"> </span><span class="n">UUID</span>
</span><span id="__span-2-7"><a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="p">);</span>
</span></code></pre></div>
<table>
<thead>
<tr>
<th>C·ªôt</th>
<th>Ki·ªÉu d·ªØ li·ªáu</th>
<th>R√†ng bu·ªôc</th>
<th>Default</th>
<th>M√¥ t·∫£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>jti</code></td>
<td><code>UUID</code></td>
<td><code>PRIMARY KEY</code></td>
<td></td>
<td>JWT ID ƒë·ªÉ thu h·ªìi (claim <code>jti</code>)</td>
</tr>
<tr>
<td><code>tenant_id</code></td>
<td><code>TEXT</code></td>
<td><code>NOT NULL</code></td>
<td></td>
<td>Tenant context</td>
</tr>
<tr>
<td><code>revoked_at</code></td>
<td><code>TIMESTAMPTZ</code></td>
<td><code>NOT NULL</code></td>
<td><code>now()</code></td>
<td>Th·ªùi ƒëi·ªÉm token b·ªã thu h·ªìi</td>
</tr>
<tr>
<td><code>reason</code></td>
<td><code>TEXT</code></td>
<td></td>
<td></td>
<td>L√Ω do (<code>logout</code>, <code>rotation</code>, v.v.)</td>
</tr>
<tr>
<td><code>revoked_by</code></td>
<td><code>UUID</code></td>
<td></td>
<td></td>
<td>ID ng∆∞·ªùi/th·ª±c th·ªÉ th·ª±c hi·ªán revoke</td>
</tr>
</tbody>
</table>
<h4 id="indexes-constraints_2">Indexes &amp; Constraints<a class="headerlink" href="#indexes-constraints_2" title="Permanent link">¬∂</a></h4>
<ul>
<li><strong>Primary Key:</strong> <code>pk_revoked_tokens</code> tr√™n (<code>jti</code>)</li>
<li><strong>B-tree Index:</strong> <code>idx_revoked_tokens_tenant_revoked_at</code> tr√™n (<code>tenant_id</code>, <code>revoked_at</code>) ‚Äì t·ªëi ∆∞u truy v·∫•n v√† purge theo tenant &amp; th·ªùi gian</li>
<li><strong>Check Constraint:</strong> <code>chk_revoked_tokens_reason</code> CHECK (<code>reason</code> IN ('logout','rotation','breach','expired'))</li>
</ul>
<h3 id="54-bang-token_stats">5.4 B·∫£ng <code>token_stats</code><a class="headerlink" href="#54-bang-token_stats" title="Permanent link">¬∂</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">token_stats</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">  </span><span class="n">stat_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">  </span><span class="n">jti</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">revoked_tokens</span><span class="p">(</span><span class="n">jti</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">  </span><span class="n">latency_ms</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-3-5"><a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">  </span><span class="n">ip_address</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-3-6"><a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="n">device_info</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
</span><span id="__span-3-7"><a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">  </span><span class="n">recorded_at</span><span class="w"> </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">()</span>
</span><span id="__span-3-8"><a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="p">);</span>
</span></code></pre></div>
<table>
<thead>
<tr>
<th>C·ªôt</th>
<th>Ki·ªÉu d·ªØ li·ªáu</th>
<th>R√†ng bu·ªôc</th>
<th>Default</th>
<th>M√¥ t·∫£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>stat_id</code></td>
<td><code>UUID</code></td>
<td><code>PRIMARY KEY</code></td>
<td></td>
<td>ID b·∫£n ghi th·ªëng k√™</td>
</tr>
<tr>
<td><code>jti</code></td>
<td><code>UUID</code></td>
<td><code>NOT NULL</code>, FK ‚Üí <code>revoked_tokens(jti)</code></td>
<td></td>
<td>Tham chi·∫øu t·ªõi token ƒë√£ b·ªã thu h·ªìi</td>
</tr>
<tr>
<td><code>latency_ms</code></td>
<td><code>INTEGER</code></td>
<td><code>NOT NULL</code></td>
<td></td>
<td>Th·ªùi gian (ms) th·ª±c hi·ªán issuance/revoke</td>
</tr>
<tr>
<td><code>ip_address</code></td>
<td><code>TEXT</code></td>
<td></td>
<td></td>
<td>ƒê·ªãa ch·ªâ IP client</td>
</tr>
<tr>
<td><code>device_info</code></td>
<td><code>JSONB</code></td>
<td></td>
<td></td>
<td>Th√¥ng tin thi·∫øt b·ªã (type, user_agent, phi√™n b·∫£n)</td>
</tr>
<tr>
<td><code>recorded_at</code></td>
<td><code>TIMESTAMPTZ</code></td>
<td><code>NOT NULL</code></td>
<td><code>now()</code></td>
<td>Th·ªùi ƒëi·ªÉm ghi nh·∫≠n th·ªëng k√™</td>
</tr>
</tbody>
</table>
<h4 id="indexes-constraints_3">Indexes &amp; Constraints<a class="headerlink" href="#indexes-constraints_3" title="Permanent link">¬∂</a></h4>
<ul>
<li><strong>Primary Key:</strong> <code>pk_token_stats</code> tr√™n (<code>stat_id</code>)</li>
<li><strong>Foreign Key:</strong> <code>fk_token_stats_revoked</code></li>
</ul>
<p><div class="language-sql highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">token_stats</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">fk_token_stats_revoked</span>
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">jti</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">revoked_tokens</span><span class="p">(</span><span class="n">jti</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">;</span>
</span></code></pre></div>
* <strong>B-tree Index:</strong> <code>idx_token_stats_jti_recorded</code> tr√™n (<code>jti</code>, <code>recorded_at</code>) ‚Äì t·ªëi ∆∞u lookup stats cho m·ªói token v√† purge theo th·ªùi gian</p>
<hr/>
<h2 id="6-indexes-constraints">6. Indexes &amp; Constraints<a class="headerlink" href="#6-indexes-constraints" title="Permanent link">¬∂</a></h2>
<p>ƒê·ªÉ ƒë·∫£m b·∫£o hi·ªáu nƒÉng truy v·∫•n v√† t√≠nh to√†n v·∫πn d·ªØ li·ªáu, m·ªói b·∫£ng trong Token Service ƒë∆∞·ª£c trang b·ªã c√°c ch·ªâ m·ª•c (index) v√† r√†ng bu·ªôc (constraint) nh∆∞ sau:</p>
<table>
<thead>
<tr>
<th>B·∫£ng</th>
<th>T√™n Index / Constraint</th>
<th>Lo·∫°i</th>
<th>ƒê·ªãnh nghƒ©a</th>
<th>M·ª•c ƒë√≠ch</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>jwks_keys</strong></td>
<td><code>pk_jwks_keys</code></td>
<td>Primary Key</td>
<td><code>(kid)</code></td>
<td>ƒê·∫£m b·∫£o <code>kid</code> l√† duy nh·∫•t, d√πng l√†m PK</td>
</tr>
<tr>
<td></td>
<td><code>uq_jwks_keys_active</code></td>
<td>Unique Constraint</td>
<td><code>(active)</code></td>
<td>Ch·ªâ m·ªôt public key ƒë∆∞·ª£c ƒë√°nh d·∫•u <code>active = TRUE</code></td>
</tr>
<tr>
<td></td>
<td><code>idx_jwks_created_at</code></td>
<td>B-tree Index</td>
<td><code>(created_at)</code></td>
<td>T√¨m key m·ªõi nh·∫•t khi rotate</td>
</tr>
<tr>
<td><strong>auth_sessions</strong></td>
<td><code>pk_auth_sessions</code></td>
<td>Primary Key</td>
<td><code>(session_id)</code></td>
<td>ƒê·ªãnh danh phi√™n</td>
</tr>
<tr>
<td></td>
<td><code>idx_auth_sessions_user_tenant</code></td>
<td>B-tree Index</td>
<td><code>(user_id, tenant_id)</code></td>
<td>Lookup sessions theo ng∆∞·ªùi d√πng &amp; tenant</td>
</tr>
<tr>
<td></td>
<td><code>idx_auth_sessions_last_active</code></td>
<td>B-tree Index</td>
<td><code>(last_active_at)</code></td>
<td>X√≥a session c≈©, th·ªëng k√™ session c√≤n ‚Äús·ªëng‚Äù</td>
</tr>
<tr>
<td><strong>revoked_tokens</strong></td>
<td><code>pk_revoked_tokens</code></td>
<td>Primary Key</td>
<td><code>(jti)</code></td>
<td>ƒê·ªãnh danh token b·ªã thu h·ªìi</td>
</tr>
<tr>
<td></td>
<td><code>idx_revoked_tokens_tenant_at</code></td>
<td>B-tree Index</td>
<td><code>(tenant_id, revoked_at)</code></td>
<td>T√¨m tokens ƒë√£ thu h·ªìi theo tenant v√† th·ªùi gian, t·ªëi ∆∞u purge job</td>
</tr>
<tr>
<td></td>
<td><code>chk_revoked_tokens_reason</code></td>
<td>Check Constraint</td>
<td><code>reason IN ('logout','rotation','breach','expired')</code></td>
<td>Gi·ªõi h·∫°n gi√° tr·ªã <code>reason</code> theo ENUM</td>
</tr>
<tr>
<td><strong>token_stats</strong></td>
<td><code>pk_token_stats</code></td>
<td>Primary Key</td>
<td><code>(stat_id)</code></td>
<td>ƒê·ªãnh danh record th·ªëng k√™</td>
</tr>
<tr>
<td></td>
<td><code>fk_token_stats_revoked_tokens</code></td>
<td>Foreign Key</td>
<td><code>(jti) REFERENCES revoked_tokens(jti) ON DELETE CASCADE</code></td>
<td>ƒê·∫£m b·∫£o m·ªói stat li√™n k·∫øt t·ªõi m·ªôt revoked token</td>
</tr>
<tr>
<td></td>
<td><code>idx_token_stats_jti_recorded</code></td>
<td>B-tree Index</td>
<td><code>(jti, recorded_at)</code></td>
<td>Lookup stats cho m·ªôt token v√† purge theo th·ªùi gian</td>
</tr>
</tbody>
</table>
<h3 id="chi-tiet-best-practices">Chi ti·∫øt &amp; Best Practices<a class="headerlink" href="#chi-tiet-best-practices" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>Primary Key &amp; Unique</strong>:  </li>
<li>PK ƒë·∫∑t tr√™n c·ªôt ƒë·ªãnh danh duy nh·∫•t (<code>kid</code>, <code>session_id</code>, <code>jti</code>, <code>stat_id</code>).  </li>
<li>
<p>Unique cho <code>jwks_keys.active</code> ƒë·ªÉ ch·ªâ 1 key ƒë∆∞·ª£c active.</p>
</li>
<li>
<p><strong>B-tree Index</strong>:  </p>
</li>
<li>D√πng cho c·ªôt th∆∞·ªùng xuy√™n filter/sort: <code>created_at</code>, <code>last_active_at</code>, <code>revoked_at</code>, <code>recorded_at</code>.  </li>
<li>
<p>Composite index <code>(user_id, tenant_id)</code> gi√∫p t√¨m session theo tenant nhanh.</p>
</li>
<li>
<p><strong>Check Constraint</strong>:  </p>
</li>
<li>
<p>S·ª≠ d·ª•ng <code>CHECK</code> ƒë·ªÉ validate ENUM-like (<code>reason</code>), kh√¥ng ph·ª• thu·ªôc ENUM type DB, gi·ªØ t√≠nh di ƒë·ªông.</p>
</li>
<li>
<p><strong>Foreign Key</strong>:  </p>
</li>
<li>
<p><code>token_stats.jti</code> tham chi·∫øu <code>revoked_tokens.jti</code> v·ªõi <code>ON DELETE CASCADE</code> ƒë·ªÉ t·ª± cleanup stats khi token b·ªã x√≥a.</p>
</li>
<li>
<p><strong>Retention &amp; Purge</strong>:  </p>
</li>
<li>C√°c cron/job purge d·ª±a tr√™n ch·ªâ m·ª•c <code>(tenant_id, revoked_at)</code> v√† <code>(jti, recorded_at)</code> ƒë·ªÉ x√≥a d·ªØ li·ªáu qu√° h·∫°n nhanh.</li>
</ul>
<blockquote>
<p>C√°c t√™n index/constraint tu√¢n chu·∫©n <strong>5‚òÖ Data Model Standard</strong>: c√≥ prefix t∆∞∆°ng ·ª©ng b·∫£ng, r√µ r√†ng lo·∫°i index, d·ªÖ tra c·ª©u khi debugging v√† tuning.</p>
</blockquote>
<hr/>
<h2 id="7-chinh-sach-luu-tru-xoa-du-lieu">7. Ch√≠nh s√°ch L∆∞u tr·ªØ &amp; X√≥a D·ªØ li·ªáu<a class="headerlink" href="#7-chinh-sach-luu-tru-xoa-du-lieu" title="Permanent link">¬∂</a></h2>
<blockquote>
<p>Tu√¢n theo ADR-024 (Data Anonymization &amp; Retention) v√† ADR-026 (Hard-Delete Policy), m·ªçi d·ªØ li·ªáu c≈© ƒë·ªÅu ƒë∆∞·ª£c x√≥a ho·∫∑c ·∫©n danh theo TTL ƒë·ªãnh s·∫µn.</p>
</blockquote>
<h3 id="71-ttl-job-purge">7.1 TTL &amp; Job Purge<a class="headerlink" href="#71-ttl-job-purge" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>B·∫£ng</th>
<th>TTL</th>
<th>Job</th>
<th>T·∫ßn su·∫•t</th>
<th>H√†nh ƒë·ªông</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>jwks_keys</code></td>
<td>30 ng√†y k·ªÉ t·ª´ <code>rotated_at</code></td>
<td><code>purge_jwks_keys</code></td>
<td>H√†ng ng√†y 02:00 UTC</td>
<td><code>DELETE FROM jwks_keys WHERE rotated_at &lt; now() - INTERVAL '30 days';</code></td>
</tr>
<tr>
<td><code>auth_sessions</code></td>
<td>14 ng√†y k·ªÉ t·ª´ <code>last_active_at</code></td>
<td><code>purge_auth_sessions</code></td>
<td>H√†ng gi·ªù</td>
<td><code>DELETE FROM auth_sessions WHERE last_active_at &lt; now() - INTERVAL '14 days';</code></td>
</tr>
<tr>
<td><code>revoked_tokens</code></td>
<td>30 ng√†y k·ªÉ t·ª´ <code>revoked_at</code></td>
<td><code>purge_revoked_tokens</code></td>
<td>H√†ng ng√†y 03:00 UTC</td>
<td><code>DELETE FROM revoked_tokens WHERE revoked_at &lt; now() - INTERVAL '30 days';</code></td>
</tr>
<tr>
<td><code>token_stats</code></td>
<td>90 ng√†y k·ªÉ t·ª´ <code>recorded_at</code></td>
<td><code>anonymize_token_stats</code> &amp; <code>purge_token_stats</code></td>
<td>H√†ng ng√†y 04:00 UTC</td>
<td>1) <code>UPDATE token_stats SET ip_address = NULL, device_info = NULL WHERE recorded_at &lt; now() - INTERVAL '90 days';</code><br/>2) <code>DELETE FROM token_stats WHERE recorded_at &lt; now() - INTERVAL '90 days';</code></td>
</tr>
</tbody>
</table>
<h3 id="72-audit-event-notification">7.2 Audit &amp; Event Notification<a class="headerlink" href="#72-audit-event-notification" title="Permanent link">¬∂</a></h3>
<ul>
<li>M·ªói job purge/anonymize ghi v√†o b·∫£ng <code>audit_log.purge_history</code> (schema v1: <code>resource</code>, <code>deleted_count</code>, <code>run_at</code>, <code>initiator='system'</code>).  </li>
<li>Sau khi ho√†n th√†nh, ph√°t s·ª± ki·ªán <strong><code>data.purged.v1</code></strong> l√™n Pub/Sub topic <code>data.v1</code> v·ªõi payload:
<div class="language-json highlight"><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-5-2"><a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="nt">"event"</span><span class="p">:</span><span class="w"> </span><span class="s2">"data.purged.v1"</span><span class="p">,</span>
</span><span id="__span-5-3"><a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="nt">"resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"revoked_tokens"</span><span class="p">,</span>
</span><span id="__span-5-4"><a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="nt">"deleted_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">12345</span><span class="p">,</span>
</span><span id="__span-5-5"><a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-09T02:00:00Z"</span>
</span><span id="__span-5-6"><a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div></li>
</ul>
<h3 id="73-hard-delete-rollback">7.3 Hard-Delete &amp; Rollback<a class="headerlink" href="#73-hard-delete-rollback" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>Hard-Delete</strong>: Kh√¥ng c√≥ c∆° ch·∫ø soft-delete‚Äîd·ªØ li·ªáu v∆∞·ª£t TTL b·ªã x√≥a vƒ©nh vi·ªÖn.</li>
<li><strong>Undo Migration</strong>: N·∫øu c·∫ßn kh√¥i ph·ª•c, s·ª≠ d·ª•ng Flyway <code>U20250617__recreate_revoked_tokens.sql</code> (ADR-023).</li>
</ul>
<h3 id="74-kiem-soat-giam-sat">7.4 Ki·ªÉm so√°t &amp; Gi√°m s√°t<a class="headerlink" href="#74-kiem-soat-giam-sat" title="Permanent link">¬∂</a></h3>
<ul>
<li>
<p>Job purge/anonymize ph·∫£i log metric:</p>
</li>
<li>
<p><code>purge_revoked_tokens_count</code></p>
</li>
<li><code>purge_auth_sessions_count</code></li>
<li><code>anonymize_token_stats_count</code></li>
<li>Alert n·∫øu job th·∫•t b·∫°i ho·∫∑c <code>deleted_count = 0</code> b·∫•t th∆∞·ªùng (k·ªãch b·∫£n d·ªØ li·ªáu qu√° nhi·ªÅu ho·∫∑c qu√° √≠t).</li>
</ul>
<hr/>
<h2 id="8-data-synchronization-events">8. Data Synchronization &amp; Events<a class="headerlink" href="#8-data-synchronization-events" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>M·ª•c ti√™u</strong> ‚Äì Ph√°t h√†nh <strong>s·ª± ki·ªán b·∫•t ƒë·ªìng b·ªô</strong> ƒë·ªÉ c√°c th√†nh ph·∫ßn kh√°c (API Gateway, Audit Service, Monitoring) nh·∫≠n bi·∫øt ngay thay ƒë·ªïi li√™n quan JWT, ƒë·ªìng th·ªùi ƒë·∫£m b·∫£o <strong>ƒë·ªìng nh·∫•t</strong> v√† <strong>c√≥ th·ªÉ m·ªü r·ªông</strong> theo ADR-030.</p>
</blockquote>
<hr/>
<h3 id="81-pubsub-topic-event-names">8.1 Pub/Sub Topic &amp; Event Names<a class="headerlink" href="#81-pubsub-topic-event-names" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>Topic chung</strong>: <code>token.v1</code> </li>
<li><strong>T√™n s·ª± ki·ªán</strong> (theo ADR-030 ‚Äì Event Schema Governance):  </li>
<li><code>token.issued.v1</code> </li>
<li><code>token.revoked.v1</code> </li>
<li><code>token.introspect_fail.v1</code> </li>
</ul>
<blockquote>
<p><em>M·ªói event c√≥ attribute <code>tenant_id</code>, d√πng ƒë·ªÉ </em><em>filter</em><em> fan-out t·ªõi c√°c subscription.</em></p>
</blockquote>
<hr/>
<h3 id="82-json-schema-registry">8.2 JSON Schema &amp; Registry<a class="headerlink" href="#82-json-schema-registry" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Event</th>
<th>Schema ID</th>
<th>Ghi ch√∫</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>token_issued_v1</code></td>
<td><code>token_issued_v1</code></td>
<td>Invariants: <code>jti</code>, <code>session_id</code></td>
</tr>
<tr>
<td><code>token_revoked_v1</code></td>
<td><code>token_revoked_v1</code></td>
<td>Invariants: <code>jti</code>, <code>revoked_by</code></td>
</tr>
<tr>
<td><code>token_introspect_fail_v1</code></td>
<td><code>token_introspect_fail_v1</code></td>
<td>Invariants: <code>token</code>, <code>error</code></td>
</tr>
</tbody>
</table>
<p>Schemas ƒë∆∞·ª£c l∆∞u trong <strong>Schema Registry</strong> (backward-compatible ‚â• 6 th√°ng).</p>
<hr/>
<h3 id="83-payload-examples">8.3 Payload Examples<a class="headerlink" href="#83-payload-examples" title="Permanent link">¬∂</a></h3>
<h4 id="831-tokenissuedv1">8.3.1 <code>token.issued.v1</code><a class="headerlink" href="#831-tokenissuedv1" title="Permanent link">¬∂</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="p">{</span>
</span><span id="__span-6-2"><a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">  </span><span class="nt">"event"</span><span class="p">:</span><span class="w"> </span><span class="s2">"token.issued.v1"</span><span class="p">,</span>
</span><span id="__span-6-3"><a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-09T08:00:00Z"</span><span class="p">,</span>
</span><span id="__span-6-4"><a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"school-xyz"</span><span class="p">,</span>
</span><span id="__span-6-5"><a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user-123"</span><span class="p">,</span>
</span><span id="__span-6-6"><a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">  </span><span class="nt">"jti"</span><span class="p">:</span><span class="w"> </span><span class="s2">"uuid-abc-123"</span><span class="p">,</span>
</span><span id="__span-6-7"><a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">  </span><span class="nt">"session_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sess-456-def"</span><span class="p">,</span>
</span><span id="__span-6-8"><a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">  </span><span class="nt">"ip_address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"203.0.113.5"</span><span class="p">,</span>
</span><span id="__span-6-9"><a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">  </span><span class="nt">"device"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-10"><a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"web"</span><span class="p">,</span>
</span><span id="__span-6-11"><a href="#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="nt">"user_agent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mozilla/5.0"</span>
</span><span id="__span-6-12"><a href="#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-6-13"><a href="#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="832-tokenrevokedv1">8.3.2 <code>token.revoked.v1</code><a class="headerlink" href="#832-tokenrevokedv1" title="Permanent link">¬∂</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-7-1"><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="p">{</span>
</span><span id="__span-7-2"><a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">  </span><span class="nt">"event"</span><span class="p">:</span><span class="w"> </span><span class="s2">"token.revoked.v1"</span><span class="p">,</span>
</span><span id="__span-7-3"><a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-09T09:15:30Z"</span><span class="p">,</span>
</span><span id="__span-7-4"><a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"school-xyz"</span><span class="p">,</span>
</span><span id="__span-7-5"><a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user-123"</span><span class="p">,</span>
</span><span id="__span-7-6"><a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">  </span><span class="nt">"jti"</span><span class="p">:</span><span class="w"> </span><span class="s2">"uuid-abc-123"</span><span class="p">,</span>
</span><span id="__span-7-7"><a href="#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">  </span><span class="nt">"revoked_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin-789"</span><span class="p">,</span>
</span><span id="__span-7-8"><a href="#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">  </span><span class="nt">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"logout"</span><span class="p">,</span>
</span><span id="__span-7-9"><a href="#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">  </span><span class="nt">"ip_address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"203.0.113.5"</span>
</span><span id="__span-7-10"><a href="#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="833-tokenintrospect_failv1">8.3.3 <code>token.introspect_fail.v1</code><a class="headerlink" href="#833-tokenintrospect_failv1" title="Permanent link">¬∂</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="p">{</span>
</span><span id="__span-8-2"><a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">  </span><span class="nt">"event"</span><span class="p">:</span><span class="w"> </span><span class="s2">"token.introspect_fail.v1"</span><span class="p">,</span>
</span><span id="__span-8-3"><a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-09T09:16:00Z"</span><span class="p">,</span>
</span><span id="__span-8-4"><a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"school-xyz"</span><span class="p">,</span>
</span><span id="__span-8-5"><a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">  </span><span class="nt">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eyJhbGciOiJSUzI1NiIs‚Ä¶"</span><span class="p">,</span>
</span><span id="__span-8-6"><a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-7"><a href="#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="nt">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"token.revoked"</span><span class="p">,</span>
</span><span id="__span-8-8"><a href="#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">    </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Token ƒë√£ b·ªã thu h·ªìi"</span>
</span><span id="__span-8-9"><a href="#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-8-10"><a href="#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="p">}</span>
</span></code></pre></div>
<hr/>
<h3 id="84-consumers-subscriptions">8.4 Consumers &amp; Subscriptions<a class="headerlink" href="#84-consumers-subscriptions" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Subscriber</th>
<th>Subscription ID</th>
<th>X·ª≠ l√Ω ch√≠nh</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>API Gateway</strong></td>
<td><code>sub-token-revoked</code></td>
<td>Xo√° cache <code>revoked:{jti}</code> khi nh·∫≠n <code>token.revoked.v1</code></td>
</tr>
<tr>
<td><strong>Audit Logging</strong></td>
<td><code>sub-token-audit</code></td>
<td>Ghi log event v√†o b·∫£ng <code>audit_log.token_events</code></td>
</tr>
<tr>
<td><strong>Monitoring Service</strong></td>
<td><code>sub-token-monitor</code></td>
<td>T√≠nh metrics - hit/miss, latency, fail rates</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>Filter</strong>: subscription l·ªçc attribute <code>tenant_id</code> ƒë·ªÉ ph√¢n v√πng ri√™ng cho m·ªói tenant.</li>
</ul>
<hr/>
<h3 id="85-delivery-semantics-ordering">8.5 Delivery Semantics &amp; Ordering<a class="headerlink" href="#85-delivery-semantics-ordering" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>At-least-once</strong> delivery, idempotent consumers.</li>
<li><strong>Ordering</strong>: Pub/Sub ƒë·∫£m b·∫£o ordering trong c√πng <code>orderingKey=tenant_id</code>.</li>
<li><strong>Retries</strong>: DLQ (Dead-Letter Queue) cho event th·∫•t b·∫°i sau 5 l·∫ßn x·ª≠ l√Ω.</li>
</ul>
<hr/>
<h3 id="86-governance-versioning">8.6 Governance &amp; Versioning<a class="headerlink" href="#86-governance-versioning" title="Permanent link">¬∂</a></h3>
<ul>
<li>M·ªói event t√≠ch h·ª£p field <code>schema_version</code> (m·∫∑c ƒë·ªãnh = 1).</li>
<li>Khi schema thay ƒë·ªïi, tƒÉng suffix: <code>token.issued.v2</code>, gi·ªØ backward-compat trong ‚â• 6 th√°ng.</li>
<li>Theo ADR-030, m·ªçi consumer ph·∫£i ki·ªÉm tra <code>schema_version</code> tr∆∞·ªõc khi deserialize.</li>
</ul>
<hr/>
<h2 id="9-data-access-control">9. Data Access Control<a class="headerlink" href="#9-data-access-control" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>M·ª•c ti√™u</strong> ‚Äì ƒê·∫£m b·∫£o ch·ªâ <strong>Token Service</strong> v√† c√°c th√†nh ph·∫ßn ƒë√£ x√°c th·ª±c m·ªõi ƒë∆∞·ª£c ph√©p truy c·∫≠p d·ªØ li·ªáu, tu√¢n <strong>principle of least privilege</strong> v√† tu√¢n chu·∫©n b·∫£o m·∫≠t m·∫°ng/D·ªØ li·ªáu.</p>
</blockquote>
<h3 id="91-authentication-database-users">9.1 Authentication &amp; Database Users<a class="headerlink" href="#91-authentication-database-users" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>Cloud SQL IAM Authentication</strong> </li>
<li>Admin s·ª≠ d·ª•ng IAM role <code>cloudsql.admin</code> ƒë·ªÉ k·∫øt n·ªëi v·ªõi instance.  </li>
<li><strong>Application user</strong> </li>
<li>T√†i kho·∫£n DB <code>token_service</code> (mapping Workload Identity <code>svc-token-db@dx-vas-core.iam.gserviceaccount.com</code>).  </li>
<li>Kh√¥ng c√≥ quy·ªÅn SUPERUSER.</li>
</ul>
<h3 id="92-network-encryption">9.2 Network &amp; Encryption<a class="headerlink" href="#92-network-encryption" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>K·∫øt n·ªëi Private IP</strong> qua VPC Peering (GKE ‚Üî Cloud SQL).  </li>
<li><strong>SSL/TLS b·∫Øt bu·ªôc</strong>: <code>sslmode=require</code>, verify server cert.  </li>
<li><strong>Firewall</strong> ch·ªâ m·ªü c·ªïng 5432 cho subnet GKE core.</li>
</ul>
<h3 id="93-privilege-matrix-least-privilege">9.3 Privilege Matrix (Least Privilege)<a class="headerlink" href="#93-privilege-matrix-least-privilege" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>DB User</th>
<th>B·∫£ng / Schema</th>
<th>Quy·ªÅn</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>token_service</code></td>
<td><code>jwks_keys</code></td>
<td>SELECT, INSERT, UPDATE</td>
</tr>
<tr>
<td></td>
<td><code>auth_sessions</code></td>
<td>SELECT, INSERT, UPDATE, DELETE</td>
</tr>
<tr>
<td></td>
<td><code>revoked_tokens</code></td>
<td>SELECT, INSERT, DELETE</td>
</tr>
<tr>
<td></td>
<td><code>token_stats</code></td>
<td>SELECT, INSERT, DELETE</td>
</tr>
<tr>
<td></td>
<td><code>audit_log.*</code></td>
<td>INSERT</td>
</tr>
<tr>
<td><strong>DB Admin</strong></td>
<td><strong>T·∫•t c·∫£</strong></td>
<td>ALL PRIVILEGES</td>
</tr>
</tbody>
</table>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1">-- V√≠ d·ª• GRANT trong migration</span>
</span><span id="__span-9-2"><a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="k">INSERT</span><span class="p">,</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">jwks_keys</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">token_service</span><span class="p">;</span>
</span><span id="__span-9-3"><a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="k">INSERT</span><span class="p">,</span><span class="w"> </span><span class="k">UPDATE</span><span class="p">,</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">auth_sessions</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">token_service</span><span class="p">;</span>
</span><span id="__span-9-4"><a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="k">INSERT</span><span class="p">,</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">revoked_tokens</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">token_service</span><span class="p">;</span>
</span><span id="__span-9-5"><a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="k">INSERT</span><span class="p">,</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">token_stats</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">token_service</span><span class="p">;</span>
</span><span id="__span-9-6"><a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="k">GRANT</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">audit_log</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">token_service</span><span class="p">;</span>
</span></code></pre></div>
<hr/>
<h2 id="10-mo-rong-trong-tuong-lai">10. M·ªü r·ªông trong T∆∞∆°ng lai<a class="headerlink" href="#10-mo-rong-trong-tuong-lai" title="Permanent link">¬∂</a></h2>
<blockquote>
<p>ƒê·ªãnh h∆∞·ªõng c√°c c·∫£i ti·∫øn ti·∫øp theo nh·∫±m tƒÉng kh·∫£ nƒÉng quan s√°t, hi·ªáu su·∫•t v√† tu√¢n th·ªß quy m√¥ l·ªõn h∆°n, ƒë·ªìng th·ªùi gi·ªØ v·ªØng t√≠nh m·ªü r·ªông &amp; an to√†n theo <strong>5‚òÖ Data Model Standard</strong> v√† c√°c <strong>ADR</strong> li√™n quan.</p>
</blockquote>
<h3 id="101-embedded-rbac-claims">10.1 Embedded RBAC Claims<a class="headerlink" href="#101-embedded-rbac-claims" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>M·ª•c ti√™u</strong>: Cho ph√©p l∆∞u tr·ª±c ti·∫øp b·∫£ng <code>rbac_claims</code> v√†o JWT ƒë·ªÉ gi·∫£m truy v·∫•n DB/Redis khi ph√¢n quy·ªÅn.  </li>
<li>
<p><strong>Thi·∫øt k·∫ø</strong>:<br>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="w">  </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">token_rbac_claims</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">    </span><span class="n">jti</span><span class="w">            </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">revoked_tokens</span><span class="p">(</span><span class="n">jti</span><span class="p">),</span>
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">    </span><span class="n">rbac_payload</span><span class="w">   </span><span class="n">JSONB</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">        </span><span class="c1">-- roles &amp; perms t·∫°i th·ªùi ƒëi·ªÉm issue</span>
</span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="n">issued_at</span><span class="w">      </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-10-5"><a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">  </span><span class="p">);</span>
</span></code></pre></div></br></p>
</li>
<li>
<p><strong>Constraint &amp; Index</strong>:</p>
</li>
<li>
<p><code>idx_token_rbac_claims_issued_at</code> on <code>(issued_at)</code> cho purge.</p>
</li>
<li><strong>Retention</strong>: TTL 2 ph√∫t (purge nhanh), theo ADR-024.</li>
</ul>
<h3 id="102-key-usage-logging">10.2 Key Usage Logging<a class="headerlink" href="#102-key-usage-logging" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>M·ª•c ti√™u</strong>: Thu th·∫≠p chi ti·∫øt m·ªói l·∫ßn JWKS key signing/verification ƒë·ªÉ ph√¢n t√≠ch v√† audit.</li>
<li><strong>Thi·∫øt k·∫ø</strong>:</li>
</ul>
<p><div class="language-sql highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">key_usage_log</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">  </span><span class="n">log_id</span><span class="w">       </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-11-3"><a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">  </span><span class="n">kid</span><span class="w">          </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">jwks_keys</span><span class="p">(</span><span class="n">kid</span><span class="p">),</span>
</span><span id="__span-11-4"><a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">  </span><span class="k">operation</span><span class="w">    </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="k">operation</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">'sign'</span><span class="p">,</span><span class="s1">'verify'</span><span class="p">)),</span>
</span><span id="__span-11-5"><a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">  </span><span class="n">jti</span><span class="w">          </span><span class="n">UUID</span><span class="p">,</span><span class="w">                    </span><span class="c1">-- n·∫øu operation='sign'</span>
</span><span id="__span-11-6"><a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">  </span><span class="k">timestamp</span><span class="w">    </span><span class="n">TIMESTAMPTZ</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">now</span><span class="p">(),</span>
</span><span id="__span-11-7"><a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">  </span><span class="n">tenant_id</span><span class="w">    </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-11-8"><a href="#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">  </span><span class="k">result</span><span class="w">       </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-11-9"><a href="#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="p">);</span>
</span></code></pre></div>
* <strong>Indexes</strong>:</p>
<ul>
<li>Composite <code>(kid, timestamp)</code> cho ph√¢n t√≠ch key hot-path.</li>
<li><strong>Purge</strong>: TTL 7 ng√†y, job <code>purge_key_usage_log</code>.</li>
</ul>
<h3 id="103-partitioning-sharding">10.3 Partitioning &amp; Sharding<a class="headerlink" href="#103-partitioning-sharding" title="Permanent link">¬∂</a></h3>
<ul>
<li>
<p><strong>Partitioned Tables</strong>:</p>
</li>
<li>
<p><code>revoked_tokens</code> theo <code>tenant_id</code> hash ‚Üí tƒÉng t·ªëc lookup.</p>
</li>
<li><code>token_stats</code> partition by date period (monthly) cho purge hi·ªáu qu·∫£.</li>
<li><strong>Shard Key</strong>: S·ª≠ d·ª•ng <code>tenant_id</code> + <code>jti</code> l√†m composite shard key khi m·ªü r·ªông Multi-Region.</li>
</ul>
<h3 id="104-cross-region-replication">10.4 Cross-Region Replication<a class="headerlink" href="#104-cross-region-replication" title="Permanent link">¬∂</a></h3>
<ul>
<li>
<p><strong>JWKS Replicas</strong>:</p>
</li>
<li>
<p>T·∫°o b·∫£ng <code>jwks_keys_replica</code> t·∫°i region ph·ª•, s·ª≠ d·ª•ng <strong>Logical Replication</strong> ho·∫∑c <strong>Cloud SQL read replicas</strong>.</p>
</li>
<li><strong>Failover</strong>: API Gateway c√≥ th·ªÉ fallback verify t·ª´ replica n·∫øu primary unreachable (theo ADR-004).</li>
</ul>
<h3 id="105-real-time-analytics-feed">10.5 Real-time Analytics Feed<a class="headerlink" href="#105-real-time-analytics-feed" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>CDC Stream</strong>: D√πng Debezium ‚Üí Pub/Sub topic <code>dw.token_changes.v1</code> ‚Üí Data Platform.</li>
<li><strong>Mart Tables</strong>:</li>
</ul>
<p><div class="language-sql highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">fct_token_issuance</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-12-2"><a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">  </span><span class="n">tenant_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-12-3"><a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">  </span><span class="nb">date</span><span class="w"> </span><span class="nb">DATE</span><span class="p">,</span>
</span><span id="__span-12-4"><a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">  </span><span class="n">issued_count</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span>
</span><span id="__span-12-5"><a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">  </span><span class="n">revoked_count</span><span class="w"> </span><span class="nb">BIGINT</span>
</span><span id="__span-12-6"><a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="p">)</span><span class="w"> </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">RANGE</span><span class="w"> </span><span class="p">(</span><span class="nb">date</span><span class="p">);</span>
</span></code></pre></div>
* <strong>Use-case</strong>: B√°o c√°o issuance/revocation theo tenant, k·∫øt h·ª£p BI Engine.</p>
<h3 id="106-audit-history-versioning">10.6 Audit History &amp; Versioning<a class="headerlink" href="#106-audit-history-versioning" title="Permanent link">¬∂</a></h3>
<ul>
<li>
<p><strong>Temporal Tables</strong>:</p>
</li>
<li>
<p>M·ªü r·ªông <code>revoked_tokens</code> th√†nh <code>revoked_tokens_history</code> l∆∞u phi√™n b·∫£n tr∆∞·ªõc khi x√≥a/·∫©n danh.</p>
</li>
<li>
<p><strong>Schema Versioning</strong>:</p>
</li>
<li>
<p>Ghi <code>schema_version</code> v√†o setiap b·∫£n ghi ƒë·ªÉ support ADR-023 khi migration ti·∫øp theo.</p>
</li>
</ul>
<blockquote>
<p>V·ªõi khung m·ªü r·ªông n√†y, Token Service s·∫Ω s·∫µn s√†ng ƒë√≥n ƒë·∫ßu c√°c y√™u c·∫ßu m·ªü r·ªông l·ªõn (10k tenant), tu√¢n chu·∫©n ADR-023, ADR-024, ADR-030 v√† gi·ªØ p95 latency &lt; 5 ms cho m·ªçi truy v·∫•n d·ªØ li·ªáu.</p>
</blockquote>
<hr/>
<h2 id="11-enums">11. ENUMs<a class="headerlink" href="#11-enums" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>M·ª•c ƒë√≠ch</strong> ‚Äì ƒê·ªãnh nghƒ©a t·∫≠p gi√° tr·ªã c·ªë ƒë·ªãnh ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n v√† gi·∫£m l·ªói ƒë·∫ßu v√†o. Theo <strong>5‚òÖ Data Model Standard</strong>, ch√∫ng ta d√πng <code>CHECK</code> constraints thay v√¨ lo·∫°i ENUM DB ri√™ng ƒë·ªÉ gi·ªØ t√≠nh di ƒë·ªông gi·ªØa PostgreSQL v√† MariaDB.</p>
</blockquote>
<h3 id="111-reason-trong-revoked_tokens">11.1 <code>reason</code> trong <code>revoked_tokens</code><a class="headerlink" href="#111-reason-trong-revoked_tokens" title="Permanent link">¬∂</a></h3>
<p>Token c√≥ th·ªÉ b·ªã thu h·ªìi b·ªüi c√°c nguy√™n nh√¢n sau:</p>
<table>
<thead>
<tr>
<th>Gi√° tr·ªã</th>
<th>M√¥ t·∫£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>logout</code></td>
<td>Ng∆∞·ªùi d√πng th·ª±c hi·ªán ƒëƒÉng xu·∫•t</td>
</tr>
<tr>
<td><code>rotation</code></td>
<td>Token b·ªã thu h·ªìi do xoay kh√≥a JWT</td>
</tr>
<tr>
<td><code>breach</code></td>
<td>Token b·ªã thu h·ªìi do ph√°t hi·ªán vi ph·∫°m b·∫£o m·∫≠t</td>
</tr>
<tr>
<td><code>expired</code></td>
<td>Token t·ª± h·∫øt h·∫°n</td>
</tr>
</tbody>
</table>
<p><strong>SQL (PostgreSQL / MariaDB)</strong></p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">revoked_tokens</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">chk_revoked_tokens_reason</span>
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">reason</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">      </span><span class="s1">'logout'</span><span class="p">,</span>
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">      </span><span class="s1">'rotation'</span><span class="p">,</span>
</span><span id="__span-13-6"><a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">      </span><span class="s1">'breach'</span><span class="p">,</span>
</span><span id="__span-13-7"><a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">      </span><span class="s1">'expired'</span>
</span><span id="__span-13-8"><a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">    </span><span class="p">));</span>
</span></code></pre></div>
<h3 id="112-tuy-chon-event-trong-pubsub">11.2 (T√πy ch·ªçn) <code>event</code> trong Pub/Sub<a class="headerlink" href="#112-tuy-chon-event-trong-pubsub" title="Permanent link">¬∂</a></h3>
<p>ƒê·ªÉ ƒë·ªìng b·ªô v·ªõi <strong>ADR-030</strong>, c√°c t√™n event c≈©ng l√† ‚Äúenum‚Äù tr√™n Pub/Sub:</p>
<table>
<thead>
<tr>
<th>Gi√° tr·ªã</th>
<th>M√¥ t·∫£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>token.issued.v1</code></td>
<td>S·ª± ki·ªán khi JWT m·ªõi ƒë∆∞·ª£c ph√°t h√†nh</td>
</tr>
<tr>
<td><code>token.revoked.v1</code></td>
<td>S·ª± ki·ªán khi JWT b·ªã thu h·ªìi</td>
</tr>
<tr>
<td><code>token.introspect_fail.v1</code></td>
<td>S·ª± ki·ªán khi introspect tr·∫£ k·∫øt qu·∫£ kh√¥ng h·ª£p l·ªá</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>L∆∞u √Ω:</strong> Vi·ªác validate event name th∆∞·ªùng di·ªÖn ra ·ªü <strong>Consumer</strong> (API Gateway, Audit Service) qua schema registry, kh√¥ng qua DB.</p>
</blockquote>
<h3 id="113-best-practices">11.3 Best Practices<a class="headerlink" href="#113-best-practices" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>Kh√¥ng</strong> hard-code gi√° tr·ªã trong ·ª©ng d·ª•ng; tham chi·∫øu qua <code>CHECK</code> ho·∫∑c enum type trong codegen.</li>
<li>Khi m·ªü r·ªông th√™m l√Ω do ho·∫∑c event m·ªõi, lu√¥n <strong>update</strong> <code>CHECK</code> constraint v√† <strong>publish</strong> event schema m·ªõi (<code>v2</code>).</li>
<li>ƒê·∫£m b·∫£o <strong>migration</strong> theo <strong>3-phase</strong> (ADR-023): Prepare ‚Üí Transition ‚Üí Cleanup khi thay ƒë·ªïi gi√° tr·ªã enum.</li>
</ul>
<hr/>
<h2 id="12-phu-luc-kiem-thu">12. Ph·ª• l·ª•c Ki·ªÉm th·ª≠<a class="headerlink" href="#12-phu-luc-kiem-thu" title="Permanent link">¬∂</a></h2>
<blockquote>
<p>ƒê·ªÉ ƒë·∫£m b·∫£o <strong>t√≠nh to√†n v·∫πn</strong>, <strong>t√≠nh ƒë√∫ng ƒë·∫Øn</strong> v√† <strong>hi·ªáu nƒÉng</strong> c·ªßa Data Model, ch√∫ng ta √°p d·ª•ng ƒëa t·∫ßng ki·ªÉm th·ª≠ theo 5‚òÖ Data Model Standard.</p>
</blockquote>
<h3 id="121-unit-tests">12.1 Unit Tests<a class="headerlink" href="#121-unit-tests" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>Framework</strong>: pgTAP (PostgreSQL) / SQLUnit (MariaDB)</li>
<li><strong>C√°c k·ªãch b·∫£n</strong>:</li>
<li><strong>Schema validation</strong> <ul>
<li>Ki·ªÉm tra c√°c b·∫£ng t·ªìn t·∫°i v·ªõi ƒë√∫ng c·ªôt, ki·ªÉu, NOT NULL.  </li>
<li><code>SELECT column_name FROM information_schema.columns WHERE table_name='revoked_tokens'</code> ‚Üí so v·ªõi spec.</li>
</ul>
</li>
<li><strong>Constraints</strong> <ul>
<li>Th·ª≠ ch√®n <code>revoked_tokens</code> v·ªõi <code>reason='invalid'</code> ‚Üí ph·∫£i fail <code>CHECK chk_revoked_tokens_reason</code>.  </li>
<li>Th·ª≠ ch√®n hai b·∫£n ghi <code>jwks_keys</code> c√πng <code>active=TRUE</code> ‚Üí ph·∫£i fail unique.</li>
</ul>
</li>
<li><strong>Default values</strong> <ul>
<li>Th·ª≠ insert kh√¥ng cung c·∫•p <code>created_at</code> ‚Üí gi√° tr·ªã m·∫∑c ƒë·ªãnh l√† <code>now()</code>.  </li>
<li>Th·ª≠ insert <code>auth_sessions</code> kh√¥ng cung c·∫•p <code>last_active_at</code> ‚Üí default <code>now()</code>.</li>
</ul>
</li>
</ul>
<h3 id="122-integration-tests">12.2 Integration Tests<a class="headerlink" href="#122-integration-tests" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>M√¥i tr∆∞·ªùng</strong>: Docker Compose v·ªõi PostgreSQL v√† MariaDB, seed d·ªØ li·ªáu m·∫´u.</li>
<li><strong>C√°c k·ªãch b·∫£n</strong>:</li>
<li><strong>Full Issuance ‚Üí Revocation ‚Üí Stats</strong> <ul>
<li>G·ªçi API <code>/v1/token/issue</code> ‚Üí ki·ªÉm tra <code>auth_sessions</code>, <code>jwks_keys</code> d√πng ƒë√∫ng <code>kid</code>.  </li>
<li>G·ªçi <code>/v1/token/revoke</code> ‚Üí b·∫£n ghi <code>revoked_tokens</code> t·ªìn t·∫°i ‚Üí th·ª≠ insert <code>token_stats</code>.  </li>
<li>X√°c nh·∫≠n <code>token_stats.jti</code> FK ‚Üí khi x√≥a <code>revoked_tokens</code>, <code>token_stats</code> t·ª± cascade delete.</li>
</ul>
</li>
<li><strong>Migration Script</strong> <ul>
<li>Ch·∫°y Flyway t·ª´ v1.0 ‚Üí v1.2 ‚Üí v1.3 ‚Üí v1.4 trong m√¥i tr∆∞·ªùng test.  </li>
<li>Ki·ªÉm tra b·∫£ng <code>revoked_tokens_v2</code> t·ªìn t·∫°i ·ªü pha Prepare, sau Transition ch·ªâ ƒë·ªçc t·ª´ v2, sau Cleanup ch·ªâ c√≤n v2.</li>
</ul>
</li>
<li><strong>Event Publication</strong> <ul>
<li>Sau each DML tr√™n DB, theo d√µi Pub/Sub mock ‚Üí ƒë·∫£m b·∫£o event <code>token.*.v1</code> ƒë∆∞·ª£c publish ƒë√∫ng payload.</li>
</ul>
</li>
</ul>
<h3 id="123-retention-purge-tests">12.3 Retention &amp; Purge Tests<a class="headerlink" href="#123-retention-purge-tests" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>Framework</strong>: Scheduled job runner + test data expiration.</li>
<li><strong>C√°c k·ªãch b·∫£n</strong>:</li>
<li><strong>TTL revoke</strong> <ul>
<li>Insert <code>revoked_tokens.revoked_at = now() - '31 days'</code> ‚Üí ch·∫°y <code>purge_revoked_tokens</code> ‚Üí b·∫£n ghi b·ªã x√≥a.  </li>
<li>B·∫£o ƒë·∫£m <code>purge_revoked_tokens_count</code> metric tƒÉng ch√≠nh x√°c.</li>
</ul>
</li>
<li><strong>Anonymize stats</strong> <ul>
<li>Insert <code>token_stats.recorded_at = now() - '91 days'</code> v·ªõi <code>ip_address</code>, <code>device_info</code>.  </li>
<li>Ch·∫°y <code>anonymize_token_stats</code> ‚Üí c√°c tr∆∞·ªùng PII ph·∫£i null; sau ƒë√≥ ch·∫°y <code>purge_token_stats</code> ‚Üí b·∫£n ghi b·ªã x√≥a.</li>
</ul>
</li>
</ul>
<h3 id="124-performance-tests">12.4 Performance Tests<a class="headerlink" href="#124-performance-tests" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>C√¥ng c·ª•</strong>: pgbench / sysbench / JMeter</li>
<li><strong>Ch·ªâ s·ªë m·ª•c ti√™u</strong>:</li>
<li><strong>p95 SELECT revoked_tokens</strong> ‚â§ 5 ms (with index).  </li>
<li><strong>p95 INSERT auth_sessions</strong> ‚â§ 10 ms.  </li>
<li><strong>Bulk purge</strong> 100k records in &lt; 30s.</li>
<li><strong>K·ªãch b·∫£n</strong>:</li>
<li>Th·ª±c hi·ªán 10k concurrent selects <code>SELECT 1 FROM revoked_tokens WHERE jti=?</code>.  </li>
<li>Th·ª±c hi·ªán 1k inserts <code>auth_sessions</code>/s v·ªõi batch size 50.  </li>
<li>Ch·∫°y purge job tr√™n 1M revoked_tokens.</li>
</ul>
<h3 id="125-security-privilege-tests">12.5 Security &amp; Privilege Tests<a class="headerlink" href="#125-security-privilege-tests" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>Verify least privilege</strong>:</li>
<li>K·∫øt n·ªëi DB b·∫±ng role <code>token_service</code> ‚Üí th·ª≠ <code>DROP TABLE jwks_keys</code> ‚Üí ph·∫£i b·ªã DENY.  </li>
<li>K·∫øt n·ªëi b·∫±ng <code>db_admin</code> ‚Üí c√≥ quy·ªÅn ALL.</li>
<li><strong>SSL enforcement</strong>:</li>
<li>K·∫øt n·ªëi kh√¥ng d√πng SSL ‚Üí th·∫•t b·∫°i v·ªõi <code>sslmode=require</code>.</li>
<li><strong>Audit Logging</strong>:</li>
<li>Khi purge ho·∫∑c rotation ch·∫°y, ki·ªÉm tra <code>audit_log.purge_history</code> c√≥ b·∫£n ghi.</li>
</ul>
<h3 id="126-concurrency-consistency">12.6 Concurrency &amp; Consistency<a class="headerlink" href="#126-concurrency-consistency" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>K·ªãch b·∫£n</strong>:</li>
<li><strong>Race Condition</strong>: 2 clients c√πng revoke <code>jti</code> ‚Üí ch·ªâ m·ªôt b·∫£n ghi ƒë∆∞·ª£c insert, kh√¥ng duplicate.  </li>
<li><strong>Dual-write migration</strong>: Trong pha Prepare, record inserted v√†o c·∫£ b·∫£ng c≈© &amp; b·∫£ng v2, sau phase Transition ch·ªâ d√πng v2.</li>
</ul>
<h3 id="127-cicd-integration">12.7 CI/CD Integration<a class="headerlink" href="#127-cicd-integration" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>Pipeline</strong>:</li>
<li>Stage <strong>Unit Test</strong> (pgTAP).  </li>
<li>Stage <strong>Integration Test</strong> (Dockerized DB).  </li>
<li>Stage <strong>Migration Test</strong> (Flyway).  </li>
<li>Stage <strong>Performance Test</strong> (light load).  </li>
<li><strong>B·∫£o ƒë·∫£m</strong>: 100 % test must pass before merge.</li>
</ul>
<hr/>
<blockquote>
<p>V·ªõi suite ki·ªÉm th·ª≠ tr√™n, Data Model c·ªßa Token Service ƒë·∫£m b·∫£o <strong>ƒë√∫ng</strong>, <strong>an to√†n</strong>, <strong>hi·ªáu nƒÉng</strong> v√† <strong>d·ªÖ m·ªü r·ªông</strong>, ƒë√°p ·ª©ng to√†n b·ªô ADR v√† 5‚òÖ Data Model Standard.  </p>
</blockquote>
<hr/>
<h2 id="13-lien-ket-tai-lieu">13. üìö Li√™n k·∫øt T√†i li·ªáu<a class="headerlink" href="#13-lien-ket-tai-lieu" title="Permanent link">¬∂</a></h2>
<ul>
<li><a href="../interface-contract/">Interface Contract</a></li>
<li><a href="./">Data Model</a></li>
<li><a href="../openapi.yaml">OpenAPI Spec</a></li>
</ul>
<h3 id="cac-quyet-inh-kien-truc-adr">üîñ C√°c Quy·∫øt ƒë·ªãnh Ki·∫øn tr√∫c (ADR)<a class="headerlink" href="#cac-quyet-inh-kien-truc-adr" title="Permanent link">¬∂</a></h3>
<ul>
<li><a href="../../../ADR/adr-003-secrets/">ADR-003 Secrets Management</a>: Quy tr√¨nh l∆∞u tr·ªØ &amp; xoay kh√≥a b√≠ m·∫≠t an to√†n.  </li>
<li><a href="../../../ADR/adr-004-security/">ADR-004 Security Policy</a>: Ch√≠nh s√°ch b·∫£o m·∫≠t t·ªïng th·ªÉ.  </li>
<li><a href="../../../ADR/adr-005-env-config/">ADR-005 Environment Configuration Strategy</a>: Chu·∫©n t√°ch c·∫•u h√¨nh ‚Äì <code>SERVICE__SECTION__KEY</code>.  </li>
<li><a href="../../../ADR/adr-006-auth-strategy/">ADR-006 Auth Strategy</a>: Chi·∫øn l∆∞·ª£c x√°c th·ª±c ng∆∞·ªùi d√πng v√† c·∫•p ph√°t token.  </li>
<li><a href="../../../ADR/adr-009-api-governance/">ADR-009 API Governance</a>: Quy t·∫Øc versioning, naming v√† style REST.  </li>
<li><a href="../../../ADR/adr-011-api-error-format/">ADR-011 API Error Format</a>: Quy ∆∞·ªõc m√£ l·ªói &amp; th√¥ng ƒëi·ªáp l·ªói (<code>namespace.snake_case</code>).  </li>
<li><a href="../../../ADR/adr-012-response-structure/">ADR-012 Response Structure</a>: Chu·∫©n h√≥a c·∫•u tr√∫c JSON response cho API.</li>
<li><a href="../../../ADR/adr-018-release-approval-policy/">ADR-018 Release Approval Policy</a>: Quy tr√¨nh ph√™ duy·ªát ph√°t h√†nh.</li>
<li><a href="../../../ADR/adr-022-sla-slo-monitoring/">ADR-022 SLA &amp; SLO Monitoring</a>: Khung gi√°m s√°t &amp; ƒë·ªãnh nghƒ©a SLO.</li>
<li><a href="../../../ADR/adr-023-schema-migration-strategy/">ADR-023 Schema Migration Strategy</a>: 3-phase migration (Prepare ‚Üí Transition ‚Üí Cleanup).  </li>
<li><a href="../../../ADR/adr-024-data-anonymization-retention/">ADR-024 Data Anonymization &amp; Retention</a>: ·∫®n danh PII v√† TTL d·ªØ li·ªáu.  </li>
<li><a href="../../../ADR/adr-026-hard-delete-policy/">ADR-026 Hard-Delete Policy</a>: Quy tr√¨nh xo√° vƒ©nh vi·ªÖn &amp; purge log.  </li>
<li><a href="../../../ADR/adr-030-event-schema-governance/">ADR-030 Event Schema Governance</a>: ƒê·∫∑t t√™n &amp; version s·ª± ki·ªán <code>*.v{n}</code>.</li>
</ul>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Tr·ªü l·∫°i m·ª•c l·ª•c
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>