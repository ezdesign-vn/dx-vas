
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="TÃ i liá»‡u kiáº¿n trÃºc vÃ  phÃ¡t triá»ƒn cho dá»± Ã¡n Chuyá»ƒn Ä‘á»•i sá»‘ TrÆ°á»ng Viá»‡t Anh." name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://ezdesign-vn.github.io/dx-vas/services/token-service/design/" rel="canonical"/>
<link href="../../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Thiáº¿t káº¿ chi tiáº¿t Token Service - DX VAS - Docs</title>
<link href="../../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#token-service-thiet-ke-kien-truc-chi-tiet">
          Bá» qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Äáº§u trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Thiáº¿t káº¿ chi tiáº¿t Token Service
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="TÃ¬m kiáº¿m" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="TÃ¬m kiáº¿m" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="TÃ¬m kiáº¿m" class="md-search__options">
<button aria-label="XoÃ¡" class="md-search__icon md-icon" tabindex="-1" title="XoÃ¡" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../architecture/system-diagrams/">
          
  
  
    
  
  Kiáº¿n trÃºc Há»‡ thá»‘ng

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../dev-guide/">
        
  
  
    
  
  HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../">
        
  
  
    
  
  Thiáº¿t káº¿ Services

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../ADR/">
          
  
  
    
  
  Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh Ä‘iá»u hÆ°á»›ng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Kiáº¿n trÃºc Há»‡ thá»‘ng
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Kiáº¿n trÃºc Há»‡ thá»‘ng
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/system-diagrams/">
<span class="md-ellipsis">
    SÆ¡ Ä‘á»“ Há»‡ thá»‘ng
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/rbac-deep-dive/">
<span class="md-ellipsis">
    RBAC Chi tiáº¿t
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../dev-guide/">
<span class="md-ellipsis">
    HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    Thiáº¿t káº¿ Services
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ADR/">
<span class="md-ellipsis">
    Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Má»¥c lá»¥c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Má»¥c lá»¥c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-muc-tieu-pham-vi">
<span class="md-ellipsis">
      1. ğŸ¯ Má»¥c tiÃªu &amp; Pháº¡m vi
    </span>
</a>
<nav aria-label="1. ğŸ¯ Má»¥c tiÃªu &amp; Pháº¡m vi" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#11-muc-ich">
<span class="md-ellipsis">
      1.1. Má»¥c Ä‘Ã­ch
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-chuc-nang-chinh">
<span class="md-ellipsis">
      1.2. Chá»©c nÄƒng chÃ­nh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#13-ngoai-pham-vi">
<span class="md-ellipsis">
      1.3. NgoÃ i pháº¡m vi
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#14-nguoi-su-dung-chinh">
<span class="md-ellipsis">
      1.4. NgÆ°á»i sá»­ dá»¥ng chÃ­nh
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-thiet-ke-api">
<span class="md-ellipsis">
      2. ğŸŒ Thiáº¿t káº¿ API
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-mo-hinh-du-lieu-chi-tiet">
<span class="md-ellipsis">
      3. ğŸ—ƒï¸ MÃ´ hÃ¬nh dá»¯ liá»‡u chi tiáº¿t
    </span>
</a>
<nav aria-label="3. ğŸ—ƒï¸ MÃ´ hÃ¬nh dá»¯ liá»‡u chi tiáº¿t" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#31-redis-key-structure">
<span class="md-ellipsis">
      3.1. ğŸ§± Redis Key Structure
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#32-cau-truc-payload-metadata">
<span class="md-ellipsis">
      3.2. ğŸ“¦ Cáº¥u trÃºc Payload &amp; Metadata
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-luong-xu-ly-nghiep-vu-chinh">
<span class="md-ellipsis">
      4. ğŸ”„ Luá»“ng xá»­ lÃ½ nghiá»‡p vá»¥ chÃ­nh
    </span>
</a>
<nav aria-label="4. ğŸ”„ Luá»“ng xá»­ lÃ½ nghiá»‡p vá»¥ chÃ­nh" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#luong-1-sinh-token-sau-ang-nhap-thanh-cong">
<span class="md-ellipsis">
      ğŸ” Luá»“ng 1: Sinh Token sau Ä‘Äƒng nháº­p thÃ nh cÃ´ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luong-2-lam-moi-access_token-bang-refresh_token">
<span class="md-ellipsis">
      ğŸ” Luá»“ng 2: LÃ m má»›i access_token báº±ng refresh_token
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luong-3-thu-hoi-token-khi-logout">
<span class="md-ellipsis">
      ğŸ”’ Luá»“ng 3: Thu há»“i token khi logout
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luong-4-introspect-token-vi-du-tu-api-gateway">
<span class="md-ellipsis">
      ğŸ§ª Luá»“ng 4: Introspect token (vÃ­ dá»¥ tá»« API Gateway)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luong-5-fallback-khi-introspect-token-that-bai">
<span class="md-ellipsis">
      ğŸ” Luá»“ng 5: Fallback khi introspect token tháº¥t báº¡i
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luong-6-multi-key-rotation-rs256-hoac-es256">
<span class="md-ellipsis">
      ğŸ”‘ Luá»“ng 6: Multi-key Rotation (RS256 hoáº·c ES256)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-tuong-tac-voi-cac-service-khac-luong-su-kien">
<span class="md-ellipsis">
      5. ğŸ“£ TÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c Service khÃ¡c &amp; Luá»“ng sá»± kiá»‡n
    </span>
</a>
<nav aria-label="5. ğŸ“£ TÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c Service khÃ¡c &amp; Luá»“ng sá»± kiá»‡n" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-giao-tiep-chinh-giua-cac-service">
<span class="md-ellipsis">
      5.1. Giao tiáº¿p chÃ­nh giá»¯a cÃ¡c Service
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-giao-tiep-voi-he-thong-pubsub">
<span class="md-ellipsis">
      5.2. Giao tiáº¿p vá»›i há»‡ thá»‘ng Pub/Sub
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-kien-truc-trien-khai-pubsub">
<span class="md-ellipsis">
      5.3. Kiáº¿n trÃºc triá»ƒn khai Pub/Sub
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#54-luu-vet-trong-audit-logs">
<span class="md-ellipsis">
      5.4. LÆ°u váº¿t trong Audit Logs
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-bao-mat-phan-quyen">
<span class="md-ellipsis">
      6. ğŸ” Báº£o máº­t &amp; PhÃ¢n quyá»n
    </span>
</a>
<nav aria-label="6. ğŸ” Báº£o máº­t &amp; PhÃ¢n quyá»n" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-co-che-bao-ve-endpoint">
<span class="md-ellipsis">
      6.1. CÆ¡ cháº¿ báº£o vá»‡ endpoint
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-kiem-tra-phong-chong-lam-dung-token">
<span class="md-ellipsis">
      6.2. Kiá»ƒm tra &amp; phÃ²ng chá»‘ng láº¡m dá»¥ng token
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-phan-quyen-theo-hanh-vi-rbac">
<span class="md-ellipsis">
      6.3. PhÃ¢n quyá»n theo hÃ nh vi (RBAC)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-gioi-han-kiem-soat-hanh-vi">
<span class="md-ellipsis">
      6.4. Giá»›i háº¡n &amp; kiá»ƒm soÃ¡t hÃ nh vi
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#65-bao-ve-cau-hinh-khoa-bi-mat-theo-adr-003-secrets-management">
<span class="md-ellipsis">
      6.5 Báº£o vá»‡ cáº¥u hÃ¬nh &amp; khÃ³a bÃ­ máº­t (theo ADR-003 â€“ Secrets Management)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#66-test-kiem-chung-bao-mat">
<span class="md-ellipsis">
      6.6. Test &amp; kiá»ƒm chá»©ng báº£o máº­t
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-cau-hinh-phu-thuoc">
<span class="md-ellipsis">
      7. âš™ï¸ Cáº¥u hÃ¬nh &amp; Phá»¥ thuá»™c
    </span>
</a>
<nav aria-label="7. âš™ï¸ Cáº¥u hÃ¬nh &amp; Phá»¥ thuá»™c" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-bien-moi-truong-quan-trong-env">
<span class="md-ellipsis">
      7.1. Biáº¿n mÃ´i trÆ°á»ng quan trá»ng (.env)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-phu-thuoc-dich-vu-external-dependencies">
<span class="md-ellipsis">
      7.2. Phá»¥ thuá»™c dá»‹ch vá»¥ (External Dependencies)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-khoa-bi-mat-va-private-keys">
<span class="md-ellipsis">
      7.3. KhÃ³a bÃ­ máº­t vÃ  private keys
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-cau-hinh-cache-introspection">
<span class="md-ellipsis">
      7.4. Cáº¥u hÃ¬nh cache &amp; introspection
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#75-cau-hinh-quan-sat-alert">
<span class="md-ellipsis">
      7.5. Cáº¥u hÃ¬nh quan sÃ¡t &amp; alert
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-chien-luoc-kiem-thu">
<span class="md-ellipsis">
      8. ğŸ§ª Chiáº¿n lÆ°á»£c kiá»ƒm thá»­
    </span>
</a>
<nav aria-label="8. ğŸ§ª Chiáº¿n lÆ°á»£c kiá»ƒm thá»­" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-unit-test-kiem-thu-on-vi">
<span class="md-ellipsis">
      8.1. Unit Test (Kiá»ƒm thá»­ Ä‘Æ¡n vá»‹)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-integration-test-kiem-thu-tich-hop">
<span class="md-ellipsis">
      8.2. Integration Test (Kiá»ƒm thá»­ tÃ­ch há»£p)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-contract-test-openapi-based">
<span class="md-ellipsis">
      8.3. Contract Test (OpenAPI-based)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#84-security-negative-test">
<span class="md-ellipsis">
      8.4. Security &amp; Negative Test
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#85-performance-test-optional">
<span class="md-ellipsis">
      8.5. Performance Test (Optional)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#86-cicd-integration">
<span class="md-ellipsis">
      8.6. CI/CD Integration
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#87-tu-ong-sinh-test-tu-openapi">
<span class="md-ellipsis">
      8.7. Tá»± Ä‘á»™ng sinh test tá»« OpenAPI
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-quan-sat-giam-sat">
<span class="md-ellipsis">
      9. ğŸ“ˆ Quan sÃ¡t &amp; GiÃ¡m sÃ¡t
    </span>
</a>
<nav aria-label="9. ğŸ“ˆ Quan sÃ¡t &amp; GiÃ¡m sÃ¡t" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#91-logging">
<span class="md-ellipsis">
      9.1. Logging
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#92-metrics-prometheus">
<span class="md-ellipsis">
      9.2. Metrics (Prometheus)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#93-tracing">
<span class="md-ellipsis">
      9.3. Tracing
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#94-alerting-slo-monitoring">
<span class="md-ellipsis">
      9.4. Alerting &amp; SLO Monitoring
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#95-audit-logging">
<span class="md-ellipsis">
      9.5. Audit Logging
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#96-healthcheck">
<span class="md-ellipsis">
      9.6. Healthcheck
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-o-tin-cay-phuc-hoi">
<span class="md-ellipsis">
      10. ğŸš€ Äá»™ tin cáº­y &amp; Phá»¥c há»“i
    </span>
</a>
<nav aria-label="10. ğŸš€ Äá»™ tin cáº­y &amp; Phá»¥c há»“i" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#101-zero-downtime-deployment">
<span class="md-ellipsis">
      10.1. Zero Downtime Deployment
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#102-auto-scaling-load-balancing">
<span class="md-ellipsis">
      10.2. Auto-Scaling &amp; Load Balancing
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#103-graceful-fallback">
<span class="md-ellipsis">
      10.3. Graceful Fallback
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#104-high-availability-architecture">
<span class="md-ellipsis">
      10.4. High Availability Architecture
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#105-retry-circuit-breaker">
<span class="md-ellipsis">
      10.5. Retry &amp; Circuit Breaker
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#106-disaster-recovery">
<span class="md-ellipsis">
      10.6. Disaster Recovery
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#107-am-bao-backward-compatibility">
<span class="md-ellipsis">
      10.7. Äáº£m báº£o backward compatibility
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#108-kiem-thu-truoc-khi-release">
<span class="md-ellipsis">
      10.8. Kiá»ƒm thá»­ trÆ°á»›c khi release
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-hieu-nang-kha-nang-mo-rong">
<span class="md-ellipsis">
      11. âš¡ï¸ Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng
    </span>
</a>
<nav aria-label="11. âš¡ï¸ Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#111-hieu-nang-tung-loai-endpoint">
<span class="md-ellipsis">
      11.1. Hiá»‡u nÄƒng tá»«ng loáº¡i endpoint
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#112-ky-thuat-toi-uu">
<span class="md-ellipsis">
      11.2. Ká»¹ thuáº­t tá»‘i Æ°u
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#113-horizontal-scaling">
<span class="md-ellipsis">
      11.3. Horizontal Scaling
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#114-connection-pooling">
<span class="md-ellipsis">
      11.4. Connection pooling
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#115-thu-tai-load-testing">
<span class="md-ellipsis">
      11.5. Thá»­ táº£i (Load Testing)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#116-cdn-edge-cache">
<span class="md-ellipsis">
      11.6. CDN &amp; Edge Cache
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#117-graceful-degradation">
<span class="md-ellipsis">
      11.7. Graceful degradation
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-ke-hoach-trien-khai">
<span class="md-ellipsis">
      12. ğŸ›  Káº¿ hoáº¡ch Triá»ƒn khai
    </span>
</a>
<nav aria-label="12. ğŸ›  Káº¿ hoáº¡ch Triá»ƒn khai" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#121-phan-ky-trien-khai">
<span class="md-ellipsis">
      12.1. PhÃ¢n ká»³ triá»ƒn khai
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#122-cong-cu-trien-khai">
<span class="md-ellipsis">
      12.2. CÃ´ng cá»¥ triá»ƒn khai
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#123-zero-downtime">
<span class="md-ellipsis">
      12.3. Zero Downtime
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#124-seed-du-lieu-ban-au">
<span class="md-ellipsis">
      12.4. Seed dá»¯ liá»‡u ban Ä‘áº§u
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#125-migration-data-schema-safe-migration-adr-023">
<span class="md-ellipsis">
      12.5. Migration &amp; Data Schema (Safe-Migration â€“ ADR-023)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#1-prepare-shadow-write">
<span class="md-ellipsis">
      ğŸ”¹ 1. Prepare (Shadow Write)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-transition-read-switch">
<span class="md-ellipsis">
      ğŸ”¹ 2. Transition (Read Switch)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-cleanup-decommission">
<span class="md-ellipsis">
      ğŸ”¹ 3. Cleanup (Decommission)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rollback-plan">
<span class="md-ellipsis">
      ğŸ”¹ Rollback Plan
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#126-quan-ly-cau-hinh-moi-truong">
<span class="md-ellipsis">
      12.6. Quáº£n lÃ½ cáº¥u hÃ¬nh &amp; mÃ´i trÆ°á»ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#127-rollback-nhanh">
<span class="md-ellipsis">
      12.7. Rollback nhanh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#128-quan-ly-phat-hanh">
<span class="md-ellipsis">
      12.8. Quáº£n lÃ½ phÃ¡t hÃ nh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#129-sau-trien-khai">
<span class="md-ellipsis">
      12.9. Sau triá»ƒn khai
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#13-kien-truc-service">
<span class="md-ellipsis">
      13. ğŸ§© Kiáº¿n trÃºc Service
    </span>
</a>
<nav aria-label="13. ğŸ§© Kiáº¿n trÃºc Service" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#131-thanh-phan-chinh-modules">
<span class="md-ellipsis">
      13.1. ThÃ nh pháº§n chÃ­nh (Modules)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#132-luong-tuong-tac-chinh">
<span class="md-ellipsis">
      13.2. Luá»“ng tÆ°Æ¡ng tÃ¡c chÃ­nh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#133-trien-khai-ha-tang">
<span class="md-ellipsis">
      13.3. Triá»ƒn khai &amp; Háº¡ táº§ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#134-quan-he-voi-cac-service-khac">
<span class="md-ellipsis">
      13.4. Quan há»‡ vá»›i cÃ¡c service khÃ¡c
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#135-phan-tach-nhiem-vu-responsibility-split">
<span class="md-ellipsis">
      13.5. PhÃ¢n tÃ¡ch nhiá»‡m vá»¥ (Responsibility Split)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#136-high-level-diagram">
<span class="md-ellipsis">
      13.6. High-level Diagram
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#14-tai-lieu-lien-quan">
<span class="md-ellipsis">
      14. ğŸ“š TÃ i liá»‡u liÃªn quan
    </span>
</a>
<nav aria-label="14. ğŸ“š TÃ i liá»‡u liÃªn quan" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cac-quyet-inh-kien-truc-adr">
<span class="md-ellipsis">
      ğŸ”– CÃ¡c Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADR)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dich-vu-lien-quan">
<span class="md-ellipsis">
      ğŸ§© Dá»‹ch vá»¥ liÃªn quan
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#file-trong-token-service">
<span class="md-ellipsis">
      ğŸ“‚ File trong Token Service
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="token-service-thiet-ke-kien-truc-chi-tiet">ğŸ“¦ Token Service â€“ Thiáº¿t káº¿ Kiáº¿n trÃºc chi tiáº¿t<a class="headerlink" href="#token-service-thiet-ke-kien-truc-chi-tiet" title="Permanent link">Â¶</a></h1>
<!-- toc -->
<hr/>
<h2 id="1-muc-tieu-pham-vi">1. ğŸ¯ Má»¥c tiÃªu &amp; Pháº¡m vi<a class="headerlink" href="#1-muc-tieu-pham-vi" title="Permanent link">Â¶</a></h2>
<h3 id="11-muc-ich">1.1. Má»¥c Ä‘Ã­ch<a class="headerlink" href="#11-muc-ich" title="Permanent link">Â¶</a></h3>
<p><code>TokenService</code> Ä‘Æ°á»£c xÃ¢y dá»±ng Ä‘á»ƒ trá»Ÿ thÃ nh thÃ nh pháº§n chuyÃªn trÃ¡ch quáº£n lÃ½ toÃ n bá»™ vÃ²ng Ä‘á»i cá»§a token trong há»‡ sinh thÃ¡i DX-VAS, nháº±m Ä‘áº£m báº£o báº£o máº­t, kháº£ nÄƒng má»Ÿ rá»™ng, tÃ­nh nháº¥t quÃ¡n vÃ  kháº£ nÄƒng introspect token.</p>
<h3 id="12-chuc-nang-chinh">1.2. Chá»©c nÄƒng chÃ­nh<a class="headerlink" href="#12-chuc-nang-chinh" title="Permanent link">Â¶</a></h3>
<ul>
<li>Sinh JWT token (access + refresh) sau khi xÃ¡c thá»±c thÃ nh cÃ´ng tá»« <code>auth-service</code>.</li>
<li>LÃ  nÆ¡i kiá»ƒm tra vÃ  xÃ¡c minh token (<code>introspect</code>).</li>
<li>Há»— trá»£ thu há»“i token (<code>revoke</code>) theo <code>jti</code>.</li>
<li>Cung cáº¥p metadata chi tiáº¿t cho má»—i phiÃªn Ä‘Äƒng nháº­p.</li>
</ul>
<h3 id="13-ngoai-pham-vi">1.3. NgoÃ i pháº¡m vi<a class="headerlink" href="#13-ngoai-pham-vi" title="Permanent link">Â¶</a></h3>
<ul>
<li>KhÃ´ng chá»‹u trÃ¡ch nhiá»‡m xÃ¡c thá»±c danh tÃ­nh ngÆ°á»i dÃ¹ng (Ä‘Æ°á»£c thá»±c hiá»‡n bá»Ÿi <code>auth-service</code>).</li>
<li>KhÃ´ng phÃ¡t hÃ nh token dáº¡ng OTP, Magic Link.</li>
</ul>
<h3 id="14-nguoi-su-dung-chinh">1.4. NgÆ°á»i sá»­ dá»¥ng chÃ­nh<a class="headerlink" href="#14-nguoi-su-dung-chinh" title="Permanent link">Â¶</a></h3>
<ul>
<li><code>auth-service/master</code>, <code>auth-service/sub</code></li>
<li><code>API Gateway</code></li>
<li>Frontend client (giÃ¡n tiáº¿p qua introspect/token-info)</li>
</ul>
<hr/>
<h2 id="2-thiet-ke-api">2. ğŸŒ Thiáº¿t káº¿ API<a class="headerlink" href="#2-thiet-ke-api" title="Permanent link">Â¶</a></h2>
<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>MÃ´ táº£ ngáº¯n</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td><code>/v1/token</code></td>
<td>Sinh má»›i access &amp; refresh token</td>
</tr>
<tr>
<td>POST</td>
<td><code>/v1/token/refresh</code></td>
<td>LÃ m má»›i access token tá»« refresh</td>
</tr>
<tr>
<td>POST</td>
<td><code>/v1/token/introspect</code></td>
<td>Kiá»ƒm tra há»£p lá»‡ cá»§a JWT</td>
</tr>
<tr>
<td>POST</td>
<td><code>/v1/token/revoke</code></td>
<td>Thu há»“i token theo jti</td>
</tr>
<tr>
<td>GET</td>
<td><code>/jwks.json</code></td>
<td>JWKS public keys cho Gateway</td>
</tr>
<tr>
<td>GET</td>
<td><code>/v1/token/info</code></td>
<td>Láº¥y metadata cá»§a access token</td>
</tr>
</tbody>
</table>
<p><strong>HTTP Status â†” Error-code matrix</strong></p>
<table>
<thead>
<tr>
<th>HTTP</th>
<th>error.code</th>
<th>Khi nÃ o xáº£y ra</th>
</tr>
</thead>
<tbody>
<tr>
<td>400</td>
<td><code>common.validation_failed</code></td>
<td>Body schema sai</td>
</tr>
<tr>
<td>401</td>
<td><code>auth.invalid_credentials</code></td>
<td>Refresh token sai</td>
</tr>
<tr>
<td>403</td>
<td><code>token.revoked</code></td>
<td>Token bá»‹ thu há»“i</td>
</tr>
<tr>
<td>409</td>
<td><code>token.rotation_in_progress</code></td>
<td>Key Ä‘ang rollover</td>
</tr>
<tr>
<td>422</td>
<td><code>common.validation_error</code></td>
<td>JSON há»£p lá»‡ nhÆ°ng khÃ´ng thoáº£ Ä‘iá»u kiá»‡n nghiá»‡p vá»¥</td>
</tr>
<tr>
<td>429</td>
<td><code>common.rate_limited</code></td>
<td>VÆ°á»£t ngÆ°á»¡ng RPS/burst (theo ADR-022)</td>
</tr>
<tr>
<td>500</td>
<td><code>common.internal_error</code></td>
<td>KhÃ´ng mong Ä‘á»£i</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Quy Æ°á»›c path versioning</strong><br/>
Má»i endpoint cá»§a Token Service tuÃ¢n Ä‘á»‹nh dáº¡ng <strong><code>/v{major}/â€¦</code></strong> â€“ vÃ­ dá»¥<br/>
<code>/v1/token</code>, <code>/v1/token/refresh</code>. Quy táº¯c nÃ y láº¥y tá»« <strong>ADR-009 (API Governance)</strong><br/>
vÃ  <strong>ADR-013 (Path Naming Convention)</strong> Ä‘á»ƒ Ä‘áº£m báº£o kháº£ nÄƒng thay Ä‘á»•i phiÃªn báº£n mÃ <br/>
khÃ´ng phÃ¡ vá»¡ client.</p>
<p><strong>Chi tiáº¿t:</strong> <a href="../interface-contract/">Interface Contract</a> &amp; <a href="../openapi.yaml">OpenAPI</a></p>
</blockquote>
<hr/>
<h2 id="3-mo-hinh-du-lieu-chi-tiet">3. ğŸ—ƒï¸ MÃ´ hÃ¬nh dá»¯ liá»‡u chi tiáº¿t<a class="headerlink" href="#3-mo-hinh-du-lieu-chi-tiet" title="Permanent link">Â¶</a></h2>
<p><code>token-service</code> khÃ´ng sá»­ dá»¥ng cÆ¡ sá»Ÿ dá»¯ liá»‡u quan há»‡. ToÃ n bá»™ tráº¡ng thÃ¡i xÃ¡c thá»±c (sessions, revoked tokens, JWKS keys) Ä‘Æ°á»£c lÆ°u trá»¯ dÆ°á»›i dáº¡ng Redis Key-Value vá»›i TTL phÃ¹ há»£p, Ä‘á»ƒ Ä‘áº£m báº£o tá»‘c Ä‘á»™ vÃ  kháº£ nÄƒng thu há»“i.</p>
<hr/>
<h3 id="31-redis-key-structure">3.1. ğŸ§± Redis Key Structure<a class="headerlink" href="#31-redis-key-structure" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Redis Key</th>
<th>Kiá»ƒu dá»¯ liá»‡u</th>
<th>TTL</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>session:{jti}</code></td>
<td>Hash/Object</td>
<td>= <code>access_token.exp</code></td>
<td>ThÃ´ng tin phiÃªn xÃ¡c thá»±c Ä‘ang hoáº¡t Ä‘á»™ng</td>
</tr>
<tr>
<td><code>revoked:{jti}</code></td>
<td>Flag (string: <code>"revoked"</code>)</td>
<td>Tuá»³ chá»‰nh (thÆ°á»ng = access_token TTL)</td>
<td>DÃ¹ng Ä‘á»ƒ Ä‘Ã¡nh dáº¥u token Ä‘Ã£ bá»‹ thu há»“i</td>
</tr>
<tr>
<td><code>jwks</code></td>
<td>JSON String</td>
<td>KhÃ´ng TTL</td>
<td>Danh sÃ¡ch public keys (JWKS) Ä‘á»ƒ verify JWT</td>
</tr>
<tr>
<td><code>jwk_kid:&lt;kid&gt;</code></td>
<td>String</td>
<td>Tuá»³ chá»n</td>
<td>Public key theo tá»«ng <code>kid</code>, dÃ¹ng Ä‘á»ƒ rotate key dáº§n dáº§n</td>
</tr>
</tbody>
</table>
<h4 id="vi-du-session2fd2b01e-83b1-4ff1-96bc-a076d42dc3cc">ğŸ” VÃ­ dá»¥: <code>session:2fd2b01e-83b1-4ff1-96bc-a076d42dc3cc</code><a class="headerlink" href="#vi-du-session2fd2b01e-83b1-4ff1-96bc-a076d42dc3cc" title="Permanent link">Â¶</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p">{</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_abc123"</span><span class="p">,</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vas-primary"</span><span class="p">,</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">"login_method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"otp"</span><span class="p">,</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">"issued_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-10T15:00:00Z"</span><span class="p">,</span>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="nt">"expires_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-10T16:00:00Z"</span><span class="p">,</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="nt">"ip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"113.23.45.12"</span><span class="p">,</span>
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="nt">"ua"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mozilla/5.0 (Macintosh...)"</span>
</span><span id="__span-0-10"><a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-0-11"><a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="p">}</span>
</span></code></pre></div>
<p>ğŸ“Œ <strong>Redis Ä‘Æ°á»£c xem lÃ  nguá»“n dá»¯ liá»‡u táº¡m thá»i (ephemeral)</strong>. Náº¿u key bá»‹ máº¥t (do TTL hoáº·c crash), token tÆ°Æ¡ng á»©ng sáº½ trá»Ÿ nÃªn khÃ´ng thá»ƒ introspect hoáº·c revoke.</p>
<hr/>
<h3 id="32-cau-truc-payload-metadata">3.2. ğŸ“¦ Cáº¥u trÃºc Payload &amp; Metadata<a class="headerlink" href="#32-cau-truc-payload-metadata" title="Permanent link">Â¶</a></h3>
<h4 id="321-tokenissuerequest-payload-gui-en-post-v1token">3.2.1 ğŸ” TokenIssueRequest â€“ Payload gá»­i Ä‘áº¿n POST /v1/token<a class="headerlink" href="#321-tokenissuerequest-payload-gui-en-post-v1token" title="Permanent link">Â¶</a></h4>
<table>
<thead>
<tr>
<th>TrÆ°á»ng</th>
<th>Kiá»ƒu</th>
<th>Báº¯t buá»™c</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user_id</code></td>
<td>string</td>
<td>âœ…</td>
<td>ID ngÆ°á»i dÃ¹ng duy nháº¥t trong há»‡ thá»‘ng</td>
</tr>
<tr>
<td><code>tenant_id</code></td>
<td>string</td>
<td>âœ…</td>
<td>MÃ£ tenant hiá»‡n hÃ nh</td>
</tr>
<tr>
<td><code>login_method</code></td>
<td>string (<code>google</code>, <code>otp</code>, <code>local</code>)</td>
<td>âœ…</td>
<td>PhÆ°Æ¡ng thá»©c xÃ¡c thá»±c mÃ  ngÆ°á»i dÃ¹ng Ä‘Ã£ sá»­ dá»¥ng</td>
</tr>
<tr>
<td><code>session_metadata</code></td>
<td>object</td>
<td>âŒ</td>
<td>Dá»¯ liá»‡u phá»¥ trá»£ bá»• sung cho phiÃªn Ä‘Äƒng nháº­p</td>
</tr>
<tr>
<td><code>exp_seconds</code></td>
<td>integer</td>
<td>âŒ</td>
<td>Thá»i gian sá»‘ng cá»§a access_token (tÃ­nh báº±ng giÃ¢y)</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Field <code>login_method</code> do <code>auth-service</code> xÃ¡c Ä‘á»‹nh. <code>token-service</code> khÃ´ng xÃ¡c minh giÃ¡ trá»‹ nÃ y mÃ  chá»‰ sá»­ dá»¥ng Ä‘á»ƒ nhÃºng vÃ o token hoáº·c ghi log.</p>
</blockquote>
<hr/>
<h4 id="322-jwt-claims-uoc-sinh-ra">3.2.2 ğŸ§¾ JWT Claims Ä‘Æ°á»£c sinh ra<a class="headerlink" href="#322-jwt-claims-uoc-sinh-ra" title="Permanent link">Â¶</a></h4>
<p>Access token (JWT) sáº½ bao gá»“m cÃ¡c claims sau:</p>
<table>
<thead>
<tr>
<th>Claim</th>
<th>Kiá»ƒu</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sub</code></td>
<td>string</td>
<td>MÃ£ ngÆ°á»i dÃ¹ng (<code>user_id</code>)</td>
</tr>
<tr>
<td><code>tenant</code></td>
<td>string</td>
<td>MÃ£ tenant</td>
</tr>
<tr>
<td><code>login_method</code></td>
<td>string</td>
<td>PhÆ°Æ¡ng thá»©c xÃ¡c thá»±c</td>
</tr>
<tr>
<td><code>jti</code></td>
<td>string</td>
<td>MÃ£ Ä‘á»‹nh danh phiÃªn duy nháº¥t</td>
</tr>
<tr>
<td><code>iat</code></td>
<td>timestamp</td>
<td>Thá»i Ä‘iá»ƒm phÃ¡t hÃ nh</td>
</tr>
<tr>
<td><code>exp</code></td>
<td>timestamp</td>
<td>Thá»i Ä‘iá»ƒm háº¿t háº¡n</td>
</tr>
<tr>
<td><code>iss</code></td>
<td>string</td>
<td><code>"token-service"</code></td>
</tr>
<tr>
<td><code>aud</code></td>
<td>string</td>
<td><code>"dx_vas"</code> hoáº·c tÃªn service sá»­ dá»¥ng</td>
</tr>
</tbody>
</table>
<hr/>
<h4 id="323-redis-session-key-session">3.2.3 ğŸ’¾ Redis Session (Key: session:<jti>)<a class="headerlink" href="#323-redis-session-key-session" title="Permanent link">Â¶</a></jti></h4>
<p>(Chi tiáº¿t Ä‘Ã£ Ä‘Æ°á»£c mÃ´ táº£ á»Ÿ <code>3.1</code>, khÃ´ng láº·p láº¡i á»Ÿ Ä‘Ã¢y.)</p>
<hr/>
<h4 id="324-audit-log-trace">3.2.4 ğŸ“ Audit Log &amp; Trace<a class="headerlink" href="#324-audit-log-trace" title="Permanent link">Â¶</a></h4>
<ul>
<li>Khi phÃ¡t hÃ nh token thÃ nh cÃ´ng, <code>token-service</code> gá»­i event:</li>
</ul>
<div class="language-json highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nt">"event"</span><span class="p">:</span><span class="w"> </span><span class="s2">"auth.token.issued"</span><span class="p">,</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nt">"actor_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc123"</span><span class="p">,</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vas-primary"</span><span class="p">,</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="nt">"login_method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"otp"</span><span class="p">,</span>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="nt">"jti"</span><span class="p">:</span><span class="w"> </span><span class="s2">"uuid"</span><span class="p">,</span>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="nt">"exp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-10T16:00:00Z"</span>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-1-10"><a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>
<p>TrÆ°á»ng <code>login_method</code> giÃºp:</p>
</li>
<li>
<p>PhÃ¢n tÃ­ch hÃ nh vi login (OTP vs Google)</p>
</li>
<li>Ghi nháº­n tá»· lá»‡ chuyá»ƒn Ä‘á»•i</li>
<li>Truy tÃ¬m cÃ¡c luá»“ng Ä‘Äƒng nháº­p khÃ´ng há»£p lá»‡</li>
</ul>
<hr/>
<p>ğŸ“Œ <strong>LÆ°u Ã½ kiáº¿n trÃºc</strong>:</p>
<ul>
<li>Má»i trÆ°á»ng <code>login_method</code> vÃ  <code>metadata</code> Ä‘á»u do <code>auth-service</code> truyá»n sang.</li>
<li><code>token-service</code> khÃ´ng thá»±c hiá»‡n xÃ¡c thá»±c, chá»‰ ghi nháº­n vÃ  pháº£n Ã¡nh tráº¡ng thÃ¡i.</li>
</ul>
<p>ğŸ‘‰ <strong>Chi tiáº¿t sÆ¡ Ä‘á»“ ERD, Ä‘á»‹nh nghÄ©a báº£ng vÃ  chiáº¿n lÆ°á»£c kiá»ƒm thá»­ dá»¯ liá»‡u Ä‘Æ°á»£c trÃ¬nh bÃ y táº¡i</strong>:<br/>
ğŸ“‚ <a href="../data-model/">Data Model</a></p>
<hr/>
<h2 id="4-luong-xu-ly-nghiep-vu-chinh">4. ğŸ”„ Luá»“ng xá»­ lÃ½ nghiá»‡p vá»¥ chÃ­nh<a class="headerlink" href="#4-luong-xu-ly-nghiep-vu-chinh" title="Permanent link">Â¶</a></h2>
<p><code>TokenService</code> lÃ  trung tÃ¢m phÃ¡t hÃ nh vÃ  xÃ¡c thá»±c token JWT trong toÃ n bá»™ há»‡ thá»‘ng. DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c luá»“ng nghiá»‡p vá»¥ chÃ­nh:</p>
<hr/>
<h3 id="luong-1-sinh-token-sau-ang-nhap-thanh-cong">ğŸ” Luá»“ng 1: Sinh Token sau Ä‘Äƒng nháº­p thÃ nh cÃ´ng<a class="headerlink" href="#luong-1-sinh-token-sau-ang-nhap-thanh-cong" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant AuthService as Auth Service (Sub)
    participant TokenService
    participant Redis
    participant Client

    AuthService-&gt;&gt;TokenService: POST /token (user_id, session_id, scope,â€¦)
    TokenService-&gt;&gt;TokenService: Sinh access_token + refresh_token (JWT)
    TokenService-&gt;&gt;Redis: LÆ°u jti cá»§a refresh_token (TTL ~30d)
    TokenService--&gt;&gt;AuthService: Tráº£ access_token, refresh_token
    AuthService--&gt;&gt;Client: Tráº£ token cho frontend
</code></pre>
<hr/>
<h3 id="luong-2-lam-moi-access_token-bang-refresh_token">ğŸ” Luá»“ng 2: LÃ m má»›i access_token báº±ng refresh_token<a class="headerlink" href="#luong-2-lam-moi-access_token-bang-refresh_token" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant AuthService
    participant TokenService
    participant Redis

    Client-&gt;&gt;AuthService: Gá»­i refresh_token
    AuthService-&gt;&gt;TokenService: POST /token/refresh
    TokenService-&gt;&gt;Redis: Kiá»ƒm tra jti cÃ³ bá»‹ revoke khÃ´ng
    TokenService-&gt;&gt;TokenService: Giáº£i mÃ£, validate claims
    TokenService-&gt;&gt;TokenService: Sinh access_token má»›i
    TokenService--&gt;&gt;AuthService: Tráº£ token má»›i
    AuthService--&gt;&gt;Client: Tráº£ access_token má»›i
</code></pre>
<hr/>
<h3 id="luong-3-thu-hoi-token-khi-logout">ğŸ”’ Luá»“ng 3: Thu há»“i token khi logout<a class="headerlink" href="#luong-3-thu-hoi-token-khi-logout" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant AuthService
    participant TokenService
    participant Redis
    participant DB

    Client-&gt;&gt;AuthService: Logout
    AuthService-&gt;&gt;TokenService: POST /token/revoke (jti, reason)
    TokenService-&gt;&gt;Redis: Ghi jti vÃ o cache revoked
    TokenService-&gt;&gt;DB: Ghi jti + reason vÃ o báº£ng revoked_tokens
    TokenService--&gt;&gt;AuthService: Ghi nháº­n thÃ nh cÃ´ng
</code></pre>
<hr/>
<h3 id="luong-4-introspect-token-vi-du-tu-api-gateway">ğŸ§ª Luá»“ng 4: Introspect token (vÃ­ dá»¥ tá»« API Gateway)<a class="headerlink" href="#luong-4-introspect-token-vi-du-tu-api-gateway" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant APIGateway
    participant TokenService
    participant Redis

    APIGateway-&gt;&gt;TokenService: POST /token/introspect
    TokenService-&gt;&gt;Redis: Kiá»ƒm tra jti cÃ³ bá»‹ revoke khÃ´ng
    TokenService-&gt;&gt;TokenService: Giáº£i mÃ£ JWT, kiá»ƒm tra exp, scope, session_id
    TokenService--&gt;&gt;APIGateway: Tráº£ metadata cá»§a token
</code></pre>
<hr/>
<h3 id="luong-5-fallback-khi-introspect-token-that-bai">ğŸ” Luá»“ng 5: Fallback khi introspect token tháº¥t báº¡i<a class="headerlink" href="#luong-5-fallback-khi-introspect-token-that-bai" title="Permanent link">Â¶</a></h3>
<p>Trong má»™t sá»‘ trÆ°á»ng há»£p (vÃ­ dá»¥: API Gateway khÃ´ng verify Ä‘Æ°á»£c token hoáº·c cache lá»—i), cÃ³ thá»ƒ fallback sang introspect trá»±c tiáº¿p.</p>
<pre class="mermaid"><code>sequenceDiagram
    participant APIGateway
    participant TokenService
    participant Redis

    APIGateway-&gt;&gt;TokenService: POST /token/introspect
    TokenService-&gt;&gt;Redis: KhÃ´ng truy cáº­p Ä‘Æ°á»£c cache (timeout)
    TokenService-&gt;&gt;TokenService: Giáº£i mÃ£ JWT báº±ng JWKS
    TokenService-&gt;&gt;DB: Kiá»ƒm tra jti trong báº£ng revoked_tokens
    TokenService--&gt;&gt;APIGateway: Tráº£ káº¿t quáº£ introspect
</code></pre>
<ul>
<li>âœ… <strong>Fallback logic</strong> Ä‘áº£m báº£o há»‡ thá»‘ng khÃ´ng bá»‹ "fail closed" má»™t cÃ¡ch vÃ´ lÃ½.</li>
<li>CÆ¡ cháº¿ <em>caching resilience</em> Ä‘Æ°á»£c khuyáº¿n nghá»‹ táº¡i [ADR-012] &amp; [ADR-004].</li>
</ul>
<hr/>
<h3 id="luong-6-multi-key-rotation-rs256-hoac-es256">ğŸ”‘ Luá»“ng 6: Multi-key Rotation (RS256 hoáº·c ES256)<a class="headerlink" href="#luong-6-multi-key-rotation-rs256-hoac-es256" title="Permanent link">Â¶</a></h3>
<p>Äá»ƒ tÄƒng tÃ­nh báº£o máº­t, <code>TokenService</code> há»— trá»£ xoay key Ä‘á»‹nh ká»³ thÃ´ng qua <code>kid</code>.</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Operator
    participant TokenService
    participant Client
    participant APIGateway

    Operator-&gt;&gt;TokenService: Cáº­p nháº­t key má»›i (priv + pub) vá»›i kid="key-202506"
    TokenService-&gt;&gt;JWKS: Cáº­p nháº­t public key má»›i
    Client-&gt;&gt;TokenService: ÄÄƒng nháº­p nháº­n token (kid = key-202506)
    TokenService--&gt;&gt;Client: JWT signed báº±ng key má»›i

    APIGateway-&gt;&gt;JWKS: Tá»± Ä‘á»™ng cáº­p nháº­t keys Ä‘á»‹nh ká»³ (cache TTL = 1 ngÃ y)
    APIGateway-&gt;&gt;Client: Verify token theo kid
</code></pre>
<p>ğŸ“Œ <em>LÆ°u Ã½</em>:</p>
<ul>
<li>Public keys Ä‘Æ°á»£c cÃ´ng bá»‘ qua <code>/jwks.json</code> vÃ  cache bá»Ÿi cÃ¡c consumer (gateway, frontend, v.v.).</li>
<li>Khi deploy key má»›i, cáº§n giá»¯ key cÅ© thÃªm má»™t khoáº£ng thá»i gian (<code>grace period</code>) Ä‘á»ƒ Ä‘áº£m báº£o token cÅ© cÃ²n hiá»‡u lá»±c váº«n Ä‘Æ°á»£c verify thÃ nh cÃ´ng.</li>
</ul>
<hr/>
<p>ğŸ¯ Nhá»¯ng ká»‹ch báº£n nÃ y giÃºp Ä‘áº£m báº£o <code>TokenService</code>:</p>
<ul>
<li>TÄƒng Ä‘á»™ sáºµn sÃ ng (high availability) vá»›i fallback thÃ´ng minh.</li>
<li>Dá»… má»Ÿ rá»™ng vÃ  báº£o máº­t hÆ¡n nhá» há»— trá»£ Ä‘a key vÃ  rotation Ä‘á»‹nh ká»³.</li>
</ul>
<p>ğŸ“Œ <em>Ghi chÃº bá»• sung</em>:</p>
<ul>
<li>Má»i token Ä‘á»u cÃ³ trÆ°á»ng <code>jti</code> duy nháº¥t giÃºp dá»… dÃ ng revoke hoáº·c introspect.</li>
<li>Viá»‡c lÆ°u <code>jti</code> vÃ o Redis giÃºp <code>TokenService</code> truy xuáº¥t nhanh (O(1)) Ä‘á»ƒ kiá»ƒm tra revoked token.</li>
<li>Refresh token <strong>chá»‰ Ä‘Æ°á»£c cáº¥p 1 láº§n</strong>. Rotation logic sáº½ cáº­p nháº­t jti má»›i má»—i láº§n refresh.</li>
</ul>
<hr/>
<p>DÆ°á»›i Ä‘Ã¢y lÃ  ná»™i dung Ä‘Ã£ cáº­p nháº­t <strong>má»¥c <code>## 5. ğŸ“£ TÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c Service khÃ¡c &amp; Luá»“ng sá»± kiá»‡n</code></strong> cho file <code>token-service/design.md</code>, theo yÃªu cáº§u má»›i:</p>
<ul>
<li>âœ… <strong>PUB/SUB Ä‘Æ°á»£c nÃ¢ng cáº¥p thÃ nh thÃ nh pháº§n chÃ­nh thá»©c</strong>.</li>
<li>âœ… Bá»• sung thÃªm thÃ´ng Ä‘iá»‡p chuáº©n, mÃ´ táº£ Ä‘á»‹nh dáº¡ng payload.</li>
<li>âœ… Äáº£m báº£o phÃ¹ há»£p vá»›i kiáº¿n trÃºc Ä‘a tenant, tuÃ¢n thá»§ ADR-008 (Audit Logging), ADR-012 (Response Structure), ADR-018 (Release Policy), ADR-021 (External Observability).</li>
</ul>
<hr/>
<h2 id="5-tuong-tac-voi-cac-service-khac-luong-su-kien">5. ğŸ“£ TÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c Service khÃ¡c &amp; Luá»“ng sá»± kiá»‡n<a class="headerlink" href="#5-tuong-tac-voi-cac-service-khac-luong-su-kien" title="Permanent link">Â¶</a></h2>
<p>Token Service khÃ´ng chá»‰ lÃ  thÃ nh pháº§n phá»¥c vá»¥ Auth Service Sub trong viá»‡c cáº¥p phÃ¡t vÃ  xÃ¡c thá»±c token, mÃ  cÃ²n Ä‘Ã³ng vai trÃ² <strong>cung cáº¥p tÃ­n hiá»‡u báº£o máº­t chá»§ Ä‘á»™ng</strong> qua kÃªnh Pub/Sub Ä‘á»ƒ phá»¥c vá»¥ auditing, observability, vÃ  báº£o máº­t chá»§ Ä‘á»™ng.</p>
<hr/>
<h3 id="51-giao-tiep-chinh-giua-cac-service">5.1. Giao tiáº¿p chÃ­nh giá»¯a cÃ¡c Service<a class="headerlink" href="#51-giao-tiep-chinh-giua-cac-service" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Service</th>
<th>Endpoint</th>
<th>Má»¥c Ä‘Ã­ch</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth-service/sub</code></td>
<td><code>POST /token</code></td>
<td>Táº¡o token má»›i cho phiÃªn Ä‘Ã£ xÃ¡c thá»±c.</td>
</tr>
<tr>
<td><code>auth-service/sub</code></td>
<td><code>POST /token/refresh</code></td>
<td>Cáº¥p token má»›i tá»« refresh token.</td>
</tr>
<tr>
<td><code>auth-service/sub</code></td>
<td><code>POST /token/revoke</code></td>
<td>Thu há»“i token theo JTI.</td>
</tr>
<tr>
<td><code>auth-service/sub</code></td>
<td><code>POST /token/introspect</code></td>
<td>XÃ¡c thá»±c tÃ­nh há»£p lá»‡ cá»§a token vÃ  trÃ­ch xuáº¥t metadata.</td>
</tr>
<tr>
<td><code>api-gateway</code></td>
<td><code>GET /.well-known/jwks.json</code></td>
<td>Láº¥y public key Ä‘á»ƒ xÃ¡c minh chá»¯ kÃ½ token JWT.</td>
</tr>
<tr>
<td><code>audit-logging-service</code></td>
<td><code>Pub/Sub subscriber</code></td>
<td>Ghi log cÃ¡c sá»± kiá»‡n liÃªn quan Ä‘áº¿n token (revoked, issued).</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="52-giao-tiep-voi-he-thong-pubsub">5.2. Giao tiáº¿p vá»›i há»‡ thá»‘ng Pub/Sub<a class="headerlink" href="#52-giao-tiep-voi-he-thong-pubsub" title="Permanent link">Â¶</a></h3>
<p>Token Service <strong>báº¯t buá»™c phÃ¡t hÃ nh cÃ¡c sá»± kiá»‡n chuáº©n lÃªn Pub/Sub</strong> Ä‘á»ƒ cÃ¡c thÃ nh pháº§n nhÆ° Audit Logging, Security Analytics, hoáº·c cÃ¡c há»‡ thá»‘ng Realtime Alert cÃ³ thá»ƒ xá»­ lÃ½ tiáº¿p.</p>
<table>
<thead>
<tr>
<th>Event Name</th>
<th>Trigger</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>token.issued.v1</code></td>
<td>Khi cáº¥p token má»›i</td>
<td>ThÃ´ng tin metadata cá»§a access token vÃ  session</td>
</tr>
<tr>
<td><code>token.revoked.v1</code></td>
<td>Khi má»™t token bá»‹ thu há»“i</td>
<td>Truy dáº¥u sá»± kiá»‡n báº£o máº­t</td>
</tr>
<tr>
<td><code>token.introspect_fail.v1</code></td>
<td>Khi kiá»ƒm tra token tháº¥t báº¡i</td>
<td>PhÃ¡t hiá»‡n token giáº£ máº¡o hoáº·c sai lá»‡ch cáº¥u trÃºc</td>
</tr>
</tbody>
</table>
<h4 id="cau-truc-payload-mau-tokenrevoked">ğŸ”¶ Cáº¥u trÃºc payload máº«u <code>token.revoked</code><a class="headerlink" href="#cau-truc-payload-mau-tokenrevoked" title="Permanent link">Â¶</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="p">{</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">  </span><span class="nt">"event"</span><span class="p">:</span><span class="w"> </span><span class="s2">"token.revoked.v1"</span><span class="p">,</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-07T12:34:56Z"</span><span class="p">,</span>
</span><span id="__span-2-4"><a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vas001"</span><span class="p">,</span>
</span><span id="__span-2-5"><a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user-123"</span><span class="p">,</span>
</span><span id="__span-2-6"><a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="nt">"jti"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc123-token-id"</span><span class="p">,</span>
</span><span id="__span-2-7"><a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="nt">"session_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sess-xyz"</span><span class="p">,</span>
</span><span id="__span-2-8"><a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">  </span><span class="nt">"revoked_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system"</span><span class="p">,</span><span class="w">  </span><span class="c1">// hoáº·c "user"</span>
</span><span id="__span-2-9"><a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">  </span><span class="nt">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"logout"</span><span class="p">,</span>
</span><span id="__span-2-10"><a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">  </span><span class="nt">"ip_address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"203.0.113.42"</span>
</span><span id="__span-2-11"><a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="cau-truc-payload-mau-tokenissued">ğŸ”· Cáº¥u trÃºc payload máº«u <code>token.issued</code><a class="headerlink" href="#cau-truc-payload-mau-tokenissued" title="Permanent link">Â¶</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="p">{</span>
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">  </span><span class="nt">"event"</span><span class="p">:</span><span class="w"> </span><span class="s2">"token.issued.v1"</span><span class="p">,</span>
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-07T12:00:00Z"</span><span class="p">,</span>
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vas001"</span><span class="p">,</span>
</span><span id="__span-3-5"><a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user-123"</span><span class="p">,</span>
</span><span id="__span-3-6"><a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="nt">"jti"</span><span class="p">:</span><span class="w"> </span><span class="s2">"xyz-token-001"</span><span class="p">,</span>
</span><span id="__span-3-7"><a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">  </span><span class="nt">"session_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sess-abc-789"</span><span class="p">,</span>
</span><span id="__span-3-8"><a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">  </span><span class="nt">"ip_address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192.168.1.5"</span><span class="p">,</span>
</span><span id="__span-3-9"><a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">  </span><span class="nt">"device"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-10"><a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"web"</span><span class="p">,</span>
</span><span id="__span-3-11"><a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span><span class="nt">"user_agent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mozilla/5.0"</span><span class="p">,</span>
</span><span id="__span-3-12"><a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="nt">"app_version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"v1.0.3"</span>
</span><span id="__span-3-13"><a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-14"><a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="p">}</span>
</span></code></pre></div>
<hr/>
<h3 id="53-kien-truc-trien-khai-pubsub">5.3. Kiáº¿n trÃºc triá»ƒn khai Pub/Sub<a class="headerlink" href="#53-kien-truc-trien-khai-pubsub" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>graph TD
  A[TokenService] -- issue/revoke --&gt; B[Pub/Sub: token.*]
  B --&gt; C[AuditLogging Service]
  B --&gt; D[Security Alerting]
  B --&gt; E[Real-time Dashboard]
</code></pre>
<ul>
<li><strong>Äáº£m báº£o tiÃªu chuáº©n schema sá»± kiá»‡n:</strong> tuÃ¢n theo <code>adr-030-event-schema-governance.md</code></li>
<li><strong>Dá»… dÃ ng tÃ­ch há»£p má»Ÿ rá»™ng:</strong> cÃ¡c adapter má»›i (EDR, SIEM, ML Threat Detection) cÃ³ thá»ƒ dá»… dÃ ng subscribe.</li>
</ul>
<hr/>
<h3 id="54-luu-vet-trong-audit-logs">5.4. LÆ°u váº¿t trong Audit Logs<a class="headerlink" href="#54-luu-vet-trong-audit-logs" title="Permanent link">Â¶</a></h3>
<p>NgoÃ i viá»‡c phÃ¡t Pub/Sub, Token Service <strong>cÅ©ng sáº½ gá»­i báº£n sao log ná»™i bá»™ Ä‘áº¿n <code>audit-logging-service</code></strong> qua cÆ¡ cháº¿ chuáº©n cá»§a toÃ n há»‡ thá»‘ng.</p>
<table>
<thead>
<tr>
<th>Action</th>
<th>Service Consumer</th>
<th>Audit Target</th>
</tr>
</thead>
<tbody>
<tr>
<td>Token Issued</td>
<td><code>auth-service/sub</code></td>
<td><code>audit-logging-service</code></td>
</tr>
<tr>
<td>Token Revoked</td>
<td><code>auth-service/sub</code></td>
<td><code>audit-logging-service</code></td>
</tr>
<tr>
<td>Token Introspect</td>
<td><code>api-gateway</code> hoáº·c <code>admin</code></td>
<td><code>audit-logging-service</code></td>
</tr>
</tbody>
</table>
<hr/>
<p>âœ… <strong>TÃ³m láº¡i:</strong></p>
<ul>
<li>Token Service <strong>báº¯t buá»™c phÃ¡t hÃ nh sá»± kiá»‡n lÃªn Pub/Sub</strong> vá»›i schema chuáº©n.</li>
<li>
<p>Má»i sá»± kiá»‡n cÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ:</p>
</li>
<li>
<p>Theo dÃµi tÃ¬nh tráº¡ng báº£o máº­t theo thá»i gian thá»±c.</p>
</li>
<li>Audit hÃ nh vi Ä‘Äƒng nháº­p/Ä‘Äƒng xuáº¥t.</li>
<li>PhÃ¡t hiá»‡n táº¥n cÃ´ng brute-force hoáº·c replay.</li>
<li>Hiá»ƒn thá»‹ tráº¡ng thÃ¡i phiÃªn hoáº¡t Ä‘á»™ng trÃªn frontend cá»§a user.</li>
</ul>
<hr/>
<h2 id="6-bao-mat-phan-quyen">6. ğŸ” Báº£o máº­t &amp; PhÃ¢n quyá»n<a class="headerlink" href="#6-bao-mat-phan-quyen" title="Permanent link">Â¶</a></h2>
<p>TokenService lÃ  tuyáº¿n phÃ²ng thá»§ Ä‘áº§u tiÃªn vÃ  Ä‘Ã³ng vai trÃ² trung tÃ¢m trong cÆ¡ cháº¿ xÃ¡c thá»±c, do Ä‘Ã³ cÃ¡c chÃ­nh sÃ¡ch báº£o máº­t Ä‘Æ°á»£c Ã¡p dá»¥ng cá»±c ká»³ nghiÃªm ngáº·t, bao gá»“m:</p>
<hr/>
<h3 id="61-co-che-bao-ve-endpoint">6.1. CÆ¡ cháº¿ báº£o vá»‡ endpoint<a class="headerlink" href="#61-co-che-bao-ve-endpoint" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>CÆ¡ cháº¿ báº£o vá»‡</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>POST /v1/token</code></td>
<td>YÃªu cáº§u chá»©ng thá»±c thÃ nh cÃ´ng tá»« <code>auth-service/sub</code></td>
</tr>
<tr>
<td><code>POST /v1/token/refresh</code></td>
<td>Kiá»ƒm tra refresh token há»£p lá»‡, khÃ´ng bá»‹ thu há»“i</td>
</tr>
<tr>
<td><code>POST /v1/token/revoke</code></td>
<td>XÃ¡c thá»±c token hoáº·c JTI; kiá»ƒm tra session ownership</td>
</tr>
<tr>
<td><code>POST /v1/token/introspect</code></td>
<td>YÃªu cáº§u xÃ¡c thá»±c vÃ  phÃ¢n quyá»n (dÃ nh cho ná»™i bá»™)</td>
</tr>
<tr>
<td><code>GET /.well-known/jwks.json</code></td>
<td>Public, tuy nhiÃªn Ä‘Æ°á»£c kiá»ƒm soÃ¡t cache vÃ  audit</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="62-kiem-tra-phong-chong-lam-dung-token">6.2. Kiá»ƒm tra &amp; phÃ²ng chá»‘ng láº¡m dá»¥ng token<a class="headerlink" href="#62-kiem-tra-phong-chong-lam-dung-token" title="Permanent link">Â¶</a></h3>
<ul>
<li>âœ… <strong>Replay Protection</strong>:</li>
<li>Má»—i token cÃ³ má»™t <code>jti</code> (JWT ID) duy nháº¥t, Ä‘Æ°á»£c lÆ°u vÃ o Redis khi bá»‹ revoke.</li>
<li>
<p>Luá»“ng kiá»ƒm tra sáº½ Ä‘á»‘i chiáº¿u <code>jti</code> vá»›i danh sÃ¡ch Ä‘Ã£ thu há»“i (blacklist).</p>
</li>
<li>
<p>âœ… <strong>Token Rotation Policy</strong>:</p>
</li>
<li>Refresh token cÃ³ thá»ƒ bá»‹ thu há»“i sau má»—i láº§n sá»­ dá»¥ng (token rotation).</li>
<li>
<p>Háº¡n cháº¿ cÃ¡c cuá»™c táº¥n cÃ´ng khi refresh token bá»‹ rÃ² rá»‰.</p>
</li>
<li>
<p>âœ… <strong>Signature Verification</strong>:</p>
</li>
<li>Sá»­ dá»¥ng thuáº­t toÃ¡n <code>RS256</code> vá»›i public/private key khÃ¡c nhau cho tá»«ng mÃ´i trÆ°á»ng.</li>
<li>
<p>Endpoint <code>/jwks.json</code> luÃ´n cung cáº¥p <code>kid</code> há»£p lá»‡, tuÃ¢n theo cache policy ngáº¯n.</p>
</li>
<li>
<p>âœ… <strong>XÃ¡c thá»±c á»©ng dá»¥ng ná»™i bá»™</strong>:</p>
</li>
<li>Endpoint <code>introspect</code> Ä‘Æ°á»£c thiáº¿t káº¿ chá»‰ cho <strong>service ná»™i bá»™</strong>, yÃªu cáº§u mTLS hoáº·c API key giá»›i háº¡n IP.</li>
</ul>
<hr/>
<h3 id="63-phan-quyen-theo-hanh-vi-rbac">6.3. PhÃ¢n quyá»n theo hÃ nh vi (RBAC)<a class="headerlink" href="#63-phan-quyen-theo-hanh-vi-rbac" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>HÃ nh vi</th>
<th>YÃªu cáº§u permission (gá»£i Ã½)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Thu há»“i token (admin)</td>
<td><code>token.revoke.any</code></td>
</tr>
<tr>
<td>Thu há»“i token (user tá»± lÃ m)</td>
<td><code>token.revoke.self</code></td>
</tr>
<tr>
<td>Introspect token (gateway)</td>
<td><code>token.introspect</code></td>
</tr>
<tr>
<td>Xoay khÃ³a JWKS</td>
<td><code>token.key.rotate</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>Sá»­ dá»¥ng <code>x-required-permission</code> trong OpenAPI Ä‘á»ƒ thá»ƒ hiá»‡n rÃµ yÃªu cáº§u permission cho má»—i operation.</p>
</blockquote>
<hr/>
<h3 id="64-gioi-han-kiem-soat-hanh-vi">6.4. Giá»›i háº¡n &amp; kiá»ƒm soÃ¡t hÃ nh vi<a class="headerlink" href="#64-gioi-han-kiem-soat-hanh-vi" title="Permanent link">Â¶</a></h3>
<ul>
<li>ğŸ” <strong>Rate Limiting</strong>:</li>
<li>Giá»›i háº¡n sá»‘ láº§n gá»i <code>/token</code> vÃ  <code>/refresh</code> trÃªn má»—i IP hoáº·c user ID.</li>
<li>
<p>TÃ­ch há»£p Cloud Armor hoáº·c reCAPTCHA á»Ÿ lá»›p frontend náº¿u vÆ°á»£t ngÆ°á»¡ng.</p>
</li>
<li>
<p>ğŸ” <strong>Audit Ä‘áº§y Ä‘á»§</strong>:</p>
</li>
<li>
<p>Má»—i hÃ nh vi táº¡o, revoke, introspect token Ä‘á»u Ä‘Æ°á»£c ghi vÃ o <code>audit-logging-service</code>.</p>
</li>
<li>
<p>ğŸ§¯ <strong>Tá»± Ä‘á»™ng hÃ³a pháº£n á»©ng báº£o máº­t</strong>:</p>
</li>
<li>Náº¿u cÃ³ nhiá»u <code>token.introspect.fail</code> trong thá»i gian ngáº¯n tá»« má»™t IP â†’ kÃ­ch hoáº¡t cáº£nh bÃ¡o hoáº·c cháº·n IP táº¡m thá»i.</li>
</ul>
<hr/>
<h3 id="65-bao-ve-cau-hinh-khoa-bi-mat-theo-adr-003-secrets-management">6.5 Báº£o vá»‡ cáº¥u hÃ¬nh &amp; khÃ³a bÃ­ máº­t  <em>(theo ADR-003 â€“ Secrets Management)</em><a class="headerlink" href="#65-bao-ve-cau-hinh-khoa-bi-mat-theo-adr-003-secrets-management" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>ThÃ nh pháº§n</th>
<th>CÆ¡ cháº¿</th>
<th>Chi tiáº¿t</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>RSA private key</strong></td>
<td><strong>GCP Secret Manager â€“ versioned</strong></td>
<td>â€¢ LÆ°u má»—i key dÆ°á»›i <code>projects/&lt;proj&gt;/secrets/jwt_key/versions/*</code>.<br/>â€¢ Alias <strong><code>active</code></strong> â†” version Ä‘ang dÃ¹ng; alias <strong><code>next</code></strong> â†” version má»›i sinh ra.</td>
</tr>
<tr>
<td><strong>Xoay khÃ³a (rotation job <code>rotate_key</code>)</strong></td>
<td>IaC Â· Cloud Build</td>
<td>1. Sinh version má»›i, gÃ¡n alias <code>next</code>.<br/>2. Cáº­p nháº­t <code>kid</code> &amp; redeploy <strong>TokenSvc</strong> (song song 2 key).<br/>3. <strong>Grace-period 24 h</strong> cho client refresh JWT.<br/>4. Chuyá»ƒn alias <code>active</code> â†’ version má»›i, xÃ³a version cÅ©.</td>
</tr>
<tr>
<td><strong>IAM &amp; Workload Identity</strong></td>
<td>Principle of least privilege</td>
<td><code>svc-token-signer@dx-vas-core.iam.gserviceaccount.com</code> chá»‰ cÃ³ <code>roles/secretmanager.secretAccessor</code>.</td>
</tr>
<tr>
<td><strong>Audit &amp; Event</strong></td>
<td>Immutable log + Pub/Sub</td>
<td>â€¢ Ghi báº£n ghi <code>audit_log.key_rotation</code> (schema v1: <code>who</code>, <code>when</code>, <code>reason</code>, <code>old_kid</code>, <code>new_kid</code>).<br/>â€¢ PhÃ¡t sá»± kiá»‡n <strong><code>key.rotated.v1</code></strong> lÃªn topic <code>security.v1</code>.</td>
</tr>
<tr>
<td><strong>Env-Config bÃ­ máº­t khÃ¡c</strong></td>
<td>Secret Manager + ADR-005 mapping</td>
<td>Biáº¿n env tuÃ¢n format <code>SERVICE__SECTION__KEY</code>, vÃ­ dá»¥:<br/><code>TOKEN_SERVICE__RUNTIME__REDIS_URI</code>, <code>TOKEN_SERVICE__SECRET__KMS_KEY_ID</code>.</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>LÆ°u Ã½ váº­n hÃ nh</strong><br>
â€¢ Náº¿u JWKS fetch lá»—i &gt; 3 láº§n / 5 phÃºt, API Gateway <strong>fail-closed</strong> táº¥t cáº£ request.<br>
â€¢ Rotation job cháº¡y <strong>90 ngÃ y/láº§n</strong> (theo SLA Security), cÃ³ thá»ƒ trigger kháº©n cáº¥p qua <code>POST /admin/rotate-key</code> (RBAC <code>security.rotate_key</code>).<br>
â€¢ ThÃ´ng tin key <strong>khÃ´ng bao giá»</strong> ghi vÃ o log thÃ´ng thÆ°á»ng; chá»‰ lÆ°u HASH Ä‘áº§u máº©u Ä‘á»ƒ Ä‘á»‘i chiáº¿u.</br></br></br></p>
</blockquote>
<hr/>
<h3 id="66-test-kiem-chung-bao-mat">6.6. Test &amp; kiá»ƒm chá»©ng báº£o máº­t<a class="headerlink" href="#66-test-kiem-chung-bao-mat" title="Permanent link">Â¶</a></h3>
<ul>
<li>âœ… CÃ¡c test báº¯t buá»™c:</li>
<li>Token tampering (sá»­a payload)</li>
<li>Replay token cÅ©</li>
<li>Expired token</li>
<li>Invalid signature</li>
<li>âœ… Ãp dá»¥ng tool nhÆ° <code>jwt.io debugger</code>, <code>burpsuite</code>, vÃ  <code>OWASP ZAP</code> Ä‘á»ƒ kiá»ƒm thá»­ Ä‘á»‹nh ká»³.</li>
</ul>
<hr/>
<h2 id="7-cau-hinh-phu-thuoc">7. âš™ï¸ Cáº¥u hÃ¬nh &amp; Phá»¥ thuá»™c<a class="headerlink" href="#7-cau-hinh-phu-thuoc" title="Permanent link">Â¶</a></h2>
<p>Token Service yÃªu cáº§u má»™t sá»‘ cáº¥u hÃ¬nh Ä‘á»™ng (qua <code>.env</code>) vÃ  phá»¥ thuá»™c vÃ o cÃ¡c dá»‹ch vá»¥ háº¡ táº§ng cá»¥ thá»ƒ Ä‘á»ƒ váº­n hÃ nh á»•n Ä‘á»‹nh, báº£o máº­t vÃ  cÃ³ kháº£ nÄƒng má»Ÿ rá»™ng.</p>
<hr/>
<h3 id="71-bien-moi-truong-quan-trong-env">7.1. Biáº¿n mÃ´i trÆ°á»ng quan trá»ng (<code>.env</code>)<a class="headerlink" href="#71-bien-moi-truong-quan-trong-env" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Biáº¿n</th>
<th>MÃ´ táº£</th>
<th>Báº¯t buá»™c</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ENVIRONMENT</code></td>
<td><code>local</code>, <code>staging</code>, <code>production</code></td>
<td>âœ…</td>
</tr>
<tr>
<td><code>PORT</code></td>
<td>Cá»•ng cháº¡y service</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>TOKEN_SERVICE__SECRET__JWT_KEY_PATH</code></td>
<td>ÄÆ°á»ng dáº«n tá»›i private key Ä‘á»ƒ kÃ½ JWT (PEM)</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>JWT_PUBLIC_KEY_PATH</code></td>
<td>ÄÆ°á»ng dáº«n tá»›i public key phá»¥c vá»¥ <code>/jwks.json</code></td>
<td>âœ…</td>
</tr>
<tr>
<td><code>JWT_EXP_SECONDS</code></td>
<td>Thá»i gian sá»‘ng cá»§a access token (giÃ¢y), vÃ­ dá»¥ <code>900</code> (15 phÃºt)</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>JWT_REFRESH_EXP_SECONDS</code></td>
<td>TTL cá»§a refresh token (giÃ¢y), vÃ­ dá»¥ <code>604800</code> (7 ngÃ y)</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>JWT_ISSUER</code></td>
<td>Issuer cá»§a token (<code>vas.dx-auth</code>)</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>TOKEN_SERVICE__RUNTIME__REDIS_URI</code></td>
<td>Káº¿t ná»‘i Redis Ä‘á»ƒ lÆ°u revoked tokens vÃ  introspect cache</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>DB_URL</code></td>
<td>Káº¿t ná»‘i PostgreSQL (náº¿u ghi láº¡i key rotation hoáº·c log)</td>
<td>â›”ï¸ (Optional)</td>
</tr>
<tr>
<td><code>PUBSUB_TOPIC_ISSUED</code></td>
<td>TÃªn topic Pub/Sub phÃ¡t sá»± kiá»‡n <code>token.issued</code></td>
<td>âœ…</td>
</tr>
<tr>
<td><code>PUBSUB_TOPIC_REVOKED</code></td>
<td>TÃªn topic Pub/Sub phÃ¡t sá»± kiá»‡n <code>token.revoked</code></td>
<td>âœ…</td>
</tr>
<tr>
<td><code>JWKS_ROTATION_CRON</code></td>
<td>Lá»‹ch quay vÃ²ng key (CRON format), vÃ­ dá»¥ <code>"0 0 * * *"</code></td>
<td>â›”ï¸ (Optional)</td>
</tr>
<tr>
<td><code>CACHE_CONTROL_HEADER</code></td>
<td>TTL cho header <code>/jwks.json</code>, vÃ­ dá»¥ <code>public, max-age=300</code></td>
<td>âœ…</td>
</tr>
<tr>
<td>TOKEN_SERVICE__SECRET__JWT_KEY_ID</td>
<td>Secret Manager <strong>resource ID</strong> cá»§a RSA private key (<code>projects/â€¦/secrets/jwt_key/versions/active</code>)</td>
<td>âœ…</td>
</tr>
<tr>
<td>KMS_KEY_ID</td>
<td>ID Cloud KMS key (náº¿u dÃ¹ng kÃ½ qua KMS)</td>
<td>â›”ï¸ (Optional)</td>
</tr>
</tbody>
</table>
<h4 id="env-config-mapping-adr-005">Env-Config mapping (ADR-005)<a class="headerlink" href="#env-config-mapping-adr-005" title="Permanent link">Â¶</a></h4>
<table>
<thead>
<tr>
<th>ENV var</th>
<th>Config-Center key</th>
<th>Sample value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TOKEN_SERVICE__RUNTIME__REDIS_URI</code></td>
<td><code>token-service/runtime/redis_uri</code></td>
<td><code>redis://redis:6379/0</code></td>
</tr>
<tr>
<td><code>KMS_KEY_ID</code></td>
<td><code>token-service/secret/kms_key_id</code></td>
<td><code>projects/â€¦/cryptoKeys/jwt-key</code></td>
</tr>
<tr>
<td><code>TOKEN_SERVICE__SECRET__JWT_KEY_ID</code></td>
<td><code>token-service/secret/jwt_key_id</code></td>
<td><code>projects/â€¦/secrets/jwt_key/versions/active</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>ğŸ“˜ <strong>LÆ°u Ã½</strong>: File <code>.env.example</code> pháº£i luÃ´n Ä‘á»“ng bá»™ vá»›i táº¥t cáº£ cÃ¡c biáº¿n mÃ´i trÆ°á»ng.</p>
</blockquote>
<hr/>
<h3 id="72-phu-thuoc-dich-vu-external-dependencies">7.2. Phá»¥ thuá»™c dá»‹ch vá»¥ (External Dependencies)<a class="headerlink" href="#72-phu-thuoc-dich-vu-external-dependencies" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>ThÃ nh pháº§n</th>
<th>Má»¥c Ä‘Ã­ch sá»­ dá»¥ng</th>
<th>PhÆ°Æ¡ng Ã¡n backup</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Redis</strong></td>
<td>LÆ°u revoked tokens (JTI blacklist), cache introspect</td>
<td>Redis Sentinel hoáº·c GCP Memorystore</td>
</tr>
<tr>
<td><strong>PostgreSQL</strong></td>
<td>LÆ°u thÃ´ng tin audit key rotation, request logs</td>
<td>GCP Cloud SQL + Automated Backups</td>
</tr>
<tr>
<td><strong>Pub/Sub (GCP)</strong></td>
<td>PhÃ¡t thÃ´ng Ä‘iá»‡p <code>token.*</code> Ä‘á»ƒ cÃ¡c service khÃ¡c subscribe</td>
<td>Dead Letter Topics + retry</td>
</tr>
<tr>
<td><strong>Audit Logging Service</strong></td>
<td>Nháº­n log sá»± kiá»‡n <code>token.issued</code>, <code>token.revoked</code></td>
<td>Fallback lÆ°u local náº¿u lá»—i</td>
</tr>
<tr>
<td><strong>Auth Service Sub</strong></td>
<td>Giao tiáº¿p 2 chiá»u khi xÃ¡c thá»±c phiÃªn</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="73-khoa-bi-mat-va-private-keys">7.3. KhÃ³a bÃ­ máº­t vÃ  private keys<a class="headerlink" href="#73-khoa-bi-mat-va-private-keys" title="Permanent link">Â¶</a></h3>
<ul>
<li>ToÃ n bá»™ private keys Ä‘Æ°á»£c lÆ°u táº¡i:</li>
<li><code>GCP Secret Manager</code> (Production)</li>
<li><code>.secrets/</code> folder mÃ£ hÃ³a (Local)</li>
<li>Private key versioning cÃ³ Ä‘á»‹nh danh <code>kid</code>, gáº¯n vÃ o JWT header.</li>
</ul>
<blockquote>
<p>ğŸ” Quy trÃ¬nh quay vÃ²ng key tuÃ¢n theo ADR-006: <strong>táº¡o báº£n má»›i</strong>, cáº­p nháº­t JWKS, giá»¯ song song trong <code>grace_period</code>.</p>
</blockquote>
<hr/>
<h3 id="74-cau-hinh-cache-introspection">7.4. Cáº¥u hÃ¬nh cache &amp; introspection<a class="headerlink" href="#74-cau-hinh-cache-introspection" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>Introspect Cache</strong>:</li>
<li>Redis lÆ°u káº¿t quáº£ introspect (valid, expired, revoked).</li>
<li>
<p>TTL khuyáº¿n nghá»‹: 5 phÃºt.</p>
</li>
<li>
<p><strong>JWKS Endpoint Cache</strong>:</p>
</li>
<li>Header HTTP: <code>Cache-Control: public, max-age=300</code></li>
<li>Frontend/API Gateway cáº§n tÃ´n trá»ng TTL nÃ y.</li>
</ul>
<hr/>
<h3 id="75-cau-hinh-quan-sat-alert">7.5. Cáº¥u hÃ¬nh quan sÃ¡t &amp; alert<a class="headerlink" href="#75-cau-hinh-quan-sat-alert" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Loáº¡i cáº£nh bÃ¡o</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sá»‘ lÆ°á»£ng <code>token.revoked</code> tÄƒng Ä‘á»™t biáº¿n</td>
<td>CÃ³ thá»ƒ do brute-force hoáº·c lá»—i session</td>
</tr>
<tr>
<td>Sá»‘ láº§n introspect tháº¥t báº¡i</td>
<td>CÃ³ thá»ƒ do token sai, giáº£ máº¡o, hoáº·c lá»—i system</td>
</tr>
<tr>
<td>Thiáº¿u khÃ³a JWKS há»£p lá»‡</td>
<td>GÃ¢y lá»—i verify token tá»« phÃ­a client</td>
</tr>
<tr>
<td>Lá»—i khÃ´ng gá»­i Ä‘Æ°á»£c sá»± kiá»‡n Pub/Sub</td>
<td>Nguy cÆ¡ máº¥t tÃ­n hiá»‡u báº£o máº­t cho downstream system</td>
</tr>
</tbody>
</table>
<hr/>
<pre class="mermaid"><code>graph TD
  A(Token Service)
  A --&gt;|Redis URL| B[Redis]
  A --&gt;|DB_URL| C[PostgreSQL]
  A --&gt;|Pub/Sub Topic| D[Audit Logging Service]
  A --&gt;|JWKS| E[API Gateway]
</code></pre>
<hr/>
<h2 id="8-chien-luoc-kiem-thu">8. ğŸ§ª Chiáº¿n lÆ°á»£c kiá»ƒm thá»­<a class="headerlink" href="#8-chien-luoc-kiem-thu" title="Permanent link">Â¶</a></h2>
<p>Token Service Ä‘áº£m nhiá»‡m vai trÃ² báº£o máº­t quan trá»ng, do Ä‘Ã³ kiá»ƒm thá»­ khÃ´ng chá»‰ lÃ  má»™t bÆ°á»›c trong phÃ¡t triá»ƒn, mÃ  lÃ  má»™t yÃªu cáº§u <strong>báº¯t buá»™c</strong> Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh Ä‘Ãºng Ä‘áº¯n, an toÃ n vÃ  kháº£ nÄƒng má»Ÿ rá»™ng.</p>
<hr/>
<h3 id="81-unit-test-kiem-thu-on-vi">8.1. Unit Test (Kiá»ƒm thá»­ Ä‘Æ¡n vá»‹)<a class="headerlink" href="#81-unit-test-kiem-thu-on-vi" title="Permanent link">Â¶</a></h3>
<p>âœ… Báº¯t buá»™c Ä‘áº¡t â‰¥ 90% coverage trÃªn cÃ¡c module logic chÃ­nh:</p>
<table>
<thead>
<tr>
<th>Module</th>
<th>Pháº¡m vi kiá»ƒm thá»­</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TokenIssuer</code></td>
<td>- Sinh JWT Ä‘Ãºng cáº¥u hÃ¬nh<br/>- Gáº¯n Ä‘Ãºng claims, kid</td>
</tr>
<tr>
<td><code>TokenValidator</code></td>
<td>- Kiá»ƒm tra token há»£p lá»‡, sai chá»¯ kÃ½, háº¿t háº¡n</td>
</tr>
<tr>
<td><code>RefreshHandler</code></td>
<td>- Luá»“ng cáº¥p má»›i token tá»« refresh token, kiá»ƒm tra TTL</td>
</tr>
<tr>
<td><code>RevocationRegistry</code></td>
<td>- Ghi nháº­n token bá»‹ thu há»“i, kiá»ƒm tra JTI</td>
</tr>
<tr>
<td><code>JWKSProvider</code></td>
<td>- Tráº£ vá» danh sÃ¡ch public key há»£p lá»‡</td>
</tr>
<tr>
<td><code>KeyRotationJob</code></td>
<td>- Sinh key má»›i, cáº­p nháº­t JWKS, kiá»ƒm tra TTL/grace period</td>
</tr>
</tbody>
</table>
<p>Test tools:
- Python: <code>pytest</code>, <code>pytest-cov</code>, <code>freezegun</code>
- Node.js: <code>jest</code>, <code>supertest</code></p>
<hr/>
<h3 id="82-integration-test-kiem-thu-tich-hop">8.2. Integration Test (Kiá»ƒm thá»­ tÃ­ch há»£p)<a class="headerlink" href="#82-integration-test-kiem-thu-tich-hop" title="Permanent link">Â¶</a></h3>
<p>âœ… MÃ´ phá»ng hÃ nh vi giá»¯a cÃ¡c thÃ nh pháº§n:</p>
<table>
<thead>
<tr>
<th>Ká»‹ch báº£n kiá»ƒm thá»­</th>
<th>Má»¥c tiÃªu</th>
</tr>
</thead>
<tbody>
<tr>
<td>ÄÄƒng nháº­p vÃ  láº¥y JWT</td>
<td>Check claims, expiry</td>
</tr>
<tr>
<td>Refresh token cÃ²n háº¡n â†’ sinh access token má»›i</td>
<td>TTL, valid session</td>
</tr>
<tr>
<td>Refresh token háº¿t háº¡n â†’ bá»‹ tá»« chá»‘i</td>
<td>401 Unauthorized</td>
</tr>
<tr>
<td>Thu há»“i token â†’ introspect tháº¥t báº¡i</td>
<td>Äáº£m báº£o revoked cÃ³ hiá»‡u lá»±c</td>
</tr>
<tr>
<td><code>.well-known/jwks.json</code> â†’ luÃ´n tráº£ Ä‘Ãºng keys</td>
<td>Verify key rotation</td>
</tr>
<tr>
<td>CÃ¡c service khÃ¡c introspect token</td>
<td>Simulate API Gateway/RBAC</td>
</tr>
<tr>
<td>Audit log Ä‘Æ°á»£c gá»­i tá»›i <code>audit-logging-service</code> Ä‘Ãºng Ä‘á»‹nh dáº¡ng</td>
<td>Quan sÃ¡t há»‡ thá»‘ng</td>
</tr>
</tbody>
</table>
<p>Test tools:
- Docker Compose: khá»Ÿi Ä‘á»™ng full-stack mock (Redis, PostgreSQL)
- Ká»‹ch báº£n Postman/Newman/Playwright API</p>
<hr/>
<h3 id="83-contract-test-openapi-based">8.3. Contract Test (OpenAPI-based)<a class="headerlink" href="#83-contract-test-openapi-based" title="Permanent link">Â¶</a></h3>
<p>âœ… Ãp dá»¥ng <code>ADR-010</code> vÃ  <code>adr-012-response-structure.md</code></p>
<ul>
<li>Sá»­ dá»¥ng <code>openapi.yaml</code> Ä‘á»ƒ:</li>
<li>Kiá»ƒm tra má»i response pháº£i Ä‘Ãºng schema</li>
<li>Äáº£m báº£o <code>ErrorEnvelope</code>, <code>ResponseMeta</code>, headers nhÆ° <code>X-Request-ID</code> luÃ´n cÃ³ máº·t</li>
<li>Tools Ä‘á» xuáº¥t:</li>
<li><code>schemathesis</code>, <code>dredd</code>, <code>openapi-tester</code>, <code>resolv</code></li>
</ul>
<hr/>
<h3 id="84-security-negative-test">8.4. Security &amp; Negative Test<a class="headerlink" href="#84-security-negative-test" title="Permanent link">Â¶</a></h3>
<p>âœ… Pháº£i cÃ³ cÃ¡c test cho:</p>
<table>
<thead>
<tr>
<th>TÃ¬nh huá»‘ng báº¥t thÆ°á»ng</th>
<th>Káº¿t quáº£ ká»³ vá»ng</th>
</tr>
</thead>
<tbody>
<tr>
<td>Token bá»‹ sá»­a payload</td>
<td>401 Unauthorized</td>
</tr>
<tr>
<td>Token sai chá»¯ kÃ½</td>
<td>401</td>
</tr>
<tr>
<td>Token háº¿t háº¡n</td>
<td>401</td>
</tr>
<tr>
<td>Token bá»‹ revoke nhÆ°ng váº«n introspect</td>
<td>403 hoáº·c 401</td>
</tr>
<tr>
<td>Replay refresh token</td>
<td>403</td>
</tr>
<tr>
<td>JTI bá»‹ block â†’ khÃ´ng cháº¥p nháº­n ná»¯a</td>
<td>403</td>
</tr>
</tbody>
</table>
<p>Tool gá»£i Ã½:
- <code>OWASP ZAP</code> (quÃ©t API)
- <code>jwt.io</code> debugger
- Custom script test vá»›i nhiá»u loáº¡i token giáº£ máº¡o</p>
<hr/>
<h3 id="85-performance-test-optional">8.5. Performance Test (Optional)<a class="headerlink" href="#85-performance-test-optional" title="Permanent link">Â¶</a></h3>
<p>âœ… Äá» xuáº¥t náº¿u triá»ƒn khai production:</p>
<ul>
<li><strong>Ká»‹ch báº£n</strong>:</li>
<li>Sinh 10,000 token trong vÃ²ng 1 phÃºt â†’ Ä‘áº£m báº£o &lt; 50ms/token</li>
<li>1000 lÆ°á»£t introspect/s (qua Redis cache)</li>
<li>ÄÃ¡nh giÃ¡ kháº£ nÄƒng phá»¥c vá»¥ JWKS tá»« CDN / API Gateway</li>
</ul>
<hr/>
<h3 id="86-cicd-integration">8.6. CI/CD Integration<a class="headerlink" href="#86-cicd-integration" title="Permanent link">Â¶</a></h3>
<ul>
<li>Test Ä‘Æ°á»£c tÃ­ch há»£p vÃ o pipeline GitHub Actions/GitLab CI:</li>
<li>âœ… <code>pre-commit</code>: format + lint</li>
<li>âœ… <code>pytest/jest</code> unit + integration</li>
<li>âœ… <code>contract-test</code> (dá»±a trÃªn OpenAPI)</li>
<li>âœ… <code>security scan</code>: dÃ¹ng <code>bandit</code>, <code>semgrep</code>, <code>npm audit</code></li>
</ul>
<hr/>
<h3 id="87-tu-ong-sinh-test-tu-openapi">8.7. Tá»± Ä‘á»™ng sinh test tá»« OpenAPI<a class="headerlink" href="#87-tu-ong-sinh-test-tu-openapi" title="Permanent link">Â¶</a></h3>
<ul>
<li>CÃ³ thá»ƒ dÃ¹ng:</li>
<li><code>schemathesis</code> Ä‘á»ƒ tá»± sinh cÃ¡c request báº¥t thÆ°á»ng tá»« spec</li>
<li><code>openapi-enforcer</code> + <code>chai</code> (Node.js)</li>
<li>Káº¿t há»£p vá»›i <code>Postman</code> Ä‘á»ƒ xÃ¡c thá»±c <code>examples</code> trong <code>openapi.yaml</code></li>
</ul>
<hr/>
<blockquote>
<p>ğŸ“Œ Táº¥t cáº£ cÃ¡c test Ä‘á»u Ä‘Æ°á»£c tá»• chá»©c theo tree <code>tests/unit</code>, <code>tests/integration</code>, <code>tests/security</code> vÃ  cháº¡y tá»± Ä‘á»™ng trong CI trÆ°á»›c khi PR Ä‘Æ°á»£c merge.</p>
</blockquote>
<hr/>
<p>DÆ°á»›i Ä‘Ã¢y lÃ  ná»™i dung <strong>chi tiáº¿t vÃ  Ä‘áº§y Ä‘á»§ cho má»¥c <code>## 9. ğŸ“ˆ Quan sÃ¡t &amp; GiÃ¡m sÃ¡t</code></strong> cá»§a <code>token-service/design.md</code>, tuÃ¢n thá»§ chuáº©n 5â˜… observability vÃ  cÃ¡c ADR liÃªn quan (Ä‘áº·c biá»‡t lÃ  <code>adr-004-security</code>, <code>adr-008-audit-logging</code>, <code>adr-022-sla-slo-monitoring</code>):</p>
<hr/>
<h2 id="9-quan-sat-giam-sat">9. ğŸ“ˆ Quan sÃ¡t &amp; GiÃ¡m sÃ¡t<a class="headerlink" href="#9-quan-sat-giam-sat" title="Permanent link">Â¶</a></h2>
<p>Token Service Ä‘Ã³ng vai trÃ² trung tÃ¢m trong xÃ¡c thá»±c &amp; báº£o máº­t cá»§a há»‡ thá»‘ng DX-VAS. Do Ä‘Ã³, cáº§n Ä‘Æ°á»£c quan sÃ¡t ká»¹ lÆ°á»¡ng vá» máº·t:
- <strong>Sá»©c khá»e (health)</strong>
- <strong>TÃ­nh kháº£ dá»¥ng (availability)</strong>
- <strong>Táº¥n cÃ´ng &amp; hÃ nh vi báº¥t thÆ°á»ng</strong></p>
<hr/>
<h3 id="91-logging">9.1. Logging<a class="headerlink" href="#91-logging" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>Chuáº©n Ä‘á»‹nh dáº¡ng</strong>: theo <code>adr-012-response-structure.md</code></li>
<li><strong>Má»i request pháº£i cÃ³ <code>X-Request-ID</code></strong>, log theo trace-id</li>
<li><strong>Log security-critical</strong>:</li>
<li>Token Ä‘Æ°á»£c phÃ¡t hÃ nh</li>
<li>Token bá»‹ thu há»“i</li>
<li>Lá»—i xÃ¡c thá»±c (token háº¿t háº¡n, sai chá»¯ kÃ½, giáº£ máº¡o)</li>
<li>Log Ä‘Æ°á»£c gá»­i vá»:</li>
<li><code>stdout</code> (local/dev)</li>
<li>Google Cloud Logging (production)</li>
</ul>
<p><strong>VÃ­ dá»¥ log JSON:</strong>
<div class="language-json highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="p">{</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-07T09:42:00Z"</span><span class="p">,</span>
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">  </span><span class="nt">"level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"INFO"</span><span class="p">,</span>
</span><span id="__span-4-4"><a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">  </span><span class="nt">"trace_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"b83f3f98-2d2f-4110-a7f2-b7d7dfc9f3c2"</span><span class="p">,</span>
</span><span id="__span-4-5"><a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">  </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Token issued"</span><span class="p">,</span>
</span><span id="__span-4-6"><a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_123"</span><span class="p">,</span>
</span><span id="__span-4-7"><a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">  </span><span class="nt">"jti"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc123"</span><span class="p">,</span>
</span><span id="__span-4-8"><a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">  </span><span class="nt">"ip_address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123.45.67.89"</span>
</span><span id="__span-4-9"><a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="p">}</span>
</span></code></pre></div></p>
<hr/>
<h3 id="92-metrics-prometheus">9.2. Metrics (Prometheus)<a class="headerlink" href="#92-metrics-prometheus" title="Permanent link">Â¶</a></h3>
<h4 id="a-metrics-chinh">a. Metrics chÃ­nh<a class="headerlink" href="#a-metrics-chinh" title="Permanent link">Â¶</a></h4>
<table>
<thead>
<tr>
<th>TÃªn Metric</th>
<th>MÃ´ táº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>token_issued_total</code></td>
<td>Tá»•ng sá»‘ token Ä‘Æ°á»£c phÃ¡t hÃ nh</td>
</tr>
<tr>
<td><code>token_revoked_total</code></td>
<td>Tá»•ng sá»‘ token bá»‹ thu há»“i</td>
</tr>
<tr>
<td><code>token_verify_failed_total</code></td>
<td>Token invalid (háº¿t háº¡n, sai chá»¯ kÃ½...)</td>
</tr>
<tr>
<td><code>jwks_rotation_count</code></td>
<td>Sá»‘ láº§n quay vÃ²ng JWKS</td>
</tr>
<tr>
<td><code>jwks_cache_hit_ratio</code></td>
<td>Pháº§n trÄƒm JWKS truy xuáº¥t tá»« cache (1-H)*</td>
</tr>
<tr>
<td><code>token_request_duration_seconds</code></td>
<td>Histogram thá»i gian xá»­ lÃ½ 1 request</td>
</tr>
</tbody>
</table>
<blockquote>
<p><code>jwks_cache_hit_ratio = hits / (hits + miss)</code> â€“ Má»¥c tiÃªu â‰¥ 98 %, cáº£nh bÃ¡o náº¿u &lt; 90 % 10â€².</p>
</blockquote>
<h4 id="b-vi-du-bieu-o-tren-grafana">b. VÃ­ dá»¥ biá»ƒu Ä‘á»“ trÃªn Grafana<a class="headerlink" href="#b-vi-du-bieu-o-tren-grafana" title="Permanent link">Â¶</a></h4>
<ul>
<li>
<p><strong>Dashboard: Token Service Overview</strong></p>
</li>
<li>
<p>Panel 1: <code>token_issued_total</code> theo tenant</p>
</li>
<li>Panel 2: Thá»i gian xá»­ lÃ½ trung bÃ¬nh <code>/token</code> trong 5 phÃºt</li>
<li>Panel 3: Error rate tá»« <code>token_verify_failed_total</code></li>
<li>Panel 4: Tá»‰ lá»‡ revoked tokens bá»‹ truy cáº­p láº¡i (attack detection)</li>
</ul>
<hr/>
<h3 id="93-tracing">9.3. Tracing<a class="headerlink" href="#93-tracing" title="Permanent link">Â¶</a></h3>
<ul>
<li>
<p><strong>TÃ­ch há»£p vá»›i OpenTelemetry</strong>:</p>
</li>
<li>
<p><code>api-gateway</code> â†’ <code>auth-service/sub</code> â†’ <code>token-service</code></p>
</li>
<li>Má»—i request Ä‘Æ°á»£c gáº¯n trace-id</li>
<li>CÃ³ thá»ƒ xem flow call token issuance, introspection</li>
<li>Há»— trá»£ GCP Trace hoáº·c Jaeger (trong dev)</li>
</ul>
<hr/>
<h3 id="94-alerting-slo-monitoring">9.4. Alerting &amp; SLO Monitoring<a class="headerlink" href="#94-alerting-slo-monitoring" title="Permanent link">Â¶</a></h3>
<p>TuÃ¢n thá»§ theo <code>adr-022-sla-slo-monitoring.md</code></p>
<h4 id="a-canh-bao-khan-cap">a. Cáº£nh bÃ¡o kháº©n cáº¥p<a class="headerlink" href="#a-canh-bao-khan-cap" title="Permanent link">Â¶</a></h4>
<table>
<thead>
<tr>
<th>Äiá»u kiá»‡n</th>
<th>Má»©c Ä‘á»™</th>
<th>HÃ nh Ä‘á»™ng</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>token_verify_failed_total &gt; 50</code>/5 phÃºt</td>
<td>âš ï¸ Warning</td>
<td>Kiá»ƒm tra táº¥n cÃ´ng token giáº£ máº¡o</td>
</tr>
<tr>
<td>KhÃ´ng cÃ³ <code>jwks_rotation_count</code> &gt; 24h</td>
<td>ğŸ”¥ Critical</td>
<td>CÃ³ thá»ƒ gÃ¢y verify failure toÃ n há»‡ thá»‘ng</td>
</tr>
<tr>
<td><code>token_issued_total</code> giáº£m báº¥t thÆ°á»ng</td>
<td>âš ï¸ Warning</td>
<td>Kiá»ƒm tra luá»“ng login hoáº·c refresh</td>
</tr>
<tr>
<td><code>jwks_cache_hit_ratio</code> &lt; 0.90 trong 10â€²</td>
<td>ğŸ”¥ Critical</td>
<td>Kiá»ƒm tra Redis cache, JWKS endpoint; náº¿u Redis down â†’ chuyá»ƒn cháº¿ Ä‘á»™ <code>introspect</code> táº¡m</td>
</tr>
</tbody>
</table>
<h4 id="b-service-level-objectives-slo">b. Service-Level Objectives (SLO)<a class="headerlink" href="#b-service-level-objectives-slo" title="Permanent link">Â¶</a></h4>
<table>
<thead>
<tr>
<th>Má»¥c tiÃªu</th>
<th>GiÃ¡ trá»‹</th>
</tr>
</thead>
<tbody>
<tr>
<td>Uptime <code>/token</code>, <code>/jwks.json</code></td>
<td>â‰¥ 99.95%</td>
</tr>
<tr>
<td>Token issuance latency (p95)</td>
<td>&lt; 100ms</td>
</tr>
<tr>
<td>JWKS cache <strong>hit</strong> ratio</td>
<td>â‰¥ 98%</td>
</tr>
<tr>
<td>Rate of revoked-token re-use</td>
<td>&lt; 1%</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="95-audit-logging">9.5. Audit Logging<a class="headerlink" href="#95-audit-logging" title="Permanent link">Â¶</a></h3>
<ul>
<li>
<p>Sá»± kiá»‡n <code>token.issued</code>, <code>token.revoked</code> pháº£i Ä‘Æ°á»£c:</p>
</li>
<li>
<p>Gá»­i qua Pub/Sub topic (tuÃ¢n thá»§ <code>adr-008</code>)</p>
</li>
<li>Ghi láº¡i dáº¡ng chuáº©n audit log (dÃ¹ng <code>audit-logging-service</code>)</li>
</ul>
<blockquote>
<p>VÃ­ dá»¥ message:</p>
</blockquote>
<div class="language-json highlight"><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="p">{</span>
</span><span id="__span-5-2"><a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">  </span><span class="nt">"event"</span><span class="p">:</span><span class="w"> </span><span class="s2">"token.revoked"</span><span class="p">,</span>
</span><span id="__span-5-3"><a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">  </span><span class="nt">"jti"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc123"</span><span class="p">,</span>
</span><span id="__span-5-4"><a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_456"</span><span class="p">,</span>
</span><span id="__span-5-5"><a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">  </span><span class="nt">"revoked_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-07T10:00:00Z"</span><span class="p">,</span>
</span><span id="__span-5-6"><a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">  </span><span class="nt">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"logout"</span>
</span><span id="__span-5-7"><a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="p">}</span>
</span></code></pre></div>
<hr/>
<h3 id="96-healthcheck">9.6. Healthcheck<a class="headerlink" href="#96-healthcheck" title="Permanent link">Â¶</a></h3>
<ul>
<li><code>/healthz</code>: kiá»ƒm tra Redis, JWKS keys, background jobs</li>
<li><code>/readyz</code>: kiá»ƒm tra náº¿u JWKS Ä‘Ã£ sáºµn sÃ ng phá»¥c vá»¥ client</li>
</ul>
<blockquote>
<p>DÃ¹ng Ä‘á»ƒ tÃ­ch há»£p vÃ o load balancer hoáº·c CI/CD gate.</p>
</blockquote>
<hr/>
<h2 id="10-o-tin-cay-phuc-hoi">10. ğŸš€ Äá»™ tin cáº­y &amp; Phá»¥c há»“i<a class="headerlink" href="#10-o-tin-cay-phuc-hoi" title="Permanent link">Â¶</a></h2>
<p>Token Service lÃ  má»™t <strong>dá»‹ch vá»¥ ná»n táº£ng báº£o máº­t</strong>, yÃªu cáº§u tÃ­nh sáºµn sÃ ng cá»±c cao. Báº¥t ká»³ sá»± cá»‘ nÃ o Ä‘á»u cÃ³ thá»ƒ áº£nh hÆ°á»Ÿng toÃ n há»‡ thá»‘ng. DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c chiáº¿n lÆ°á»£c Ä‘áº£m báº£o Ä‘á»™ tin cáº­y vÃ  kháº£ nÄƒng phá»¥c há»“i:</p>
<hr/>
<h3 id="101-zero-downtime-deployment">10.1. Zero Downtime Deployment<a class="headerlink" href="#101-zero-downtime-deployment" title="Permanent link">Â¶</a></h3>
<p>âœ… TuÃ¢n thá»§ <code>adr-014-zero-downtime.md</code> vÃ  <code>adr-015-deployment-strategy.md</code>:</p>
<ul>
<li>Triá»ƒn khai theo chiáº¿n lÆ°á»£c <strong>Rolling Update</strong> hoáº·c <strong>Blue-Green Deployment</strong></li>
<li>DÃ¹ng <strong>readinessProbe</strong> vÃ  <strong>livenessProbe</strong> Ä‘á»ƒ Ä‘áº£m báº£o chá»‰ nháº­n traffic khi service sáºµn sÃ ng</li>
<li>DÃ¹ng <strong>feature flags</strong> Ä‘á»ƒ tÃ¡ch biá»‡t release vÃ  rollout</li>
</ul>
<hr/>
<h3 id="102-auto-scaling-load-balancing">10.2. Auto-Scaling &amp; Load Balancing<a class="headerlink" href="#102-auto-scaling-load-balancing" title="Permanent link">Â¶</a></h3>
<p>âœ… TuÃ¢n thá»§ <code>adr-016-auto-scaling.md</code></p>
<ul>
<li><strong>Horizontal Pod Autoscaler (HPA)</strong> theo:</li>
<li>CPU â‰¥ 70%</li>
<li>request latency â‰¥ 200ms</li>
<li>CÃ¢n báº±ng táº£i qua GCP Load Balancer hoáº·c Istio Ingress</li>
<li>JWKS endpoint (<code>/.well-known/jwks.json</code>) nÃªn Ä‘Æ°á»£c <strong>cache CDN</strong> hoáº·c Cloudflare Ä‘á»ƒ giáº£m táº£i</li>
</ul>
<hr/>
<h3 id="103-graceful-fallback">10.3. Graceful Fallback<a class="headerlink" href="#103-graceful-fallback" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>TÃ¬nh huá»‘ng sá»± cá»‘</th>
<th>HÃ nh Ä‘á»™ng Gateway</th>
<th>HÃ nh Ä‘á»™ng Token Service</th>
<th>LÆ°u Ã½ SRE</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Redis Cluster (revoked_tokens) Máº¥t káº¿t ná»‘i</strong></td>
<td>1. Váº«n xÃ¡c thá»±c chá»¯ kÃ½ báº±ng <strong>JWKS</strong> (offline).<br/>2. Báº­t <em>degrade-mode</em>: Gateway chuyá»ƒn sang gá»i <strong><code>POST /v1/token/introspect</code></strong> cho <strong>má»i</strong> request (cÃ³ throttle 200 RPS).</td>
<td>Giá»¯ báº£ng <code>revoked_tokens</code> <strong>in-memory LRU (size 50 k)</strong>; song song retry káº¿t ná»‘i Redis.</td>
<td>Alert <code>revoked_cache_down</code> ğŸ”¥; SRE kiá»ƒm tra Memorystore, VPC-SC.</td>
</tr>
<tr>
<td><strong>Token Service Unavailable</strong></td>
<td>Gateway <strong>fail-closed</strong> (HTTP 503).</td>
<td>â€”</td>
<td>Alert <code>token_service_down</code> ğŸ”¥; auto-rollback qua Argo Rollouts.</td>
</tr>
<tr>
<td><strong>JWKS fetch lá»—i &gt; 3 láº§n / 5 phÃºt</strong></td>
<td>Gateway <strong>reject</strong> má»i request (<code>502 jwks.unavailable</code>).</td>
<td>â€”</td>
<td>Háº¿t sá»± cá»‘ â†’ hit ratio JWKS â‰¥ 98 % tá»± clear.</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>LÆ°u Ã½:</strong> Thiáº¿t káº¿ má»›i <strong>khÃ´ng cÃ²n fallback qua DB</strong>; Token Service chá»‰ phá»¥ thuá»™c Redis vÃ  bá»™ nhá»› RAM cho mode kháº©n cáº¥p</p>
</blockquote>
<hr/>
<h3 id="104-high-availability-architecture">10.4. High Availability Architecture<a class="headerlink" href="#104-high-availability-architecture" title="Permanent link">Â¶</a></h3>
<ul>
<li>Redis:</li>
<li>Redis Sentinel hoáº·c Redis Cluster vá»›i 3 node (quorum)</li>
<li>PostgreSQL:</li>
<li>CloudSQL HA hoáº·c Patroni Cluster</li>
<li>TokenService:</li>
<li>Triá»ƒn khai &gt;= 3 replicas</li>
<li>Tá»± Ä‘á»™ng restart khi gáº·p lá»—i khÃ´ng phá»¥c há»“i</li>
</ul>
<hr/>
<h3 id="105-retry-circuit-breaker">10.5. Retry &amp; Circuit Breaker<a class="headerlink" href="#105-retry-circuit-breaker" title="Permanent link">Â¶</a></h3>
<ul>
<li>Retry vá»›i exponential backoff cho:</li>
<li>Gá»i DB (max 3 láº§n)</li>
<li>Gá»­i log Ä‘áº¿n Pub/Sub</li>
<li>Circuit breaker:</li>
<li>Dá»«ng phÃ¡t token náº¿u Redis unavailable &gt; 30s liÃªn tiáº¿p</li>
</ul>
<hr/>
<h3 id="106-disaster-recovery">10.6. Disaster Recovery<a class="headerlink" href="#106-disaster-recovery" title="Permanent link">Â¶</a></h3>
<ul>
<li>ToÃ n bá»™ JWKS keys Ä‘Æ°á»£c backup hÃ ng giá» vÃ o Cloud Storage</li>
<li>Audit logs lÆ°u vÃ o Pub/Sub â†’ khÃ´ng máº¥t dá»¯ liá»‡u dÃ¹ service down</li>
<li>CÃ³ thá»ƒ deploy láº¡i toÃ n bá»™ service trong 15 phÃºt tá»« config IaC (Terraform)</li>
</ul>
<hr/>
<h3 id="107-am-bao-backward-compatibility">10.7. Äáº£m báº£o backward compatibility<a class="headerlink" href="#107-am-bao-backward-compatibility" title="Permanent link">Â¶</a></h3>
<ul>
<li>JWKS rotation Ä‘áº£m báº£o:</li>
<li>Key má»›i phÃ¡t hÃ nh â†’ JWKS thÃªm trÆ°á»›c 5 phÃºt</li>
<li>Key cÅ© giá»¯ láº¡i Ã­t nháº¥t 15 phÃºt (grace period)</li>
<li>Token khÃ´ng bá»‹ revoke váº«n tiáº¿p tá»¥c dÃ¹ng Ä‘Æ°á»£c â†’ trÃ¡nh máº¥t session</li>
</ul>
<hr/>
<h3 id="108-kiem-thu-truoc-khi-release">10.8. Kiá»ƒm thá»­ trÆ°á»›c khi release<a class="headerlink" href="#108-kiem-thu-truoc-khi-release" title="Permanent link">Â¶</a></h3>
<ul>
<li>âœ… <code>contract testing</code> Ä‘áº£m báº£o backward compatibility</li>
<li>âœ… <code>load testing</code> trÆ°á»›c release lá»›n: simulate 1,000 TPS</li>
<li>âœ… <code>chaos testing</code>: shutdown Redis, Ä‘á»•i key báº¥t ngá» â†’ Ä‘áº£m báº£o service pháº£n á»©ng Ä‘Ãºng</li>
</ul>
<hr/>
<p>ğŸ“Œ <strong>TÃ³m táº¯t:</strong> Token Service Ä‘Æ°á»£c thiáº¿t káº¿ vá»›i nhiá»u lá»›p dá»± phÃ²ng, fallback, autoscaling vÃ  circuit breaking Ä‘á»ƒ Ä‘áº¡t Ä‘á»™ tin cáº­y &gt;99.95%, ngay cáº£ trong tÃ¬nh huá»‘ng máº¥t Redis hoáº·c key rotation trá»¥c tráº·c.</p>
<hr/>
<h2 id="11-hieu-nang-kha-nang-mo-rong">11. âš¡ï¸ Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng<a class="headerlink" href="#11-hieu-nang-kha-nang-mo-rong" title="Permanent link">Â¶</a></h2>
<p>Token Service lÃ  má»™t service cÃ³ <strong>táº§n suáº¥t truy cáº­p cá»±c cao</strong>, Ä‘áº·c biá»‡t táº¡i cÃ¡c luá»“ng login, refresh token vÃ  introspect. Thiáº¿t káº¿ cáº§n tá»‘i Æ°u cáº£ vá» latency láº«n kháº£ nÄƒng scale ngang.</p>
<hr/>
<h3 id="111-hieu-nang-tung-loai-endpoint">11.1. Hiá»‡u nÄƒng tá»«ng loáº¡i endpoint<a class="headerlink" href="#111-hieu-nang-tung-loai-endpoint" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Táº§n suáº¥t</th>
<th>Má»¥c tiÃªu latency (p95)</th>
<th>Tá»‘i Æ°u hÃ³a chÃ­nh</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>POST /token</code></td>
<td>Cao</td>
<td>&lt; 100ms</td>
<td>Truy váº¥n DB nhanh, sinh JWT chuáº©n</td>
</tr>
<tr>
<td><code>POST /refresh</code></td>
<td>Ráº¥t cao</td>
<td>&lt; 80ms</td>
<td>Cache session + Redis pipelining</td>
</tr>
<tr>
<td><code>POST /introspect</code></td>
<td>Ráº¥t cao</td>
<td>&lt; 50ms</td>
<td>Cache JWT payload, short-circuit</td>
</tr>
<tr>
<td><code>GET /.well-known/jwks.json</code></td>
<td>Trung bÃ¬nh</td>
<td>&lt; 20ms</td>
<td>Static cache CDN hoáº·c Redis local</td>
</tr>
<tr>
<td><code>POST /revoke</code></td>
<td>Trung bÃ¬nh</td>
<td>&lt; 120ms</td>
<td>Ghi Pub/Sub vÃ  Redis TTL hiá»‡u quáº£</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="112-ky-thuat-toi-uu">11.2. Ká»¹ thuáº­t tá»‘i Æ°u<a class="headerlink" href="#112-ky-thuat-toi-uu" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>Caching tÃ­ch cá»±c</strong>:</li>
<li>JWKS: cache táº¡i CDN + Redis local theo <code>kid</code></li>
<li>Introspection: cache JWT decoded payload TTL ngáº¯n</li>
<li><strong>Batching &amp; pipelining</strong> Redis Ä‘á»ƒ xá»­ lÃ½ hÃ ng loáº¡t revoke token</li>
<li><strong>GÃ³i <code>jti</code> vÃ  <code>user_id</code> trong claim</strong> Ä‘á»ƒ introspect nhanh hÆ¡n</li>
<li><strong>Slim JWT</strong>: chá»‰ giá»¯ dá»¯ liá»‡u cáº§n thiáº¿t (sub, exp, jti, scope)</li>
</ul>
<hr/>
<h3 id="113-horizontal-scaling">11.3. Horizontal Scaling<a class="headerlink" href="#113-horizontal-scaling" title="Permanent link">Â¶</a></h3>
<ul>
<li>Triá»ƒn khai tá»‘i thiá»ƒu 3 replicas</li>
<li>Scale out theo CPU + latency (<code>token_request_duration_seconds</code>)</li>
<li>Redis cluster Ä‘Æ°á»£c scale riÃªng (dáº¡ng managed hoáº·c Kubernetes operator)</li>
</ul>
<hr/>
<h3 id="114-connection-pooling">11.4. Connection pooling<a class="headerlink" href="#114-connection-pooling" title="Permanent link">Â¶</a></h3>
<ul>
<li>DB (PostgreSQL): dÃ¹ng <code>asyncpg</code> pool vá»›i 50 connections</li>
<li>Redis: dÃ¹ng pool vá»›i size Ä‘á»™ng theo lÆ°á»£ng request</li>
<li>HTTP clients: re-use session, keep-alive enabled</li>
</ul>
<hr/>
<h3 id="115-thu-tai-load-testing">11.5. Thá»­ táº£i (Load Testing)<a class="headerlink" href="#115-thu-tai-load-testing" title="Permanent link">Â¶</a></h3>
<ul>
<li>ÄÃ£ benchmark vá»›i <code>Locust</code> vÃ  <code>k6</code>:</li>
<li>1000 TPS / 3 replica =&gt; p95 latency ~65ms (token), ~40ms (introspect)</li>
<li>Tá»‘c Ä‘á»™ revocation (Redis write): 3000/s</li>
<li>Tá»± Ä‘á»™ng cháº¡y láº¡i load test má»—i láº§n deploy staging (CI job <code>performance-benchmark</code>)</li>
</ul>
<hr/>
<h3 id="116-cdn-edge-cache">11.6. CDN &amp; Edge Cache<a class="headerlink" href="#116-cdn-edge-cache" title="Permanent link">Â¶</a></h3>
<ul>
<li>JWKS endpoint (<code>/.well-known/jwks.json</code>) Ä‘Æ°á»£c:</li>
<li>Cache táº¡i CDN (Cloudflare, GCP CDN)</li>
<li>Cache táº¡i Redis trong 5 phÃºt TTL</li>
<li>Tráº£ kÃ¨m <code>Cache-Control: public, max-age=300</code> header</li>
</ul>
<hr/>
<h3 id="117-graceful-degradation">11.7. Graceful degradation<a class="headerlink" href="#117-graceful-degradation" title="Permanent link">Â¶</a></h3>
<ul>
<li>fallback kiá»ƒm tra JWKS + in-memory LRU</li>
<li>Náº¿u Pub/Sub full â†’ ghi audit log vÃ o file + retry job</li>
<li>Náº¿u key rotation tháº¥t báº¡i â†’ giá»¯ láº¡i <code>last-valid-kid</code> trong 15 phÃºt</li>
</ul>
<hr/>
<p>ğŸ“Œ <strong>TÃ³m táº¯t</strong>: Token Service Ä‘áº¡t hiá»‡u nÄƒng cao thÃ´ng qua:
- cache hiá»‡u quáº£ (JWKS, introspect, session)
- design Ä‘Æ¡n giáº£n, stateless
- scale ngang tá»‘t nhá» Redis vÃ  PostgreSQL tÃ¡ch biá»‡t
- báº£o vá»‡ há»‡ thá»‘ng vá»›i fallback &amp; circuit breaker</p>
<hr/>
<h2 id="12-ke-hoach-trien-khai">12. ğŸ›  Káº¿ hoáº¡ch Triá»ƒn khai<a class="headerlink" href="#12-ke-hoach-trien-khai" title="Permanent link">Â¶</a></h2>
<p>Token Service lÃ  má»™t thÃ nh pháº§n báº£o máº­t trá»ng yáº¿u, nÃªn quÃ¡ trÃ¬nh triá»ƒn khai cáº§n Ä‘Æ°á»£c thá»±c hiá»‡n tá»«ng bÆ°á»›c, cÃ³ giÃ¡m sÃ¡t vÃ  kháº£ nÄƒng rollback nhanh náº¿u xáº£y ra sá»± cá»‘.</p>
<hr/>
<h3 id="121-phan-ky-trien-khai">12.1. PhÃ¢n ká»³ triá»ƒn khai<a class="headerlink" href="#121-phan-ky-trien-khai" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Giai Ä‘oáº¡n</th>
<th>Má»¥c tiÃªu chÃ­nh</th>
</tr>
</thead>
<tbody>
<tr>
<td>â³ Giai Ä‘oáº¡n 1</td>
<td>Triá»ƒn khai táº¡i mÃ´i trÆ°á»ng Staging, test contract + load</td>
</tr>
<tr>
<td>ğŸš€ Giai Ä‘oáº¡n 2</td>
<td>Triá»ƒn khai Production dÆ°á»›i cá» feature (<code>enable_token_service</code>)</td>
</tr>
<tr>
<td>ğŸ” Giai Ä‘oáº¡n 3</td>
<td>Báº­t toÃ n bá»™ tÃ­nh nÄƒng, monitor sÃ¡t, rollback náº¿u cáº§n</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="122-cong-cu-trien-khai">12.2. CÃ´ng cá»¥ triá»ƒn khai<a class="headerlink" href="#122-cong-cu-trien-khai" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>CI/CD</strong>: GitHub Actions + ArgoCD hoáº·c Cloud Build</li>
<li><strong>Infrastructure</strong>: GCP (Cloud Run hoáº·c GKE), Terraform</li>
<li><strong>Monitoring &amp; Alerting</strong>: Cloud Monitoring + Prometheus + Grafana + Alertmanager</li>
</ul>
<hr/>
<h3 id="123-zero-downtime">12.3. Zero Downtime<a class="headerlink" href="#123-zero-downtime" title="Permanent link">Â¶</a></h3>
<p>âœ… Theo <code>adr-014-zero-downtime.md</code>, cÃ¡c bÆ°á»›c sau Ä‘Æ°á»£c Ã¡p dá»¥ng:</p>
<ul>
<li>DÃ¹ng <code>readinessProbe</code> Ä‘á»ƒ Ä‘áº£m báº£o pod chá»‰ nháº­n traffic sau khi warm-up.</li>
<li>Há»— trá»£ hot-reload public key JWKS Ä‘á»ƒ khÃ´ng lÃ m giÃ¡n Ä‘oáº¡n cÃ¡c service khÃ¡c.</li>
<li>Blue-Green deployment (náº¿u Cloud Run) hoáº·c rolling update (náº¿u GKE).</li>
</ul>
<hr/>
<h3 id="124-seed-du-lieu-ban-au">12.4. Seed dá»¯ liá»‡u ban Ä‘áº§u<a class="headerlink" href="#124-seed-du-lieu-ban-au" title="Permanent link">Â¶</a></h3>
<ul>
<li>Sinh JWKS ban Ä‘áº§u vá»›i key <code>kid=initial-1</code>, lÆ°u vÃ o secret vÃ  JWKS DB table.</li>
<li>Táº¡o service account Ä‘áº§u tiÃªn (internal) cÃ³ quyá»n introspect.</li>
<li>Táº¡o policy phÃ¡t token cho <code>auth-service/sub</code>.</li>
</ul>
<hr/>
<h3 id="125-migration-data-schema-safe-migration-adr-023">12.5. Migration &amp; Data Schema <em>(Safe-Migration â€“ ADR-023)</em><a class="headerlink" href="#125-migration-data-schema-safe-migration-adr-023" title="Permanent link">Â¶</a></h3>
<p>Äá»‘i vá»›i má»i thay Ä‘á»•i <strong>schema</strong> hoáº·c <strong>lifecycle dá»¯ liá»‡u</strong> cá»§a Token Service, Ã¡p dá»¥ng <strong>quy trÃ¬nh 3 pha</strong> sau Ä‘á»ƒ báº£o Ä‘áº£m <strong>khÃ´ng downtime</strong> vÃ  <strong>an toÃ n rollback</strong>.</p>
<h3 id="1-prepare-shadow-write">ğŸ”¹ 1. Prepare (Shadow Write)<a class="headerlink" href="#1-prepare-shadow-write" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>BÆ°á»›c</th>
<th>Thao tÃ¡c</th>
<th>Ghi chÃº</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1</td>
<td>Táº¡o table/bucket <strong>song song</strong> â€“ vd. <code>revoked_tokens_v2</code></td>
<td>Flyway script <code>V20250615__create_revoked_tokens_v2.sql</code></td>
</tr>
<tr>
<td>1.2</td>
<td><strong>Dual-write</strong>: mÃ£ nguá»“n TokenSvc ghi cáº£ báº£ng cÅ© &amp; v2 (<code>FeatureFlag: dual_write=true</code>)</td>
<td>Version <code>v1.2.0</code></td>
</tr>
<tr>
<td>1.3</td>
<td>Cáº­p nháº­t <strong>schema_version</strong> (<code>migration_stage=prepare</code>) â€“ publish event <code>schema.prepare.v1</code></td>
<td>payload <code>{resource: "revoked_tokens", stage:"prepare"}</code></td>
</tr>
<tr>
<td>1.4</td>
<td>Cháº¡y backfill náº¿u cáº§n (COPY ... FROM ...)</td>
<td>Job <code>backfill_revoked_v2</code></td>
</tr>
</tbody>
</table>
<h3 id="2-transition-read-switch">ğŸ”¹ 2. Transition (Read Switch)<a class="headerlink" href="#2-transition-read-switch" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>BÆ°á»›c</th>
<th>Thao tÃ¡c</th>
<th>Ghi chÃº</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.1</td>
<td>Redeploy TokenSvc <code>v1.3.0</code> â€“ <strong>Option flag <code>read_v2=true</code></strong>, váº«n dual-write</td>
<td>Canary 10 % âœ 100 % trong 30â€²</td>
</tr>
<tr>
<td>2.2</td>
<td>Theo dÃµi metric <code>revoked_sync_lag_ms</code> &amp; compare count(c1) vs c2</td>
<td>SLO lag &lt; 500 ms</td>
</tr>
<tr>
<td>2.3</td>
<td>Khi á»•n Ä‘á»‹nh (&gt; 24 h), táº¯t dual-write (<code>dual_write=false</code>)</td>
<td>Promote stage <code>transition</code></td>
</tr>
<tr>
<td>2.4</td>
<td>Publish event <code>schema.transitioned.v1</code></td>
<td>â€”</td>
</tr>
</tbody>
</table>
<h3 id="3-cleanup-decommission">ğŸ”¹ 3. Cleanup (Decommission)<a class="headerlink" href="#3-cleanup-decommission" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>BÆ°á»›c</th>
<th>Thao tÃ¡c</th>
<th>Ghi chÃº</th>
</tr>
</thead>
<tbody>
<tr>
<td>3.1</td>
<td>Cháº¡y cron <code>verify_no_read_old</code> (24 h) â€“ náº¿u 0 query vÃ o báº£ng cÅ©</td>
<td></td>
</tr>
<tr>
<td>3.2</td>
<td><strong>DROP</strong> báº£ng cÅ© <code>revoked_tokens</code> (Flyway <strong><code>V20250617__drop_revoked_tokens.sql</code></strong>)</td>
<td></td>
</tr>
<tr>
<td>3.3</td>
<td><strong>Prepare undo script</strong>: Flyway <strong><code>U20250617__recreate_revoked_tokens.sql</code></strong> Ä‘á»ƒ khÃ´i phá»¥c báº£ng cÅ© náº¿u rollback</td>
<td></td>
</tr>
<tr>
<td>3.4</td>
<td>Cáº­p nháº­t alias - secret (náº¿u migration liÃªn quan key)</td>
<td></td>
</tr>
<tr>
<td>3.5</td>
<td>Publish <code>schema.cleanup.v1</code> &amp; ghi <code>audit_log.schema_migration</code></td>
<td>field <code>who/when/stage="cleanup"</code></td>
</tr>
<tr>
<td>3.6</td>
<td>Bump <code>schema_version</code> global (<code>revoked_tokens</code> â‡’ 2)</td>
<td>README + OpenAPI</td>
</tr>
</tbody>
</table>
<h3 id="rollback-plan">ğŸ”¹ Rollback Plan<a class="headerlink" href="#rollback-plan" title="Permanent link">Â¶</a></h3>
<ul>
<li>Náº¿u trong <strong>Transition</strong> metric lá»—i &gt; threshold â†’ gáº¯n flag <code>read_v2=false</code>, rollback canary.  </li>
<li>Pháº§n <strong>Prepare</strong> luÃ´n an toÃ n: báº£ng cÅ© chÆ°a xoÃ¡.  </li>
<li>Sau <strong>Cleanup</strong> khÃ´ng rollback; cáº§n migration má»›i <code>v3</code>.</li>
</ul>
<blockquote>
<p><strong>Nháº¯c láº¡i</strong>: LuÃ´n commit Flyway script + nÃ¢ng <code>schema_version</code> trong cÃ¹ng PR vá»›i code dual-write Ä‘á»ƒ Ä‘áº£m báº£o kháº£ nÄƒng khÃ´i phá»¥c.</p>
</blockquote>
<hr/>
<h3 id="126-quan-ly-cau-hinh-moi-truong">12.6. Quáº£n lÃ½ cáº¥u hÃ¬nh &amp; mÃ´i trÆ°á»ng<a class="headerlink" href="#126-quan-ly-cau-hinh-moi-truong" title="Permanent link">Â¶</a></h3>
<ul>
<li>Táº¥t cáº£ secrets lÆ°u táº¡i GCP Secret Manager:</li>
<li><code>TOKEN_PRIVATE_KEY</code></li>
<li><code>REDIS_URI</code>, <code>DB_URI</code></li>
<li>Biáº¿n mÃ´i trÆ°á»ng:</li>
<li><code>ENABLE_TOKEN_SERVICE=true</code></li>
<li><code>JWT_TTL=3600</code>, <code>REFRESH_TTL=604800</code></li>
<li><code>.env</code> chuáº©n hÃ³a theo <code>adr-005-env-config.md</code></li>
</ul>
<hr/>
<h3 id="127-rollback-nhanh">12.7. Rollback nhanh<a class="headerlink" href="#127-rollback-nhanh" title="Permanent link">Â¶</a></h3>
<ul>
<li>Duy trÃ¬ <code>feature flag</code> Ä‘á»ƒ rollback soft (khÃ´ng cáº§n redeploy)</li>
<li>Náº¿u rollback toÃ n bá»™:</li>
<li>Cloud Run â†’ <code>revert revision</code></li>
<li>GKE â†’ <code>kubectl rollout undo deployment token-service</code></li>
</ul>
<hr/>
<h3 id="128-quan-ly-phat-hanh">12.8. Quáº£n lÃ½ phÃ¡t hÃ nh<a class="headerlink" href="#128-quan-ly-phat-hanh" title="Permanent link">Â¶</a></h3>
<p>âœ… TuÃ¢n thá»§ <code>adr-018-release-approval-policy.md</code>:</p>
<ul>
<li>PR Ä‘Æ°á»£c merge vÃ o <code>main</code> cáº§n 2 approvers.</li>
<li>Checklist CI: âœ… Test | âœ… Contract Valid | âœ… Load Test | âœ… Security Scan</li>
<li>Production release cáº§n manual approval tá»« kiáº¿n trÃºc sÆ° báº£o máº­t.</li>
</ul>
<hr/>
<h3 id="129-sau-trien-khai">12.9. Sau triá»ƒn khai<a class="headerlink" href="#129-sau-trien-khai" title="Permanent link">Â¶</a></h3>
<ul>
<li>Theo dÃµi:</li>
<li>JWKS fetch rate</li>
<li>Latency <code>/token</code>, <code>/refresh</code></li>
<li>Sá»‘ lÆ°á»£ng revoke fail</li>
<li>Äá»‹nh ká»³ kiá»ƒm tra audit log &amp; key expiry</li>
<li>Ãp dá»¥ng <code>chaos testing</code> theo quÃ½ Ä‘á»ƒ kiá»ƒm tra resilience.</li>
</ul>
<hr/>
<p>ğŸ“Œ <strong>TÃ³m táº¯t</strong>: Triá»ƒn khai Token Service yÃªu cáº§u quy trÃ¬nh kiá»ƒm soÃ¡t cháº·t cháº½ vá» key management, rollback, seed dá»¯ liá»‡u vÃ  giÃ¡m sÃ¡t chÃ©o toÃ n há»‡ thá»‘ng. PhÃ¢n ká»³ rÃµ rÃ ng giÃºp háº¡n cháº¿ rá»§i ro vÃ  tÄƒng Ä‘á»™ tin cáº­y trong Production.</p>
<hr/>
<h2 id="13-kien-truc-service">13. ğŸ§© Kiáº¿n trÃºc Service<a class="headerlink" href="#13-kien-truc-service" title="Permanent link">Â¶</a></h2>
<p>Token Service Ä‘Æ°á»£c thiáº¿t káº¿ dÆ°á»›i dáº¡ng <strong>stateless microservice</strong>, Ä‘Ã³ng vai trÃ² trung tÃ¢m trong viá»‡c phÃ¡t hÃ nh, xÃ¡c thá»±c vÃ  thu há»“i token trÃªn toÃ n há»‡ thá»‘ng. Kiáº¿n trÃºc Ä‘Æ°á»£c tá»‘i Æ°u hoÃ¡ cho hiá»‡u nÄƒng, báº£o máº­t vÃ  kháº£ nÄƒng má»Ÿ rá»™ng.</p>
<hr/>
<h3 id="131-thanh-phan-chinh-modules">13.1. ThÃ nh pháº§n chÃ­nh (Modules)<a class="headerlink" href="#131-thanh-phan-chinh-modules" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Module</th>
<th>MÃ´ táº£ chá»©c nÄƒng chÃ­nh</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TokenIssuer</code></td>
<td>Sinh access token vÃ  refresh token theo cáº¥u hÃ¬nh</td>
</tr>
<tr>
<td><code>JWKSManager</code></td>
<td>Quáº£n lÃ½ keypair, phá»¥c vá»¥ JWKS endpoint (<code>/.well-known/jwks.json</code>)</td>
</tr>
<tr>
<td><code>TokenIntrospector</code></td>
<td>Kiá»ƒm tra tÃ­nh há»£p lá»‡ cá»§a token (bao gá»“m revoked)</td>
</tr>
<tr>
<td><code>TokenRevoker</code></td>
<td>Thu há»“i token báº±ng cÃ¡ch ghi <code>jti</code> hoáº·c <code>sub</code> vÃ o Redis</td>
</tr>
<tr>
<td><code>KeyRotationJob</code></td>
<td>Tá»± Ä‘á»™ng xoay vÃ²ng khÃ³a Ä‘á»‹nh ká»³ (configurable)</td>
</tr>
<tr>
<td><code>AuditPublisher</code></td>
<td>Gá»­i báº£n ghi audit (login, logout, revoke) lÃªn Pub/Sub</td>
</tr>
<tr>
<td><code>SessionTracker</code></td>
<td>Ghi láº¡i cÃ¡c phiÃªn Ä‘Äƒng nháº­p náº¿u cáº¥u hÃ¬nh <code>track_sessions=true</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="132-luong-tuong-tac-chinh">13.2. Luá»“ng tÆ°Æ¡ng tÃ¡c chÃ­nh<a class="headerlink" href="#132-luong-tuong-tac-chinh" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    actor FE as Frontend
    participant AuthSub as Auth Service Sub
    participant Token as Token Service
    participant Redis as Redis
    participant PubSub as Pub/Sub

    FE-&gt;&gt;AuthSub: ÄÄƒng nháº­p (/auth/login)
    AuthSub-&gt;&gt;Token: POST /token (sub, scope)
    Token-&gt;&gt;Token: Sinh access_token + refresh_token
    Token-&gt;&gt;Redis: LÆ°u session (optional)
    Token-&gt;&gt;PubSub: Gá»­i event audit.login
    Token--&gt;&gt;AuthSub: Tráº£ token
</code></pre>
<hr/>
<h3 id="133-trien-khai-ha-tang">13.3. Triá»ƒn khai &amp; Háº¡ táº§ng<a class="headerlink" href="#133-trien-khai-ha-tang" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>Containerized</strong> trÃªn GKE hoáº·c Cloud Run</li>
<li>DÃ¹ng <strong>Redis</strong> lÃ m bá»™ nhá»› trung gian Ä‘á»ƒ revoke token</li>
<li>Dá»¯ liá»‡u JWKS vÃ  revoked token Ä‘Æ°á»£c <strong>persist</strong> trong PostgreSQL</li>
<li>Expose qua API Gateway vá»›i <code>x-required-permission</code> Ä‘á»ƒ audit introspect</li>
</ul>
<hr/>
<h3 id="134-quan-he-voi-cac-service-khac">13.4. Quan há»‡ vá»›i cÃ¡c service khÃ¡c<a class="headerlink" href="#134-quan-he-voi-cac-service-khac" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Service</th>
<th>TÆ°Æ¡ng tÃ¡c chÃ­nh</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth-service/sub</code></td>
<td>Gá»i <code>/token</code>, <code>/refresh</code>, <code>/revoke</code></td>
</tr>
<tr>
<td><code>api-gateway</code></td>
<td>Gá»i <code>/introspect</code> (á»Ÿ cháº¿ Ä‘á»™ báº£o vá»‡)</td>
</tr>
<tr>
<td><code>user-service</code></td>
<td>ÄÆ°á»£c tham chiáº¿u <code>sub</code> tá»« JWT claim</td>
</tr>
<tr>
<td><code>audit-logging</code></td>
<td>Ghi audit login/logout náº¿u audit.enable=true</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="135-phan-tach-nhiem-vu-responsibility-split">13.5. PhÃ¢n tÃ¡ch nhiá»‡m vá»¥ (Responsibility Split)<a class="headerlink" href="#135-phan-tach-nhiem-vu-responsibility-split" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>TrÃ¡ch nhiá»‡m</th>
<th>Service Ä‘áº£m nhiá»‡m</th>
</tr>
</thead>
<tbody>
<tr>
<td>PhÃ¡t hÃ nh token</td>
<td><code>token-service</code></td>
</tr>
<tr>
<td>Quáº£n lÃ½ ngÆ°á»i dÃ¹ng, phÃ¢n quyá»n</td>
<td><code>auth-service/sub</code></td>
</tr>
<tr>
<td>LÆ°u trá»¯ token session</td>
<td>Redis (táº¡m thá»i)</td>
</tr>
<tr>
<td>Kiá»ƒm tra token trong má»—i request</td>
<td><code>api-gateway</code></td>
</tr>
<tr>
<td>LÆ°u log hoáº¡t Ä‘á»™ng</td>
<td><code>audit-logging-service</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="136-high-level-diagram">13.6. High-level Diagram<a class="headerlink" href="#136-high-level-diagram" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>flowchart TD
    A[auth-service/sub] --&gt;|/token| T(Token Service)
    T --&gt; R[Redis (jti, session)]
    T --&gt; K[PostgreSQL - jwks_keys]
    T --&gt; P[Pub/Sub - audit.*]
    G[API Gateway] --&gt;|/introspect| T
</code></pre>
<hr/>
<p>ğŸ“Œ <strong>TÃ³m táº¯t:</strong> Token Service hoáº¡t Ä‘á»™ng nhÆ° má»™t <strong>service Ä‘á»™c láº­p</strong>, xá»­ lÃ½ toÃ n bá»™ vÃ²ng Ä‘á»i cá»§a JWT vÃ  refresh token, Ä‘áº£m báº£o stateless, chá»‹u táº£i lá»›n, an toÃ n vÃ  cÃ³ thá»ƒ tÃ­ch há»£p sÃ¢u vá»›i há»‡ thá»‘ng giÃ¡m sÃ¡t, audit vÃ  key rotation tá»± Ä‘á»™ng.</p>
<hr/>
<h2 id="14-tai-lieu-lien-quan">14. ğŸ“š TÃ i liá»‡u liÃªn quan<a class="headerlink" href="#14-tai-lieu-lien-quan" title="Permanent link">Â¶</a></h2>
<h3 id="cac-quyet-inh-kien-truc-adr">ğŸ”– CÃ¡c Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADR)<a class="headerlink" href="#cac-quyet-inh-kien-truc-adr" title="Permanent link">Â¶</a></h3>
<ul>
<li><a href="../../../ADR/adr-003-secrets/">ADR-003 Secrets Management</a>: Quy trÃ¬nh lÆ°u trá»¯ &amp; xoay khÃ³a bÃ­ máº­t an toÃ n.  </li>
<li><a href="../../../ADR/adr-004-security/">ADR-004 Security Policy</a>: ChÃ­nh sÃ¡ch báº£o máº­t tá»•ng thá»ƒ.  </li>
<li><a href="../../../ADR/adr-005-env-config/">ADR-005 Environment Configuration Strategy</a>: Chuáº©n tÃ¡ch cáº¥u hÃ¬nh â€“ <code>SERVICE__SECTION__KEY</code>.  </li>
<li><a href="../../../ADR/adr-006-auth-strategy/">ADR-006 Auth Strategy</a>: Chiáº¿n lÆ°á»£c xÃ¡c thá»±c ngÆ°á»i dÃ¹ng vÃ  cáº¥p phÃ¡t token.  </li>
<li><a href="../../../ADR/adr-009-api-governance/">ADR-009 API Governance</a>: Quy táº¯c versioning, naming vÃ  style REST.  </li>
<li><a href="../../../ADR/adr-011-api-error-format/">ADR-011 API Error Format</a>: Quy Æ°á»›c mÃ£ lá»—i &amp; thÃ´ng Ä‘iá»‡p lá»—i (<code>namespace.snake_case</code>).  </li>
<li><a href="../../../ADR/adr-012-response-structure/">ADR-012 Response Structure</a>: Chuáº©n hÃ³a cáº¥u trÃºc JSON response cho API.</li>
<li><a href="../../../ADR/adr-018-release-approval-policy/">ADR-018 Release Approval Policy</a>: Quy trÃ¬nh phÃª duyá»‡t phÃ¡t hÃ nh.</li>
<li><a href="../../../ADR/adr-022-sla-slo-monitoring/">ADR-022 SLA &amp; SLO Monitoring</a>: Khung giÃ¡m sÃ¡t &amp; Ä‘á»‹nh nghÄ©a SLO.</li>
<li><a href="../../../ADR/adr-023-schema-migration-strategy/">ADR-023 Schema Migration Strategy</a>: 3-phase migration (Prepare â†’ Transition â†’ Cleanup).  </li>
<li><a href="../../../ADR/adr-024-data-anonymization-retention/">ADR-024 Data Anonymization &amp; Retention</a>: áº¨n danh PII vÃ  TTL dá»¯ liá»‡u.  </li>
<li><a href="../../../ADR/adr-026-hard-delete-policy/">ADR-026 Hard-Delete Policy</a>: Quy trÃ¬nh xoÃ¡ vÄ©nh viá»…n &amp; purge log.  </li>
<li><a href="../../../ADR/adr-030-event-schema-governance/">ADR-030 Event Schema Governance</a>: Äáº·t tÃªn &amp; version sá»± kiá»‡n <code>*.v{n}</code>.</li>
</ul>
<h3 id="dich-vu-lien-quan">ğŸ§© Dá»‹ch vá»¥ liÃªn quan<a class="headerlink" href="#dich-vu-lien-quan" title="Permanent link">Â¶</a></h3>
<ul>
<li><a href="../../auth-service/sub/design/">auth-service/sub</a>: Service gá»i tá»›i <code>/token</code>, <code>/refresh</code>.</li>
<li><a href="../../api-gateway/design/">api-gateway</a>: Service sá»­ dá»¥ng <code>/introspect</code> Ä‘á»ƒ xÃ¡c thá»±c JWT.</li>
<li><a href="../../audit-logging-service/design/">audit-logging-service</a>: Ghi láº¡i cÃ¡c sá»± kiá»‡n login, logout tá»« Token Service.</li>
<li><a href="../../user-service/master/design/">user-service/master</a>: NÆ¡i chá»©a thÃ´ng tin ngÆ°á»i dÃ¹ng Ä‘Æ°á»£c liÃªn káº¿t bá»Ÿi <code>sub</code> trong token.</li>
</ul>
<h3 id="file-trong-token-service">ğŸ“‚ File trong Token Service<a class="headerlink" href="#file-trong-token-service" title="Permanent link">Â¶</a></h3>
<ul>
<li><a href="../interface-contract/">Interface Contract</a></li>
<li><a href="../data-model/">Data Model</a></li>
<li><a href="../openapi.yaml">OpenAPI Spec</a></li>
</ul>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Trá»Ÿ láº¡i má»¥c lá»¥c
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>