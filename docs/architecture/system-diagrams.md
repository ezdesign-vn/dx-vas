# S∆° ƒë·ªì Ki·∫øn tr√∫c H·ªá th·ªëng dx-vas

T√†i li·ªáu n√†y t·∫≠p h·ª£p t·∫•t c·∫£ c√°c s∆° ƒë·ªì ki·∫øn tr√∫c quan tr·ªçng c·ªßa h·ªá th·ªëng chuy·ªÉn ƒë·ªïi s·ªë dx-vas, bao g·ªìm:

* S∆° ƒë·ªì ki·∫øn tr√∫c t·ªïng th·ªÉ
* Di·ªÖn gi·∫£i c√°c kh·ªëi ch·ª©c nƒÉng
* C√°c s∆° ƒë·ªì con chi ti·∫øt theo t·ª´ng lu·ªìng nghi·ªáp v·ª• (v√≠ d·ª•: Tuy·ªÉn sinh, Th√¥ng b√°o, Ph√¢n quy·ªÅn RBAC...)

## üìö M·ª•c l·ª•c S∆° ƒë·ªì Ki·∫øn tr√∫c H·ªá th·ªëng dx-vas

| STT | T√™n s∆° ƒë·ªì | M√¥ t·∫£ ng·∫Øn | Li√™n k·∫øt |
|-----|-----------|------------|----------|
| 1Ô∏è‚É£ | **Ki·∫øn tr√∫c t·ªïng quan h·ªá th·ªëng Multi-Tenant** | T·ªïng th·ªÉ h·ªá th·ªëng g·ªìm Shared Core v√† c√°c Tenant Stack | [Xem s∆° ƒë·ªì](#1-ki·∫øn-tr√∫c-t·ªïng-quan-h·ªá-th·ªëng-multi-tenant) |
| 2Ô∏è‚É£ | **Lu·ªìng ƒë√°nh gi√° RBAC t·∫°i API Gateway** | C√°ch Gateway ƒë√°nh gi√° quy·ªÅn ƒë·ªông t·ª´ JWT + Redis + Sub Service | [Xem s∆° ƒë·ªì](#2-lu·ªìng-ƒë√°nh-gi√°-rbac-t·∫°i-api-gateway) |
| 3Ô∏è‚É£ | **Lu·ªìng ph√°t h√†nh JWT ƒëa-tenant** | Qu√° tr√¨nh x√°c th·ª±c Google/OTP v√† ph√°t token | [Xem s∆° ƒë·ªì](#3-lu·ªìng-ph√°t-h√†nh-jwt-ƒëa-tenant) |
| 4Ô∏è‚É£ | **Lu·ªìng g·ª≠i Notification to√†n h·ªá th·ªëng (Option B)** | Pub/Sub fan-out t·ª´ Master ƒë·∫øn Sub Notification Services | [Xem s∆° ƒë·ªì](#4-lu·ªìng-g·ª≠i-notification-to√†n-h·ªá-th·ªëng-pubsub-fan-out) |
| 5Ô∏è‚É£ | **S∆° ƒë·ªì tri·ªÉn khai h·∫° t·∫ßng (Deployment Diagram)** | T·ªï ch·ª©c project GCP cho core/tenant/monitoring/data | [Xem s∆° ƒë·ªì](#5-s∆°-ƒë·ªì-tri·ªÉn-khai-h·∫°-t·∫ßng-deployment-diagram) |
| 6Ô∏è‚É£ | **V√≤ng ƒë·ªùi t√†i kho·∫£n (Account Lifecycle)** | T·ª´ t·∫°o user ‚Üí g√°n tenant ‚Üí c·∫•p quy·ªÅn ‚Üí v√¥ hi·ªáu h√≥a | [Xem s∆° ƒë·ªì](#6-v√≤ng-ƒë·ªùi-t√†i-kho·∫£n-account-lifecycle) |
| 7Ô∏è‚É£ | **Lu·ªìng ƒë·ªìng b·ªô RBAC t·ª´ Master ‚Üí Sub** | T·ª± ƒë·ªông ho·∫∑c th·ªß c√¥ng sync role/permission template | [Xem s∆° ƒë·ªì](#7-lu·ªìng-ƒë·ªìng-b·ªô-rbac-t·ª´-master--sub-user-services) |
| 8Ô∏è‚É£ | **Ph√¢n quy·ªÅn giao di·ªán ng∆∞·ªùi d√πng (UI Role Mapping)** | Vai tr√≤ ƒë∆∞·ª£c √°nh x·∫° ƒë·∫øn c√°c frontend: Superadmin, Admin, GV, PH | [Xem s∆° ƒë·ªì](#8-ph√¢n-quy·ªÅn-giao-di·ªán-ng∆∞·ªùi-d√πng-ui-role-mapping) |

---

## 1. Ki·∫øn tr√∫c t·ªïng quan h·ªá th·ªëng Multi-Tenant

> **M·ª•c ti√™u** ‚Äì Cho th·∫•y b·ª©c tranh cao nh·∫•t: **Core Services** d√πng chung, **Tenant Stack** c√¥ l·∫≠p; JWT do **Token Service** k√Ω, RBAC cache ·ªü **API Gateway**, d·ªØ li·ªáu nghi·ªáp v·ª• g√≥i trong **SMS** (per tenant).

```mermaid
flowchart TD
  %% ======= EXTERNAL =======
  subgraph ext ["üåê External IdP & Channels"]
    GoogleOAuth(Google OAuth2)
    OTPProv(OTP Provider)
    EmailSvc(Email Gateway)
    SMSSvc(SMS Gateway)
  end

  %% ======= FRONTEND =======
  subgraph fe ["üíª Frontend Apps"]
    AdminPortal(Admin Portal)
    TeacherPortal(Teacher Portal)
    StudentPortal(Student Portal)
    ParentPortal(Parent Portal)
  end

  %% ======= CORE SERVICES =======
  subgraph core ["üîß Core Services (Shared)"]
    APIGW(API Gateway)
    TokenSvc(Token Service)
    AuthM(Auth Master)
    UserM(User Master)
    NotifM(Notification Master)
    RedisRev[Redis<br/>revoked_tokens cache]
    ReportSvc(Reporting Service)
    PubSub((Pub / Sub))
  end

  %% ======= DATA PLATFORM =======
  subgraph db ["üîß Data Platform"]
    BQ(Data Warehouse)
  end

  %% ======= TENANT STACK EXAMPLE =======
  subgraph tenantA ["üè´ Tenant Stack ¬∑ ABC School"]
    subgraph smsgrp ["School Management System (SMS)"]
      SMS(SMS Backend<br/>+ MariaDB)
    end
    AuthSub(Auth Sub)
    UserSub(User Sub)
    NotifSub(Notif Sub)
  end

  %% ======= FLOWS =======
  %% Front-door
  AdminPortal -. https .-> APIGW
  TeacherPortal -. https .-> APIGW
  StudentPortal -. https .-> APIGW
  ParentPortal  -. https .-> APIGW

  %% Auth & Token
  APIGW -->|/login| AuthM
  AuthM -->|/token/issue| TokenSvc
  AuthSub -->|/token/issue| TokenSvc
  TokenSvc -- JWKS --> APIGW

  %% Revoked-token check
  APIGW -->|check revoked| RedisRev
  TokenSvc -->|sync revoked| RedisRev

  %% Core routing
  APIGW ==> UserM
  APIGW ==> NotifM
  APIGW ==> ReportSvc

  %% Tenant routing
  APIGW ==> AuthSub
  APIGW ==> UserSub
  APIGW ==> NotifSub
  APIGW ==> SMS

  %% Event fan-out
  UserM -- "user.*" --> PubSub
  NotifM -- "notif.*" --> PubSub
  PubSub -- "user.*" --> UserSub
  PubSub -- "notif.*" --> NotifSub

  %% ELT (simplified)
  SMS -- "ELT" --> BQ
```

### üóùÔ∏è Ch√∫ th√≠ch m≈©i t√™n & ƒë∆∞·ªùng n√©t

| K√Ω hi·ªáu        | √ù nghƒ©a                                     |
| -------------- | ------------------------------------------- |
| `-. https .->` | G·ªçi HTTPS t·ª´ frontend/browser               |
| `-->`          | G·ªçi API ƒë·ªìng b·ªô n·ªôi b·ªô                      |
| `==>`          | G·ªçi API ƒë·ªìng b·ªô ∆∞u ti√™n cao / routing ch√≠nh |
| `..>`          | Lu·ªìng b·∫•t ƒë·ªìng b·ªô (Pub/Sub, ELT)            |
| `-- JWKS -->`  | Gateway t·∫£i public key JWKS ƒë·ªÉ x√°c th·ª±c JWT |

* **Token Service** k√Ω JWT (RS256); **API Gateway** x√°c th·ª±c offline qua **JWKS** cache 10 ‚Ä≤ v√† ki·ªÉm tra `revoked:{jti}` trong **Redis** tr∆∞·ªõc khi ƒë√°nh gi√° RBAC.
* **SMS** thay th·∫ø ho√†n to√†n c√°c adapter CRM/SIS/LMS c≈©, tr·ªü th√†nh ngu·ªìn d·ªØ li·ªáu nghi·ªáp v·ª• duy nh·∫•t ·ªü m·ªói tenant.
* M·ªói tenant stack tri·ªÉn khai ƒë·ªôc l·∫≠p; autoscale kh√¥ng ·∫£nh h∆∞·ªüng Core Services.

> S∆° ƒë·ªì ph·∫£n √°nh ƒë·∫ßy ƒë·ªß hai Change Request g·∫ßn nh·∫•t: **Token Service centralization** v√† **Tenant Stack simplification v·ªõi SMS**.

---

## 2. Lu·ªìng ƒë√°nh gi√° RBAC t·∫°i API Gateway

> **M·ª•c ti√™u** ‚Äì ƒê·∫£m b·∫£o **m·ªói request** ƒë∆∞·ª£c x√°c th·ª±c (JWT) v√† u·ª∑ quy·ªÅn (RBAC + Condition) **< 5 ms** p95, ƒë·ªìng th·ªùi ph·∫£n ·ª©ng t·ª©c th·ªùi khi token b·ªã thu h·ªìi ho·∫∑c quy·ªÅn thay ƒë·ªïi.

### 2.1 Sequence Diagram

```mermaid
sequenceDiagram
    autonumber
    participant FE      as üåê Frontend
    participant APIGW   as üõ°Ô∏è API Gateway
    participant RedisRev as üîÑ Redis revoked
    participant RedisRBAC as üîÑ Redis RBAC
    participant UserSub as üß© User Sub (tenant)
    participant TokenSvc as üóùÔ∏è Token Service

    FE->>APIGW: HTTP request + JWT
    Note right of APIGW: ‚ë† Verify RS256 via<br/>JWKS (cache 10‚Ä≤)
    APIGW->>RedisRev: GET revoked:{jti}       %% check revoked
    alt Token revoked
        APIGW-->>FE: 403 token.revoked
    else Not revoked
        APIGW->>RedisRBAC: GET rbac:{uid}:{tid}
        alt Cache HIT
            Note right of APIGW: ‚ë° RBAC cache hit
        else Cache MISS
            APIGW->>UserSub: /rbac?uid={uid}
            UserSub-->>APIGW: roles + perms
            APIGW->>RedisRBAC: SET rbac:{uid}:{tid} (TTL)
        end
        Note right of APIGW: ‚ë¢ Evaluate<br/>Condition Engine
        alt Permission pass
            APIGW-->>FE: 2xx success
        else Denied
            APIGW-->>FE: 403 auth.permission_denied
        end
    end
```

### 2.2 B∆∞·ªõc x·ª≠ l√Ω chi ti·∫øt

| # | B∆∞·ªõc                                                           | Th·ªùi gian m·ª•c ti√™u |
| - | -------------------------------------------------------------- | ------------------ |
| ‚ë† | X√°c th·ª±c ch·ªØ k√Ω JWT b·∫±ng **JWKS** (cache 10 ph√∫t)              | < 0.5 ms           |
| ‚ë° | Tra **Redis** cache RBAC (`rbac:{uid}:{tid}`)                  | hit ‚â• 98 %         |
| ‚ë¢ | Engine so s√°nh `condition` (*\$user*, *\$request*, *\$tenant*) | < 4 ms             |

### 2.3 Quy t·∫Øc x·ª≠ l√Ω

1. **Token b·ªã thu h·ªìi** ‚Üí tr·∫£ `403 token.revoked`, ghi metric `revoked_token_cache_hit_ratio`.
2. **RBAC cache miss** ‚Üí t·∫£i t·ª´ **User Sub** r·ªìi set TTL 5 ‚Äì 15 ph√∫t (tu·ª≥ tenant).
3. **Permission c√≥ condition** ‚Üí n·∫øu placeholder thi·∫øu / type mismatch ‚Üí `400 common.validation_failed`.
4. **M·ªçi ph·∫£n h·ªìi l·ªói** d√πng `ErrorEnvelope` (ADR-011).

### 2.4 Metrics & Alert

| Metric                          | M·ª•c ti√™u | Alert          |
| ------------------------------- | -------- | -------------- |
| `rbac_cache_hit_ratio`          | ‚â• 98 %   | < 95 % 10‚Ä≤     |
| `revoked_token_cache_hit_ratio` | ‚â• 95 %   | < 90 % 10‚Ä≤     |
| `rbac_cond_latency_p95`         | < 5 ms   | > 10 ms 5‚Ä≤     |
| `rbac_eval_error_rate`          | = 0      | b·∫•t k·ª≥ > 0.1 % |

> **K·∫øt qu·∫£:** V·ªõi cache hai t·∫ßng (RBAC & Revoked) v√† Engine ƒëi·ªÅu ki·ªán ch·∫°y t·∫°i Gateway, dx-vas u·ª∑ quy·ªÅn g·∫ßn-real-time m√† kh√¥ng ƒë√°nh ƒë·ªïi hi·ªáu nƒÉng.

---

## 3. Lu·ªìng ph√°t h√†nh JWT ƒëa-tenant

> **M·ª•c ti√™u** ‚Äì T·∫°o **JWT RS256** ch·ª©a ƒë·∫ßy ƒë·ªß claim (`sub`, `tid`, `roles`, `permissions`, `jti`, `sid`, `exp`) cho **m·ªçi ph∆∞∆°ng th·ª©c ƒëƒÉng nh·∫≠p** (Google OAuth2 & Local / OTP) v√† m·ªçi tenant.

### 3.1 Sequence Diagram

```mermaid
sequenceDiagram
    autonumber
    participant FE as üåê Frontend
    participant APIGW as üõ°Ô∏è API Gateway
    participant AuthM as üîê Auth Master
    participant AuthT as üîê Auth Sub
    participant Captcha as üõ°Ô∏è reCAPTCHA
    participant UserSub as üß© User Sub (tenant)
    participant TokenSvc as üóùÔ∏è Token Service

    %% JWKS cache line (dashed for offline verify)
    TokenSvc-->>APIGW: JWKS (cache 10‚Ä≤)

    rect rgba(220,220,220,0.05)
        FE->>APIGW: /login/google
        APIGW->>AuthM: forward
        AuthM->>Google OAuth2: auth code flow
        Google OAuth2-->>AuthM: id_token
        AuthM->>UserSub: GET roles/permissions
        AuthM->>TokenSvc: POST /token/issue
        TokenSvc-->>AuthM: JWT (access + refresh)
        AuthM-->>APIGW: 200 JWT
        APIGW-->>FE: 200 JWT
    end

    rect rgba(220,220,220,0.05)
        FE->>APIGW: /login/otp
        APIGW->>AuthT: forward
        AuthT-->>Captcha: verify CAPTCHA
        Captcha-->>AuthT: OK / Fail
        AuthT->>AuthT: verify OTP / password
        AuthT->>UserSub: GET RBAC
        AuthT->>TokenSvc: POST /token/issue
        TokenSvc-->>AuthT: JWT (access + refresh)
        AuthT-->>APIGW: 200 JWT
        APIGW-->>FE: 200 JWT
    end
```

### 3.2 B∆∞·ªõc x·ª≠ l√Ω chi ti·∫øt

| B∆∞·ªõc | M√¥ t·∫£                                                                       | Th√†nh ph·∫ßn                 |
| ---- | --------------------------------------------------------------------------- | -------------------------- |
| 1    | Frontend g·ª≠i y√™u c·∫ßu ƒëƒÉng nh·∫≠p (Google ho·∫∑c OTP).                           | FE ‚Üí API Gateway           |
| 2    | **Auth Master** (Google) ho·∫∑c **Auth Sub** (OTP) x√°c th·ª±c ng∆∞·ªùi d√πng.       | AuthM / AuthT              |
| 3    | G·ªçi **User Sub** l·∫•y `roles`, `permissions` trong tenant ƒë√£ ch·ªçn.           | AuthM / AuthT              |
| 4    | G·ªçi **Token Service** `POST /token/issue` ‚Üí nh·∫≠n c·∫∑p token ƒë√£ k√Ω **RS256**. | AuthM / AuthT ‚Üí TokenSvc   |
| 5    | Tr·∫£ JWT cho Frontend qua **API Gateway**.                                   | AuthM / AuthT ‚Üí APIGW ‚Üí FE |

### 3.3 C·∫•u tr√∫c JWT

| Claim                  | √ù nghƒ©a                               |
| ---------------------- | ------------------------------------- |
| `sub`                  | `user_id_global`                      |
| `tid`                  | `tenant_id`                           |
| `roles`, `permissions` | Danh s√°ch vai tr√≤ & quy·ªÅn (RBAC)      |
| `auth_provider`        | `google` / `local` / `otp`            |
| `jti`                  | UUID duy nh·∫•t ‚Äì d√πng thu h·ªìi token    |
| `sid`                  | Session ID tham chi·∫øu `auth_sessions` |
| `exp`                  | H·∫øt h·∫°n ‚â§ 15 ph√∫t (access token)      |

Refresh token TTL 14 ng√†y; l∆∞u `auth_sessions`.

### 3.4 Ki·ªÉm so√°t & B·∫£o m·∫≠t

* **CAPTCHA** b·∫Øt bu·ªôc tr∆∞·ªõc b∆∞·ªõc OTP ƒë·ªÉ tr√°nh brute-force.
* **JWKS** c√¥ng khai cache 10 ph√∫t ‚Äì Gateway x√°c th·ª±c ch·ªØ k√Ω offline.
* **Token revocation**: `/token/revoke` th√™m `jti` v√†o Redis (`revoked:{jti}`) ‚Üí Gateway ch·∫∑n ngay.

### 3.5 Metric gi√°m s√°t

| Metric                    | Target   |
| ------------------------- | -------- |
| `token_issue_latency_p95` | < 100 ms |
| `login_success_rate`      | > 98 %   |
| `captcha_failure_rate`    | < 2 %    |

> **K·∫øt qu·∫£:** Ng∆∞·ªùi d√πng nh·∫≠n JWT trong m·ªôt v√≤ng request, c√≤n API Gateway s·ªü h·ªØu ƒë·ªß th√¥ng tin (`tid`, RBAC, jti) ƒë·ªÉ x√°c th·ª±c & u·ª∑ quy·ªÅn si√™u nhanh cho t·ª´ng tenant.

---

## 4. Lu·ªìng g·ª≠i Notification to√†n h·ªá th·ªëng (Pub/Sub fan-out)

> **M·ª•c ti√™u** ‚Äì T√°ch r·ªùi **orchestration** (Notification Master) kh·ªèi **delivery** (Notification Sub per tenant), b·∫£o ƒë·∫£m:  
> ‚Ä¢ Th·ªëng nh·∫•t template & tracking ·ªü Core.  
> ‚Ä¢ Fan-out s·ª± ki·ªán **< 1 s** t·ªõi m·ªçi tenant.  
> ‚Ä¢ Kh√¥ng r√†ng bu·ªôc tenant v√†o h·∫° t·∫ßng SMTP/SMS chung.  

### 4.1 Sequence Diagram

```mermaid
sequenceDiagram
    autonumber
    participant ServiceX as üìù Any Core / SMS
    participant NotifM   as üì£ Notification Master
    participant PubSub   as ‚òÅÔ∏è Pub/Sub<br/>topic **notification.v1**
    participant NotifSub as üì© Notification Sub (tenant)
    participant EmailSvc as ‚úâÔ∏è Email Gateway
    participant SMSSvc   as üì± SMS Gateway

    ServiceX->>NotifM: POST /notifications (payload, tenant_id)
    NotifM->>NotifM: Validate + resolve template
    NotifM->>PubSub: üîî **notif.email_requested.v1**
    NotifM->>PubSub: üîî **notif.sms_requested.v1**
    PubSub-->>NotifSub: Fan-out event (filter tenant_id)
    NotifSub->>EmailSvc: Send email
    NotifSub->>SMSSvc: Send SMS
    NotifSub->>PubSub: üîî **notif.sent.v1** (status, message_id)
    PubSub-->>NotifM: Ack status
```

### 4.2 ƒê·ªãnh tuy·∫øn & Schema

| Ch·ªß ƒë·ªÅ / Event             | M√¥ t·∫£                                   | Schema ID (ADR-030)  |
| -------------------------- | --------------------------------------- | -------------------- |
| `notification.v1`          | Topic chung cho m·ªçi s·ª± ki·ªán notificaton | ‚Äî                    |
| `notif.email_requested.v1` | Master y√™u c·∫ßu g·ª≠i Email                | `notif_email_req_v1` |
| `notif.sms_requested.v1`   | Master y√™u c·∫ßu g·ª≠i SMS                  | `notif_sms_req_v1`   |
| `notif.sent.v1`            | Sub b√°o c√°o k·∫øt qu·∫£ (OK/FAIL)           | `notif_sent_v1`      |

*Tenant Sub* subscribe v·ªõi filter `attributes.tenant_id == "<tenant>"` ‚Üí t√°ch bi·ªát lu·ªìng.

### 4.3 X·ª≠ l√Ω t·∫°i Notification Master

1. **Validate** payload & tenant quota.
2. **Merge Template** ‚Üî data; log `audit_log.notifications`.
3. **Publish** s·ª± ki·ªán `*.requested.v1` k√®m `schema_version`.
4. **Track** status qua `notif.sent.v1`; retry n·∫øu k·∫øt qu·∫£ `FAIL`.

### 4.4 X·ª≠ l√Ω t·∫°i Notification Sub (per tenant)

| B∆∞·ªõc | H√†nh ƒë·ªông                                     | Idempotency          |
| ---- | --------------------------------------------- | -------------------- |
| 1    | Nh·∫≠n event; ki·ªÉm tra `dedup_id`               | Redis SETNX 15 m     |
| 2    | Render template (locale)                      | ‚Äî                    |
| 3    | G·ª≠i Email / SMS                               | 3 l·∫ßn retry back-off |
| 4    | Publish `notif.sent.v1` (status, message\_id) | ‚Äî                    |

### 4.5 Kh·∫£ nƒÉng m·ªü r·ªông & SLA

| Th√†nh ph·∫ßn                      | Autoscale                 | SLA                      |
| ------------------------------- | ------------------------- | ------------------------ |
| Pub/Sub topic `notification.v1` | 100k msg/s                | ‚â• 99.9 %                 |
| Notification Sub                | HPA (RPS & queue lag)     | email < 30 s, sms < 10 s |
| Email/SMS Gateway               | Ngo√†i ph·∫°m vi (3rd-party) | ‚Äî                        |

### 4.6 Monitoring & Alert

* **Metric** `notif_sent_success_rate` ‚â• 97 % (per channel).
* **Lag** Pub/Sub `subscription/oldest_unacked_age` < 5 s.
* **Dashboard** s·ªë l∆∞·ª£ng g·ª≠i Email/SMS theo tenant, bounce rate, cost.
* **Alert** n·∫øu `notif.sent.v1` FAIL > 2 % trong 5 ‚Ä≤.

> Nh·ªù Pub/Sub fan-out, DX-VAS g·ª≠i th√¥ng b√°o **m·ªôt l·∫ßn** ·ªü Core nh∆∞ng b·∫£o ƒë·∫£m **m·ªói tenant** x·ª≠ l√Ω & tu·ª≥ bi·∫øn ri√™ng, ƒë·ªìng th·ªùi Master v·∫´n n·∫Øm ƒë·∫ßy ƒë·ªß log & KPI.

---

## 5. S∆° ƒë·ªì tri·ªÉn khai h·∫° t·∫ßng (Deployment Diagram)

> **Ph√¢n t√°ch** r√µ hai bi√™n:  
> **Core Project** ‚Äì ch·∫°y duy nh·∫•t, chia s·∫ª cho m·ªçi tenant;  
> **Tenant Project** ‚Äì nh√¢n b·∫£n cho t·ª´ng tr∆∞·ªùng, ƒë·ªôc l·∫≠p compute/giao th·ª©c m·∫°ng, ch·ªâ k·∫øt n·ªëi qua API Gateway & Pub/Sub.

```mermaid
flowchart TD
%% ========= CORE PROJECT =========
  subgraph Core[üè¢ GCP Project **dx-vas-core**]
    direction TB
    subgraph CoreVPC["üîê VPC core (GKE)"]
      APIGW[üõ°Ô∏è API Gateway<br/>Envoy]
      TokenSvc[üóùÔ∏è Token Service]
      AuthM[üîê Auth Master]
      UserM[üë• User Master]
      NotifM[üì£ Notification Master]
      ReportSvc[üìä Reporting Service]
    end
    RedisRev[(üîÑ Redis Cluster<br/>revoked_tokens)]
    CloudSQL[(üêò PostgreSQL\nusers_global + audit)]
    PubSubCore((‚òÅÔ∏è Pub/Sub))
    BQ[(üì¶ BigQuery<br/>Data Warehouse)]
    SecretMgr[[üîë Secret Manager]]
  end

%% ========= TENANT PROJECT (EXAMPLE) =========
  subgraph TenantA[üè´ GCP Project **dx-vas-tenant-abc**]
    direction TB
    subgraph TenantVPC["üîê VPC tenant (GKE)"]
      AuthSub[üîê Auth Sub]
      UserSub[üë§ User Sub]
      NotifSub[üì• Notif Sub]
      SMS[üè´ SMS<br/>Backend]
    end
    SMSDB[(üçÉ MariaDB<br/>Galera Cluster)]
    RedisTenant[(üîÑ Redis Local)]
    PubSubTenant((‚òÅÔ∏è Pub/Sub<br/>sub-only))
  end

%% ========= TRAFFIC =========
  %% Front-end
  FE[üåê Portals / Mobile]
  FE -. https .-> APIGW

  %% Token flow
  APIGW --> TokenSvc
  TokenSvc -- JWKS --> APIGW
  TokenSvc --> RedisRev

  %% Core services
  APIGW ==> AuthM
  APIGW ==> UserM
  APIGW ==> NotifM
  APIGW ==> ReportSvc

  %% Pub/Sub fan-out
  NotifM --"notif.*"--> PubSubCore
  UserM --"user.*"--> PubSubCore
  PubSubCore --"filtered by tenant_id"--> PubSubTenant
  PubSubTenant --"events"--> NotifSub
  PubSubTenant --"events"--> UserSub

  %% Tenant internal
  APIGW ==> AuthSub
  APIGW ==> UserSub
  APIGW ==> SMS
  NotifSub --> EmailSvc[[‚úâÔ∏è Email\nGateway]]
  NotifSub --> SMSSvc[[üì± SMS\nGateway]]

  %% Data / ELT
  SMS -->|ELT| BQ

  %% Secrets & KV
  TokenSvc --> SecretMgr
  AuthM --> SecretMgr

  %% VPC Peering
  CoreVPC --- TenantVPC

  %% Legend ‚Äì External gateway node
  ExtGW[[‚úâÔ∏è/üì± External Gateway]]

  %% Legend
  classDef edgeHttps stroke-dasharray: 5 3;
  class FE edgeHttps;
```

> Node ExtGW[[‚úâÔ∏è/üì± External Gateway]] hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng ‚úâÔ∏è/üì±, t∆∞·ª£ng tr∆∞ng cho c·∫£ Email Gateway v√† SMS Gateway.
> ƒê·∫∑t trong ph·∫ßn ‚ÄúLegend‚Äù gi√∫p ng∆∞·ªùi ƒë·ªçc hi·ªÉu nhanh √Ω nghƒ©a c·ªßa c√°c n√∫t EmailSvc v√† SMSSvc ƒë√£ d√πng ·ªü Tenant stack.

### üîë Ghi ch√∫ & Ch√≠nh s√°ch

| Th√†nh ph·∫ßn               | SLA / SLO                         | Autoscale          |
| ------------------------ | --------------------------------- | ------------------ |
| **API Gateway**          | p95 < 20 ms                       | HPA RPS + CPU      |
| **Token Service**        | p95 < 50 ms; availability 99.95 % | HPA CPU            |
| **Redis Cluster (core)** | hit ‚â• 95 %; failover multi-AZ     | Manged Memorystore |
| **Pub/Sub fan-out**      | latency < 1 s                     | Serverless         |
| **Tenant GKE**           | c√¥ l·∫≠p VPC; node-pool ri√™ng       | HPA per tenant     |
| **MariaDB Galera**       | RPO = 0; RTO < 5 min              | CloudSQL HA        |

* CI/CD: **Argo CD** sync `core` & `tenant` chart; **Terraform Cloud** d·ª±ng VPC, DB, Secret.
* VPC peering + firewall ch·ªâ m·ªü c·ªïng 443/mTLS; traffic gi·ªØa tenant ‚Üî core ƒëi qua **API Gateway**.
* **Secret Manager** l∆∞u RSA key (`kid current|next`) & SMTP creds; rotation ‚â§ 90 ng√†y.

> **K·∫øt qu·∫£** ‚Äì Ki·∫øn tr√∫c t√°ch b·∫°ch gi√∫p m·ªü r·ªông tenant m·ªõi b·∫±ng m·ªôt c·ª•m GKE + MariaDB, kh√¥ng t√°c ƒë·ªông Core, ƒë·ªìng th·ªùi Core duy tr√¨ single-pane quan s√°t & b·∫£o m·∫≠t.

---

## 6. V√≤ng ƒë·ªùi T√†i kho·∫£n (Account Lifecycle)

> **ƒê·ªãnh nghƒ©a**  
> *T√†i kho·∫£n* = b·∫£n ghi **users_global** (User Service Master) + (0‚Ä¶n) b·∫£n ghi **users_in_tenant**.  
> T√†i kho·∫£n c√≥ th·ªÉ **s·ªëng** ·ªü nhi·ªÅu tenant, **ƒë√≥ng bƒÉng** (inactive) c·ª•c b·ªô ho·∫∑c to√†n c·ª•c, **ƒë∆∞·ª£c ·∫©n danh** ho·∫∑c **xo√° vƒ©nh vi·ªÖn** theo ADR-024 & ADR-026.

### 6.1 Lu·ªìng kh·ªüi t·∫°o (Create / First Login)

```mermaid
sequenceDiagram
    autonumber
    participant FE       as üåê Frontend
    participant AuthM    as üîê Auth Master
    participant UserM    as üë• User Master
    participant UserSub  as üß© User Sub
    participant PubSub   as ‚òÅÔ∏è Pub/Sub

    FE->>AuthM: Login Google
    AuthM->>UserM: GET /users?email=<>
    alt New user
        UserM-->>AuthM: 404
        AuthM->>UserM: POST /users (create\, provider)
    else Exists
        UserM-->>AuthM: user_id_global
    end
    AuthM->>UserM: PUT /assign tenant_id
    UserM-->>AuthM: 200 OK
    UserM-->>PubSub: üîî **user.created.v1** / **user.tenant_assigned.v1**
    PubSub-->>UserSub: fan-out
    UserSub->>UserSub: UPSERT users_in_tenant
```

* **Provider**: `google` / `local` / `otp` (l∆∞u trong `auth_provider`).
* **Event** `user.created.v1` ch·ª©a `schema_version`, d√πng ƒë·ªÉ seed tenant DB.

### 6.2 K√≠ch ho·∫°t / Ng∆∞ng ho·∫°t ƒë·ªông

| Ph·∫°m vi             | API                                                         | Tr·∫°ng th√°i                 | Event                    |
| ------------------- | ----------------------------------------------------------- | -------------------------- | ------------------------ |
| **To√†n c·ª•c**        | `PATCH /users/{id} is_active=false`                         | Kh√≥a ƒëƒÉng nh·∫≠p m·ªçi tenant  | `user_status_changed.v1` |
| **C·ª•c b·ªô (tenant)** | `PATCH /users/{id}?tenant_id=... is_active_in_tenant=false` | Kh√≥a trong tenant hi·ªán t·∫°i | `user_status_changed.v1` |

Gateway cache **RBAC** b·ªã xo√° khi nh·∫≠n event \&nbsps; token c≈© s·∫Ω b·ªã ch·∫∑n n·∫øu user\_inactive.

### 6.3 C·∫≠p nh·∫≠t th√¥ng tin h·ªì s∆°

* **To√†n c·ª•c**: `PUT /users/{id}` ‚Üí b·∫£ng `users_global`.
* **C·ª•c b·ªô** : `PUT /users/{id}` + header `X-Tenant-ID` ‚Üí b·∫£ng `users_in_tenant`.
* Ph√°t event `user.profile_updated.v1`; ETL ƒë·ªìng b·ªô sang BigQuery.

### 6.4 V√≤ng ƒë·ªùi phi√™n (Session TTL)

| Lo·∫°i              | TTL                   | L∆∞u ·ªü                     |
| ----------------- | --------------------- | ------------------------- |
| **Access token**  | ‚â§ 15 ‚Ä≤                | JWT claim `exp`           |
| **Refresh token** | 14 ng√†y               | b·∫£ng `auth_sessions`      |
| **Force logout**  | `/token/revoke sid=*` | Xo√° Redis `revoked:{jti}` |

### 6.5 ·∫®n danh & Xo√° vƒ©nh vi·ªÖn

| Pha             | Thao t√°c                                                              | Timeout | ADR       |
| --------------- | --------------------------------------------------------------------- | ------- | --------- |
| **Soft Delete** | User self-delete ‚Üí `is_active = false`, flag `delete_after = now+30d` | 30 ng√†y | 026       |
| **Hard Delete** | Job `user_purge` xo√° b·∫£n ghi, ƒë·ªïi d·ªØ li·ªáu PII ‚Üí hash                  | ‚Äî       | 024 & 026 |

* **Audit log** ghi ‚Äúuser purged‚Äù k√®m `gdpr_request_id`.
* `user.deleted.v1` event b·∫Øn l√™n Pub/Sub ‚Üí Tenant Sub nh·∫≠n & purge b·∫£n ghi local.

### 6.6 Mapping ‚Üí JWT & RBAC Cache

| Thu·ªôc t√≠nh            | Ngu·ªìn                  | Claim / Cache                   |
| --------------------- | ---------------------- | ------------------------------- |
| `user_id`             | users\_global.user\_id | `sub`                           |
| `tenant_id`           | header ch·ªçn tenant     | `tid`                           |
| `roles / perms`       | JOIN UserSub           | Cache `rbac:{uid}:{tid}` 5-15 ‚Ä≤ |
| `is_active`           | users\_global          | Gateway ch·∫∑n n·∫øu false          |
| `is_active_in_tenant` | users\_in\_tenant      | Gateway ch·∫∑n n·∫øu false          |

### 6.7 KPI & Alert

| Metric                       | M·ª•c ti√™u          | Alert        |
| ---------------------------- | ----------------- | ------------ |
| `user_login_success_rate`    | > 98 % tenant-avg | < 95 % 15‚Ä≤   |
| `user_purge_backlog`         | = 0               | > 0 ghi Jira |
| `profile_update_latency_p95` | < 100 ms          | > 200 ms     |

> **T√≥m t·∫Øt** ‚Äì V√≤ng ƒë·ªùi t√†i kho·∫£n ƒë∆∞·ª£c qu·∫£n tr·ªã trung t√¢m nh∆∞ng cho ph√©p tenant t·ª± do tu·ª≥ ch·ªânh RBAC, ƒë·ªìng th·ªùi tu√¢n th·ªß GDPR v·ªÅ xo√° v√† ·∫©n danh d·ªØ li·ªáu.

---

## 7. Lu·ªìng ƒë·ªìng b·ªô RBAC t·ª´ Master ‚Üí Sub User Services

> **M·ª•c ti√™u** ‚Äì B·∫£o ƒë·∫£m **Role / Permission** lu√¥n ƒë·ªìng nh·∫•t gi·ªØa **User Master** v√† **User Sub** m√† v·∫´n cho ph√©p tenant **t√πy ch·ªânh** khi c·∫ßn.  
> C∆° ch·∫ø ƒë·ªìng b·ªô k·∫øt h·ª£p **s·ª± ki·ªán (event-driven)** & **ƒë·ªìng b·ªô ƒë·ªãnh k·ª≥ (cron sync)**, c√≥ ki·ªÉm so√°t *schema_version* (ADR-030).

### 7.1 Sequence Diagram (Event-driven)

```mermaid
sequenceDiagram
    autonumber
    participant Admin as üéõÔ∏è Admin Portal (Core)
    participant UserM as üë• User Master
    participant PubSub as ‚òÅÔ∏è Pub/Sub topic **rbac.v1**
    participant UserSub as üß© User Sub (tenant)
    participant RedisRBAC as üîÑ Redis rbac cache
    participant APIGW as üõ°Ô∏è API Gateway

    Admin->>UserM: POST /roles (create) üîñschema_version=2
    UserM-->>PubSub: üîî rbac_updated.v1 { tenant_id="*", ... }
    PubSub-->>UserSub: fan-out event (filter tenant_id)
    UserSub->>UserSub: UPSERT role / permission
    UserSub-->>PubSub: üîî rbac_updated_ack.v1
    PubSub-->>UserM: ack

    Note over APIGW,RedisRBAC: Gateway nh·∫≠n event<br/>x√≥a cache rbac:{uid}:{tid}
```

### 7.2 S·ª± ki·ªán & Schema (ADR-030)

| Event                     | Khi n√†o ph√°t                               | Payload ch√≠nh                                       | Ghi ch√∫                                |
| ------------------------- | ------------------------------------------ | --------------------------------------------------- | -------------------------------------- |
| `rbac_updated.v1`         | Master thay ƒë·ªïi / t·∫°o m·ªõi role, permission | `tenant_id` (`*` = all), `schema_version`, `diff[]` | Fan-out t·ªõi tenant Sub                 |
| `rbac_updated_ack.v1`     | Sub x·ª≠ l√Ω xong diff                        | `tenant_id`, `applied_version`                      | Cho Master tracking                    |
| `rbac_template_synced.v1` | Job sync ƒë·ªãnh k·ª≥                           | `tenant_id`, `from_version`, `to_version`           | Ch·ªâ khi tenant d√πng template ‚Äúinherit‚Äù |

JSON Schema ID l∆∞u trong **Schema Registry**, backward-compat ‚â• 6 th√°ng.

### 7.3 ƒê·ªìng b·ªô ƒë·ªãnh k·ª≥ (Cron Sync)

| Chu k·ª≥             | Trigger                                | ƒêi·ªÅu ki·ªán ch·∫°y                | H√†nh ƒë·ªông                                                            |
| ------------------ | -------------------------------------- | ----------------------------- | -------------------------------------------------------------------- |
| `weekly` (default) | Cloud Scheduler ‚Üí Cloud Run `sync-job` | Tenant c√≥ `sync_mode=inherit` | So s√°nh `schema_version`; publish `rbac_template_synced.v1` n·∫øu kh√°c |
| `manual`           | Tenant Admin ‚Üí ‚ÄúSync Now‚Äù              | ‚Äî                             | G·ªçi th·∫≥ng User Master `POST /templates/sync`                         |

*N·∫øu tenant ƒë√£ **clone** template, job ghi log `status=forked` ‚Äì **kh√¥ng ghi ƒë√®**.*

### 7.4 X·ª≠ l√Ω conflict

> **Conflict** = `permission_code` tr√πng nh∆∞ng `schema_version` kh√°c.

1. Job `sync-job` ph√°t hi·ªán ‚Üí flag `conflict=true`, publish `rbac_conflict_detected.v1`.
2. Tenant nh·∫≠n s·ª± ki·ªán, hi·ªÉn th·ªã banner ‚Äú**RBAC template out-of-date**‚Äù.
3. Admin tenant c√≥ 30 ng√†y ƒë·ªÉ merge / bump version, n·∫øu kh√¥ng h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông *lock* quy·ªÅn m·ªõi (deny by default).

### 7.5 C·∫≠p nh·∫≠t cache & Gateway

* Gateway subscribe `rbac_updated.v1`, `rbac_template_synced.v1`, `rbac_conflict_detected.v1`.
* Khi s·ª± ki·ªán t·ªõi: **xo√°** `rbac:{user_id}:{tenant_id}` & `revoked:{jti}` (n·∫øu c·∫ßn).
* Metric `rbac_cache_invalidate_count` tƒÉng; latency invalidate m·ª•c ti√™u < 1 s.

### 7.6 KPI & Alert

| Metric                   | Target           | Alert        |
| ------------------------ | ---------------- | ------------ |
| `rbac_sync_success_rate` | 100 %            | b·∫•t k·ª≥ l·ªói   |
| `rbac_template_age_days` | < 30 d (inherit) | > 45 d       |
| `rbac_conflict_count`    | 0                | > 0 t·∫°o Jira |
| `sync_job_duration_p95`  | < 60 s           | > 120 s      |

> **K·∫øt qu·∫£** ‚Äì Tenant lu√¥n c√≥ RBAC m·ªõi trong v√≤ng **1 gi√¢y** sau khi Master thay ƒë·ªïi, trong khi v·∫´n c√≥ **quy·ªÅn t·ª± ch·ªß** v·ªõi template ƒë√£ clone.

---

## 8. Ph√¢n quy·ªÅn Giao di·ªán Ng∆∞·ªùi D√πng (UI Role Mapping)

> **M·ª•c ti√™u** ‚Äì Li√™n k·∫øt **Role / Permission** (RBAC) v·ªõi **t√≠nh nƒÉng c·ª• th·ªÉ** tr√™n b·ªën c·ªïng **Admin ¬∑ Teacher ¬∑ Student ¬∑ Parent**, gi√∫p ƒë·ªôi frontend hi·ªÉn th·ªã/·∫©n n√∫t v√† ki·ªÉm tra quy·ªÅn th·ªëng nh·∫•t gi·ªØa UI & Gateway.

### 8.1 Ma tr·∫≠n Portal ‚Üí Vai tr√≤ Chu·∫©n

| Portal | Role m·∫∑c ƒë·ªãnh (`role_code`) | ƒê·ªëi t∆∞·ª£ng |
|--------|----------------------------|-----------|
| **Admin Portal** | `admin.super`, `admin.finance`, `admin.academic` | Qu·∫£n tr·ªã tr∆∞·ªùng |
| **Teacher Portal** | `teacher.homeroom`, `teacher.subject` | Gi√°o vi√™n |
| **Student Portal** | `student.default` | H·ªçc sinh |
| **Parent Portal** | `parent.default` | Ph·ª• huynh |

*Tenant c√≥ th·ªÉ **clone** v√† ƒë·ªïi t√™n role; `schema_version` tƒÉng l√™n khi s·ª≠a.*

### 8.2 Mapping UI ‚Üí Permission

| Khu v·ª±c UI | H√†nh ƒë·ªông | Permission y√™u c·∫ßu (`permission_code`) |
|------------|-----------|----------------------------------------|
| **Dashboard** | Xem b√°o c√°o ƒëƒÉng nh·∫≠p | `report.view_login_by_tenant` |
| **Finance** | Xem b√°o c√°o t√†i ch√≠nh | `report.view_financial_summary` |
| **Gradebook** | S·ª≠a ƒëi·ªÉm | `grade.edit_assignment` (teacher) |
| **Attendance** | ƒêi·ªÉm danh | `attendance.mark` |
| **User Management** | G√°n role | `rbac.manage_role` |
| **Settings** | ƒê·ªìng b·ªô RBAC template | `rbac.sync_template` |
| **SMS Broadcast** | G·ª≠i SMS h√†ng lo·∫°t | `notif.broadcast_sms` |

> UI component ƒë·ªçc **JWT claim `permissions`** (ƒë√£ t·ªëi ∆∞u b·ªüi Gateway cache), ·∫©n n√∫t n·∫øu kh√¥ng ƒë·ªß quy·ªÅn.

### 8.3 Ki·ªÉm tra quy·ªÅn (Frontend)

```ts
// React helper
import { useAuth } from "@/hooks/useAuth";

export function Can({ perm, children }) {
  const { permissions } = useAuth();          // l·∫•y t·ª´ JWT decode
  if (permissions.includes(perm)) return children;
  return null;                                // ·∫©n UI n·∫øu thi·∫øu quy·ªÅn
}
```

*√Åp d·ª•ng pattern n√†y cho button/menu t·ª´ng portal; tr√°nh ‚Äúhard-code‚Äù role.*

### 8.4 Dynamic Condition

* V·ªõi permission c√≥ `condition`, FE g·ªüi `input_parameters` ƒë√∫ng schema:

  ```json
  { "class_id": "10A1" }
  ```

* Gateway s·∫Ω so s√°nh `$request.class_id` vs `$user.class_id`; FE **kh√¥ng** c·∫ßn logic ph·ª•.

### 8.5 Quy tr√¨nh th√™m t√≠nh nƒÉng m·ªõi

1. **FE** m·ªü PR t·∫°o UI + flag `TODO_PERMISSION`.
2. **BE** th√™m permission v√†o `global_permissions_templates` (`schema_version+1`).
3. **RBAC Sync Job** fan-out `rbac_updated.v1`; FE l·∫•y JWT m·ªõi ‚Üí ch·ª©c nƒÉng hi·ªÉn th·ªã.
4. Th√™m entry m·ªõi v√†o **b·∫£ng 8.2** trong t√†i li·ªáu n√†y.

### 8.6 KPI UI Authorization

| Metric                         | Target  |
| ------------------------------ | ------- |
| `ui_unauthorized_click_rate`   | < 0.1 % |
| `jwt_permissions_payload_size` | ‚â§ 4 KB  |

> **K·∫øt qu·∫£** ‚Äì Ph√¢n quy·ªÅn UI l·ªá thu·ªôc ƒë√∫ng v√†o **Permission** (kh√¥ng ph·∫£i Role c·ª©ng), cho ph√©p tenant thay ƒë·ªïi Role m√† kh√¥ng ph·∫£i s·ª≠a Frontend.

---

## 9. H·ªá th·ªëng B√°o c√°o & Ph√¢n t√≠ch (Reporting & Analytics Architecture)

> **M·ª•c ti√™u** ‚Äì Cung c·∫•p b√°o c√°o **g·∫ßn real-time**, t√°ch bi·ªát d·ªØ li·ªáu ƒëa-tenant, cho ph√©p **ph√¢n quy·ªÅn chi ti·∫øt** (row-level) d·ª±a tr√™n RBAC v√† `condition` c·ªßa permission. Ki·∫øn tr√∫c tu√¢n th·ªß `ADR-028 ‚Äì Reporting Architecture`, `ADR-029 ‚Äì Report Template Schema`, `ADR-030 ‚Äì Event Schema Governance`.

### 9.1 Lu·ªìng d·ªØ li·ªáu t·ªïng qu√°t

```mermaid
flowchart LR
  SMS((üìö SMS<br/>MariaDB))
  Debezium([‚öôÔ∏è Debezium CDC])
  DataLake[(üíæ GCS Parquet Staging)]
  DataFlow([üõ†Ô∏è Dataflow<br/>ELT Transform])
  BQ[üì¶ BigQuery<br/>Data Warehouse]
  ReportSvc([üìä Reporting Service])
  APIGW(üõ°Ô∏è API Gateway)
  FE[üåê Superadmin Portal]

  SMS --> Debezium --> DataLake --> DataFlow --> BQ
  ReportSvc ==> BQ
  FE -. https .-> APIGW ==> ReportSvc
```

* **CDC** Debezium stream ‚Üí GCS (parquet) < 1 min lag.
* **Dataflow** load & transform ‚ûú BQ **Raw ‚Üí Staging ‚Üí Mart** (Kimball).
* **Reporting Service** ch·∫°y query tham s·ªë ho√°, th√™m `tenant_id` & RBAC filters.
* **Superadmin Portal** t·∫£i b√°o c√°o qua Gateway (JWT + permission ki·ªÉm tra).

### 9.2 Ki·∫øn tr√∫c Data Warehouse (BigQuery)

| Layer              | V√≠ d·ª• b·∫£ng                      | Partition / Cluster | B·∫£o m·∫≠t                    |
| ------------------ | ------------------------------- | ------------------- | -------------------------- |
| **Raw**            | `abc_sms_enrolment_raw`         | `_PARTITIONDATE`    | IAM: read-only             |
| **Staging**        | `abc_sms_enrolment_stg`         | `_PARTITIONDATE`    | ‚Äî                          |
| **Mart**           | `fct_enrolment` ¬∑ `dim_student` | cluster `tenant_id` | Row ACL by `tenant_id`     |
| **Reporting View** | `vw_financial_summary`          | ‚Äî                   | Authorized View per tenant |

*Retention*: Raw 30 ng√†y, Mart 5 nƒÉm (·∫©n danh PII theo ADR-024).

### 9.3 RBAC & Row-Level Security

| C·∫•p truy c·∫≠p | ƒêi·ªÅu ki·ªán SQL                     | Permission y√™u c·∫ßu                                   |
| ------------ | --------------------------------- | ---------------------------------------------------- |
| **Tenant**   | `WHERE tenant_id = $tid`          | `report.view_financial_summary`                      |
| **Class**    | `WHERE class_id = $user.class_id` | `report.view_login_by_tenant` + condition            |
| **Global**   | Kh√¥ng filter                      | `report.view_financial_summary` + role `admin.super` |

*Gateway* g·∫Øn `tenant_id`, `roles`, `permissions` v√†o header; Reporting Service d·ª±ng c√¢u l·ªánh SQL v·ªõi **parameterized filters** ‚Üí tr√°nh SQL-Injection.

### 9.4 Template & Export

* T·∫•t c·∫£ template JSON schema l∆∞u `report_templates` (version-controlled).
* API:

  * `GET /reports/{id}` ‚Äì metadata & required params.
  * `POST /reports/{id}/export` ‚Äì CSV / Parquet; header `Content-Disposition`.
* Quy·ªÅn `report.manage_report_templates` cho ph√©p admin tenant s·ª≠a template clone.

### 9.5 Gi√°m s√°t chi ph√≠ & Hi·ªáu su·∫•t

| KPI                      | M·ª•c ti√™u         | Alert        |
| ------------------------ | ---------------- | ------------ |
| `bq_query_latency_p95`   | < 5 s            | > 10 s 5‚Ä≤    |
| `bq_cost_per_tenant_day` | +‚â§ 15 % 30 d-avg | Slack FinOps |
| `elt_lag_minutes_p95`    | < 10‚Ä≤            | > 20‚Ä≤ 15‚Ä≤    |

### 9.6 S∆° ƒë·ªì quy·ªÅn truy c·∫≠p b√°o c√°o

```mermaid
stateDiagram-v2
  [*] --> RequestAPI
  RequestAPI -->|JWT valid + permission| BuildQuery
  BuildQuery --> ExecuteBQ
  ExecuteBQ --> ExportFile
  ExportFile --> [*]
  RequestAPI -->|No permission| Forbidden
  Forbidden --> [*]
```

### 9.7 Roadmap m·ªü r·ªông

1. **Materialized View** cho b√°o c√°o th·ªùi gian th·ª±c attendance (latency < 30 s).
2. **Pre-computed cube** (BigQuery BI Engine) cho dashboard hi·ªáu nƒÉng cao.
3. **Tenant self-service chart builder** ‚Äì drag-and-drop, d√πng row ACL ƒë√£ s·∫µn.

> **K·∫øt qu·∫£** ‚Äì B√°o c√°o ph√¢n t√°ch theo tenant, c√≥ th·ªÉ tu·ª≥ bi·∫øn ƒëi·ªÅu ki·ªán truy c·∫≠p (row-level), trong khi chi ph√≠ v√† ƒë·ªô tr·ªÖ ƒë∆∞·ª£c ki·ªÉm so√°t ch·∫∑t ch·∫Ω.

---

## 10. AI Integration Strategy

> **M·ª•c ti√™u** ‚Äì ·ª®ng d·ª•ng AI ƒë·ªÉ **n√¢ng cao tr·∫£i nghi·ªám** (chat-support, g·ª£i √Ω h·ªçc t·∫≠p), **t·ªëi ∆∞u v·∫≠n h√†nh** (d·ª± b√°o l·ªói, chi ph√≠) v√† **m·ªü r·ªông s·∫£n ph·∫©m** (ph√¢n t√≠ch d·ªØ li·ªáu h·ªçc t·∫≠p).  
> Chi·∫øn l∆∞·ª£c b√°m theo 4 tr·ª•: **(1) Use-case r√µ r√†ng ‚Üí (2) Data foundation s·∫°ch ‚Üí (3) Model lifecycle c√≥ ki·ªÉm so√°t ‚Üí (4) Tu√¢n th·ªß b·∫£o m·∫≠t/ƒë·∫°o ƒë·ª©c**.

### 10.1 Use-case ∆Øu ti√™n (2025-2026)

| Use-case | M√¥ t·∫£ | M√¥ h√¨nh / API |
|----------|-------|---------------|
| **AI Chat Support** | Chatbot h·ªó tr·ª£ gi√°o vi√™n & ph·ª• huynh (FAQ, h∆∞·ªõng d·∫´n) | LLM (Vertex AI PaLM 2-Text, context Knowledge-Graph) |
| **Homework Feedback** | G·ª£i √Ω s·ª≠a c√¢u / gi·∫£i chi ti·∫øt cho h·ªçc sinh | LLM + Prompt-engineering + Guardrails |
| **Attendance Anomaly** | D·ª± b√°o v·∫Øng m·∫∑t b·∫•t th∆∞·ªùng | LSTM tim-series (BigQuery ML) |
| **Cost Forecast** | D·ª± ƒëo√°n chi ph√≠ GCP/tenant th√°ng t·ªõi | Prophet ARIMA |
| **Incident Triage** | Ph√¢n lo·∫°i log l·ªói ‚Üí g·ª£i √Ω fix | Embedding + kNN (Vector Search) |

### 10.2 Ki·∫øn tr√∫c tri·ªÉn khai

```mermaid
flowchart LR
  subgraph Core_AI ["ü§ñ AI Core Services"]
    AIAPI[(AI Inference API<br/>Cloud Run)]
    VectorDB[(Vertex AI Vector<br/>Store)]
    FeatureStore[(Feature Store)]
  end

  subgraph DataPlane
    BQ[(BigQuery DW)]
    PubSub((Pub/Sub events))
  end

  FE[üåê Frontend / Portal] -. gRPC/REST .-> AIAPI
  BQ -- batch --> FeatureStore
  PubSub -- stream --> FeatureStore
  AIAPI -- embed --> VectorDB
  AIAPI -- fetch feature --> FeatureStore
  AIAPI -. call .-> VertexLLM[[Vertex AI<br/>PaLM 2]]
```

### 10.3 Model Lifecycle

| Giai ƒëo·∫°n      | C√¥ng c·ª•                                 | Quy tr√¨nh                                                 |
| -------------- | --------------------------------------- | --------------------------------------------------------- |
| **Experiment** | Vertex AI Workbench + AutoML            | Data Scientist ch·∫°y notebook; metadata log ML Metadata    |
| **Train**      | Vertex AI Training                      | Output `model-artifact:hash` k√®m `schema_version`         |
| **Validate**   | CI job `ml-test`                        | Accuracy ‚â• KPI; bias test; security scan prompt-injection |
| **Deploy**     | Cloud Run (CPU) / GPU endpoint          | Blue-Green 5‚Üí50‚Üí100 %                                     |
| **Monitor**    | Vertex AI Model Monitoring + Prometheus | Drift, latency, cost, PII leakage alert                   |

*Governance*: PR ph·∫£i k√®m **Model Card** (YAML) ‚Üí review **AI Guild**.

### 10.4 B·∫£o m·∫≠t & ƒê·∫°o ƒë·ª©c

* **PII Masking** tr∆∞·ªõc khi g·ª≠i prompt t·ªõi LLM (`email`, `phone`, `student_name`).
* **Prompt Firewall** ‚Äì regex + model-guard kh√¥ng tr·∫£ l·ªùi n·ªôi dung c·∫•m (Cheating, PII).
* **Opt-in**: H·ªçc sinh < 16 tu·ªïi y√™u c·∫ßu ph·ª• huynh ƒë·ªìng √Ω.
* **Data Residency**: Ch·ªâ l∆∞u embedding ·ªü `us-central1` (GDPR SCC).

### 10.5 KPI & Gi√°m s√°t

| Metric                                   | Target     | Alert           |
| ---------------------------------------- | ---------- | --------------- |
| `ai_inference_latency_p95`               | < 800 ms   | > 1200 ms 5‚Ä≤    |
| `chatbot_answer_helpful_rate` (thumb-up) | > 85 %     | < 70 % ng√†y     |
| `model_drift_score`                      | < 0.1      | > 0.2 tu·∫ßn      |
| `cost_ai_per_1000req`                    | ‚â§ 0.02 USD | > 0.03 USD ng√†y |

### 10.6 Roadmap

1. **Q3-2025** ‚Äì Chat Support Alpha (English ‚Üí Vietnamese).
2. **Q4-2025** ‚Äì Homework Feedback Pilot ·ªü 2 tenant Premium.
3. **Q1-2026** ‚Äì Full Cost Forecast + Incident Triage.
4. **Q2-2026** ‚Äì Fine-tune mini-LLM on-prem (5-7 B params) n·∫øu ROI ƒë·∫°t.

> **Th√¥ng ƒëi·ªáp ch·ªß ƒë·∫°o:** AI ch·ªâ h·ªØu √≠ch khi *t√≠ch h·ª£p m∆∞·ª£t* v√†o lu·ªìng d·ªØ li·ªáu & b·∫£o m·∫≠t s·∫µn c√≥; DX-VAS l·∫•y **data quality + governance** l√†m tr·ªçng t√¢m tr∆∞·ªõc khi ‚Äúb∆°m‚Äù m√¥ h√¨nh v√†o s·∫£n ph·∫©m.

---

üìå **Ghi ch√∫:**

* `DataAccessAPI` l√† l·ªõp tr·ª´u t∆∞·ª£ng (c√≥ th·ªÉ d√πng ƒë·ªÉ chu·∫©n b·ªã d·ªØ li·ªáu cho training ho·∫∑c inference)
* `MetadataRegistry` t∆∞∆°ng ·ª©ng v·ªõi qu·∫£n tr·ªã schema theo `ADR-030`
* M·ªói AI Agent c√≥ m·ª•c ti√™u ri√™ng (h·ªó tr·ª£, t·ªïng h·ª£p, d·ª± ƒëo√°n) v√† c√≥ th·ªÉ t√°i s·ª≠ d·ª•ng query/template t·ª´ Reporting Service

---

üìò **Ghi ch√∫:**

* UI kh√¥ng n√™n hard-code role, m√† n√™n ki·ªÉm tra theo permission c·ª• th·ªÉ (VD: `can_assign_role`, `can_view_tuition`)
* C√°c permission n√†y ƒë∆∞·ª£c Gateway tr·∫£ v·ªÅ trong JWT ho·∫∑c refresh qua API `GET /me/permissions`
* Vi·ªác ki·ªÉm tra quy·ªÅn c√≥ th·ªÉ d√πng Hook/Vuex/Redux trung t√¢m t·∫°i frontend ƒë·ªÉ g·∫Øn c·ªù `canAccess[X]`

üìé Li√™n quan:

* [RBAC Deep Dive](./rbac-deep-dive.md#11-best-practices-cho-qu·∫£n-tr·ªã-rbac)
* [README](../README.md)
