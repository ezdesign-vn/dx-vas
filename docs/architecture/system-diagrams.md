# S∆° ƒë·ªì Ki·∫øn tr√∫c H·ªá th·ªëng dx-vas

T√†i li·ªáu n√†y t·∫≠p h·ª£p t·∫•t c·∫£ c√°c s∆° ƒë·ªì ki·∫øn tr√∫c quan tr·ªçng c·ªßa h·ªá th·ªëng chuy·ªÉn ƒë·ªïi s·ªë dx-vas, bao g·ªìm:

* S∆° ƒë·ªì ki·∫øn tr√∫c t·ªïng th·ªÉ
* Di·ªÖn gi·∫£i c√°c kh·ªëi ch·ª©c nƒÉng
* C√°c s∆° ƒë·ªì con chi ti·∫øt theo t·ª´ng lu·ªìng nghi·ªáp v·ª• (v√≠ d·ª•: Tuy·ªÉn sinh, Th√¥ng b√°o, Ph√¢n quy·ªÅn RBAC...)

## üìö M·ª•c l·ª•c S∆° ƒë·ªì Ki·∫øn tr√∫c H·ªá th·ªëng dx-vas

| STT | T√™n s∆° ƒë·ªì | M√¥ t·∫£ ng·∫Øn | Li√™n k·∫øt |
|-----|-----------|------------|----------|
| 1Ô∏è‚É£ | **Ki·∫øn tr√∫c t·ªïng quan h·ªá th·ªëng Multi-Tenant** | T·ªïng th·ªÉ h·ªá th·ªëng g·ªìm Shared Core v√† c√°c Tenant Stack | [Xem s∆° ƒë·ªì](#1-ki·∫øn-tr√∫c-t·ªïng-quan-h·ªá-th·ªëng-multi-tenant) |
| 2Ô∏è‚É£ | **Lu·ªìng ƒë√°nh gi√° RBAC t·∫°i API Gateway** | C√°ch Gateway ƒë√°nh gi√° quy·ªÅn ƒë·ªông t·ª´ JWT + Redis + Sub Service | [Xem s∆° ƒë·ªì](#2-lu·ªìng-ƒë√°nh-gi√°-rbac-t·∫°i-api-gateway) |
| 3Ô∏è‚É£ | **Lu·ªìng ph√°t h√†nh JWT ƒëa-tenant** | Qu√° tr√¨nh x√°c th·ª±c Google/OTP v√† ph√°t token | [Xem s∆° ƒë·ªì](#3-lu·ªìng-ph√°t-h√†nh-jwt-ƒëa-tenant) |
| 4Ô∏è‚É£ | **Lu·ªìng g·ª≠i Notification to√†n h·ªá th·ªëng (Option B)** | Pub/Sub fan-out t·ª´ Master ƒë·∫øn Sub Notification Services | [Xem s∆° ƒë·ªì](#4-lu·ªìng-g·ª≠i-notification-to√†n-h·ªá-th·ªëng-option-b--pubsub-fan-out) |
| 5Ô∏è‚É£ | **S∆° ƒë·ªì tri·ªÉn khai h·∫° t·∫ßng (Deployment Diagram)** | T·ªï ch·ª©c project GCP cho core/tenant/monitoring/data | [Xem s∆° ƒë·ªì](#5-s∆°-ƒë·ªì-tri·ªÉn-khai-h·∫°-t·∫ßng-deployment-diagram) |
| 6Ô∏è‚É£ | **V√≤ng ƒë·ªùi t√†i kho·∫£n (Account Lifecycle)** | T·ª´ t·∫°o user ‚Üí g√°n tenant ‚Üí c·∫•p quy·ªÅn ‚Üí v√¥ hi·ªáu h√≥a | [Xem s∆° ƒë·ªì](#6-v√≤ng-ƒë·ªùi-t√†i-kho·∫£n-account-lifecycle) |
| 7Ô∏è‚É£ | **Lu·ªìng ƒë·ªìng b·ªô RBAC t·ª´ Master ‚Üí Sub** | T·ª± ƒë·ªông ho·∫∑c th·ªß c√¥ng sync role/permission template | [Xem s∆° ƒë·ªì](#7-lu·ªìng-ƒë·ªìng-b·ªô-rbac-t·ª´-master--sub-user-services) |
| 8Ô∏è‚É£ | **Ph√¢n quy·ªÅn giao di·ªán ng∆∞·ªùi d√πng (UI Role Mapping)** | Vai tr√≤ ƒë∆∞·ª£c √°nh x·∫° ƒë·∫øn c√°c frontend: Superadmin, Admin, GV, PH | [Xem s∆° ƒë·ªì](#8-ph√¢n-quy·ªÅn-giao-di·ªán-ng∆∞·ªùi-d√πng-ui-role-mapping) |


---

## 1. Ki·∫øn tr√∫c t·ªïng quan h·ªá th·ªëng Multi-Tenant

S∆° ƒë·ªì d∆∞·ªõi ƒë√¢y m√¥ t·∫£ ki·∫øn tr√∫c t·ªïng th·ªÉ c·ªßa h·ªá th·ªëng dx-vas theo m√¥ h√¨nh multi-tenant:

- M·ªôt c√¥ng ty qu·∫£n l√Ω nhi·ªÅu tr∆∞·ªùng th√†nh vi√™n (tenant), m·ªói tr∆∞·ªùng c√≥ stack ri√™ng bi·ªát.
- C√°c stack tenant s·ª≠ d·ª•ng chung c√°c d·ªãch v·ª• c·ªët l√µi nh∆∞ API Gateway, User Service Master, Auth Master.
- Ph√¢n quy·ªÅn, x√°c th·ª±c, th√¥ng b√°o v√† ƒë·ªãnh tuy·∫øn ƒë∆∞·ª£c th·ª±c hi·ªán theo t·ª´ng `tenant_id`.

```mermaid
flowchart TD

  subgraph Tenant_A["Tenant A Stack"]
    A_PWA[PWA A]
    A_Admin[Admin SPA A]
    A_Auth[Sub Auth A]
    A_User[Sub User A]
    A_CRM[CRM Adapter A]
    A_SIS[SIS Adapter A]
    A_LMS[LMS Adapter A]
    A_Notify[Sub Notification A]
  end

  subgraph Tenant_B["Tenant B Stack"]
    B_PWA[PWA B]
    B_Admin[Admin SPA B]
    B_Auth[Sub Auth B]
    B_User[Sub User B]
    B_CRM[CRM Adapter B]
    B_SIS[SIS Adapter B]
    B_LMS[LMS Adapter B]
    B_Notify[Sub Notification B]
  end

  subgraph SharedCore["Shared Core Services"]
    Gateway[üõ°Ô∏è API Gateway]
    AuthMaster[üîê Auth Master]
    UserMaster[üß† User Master]
    Superadmin[üßë‚Äçüíº Superadmin Webapp]
    NotifyMaster[üì£ Notification Master]
    PubSub[üì® Pub/Sub Bus]
    Redis[‚ö° Redis Cache]
    LogSys[üìä Monitoring & Audit]
  end

  A_PWA --> Gateway
  A_Admin --> Gateway
  B_PWA --> Gateway
  B_Admin --> Gateway

  Gateway --> AuthMaster
  Gateway --> UserMaster
  Gateway --> Redis
  Gateway --> LogSys

  Gateway --> A_Auth
  Gateway --> A_User
  Gateway --> A_CRM
  Gateway --> A_SIS
  Gateway --> A_LMS
  Gateway --> A_Notify

  Gateway --> B_Auth
  Gateway --> B_User
  Gateway --> B_CRM
  Gateway --> B_SIS
  Gateway --> B_LMS
  Gateway --> B_Notify

  Superadmin --> UserMaster
  Superadmin --> NotifyMaster

  NotifyMaster --> PubSub
  PubSub --> A_Notify
  PubSub --> B_Notify

  AuthMaster --> UserMaster
  A_Auth --> UserMaster
  B_Auth --> UserMaster
```

üìò **Ghi ch√∫:**

* C√°c kh·ªëi `Tenant A`, `Tenant B` c√≥ th·ªÉ m·ªü r·ªông t√πy theo s·ªë l∆∞·ª£ng tr∆∞·ªùng.
* Sub Notification Service l·∫Øng nghe t·ª´ `Notification Master` th√¥ng qua Pub/Sub (`Option B`).
* RBAC, Auth, Notification ƒë·ªÅu ho·∫°t ƒë·ªông theo `tenant_id`, ƒë·∫£m b·∫£o isolation.

---

## 2. Lu·ªìng ƒë√°nh gi√° RBAC t·∫°i API Gateway

S∆° ƒë·ªì d∆∞·ªõi m√¥ t·∫£ c√°ch API Gateway th·ª±c hi·ªán x√°c th·ª±c v√† ƒë√°nh gi√° ph√¢n quy·ªÅn ƒë·ªông (RBAC) cho t·ª´ng request d·ª±a tr√™n JWT, Redis cache, v√† Sub User Service.

- Gateway gi·∫£i m√£ JWT ƒë·ªÉ l·∫•y `user_id`, `tenant_id`, `permissions`.
- N·∫øu c√≥ cache, s·ª≠ d·ª•ng Redis ƒë·ªÉ tra c·ª©u nhanh.
- N·∫øu kh√¥ng c√≥, g·ªçi Sub User Service t∆∞∆°ng ·ª©ng ƒë·ªÉ l·∫•y quy·ªÅn theo tenant.
- ƒê√°nh gi√° c√°c ƒëi·ªÅu ki·ªán JSONB n·∫øu c√≥ trong permission.

```mermaid
sequenceDiagram
    autonumber
    participant Frontend as üåê Frontend App
    participant Gateway as üõ°Ô∏è API Gateway
    participant JWT as üì¶ JWT Token
    participant Redis as ‚ö° Redis (RBAC Cache)
    participant SubUser as üß© Sub User Service (per tenant)

    Frontend->>Gateway: G·ª≠i request k√®m JWT

    Gateway->>JWT: Gi·∫£i m√£ token
    Gateway->>JWT: Tr√≠ch xu·∫•t user_id, tenant_id

    alt Cache Hit
        Gateway->>Redis: GET rbac:{user_id}:{tenant_id}
        Redis-->>Gateway: Tr·∫£ v·ªÅ roles & permissions
    else Cache Miss
        Gateway->>SubUser: GET /rbac/{user_id}
        SubUser-->>Gateway: Tr·∫£ v·ªÅ roles & permissions
        Gateway->>Redis: SET rbac:{user_id}:{tenant_id}
    end

    Gateway->>Gateway: ƒê√°nh gi√° permission match + condition JSONB

    alt C√≥ quy·ªÅn truy c·∫≠p h·ª£p l·ªá
        Gateway-->>Frontend: ‚úÖ 200 OK (Forward ƒë·∫øn backend)
    else Kh√¥ng h·ª£p l·ªá
        Gateway-->>Frontend: ‚ùå 403 Forbidden
    end
```

üìò **Tham kh·∫£o th√™m:**

* [Chi ti·∫øt v·ªÅ RBAC Cache](../rbac-deep-dive.md#6-chi·∫øn-l∆∞·ª£c-cache-rbac-t·∫°i-api-gateway)
* [C·∫•u tr√∫c permission c√≥ ƒëi·ªÅu ki·ªán](../rbac-deep-dive.md#5-permission-c√≥-ƒëi·ªÅu-ki·ªán-condition-jsonb)

---

## 3. Lu·ªìng ph√°t h√†nh JWT ƒëa-tenant

S∆° ƒë·ªì n√†y m√¥ t·∫£ hai lu·ªìng x√°c th·ª±c v√† ph√°t h√†nh JWT:

1. Qua Google OAuth2 ‚Äì x·ª≠ l√Ω b·ªüi Auth Service Master
2. Qua Local/OTP ‚Äì x·ª≠ l√Ω b·ªüi Sub Auth Service c·ªßa t·ª´ng tenant

Sau khi x√°c th·ª±c, JWT ƒë∆∞·ª£c ph√°t h√†nh v·ªõi th√¥ng tin `user_id_global`, `tenant_id`, `roles`, `permissions` ‚Äì ph·ª•c v·ª• ph√¢n quy·ªÅn t·∫°i API Gateway.

```mermaid
sequenceDiagram
    autonumber
    participant User as üë§ Ng∆∞·ªùi d√πng
    participant Frontend as üåê Frontend App
    participant AuthM as üîê Auth Master
    participant AuthT as üîê Sub Auth Service
    participant Master as üß† User Service Master
    participant SubUser as üß© Sub User Service
    participant JWT as üì¶ JWT Token

    rect rgba(220,220,220,0.1)
    Note over User, AuthM: ƒêƒÉng nh·∫≠p b·∫±ng Google OAuth2
    User->>Frontend: Truy c·∫≠p ·ª©ng d·ª•ng
    Frontend->>AuthM: G·ª≠i y√™u c·∫ßu ƒëƒÉng nh·∫≠p Google
    AuthM->>Google: OAuth2 login
    Google-->>AuthM: Access Token
    AuthM->>Master: X√°c minh user Google + l·∫•y user_id_global
    Master-->>AuthM: Tr·∫£ user_id_global + danh s√°ch tenant

    alt User c√≥ nhi·ªÅu tenant
        AuthM->>Frontend: Hi·ªÉn th·ªã danh s√°ch tenant ƒë·ªÉ ch·ªçn
        Frontend->>AuthM: G·ª≠i l·∫°i tenant ƒë√£ ch·ªçn
    end

    AuthM->>SubUser: L·∫•y roles & permissions theo tenant ƒë√£ ch·ªçn
    SubUser-->>AuthM: Tr·∫£ RBAC
    AuthM->>JWT: Ph√°t h√†nh token ch·ª©a user_id, tenant_id, roles, permissions
    AuthM-->>Frontend: Tr·∫£ JWT
    end

    rect rgba(220,220,220,0.1)
    Note over User, AuthT: ƒêƒÉng nh·∫≠p b·∫±ng OTP / Local
    User->>Frontend: Truy c·∫≠p app tenant (VD: `abc.truongvietanh.edu.vn`)
    Frontend->>AuthT: G·ª≠i y√™u c·∫ßu login OTP
    AuthT->>Master: Ki·ªÉm tra ho·∫∑c ƒëƒÉng k√Ω user ‚Üí l·∫•y user_id_global
    Master-->>AuthT: Tr·∫£ user_id_global
    AuthT->>SubUser: L·∫•y RBAC theo tenant
    SubUser-->>AuthT: Tr·∫£ roles, permissions
    AuthT->>JWT: Ph√°t JWT v·ªõi tenant_id + quy·ªÅn
    AuthT-->>Frontend: Tr·∫£ JWT
    end
```

üìò **Tham kh·∫£o th√™m:**

* [ADR-006: Chi·∫øn l∆∞·ª£c x√°c th·ª±c](../ADR/adr-006-auth-strategy.md)
* [C·∫•u tr√∫c token & chu·∫©n ho√° claim](../README.md#5-auth-service)

---

## 4. Lu·ªìng g·ª≠i Notification to√†n h·ªá th·ªëng (Option B ‚Äì Pub/Sub fan-out)

S∆° ƒë·ªì d∆∞·ªõi ƒë√¢y th·ªÉ hi·ªán lu·ªìng g·ª≠i th√¥ng b√°o to√†n h·ªá th·ªëng khi Superadmin mu·ªën broadcast ƒë·∫øn m·ªôt ho·∫∑c nhi·ªÅu tr∆∞·ªùng th√†nh vi√™n:

- Notification Master ph√°t s·ª± ki·ªán l√™n Pub/Sub.
- M·ªói Sub Notification Service l·∫Øng nghe topic, l·ªçc theo `tenant_id`, g·ª≠i th√¥ng b√°o b·∫±ng k√™nh ri√™ng (Zalo OA, Gmail API‚Ä¶).
- M·ªói Sub Service ph·∫£n h·ªìi l·∫°i tr·∫°ng th√°i g·ª≠i qua m·ªôt topic ri√™ng ƒë·ªÉ Master theo d√µi v√† t·ªïng h·ª£p.

```mermaid
sequenceDiagram
    autonumber
    participant Superadmin as üßë‚Äçüíº Superadmin Webapp
    participant NotifyMaster as üì£ Notification Master
    participant PubSub as üì® Pub/Sub: vas-global-notifications-topic
    participant NotifyA as üîî Sub Notification ‚Äì Tenant A
    participant NotifyB as üîî Sub Notification ‚Äì Tenant B
    participant PubSubAck as üì© Pub/Sub: vas-tenant-notification-ack-topic

    Superadmin->>NotifyMaster: G·ª≠i y√™u c·∫ßu g·ª≠i th√¥ng b√°o to√†n h·ªá th·ªëng
    NotifyMaster->>PubSub: Publish `global_notification_requested`

    Note over PubSub: Fan-out message ƒë·∫øn t·∫•t c·∫£ subscriber

    PubSub-->>NotifyA: S·ª± ki·ªán g·ª≠i th√¥ng b√°o
    PubSub-->>NotifyB: S·ª± ki·ªán g·ª≠i th√¥ng b√°o

    alt tenant_id kh·ªõp
        NotifyA->>NotifyA: √Åp d·ª•ng template + l·ªçc ng∆∞·ªùi nh·∫≠n
        NotifyA->>Channels: G·ª≠i th√¥ng b√°o ƒëa k√™nh
        NotifyA->>PubSubAck: Ph·∫£n h·ªìi `tenant_notification_batch_status`
    end

    alt tenant_id kh·ªõp
        NotifyB->>NotifyB: √Åp d·ª•ng template + l·ªçc ng∆∞·ªùi nh·∫≠n
        NotifyB->>Channels: G·ª≠i th√¥ng b√°o ƒëa k√™nh
        NotifyB->>PubSubAck: Ph·∫£n h·ªìi `tenant_notification_batch_status`
    end

    Note over NotifyMaster: (t√πy ch·ªçn) L·∫Øng nghe `tenant_notification_batch_status` ƒë·ªÉ t·ªïng h·ª£p k·∫øt qu·∫£
```

üìò **Ghi ch√∫:**

* M·ªói Sub Notification t·ª± ch·ªãu tr√°ch nhi·ªám g·ª≠i ƒëi v√† ghi log theo c·∫•u h√¨nh tenant ri√™ng.
* Notification Master **kh√¥ng c·∫ßn bi·∫øt c·∫•u tr√∫c c·ª• th·ªÉ** c·ªßa t·ª´ng Sub Service, ch·ªâ c·∫ßn ph√°t s·ª± ki·ªán chu·∫©n ho√°.
* H·ªá th·ªëng h·ªó tr·ª£ c·∫£ l·ªçc theo `target_tenant_ids`, `target_roles`, ho·∫∑c ti√™u ch√≠ t√πy ch·ªânh.

üìé Tham kh·∫£o th√™m:

* [`phat-sinh-va-phuong-an-02.md`](../requirements/phat-sinh-va-phuong-an-02.md)
* [`adr-008-audit-logging.md`](../ADR/adr-008-audit-logging.md)

---

## 5. S∆° ƒë·ªì tri·ªÉn khai h·∫° t·∫ßng (Deployment Diagram)

S∆° ƒë·ªì n√†y m√¥ t·∫£ ki·∫øn tr√∫c tri·ªÉn khai h·∫° t·∫ßng c·ªßa h·ªá th·ªëng dx-vas tr√™n Google Cloud, theo m√¥ h√¨nh chia project r√µ r√†ng gi·ªØa core services v√† c√°c tenant. M·ªói tenant c√≥ stack ri√™ng, ƒë·ªôc l·∫≠p v·ªÅ t√†i nguy√™n, gi√∫p ƒë·∫£m b·∫£o c√°ch ly v√† d·ªÖ scale.

```mermaid
graph TD

  subgraph GCP["Google Cloud Platform"]
    
    subgraph core["Project: dx-vas-core"]
      APIGW[üõ°Ô∏è API Gateway]
      AuthMaster[üîê Auth Service Master]
      UserMaster[üß† User Service Master]
      NotifyMaster[üì£ Notification Master]
      Redis[‚ö° Redis Cache]
      PubSub[üì® Pub/Sub Topics]
    end

    subgraph tenantA["Project: dx-vas-tenant-a"]
      AuthA[üîê Sub Auth A]
      UserA[üß© Sub User A]
      NotifyA[üîî Sub Notification A]
      CRM_A[CRM Adapter A]
      SIS_A[SIS Adapter A]
      LMS_A[LMS Adapter A]
    end

    subgraph tenantB["Project: dx-vas-tenant-b"]
      AuthB[üîê Sub Auth B]
      UserB[üß© Sub User B]
      NotifyB[üîî Sub Notification B]
      CRM_B[CRM Adapter B]
      SIS_B[SIS Adapter B]
      LMS_B[LMS Adapter B]
    end

    subgraph monitoring["Project: dx-vas-monitoring"]
      Logs[üìä Cloud Logging]
      Metrics[üìà Cloud Monitoring]
      Alerts[üö® Alerting Rules]
    end

    subgraph data["Project: dx-vas-data"]
      DB["üóÑÔ∏è Cloud SQL (PostgreSQL, MySQL)"]
      BQ[üì¶ BigQuery]
      GCS[üìÅ GCS Buckets]
    end
  end

  APIGW --> AuthMaster
  APIGW --> UserMaster
  APIGW --> Redis
  APIGW --> tenantA
  APIGW --> tenantB

  NotifyMaster --> PubSub
  PubSub --> NotifyA
  PubSub --> NotifyB

  AuthA --> UserMaster
  AuthB --> UserMaster
  NotifyA --> Logs
  NotifyB --> Logs
  UserMaster --> DB
  tenantA --> DB
  tenantB --> DB
  APIGW --> Logs
```

üìò **Gi·∫£i th√≠ch:**

* M·ªói tenant ƒë∆∞·ª£c t√°ch th√†nh 1 project ri√™ng (theo chu·∫©n ƒëa t·ªï ch·ª©c v√† qu·∫£n tr·ªã billing).
* `dx-vas-core` ch·ª©a c√°c d·ªãch v·ª• d√πng chung: Gateway, Auth/User Master, Redis, Pub/Sub.
* `dx-vas-monitoring` t·∫≠p trung log/metrics to√†n h·ªá th·ªëng.
* `dx-vas-data` l∆∞u tr·ªØ Cloud SQL, BigQuery, GCS ph·ª•c v·ª• ph√¢n t√≠ch, l∆∞u tr·ªØ t·∫≠p trung.

üìé Tham kh·∫£o chi ti·∫øt:

* [`adr-019-project-layout.md`](../ADR/adr-019-project-layout.md)
* [`adr-015-deployment-strategy.md`](../ADR/adr-015-deployment-strategy.md)

---

## 6. V√≤ng ƒë·ªùi t√†i kho·∫£n (Account Lifecycle)

S∆° ƒë·ªì d∆∞·ªõi ƒë√¢y m√¥ t·∫£ to√†n b·ªô v√≤ng ƒë·ªùi c·ªßa m·ªôt ng∆∞·ªùi d√πng trong h·ªá th·ªëng dx-vas, t·ª´ khi ƒë∆∞·ª£c ƒë·ªãnh danh t·∫°i User Service Master ƒë·∫øn khi ƒë∆∞·ª£c g√°n v√†o tenant, ph√¢n quy·ªÅn, ho·∫°t ƒë·ªông v√† (n·∫øu c·∫ßn) b·ªã v√¥ hi·ªáu h√≥a.

```mermaid
graph TD

  A[üì• ƒêƒÉng k√Ω / Import User] --> B[üß† T·∫°o ƒë·ªãnh danh t·∫°i users_global]
  B --> C[üè´ G√°n v√†o tenant t·∫°i user_tenant_assignments]
  C --> D[üß© ƒê·ªìng b·ªô xu·ªëng users_in_tenant]
  D --> E[üóÇÔ∏è G√°n role t·∫°i user_role_in_tenant]
  E --> F[üõÇ Ph√°t JWT sau khi x√°c th·ª±c]
  F --> G[‚öôÔ∏è Ho·∫°t ƒë·ªông & ph√¢n quy·ªÅn t·∫°i Gateway]

  G --> H[ü™µ Audit log + th·ªëng k√™]
  G --> I[üõë V√¥ hi·ªáu h√≥a t·∫°m th·ªùi: is_active_in_tenant = false]
  G --> J[üóÉÔ∏è V√¥ hi·ªáu h√≥a to√†n c·ª•c: is_active = false]

  I --> H
  J --> H
```

üìå **√ù nghƒ©a c√°c b∆∞·ªõc:**

* **B∆∞·ªõc A‚ÄìC:** User c√≥ th·ªÉ ƒë∆∞·ª£c th√™m th·ªß c√¥ng (Admin/Superadmin) ho·∫∑c import t·ª´ h·ªá th·ªëng kh√°c.
* **B∆∞·ªõc D‚ÄìE:** Khi g√°n v√†o tenant, user ƒë∆∞·ª£c √°nh x·∫° v√† g√°n role t·∫°i tenant ƒë√≥.
* **B∆∞·ªõc F‚ÄìG:** Sau khi ƒëƒÉng nh·∫≠p, token ƒë∆∞·ª£c ph√°t h√†nh v√† d√πng ƒë·ªÉ ph√¢n quy·ªÅn.
* **B∆∞·ªõc H‚ÄìJ:** Qu·∫£n tr·ªã vi√™n c√≥ th·ªÉ v√¥ hi·ªáu h√≥a t·∫°m th·ªùi t·∫°i tenant ho·∫∑c to√†n h·ªá th·ªëng.

üìò Tham kh·∫£o chi ti·∫øt m√¥ h√¨nh d·ªØ li·ªáu:

* [`user-service/master/data-model.md`](../services/user-service/master/data-model.md)
* [`user-service/tenant/data-model.md`](../services/user-service/tenant/data-model.md)

---

## 7. Lu·ªìng ƒë·ªìng b·ªô RBAC t·ª´ Master ‚Üí Sub User Services

S∆° ƒë·ªì n√†y m√¥ t·∫£ c√°ch h·ªá th·ªëng dx-vas th·ª±c hi·ªán ƒë·ªìng b·ªô vai tr√≤ v√† quy·ªÅn t·ª´ User Service Master xu·ªëng c√°c Sub User Service c·ªßa t·ª´ng tenant.

- C√°c template vai tr√≤/quy·ªÅn ƒë∆∞·ª£c qu·∫£n l√Ω t·∫≠p trung.
- Tenant c√≥ th·ªÉ ch·ªçn k·∫ø th·ª´a t·ª± ƒë·ªông, ho·∫∑c clone ƒë·ªÉ ch·ªânh s·ª≠a n·ªôi b·ªô.
- Vi·ªác ƒë·ªìng b·ªô ƒë∆∞·ª£c th·ª±c hi·ªán theo event (Pub/Sub) ho·∫∑c API ch·ªß ƒë·ªông.

```mermaid
sequenceDiagram
    autonumber
    participant Admin as üßë‚Äçüíº Superadmin / DevOps
    participant Master as üß† User Service Master
    participant PubSub as üì® Pub/Sub: rbac-sync
    participant SubUser as üß© Sub User Service (per tenant)

    Admin->>Master: C·∫≠p nh·∫≠t template role/permission
    Master->>Master: Ghi v√†o global_roles_templates / global_permissions_templates

    alt C·∫•u h√¨nh auto-sync (tenant ƒëang d√πng b·∫£n chu·∫©n)
        Master->>PubSub: Publish `rbac_template_updated`
        PubSub-->>SubUser: S·ª± ki·ªán c·∫≠p nh·∫≠t RBAC
        SubUser->>SubUser: T·ª± ƒë·ªông c·∫≠p nh·∫≠t/c·∫≠p ƒë√® c√°c role/permission
    else Tenant d√πng b·∫£n ƒë√£ clone
        Admin->>SubUser: Y√™u c·∫ßu re-sync th·ªß c√¥ng (qua API)
        SubUser->>SubUser: Hi·ªÉn th·ªã diff, cho ph√©p x√°c nh·∫≠n c·∫≠p nh·∫≠t
    end
```

üìò **Ghi ch√∫:**

* C·∫•u h√¨nh `sync_mode` t·∫°i m·ªói tenant c√≥ th·ªÉ l√†:

  * `"inherit"`: ƒë·ªìng b·ªô t·ª± ƒë·ªông
  * `"clone"`: ch·ªâ copy 1 l·∫ßn, sau ƒë√≥ qu·∫£n l√Ω ri√™ng
* Tenant c√≥ th·ªÉ d√πng dashboard ƒë·ªÉ xem ch√™nh l·ªách gi·ªØa template master v√† local.

üìé T√†i li·ªáu li√™n quan:

* [`rbac-deep-dive.md`](../architecture/rbac-deep-dive.md#7-chi·∫øn-l∆∞·ª£c-ƒë·ªìng-b·ªô-rbac)

---

## 8. Ph√¢n quy·ªÅn giao di·ªán ng∆∞·ªùi d√πng (UI Role Mapping)

S∆° ƒë·ªì d∆∞·ªõi m√¥ t·∫£ c√°ch c√°c vai tr√≤ h·ªá th·ªëng ƒë∆∞·ª£c √°nh x·∫° v√† ki·ªÉm so√°t hi·ªÉn th·ªã t√≠nh nƒÉng trong t·ª´ng l·ªõp giao di·ªán ng∆∞·ªùi d√πng.

- Quy·ªÅn ƒë∆∞·ª£c c·∫•p t·∫°i Sub User Service (per tenant)
- UI x√°c ƒë·ªãnh quy·ªÅn truy c·∫≠p ch·ª©c nƒÉng d·ª±a v√†o c√°c permission ƒë√£ decode t·ª´ JWT

```mermaid
flowchart TD

  subgraph SuperadminWebapp["üßë‚Äçüíº Superadmin Webapp"]
    S1[View Tenants]
    S2[Assign User ‚Üî Tenant]
    S3[Manage Global RBAC Templates]
    S4[Global Notification]
    S5[System Audit Logs]
  end

  subgraph AdminWebapp_Tenant["üßë‚Äçüè´ Admin Webapp (per tenant)"]
    A1[Manage Users in Tenant]
    A2[Assign Roles]
    A3[Create/Update Roles]
    A4["Access Audit Logs (Tenant)"]
    A5[Send Local Notification]
  end

  subgraph TeacherUI["üë©‚Äçüè´ Teacher Interface"]
    T1[Xem l·ªõp ƒëang d·∫°y]
    T2[Nh·∫≠p ƒëi·ªÉm]
    T3[G·ª≠i th√¥ng b√°o ƒë·∫øn h·ªçc sinh]
  end

  subgraph ParentUI["üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Ph·ª• huynh UI"]
    P1[Xem h·ªçc ph√≠]
    P2[Xem ƒëi·ªÉm s·ªë, h·∫°nh ki·ªÉm]
    P3[G·ª≠i ph·∫£n h·ªìi gi√°o vi√™n]
  end

  subgraph JWT["üì¶ JWT Payload"]
    Roles["roles[]"]
    Permissions["permissions[]"]
  end

  JWT --> SuperadminWebapp
  JWT --> AdminWebapp_Tenant
  JWT --> TeacherUI
  JWT --> ParentUI
```

üìò **Ghi ch√∫:**

* UI kh√¥ng n√™n hard-code role, m√† n√™n ki·ªÉm tra theo permission c·ª• th·ªÉ (VD: `can_assign_role`, `can_view_tuition`)
* C√°c permission n√†y ƒë∆∞·ª£c Gateway tr·∫£ v·ªÅ trong JWT ho·∫∑c refresh qua API `GET /me/permissions`
* Vi·ªác ki·ªÉm tra quy·ªÅn c√≥ th·ªÉ d√πng Hook/Vuex/Redux trung t√¢m t·∫°i frontend ƒë·ªÉ g·∫Øn c·ªù `canAccess[X]`

üìé Li√™n quan:

* [`rbac-deep-dive.md`](../architecture/rbac-deep-dive.md#11-best-practices-cho-qu·∫£n-tr·ªã-rbac)
* [`README.md`](../README.md#3-admin-webapp-c·∫•p-ƒë·ªô-tenant)
