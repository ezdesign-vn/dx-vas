# Ph√¢n t√≠ch Chuy√™n s√¢u: Ki·∫øn tr√∫c Ph√¢n quy·ªÅn ƒê·ªông (RBAC) trong H·ªá th·ªëng dx-vas

## üìö M·ª•c l·ª•c Chi ti·∫øt ‚Äì Ph√¢n t√≠ch Ki·∫øn tr√∫c Ph√¢n quy·ªÅn ƒê·ªông (RBAC)

| STT | T√™n m·ª•c | M√¥ t·∫£ | Li√™n k·∫øt |
|-----|---------|-------|----------|
| 1Ô∏è‚É£ | **T·ªïng quan & ƒê·ªãnh nghƒ©a RBAC** | Kh√°i ni·ªám role, permission, condition, √°p d·ª•ng trong ki·∫øn tr√∫c ƒëa tenant | [Xem m·ª•c](#1-t·ªïng-quan--ƒë·ªãnh-nghƒ©a-rbac) |
| 2Ô∏è‚É£ | **Ph√¢n t·∫ßng Qu·∫£n l√Ω ƒê·ªãnh danh & Ph√¢n quy·ªÅn** | Vai tr√≤ c·ªßa User Service Master v√† Sub User Service | [Xem m·ª•c](#2-ph√¢n-t·∫ßng-qu·∫£n-l√Ω-ƒë·ªãnh-danh--ph√¢n-quy·ªÅn) |
| 3Ô∏è‚É£ | **Lu·ªìng X√°c th·ª±c & Ph√¢n quy·ªÅn (Multi-Tenant)** | C√°ch JWT ƒë∆∞·ª£c ph√°t h√†nh v√† RBAC ƒë∆∞·ª£c ƒë√°nh gi√° t·∫°i Gateway | [Xem m·ª•c](#3-lu·ªìng-x√°c-th·ª±c--ph√¢n-quy·ªÅn-multi-tenant) |
| 4Ô∏è‚É£ | **M√¥ h√¨nh D·ªØ li·ªáu RBAC (Master vs Sub)** | Chi ti·∫øt c√°c b·∫£ng schema t·∫°i Master v√† Sub Service | [Xem m·ª•c](#4-m√¥-h√¨nh-d·ªØ-li·ªáu-rbac-master-vs-sub) |
| 5Ô∏è‚É£ | **Permission c√≥ ƒëi·ªÅu ki·ªán (Condition JSONB)** | M√¥ h√¨nh `condition` ƒë·ªông d·ª±a tr√™n context ng∆∞·ªùi d√πng & request | [Xem m·ª•c](#5-permission-c√≥-ƒëi·ªÅu-ki·ªán-condition-jsonb) |
| 6Ô∏è‚É£ | **Chi·∫øn l∆∞·ª£c Cache RBAC t·∫°i API Gateway** | C√°ch Redis cache gi√∫p tƒÉng hi·ªáu nƒÉng v√† logic invalidation | [Xem m·ª•c](#6-chi·∫øn-l∆∞·ª£c-cache-rbac-t·∫°i-api-gateway) |
| 7Ô∏è‚É£ | **Chi·∫øn l∆∞·ª£c ƒê·ªìng b·ªô RBAC** | T·ª´ template Master ƒë·∫øn Sub User Service (k·∫ø th·ª´a ho·∫∑c clone) | [Xem m·ª•c](#7-chi·∫øn-l∆∞·ª£c-ƒë·ªìng-b·ªô-rbac) |
| 8Ô∏è‚É£ | **Hi·ªáu nƒÉng & Kh·∫£ nƒÉng m·ªü r·ªông** | K·ªπ thu·∫≠t t·ªëi ∆∞u cache, pub/sub, autoscale theo tenant | [Xem m·ª•c](#8-hi·ªáu-nƒÉng--kh·∫£-nƒÉng-m·ªü-r·ªông) |
| 9Ô∏è‚É£ | **B·∫£o m·∫≠t chuy√™n s√¢u trong RBAC** | Isolation theo tenant, JWT trust, ƒë·ªãnh danh vai tr√≤ | [Xem m·ª•c](#9-b·∫£o-m·∫≠t-chuy√™n-s√¢u-trong-rbac) |
| üîü | **Gi√°m s√°t & G·ª° l·ªói** | Audit logs, debug header, metric h·ªá th·ªëng RBAC | [Xem m·ª•c](#10-gi√°m-s√°t--g·ª°-l·ªói) |
| 1Ô∏è‚É£1Ô∏è‚É£ | **Best Practices cho Qu·∫£n tr·ªã RBAC** | C√°c khuy·∫øn ngh·ªã t√™n role, s·ªë l∆∞·ª£ng role/user, ph√¢n quy·ªÅn t·ªëi ∆∞u | [Xem m·ª•c](#11-best-practices-cho-qu·∫£n-tr·ªã-rbac) |
| 1Ô∏è‚É£2Ô∏è‚É£ | **C√¥ng c·ª• & T√†i li·ªáu li√™n quan** | Li√™n k·∫øt t·ªõi ADR, data-model, s∆° ƒë·ªì, spec JSONB, OpenAPI | [Xem m·ª•c](#12-c√¥ng-c·ª•--t√†i-li·ªáu-li√™n-quan) |

## 1. T·ªïng quan & ƒê·ªãnh nghƒ©a RBAC

RBAC (Role-Based Access Control) trong h·ªá th·ªëng dx-vas cho ph√©p ki·ªÉm so√°t quy·ªÅn truy c·∫≠p m·ªôt c√°ch linh ho·∫°t v√† c√≥ th·ªÉ m·ªü r·ªông, d·ª±a tr√™n:

- **Vai tr√≤ ng∆∞·ªùi d√πng** (Role) trong t·ª´ng tr∆∞·ªùng th√†nh vi√™n (tenant)
- **T·∫≠p h·ª£p quy·ªÅn** (Permission) ƒë∆∞·ª£c g√°n cho m·ªói role
- **ƒêi·ªÅu ki·ªán th·ª±c thi** (Condition, n·∫øu c√≥) √°p d·ª•ng ·ªü c·∫•p permission

M√¥ h√¨nh RBAC n√†y ho·∫°t ƒë·ªông trong b·ªëi c·∫£nh **multi-tenant**, n∆°i m·ªói tenant (tr∆∞·ªùng th√†nh vi√™n) c√≥ **RBAC ƒë·ªôc l·∫≠p**, nh∆∞ng v·∫´n k·∫ø th·ª´a m·ªôt ph·∫ßn t·ª´ **template to√†n h·ªá th·ªëng** do User Service Master cung c·∫•p.

---

## 2. Ph√¢n t·∫ßng Qu·∫£n l√Ω ƒê·ªãnh danh & Ph√¢n quy·ªÅn

### üß† User Service Master
- L√† ngu·ªìn ch√¢n l√Ω duy nh·∫•t cho to√†n b·ªô ng∆∞·ªùi d√πng (`users_global`)
- Qu·∫£n l√Ω:
  - Danh s√°ch tenant (`tenants`)
  - M·ªëi quan h·ªá user ‚Üî tenant (`user_tenant_assignments`)
  - C√°c template vai tr√≤ v√† quy·ªÅn to√†n h·ªá th·ªëng:
    - `global_roles_templates`
    - `global_permissions_templates`
- Kh√¥ng tr·ª±c ti·∫øp ƒë√°nh gi√° RBAC, m√† cung c·∫•p ƒë·ªãnh danh v√† template cho Sub Services

### üß© Sub User Service (per Tenant)
- M·ªói tenant c√≥ 1 instance ri√™ng, qu·∫£n l√Ω:
  - Ng∆∞·ªùi d√πng thu·ªôc tenant (`users_in_tenant`) ‚Äì √°nh x·∫° ƒë·∫øn `user_id_global`
  - Tr·∫°ng th√°i ho·∫°t ƒë·ªông n·ªôi b·ªô: `is_active_in_tenant`
  - Vai tr√≤ (`roles_in_tenant`), quy·ªÅn (`permissions_in_tenant`)
  - Mapping:
    - `user_role_in_tenant`
    - `role_permission_in_tenant`
- Cho ph√©p k·∫ø th·ª´a t·ª´ template Master ho·∫∑c t·ª± ƒë·ªãnh nghƒ©a

---

## 3. Lu·ªìng X√°c th·ª±c & Ph√¢n quy·ªÅn (Multi-Tenant)

### üîê Lu·ªìng ph√°t h√†nh JWT
1. Ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p qua:
   - Google OAuth2 ‚Üí Auth Master
   - OTP/Local ‚Üí Sub Auth Service
2. Sau khi x√°c th·ª±c:
   - `tenant_id` ƒë∆∞·ª£c ch·ªçn (n·∫øu ng∆∞·ªùi d√πng thu·ªôc nhi·ªÅu tenant).
   - Auth Service g·ªçi **User Service Master** ‚Üí ki·ªÉm tra `user_id_global` & quy·ªÅn truy c·∫≠p tenant.
   - G·ªçi **Sub User Service** ‚Üí l·∫•y `roles`, `permissions`.
   - **G·ªçi Token Service** `POST /token/issue` ‚Üí nh·∫≠n JWT k√Ω **RS256**.
3. JWT ƒë∆∞·ª£c ph√°t h√†nh v·ªõi:
   - `user_id`, `tenant_id`, `roles`, `permissions`, `auth_provider`,
   - **`jti`, `sid`, `exp`** (ph·ª•c v·ª• thu h·ªìi token & qu·∫£n l√Ω phi√™n).

### üõ°Ô∏è API Gateway ƒë√°nh gi√° RBAC
- X√°c th·ª±c ch·ªØ k√Ω JWT **offline** qua **JWKS** cache 10‚Ä≤.
- Ki·ªÉm tra `tenant_id`, `exp` v√† tr·∫°ng th√°i ng∆∞·ªùi d√πng (`is_active`, `is_active_in_tenant`).
- Tra **Redis**: `revoked:{jti}` ‚Üí n·∫øu *hit* ‚áí tr·∫£ `403` (`token.revoked`), hu·ª∑ cache RBAC.
- Truy v·∫•n Redis cache RBAC: `rbac:{user_id}:{tenant_id}` ‚Üí n·∫øu *miss* g·ªçi Sub User Service ƒë·ªÉ n·∫°p l·∫°i.
- ƒê√°nh gi√° `condition` n·∫øu permission c√≥ r√†ng bu·ªôc ƒë·ªông.

---

## 4. M√¥ h√¨nh D·ªØ li·ªáu RBAC (Master vs Sub)

> **Nguy√™n t·∫Øc chung**  
> * **User Service Master** (Core ‚Äî PostgreSQL) l∆∞u danh t√≠nh _to√†n c·ª•c_ & template RBAC chu·∫©n.  
> * **Sub User Service** (per-tenant ‚Äî MariaDB) ch·ªâ l∆∞u RBAC _c·ª•c b·ªô_, ƒë·ªìng b·ªô b·∫•t ƒë·ªìng b·ªô qua Pub/Sub.  
> * M·ªçi b·∫£ng ph·∫£i c√≥ kho√° ch√≠nh r√µ r√†ng, theo chu·∫©n ‚≠ê2 Data Model Standard.

---

### üì¶ T·∫°i User Service Master (PostgreSQL)

```sql
-- +flyway
-- 4.1  Ng∆∞·ªùi d√πng to√†n h·ªá th·ªëng
CREATE TABLE users_global (
  user_id           UUID PRIMARY KEY,
  full_name         TEXT NOT NULL,
  email             TEXT NOT NULL,
  phone             TEXT,
  auth_provider     TEXT NOT NULL CHECK (auth_provider IN ('google', 'local')),
  local_auth_tenant_id UUID,
  is_active         BOOLEAN DEFAULT TRUE,
  UNIQUE (email, auth_provider)
);

-- 4.2  Danh s√°ch tenant
CREATE TABLE tenants (
  tenant_id   UUID PRIMARY KEY,
  tenant_name TEXT NOT NULL,
  status      TEXT NOT NULL CHECK (status IN ('active', 'inactive'))
);

-- 4.3  √Ånh x·∫° user ‚Üî tenant
CREATE TABLE user_tenant_assignments (
  user_id    UUID REFERENCES users_global(user_id),
  tenant_id  UUID REFERENCES tenants(tenant_id),
  assigned_by UUID,
  assigned_at TIMESTAMP,
  PRIMARY KEY (user_id, tenant_id)
);

-- 4.4  Template vai tr√≤ & quy·ªÅn to√†n c·ª•c
CREATE TABLE global_roles_templates (
  template_id  UUID PRIMARY KEY,
  template_code TEXT UNIQUE NOT NULL,
  description  TEXT
);

CREATE TABLE global_permissions_templates (
  template_id     UUID PRIMARY KEY,
  permission_code TEXT UNIQUE NOT NULL,
  action          TEXT NOT NULL,
  resource        TEXT NOT NULL,
  default_condition JSONB   -- PostgreSQL JSONB
);
```

**V√≠ d·ª• quy·ªÅn to√†n c·ª•c**

| permission_code                 | description                       |
| -------------------------------- | --------------------------------- |
| `report.view_login_by_tenant`    | Xem b√°o c√°o ƒëƒÉng nh·∫≠p theo tenant |
| `report.view_financial_summary`  | Xem b√°o c√°o t√†i ch√≠nh t·ªïng h·ª£p    |
| `report.manage_report_templates` | T·∫°o/ c·∫≠p nh·∫≠t template b√°o c√°o    |

---

### üì¶ T·∫°i Sub User Service (m·ªói tenant ‚Äî MariaDB)

```sql
-- +flyway
-- 4.5  Ng∆∞·ªùi d√πng c·ª•c b·ªô (tham chi·∫øu user_id to√†n c·ª•c)
CREATE TABLE users_in_tenant (
  user_id UUID PRIMARY KEY,
  is_active_in_tenant BOOLEAN DEFAULT TRUE
);

-- 4.6  Vai tr√≤ & quy·ªÅn trong tenant
CREATE TABLE roles_in_tenant (
  role_id   UUID PRIMARY KEY,
  role_code TEXT UNIQUE NOT NULL,
  role_name TEXT NOT NULL
);

CREATE TABLE permissions_in_tenant (
  permission_id    UUID PRIMARY KEY,
  permission_code  TEXT UNIQUE NOT NULL,
  action           TEXT NOT NULL,
  resource         TEXT NOT NULL,
  condition        JSON        -- MariaDB JSON
, schema_version   INT  NOT NULL DEFAULT 1 COMMENT 'Event-schema version'
);

-- 4.7  Mapping user ‚Üî role
CREATE TABLE user_role_in_tenant (
  user_id UUID REFERENCES users_in_tenant(user_id),
  role_id UUID REFERENCES roles_in_tenant(role_id),
  PRIMARY KEY (user_id, role_id)
);

-- 4.8  Mapping role ‚Üî permission
CREATE TABLE role_permission_in_tenant (
  role_id       UUID REFERENCES roles_in_tenant(role_id),
  permission_id UUID REFERENCES permissions_in_tenant(permission_id),
  PRIMARY KEY (role_id, permission_id)
);
```

**V√≠ d·ª• quy·ªÅn trong tenant**

| permission_code                | scope  | is_custom | note                                |
| ------------------------------- | ------ | ---------- | ----------------------------------- |
| `report.view_login_by_tenant`   | tenant | false      | K·∫ø th·ª´a t·ª´ Master                   |
| `report.view_financial_summary` | global | false      | Ch·ªâ c·∫•p cho vai tr√≤ qu·∫£n l√Ω         |
| `grade.edit_assignment`         | class  | true       | Quy·ªÅn tu·ª≥ ch·ªânh do Admin tenant t·∫°o |

---

### üìò T√†i li·ªáu chi ti·∫øt

* [`user-service/master/data-model.md`](../services/user-service/master/data-model.md) ‚Äì M√¥ h√¨nh & migration PostgreSQL.
* [`user-service/tenant/data-model.md`](../services/user-service/tenant/data-model.md) ‚Äì M√¥ h√¨nh MariaDB & chi·∫øn l∆∞·ª£c sync Pub/Sub.

> M√¥ h√¨nh n√†y **t√°ch bi·ªát r√µ r√†ng** danh t√≠nh to√†n c·ª•c v·ªõi RBAC c·ª•c b·ªô, ƒë·ªìng th·ªùi h·ªó tr·ª£ **version schema** (c·ªôt `schema_version`) cho h·ªá th·ªëng **Event Schema Governance** (ADR-030).

---

## 5. Permission C√≥ ƒêi·ªÅu Ki·ªán (Conditional Permission)

> **M·ª•c ti√™u** ‚Äì Cho ph√©p **RBAC linh ho·∫°t** d·ª±a tr√™n *ng·ªØ c·∫£nh* (context-aware).  
> Thay v√¨ g√°n quy·ªÅn ‚Äúc·ª©ng‚Äù, m·ªói **permission** c√≥ th·ªÉ ƒë√≠nh k√®m tr∆∞·ªùng `condition` d∆∞·ªõi d·∫°ng **JSON** (`JSONB` tr√™n PostgreSQL Core, `JSON` tr√™n MariaDB Tenant).

### 5.1 C√∫ ph√°p & Context

| Placeholder | Ngu·ªìn d·ªØ li·ªáu | V√≠ d·ª• |
|-------------|--------------|-------|
| `$user.<field>`    | B·∫£n ghi `users_in_tenant` (Sub DB) | `$user.class_id` |
| `$request.<field>` | Body / query-param / header HTTP | `$request.class_id` |
| `$tenant.<field>`  | Metadata c·ªßa tenant (b·∫£ng `tenants`) | `$tenant.tier` |

**To√°n t·ª≠ m·∫∑c ƒë·ªãnh**: _so s√°nh b·∫±ng_ (`==`).  
**To√°n t·ª≠ m·ªü r·ªông** (v2): `$in`, `$contains`, `$gte`, `$lte`.

### 5.2 V√≠ d·ª• ƒëi·ªÅu ki·ªán

| M√¥ t·∫£ | JSON ƒëi·ªÅu ki·ªán | Di·ªÖn gi·∫£i |
|-------|---------------|-----------|
| Ch·ªâ xem l·ªõp c·ªßa ch√≠nh m√¨nh | `{ "class_id": "$user.class_id" }` | `class_id (request)` `==` `class_id (user)` |
| H·∫°n ch·∫ø b√°o c√°o theo kh·ªëi tr∆∞·ªùng | `{ "grade": "$user.grade" }` | So s√°nh `grade` |
| Quy·ªÅn admin tenant cao c·∫•p | `{ "$tenant.tier": "premium" }` | Tenant ph·∫£i ·ªü g√≥i ‚Äúpremium‚Äù |

### 5.3 Lu·ªìng ƒë√°nh gi√° (Evaluation Flow)

```mermaid
flowchart LR
  APIGW(API Gateway) --> CondEval(Condition Engine)
  CondEval -->|read| RedisRBAC[(RBAC cache)]
  CondEval -->|read| RequestCtx[/HTTP Request/]
  CondEval -->|read| JWTClaim[/JWT/]
  CondEval -->|read| TenantMeta[(Tenant metadata)]
```

1. **API Gateway** ƒë√£ x√°c th·ª±c JWT & t·∫£i RBAC cache.
2. **Condition Engine** l·∫∑p qua list permission:

   * N·∫øu `condition == null` ‚áí pass.
   * N·∫øu c√≥ `condition` ‚áí render placeholder ‚Üí so s√°nh.
3. N·∫øu **b·∫•t k·ª≥** permission pass ‚áí request **ƒë∆∞·ª£c ph√©p**.
4. K·∫øt qu·∫£ cache `rbac:{user_id}:{tenant_id}` theo TTL.

### 5.4 K·ªãch b·∫£n quan tr·ªçng

| K·ªãch b·∫£n              | Handling                                                                |
| --------------------- | ----------------------------------------------------------------------- |
| **Token b·ªã thu h·ªìi**  | Gateway tr·∫£ `403` `token.revoked` tr∆∞·ªõc khi evaluate.                   |
| **Placeholder thi·∫øu** | Tr·∫£ `400` `common.validation_failed`.                                   |
| **Type mismatch**     | Tr·∫£ `400`; log detail v√†o Audit-Logging.                                |
| **Condition n·∫∑ng**    | Flag ‚Äúslow condition‚Äù khi eval > 5 ms ‚Äì metric `rbac_cond_latency_p95`. |

### 5.5 Qu·∫£n tr·ªã & Template

* **Template quy·ªÅn** (level Master) l∆∞u ·ªü `global_permissions_templates.default_condition`.
* Tenant **override** b·∫±ng c√°ch vi·∫øt `condition` m·ªõi trong `permissions_in_tenant`.
* Report-related permission (`report.*`) ƒëi k√®m `data_scope` (ADR-029).

> **L∆∞u √Ω b·∫£o m·∫≠t**
>
> * Kh√¥ng cho ph√©p placeholder **t·ª± do**; ch·ªâ whitelist `$user`, `$request`, `$tenant`.
> * ƒê·ªëi v·ªõi d·ªØ li·ªáu nh·∫°y c·∫£m (PII), placeholder ph·∫£i **·∫©n danh** (hash) tr∆∞·ªõc khi so s√°nh.

---

## 6. Chi·∫øn l∆∞·ª£c Cache RBAC t·∫°i API Gateway

> **M·ª•c ti√™u** ‚Äì Gi·∫£m ƒë·ªô tr·ªÖ u·ª∑ quy·ªÅn v√† t·∫£i truy v·∫•n RBAC, nh∆∞ng v·∫´n b·∫£o ƒë·∫£m c·∫≠p nh·∫≠t t·ª©c th·ªùi khi quy·ªÅn thay ƒë·ªïi ho·∫∑c token b·ªã thu h·ªìi.

### 6.1 C∆° ch·∫ø t·ªïng quan  
1. **Gateway** x√°c th·ª±c ch·ªØ k√Ω JWT **offline** b·∫±ng **JWKS** (cache 10 ‚Ä≤).  
2. Tr∆∞·ªõc khi ƒë√°nh gi√° RBAC, Gateway:  
   1. Ki·ªÉm tra kho√° **`revoked:{jti}`** trong Redis (TTL 15 ‚Ä≤).  
   2. N·∫øu *miss* cache RBAC (`rbac:{user_id}:{tenant_id}`) ‚Üí g·ªçi **Sub User Service** n·∫°p l·∫°i.  
3. Quy·ªÅn m·ªõi / thu h·ªìi token ƒë∆∞·ª£c **ƒë·∫©y s·ª± ki·ªán** qua Pub/Sub ƒë·ªÉ Gateway t·ª± xo√° cache.

### 6.2 C·∫•u tr√∫c cache

#### üîë **Key**

```text
rbac:{user_id}:{tenant_id}
```

#### üì¶ **Value**

```json
{
  "roles": ["teacher"],
  "permissions": ["grade.edit_assignment", "report.view_login_by_tenant"],
  "issued_at": "2025-07-01T12:00:00Z"
}
```

#### ‚è± **TTL & L√†m m·ªõi**

| TTL            | M·ª©c √°p d·ª•ng                                         | Ghi ch√∫                    |
| -------------- | --------------------------------------------------- | -------------------------- |
| **10 ph√∫t**    | Core services (Gateway ‚Üí Master)                    | Gi√° tr·ªã m·∫∑c ƒë·ªãnh           |
| **5‚Äì15 ph√∫t**  | Tenant stack (Gateway ‚Üí Sub)                        | ƒêi·ªÅu ch·ªânh theo t·∫£i tenant |
| **Invalidate** | Khi JWT m·ªõi c√≥ RBAC m·ªõi *ho·∫∑c* event `rbac_updated` | T·ª©c th·ªùi xo√° cache         |

### 6.3 Ki·ªÉm tra token b·ªã thu h·ªìi (revoked)

* **Redis key** `revoked:{jti}` (TTL 15 ‚Ä≤) ‚Äì **Token Service** ƒë·ªìng b·ªô ngay sau `/token/revoke`.

* Gateway tra key tr∆∞·ªõc khi ƒë√°nh gi√° RBAC:

  ```json
  403
  {
    "error": { "code": "token.revoked", "message": "Token ƒë√£ b·ªã thu h·ªìi" },
    "meta": { "trace_id": "‚Ä¶", "service": "api_gateway", "timestamp": "‚Ä¶" }
  }
  ```

* N·∫øu **cache-miss**, Gateway g·ªçi `POST /token/introspect` ƒë·ªÉ x√°c minh.

* **Metric gi√°m s√°t**

  * `revoked_token_cache_hit_ratio` ‚â• 98 % ‚Äì alert < 90 % 10‚Ä≤.
  * `rbac_cache_latency_p95` < 5 ms.

### 6.4 Invalidation qua Pub/Sub

| S·ª± ki·ªán               | N∆°i ph√°t          | H√†nh ƒë·ªông Gateway                          |
| --------------------- | ----------------- | ------------------------------------------ |
| `rbac_updated`        | Sub User Service  | Xo√° `rbac:{user_id}:{tenant_id}`           |
| `token.revoked`       | Token Service     | Xo√° `revoked:{jti}` & cache RBAC li√™n quan |
| `user_status_changed` | User Master / Sub | V√¥ hi·ªáu ho√° JWT & cache RBAC               |

### 6.5 Quy t·∫Øc ƒë·∫∑c bi·ªát cho b√°o c√°o

* C√°c permission `report.*` th∆∞·ªùng ƒë∆∞·ª£c ƒë√°nh gi√° t·∫°i Gateway khi **Superadmin Webapp** g·ªçi **Reporting Service**.
* N·∫øu permission c√≥ `condition`, **Condition Engine** so kh·ªõp `input_parameters` v·ªõi context ng∆∞·ªùi d√πng. (Xem m·ª•c 5).

üìò *ƒê·ªãnh nghƒ©a schema s·ª± ki·ªán*: [`rbac-events.md`](./rbac-events.md)

---

## 7. Chi·∫øn l∆∞·ª£c ƒê·ªìng b·ªô RBAC

> **M·ª•c ti√™u** ‚Äì Cho ph√©p tenant **k·∫ø th·ª´a** RBAC chu·∫©n, **tu·ª≥ ch·ªânh** khi c·∫ßn, nh∆∞ng v·∫´n gi·ªØ **t√≠nh nh·∫•t qu√°n & d·ªÖ quan s√°t**. C∆° ch·∫ø ƒë·ªìng b·ªô d·ª±a tr√™n **Pub/Sub** v√† **schema versioning** (ADR-030).

### 7.1 K·∫ø th·ª´a & T√πy ch·ªânh

| H√†nh ƒë·ªông | API / S·ª± ki·ªán | K·∫øt qu·∫£ |
|-----------|---------------|---------|
| **Import template** | `POST /rbac/templates/import` | Tenant l·∫•y b·∫£n *snapshot* Role/Permission t·ª´ Master (version hi·ªán t·∫°i). |
| **Clone template** | `POST /rbac/templates/clone` | T·∫°o b·∫£n sao (`schema_version` k·∫ø th·ª´a) ‚Üí s·ª≠a `role_name`, `condition`. |
| **T·∫°o m·ªõi** | `POST /rbac/templates` | B·∫£n tr·∫Øng ho√†n to√†n, version m·∫∑c ƒë·ªãnh **1**. |
| **Sync ƒë·ªãnh k·ª≥** | Cron-option (`weekly`, `monthly`) | Ch·ªâ √°p d·ª•ng **template ch∆∞a clone**; diff ‚Üí update t·ª± ƒë·ªông. |

> *Tenant clone = m·∫•t ƒë∆∞·ªùng sync; ph·∫£i c·∫≠p nh·∫≠t th·ªß c√¥ng n·∫øu Master ƒë·ªïi.*

### 7.2 G√°n Role cho Ng∆∞·ªùi d√πng

* API **Sub User Service** (ƒë∆∞·ª£c Admin Portal s·ª≠ d·ª•ng):  
  * `PUT /users/{id}/roles` ‚Äì g√°n ho·∫∑c g·ª° `role_id`.  
  * `PATCH /users/{id}` ‚Äì c·∫≠p nh·∫≠t `is_active_in_tenant`.  
  * `POST /roles` ‚Äì t·∫°o role tu·ª≥ ch·ªânh (y√™u c·∫ßu permission `rbac.manage_role`).  
* M·ªói thao t√°c xu·∫•t s·ª± ki·ªán **`rbac_updated`** (payload c√≥ `schema_version`).

### 7.3 ƒê·ªìng b·ªô & Invalidate (Pub/Sub)

```mermaid
flowchart LR
  RBT(üì• rbac_updated) -- publish --> Bus((Pub/Sub))
  Bus -- fan-out --> GW(API Gateway)
  Bus -- fan-out --> Audit(Audit-Logging)
  GW -- purge --> RedisRBAC[("rbac:{user_id}:{tid}")]
```

| S·ª± ki·ªán                   | Ph√°t t·ª´           | H√†nh ƒë·ªông Gateway             |
| ------------------------- | ----------------- | ----------------------------- |
| `rbac_updated.v1`         | Sub User Service  | Xo√° cache RBAC li√™n quan      |
| `rbac_template_cloned.v1` | Tenant Admin      | Ch·ªâ ghi log, kh√¥ng t·ª± sync    |
| `rbac_template_synced.v1` | Job Master‚ÜíTenant | C·∫≠p nh·∫≠t `schema_version` m·ªõi |

### 7.4 Versioning & Conflict

* M·ªói b·∫£n ghi **role / permission** c√≥ `schema_version`.
* Khi Master n√¢ng version, pipeline `template_sync` g·ª≠i diff; n·∫øu b·∫£n tenant ƒë√£ clone ‚Üí c·∫£nh b√°o ‚Äú*forked template*‚Äù.
* ƒêi·ªÅu ki·ªán **conflict**: `permission_code` tr√πng nh∆∞ng version kh√°c ‚Üí job flag `status=conflict`, y√™u c·∫ßu Admin tenant r√† so√°t.

### 7.5 ƒê·ªìng b·ªô ƒë·ªãnh k·ª≥ (t√πy ch·ªçn)

* Tenant ch·ªçn trong **Settings ‚Üí RBAC Sync**: `off` / `weekly` / `monthly`.
* Job **Cloud Scheduler + Cloud Run** g·ªçi `POST /templates/sync` ‚Üí Master t√≠nh diff ‚Üí ph√°t `rbac_template_synced.v1`.

### 7.6 KPI & Monitoring

| Metric                   | M·ª•c ti√™u                | Alert               |
| ------------------------ | ----------------------- | ------------------- |
| `rbac_sync_success_rate` | = 100 %                 | b·∫•t k·ª≥ failure      |
| `rbac_conflict_count`    | = 0                     | > 0 t·∫°o Jira ticket |
| `rbac_template_age_days` | < 30 ng√†y (sync weekly) | > 45 ng√†y           |

üìò **Schema s·ª± ki·ªán chi ti·∫øt** xem [`rbac-events.md`](./rbac-events.md).

---

## 8. Hi·ªáu nƒÉng & Kh·∫£ nƒÉng m·ªü r·ªông

H·ªá th·ªëng RBAC c·ªßa **dx-vas** ph·∫£i ph·ª•c v·ª• **200+ tenant** v·ªõi h√†ng ng√†n ng∆∞·ªùi d√πng/tenant, ƒë·ªìng th·ªùi gi·ªØ **p95 latency < 5 ms** cho b∆∞·ªõc u·ª∑ quy·ªÅn t·∫°i API Gateway.

### 8.1 K·ªπ thu·∫≠t t·ªëi ∆∞u

| K·ªπ thu·∫≠t | M√¥ t·∫£ | L·ª£i √≠ch |
|----------|-------|---------|
| **Gateway RBAC cache** | L∆∞u `rbac:{user_id}:{tenant_id}` 5‚Äì15 ph√∫t | Tr√°nh round-trip Sub Service ‚Üí gi·∫£m ~2 ms / request |
| **Redis revoked-token cache** | Key `revoked:{jti}` TTL 15‚Ä≤ | Ki·ªÉm tra thu h·ªìi token c·ª•c b·ªô, kh√¥ng g·ªçi `/token/introspect` |
| **Pub/Sub Fan-out invalidate** | S·ª± ki·ªán `rbac_updated`, `token.revoked` ‚Üí Gateway xo√° cache | C·∫≠p nh·∫≠t g·∫ßn-real-time (< 1 s) |
| **Condition Engine JSON(B)** | So s√°nh `$user`, `$request`, `$tenant` t·∫°i Gateway | RBAC linh ho·∫°t, kh√¥ng b√πng n·ªï b·∫£ng Permission |
| **Batch API** | `POST /users/roles:batchAssign` | Gi·∫£m s·ªë k·∫øt n·ªëi DB / network |

### 8.2 Quy m√¥ Cloud (Cloud-Scale)

* **Redis Cluster** 3-node, **namespace theo `tenant_id`** ‚Üí h·∫°n ch·∫ø kho√° n√≥ng, b·∫£o v·ªá tenant kh√°c.  
* **Sub User Service** autoscale HPA (CPU + RPS) ‚Üí tenant b·∫≠n kh√¥ng ·∫£nh h∆∞·ªüng tenant r·∫£nh.  
* **Message Bus** Pub/Sub topic `tenant.*` chia *partition* = tenant ‚Üí b·∫£o ƒë·∫£m th·ª© t·ª± trong tenant.  
* **Data Model** `roles_in_tenant` & `permissions_in_tenant` shard theo `tenant_id` ‚Üí ch·ªâ qu√©t ph·∫°m vi nh·ªè.

### 8.3 Monitoring & Alerting

| Metric | M·ª•c ti√™u | Alert |
|--------|----------|-------|
| `rbac_cache_hit_ratio` | ‚â• 98 % | < 95 % trong 10‚Ä≤ |
| `revoked_token_cache_hit_ratio` | ‚â• 95 % | < 90 % trong 10‚Ä≤ |
| `rbac_cond_latency_p95` | < 5 ms | > 10 ms trong 5‚Ä≤ |
| `rbac_conflict_count` | = 0 | b·∫•t k·ª≥ > 0 |
| `user_roles_count_p99` | < 50 | user > 100 role ‚Üí Jira ticket |

_Log sample _:

```json
{
  "tenant_id": "tenant-abc",
  "user_id": "u-123",
  "cache_hit": true,
  "cache_type": "rbac",
  "latency_ms": 1.8,
  "trace_id": "trace-xyz"
}
```

### 8.4 ƒê·ªãnh h∆∞·ªõng t·ªëi ∆∞u ti·∫øp theo

* **JWT-signed RBAC claims** (‚Äúembedded RBAC‚Äù) ‚Üí TTL 2 ‚Ä≤ + checksum, gi·∫£m truy v·∫•n Redis ·ªü m·ª©c c·ª±c l·ªõn.
* **Edge-Cache (CDN) JWKS** gi·∫£m th·ªùi gian t·∫£i key ·ªü v√πng xa.
* **Adaptive TTL** ‚Äì Gateway k√©o d√†i TTL cho user √≠t thay ƒë·ªïi, r√∫t ng·∫Øn cho admin thao t√°c nhi·ªÅu quy·ªÅn.

> **K·∫øt qu·∫£ mong ƒë·ª£i:** V·ªõi c√°c k·ªπ thu·∫≠t tr√™n, dx-vas gi·ªØ ƒë∆∞·ª£c hi·ªáu nƒÉng ·ªïn ƒë·ªãnh khi m·ªü r·ªông tenant m·ªõi, ƒë·ªìng th·ªùi b·∫£o ƒë·∫£m vi·ªác thu h·ªìi quy·ªÅn/token di·ªÖn ra trong v√†i gi√¢y ‚Äì kh√¥ng ·∫£nh h∆∞·ªüng tr·∫£i nghi·ªám ng∆∞·ªùi d√πng.

---

## 9. B·∫£o m·∫≠t chuy√™n s√¢u trong RBAC

RBAC l√† l·ªõp ki·ªÉm so√°t truy c·∫≠p tr·ªçng y·∫øu, n√™n c√°c nguy√™n t·∫Øc b·∫£o m·∫≠t sau ƒë∆∞·ª£c √°p d·ª•ng nghi√™m ng·∫∑t trong h·ªá th·ªëng dx-vas:

### üîê Isolation theo Tenant
- M·ªói Sub User Service ch·ªâ truy xu·∫•t d·ªØ li·ªáu ng∆∞·ªùi d√πng v√† role/permission c·ªßa ch√≠nh tenant ƒë√≥
- Kh√¥ng c√≥ API cho ph√©p thao t√°c ch√©o tenant

### üîê T√™n ƒë·ªãnh danh v√† kh√¥ng gian RBAC
- C√°c vai tr√≤ (`role_code`) v√† quy·ªÅn (`permission_code`) ph·∫£i l√† duy nh·∫•t **trong ph·∫°m vi tenant**
- Kh√¥ng cho ph√©p ‚Äúshadow‚Äù vai tr√≤ t·ª´ tenant kh√°c

### üîê Ch·ªëng gi·∫£ m·∫°o JWT
- JWT ƒë∆∞·ª£c k√Ω RS256 b·ªüi **Token Service**; Gateway x√°c th·ª±c *offline* qua **JWKS** cache 10‚Ä≤.  
- Gateway th√™m b∆∞·ªõc ‚Äúcheck revoked‚Äù (Redis) tr∆∞·ªõc khi ƒë√°nh gi√° RBAC.

### üîê API RBAC lu√¥n b·∫£o v·ªá b·ªüi Auth + Role
- M·ªçi thao t√°c g√°n quy·ªÅn, g√°n vai tr√≤, c·∫≠p nh·∫≠t ph·∫£i c√≥ quy·ªÅn c·ª• th·ªÉ (`manage_rbac`, `assign_role`, v.v.)

---

## 10. Gi√°m s√°t & G·ª° l·ªói

ƒê·ªÉ h·ªó tr·ª£ v·∫≠n h√†nh v√† b·∫£o m·∫≠t, c√°c h√†nh ƒë·ªông li√™n quan ƒë·∫øn RBAC ƒë∆∞·ª£c log v√† theo d√µi chi ti·∫øt:

### ü™µ Audit Trail
- M·ªói h√†nh ƒë·ªông:
  - G√°n vai tr√≤
  - T·∫°o permission
  - C·∫≠p nh·∫≠t condition
- ƒê∆∞·ª£c log k√®m:
  - `user_id`, `actor_id`, `tenant_id`, `timestamp`, `payload_before`, `payload_after`
- C√°c h√†nh vi truy c·∫≠p b√°o c√°o (truy v·∫•n, export, xem c·∫•u h√¨nh) ƒë∆∞·ª£c log v√†o **Audit Logging Stack** ƒë·ªÉ h·ªó tr·ª£ b·∫£o m·∫≠t v√† ph√¢n t√≠ch h√†nh vi.
- Vi·ªác log n√†y tu√¢n th·ªß ƒë·ªãnh d·∫°ng `ADR-008` v√† c√≥ th·ªÉ ƒë∆∞·ª£c d√πng ƒë·ªÉ sinh c√°c b√°o c√°o ph√¢n quy·ªÅn v√† audit s·ª≠ d·ª•ng h·ªá th·ªëng b√°o c√°o.

### üß™ Debug Flow t·∫°i Gateway
- G·∫Øn `X-RBAC-Trace-ID` v√†o m·ªói request n·∫øu b·∫≠t debug
- Log c√°c b∆∞·ªõc ƒë√°nh gi√°: permission match, condition eval, cache hit/miss
- C√≥ th·ªÉ b·∫≠t ch·∫ø ƒë·ªô ‚Äúdry-run‚Äù RBAC tr√™n staging ƒë·ªÉ ki·ªÉm tra rule m·ªõi

### üìà Metrics
- S·ªë l∆∞·ª£ng permission theo tenant
- T·ª∑ l·ªá cache hit/miss RBAC
- C·∫£nh b√°o n·∫øu user c√≥ s·ªë role v∆∞·ª£t ng∆∞·ª°ng
- `revoked_token_cache_hit_ratio`

---

## 11. Best Practices cho Qu·∫£n tr·ªã RBAC

M·ªôt s·ªë khuy·∫øn ngh·ªã ƒë∆∞·ª£c √°p d·ª•ng v√† ki·ªÉm so√°t qua Superadmin Webapp ho·∫∑c Admin Webapp t·∫°i tenant:

- ‚úÖ ƒê·∫∑t t√™n `role_code`, `permission_code` r√µ r√†ng, snake_case
- ‚úÖ T√°ch vai tr√≤ theo domain ch·ª©c nƒÉng: `academic_staff`, `finance_admin`, `class_teacher`
- ‚úÖ Gi·ªõi h·∫°n s·ªë vai tr√≤/user ‚â§ 10 ƒë·ªÉ d·ªÖ ki·ªÉm so√°t
- ‚úÖ ∆Øu ti√™n d√πng permission c√≥ `condition` h∆°n l√† t·∫°o th√™m role m·ªõi
- ‚úÖ D√πng template n·∫øu tenant kh√¥ng c√≥ nhu c·∫ßu tu·ª≥ ch·ªânh
- ‚ùå Kh√¥ng cho ph√©p s·ª≠a `role_code` sau khi g√°n cho user
- ‚ùå Kh√¥ng c·∫•p quy·ªÅn `manage_rbac` ƒë·∫°i tr√† ‚Äì n√™n g√°n cho 1‚Äì2 ng∆∞·ªùi c√≥ tr√°ch nhi·ªám
- üîí **Ph√¢n quy·ªÅn truy c·∫≠p b√°o c√°o k·ªπ l∆∞·ª°ng:** C√°c permission d·∫°ng `report.view_*` n√™n ƒë∆∞·ª£c g√°n r√µ r√†ng theo vai tr√≤, gi·ªõi h·∫°n theo scope (`tenant` ho·∫∑c `global`). Nh·ªØng quy·ªÅn nh∆∞ `report.manage_report_templates` n√™n **ch·ªâ c·∫•p cho Superadmin ho·∫∑c roles ƒë·∫∑c bi·ªát**, ƒë·ªÉ tr√°nh nguy c∆° r√≤ r·ªâ th√¥ng tin ho·∫∑c truy v·∫•n nh·∫°y c·∫£m.

---

## 12. C√¥ng c·ª• & T√†i li·ªáu li√™n quan

üìò T√†i li·ªáu k·ªπ thu·∫≠t chi ti·∫øt li√™n quan ƒë·∫øn RBAC:

| M·ª•c | File |
|-----|------|
| Ki·∫øn tr√∫c t·ªïng quan RBAC | [`README.md`](../README.md) |
| M√¥ h√¨nh d·ªØ li·ªáu User Master | [`user-service/master/data-model.md`](../services/user-service/master/data-model.md) |
| M√¥ h√¨nh d·ªØ li·ªáu Sub User Service | [`user-service/tenant/data-model.md`](../services/user-service/tenant/data-model.md) |
| Giao di·ªán qu·∫£n tr·ªã RBAC | [`ic-02-admin-webapp.md`](../interfaces/ic-02-admin-webapp.md) |
| Ki·ªÉm so√°t x√°c th·ª±c & JWT | [`adr-006-auth-strategy.md`](../ADR/adr-006-auth-strategy.md) |
| Quy t·∫Øc ƒëi·ªÅu ki·ªán & JSONB | [`rbac-condition-schema.md`](./rbac-condition-schema.md) |
| S·ª± ki·ªán RBAC & Cache Invalidation | [`rbac-events.md`](./rbac-events.md) |
| Danh s√°ch role m·∫´u to√†n h·ªá th·ªëng | [`global-roles-template.yaml`](../templates/global-roles-template.yaml) |

---

### üîç S∆° ƒë·ªì RBAC Ph√¢n t·∫ßng ‚Äì User Master v√† Sub User Services

```mermaid
flowchart TD

  subgraph Master["User Service Master"]
    UGM[users_global]
    TENTS[tenants]
    UTA[user_tenant_assignments]
    GRT[global_roles_templates]
    GPT[global_permissions_templates]
  end

  subgraph Tenant_A["Sub User Service ‚Äì Tenant A"]
    UTA1[users_in_tenant]
    RA1[roles_in_tenant]
    PA1[permissions_in_tenant]
    URA1[user_role_in_tenant]
    RPA1[role_permission_in_tenant]
  end

  subgraph Tenant_B["Sub User Service ‚Äì Tenant B"]
    UTA2[users_in_tenant]
    RA2[roles_in_tenant]
    PA2[permissions_in_tenant]
    URA2[user_role_in_tenant]
    RPA2[role_permission_in_tenant]
  end

  %% Mapping
  UGM --> UTA
  TENTS --> UTA
  UGM --> UTA1
  UGM --> UTA2

  GRT --> RA1
  GRT --> RA2
  GPT --> PA1
  GPT --> PA2

  UTA1 --> URA1
  RA1 --> URA1
  RA1 --> RPA1
  PA1 --> RPA1

  UTA2 --> URA2
  RA2 --> URA2
  RA2 --> RPA2
  PA2 --> RPA2
```

üìå **Gi·∫£i th√≠ch:**

* `users_global` l√† ngu·ªìn ƒë·ªãnh danh chung, d√πng cho t·∫•t c·∫£ c√°c tenant.
* M·ªói tenant c√≥ Sub User Service qu·∫£n l√Ω ri√™ng:

  * `users_in_tenant` √°nh x·∫° t·ªõi `user_id_global`
  * Vai tr√≤ & quy·ªÅn c·ª•c b·ªô, c√≥ th·ªÉ k·∫ø th·ª´a t·ª´ Master ho·∫∑c t·ª± ƒë·ªãnh nghƒ©a
* Mapping RBAC (`user ‚Üî role ‚Üî permission`) l√† ƒë·ªôc l·∫≠p gi·ªØa c√°c tenant.

üìò S∆° ƒë·ªì n√†y gi√∫p Superadmin, DevOps v√† Dev hi·ªÉu r√µ lu·ªìng ph√¢n quy·ªÅn, v·ªã tr√≠ source of truth, v√† c√°ch t√°ch bi·ªát b·∫£o m·∫≠t gi·ªØa c√°c tenant.

---

### üîê S∆° ƒë·ªì Lu·ªìng Ki·ªÉm tra RBAC t·∫°i API Gateway

```mermaid
sequenceDiagram
    autonumber
    participant Client as üåê Client (Frontend)
    participant Gateway as üõ°Ô∏è API Gateway
    participant Auth as üîê Auth Service (Master/Sub)
    participant JWT as üì¶ JWT Token
    participant Redis as ‚ö° RBAC Cache
    participant SubUser as üß© Sub User Service (per tenant)

    Client->>Auth: ƒêƒÉng nh·∫≠p (OAuth2 / OTP)
    Auth->>JWT: Ph√°t h√†nh JWT ch·ª©a<br>user_id, tenant_id, roles, permissions
    Client->>Gateway: G·ª≠i request k√®m JWT

    Gateway->>JWT: Gi·∫£i m√£ JWT
    Gateway->>JWT: L·∫•y user_id, tenant_id, permissions
    alt Cache Hit
        Gateway->>Redis: L·∫•y RBAC t·ª´ cache<br>rbac:{user_id}:{tenant_id}
    else Cache Miss
        Gateway->>SubUser: G·ªçi API ƒë·ªÉ l·∫•y roles & permissions
        SubUser-->>Gateway: Tr·∫£ v·ªÅ roles, permissions
        Gateway->>Redis: Ghi cache RBAC
    end

    alt C√≥ permission kh·ªõp + ƒëi·ªÅu ki·ªán ƒë√∫ng
        Gateway-->>Client: ‚úÖ 200 OK (forward t·ªõi backend)
    else Kh√¥ng c√≥ quy·ªÅn / Sai ƒëi·ªÅu ki·ªán
        Gateway-->>Client: ‚ùå 403 Forbidden
    end
```

üìå **Gi·∫£i th√≠ch nhanh:**

* Gateway l√† n∆°i trung t√¢m ƒë√°nh gi√° quy·ªÅn d·ª±a tr√™n JWT v√† RBAC.
* D√πng cache Redis ƒë·ªÉ tr√°nh g·ªçi Sub User Service qu√° th∆∞·ªùng xuy√™n.
* H·ªó tr·ª£ `condition JSONB` ƒë∆∞·ª£c ƒë√°nh gi√° t·∫°i Gateway b·∫±ng context t·ª´ JWT v√† request.

üìò RBAC cache invalidation ƒë∆∞·ª£c ƒëi·ªÅu ph·ªëi b·ªüi Pub/Sub events t·ª´ Sub User Service nh∆∞ `rbac_updated` ho·∫∑c `user_status_changed`.

---

### üîë S∆° ƒë·ªì Lu·ªìng Ph√°t h√†nh JWT ƒêa-Tenant

```mermaid
sequenceDiagram
    autonumber
    participant FE as üåê Frontend
    participant AuthM as üîê Auth Master
    participant AuthT as üîê Auth Sub
    participant Captcha as üõ°Ô∏è reCAPTCHA
    participant TokenSvc as üóùÔ∏è Token Service
    participant UserSub as üß© User Sub (tenant)
    participant JWT as üì¶ JWT

    rect rgba(220,220,220,0.05)
        FE->>AuthM: Login Google
        AuthM->>UserSub: GET roles/permissions
        AuthM->>TokenSvc: POST /token/issue
        TokenSvc-->>AuthM: JWT (RS256)
        AuthM-->>FE: Return JWT
    end

    rect rgba(220,220,220,0.05)
        FE->>AuthT: Login OTP
        AuthT-->>Captcha: verify CAPTCHA
        Captcha-->>AuthT: OK / Fail
        AuthT->>UserSub: GET RBAC
        AuthT->>TokenSvc: POST /token/issue
        TokenSvc-->>AuthT: JWT (RS256)
        AuthT-->>FE: Return JWT
    end
```

üìå **ƒêi·ªÉm ch√≠nh:**

* Auth Master x·ª≠ l√Ω Google OAuth2 + l·ª±a ch·ªçn tenant.
* Sub Auth x·ª≠ l√Ω x√°c th·ª±c Local/OTP t·∫°i tenant.
* M·ªçi JWT ph√°t ra ƒë·ªÅu ch·ª©a `user_id_global`, `tenant_id`, `roles`, `permissions`, `jti`, `sid` ‚Äì ph·ª•c v·ª• thu h·ªìi token & qu·∫£n l√Ω phi√™n (See CR-03).

üìò Tham kh·∫£o chi ti·∫øt c·∫•u tr√∫c JWT trong [`adr-006-auth-strategy.md`](../ADR/adr-006-auth-strategy.md)
