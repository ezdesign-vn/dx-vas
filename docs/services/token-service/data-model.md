---
title: "Token Service - Data Model"
version: "1.0"
last_updated: "2025-06-09"
author: "DX VAS Team"
reviewed_by: "Stephen Le"
---

# üóÉÔ∏è Token Service - Data Model

<!-- toc -->

> **Token Service** l√† th√†nh ph·∫ßn trung t√¢m trong ki·∫øn tr√∫c DX-VAS, ch·ªãu tr√°ch nhi·ªám qu·∫£n l√Ω c√°c d·ªØ li·ªáu sau:
> - **JWKS keys** (`jwks_keys`) ‚Äì l∆∞u metadata key ƒë·ªÉ API Gateway x√°c th·ª±c JWT offline (RS256) theo ADR-006.  
> - **Auth sessions** (`auth_sessions`) ‚Äì session_id, user_id, tenant_id, TTL refresh token.  
> - **Revoked tokens** (`revoked_tokens`) ‚Äì jti, tenant_id, revoked_at, reason (CR-03).  
> - **Token stats** (`token_stats`) ‚Äì latency, ip_address, device, ch·ªâ khi `enable_token_stats=true`.  

---

## 1. Ph·∫°m vi D·ªØ li·ªáu Qu·∫£n l√Ω (Scope)

**Token Service** qu·∫£n l√Ω d·ªØ li·ªáu li√™n quan ƒë·∫øn lu·ªìng ph√°t h√†nh, thu h·ªìi v√† introspect JWT, bao g·ªìm:
- C·∫•u h√¨nh v√† metadata JWKS.
- L·ªãch s·ª≠ phi√™n (session) cho refresh token.
- Danh s√°ch token ƒë√£ b·ªã thu h·ªìi ƒë·ªÉ ch·∫∑n offline.
- Th·ªëng k√™ (tu·ª≥ ch·ªçn) cho m·ªói token (latency, IP, v.v.).

## 2. Ngo√†i Ph·∫°m Vi (Out of Scope)

**Token Service** **kh√¥ng** qu·∫£n l√Ω:
- ‚ùå Th√¥ng tin ng∆∞·ªùi d√πng / role / permission (thu·ªôc User Service).  
- ‚ùå D·ªØ li·ªáu SMS / Email (thu·ªôc Notification Service).  
- ‚ùå L·ªãch s·ª≠ audit chi ti·∫øt ngo√†i c√°c s·ª± ki·ªán token.*.v1 (ƒë√£ publish Pub/Sub).

## 3. M·ª•c ti√™u c·ªßa T√†i li·ªáu M√¥ h√¨nh D·ªØ li·ªáu

- M√¥ t·∫£ chi ti·∫øt c·∫•u tr√∫c b·∫£ng ph·ª•c v·ª• Issuance, Revocation, Introspection.  
- Th·ªÉ hi·ªán r√µ r√†ng r√†ng bu·ªôc PK/FK, index, ENUM (n·∫øu c√≥).  
- ƒê·∫£m b·∫£o tu√¢n th·ªß c√°c ADR quan tr·ªçng:  
  - ADR-023 (Schema Migration Strategy)  
  - ADR-024 (Data Anonymization & Retention)  
  - ADR-026 (Hard Delete Policy)  

---

## 4. S∆° ƒë·ªì ERD (Entity Relationship Diagram)

**S∆° ƒë·ªì s∆° b·ªô**

```mermaid
erDiagram
  jwks_keys {
    UUID kid PK
    JSON public_key
    BOOLEAN active
    TIMESTAMPTZ created_at
    TIMESTAMPTZ rotated_at
  }
  auth_sessions {
    UUID session_id PK
    UUID user_id
    TEXT tenant_id
    TIMESTAMPTZ created_at
    TIMESTAMPTZ last_active_at
  }
  revoked_tokens {
    UUID jti PK
    TEXT tenant_id
    TIMESTAMPTZ revoked_at
    TEXT reason
    UUID revoked_by
  }
  token_stats {
    UUID stat_id PK
    UUID jti FK
    INTEGER latency_ms
    TEXT ip_address
    JSON device_info
    TIMESTAMPTZ recorded_at
  }

  jwks_keys ||--o{ auth_sessions : "signs sessions"
  auth_sessions ||--o{ revoked_tokens : "may be revoked"
  revoked_tokens ||--o| token_stats : "0..1 stats"
```

> **Ch√∫ th√≠ch:**
>
> * `revoked_tokens ‚Üí token_stats` l√† quan h·ªá 1-to-0..1 (m·ªôt revoke c√≥ th·ªÉ kh√¥ng c√≥ stat).
> * `jwks_keys.active` ch·ªâ one-hot active key; c√°c key c≈© gi·ªØ ƒë·ªÉ verify until TTL.


**S∆° ƒë·ªì ERD chi ti·∫øt**

```mermaid
erDiagram
  jwks_keys {
    UUID    kid PK              "Key ID"
    JSONB   public_key NOT_NULL JWK public key
    BOOLEAN active DEFAULT FALSE
    TIMESTAMPTZ created_at NOT_NULL DEFAULT now()
    TIMESTAMPTZ rotated_at NOT_NULL
  }
  auth_sessions {
    UUID        session_id PK           "Session ID (refresh token)"
    UUID        user_id NOT_NULL        Global user_id
    TEXT        tenant_id NOT_NULL      "Tenant context"
    TIMESTAMPTZ created_at NOT_NULL DEFAULT now()
    TIMESTAMPTZ last_active_at DEFAULT now() NOT_NULL
  }
  revoked_tokens {
    UUID        jti PK                  "JWT ID"
    TEXT        tenant_id NOT_NULL
    TIMESTAMPTZ revoked_at NOT_NULL DEFAULT now()
    TEXT        reason
    UUID        revoked_by
  }
  token_stats {
    UUID    stat_id PK                  "Stats record ID"
    UUID    jti FK NOT_NULL             References "revoked_tokens.jti"
    INT     latency_ms NOT_NULL
    TEXT    ip_address
    JSONB   device_info
    TIMESTAMPTZ recorded_at NOT_NULL DEFAULT now()
  }

  jwks_keys   ||--o{ auth_sessions   : "signs sessions"
  auth_sessions ||--o{ revoked_tokens  : "may be revoked"
  revoked_tokens ||--o| token_stats    : "0..1 stats"
```

> **Ch√∫ th√≠ch & Best Practices**
>
> * **Cardinality**
>
>   * `jwks_keys (1) ‚Üí auth_sessions (0..*)` ‚Äì m·ªôt key c√≥ th·ªÉ sign nhi·ªÅu phi√™n.
>   * `auth_sessions (1) ‚Üí revoked_tokens (0..*)` ‚Äì kh√¥ng ph·∫£i m·ªçi session ƒë·ªÅu b·ªã revoke.
>   * `revoked_tokens (1) ‚Üí token_stats (0..1)` ‚Äì stats ch·ªâ sinh khi `enable_token_stats=true`.
> * **Indexes**
>
>   * `jwks_keys(active)` for fast lookup of current key.
>   * `auth_sessions(user_id, tenant_id)` for session validation.
>   * `revoked_tokens(tenant_id)` ƒë·ªÉ Gateway check revoked nhanh.
> * **Retention & Delete**
>
>   * `jwks_keys`: gi·ªØ 30 ng√†y sau rotation ‚Üí Cron purge (ADR-024/026).
>   * `revoked_tokens`: TTL 30d ‚Üí auto-purge (ADR-024/026).
>   * `token_stats`: TTL 90d ‚Üí anonymize & delete (ADR-024).

---

## 5. Chi ti·∫øt T·ª´ng B·∫£ng

### 5.1 B·∫£ng `jwks_keys`

```sql
CREATE TABLE jwks_keys (
  kid UUID PRIMARY KEY,
  public_key JSONB NOT NULL,
  active BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  rotated_at TIMESTAMPTZ
);
```

| C·ªôt          | Ki·ªÉu d·ªØ li·ªáu  | R√†ng bu·ªôc     | Default | M√¥ t·∫£                              |
| ------------ | ------------- | ------------- | ------- | ---------------------------------- |
| `kid`        | `UUID`        | `PRIMARY KEY` |         | Key ID, kh·ªõp JWT header `kid`      |
| `public_key` | `JSONB`       | `NOT NULL`    |         | JWK Public Key                     |
| `active`     | `BOOLEAN`     | `NOT NULL`    | `FALSE` | True n·∫øu ƒëang d√πng ƒë·ªÉ verify       |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL`    | `now()` | Th·ªùi ƒëi·ªÉm t·∫°o key                  |
| `rotated_at` | `TIMESTAMPTZ` |               |         | Th·ªùi ƒëi·ªÉm key ƒë∆∞·ª£c rotate l·∫ßn cu·ªëi |

#### Indexes & Constraints

* **Primary Key:** `pk_jwks_keys` on `(kid)`
* **Unique Constraint:** `uq_jwks_keys_active` on `(active)` ‚Äì ch·ªâ m·ªôt key ƒë∆∞·ª£c active t·∫°i m·ªôt th·ªùi ƒëi·ªÉm
* **B-tree Index:** `idx_jwks_created_at` on `(created_at)` ‚Äì t·ªëi ∆∞u truy v·∫•n key m·ªõi nh·∫•t

### 5.2 B·∫£ng `auth_sessions`

```sql
CREATE TABLE auth_sessions (
  session_id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  tenant_id TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  last_active_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

| C·ªôt              | Ki·ªÉu d·ªØ li·ªáu  | R√†ng bu·ªôc     | Default | M√¥ t·∫£                               |
| ---------------- | ------------- | ------------- | ------- | ----------------------------------- |
| `session_id`     | `UUID`        | `PRIMARY KEY` |         | ID phi√™n d√πng cho refresh token     |
| `user_id`        | `UUID`        | `NOT NULL`    |         | `user_id_global` t·ª´ User Service    |
| `tenant_id`      | `TEXT`        | `NOT NULL`    |         | Tenant context                      |
| `created_at`     | `TIMESTAMPTZ` | `NOT NULL`    | `now()` | Th·ªùi ƒëi·ªÉm phi√™n ƒë∆∞·ª£c t·∫°o            |
| `last_active_at` | `TIMESTAMPTZ` | `NOT NULL`    | `now()` | Th·ªùi ƒëi·ªÉm phi√™n ho·∫°t ƒë·ªông cu·ªëi c√πng |

#### Indexes & Constraints

* **Primary Key:** `pk_auth_sessions` tr√™n (`session_id`)
* **B-tree Index:** `idx_auth_sessions_user_tenant` tr√™n (`user_id`, `tenant_id`) ‚Äì t·ªëi ∆∞u lookup session theo user & tenant
* **B-tree Index:** `idx_auth_sessions_last_active` tr√™n (`last_active_at`) ‚Äì h·ªó tr·ª£ purge phi√™n c≈© v√† th·ªëng k√™ session c√≤n s·ªëng

### 5.3 B·∫£ng `revoked_tokens`

```sql
CREATE TABLE revoked_tokens (
  jti UUID PRIMARY KEY,
  tenant_id TEXT NOT NULL,
  revoked_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  reason TEXT,
  revoked_by UUID
);
```

| C·ªôt          | Ki·ªÉu d·ªØ li·ªáu  | R√†ng bu·ªôc     | Default | M√¥ t·∫£                              |
| ------------ | ------------- | ------------- | ------- | ---------------------------------- |
| `jti`        | `UUID`        | `PRIMARY KEY` |         | JWT ID ƒë·ªÉ thu h·ªìi (claim `jti`)    |
| `tenant_id`  | `TEXT`        | `NOT NULL`    |         | Tenant context                     |
| `revoked_at` | `TIMESTAMPTZ` | `NOT NULL`    | `now()` | Th·ªùi ƒëi·ªÉm token b·ªã thu h·ªìi         |
| `reason`     | `TEXT`        |               |         | L√Ω do (`logout`, `rotation`, v.v.) |
| `revoked_by` | `UUID`        |               |         | ID ng∆∞·ªùi/th·ª±c th·ªÉ th·ª±c hi·ªán revoke |

#### Indexes & Constraints

* **Primary Key:** `pk_revoked_tokens` tr√™n (`jti`)
* **B-tree Index:** `idx_revoked_tokens_tenant_revoked_at` tr√™n (`tenant_id`, `revoked_at`) ‚Äì t·ªëi ∆∞u truy v·∫•n v√† purge theo tenant & th·ªùi gian
* **Check Constraint:** `chk_revoked_tokens_reason` CHECK (`reason` IN ('logout','rotation','breach','expired'))

### 5.4 B·∫£ng `token_stats`

```sql
CREATE TABLE token_stats (
  stat_id UUID PRIMARY KEY,
  jti UUID NOT NULL REFERENCES revoked_tokens(jti) ON DELETE CASCADE,
  latency_ms INTEGER NOT NULL,
  ip_address TEXT,
  device_info JSONB,
  recorded_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

| C·ªôt           | Ki·ªÉu d·ªØ li·ªáu  | R√†ng bu·ªôc                              | Default | M√¥ t·∫£                                             |
| ------------- | ------------- | -------------------------------------- | ------- | ------------------------------------------------- |
| `stat_id`     | `UUID`        | `PRIMARY KEY`                          |         | ID b·∫£n ghi th·ªëng k√™                               |
| `jti`         | `UUID`        | `NOT NULL`, FK ‚Üí `revoked_tokens(jti)` |         | Tham chi·∫øu t·ªõi token ƒë√£ b·ªã thu h·ªìi                |
| `latency_ms`  | `INTEGER`     | `NOT NULL`                             |         | Th·ªùi gian (ms) th·ª±c hi·ªán issuance/revoke          |
| `ip_address`  | `TEXT`        |                                        |         | ƒê·ªãa ch·ªâ IP client                                 |
| `device_info` | `JSONB`       |                                        |         | Th√¥ng tin thi·∫øt b·ªã (type, user\_agent, phi√™n b·∫£n) |
| `recorded_at` | `TIMESTAMPTZ` | `NOT NULL`                             | `now()` | Th·ªùi ƒëi·ªÉm ghi nh·∫≠n th·ªëng k√™                       |

#### Indexes & Constraints

* **Primary Key:** `pk_token_stats` tr√™n (`stat_id`)
* **Foreign Key:** `fk_token_stats_revoked`

  ```sql
  ALTER TABLE token_stats
    ADD CONSTRAINT fk_token_stats_revoked
      FOREIGN KEY (jti) REFERENCES revoked_tokens(jti) ON DELETE CASCADE;
  ```
* **B-tree Index:** `idx_token_stats_jti_recorded` tr√™n (`jti`, `recorded_at`) ‚Äì t·ªëi ∆∞u lookup stats cho m·ªói token v√† purge theo th·ªùi gian

---

## 6. Indexes & Constraints

ƒê·ªÉ ƒë·∫£m b·∫£o hi·ªáu nƒÉng truy v·∫•n v√† t√≠nh to√†n v·∫πn d·ªØ li·ªáu, m·ªói b·∫£ng trong Token Service ƒë∆∞·ª£c trang b·ªã c√°c ch·ªâ m·ª•c (index) v√† r√†ng bu·ªôc (constraint) nh∆∞ sau:

| B·∫£ng              | T√™n Index / Constraint           | Lo·∫°i              | ƒê·ªãnh nghƒ©a                                           | M·ª•c ƒë√≠ch                                                            |
|-------------------|----------------------------------|-------------------|------------------------------------------------------|---------------------------------------------------------------------|
| **jwks_keys**     | `pk_jwks_keys`                   | Primary Key       | `(kid)`                                              | ƒê·∫£m b·∫£o `kid` l√† duy nh·∫•t, d√πng l√†m PK                              |
|                   | `uq_jwks_keys_active`            | Unique Constraint | `(active)`                                           | Ch·ªâ m·ªôt public key ƒë∆∞·ª£c ƒë√°nh d·∫•u `active = TRUE`                   |
|                   | `idx_jwks_created_at`            | B-tree Index      | `(created_at)`                                       | T√¨m key m·ªõi nh·∫•t khi rotate                                         |
| **auth_sessions** | `pk_auth_sessions`               | Primary Key       | `(session_id)`                                       | ƒê·ªãnh danh phi√™n                                                   |
|                   | `idx_auth_sessions_user_tenant`  | B-tree Index      | `(user_id, tenant_id)`                               | Lookup sessions theo ng∆∞·ªùi d√πng & tenant                            |
|                   | `idx_auth_sessions_last_active`  | B-tree Index      | `(last_active_at)`                                   | X√≥a session c≈©, th·ªëng k√™ session c√≤n ‚Äús·ªëng‚Äù                        |
| **revoked_tokens**| `pk_revoked_tokens`              | Primary Key       | `(jti)`                                              | ƒê·ªãnh danh token b·ªã thu h·ªìi                                         |
|                   | `idx_revoked_tokens_tenant_at`   | B-tree Index      | `(tenant_id, revoked_at)`                            | T√¨m tokens ƒë√£ thu h·ªìi theo tenant v√† th·ªùi gian, t·ªëi ∆∞u purge job   |
|                   | `chk_revoked_tokens_reason`      | Check Constraint  | `reason IN ('logout','rotation','breach','expired')` | Gi·ªõi h·∫°n gi√° tr·ªã `reason` theo ENUM                               |
| **token_stats**   | `pk_token_stats`                 | Primary Key       | `(stat_id)`                                          | ƒê·ªãnh danh record th·ªëng k√™                                          |
|                   | `fk_token_stats_revoked_tokens`  | Foreign Key       | `(jti) REFERENCES revoked_tokens(jti) ON DELETE CASCADE` | ƒê·∫£m b·∫£o m·ªói stat li√™n k·∫øt t·ªõi m·ªôt revoked token                  |
|                   | `idx_token_stats_jti_recorded`   | B-tree Index      | `(jti, recorded_at)`                                 | Lookup stats cho m·ªôt token v√† purge theo th·ªùi gian                |

### Chi ti·∫øt & Best Practices

- **Primary Key & Unique**:  
  - PK ƒë·∫∑t tr√™n c·ªôt ƒë·ªãnh danh duy nh·∫•t (`kid`, `session_id`, `jti`, `stat_id`).  
  - Unique cho `jwks_keys.active` ƒë·ªÉ ch·ªâ 1 key ƒë∆∞·ª£c active.

- **B-tree Index**:  
  - D√πng cho c·ªôt th∆∞·ªùng xuy√™n filter/sort: `created_at`, `last_active_at`, `revoked_at`, `recorded_at`.  
  - Composite index `(user_id, tenant_id)` gi√∫p t√¨m session theo tenant nhanh.

- **Check Constraint**:  
  - S·ª≠ d·ª•ng `CHECK` ƒë·ªÉ validate ENUM-like (`reason`), kh√¥ng ph·ª• thu·ªôc ENUM type DB, gi·ªØ t√≠nh di ƒë·ªông.

- **Foreign Key**:  
  - `token_stats.jti` tham chi·∫øu `revoked_tokens.jti` v·ªõi `ON DELETE CASCADE` ƒë·ªÉ t·ª± cleanup stats khi token b·ªã x√≥a.

- **Retention & Purge**:  
  - C√°c cron/job purge d·ª±a tr√™n ch·ªâ m·ª•c `(tenant_id, revoked_at)` v√† `(jti, recorded_at)` ƒë·ªÉ x√≥a d·ªØ li·ªáu qu√° h·∫°n nhanh.

> C√°c t√™n index/constraint tu√¢n chu·∫©n **5‚òÖ Data Model Standard**: c√≥ prefix t∆∞∆°ng ·ª©ng b·∫£ng, r√µ r√†ng lo·∫°i index, d·ªÖ tra c·ª©u khi debugging v√† tuning.

---

## 7. Ch√≠nh s√°ch L∆∞u tr·ªØ & X√≥a D·ªØ li·ªáu

> Tu√¢n theo ADR-024 (Data Anonymization & Retention) v√† ADR-026 (Hard-Delete Policy), m·ªçi d·ªØ li·ªáu c≈© ƒë·ªÅu ƒë∆∞·ª£c x√≥a ho·∫∑c ·∫©n danh theo TTL ƒë·ªãnh s·∫µn.

### 7.1 TTL & Job Purge

| B·∫£ng               | TTL                              | Job                           | T·∫ßn su·∫•t   | H√†nh ƒë·ªông                                                         |
|--------------------|----------------------------------|-------------------------------|------------|-------------------------------------------------------------------|
| `jwks_keys`        | 30 ng√†y k·ªÉ t·ª´ `rotated_at`       | `purge_jwks_keys`             | H√†ng ng√†y 02:00 UTC | `DELETE FROM jwks_keys WHERE rotated_at < now() - INTERVAL '30 days';` |
| `auth_sessions`    | 14 ng√†y k·ªÉ t·ª´ `last_active_at`   | `purge_auth_sessions`         | H√†ng gi·ªù   | `DELETE FROM auth_sessions WHERE last_active_at < now() - INTERVAL '14 days';` |
| `revoked_tokens`   | 30 ng√†y k·ªÉ t·ª´ `revoked_at`       | `purge_revoked_tokens`        | H√†ng ng√†y 03:00 UTC | `DELETE FROM revoked_tokens WHERE revoked_at < now() - INTERVAL '30 days';` |
| `token_stats`      | 90 ng√†y k·ªÉ t·ª´ `recorded_at`      | `anonymize_token_stats` & `purge_token_stats` | H√†ng ng√†y 04:00 UTC | 1) `UPDATE token_stats SET ip_address = NULL, device_info = NULL WHERE recorded_at < now() - INTERVAL '90 days';`<br>2) `DELETE FROM token_stats WHERE recorded_at < now() - INTERVAL '90 days';` |

### 7.2 Audit & Event Notification

- M·ªói job purge/anonymize ghi v√†o b·∫£ng `audit_log.purge_history` (schema v1: `resource`, `deleted_count`, `run_at`, `initiator='system'`).  
- Sau khi ho√†n th√†nh, ph√°t s·ª± ki·ªán **`data.purged.v1`** l√™n Pub/Sub topic `data.v1` v·ªõi payload:
```json
  {
    "event": "data.purged.v1",
    "resource": "revoked_tokens",
    "deleted_count": 12345,
    "timestamp": "2025-06-09T02:00:00Z"
  }
```

### 7.3 Hard-Delete & Rollback

* **Hard-Delete**: Kh√¥ng c√≥ c∆° ch·∫ø soft-delete‚Äîd·ªØ li·ªáu v∆∞·ª£t TTL b·ªã x√≥a vƒ©nh vi·ªÖn.
* **Undo Migration**: N·∫øu c·∫ßn kh√¥i ph·ª•c, s·ª≠ d·ª•ng Flyway `U20250617__recreate_revoked_tokens.sql` (ADR-023).

### 7.4 Ki·ªÉm so√°t & Gi√°m s√°t

* Job purge/anonymize ph·∫£i log metric:

  * `purge_revoked_tokens_count`
  * `purge_auth_sessions_count`
  * `anonymize_token_stats_count`
* Alert n·∫øu job th·∫•t b·∫°i ho·∫∑c `deleted_count = 0` b·∫•t th∆∞·ªùng (k·ªãch b·∫£n d·ªØ li·ªáu qu√° nhi·ªÅu ho·∫∑c qu√° √≠t).

---

## 8. Data Synchronization & Events

> **M·ª•c ti√™u** ‚Äì Ph√°t h√†nh **s·ª± ki·ªán b·∫•t ƒë·ªìng b·ªô** ƒë·ªÉ c√°c th√†nh ph·∫ßn kh√°c (API Gateway, Audit Service, Monitoring) nh·∫≠n bi·∫øt ngay thay ƒë·ªïi li√™n quan JWT, ƒë·ªìng th·ªùi ƒë·∫£m b·∫£o **ƒë·ªìng nh·∫•t** v√† **c√≥ th·ªÉ m·ªü r·ªông** theo ADR-030.

---

### 8.1 Pub/Sub Topic & Event Names

- **Topic chung**: `token.v1`  
- **T√™n s·ª± ki·ªán** (theo ADR-030 ‚Äì Event Schema Governance):  
  - `token.issued.v1`  
  - `token.revoked.v1`  
  - `token.introspect_fail.v1`  

> *M·ªói event c√≥ attribute `tenant_id`, d√πng ƒë·ªÉ **filter** fan-out t·ªõi c√°c subscription.*

---

### 8.2 JSON Schema & Registry

| Event                            | Schema ID              | Ghi ch√∫                         |
|----------------------------------|------------------------|---------------------------------|
| `token_issued_v1`                | `token_issued_v1`      | Invariants: `jti`, `session_id` |
| `token_revoked_v1`               | `token_revoked_v1`     | Invariants: `jti`, `revoked_by` |
| `token_introspect_fail_v1`       | `token_introspect_fail_v1` | Invariants: `token`, `error`    |

Schemas ƒë∆∞·ª£c l∆∞u trong **Schema Registry** (backward-compatible ‚â• 6 th√°ng).

---

### 8.3 Payload Examples

#### 8.3.1 `token.issued.v1`

```json
{
  "event": "token.issued.v1",
  "timestamp": "2025-06-09T08:00:00Z",
  "tenant_id": "school-xyz",
  "user_id": "user-123",
  "jti": "uuid-abc-123",
  "session_id": "sess-456-def",
  "ip_address": "203.0.113.5",
  "device": {
    "type": "web",
    "user_agent": "Mozilla/5.0"
  }
}
```

#### 8.3.2 `token.revoked.v1`

```json
{
  "event": "token.revoked.v1",
  "timestamp": "2025-06-09T09:15:30Z",
  "tenant_id": "school-xyz",
  "user_id": "user-123",
  "jti": "uuid-abc-123",
  "revoked_by": "admin-789",
  "reason": "logout",
  "ip_address": "203.0.113.5"
}
```

#### 8.3.3 `token.introspect_fail.v1`

```json
{
  "event": "token.introspect_fail.v1",
  "timestamp": "2025-06-09T09:16:00Z",
  "tenant_id": "school-xyz",
  "token": "eyJhbGciOiJSUzI1NiIs‚Ä¶",
  "error": {
    "code": "token.revoked",
    "message": "Token ƒë√£ b·ªã thu h·ªìi"
  }
}
```

---

### 8.4 Consumers & Subscriptions

| Subscriber             | Subscription ID     | X·ª≠ l√Ω ch√≠nh                                           |
| ---------------------- | ------------------- | ----------------------------------------------------- |
| **API Gateway**        | `sub-token-revoked` | Xo√° cache `revoked:{jti}` khi nh·∫≠n `token.revoked.v1` |
| **Audit Logging**      | `sub-token-audit`   | Ghi log event v√†o b·∫£ng `audit_log.token_events`       |
| **Monitoring Service** | `sub-token-monitor` | T√≠nh metrics - hit/miss, latency, fail rates          |

* **Filter**: subscription l·ªçc attribute `tenant_id` ƒë·ªÉ ph√¢n v√πng ri√™ng cho m·ªói tenant.

---

### 8.5 Delivery Semantics & Ordering

* **At-least-once** delivery, idempotent consumers.
* **Ordering**: Pub/Sub ƒë·∫£m b·∫£o ordering trong c√πng `orderingKey=tenant_id`.
* **Retries**: DLQ (Dead-Letter Queue) cho event th·∫•t b·∫°i sau 5 l·∫ßn x·ª≠ l√Ω.

---

### 8.6 Governance & Versioning

* M·ªói event t√≠ch h·ª£p field `schema_version` (m·∫∑c ƒë·ªãnh = 1).
* Khi schema thay ƒë·ªïi, tƒÉng suffix: `token.issued.v2`, gi·ªØ backward-compat trong ‚â• 6 th√°ng.
* Theo ADR-030, m·ªçi consumer ph·∫£i ki·ªÉm tra `schema_version` tr∆∞·ªõc khi deserialize.

---

## 9. Data Access Control

> **M·ª•c ti√™u** ‚Äì ƒê·∫£m b·∫£o ch·ªâ **Token Service** v√† c√°c th√†nh ph·∫ßn ƒë√£ x√°c th·ª±c m·ªõi ƒë∆∞·ª£c ph√©p truy c·∫≠p d·ªØ li·ªáu, tu√¢n **principle of least privilege** v√† tu√¢n chu·∫©n b·∫£o m·∫≠t m·∫°ng/D·ªØ li·ªáu.

### 9.1 Authentication & Database Users

- **Cloud SQL IAM Authentication**  
  - Admin s·ª≠ d·ª•ng IAM role `cloudsql.admin` ƒë·ªÉ k·∫øt n·ªëi v·ªõi instance.  
- **Application user**  
  - T√†i kho·∫£n DB `token_service` (mapping Workload Identity `svc-token-db@dx-vas-core.iam.gserviceaccount.com`).  
  - Kh√¥ng c√≥ quy·ªÅn SUPERUSER.

### 9.2 Network & Encryption

- **K·∫øt n·ªëi Private IP** qua VPC Peering (GKE ‚Üî Cloud SQL).  
- **SSL/TLS b·∫Øt bu·ªôc**: `sslmode=require`, verify server cert.  
- **Firewall** ch·ªâ m·ªü c·ªïng 5432 cho subnet GKE core.

### 9.3 Privilege Matrix (Least Privilege)

| DB User        | B·∫£ng / Schema         | Quy·ªÅn                                |
|----------------|-----------------------|--------------------------------------|
| `token_service`| `jwks_keys`           | SELECT, INSERT, UPDATE               |
|                | `auth_sessions`       | SELECT, INSERT, UPDATE, DELETE       |
|                | `revoked_tokens`      | SELECT, INSERT, DELETE               |
|                | `token_stats`         | SELECT, INSERT, DELETE               |
|                | `audit_log.*`         | INSERT                               |
| **DB Admin**   | **T·∫•t c·∫£**            | ALL PRIVILEGES                       |

```sql
-- V√≠ d·ª• GRANT trong migration
GRANT SELECT, INSERT, UPDATE ON jwks_keys TO token_service;
GRANT SELECT, INSERT, UPDATE, DELETE ON auth_sessions TO token_service;
GRANT SELECT, INSERT, DELETE ON revoked_tokens TO token_service;
GRANT SELECT, INSERT, DELETE ON token_stats TO token_service;
GRANT INSERT ON audit_log.* TO token_service;
```

---

## 10. M·ªü r·ªông trong T∆∞∆°ng lai

> ƒê·ªãnh h∆∞·ªõng c√°c c·∫£i ti·∫øn ti·∫øp theo nh·∫±m tƒÉng kh·∫£ nƒÉng quan s√°t, hi·ªáu su·∫•t v√† tu√¢n th·ªß quy m√¥ l·ªõn h∆°n, ƒë·ªìng th·ªùi gi·ªØ v·ªØng t√≠nh m·ªü r·ªông & an to√†n theo **5‚òÖ Data Model Standard** v√† c√°c **ADR** li√™n quan.

### 10.1 Embedded RBAC Claims

- **M·ª•c ti√™u**: Cho ph√©p l∆∞u tr·ª±c ti·∫øp b·∫£ng `rbac_claims` v√†o JWT ƒë·ªÉ gi·∫£m truy v·∫•n DB/Redis khi ph√¢n quy·ªÅn.  
- **Thi·∫øt k·∫ø**:  
```sql
  CREATE TABLE token_rbac_claims (
    jti            UUID PRIMARY KEY REFERENCES revoked_tokens(jti),
    rbac_payload   JSONB NOT NULL,        -- roles & perms t·∫°i th·ªùi ƒëi·ªÉm issue
    issued_at      TIMESTAMPTZ NOT NULL
  );
```

* **Constraint & Index**:

  * `idx_token_rbac_claims_issued_at` on `(issued_at)` cho purge.
* **Retention**: TTL 2 ph√∫t (purge nhanh), theo ADR-024.

### 10.2 Key Usage Logging

* **M·ª•c ti√™u**: Thu th·∫≠p chi ti·∫øt m·ªói l·∫ßn JWKS key signing/verification ƒë·ªÉ ph√¢n t√≠ch v√† audit.
* **Thi·∫øt k·∫ø**:

  ```sql
  CREATE TABLE key_usage_log (
    log_id       UUID PRIMARY KEY,
    kid          UUID NOT NULL REFERENCES jwks_keys(kid),
    operation    TEXT NOT NULL CHECK (operation IN ('sign','verify')),
    jti          UUID,                    -- n·∫øu operation='sign'
    timestamp    TIMESTAMPTZ NOT NULL DEFAULT now(),
    tenant_id    TEXT,
    result       BOOLEAN NOT NULL
  );
  ```
* **Indexes**:

  * Composite `(kid, timestamp)` cho ph√¢n t√≠ch key hot-path.
* **Purge**: TTL 7 ng√†y, job `purge_key_usage_log`.

### 10.3 Partitioning & Sharding

* **Partitioned Tables**:

  * `revoked_tokens` theo `tenant_id` hash ‚Üí tƒÉng t·ªëc lookup.
  * `token_stats` partition by date period (monthly) cho purge hi·ªáu qu·∫£.
* **Shard Key**: S·ª≠ d·ª•ng `tenant_id` + `jti` l√†m composite shard key khi m·ªü r·ªông Multi-Region.

### 10.4 Cross-Region Replication

* **JWKS Replicas**:

  * T·∫°o b·∫£ng `jwks_keys_replica` t·∫°i region ph·ª•, s·ª≠ d·ª•ng **Logical Replication** ho·∫∑c **Cloud SQL read replicas**.
* **Failover**: API Gateway c√≥ th·ªÉ fallback verify t·ª´ replica n·∫øu primary unreachable (theo ADR-004).

### 10.5 Real-time Analytics Feed

* **CDC Stream**: D√πng Debezium ‚Üí Pub/Sub topic `dw.token_changes.v1` ‚Üí Data Platform.
* **Mart Tables**:

  ```sql
  CREATE TABLE fct_token_issuance (
    tenant_id TEXT,
    date DATE,
    issued_count BIGINT,
    revoked_count BIGINT
  ) PARTITION BY RANGE (date);
  ```
* **Use-case**: B√°o c√°o issuance/revocation theo tenant, k·∫øt h·ª£p BI Engine.

### 10.6 Audit History & Versioning

* **Temporal Tables**:

  * M·ªü r·ªông `revoked_tokens` th√†nh `revoked_tokens_history` l∆∞u phi√™n b·∫£n tr∆∞·ªõc khi x√≥a/·∫©n danh.
* **Schema Versioning**:

  * Ghi `schema_version` v√†o setiap b·∫£n ghi ƒë·ªÉ support ADR-023 khi migration ti·∫øp theo.

> V·ªõi khung m·ªü r·ªông n√†y, Token Service s·∫Ω s·∫µn s√†ng ƒë√≥n ƒë·∫ßu c√°c y√™u c·∫ßu m·ªü r·ªông l·ªõn (10k tenant), tu√¢n chu·∫©n ADR-023, ADR-024, ADR-030 v√† gi·ªØ p95 latency < 5 ms cho m·ªçi truy v·∫•n d·ªØ li·ªáu.

---

## 11. ENUMs

> **M·ª•c ƒë√≠ch** ‚Äì ƒê·ªãnh nghƒ©a t·∫≠p gi√° tr·ªã c·ªë ƒë·ªãnh ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n v√† gi·∫£m l·ªói ƒë·∫ßu v√†o. Theo **5‚òÖ Data Model Standard**, ch√∫ng ta d√πng `CHECK` constraints thay v√¨ lo·∫°i ENUM DB ri√™ng ƒë·ªÉ gi·ªØ t√≠nh di ƒë·ªông gi·ªØa PostgreSQL v√† MariaDB.

### 11.1 `reason` trong `revoked_tokens`

Token c√≥ th·ªÉ b·ªã thu h·ªìi b·ªüi c√°c nguy√™n nh√¢n sau:

| Gi√° tr·ªã    | M√¥ t·∫£                              |
|------------|------------------------------------|
| `logout`   | Ng∆∞·ªùi d√πng th·ª±c hi·ªán ƒëƒÉng xu·∫•t     |
| `rotation` | Token b·ªã thu h·ªìi do xoay kh√≥a JWT  |
| `breach`   | Token b·ªã thu h·ªìi do ph√°t hi·ªán vi ph·∫°m b·∫£o m·∫≠t |
| `expired`  | Token t·ª± h·∫øt h·∫°n                  |

**SQL (PostgreSQL / MariaDB)**

```sql
ALTER TABLE revoked_tokens
  ADD CONSTRAINT chk_revoked_tokens_reason
    CHECK (reason IN (
      'logout',
      'rotation',
      'breach',
      'expired'
    ));
```

### 11.2 (T√πy ch·ªçn) `event` trong Pub/Sub

ƒê·ªÉ ƒë·ªìng b·ªô v·ªõi **ADR-030**, c√°c t√™n event c≈©ng l√† ‚Äúenum‚Äù tr√™n Pub/Sub:

| Gi√° tr·ªã                    | M√¥ t·∫£                                           |
| -------------------------- | ----------------------------------------------- |
| `token.issued.v1`          | S·ª± ki·ªán khi JWT m·ªõi ƒë∆∞·ª£c ph√°t h√†nh              |
| `token.revoked.v1`         | S·ª± ki·ªán khi JWT b·ªã thu h·ªìi                      |
| `token.introspect_fail.v1` | S·ª± ki·ªán khi introspect tr·∫£ k·∫øt qu·∫£ kh√¥ng h·ª£p l·ªá |

> **L∆∞u √Ω:** Vi·ªác validate event name th∆∞·ªùng di·ªÖn ra ·ªü **Consumer** (API Gateway, Audit Service) qua schema registry, kh√¥ng qua DB.

### 11.3 Best Practices

* **Kh√¥ng** hard-code gi√° tr·ªã trong ·ª©ng d·ª•ng; tham chi·∫øu qua `CHECK` ho·∫∑c enum type trong codegen.
* Khi m·ªü r·ªông th√™m l√Ω do ho·∫∑c event m·ªõi, lu√¥n **update** `CHECK` constraint v√† **publish** event schema m·ªõi (`v2`).
* ƒê·∫£m b·∫£o **migration** theo **3-phase** (ADR-023): Prepare ‚Üí Transition ‚Üí Cleanup khi thay ƒë·ªïi gi√° tr·ªã enum.

---

## 12. Ph·ª• l·ª•c Ki·ªÉm th·ª≠

> ƒê·ªÉ ƒë·∫£m b·∫£o **t√≠nh to√†n v·∫πn**, **t√≠nh ƒë√∫ng ƒë·∫Øn** v√† **hi·ªáu nƒÉng** c·ªßa Data Model, ch√∫ng ta √°p d·ª•ng ƒëa t·∫ßng ki·ªÉm th·ª≠ theo 5‚òÖ Data Model Standard.

### 12.1 Unit Tests

- **Framework**: pgTAP (PostgreSQL) / SQLUnit (MariaDB)
- **C√°c k·ªãch b·∫£n**:
  1. **Schema validation**  
     - Ki·ªÉm tra c√°c b·∫£ng t·ªìn t·∫°i v·ªõi ƒë√∫ng c·ªôt, ki·ªÉu, NOT NULL.  
     - `SELECT column_name FROM information_schema.columns WHERE table_name='revoked_tokens'` ‚Üí so v·ªõi spec.
  2. **Constraints**  
     - Th·ª≠ ch√®n `revoked_tokens` v·ªõi `reason='invalid'` ‚Üí ph·∫£i fail `CHECK chk_revoked_tokens_reason`.  
     - Th·ª≠ ch√®n hai b·∫£n ghi `jwks_keys` c√πng `active=TRUE` ‚Üí ph·∫£i fail unique.
  3. **Default values**  
     - Th·ª≠ insert kh√¥ng cung c·∫•p `created_at` ‚Üí gi√° tr·ªã m·∫∑c ƒë·ªãnh l√† `now()`.  
     - Th·ª≠ insert `auth_sessions` kh√¥ng cung c·∫•p `last_active_at` ‚Üí default `now()`.

### 12.2 Integration Tests

- **M√¥i tr∆∞·ªùng**: Docker Compose v·ªõi PostgreSQL v√† MariaDB, seed d·ªØ li·ªáu m·∫´u.
- **C√°c k·ªãch b·∫£n**:
  1. **Full Issuance ‚Üí Revocation ‚Üí Stats**  
     - G·ªçi API `/v1/token/issue` ‚Üí ki·ªÉm tra `auth_sessions`, `jwks_keys` d√πng ƒë√∫ng `kid`.  
     - G·ªçi `/v1/token/revoke` ‚Üí b·∫£n ghi `revoked_tokens` t·ªìn t·∫°i ‚Üí th·ª≠ insert `token_stats`.  
     - X√°c nh·∫≠n `token_stats.jti` FK ‚Üí khi x√≥a `revoked_tokens`, `token_stats` t·ª± cascade delete.
  2. **Migration Script**  
     - Ch·∫°y Flyway t·ª´ v1.0 ‚Üí v1.2 ‚Üí v1.3 ‚Üí v1.4 trong m√¥i tr∆∞·ªùng test.  
     - Ki·ªÉm tra b·∫£ng `revoked_tokens_v2` t·ªìn t·∫°i ·ªü pha Prepare, sau Transition ch·ªâ ƒë·ªçc t·ª´ v2, sau Cleanup ch·ªâ c√≤n v2.
  3. **Event Publication**  
     - Sau each DML tr√™n DB, theo d√µi Pub/Sub mock ‚Üí ƒë·∫£m b·∫£o event `token.*.v1` ƒë∆∞·ª£c publish ƒë√∫ng payload.

### 12.3 Retention & Purge Tests

- **Framework**: Scheduled job runner + test data expiration.
- **C√°c k·ªãch b·∫£n**:
  1. **TTL revoke**  
     - Insert `revoked_tokens.revoked_at = now() - '31 days'` ‚Üí ch·∫°y `purge_revoked_tokens` ‚Üí b·∫£n ghi b·ªã x√≥a.  
     - B·∫£o ƒë·∫£m `purge_revoked_tokens_count` metric tƒÉng ch√≠nh x√°c.
  2. **Anonymize stats**  
     - Insert `token_stats.recorded_at = now() - '91 days'` v·ªõi `ip_address`, `device_info`.  
     - Ch·∫°y `anonymize_token_stats` ‚Üí c√°c tr∆∞·ªùng PII ph·∫£i null; sau ƒë√≥ ch·∫°y `purge_token_stats` ‚Üí b·∫£n ghi b·ªã x√≥a.

### 12.4 Performance Tests

- **C√¥ng c·ª•**: pgbench / sysbench / JMeter
- **Ch·ªâ s·ªë m·ª•c ti√™u**:
  - **p95 SELECT revoked_tokens** ‚â§ 5 ms (with index).  
  - **p95 INSERT auth_sessions** ‚â§ 10 ms.  
  - **Bulk purge** 100k records in < 30s.
- **K·ªãch b·∫£n**:
  1. Th·ª±c hi·ªán 10k concurrent selects `SELECT 1 FROM revoked_tokens WHERE jti=?`.  
  2. Th·ª±c hi·ªán 1k inserts `auth_sessions`/s v·ªõi batch size 50.  
  3. Ch·∫°y purge job tr√™n 1M revoked_tokens.

### 12.5 Security & Privilege Tests

- **Verify least privilege**:
  - K·∫øt n·ªëi DB b·∫±ng role `token_service` ‚Üí th·ª≠ `DROP TABLE jwks_keys` ‚Üí ph·∫£i b·ªã DENY.  
  - K·∫øt n·ªëi b·∫±ng `db_admin` ‚Üí c√≥ quy·ªÅn ALL.
- **SSL enforcement**:
  - K·∫øt n·ªëi kh√¥ng d√πng SSL ‚Üí th·∫•t b·∫°i v·ªõi `sslmode=require`.
- **Audit Logging**:
  - Khi purge ho·∫∑c rotation ch·∫°y, ki·ªÉm tra `audit_log.purge_history` c√≥ b·∫£n ghi.

### 12.6 Concurrency & Consistency

- **K·ªãch b·∫£n**:
  1. **Race Condition**: 2 clients c√πng revoke `jti` ‚Üí ch·ªâ m·ªôt b·∫£n ghi ƒë∆∞·ª£c insert, kh√¥ng duplicate.  
  2. **Dual-write migration**: Trong pha Prepare, record inserted v√†o c·∫£ b·∫£ng c≈© & b·∫£ng v2, sau phase Transition ch·ªâ d√πng v2.

### 12.7 CI/CD Integration

- **Pipeline**:
  1. Stage **Unit Test** (pgTAP).  
  2. Stage **Integration Test** (Dockerized DB).  
  3. Stage **Migration Test** (Flyway).  
  4. Stage **Performance Test** (light load).  
- **B·∫£o ƒë·∫£m**: 100 % test must pass before merge.

---

> V·ªõi suite ki·ªÉm th·ª≠ tr√™n, Data Model c·ªßa Token Service ƒë·∫£m b·∫£o **ƒë√∫ng**, **an to√†n**, **hi·ªáu nƒÉng** v√† **d·ªÖ m·ªü r·ªông**, ƒë√°p ·ª©ng to√†n b·ªô ADR v√† 5‚òÖ Data Model Standard.  

---

## 13. üìö Li√™n k·∫øt T√†i li·ªáu

* [Interface Contract](./interface-contract.md)
* [Data Model](./data-model.md)
* [OpenAPI Spec](./openapi.yaml)

### üîñ C√°c Quy·∫øt ƒë·ªãnh Ki·∫øn tr√∫c (ADR)

- [ADR-003 Secrets Management](../../ADR/adr-003-secrets.md): Quy tr√¨nh l∆∞u tr·ªØ & xoay kh√≥a b√≠ m·∫≠t an to√†n.  
- [ADR-004 Security Policy](../../ADR/adr-004-security.md): Ch√≠nh s√°ch b·∫£o m·∫≠t t·ªïng th·ªÉ.  
- [ADR-005 Environment Configuration Strategy](../../ADR/adr-005-env-config.md): Chu·∫©n t√°ch c·∫•u h√¨nh ‚Äì `SERVICE__SECTION__KEY`.  
- [ADR-006 Auth Strategy](../../ADR/adr-006-auth-strategy.md): Chi·∫øn l∆∞·ª£c x√°c th·ª±c ng∆∞·ªùi d√πng v√† c·∫•p ph√°t token.  
- [ADR-009 API Governance](../../ADR/adr-009-api-governance.md): Quy t·∫Øc versioning, naming v√† style REST.  
- [ADR-011 API Error Format](../../ADR/adr-011-api-error-format.md): Quy ∆∞·ªõc m√£ l·ªói & th√¥ng ƒëi·ªáp l·ªói (`namespace.snake_case`).  
- [ADR-012 Response Structure](../../ADR/adr-012-response-structure.md): Chu·∫©n h√≥a c·∫•u tr√∫c JSON response cho API.
- [ADR-018 Release Approval Policy](../../ADR/adr-018-release-approval-policy.md): Quy tr√¨nh ph√™ duy·ªát ph√°t h√†nh.
- [ADR-022 SLA & SLO Monitoring](../../ADR/adr-022-sla-slo-monitoring.md): Khung gi√°m s√°t & ƒë·ªãnh nghƒ©a SLO.
- [ADR-023 Schema Migration Strategy](../../ADR/adr-023-schema-migration-strategy.md): 3-phase migration (Prepare ‚Üí Transition ‚Üí Cleanup).  
- [ADR-024 Data Anonymization & Retention](../../ADR/adr-024-data-anonymization-retention.md): ·∫®n danh PII v√† TTL d·ªØ li·ªáu.  
- [ADR-026 Hard-Delete Policy](../../ADR/adr-026-hard-delete-policy.md): Quy tr√¨nh xo√° vƒ©nh vi·ªÖn & purge log.  
- [ADR-030 Event Schema Governance](../../ADR/adr-030-event-schema-governance.md): ƒê·∫∑t t√™n & version s·ª± ki·ªán `*.v{n}`.
