---
title: User Service Master ‚Äì Service Design Document
description: Service Design Document cho SPA qu·∫£n tr·ªã h·ªá th·ªëng VAS DX
version: 1.1
author: DX VAS Team
last_updated: 2025-06-13
reviewed_by: Stephen Le
---
# üìò User Service Master ‚Äì Service Design Document

## 1. M·ª•c ƒë√≠ch (Scope)

User Service Master ch·ªãu tr√°ch nhi·ªám qu·∫£n l√Ω ƒë·ªãnh danh ng∆∞·ªùi d√πng to√†n c·ª•c (`users_global`), danh s√°ch tenant (`tenants`) v√† vi·ªác g√°n ng∆∞·ªùi d√πng v√†o tenant c·ª• th·ªÉ (`user_tenant_assignments`). Ngo√†i ra, service n√†y c≈©ng cung c·∫•p c√°c template RBAC to√†n c·ª•c (`global_roles_templates`, `global_permissions_templates`) ƒë·ªÉ c√°c Sub User Service c√≥ th·ªÉ ƒë·ªìng b·ªô v√† kh·ªüi t·∫°o RBAC c·ª•c b·ªô cho t·ª´ng tenant.

Service n√†y l√† n·ªÅn t·∫£ng c·ªët l√µi cho to√†n b·ªô h·ªá th·ªëng ph√¢n quy·ªÅn ƒëa tenant, ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n trong qu·∫£n l√Ω ng∆∞·ªùi d√πng v√† h·ªó tr·ª£ c√°c lu·ªìng x√°c th·ª±c t·ª´ Auth Master/Sub.

### üö´ Kh√¥ng ch·ªãu tr√°ch nhi·ªám (Out of Scope)

User Service Master **kh√¥ng** ch·ªãu tr√°ch nhi·ªám ƒë·ªëi v·ªõi c√°c ch·ª©c nƒÉng sau:

- ‚ùå Qu·∫£n l√Ω RBAC chi ti·∫øt ·ªü c·∫•p tenant (bao g·ªìm roles, permissions, v√† user-role mapping c·ª•c b·ªô) ‚Äì ƒë√¢y l√† tr√°ch nhi·ªám c·ªßa Sub User Service t∆∞∆°ng ·ª©ng.
- ‚ùå Th·ª±c hi·ªán x√°c th·ª±c ng∆∞·ªùi d√πng (Google OAuth2, OTP, Local login) ‚Äì do Auth Service Master/Sub x·ª≠ l√Ω.
- ‚ùå L∆∞u tr·ªØ ho·∫∑c x·ª≠ l√Ω c√°c d·ªØ li·ªáu nghi·ªáp v·ª• chi ti·∫øt c·ªßa t·ª´ng tenant (v√≠ d·ª•: h·ªçc sinh, gi√°o vi√™n, l·ªõp h·ªçc, h·ªçc ph√≠...) ‚Äì c√°c adapter CRM/SIS/LMS ƒë·∫£m nhi·ªám ph·∫ßn n√†y.
- ‚ùå Cung c·∫•p c√°c giao di·ªán frontend ‚Äì v√≠ d·ª• Superadmin Webapp ch·ªâ g·ªçi API t·ª´ Gateway, ch·ª© kh√¥ng truy c·∫≠p tr·ª±c ti·∫øp v√†o service n√†y.

---

## 2. Tr√°ch nhi·ªám ch√≠nh (Responsibilities)

- Qu·∫£n l√Ω b·∫£ng ƒë·ªãnh danh ng∆∞·ªùi d√πng to√†n h·ªá th·ªëng (`users_global`)
- Cho ph√©p t·∫°o, c·∫≠p nh·∫≠t, tra c·ª©u th√¥ng tin ng∆∞·ªùi d√πng to√†n c·ª•c
- Qu·∫£n l√Ω danh s√°ch tenant ƒëang ho·∫°t ƒë·ªông v√† tr·∫°ng th√°i
- G√°n quy·ªÅn ng∆∞·ªùi d√πng v√†o c√°c tenant c·ª• th·ªÉ (`user_tenant_assignments`)
- Cung c·∫•p b·ªô template `roles` v√† `permissions` d√πng ƒë·ªÉ seed xu·ªëng c√°c tenant
- Ph√°t s·ª± ki·ªán `user_created`, `tenant_user_assigned`, `rbac_template_updated` ph·ª•c v·ª• Sub Services

---

## 3. Lu·ªìng nghi·ªáp v·ª• ch√≠nh (Business Flows)

### üîπ ƒêƒÉng nh·∫≠p Google OAuth2 (qua Auth Master)
1. Auth Master x√°c th·ª±c th√†nh c√¥ng user Google ‚Üí g·ªçi `GET /users-global/by-email`
2. N·∫øu ch∆∞a t·ªìn t·∫°i ‚Üí g·ªçi `POST /users-global` ƒë·ªÉ t·∫°o m·ªõi
3. G·ªçi `GET /user-tenant-assignments?user_id=...` ƒë·ªÉ l·∫•y danh s√°ch tenant ng∆∞·ªùi d√πng thu·ªôc v·ªÅ
4. Ng∆∞·ªùi d√πng ch·ªçn tenant ‚Üí chuy·ªÉn qua lu·ªìng Auth ti·∫øp theo

### üîπ G√°n ng∆∞·ªùi d√πng v√†o tenant
- Admin h·ªá th·ªëng (qua Superadmin Webapp) c√≥ th·ªÉ g√°n ng∆∞·ªùi d√πng v√†o 1 ho·∫∑c nhi·ªÅu tenant
- G·ªçi `POST /user-tenant-assignments`
- Ph√°t s·ª± ki·ªán `tenant_user_assigned` ƒë·ªÉ Sub User Service t·∫°o b·∫£n ghi c·ª•c b·ªô

#### üîÑ Lu·ªìng 1: Superadmin g√°n ng∆∞·ªùi d√πng v√†o tenant

```mermaid
sequenceDiagram
    participant FE as Superadmin Webapp
    participant GW as API Gateway
    participant USM as User Service Master
    participant DB as PostgreSQL (users_global + user_tenant_assignments)
    participant PUB as Google Pub/Sub

    FE->>GW: POST /user-tenant-assignments
    GW->>USM: POST /user-tenant-assignments
    USM->>DB: Ghi user_id, tenant_id, role_codes v√†o b·∫£ng user_tenant_assignments
    USM-->>PUB: Ph√°t s·ª± ki·ªán tenant_user_assigned (ch·ª©a user_id, tenant_id, role_codes)
    USM-->>GW: 200 OK (status: success)
    GW-->>FE: Hi·ªÉn th·ªã k·∫øt qu·∫£ g√°n th√†nh c√¥ng
```

**üìù Gi·∫£i th√≠ch chi ti·∫øt:**

1. Superadmin g·ª≠i y√™u c·∫ßu g√°n ng∆∞·ªùi d√πng (`user_id`) v√†o m·ªôt `tenant_id`, k√®m danh s√°ch `role_codes`.
2. API Gateway ƒë·ªãnh tuy·∫øn request t·ªõi User Service Master.
3. User Service Master ghi th√¥ng tin v√†o b·∫£ng `user_tenant_assignments`.
4. Sau khi ghi th√†nh c√¥ng, service ph√°t m·ªôt s·ª± ki·ªán `tenant_user_assigned` l√™n Pub/Sub, gi√∫p Sub User Service c·ªßa tenant t∆∞∆°ng ·ª©ng c√≥ th·ªÉ ƒë·ªìng b·ªô RBAC.
5. K·∫øt qu·∫£ tr·∫£ v·ªÅ cho frontend x√°c nh·∫≠n h√†nh ƒë·ªông ƒë√£ th√†nh c√¥ng.

**üîÅ Tr∆∞·ªùng h·ª£p l·ªói ti·ªÅm ·∫©n:**

* `user_id` kh√¥ng t·ªìn t·∫°i trong `users_global` ‚Üí 404.
* `tenant_id` kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng t·ªìn t·∫°i ‚Üí 400.
* L·ªói logic: ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c g√°n v√†o tenant ƒë√≥ ‚Üí 409 Conflict.

#### üîê Lu·ªìng 2: ƒêƒÉng nh·∫≠p Google OAuth2 ‚Äì y√™u c·∫ßu t·ª´ Auth Master

```mermaid
sequenceDiagram
    participant FE as Frontend (Superadmin Webapp)
    participant AuthM as Auth Service Master
    participant UserM as User Service Master

    FE->>AuthM: ƒêƒÉng nh·∫≠p Google (OAuth2)
    AuthM->>Google: Trao ƒë·ªïi token
    Google-->>AuthM: Tr·∫£ v·ªÅ user info (email, name,...)

    AuthM->>UserM: GET /users-global/by-email?email=...
    alt Kh√¥ng t√¨m th·∫•y
        AuthM->>UserM: POST /users-global (t·∫°o user)
    end

    AuthM->>UserM: GET /user-tenant-assignments?user_id=...
    UserM-->>AuthM: Tr·∫£ v·ªÅ danh s√°ch tenant ƒë√£ g√°n

    AuthM-->>FE: Tr·∫£ v·ªÅ danh s√°ch tenant ƒë·ªÉ ch·ªçn
```

‚û°Ô∏è Sau b∆∞·ªõc n√†y, AuthM s·∫Ω ti·∫øp t·ª•c g·ªçi Sub User Service t∆∞∆°ng ·ª©ng ƒë·ªÉ l·∫•y RBAC v√† ph√°t h√†nh JWT.

---

#### üß© Lu·ªìng 3: T·∫°o/C·∫≠p nh·∫≠t RBAC Template

```mermaid
sequenceDiagram
    participant FE as Superadmin Webapp
    participant Gateway as API Gateway
    participant UserM as User Service Master
    participant PubSub as GCP Pub/Sub

    FE->>Gateway: POST /rbac/templates (role/permission)
    Gateway->>UserM: POST /rbac/templates
    UserM->>DB: T·∫°o ho·∫∑c c·∫≠p nh·∫≠t b·∫£ng templates
    UserM->>PubSub: Publish event rbac_template_updated
    PubSub-->>SubUser: Trigger ƒë·ªìng b·ªô template
```

‚û°Ô∏è C√°c Sub User Service c√≥ th·ªÉ t·ª± ƒë·ªìng b·ªô ho·∫∑c hi·ªÉn th·ªã g·ª£i √Ω c·∫≠p nh·∫≠t template.

---

#### üë§ Lu·ªìng 4: Sub Auth Service t·∫°o user local m·ªõi v√† c·∫•p `user_id_global`

```mermaid
sequenceDiagram
    participant AuthT as Sub Auth Service
    participant Gateway as API Gateway
    participant UserM as User Service Master

    AuthT->>Gateway: POST /users-global (t·∫°o user local)
    Gateway->>UserM: POST /users-global
    UserM->>DB: T·∫°o user (auth_provider = 'local')
    UserM-->>Gateway: Tr·∫£ v·ªÅ user_id_global
    Gateway-->>AuthT: Tr·∫£ v·ªÅ user_id_global
```

‚û°Ô∏è AuthT sau ƒë√≥ s·∫Ω g√°n user v√†o tenant c·ªßa m√¨nh v√† ph√°t h√†nh JWT theo chu·∫©n ƒëa tenant.

---

## 4. M√¥ h√¨nh d·ªØ li·ªáu

C√°c b·∫£ng ch√≠nh do User Service Master qu·∫£n l√Ω bao g·ªìm:

- `users_global`: danh s√°ch ng∆∞·ªùi d√πng to√†n c·ª•c, g·∫Øn v·ªõi auth_provider.
- `tenants`: th√¥ng tin t·ª´ng tenant (tr∆∞·ªùng th√†nh vi√™n).
- `user_tenant_assignments`: li√™n k·∫øt ng∆∞·ªùi d√πng v·ªõi t·ª´ng tenant c·ª• th·ªÉ.
- `global_roles_templates`: danh s√°ch template vai tr√≤ to√†n c·ª•c.
- `global_permissions_templates`: danh s√°ch template quy·ªÅn to√†n c·ª•c.

### üß© S∆° ƒë·ªì ERD t·ªïng quan

```mermaid
erDiagram

    USERS_GLOBAL {
        UUID user_id PK
        TEXT full_name
        TEXT email
        TEXT auth_provider
    }

    TENANTS {
        TEXT tenant_id PK
        TEXT tenant_name
        TEXT status
    }

    USER_TENANT_ASSIGNMENTS {
        UUID id PK
        UUID user_id_global FK
        TEXT tenant_id FK
        TEXT role_codes
        BOOLEAN is_active
    }

    GLOBAL_ROLES_TEMPLATES {
        UUID template_id PK
        TEXT template_code
        TEXT description
    }

    GLOBAL_PERMISSIONS_TEMPLATES {
        UUID template_id PK
        TEXT permission_code
        TEXT action
        TEXT resource
        TEXT default_condition
    }

    USERS_GLOBAL ||--o{ USER_TENANT_ASSIGNMENTS : has
    TENANTS ||--o{ USER_TENANT_ASSIGNMENTS : includes
    GLOBAL_ROLES_TEMPLATES ||--o{ GLOBAL_PERMISSIONS_TEMPLATES : defines
```

üìù **Ghi ch√∫ quan tr·ªçng cho s∆° ƒë·ªì ERD:**

- `USER_TENANT_ASSIGNMENTS.role_codes`: L√† m·ªôt **m·∫£ng TEXT**. Mermaid kh√¥ng h·ªó tr·ª£ ki·ªÉu `TEXT[]`, n√™n ƒë∆∞·ª£c ghi l√† `TEXT` cho ƒë∆°n gi·∫£n.
- `GLOBAL_PERMISSIONS_TEMPLATES.default_condition`: L√† m·ªôt **tr∆∞·ªùng JSONB** d√πng ƒë·ªÉ ƒë·ªãnh nghƒ©a ƒëi·ªÅu ki·ªán RBAC. Mermaid ch·ªâ h·ªó tr·ª£ `TEXT`, n√™n c·∫ßn hi·ªÉu `TEXT default_condition` ·ªü ƒë√¢y l√† bi·ªÉu di·ªÖn c·ªßa JSONB.
- `email`, `template_code`, `permission_code`: C√≥ r√†ng bu·ªôc `UNIQUE` trong thi·∫øt k·∫ø th·ª±c t·∫ø ‚Äì kh√¥ng th·ªÉ hi·ªán trong s∆° ƒë·ªì Mermaid nh∆∞ng ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong migration script ho·∫∑c t√†i li·ªáu `data-model.md`.

üëâ Xem chi ti·∫øt ƒë·ªãnh nghƒ©a b·∫£ng t·∫°i: [`data-model.md`](./data-model.md)

---

## 5. API

User Service Master cung c·∫•p c√°c API ph·ª•c v·ª• cho:

- Superadmin Webapp: qu·∫£n l√Ω ƒë·ªãnh danh ng∆∞·ªùi d√πng v√† RBAC to√†n c·ª•c.
- Auth Service Master/Sub: tra c·ª©u, t·∫°o ng∆∞·ªùi d√πng to√†n c·ª•c.
- Sub User Service: ƒë·ªìng b·ªô danh s√°ch assignment, template RBAC.

Chi ti·∫øt ƒë·ªãnh nghƒ©a tham kh·∫£o t·∫°i [`interface-contract.md`](./interface-contract.md) v√† [`openapi.yaml`](./openapi.yaml).

### üìö B·∫£ng t√≥m t·∫Øt API ch√≠nh

| Method | Path                          | M√¥ t·∫£ ng·∫Øn                                      | Y√™u c·∫ßu quy·ªÅn                     |
|--------|-------------------------------|------------------------------------------------|----------------------------------|
| GET    | `/users-global/by-email`      | Tra c·ª©u ng∆∞·ªùi d√πng to√†n c·ª•c theo email         | Authenticated (Google)           |
| POST   | `/users-global`               | T·∫°o ng∆∞·ªùi d√πng to√†n c·ª•c m·ªõi                    | Authenticated (Google, OTP)      |
| GET    | `/tenants`                    | Li·ªát k√™ danh s√°ch c√°c tenant hi·ªán c√≥           | Superadmin                       |
| GET    | `/user-tenant-assignments`    | Tra c·ª©u c√°c tenant m√† ng∆∞·ªùi d√πng thu·ªôc v·ªÅ      | Auth Service / Admin Tenant     |
| POST   | `/user-tenant-assignments`    | G√°n ng∆∞·ªùi d√πng v√†o tenant c·ª• th·ªÉ               | Superadmin                       |
| GET    | `/global-roles-templates`     | Tra c·ª©u template vai tr√≤ to√†n c·ª•c              | Superadmin                       |
| POST   | `/global-roles-templates`     | T·∫°o m·ªõi template vai tr√≤ to√†n c·ª•c              | Superadmin                       |
| GET    | `/global-permissions-templates` | Tra c·ª©u template quy·ªÅn to√†n c·ª•c               | Superadmin                       |
| POST   | `/global-permissions-templates` | T·∫°o m·ªõi template quy·ªÅn to√†n c·ª•c               | Superadmin                       |

---

## 6. S·ª± ki·ªán ph√°t ra (Events)

User Service Master ph√°t c√°c s·ª± ki·ªán l√™n Google Cloud Pub/Sub ƒë·ªÉ:

- Th√¥ng b√°o cho c√°c Sub User Services v·ªÅ thay ƒë·ªïi RBAC.
- Cho ph√©p c√°c service kh√°c ƒë·ªìng b·ªô ƒë·ªãnh danh ng∆∞·ªùi d√πng v√† c·∫•u h√¨nh tenant.

### üì¢ Danh s√°ch s·ª± ki·ªán

#### 1. `tenant_user_assigned`

> Khi m·ªôt ng∆∞·ªùi d√πng ƒë∆∞·ª£c g√°n v√†o m·ªôt tenant m·ªõi.

```json
{
  "event_id": "evt_7a3a8b40",
  "event_type": "tenant_user_assigned",
  "user_id_global": "usr_12345678",
  "tenant_id": "vas-truong-a",
  "role_codes": ["teacher", "homeroom"],
  "assignment_status": "active",
  "timestamp": "2025-06-01T08:30:00Z"
}
```

* **Consumer:** Sub User Service c·ªßa tenant t∆∞∆°ng ·ª©ng
* **T√°c d·ª•ng:** T·ª± ƒë·ªông t·∫°o `users_in_tenant` v√† mapping role cho user trong tenant ƒë√≥
* **Y√™u c·∫ßu idempotency:** Sub Service ph·∫£i ki·ªÉm tra `event_id` ho·∫∑c `user_id + tenant_id` ƒë√£ x·ª≠ l√Ω hay ch∆∞a.

---

#### 2. `rbac_template_updated`

> Khi m·ªôt template vai tr√≤ ho·∫∑c quy·ªÅn to√†n c·ª•c ƒë∆∞·ª£c c·∫≠p nh·∫≠t.

```json
{
  "event_id": "evt_5baf6c2d",
  "event_type": "rbac_template_updated",
  "template_type": "permission",
  "template_id": "perm_tpl_001",
  "action": "create_or_update",
  "updated_by": "superadmin@vas.edu.vn",
  "timestamp": "2025-06-01T09:00:00Z"
}
```

* **Consumer:** Sub User Services c√≥ nhu c·∫ßu ƒë·ªìng b·ªô template
* **T√°c d·ª•ng:** Cho ph√©p Sub Service quy·∫øt ƒë·ªãnh c√≥ n√™n c·∫≠p nh·∫≠t local template kh√¥ng (ho·∫∑c g·ª£i √Ω cho admin c·∫≠p nh·∫≠t th·ªß c√¥ng)
* **G·ª£i √Ω th·ª±c thi:** C√≥ th·ªÉ l∆∞u l·∫°i trong b·∫£ng `rbac_template_sync_log` t·∫°i Sub Service ƒë·ªÉ ki·ªÉm so√°t phi√™n b·∫£n.

---

## 7. üîê B·∫£o m·∫≠t & Ph√¢n quy·ªÅn

`user-service/master` x·ª≠ l√Ω th√¥ng tin ƒë·ªãnh danh to√†n c·ª•c (Global User Identity), do ƒë√≥ y√™u c·∫ßu ch√≠nh s√°ch b·∫£o m·∫≠t v√† ki·ªÉm so√°t ph√¢n quy·ªÅn ch·∫∑t ch·∫Ω theo ki·∫øn tr√∫c RBAC ph√¢n t·∫ßng (xem chi ti·∫øt t·∫°i [`rbac-deep-dive.md`](../../architecture/rbac-deep-dive.md)).

---

### üõ°Ô∏è 7.1. Authentication (X√°c th·ª±c)

* T·∫•t c·∫£ c√°c endpoint ƒë·ªÅu y√™u c·∫ßu **JWT access token h·ª£p l·ªá**, do `auth-service/master` c·∫•p ph√°t.
* Token ƒë∆∞·ª£c x√°c th·ª±c t·∫°i API Gateway, s·ª≠ d·ª•ng public key t·ª´ `JWKS` endpoint.
* Service kh√¥ng decode token m√† d·ª±a v√†o gateway ƒë·ªÉ inject `X-User-ID`, `X-User-Role`, `X-Tenant-ID`.

---

### üß© 7.2. Authorization (Ph√¢n quy·ªÅn ƒë·ªông)

* H·ªá th·ªëng √°p d·ª•ng **RBAC 3 t·∫ßng**: `global`, `tenant`, v√† `scoped-role`.
* M·ªói endpoint ƒë·ªãnh nghƒ©a `x-required-permission`, v√≠ d·ª•:

```yaml
x-required-permission: user.read:any
```

* C√°c permission ƒë∆∞·ª£c mapping theo b·∫£ng sau:

| Permission         | M√¥ t·∫£                                 |
| ------------------ | ------------------------------------- |
| `user.read:any`    | Truy c·∫≠p th√¥ng tin b·∫•t k·ª≥ user n√†o    |
| `user.read:self`   | Truy c·∫≠p ch·ªâ th√¥ng tin c·ªßa ch√≠nh m√¨nh |
| `user.create`      | T·∫°o user m·ªõi to√†n c·ª•c                 |
| `user.update:any`  | S·ª≠a th√¥ng tin user b·∫•t k·ª≥             |
| `user.update:self` | S·ª≠a th√¥ng tin c·ªßa ch√≠nh m√¨nh          |

---

### üîê 7.3. B·∫£o v·ªá d·ªØ li·ªáu nh·∫°y c·∫£m

* Tr∆∞·ªùng `password`, `token`, `email_verified_at` ƒë·ªÅu ƒë∆∞·ª£c b·∫£o v·ªá:

  * `password` ch·ªâ ghi, kh√¥ng bao gi·ªù tr·∫£ v·ªÅ (g·∫Øn `writeOnly: true`)
  * Email ƒë∆∞·ª£c x√°c minh ·ªü `auth/master`, kh√¥ng l∆∞u l·∫°i trong `user/master`
* C√°c tr∆∞·ªùng c√≥ th·ªÉ b·ªã gi·ªõi h·∫°n truy c·∫≠p tu·ª≥ theo vai tr√≤:

  * `internal_notes` ch·ªâ hi·ªán v·ªõi `admin`, kh√¥ng hi·ªán v·ªõi `self`

---

### üîÅ 7.4. Audit Logging

* M·ªçi thao t√°c ghi (`POST`, `PATCH`, `DELETE`) ƒë·ªÅu emit s·ª± ki·ªán audit:

  * `user.created`, `user.updated`, `user.merged`
* Log audit ƒë∆∞·ª£c g·ª≠i qua Pub/Sub ‚Üí `audit-logging-service`, tu√¢n th·ªß [ADR-008](../../../ADR/adr-008-audit-logging.md)

---

### üîí 7.5. Internal Auth

* C√°c call n·ªôi b·ªô (v√≠ d·ª•: t·ª´ `auth-service/master`) s·ª≠ d·ª•ng `SERVICE_AUTH_TOKEN` v√† ƒë∆∞·ª£c ki·ªÉm tra t·∫°i gateway.
* Nh·ªØng API kh√¥ng d√†nh cho public (seed role, fetch global profile) c√≥ g·∫Øn:

```yaml
x-internal-only: true
x-service-auth-required: true
```

---

### üö´ 7.6. Rate Limiting & Abuse Prevention

* Gateway c·∫•u h√¨nh limit m·∫∑c ƒë·ªãnh: `100 req/min/user`
* C√°c endpoint nh·∫°y c·∫£m (t√¨m theo email, t·∫°o user) c√≥ th·ªÉ g·∫Øn limit ri√™ng.

---

## 8. ‚öôÔ∏è C·∫•u h√¨nh & Tri·ªÉn khai

### üîß Bi·∫øn m√¥i tr∆∞·ªùng

Service s·ª≠ d·ª•ng c·∫•u h√¨nh t·ª´ file `.env` (ho·∫∑c `settings/.env.<env>.template`) theo chu·∫©n h√≥a t·ª´ [ADR-005: Env Config](../../../ADR/adr-005-env-config.md). M·ªôt s·ªë bi·∫øn ch√≠nh:

| T√™n bi·∫øn               | M√¥ t·∫£                                                                 | V√≠ d·ª•                            |
| ---------------------- | --------------------------------------------------------------------- | -------------------------------- |
| `ENVIRONMENT`          | M√¥i tr∆∞·ªùng ch·∫°y (`local`, `staging`, `production`)                    | `staging`                        |
| `SERVICE_PORT`         | C·ªïng ch·∫°y service                                                     | `8000`                           |
| `DATABASE_URL`         | K·∫øt n·ªëi PostgreSQL                                                    | `postgresql://user:pass@host/db` |
| `REDIS_URL`            | K·∫øt n·ªëi Redis (cache session/token)                                   | `redis://localhost:6379/0`       |
| `SERVICE_AUTH_TOKEN`   | Token d√πng ƒë·ªÉ g·ªçi n·ªôi b·ªô gi·ªØa c√°c service (Auth Master ‚Üí User Master) | `secret-key`                     |
| `JWT_PUBLIC_KEY`       | Public key ƒë·ªÉ validate access token (d·∫°ng PEM)                        | ‚Äì                                |
| `GOOGLE_CLOUD_PROJECT` | Project ID d√πng cho Pub/Sub (n·∫øu b·∫≠t audit)                           | `dxvas-dev`                      |
| `LOG_LEVEL`            | M·ª©c log (`DEBUG`, `INFO`, ...)                                        | `INFO`                           |

üëâ To√†n b·ªô c√°c bi·∫øn ƒë∆∞·ª£c li·ªát k√™ v√† version h√≥a t·∫°i: `settings/.env.template`.

---

### üõ† C·∫•u tr√∫c th∆∞ m·ª•c c·∫•u h√¨nh

```bash
settings/
‚îú‚îÄ‚îÄ .env.template              # Bi·∫øn m√¥i tr∆∞·ªùng chu·∫©n (d√πng cho m·ªçi m√¥i tr∆∞·ªùng)
‚îú‚îÄ‚îÄ env.staging.yaml          # Override cho m√¥i tr∆∞·ªùng staging
‚îú‚îÄ‚îÄ env.production.yaml       # Override cho m√¥i tr∆∞·ªùng production
‚îî‚îÄ‚îÄ secrets.yaml              # Ch·ªâ ch·ª©a key nh·∫°y c·∫£m, inject t·ª´ Vault/SecretManager
```

* To√†n b·ªô file `yaml` ƒë·ªÅu ƒë∆∞·ª£c load t·ª± ƒë·ªông b·ªüi module config chu·∫©n trong `dx-core`.
* Secrets nh∆∞ `JWT_PRIVATE_KEY` KH√îNG ƒë∆∞·ª£c ghi tr·ª±c ti·∫øp v√†o `.env`, m√† ƒë∆∞·ª£c mount v√†o volume ho·∫∑c l·∫•y t·ª´ SecretManager (theo [ADR-003: Secrets](../../../ADR/adr-003-secrets.md)).

---

### üöÄ CI/CD & Tri·ªÉn khai

Tu√¢n th·ªß [ADR-001: CI/CD Pipeline](../../../ADR/adr-001-ci-cd.md):

| Th√†nh ph·∫ßn    | C√¥ng c·ª•                        | Ghi ch√∫                                               |
| ------------- | ------------------------------ | ----------------------------------------------------- |
| Build & test  | GitHub Actions                 | `test.yaml`, `lint.yaml` trong `.github/workflows/`   |
| Build image   | Docker, Poetry                 | Image t·ªëi ∆∞u t·ª´ `python:slim`, kh√¥ng include dev deps |
| Scan b·∫£o m·∫≠t  | `trivy`, `semgrep`             | T√≠ch h·ª£p v√†o CI                                       |
| Deploy        | ArgoCD                         | T·ª± ƒë·ªông rollout n·∫øu merge v√†o `main`                  |
| Observability | OpenTelemetry, Grafana, Sentry | Default g·∫Øn theo dx-core                              |
| Migration     | Alembic, trigger qua Argo Job  | T√°ch step migrate v√† deploy r√µ r√†ng                   |

---

üìå ƒê·ªÉ ch·∫°y service c·ª•c b·ªô:

```bash
cp settings/.env.template .env
docker-compose up -d postgres redis
make run
```

---

## 9. üß™ Chi·∫øn l∆∞·ª£c Test

Vi·ªác ki·ªÉm th·ª≠ `user-service/master` ƒë∆∞·ª£c t·ªï ch·ª©c theo **chi·∫øn l∆∞·ª£c ki·ªÉm th·ª≠ ƒëa t·∫ßng**, ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng t·ª´ m·ª©c ƒë·ªô logic n·ªôi b·ªô ƒë·∫øn t√≠ch h·ª£p li√™n service, ƒë·ªìng th·ªùi c√≥ th·ªÉ ch·∫°y hi·ªáu qu·∫£ trong CI/CD pipeline.

---

### ‚úÖ 9.1. Unit Test

* Ph·∫°m vi:

  * X·ª≠ l√Ω logic nghi·ªáp v·ª•: t·∫°o user, validate d·ªØ li·ªáu, ph√¢n quy·ªÅn ƒë·ªông
  * Format h√≥a response v√† m√£ l·ªói theo ADR-012
* C√¥ng c·ª•: `pytest + pytest-mock`
* M·ªói PR m·ªõi ƒë·ªÅu b·∫Øt bu·ªôc ch·∫°y qua test suite n√†y trong GitHub Actions (`test.yaml`)
* Y√™u c·∫ßu coverage ‚â• **85%**

---

### ‚úÖ 9.2. Contract Test (Consumer-Driven)

Tu√¢n th·ªß [ADR-010: Contract Testing](../../../ADR/adr-010-contract-testing.md)

* Ki·ªÉm th·ª≠ t∆∞∆°ng th√≠ch gi·ªØa `user-service/master` v√† c√°c consumer (v√≠ d·ª•: `auth/master`, `api-gateway`)
* D√πng `pact-python`, publish pact file l√™n `pact-broker`
* CI s·∫Ω **fail n·∫øu producer l√†m g√£y contract**
* B·∫Øt bu·ªôc c√≥ contract test cho c√°c API:

  * `GET /users-global/{id}`
  * `POST /users-global`
  * `GET /users-global/by-email`

---

### ‚úÖ 9.3. Integration Test (Service level)

* Spin-up to√†n b·ªô stack (PostgreSQL, Redis, user-service) trong Docker Compose
* Ch·∫°y c√°c test query + mutation logic ƒë·∫ßy ƒë·ªß (bao g·ªìm validate RBAC, ph√¢n quy·ªÅn)
* D√πng `httpx` ho·∫∑c `pytest-httpx` ƒë·ªÉ test end-to-end response format
* ƒê·∫£m b·∫£o emit ƒë√∫ng c√°c s·ª± ki·ªán (`user.created`, `user.duplicated`, `user.updated`) qua Pub/Sub mock

---

### ‚úÖ 9.4. Load & Performance Test (T√πy ch·ªçn)

* D√πng `locust` ho·∫∑c `k6` ƒë·ªÉ test throughput c·ªßa c√°c API truy xu·∫•t h√†ng lo·∫°t (pagination, filter)
* ∆Ø·ªõc l∆∞·ª£ng ng∆∞·ª°ng t·ªëi ∆∞u: 1000 req/s v·ªõi latency P95 < 200ms
* Gi√∫p tune indexing, limit-offset, caching Redis user\_id ‚Üí full profile

---

### ‚úÖ 9.5. Security Test

* `pytest` v·ªõi c√°c case ƒë·∫∑c bi·ªát: kh√¥ng c√≥ token, token sai scope, sai tenant
* K·∫øt h·ª£p `semgrep` ƒë·ªÉ ph√°t hi·ªán hardcoded secrets, l·ªói injection
* Test `user.read:self` vs `user.read:any` ƒë·ªÉ x√°c minh ph√¢n quy·ªÅn ƒë·ªông

---

### üß™ B√°o c√°o & T√≠ch h·ª£p CI

* Test ch·∫°y qua `make test`, `make test-contract`, `make test-int`
* K·∫øt qu·∫£ publish l√™n `coverage.xml`, `junit.xml`, t√≠ch h·ª£p GitHub Checks
* Pact Broker: `https://pact.dxvas.vn`
* Allure Report: T√πy ch·ªçn publish khi ch·∫°y full test suite

> üß† M·ªçi k·ªãch b·∫£n test c·∫ßn bao g·ªìm tr∆∞·ªùng h·ª£p th√†nh c√¥ng, l·ªói logic, v√† l·ªói h·ªá th·ªëng (timeout, l·ªói DB, l·ªói Pub/Sub...).

---

## 10. üìà Quan s√°t & Gi√°m s√°t

H·ªá th·ªëng quan s√°t (observability) c·ªßa `user-service/master` gi√∫p ƒë·∫£m b·∫£o kh·∫£ nƒÉng ph√°t hi·ªán l·ªói s·ªõm, ƒëo l∆∞·ªùng s·ª©c kh·ªèe h·ªá th·ªëng v√† h·ªó tr·ª£ ph√¢n t√≠ch h√†nh vi ng∆∞·ªùi d√πng ph·ª•c v·ª• v·∫≠n h√†nh ƒëa tenant hi·ªáu qu·∫£.

---

### üìä 10.1. Logging

* **Chu·∫©n log JSON** theo `dx-core`, ƒë·ªãnh d·∫°ng:
  `{ timestamp, level, service, trace_id, span_id, user_id, tenant_id, msg, extra... }`
* T√≠ch h·ª£p OpenTelemetry ƒë·ªÉ ƒë√≠nh k√®m `trace_id`, `span_id` theo chu·∫©n OTEL.
* Log ƒë∆∞·ª£c g·ª≠i v·ªÅ:

  * Dev: `stdout` ‚Üí Loki/Grafana
  * Prod: GCP Logging ho·∫∑c OpenObserve

| Level   | M·ª•c ƒë√≠ch                                    |
| ------- | ------------------------------------------- |
| `INFO`  | Thao t√°c th√¥ng th∆∞·ªùng                       |
| `WARN`  | Thao t√°c sai, kh√¥ng l√†m crash               |
| `ERROR` | Exception, database l·ªói, s·ª± c·ªë nghi√™m tr·ªçng |
| `DEBUG` | G·ª° l·ªói (ch·ªâ b·∫≠t khi local/dev)              |

---

### üìà 10.2. Metrics

* S·ª≠ d·ª•ng `Prometheus` exporter th√¥ng qua `dx-core.metrics`.
* M·ªôt s·ªë metrics quan tr·ªçng:

| Metric                            | Lo·∫°i      | Nh√£n                 | Ghi ch√∫                        |
| --------------------------------- | --------- | -------------------- | ------------------------------ |
| `http_requests_total`             | Counter   | path, method, status | T·ªïng s·ªë request                |
| `http_request_duration_seconds`   | Histogram | path, method         | ƒê·ªô tr·ªÖ                         |
| `user_create_success_total`       | Counter   | tenant\_id           | T·∫°o user th√†nh c√¥ng            |
| `user_lookup_by_email_miss_total` | Counter   | ‚Äì                    | Kh√¥ng t√¨m th·∫•y user theo email |
| `db_query_duration_seconds`       | Histogram | model, operation     | Theo d√µi hi·ªáu nƒÉng DB          |

---

### üîê 10.3. Audit Logging

Tu√¢n th·ªß [ADR-008](../../../ADR/adr-008-audit-logging.md):

* Emit c√°c s·ª± ki·ªán audit d·∫°ng Pub/Sub:

  * `user.created`
  * `user.updated`
  * `user.duplicated`
* M·ªói event bao g·ªìm: `actor_id`, `target_user_id`, `tenant_id`, `action`, `changes`
* ƒê∆∞·ª£c forward sang `audit-logging-service` ƒë·ªÉ l∆∞u DB ri√™ng (GCP BigQuery ho·∫∑c PostgreSQL ph√¢n v√πng)

* T·∫•t c·∫£ c√°c thao t√°c thay ƒë·ªïi d·ªØ li·ªáu li√™n quan ƒë·∫øn ng∆∞·ªùi d√πng v√† tenant ƒë·ªÅu ƒë∆∞·ª£c ghi l·∫°i th√¥ng qua Audit Logging Service, bao g·ªìm:

    - `user.created`, `user.updated`, `user.deleted`
    - `user_tenant_assignment.created`
    - `tenant.created`, `tenant.status_changed`
    - `role_template.updated`, `permission_template.updated`

* Log bao g·ªìm:
    - `actor_id`, `tenant_id`, `action`, `target_table`, `before`, `after`, `timestamp`
    - Request `X-Request-ID` ƒë·ªÉ truy v·∫øt qua to√†n h·ªá th·ªëng

---

### üí∞ 10.4. Cost Observability (Billing)

√Åp d·ª•ng [ADR-020](../../../ADR/adr-020-cost-observability.md):

* T·ª± ƒë·ªông emit s·ª± ki·ªán `usage.user.query` v√† `usage.user.create`
* H·ªó tr·ª£ billing theo s·ªë l·∫ßn truy c·∫≠p d·ªØ li·ªáu `global user` c·ªßa m·ªói tenant
* C√°c service kh√°c (nh∆∞ SIS, CRM) c√≥ th·ªÉ t√≠ch h·ª£p c√°c s·ª± ki·ªán n√†y ƒë·ªÉ ∆∞·ªõc l∆∞·ª£ng chi ph√≠

---

### üß™ 10.5. Health Check & Alert

* Endpoint: `GET /healthz` (c√≥ th·ªÉ b·ªï sung `/readyz`)
* T√≠ch h·ª£p:

  * Argo Rollout ‚Üí ki·ªÉm tra tr∆∞·ªõc khi scale
  * GCP Cloud Monitoring ‚Üí alert theo latency v√† error rate

---

## 11. üöÄ ƒê·ªô tin c·∫≠y & Ph·ª•c h·ªìi

`user-service/master` ƒë√≥ng vai tr√≤ then ch·ªët trong h·ªá th·ªëng ƒë·ªãnh danh to√†n c·ª•c, do ƒë√≥ ƒë∆∞·ª£c thi·∫øt k·∫ø v·ªõi m·ª•c ti√™u **kh·∫£ d·ª•ng cao (HA)**, ƒë·∫£m b·∫£o **kh√¥ng m·∫•t d·ªØ li·ªáu** v√† **kh√¥ng gi√°n ƒëo·∫°n khi c·∫≠p nh·∫≠t**.

---

### üß± 11.1. Tri·ªÉn khai kh√¥ng gi√°n ƒëo·∫°n (Zero Downtime)

Tu√¢n th·ªß [ADR-014: Zero Downtime](../../../ADR/adr-014-zero-downtime.md):

* S·ª≠ d·ª•ng chi·∫øn l∆∞·ª£c rollout `blue-green` ho·∫∑c `canary` qua Argo Rollouts.
* Endpoint `GET /healthz` + probe readiness ki·ªÉm tra DB + Redis + Pub/Sub.
* Th·ª±c hi·ªán shadow traffic test tr∆∞·ªõc khi 100% chuy·ªÉn route.

---

### ‚öôÔ∏è 11.2. Ch√≠nh s√°ch tri·ªÉn khai

Theo [ADR-015: Deployment Strategy](../../../ADR/adr-015-deployment-strategy.md) v√† [ADR-018: Release Approval](../../../ADR/adr-018-release-approval-policy.md):

* M·ªçi release ƒë·ªÅu y√™u c·∫ßu:

  * Pass CI (`unit`, `contract`, `integration`)
  * ƒê∆∞·ª£c duy·ªát b·ªüi reviewer k·ªπ thu·∫≠t
  * G·∫Øn tag version (`v2.x.x`)
* T·ª± ƒë·ªông deploy n·∫øu PR merge v√†o `main` v√† c√≥ tag.

---

### ‚ôªÔ∏è 11.3. Auto Scaling

Tu√¢n th·ªß [ADR-016: Auto Scaling](../../../ADR/adr-016-auto-scaling.md):

* S·ª≠ d·ª•ng HPA (Horizontal Pod Autoscaler) theo:

  * CPU: ‚â• 70%
  * Request QPS: ‚â• 500 req/s
* Gi·ªõi h·∫°n min 2 replica, max 10 (c√≥ th·ªÉ override theo tenant load)

---

### üíæ 11.4. D·ª± ph√≤ng d·ªØ li·ªáu & recovery

* To√†n b·ªô d·ªØ li·ªáu l∆∞u t·∫°i PostgreSQL ph√¢n v√πng theo tenant\_id.
* Backup qua Cloud SQL export ƒë·ªãnh k·ª≥ (6 gi·ªù/l·∫ßn).
* M·ªói thay ƒë·ªïi ng∆∞·ªùi d√πng ƒë·ªÅu ph√°t `user.updated` ‚Üí c√≥ th·ªÉ sync v√†o h·ªá th·ªëng ph·ª• nh∆∞ CRM/LMS/SIS ƒë·ªÉ ƒë·∫£m b·∫£o redundancy.

---

### ‚ö° 11.5. Retry & Timeouts

* Giao ti·∫øp n·ªôi b·ªô gi·ªØa services c√≥ timeout 3s + retry 2 l·∫ßn (exponential backoff).
* N·∫øu `user.master` kh√¥ng ph·∫£n h·ªìi:

  * Gateway tr·∫£ l·ªói `503` v·ªõi m√£ `user.service_unavailable`
  * Ghi log + emit alert

---

### üîÑ 11.6. Rollback & Observability

* N·∫øu rollout l·ªói (readiness probe fail > 20s), t·ª± ƒë·ªông rollback v·ªÅ version tr∆∞·ªõc.
* T√≠ch h·ª£p OpenTelemetry ƒë·ªÉ debug l·ªói multi-hop: t·ª´ gateway ‚Üí auth ‚Üí user.

---

## 12. ‚ö°Ô∏è Hi·ªáu nƒÉng & Kh·∫£ nƒÉng m·ªü r·ªông

`user-service/master` ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ ph·ª•c v·ª• truy v·∫•n user to√†n c·ª•c ƒëa tenant, v·ªõi kh·∫£ nƒÉng scale linh ho·∫°t v√† ƒë√°p ·ª©ng h√†ng tri·ªáu b·∫£n ghi. M·ªçi th√†nh ph·∫ßn t·ª´ l∆∞u tr·ªØ, cache ƒë·∫øn API ƒë·ªÅu ƒë∆∞·ª£c t·ªëi ∆∞u ƒë·ªÉ ƒë·∫£m b·∫£o throughput cao, latency th·∫•p v√† h·ªó tr·ª£ m·ªü r·ªông theo chi·ªÅu ngang.

---

### ‚ö° 12.1. Truy v·∫•n t·ªëi ∆∞u & indexing

* C√°c API th∆∞·ªùng xuy√™n s·ª≠ d·ª•ng nh∆∞:

  * `GET /users-global/by-email`
  * `GET /users-global/by-phone`
  * `GET /users-global/{id}`
    ƒë·ªÅu ƒë∆∞·ª£c t·ªëi ∆∞u th√¥ng qua **index ph·ª©c h·ª£p** (`email, tenant_id`, `phone_number, tenant_id`).
* C∆° ch·∫ø filter s·ª≠ d·ª•ng `tenant_id` nh∆∞ ƒëi·ªÅu ki·ªán b·∫Øt bu·ªôc ƒë·ªÉ ƒë·∫£m b·∫£o query nhanh v√† c√°ch ly d·ªØ li·ªáu.

---

### üß† 12.2. Caching th√¥ng minh

* Redis layer ƒë·ªÉ cache c√°c b·∫£n ghi ng∆∞·ªùi d√πng ph·ªï bi·∫øn (d·ª±a v√†o LRU ho·∫∑c Top-K queries).
* TTL m·∫∑c ƒë·ªãnh: 15 ph√∫t. C√≥ c∆° ch·∫ø invalidate khi c√≥ `user.updated`.
* D·ªØ li·ªáu cache:

  * `user_id ‚Üí profile`
  * `email/phone ‚Üí user_id`
* C∆° ch·∫ø warming cache khi kh·ªüi ƒë·ªông ƒë·ªÉ tƒÉng cold-start performance.

---

### üöÄ 12.3. H·ªó tr·ª£ ph√¢n trang l·ªõn (deep pagination)

* D√πng c∆° ch·∫ø **seek-based pagination** (trang theo `created_at` ho·∫∑c `user_id`) ƒë·ªÉ tr√°nh hi·ªáu nƒÉng k√©m khi offset l·ªõn.
* Default limit: 20. Max limit: 1000.
* C√≥ h·ªó tr·ª£ c·∫£ offset pagination cho use-case qu·∫£n tr·ªã vi√™n.

---

### ‚öôÔ∏è 12.4. Horizontal Scaling

* Service stateless ‚Üí c√≥ th·ªÉ scale theo replica (tu√¢n th·ªß [ADR-016](../../../ADR/adr-016-auto-scaling.md))
* Redis + PostgreSQL c√≥ th·ªÉ t√°ch c·ª•m theo workload:

  * Redis: scale theo s·ªë l∆∞·ª£ng hot user
  * Postgres: c√≥ th·ªÉ sharding theo `tenant_id` n·∫øu v∆∞·ª£t qu√° ng∆∞·ª°ng

---

### üìâ 12.5. Theo d√µi hi·ªáu nƒÉng

* Metrics Prometheus:

  * `http_request_duration_seconds`
  * `user.lookup_latency_p95`
  * `db_user_query_duration_seconds`
* C·∫£nh b√°o n·∫øu:

  * `P95 > 200ms` trong 5 ph√∫t
  * `cache_miss_rate > 30%` trong 10 ph√∫t

---

### üß™ 12.6. Benchmark & Load test

* D√πng `k6` ƒë·ªÉ test v·ªõi 1 tri·ªáu user, 1000 req/s trong 10 ph√∫t:

  * `P95 < 150ms`, `success_rate > 99.9%`
* Test profile:

  * 90% `GET`
  * 8% `POST`
  * 2% `PATCH`

---

## 13. üß© Ki·∫øn tr√∫c Service

`user-service/master` l√† m·ªôt th√†nh ph·∫ßn **core multi-tenant**, ch·ªãu tr√°ch nhi·ªám qu·∫£n l√Ω danh t√≠nh to√†n c·ª•c cho ng∆∞·ªùi d√πng tr√™n to√†n h·ªá th·ªëng VAS, bao g·ªìm: ID ƒë·ªãnh danh, t√†i kho·∫£n g·ªëc, v√† th√¥ng tin li√™n k·∫øt gi·ªØa ng∆∞·ªùi d√πng v·ªõi c√°c tenant. Service n√†y ho·∫°t ƒë·ªông ƒë·ªôc l·∫≠p v·ªõi c√°c sub-service tenant-specific, v√† l√† ngu·ªìn d·ªØ li·ªáu g·ªëc ph·ª•c v·ª• `auth-service/master`, `token-service` v√† h·ªá th·ªëng SMS m·ªõi t√≠ch h·ª£p.

---

### üß≠ 13.1. S∆° ƒë·ªì ki·∫øn tr√∫c c·∫≠p nh·∫≠t (tu√¢n CR-04)

```mermaid
flowchart TD
  subgraph Core Services
    GATEWAY[API Gateway]
    AUTH_MASTER[Auth Service - Master]
    USER_MASTER[User Service - Master]
    TOKEN[Token Service]
    AUDIT[Audit Logging Service]
  end

  subgraph Data Layer
    PG_GLOBAL[(PostgreSQL - Global)]
    REDIS[(Redis)]
  end

  subgraph Tenant System
    SMS[(School Management System)]
  end

  GATEWAY -->|JWT + RBAC + X-Tenant-ID| AUTH_MASTER
  GATEWAY -->|RBAC + Route| USER_MASTER

  AUTH_MASTER -->|Lookup user| USER_MASTER
  USER_MASTER -->|Read/write| PG_GLOBAL
  USER_MASTER -->|Cache email/user_id| REDIS
  USER_MASTER -->|Emit user.created/updated| PUBSUB[(Pub/Sub)]
  USER_MASTER --> AUDIT

  PUBSUB --> SMS
```

---

### üß© 13.2. Th√†nh ph·∫ßn ch√≠nh

| Th√†nh ph·∫ßn            | Vai tr√≤                                                   |
| --------------------- | --------------------------------------------------------- |
| `FastAPI`             | Framework tri·ªÉn khai HTTP API                             |
| `PostgreSQL` (global) | L∆∞u tr·ªØ ch√≠nh th√¥ng tin ng∆∞·ªùi d√πng to√†n c·ª•c               |
| `Redis`               | TƒÉng t·ªëc truy xu·∫•t `email ‚Üí user_id`, `user_id ‚Üí profile` |
| `Pub/Sub`             | Ph√°t s·ª± ki·ªán cho c√°c h·ªá th·ªëng downstream nh∆∞ `SMS`        |
| `Audit Logging`       | Ghi nh·∫≠n thay ƒë·ªïi user ph·ª•c v·ª• ki·ªÉm tra v√† compliance     |

---

### ‚öôÔ∏è 13.3. C·∫•u tr√∫c th∆∞ m·ª•c

```bash
user-service/
‚îú‚îÄ‚îÄ main.py                  # Entry point ch√≠nh
‚îú‚îÄ‚îÄ api/                     # Router FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ global_users.py      # ƒê·ªãnh nghƒ©a endpoint /users-global/*
‚îú‚îÄ‚îÄ models/                  # ORM models
‚îú‚îÄ‚îÄ schemas/                 # Request/response schemas
‚îú‚îÄ‚îÄ services/                # Business logic: user creation, update, conflict detection
‚îú‚îÄ‚îÄ events/                  # Emit Pub/Sub events
‚îú‚îÄ‚îÄ core/                    # C·∫•u h√¨nh, middleware, utils
‚îî‚îÄ‚îÄ tests/                   # Ki·ªÉm th·ª≠ unit & integration
```

---

### üîÑ 13.4. Giao ti·∫øp & t√≠ch h·ª£p

| D·ªãch v·ª•                 | M·ª•c ƒë√≠ch                                                                       |
| ----------------------- | ------------------------------------------------------------------------------ |
| `auth-service/master`   | X√°c th·ª±c ng∆∞·ªùi d√πng, g·ªçi `GET /users-global/by-email`                          |
| `token-service`         | Cung c·∫•p JWT token v·ªõi `user_id` to√†n c·ª•c                                      |
| `API Gateway`           | √Åp d·ª•ng RBAC & inject c√°c header (`X-User-ID`, `X-Permissions`, `X-Tenant-ID`) |
| `SMS (Tenant)`          | Ti√™u th·ª• s·ª± ki·ªán `user.created`, `user.updated` ƒë·ªÉ sync user profile           |
| `audit-logging-service` | Nh·∫≠n log t·ª´ m·ªçi h√†nh ƒë·ªông c·∫≠p nh·∫≠t, t·∫°o user                                   |

---

### üì£ 13.5. C√°c s·ª± ki·ªán ph√°t ra

Tu√¢n chu·∫©n ƒë·ªãnh danh s·ª± ki·ªán t·ª´ \[ADR-030: Event Schema Governance]:

| S·ª± ki·ªán           | Khi n√†o ph√°t                            | Payload                                      |
| ----------------- | --------------------------------------- | -------------------------------------------- |
| `user.created`    | Khi t·∫°o user m·ªõi to√†n c·ª•c               | `{ user_id, email, created_by, timestamp }`  |
| `user.updated`    | Khi c·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng       | `{ user_id, fields_changed, updated_by }`    |
| `user.duplicated` | Khi ph√°t hi·ªán tr√πng th√¥ng tin ƒë·ªãnh danh | `{ conflict_user_ids, resolution_strategy }` |

---

## 14. T√†i li·ªáu li√™n quan

| T√™n t√†i li·ªáu                                | M√¥ t·∫£ ng·∫Øn g·ªçn                                                                 |
|---------------------------------------------|--------------------------------------------------------------------------------|
| [rbac-deep-dive.md](../../../architecture/rbac-deep-dive.md) | M√¥ t·∫£ chi ti·∫øt ki·∫øn tr√∫c RBAC, c√°c b·∫£ng li√™n quan v√† s∆° ƒë·ªì quy·ªÅn              |
| [adr-007-rbac.md](../../../ADR/adr-007-rbac.md)     | Quy·∫øt ƒë·ªãnh thi·∫øt k·∫ø ki·∫øn tr√∫c RBAC ph√¢n t·∫ßng theo m√¥ h√¨nh Master-Sub          |
| [adr-006-auth-strategy.md](../../../ADR/adr-006-auth-strategy.md) | M√¥ t·∫£ chi·∫øn l∆∞·ª£c x√°c th·ª±c, JWT v√† vai tr√≤ c·ªßa User Service Master/Sub         |
| [Data Model](./data-model.md)             | Chi ti·∫øt c√°c b·∫£ng CSDL ƒë∆∞·ª£c qu·∫£n l√Ω b·ªüi User Service Master                  |
| [Interface Contract](./interface-contract.md) | H·ª£p ƒë·ªìng API ƒë·ªãnh nghƒ©a r√µ input/output, auth, m√£ l·ªói c·ªßa c√°c endpoint       |
| [OpenAPI](./openapi.yaml)               | File ƒë·∫∑c t·∫£ OpenAPI k·ªπ thu·∫≠t d√πng ƒë·ªÉ t·∫°o SDK/Client/Docs t·ª± ƒë·ªông             |
| [system-diagrams.md](../../../architecture/system-diagrams.md) | S∆° ƒë·ªì ki·∫øn tr√∫c t·ªïng th·ªÉ h·ªá th·ªëng, c√°c service v√† d√≤ng t∆∞∆°ng t√°c             |
| [README.md](../../../README.md)              | T√†i li·ªáu ki·∫øn tr√∫c t·ªïng quan, m·ª•c ti√™u t·ªïng th·ªÉ v√† c√°c nguy√™n l√Ω thi·∫øt k·∫ø     |
