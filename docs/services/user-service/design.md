# User Service ‚Äì Thi·∫øt k·∫ø chi ti·∫øt

## 1. Scope & Responsibilities

**M√¥ t·∫£ ng·∫Øn:**
User Service l√† service c·ªët l√µi c·ªßa h·ªá th·ªëng dx-vas, ch·ªãu tr√°ch nhi·ªám qu·∫£n l√Ω th√¥ng tin ƒë·ªãnh danh, tr·∫°ng th√°i v√† ph√¢n quy·ªÅn ng∆∞·ªùi d√πng (RBAC). ƒê√¢y l√† trung t√¢m ph√¢n quy·ªÅn ƒë·ªông (condition-based), l√† n∆°i duy nh·∫•t ghi nh·∫≠n user-role-permission mapping.

### Tr√°ch nhi·ªám ch√≠nh:

- Qu·∫£n l√Ω d·ªØ li·ªáu ƒë·ªãnh danh ng∆∞·ªùi d√πng:
  - `user_id`, `name`, `email`, `type`, `status`, `created_at`, `updated_at`
- Qu·∫£n l√Ω tr·∫°ng th√°i t√†i kho·∫£n: `pending`, `active`, `inactive`, `deleted`
- Ph√¢n quy·ªÅn ƒë·ªông (RBAC):
  - Qu·∫£n l√Ω `roles`, `permissions`
  - Mapping user ‚Üí roles ‚Üí permissions (v·ªõi `condition`)
- Cung c·∫•p API cho API Gateway ki·ªÉm tra quy·ªÅn (qua Redis ho·∫∑c API fallback)
- Ph√°t s·ª± ki·ªán `rbac_updated`, `user_status_changed` ƒë·ªÉ ƒë·ªìng b·ªô RBAC cache t·∫°i Gateway

### Kh√¥ng ch·ªãu tr√°ch nhi·ªám:

- ƒêƒÉng nh·∫≠p / x√°c th·ª±c ng∆∞·ªùi d√πng (thu·ªôc Auth Service)
- G·ª≠i th√¥ng b√°o (thu·ªôc Notification Service)
- Truy xu·∫•t th√¥ng tin h·ªçc sinh / ph·ª• huynh (thu·ªôc SIS)

### T√≠ch h·ª£p:

- Redis Cache: ƒë·ªÉ ƒë·∫©y RBAC user snapshot ph·ª•c v·ª• API Gateway
- Pub/Sub: ƒë·ªÉ publish c√°c s·ª± ki·ªán `user_status_changed`, `rbac_updated`
- Cloud SQL (PostgreSQL): l∆∞u tr·ªØ d·ªØ li·ªáu ch√≠nh

---

## 2. API Specification

C√°c API c·ªßa User Service ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a chi ti·∫øt trong file OpenAPI t·∫°i:
üëâ [`openapi.yaml`](../../../openapi/user-service/openapi.yaml)

### M√¥ t·∫£ t·ªïng quan:

| Method | Path                          | M√¥ t·∫£ ng·∫Øn                                        |
|--------|-------------------------------|--------------------------------------------------|
| GET    | `/users`                      | L·∫•y danh s√°ch ng∆∞·ªùi d√πng, c√≥ ph√¢n trang & l·ªçc   |
| POST   | `/users`                      | T·∫°o ng∆∞·ªùi d√πng m·ªõi (ch·ªâ d√†nh cho Admin Service) |
| GET    | `/users/{id}`                | L·∫•y chi ti·∫øt ng∆∞·ªùi d√πng                          |
| PATCH  | `/users/{id}`                | C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng                    |
| PATCH  | `/users/{id}/status`         | C·∫≠p nh·∫≠t tr·∫°ng th√°i ho·∫°t ƒë·ªông (is_active)       |
| GET    | `/users/{id}/permissions`    | L·∫•y danh s√°ch quy·ªÅn c·ªßa user (g·ªìm condition)    |
| GET    | `/users/{id}/permissions/raw`| L·∫•y full RBAC raw (roles, permissions, mapping) |

### Quy ∆∞·ªõc tr·∫£ v·ªÅ:

- Tu√¢n theo c·∫•u tr√∫c chu·∫©n ƒë√£ m√¥ t·∫£ trong `backend-dev-guide.md`
- Lu√¥n b·ªçc k·∫øt qu·∫£ trong `DataEnvelope`, l·ªói trong `ErrorEnvelope`
- M√£ l·ªói ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a th·ªëng nh·∫•t trong h·ªá th·ªëng (4xx, 5xx)

### B·∫£o m·∫≠t & ph√¢n quy·ªÅn:

- C√°c endpoint y√™u c·∫ßu JWT h·ª£p l·ªá t·ª´ Gateway
- M·ªôt s·ªë endpoint y√™u c·∫ßu `X-Permissions` t∆∞∆°ng ·ª©ng (`user:read`, `user:update`, `rbac:view`, v.v.)
- RBAC ƒë∆∞·ª£c ki·ªÉm tra b·ªüi Gateway d·ª±a tr√™n d·ªØ li·ªáu t·ª´ Redis ho·∫∑c fallback qua `GET /users/{id}/permissions`

üìå Chi ti·∫øt schema input/output vui l√≤ng xem t·∫°i [`openapi.yaml`](../../../openapi/user-service/openapi.yaml)

---

## 3. Data Model

üìÑ Chi ti·∫øt b·∫£ng CSDL ƒë∆∞·ª£c m√¥ t·∫£ trong [`data-model.md`](./data-model.md)

### T·ªïng quan c√°c b·∫£ng ch√≠nh:

| B·∫£ng             | M√¥ t·∫£ ch·ª©c nƒÉng                                      |
|------------------|-------------------------------------------------------|
| `users`          | L∆∞u th√¥ng tin ng∆∞·ªùi d√πng v√† tr·∫°ng th√°i ho·∫°t ƒë·ªông      |
| `roles`          | ƒê·ªãnh nghƒ©a c√°c vai tr√≤ h·ªá th·ªëng (admin, teacher, ...)|
| `permissions`    | ƒê·ªãnh nghƒ©a c√°c quy·ªÅn chi ti·∫øt, g·ªìm `condition` JSONB |
| `user_role`      | Mapping nhi·ªÅu-nhi·ªÅu gi·ªØa ng∆∞·ªùi d√πng v√† vai tr√≤       |
| `role_permission`| Mapping nhi·ªÅu-nhi·ªÅu gi·ªØa vai tr√≤ v√† quy·ªÅn            |

### Ghi ch√∫ thi·∫øt k·∫ø:

- **RBAC ƒë·ªông:** c·ªôt `condition` trong b·∫£ng `permissions` l√† ki·ªÉu `JSONB`, cho ph√©p ƒë·ªãnh nghƒ©a c√°c ƒëi·ªÅu ki·ªán linh ho·∫°t (xem th√™m trong [`rbac-deep-dive.md`](../../architecture/rbac-deep-dive.md#5-permission-c√≥-ƒëi·ªÅu-ki·ªán-condition-jsonb))
- **T√≠nh nh·∫•t qu√°n:** c√°c thay ƒë·ªïi li√™n quan ƒë·∫øn ph√¢n quy·ªÅn s·∫Ω ph√°t s·ª± ki·ªán `rbac_updated`, c√°c thay ƒë·ªïi tr·∫°ng th√°i ng∆∞·ªùi d√πng s·∫Ω ph√°t `user_status_changed`
- **M√£ ƒë·ªãnh danh:** t·∫•t c·∫£ b·∫£ng ƒë·ªÅu s·ª≠ d·ª•ng UUID (`uuid4`) l√†m kh√≥a ch√≠nh
- **Truy v·∫øt & log:** b·∫£ng `users` c√≥ th·ªÉ m·ªü r·ªông th√™m c√°c c·ªôt `created_at`, `updated_at`, `last_login_at` ƒë·ªÉ ph·ª•c v·ª• m·ª•c ƒë√≠ch audit/log

üìå Xem chi ti·∫øt c√°c c·ªôt, ch·ªâ m·ª•c, r√†ng bu·ªôc trong [`data-model.md`](./data-model.md)

---

## 4. Business Logic Flows

User Service kh√¥ng ch·ªâ l∆∞u tr·ªØ th√¥ng tin ng∆∞·ªùi d√πng m√† c√≤n l√† trung t√¢m ƒëi·ªÅu ph·ªëi ph√¢n quy·ªÅn ƒë·ªông (RBAC) trong to√†n b·ªô h·ªá th·ªëng. D∆∞·ªõi ƒë√¢y l√† c√°c lu·ªìng x·ª≠ l√Ω nghi·ªáp v·ª• ch√≠nh:

---

### 4.1. ƒêƒÉng nh·∫≠p th√†nh c√¥ng ‚Üí C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng (auto-create n·∫øu ch∆∞a t·ªìn t·∫°i)

```mermaid
sequenceDiagram
    participant Gateway
    participant AuthService
    participant UserService
    Gateway->>AuthService: G·ªçi API x√°c th·ª±c (OAuth2 ho·∫∑c Local)
    AuthService-->>Gateway: Tr·∫£ v·ªÅ JWT ch·ª©a `user_id`, `email`, `role_hint`
    Gateway->>UserService: `POST /users/sync-from-token` (k√®m info trong token)
    UserService->>UserService: Ki·ªÉm tra `user_id` ƒë√£ t·ªìn t·∫°i?
    alt Ch∆∞a t·ªìn t·∫°i
        UserService->>DB: T·∫°o user m·ªõi, tr·∫°ng th√°i `active`
    else ƒê√£ t·ªìn t·∫°i
        UserService->>DB: C·∫≠p nh·∫≠t `last_login_at`, ƒë·ªìng b·ªô t√™n/email n·∫øu thay ƒë·ªïi
    end
    UserService-->>Gateway: OK
```

---

### 4.2. C·∫≠p nh·∫≠t ph√¢n quy·ªÅn ƒë·ªông

* API: `PATCH /users/{id}/rbac`
* Logic:

  * C·∫≠p nh·∫≠t danh s√°ch `role_id` c·ªßa user
  * Ghi nh·∫≠n c√°c permission t∆∞∆°ng ·ª©ng th√¥ng qua b·∫£ng `role_permission`
  * Ph√°t s·ª± ki·ªán `rbac_updated` ƒë·ªÉ API Gateway c·∫≠p nh·∫≠t cache RBAC n·ªôi b·ªô

---

### 4.3. Ng·ª´ng k√≠ch ho·∫°t t√†i kho·∫£n ng∆∞·ªùi d√πng

* API: `PATCH /users/{id}/status`
* Logic:

  * C·∫≠p nh·∫≠t `is_active = false`
  * Ph√°t s·ª± ki·ªán `user_status_changed` ƒë·ªÉ c√°c service li√™n quan thu h·ªìi token/cache
  * Gateway s·∫Ω t·ª´ ch·ªëi request n·∫øu ng∆∞·ªùi d√πng b·ªã disable

---

üìå Xem chi ti·∫øt c√°c permission v√† schema RBAC trong [`rbac-deep-dive.md`](../../architecture/rbac-deep-dive.md)

---

## 5. Business Logic Flows ‚Äì Lu·ªìng nghi·ªáp v·ª• ch√≠nh

### 5.1. C·∫≠p nh·∫≠t tr·∫°ng th√°i ng∆∞·ªùi d√πng (Active / Inactive)

```mermaid
sequenceDiagram
    participant AdminApp
    participant APIGateway
    participant UserService
    participant DB

    AdminApp->>APIGateway: PATCH /users/{id}/status (active=false)
    APIGateway->>UserService: PATCH /users/{id}/status
    UserService->>DB: UPDATE users SET is_active = false WHERE id = ?
    UserService-->>APIGateway: 200 OK
    APIGateway-->>AdminApp: 200 OK
    Note over UserService: Emit event `user_status_changed`
```

### 5.2. C·∫≠p nh·∫≠t RBAC cho ng∆∞·ªùi d√πng

```mermaid
sequenceDiagram
    participant AdminApp
    participant APIGateway
    participant UserService
    participant DB

    AdminApp->>APIGateway: PATCH /users/{id}/rbac
    APIGateway->>UserService: PATCH /users/{id}/rbac
    UserService->>DB: UPDATE user_roles, user_permissions
    UserService-->>APIGateway: 200 OK
    APIGateway-->>AdminApp: 200 OK
    Note over UserService: Emit event `rbac_updated`
```

### 5.3. T·∫°o ng∆∞·ªùi d√πng m·ªõi t·ª´ h·ªá th·ªëng kh√°c (v√≠ d·ª•: CRM, SIS)

```mermaid
sequenceDiagram
    participant Adapter
    participant APIGateway
    participant UserService
    participant DB

    Adapter->>APIGateway: POST /users
    APIGateway->>UserService: POST /users
    UserService->>DB: INSERT INTO users (...)
    UserService-->>APIGateway: 201 Created
    APIGateway-->>Adapter: 201 Created
    Note over UserService: Emit event `user_created`
```

> üîÅ C√°c lu·ªìng x·ª≠ l√Ω n√†y ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ tu√¢n th·ªß m√¥ h√¨nh event-driven: sau khi c·∫≠p nh·∫≠t tr·∫°ng th√°i ng∆∞·ªùi d√πng ho·∫∑c ph√¢n quy·ªÅn, User Service s·∫Ω ph√°t s·ª± ki·ªán ƒë·ªÉ c√°c th√†nh ph·∫ßn kh√°c nh∆∞ API Gateway c√≥ th·ªÉ c·∫≠p nh·∫≠t cache t∆∞∆°ng ·ª©ng.

---

## 6. Events ‚Äì C√°c s·ª± ki·ªán User Service ph√°t ra

User Service l√† m·ªôt trong c√°c Core Service ph√°t sinh s·ª± ki·ªán quan tr·ªçng li√™n quan ƒë·∫øn tr·∫°ng th√°i ng∆∞·ªùi d√πng v√† ph√¢n quy·ªÅn. T·∫•t c·∫£ c√°c s·ª± ki·ªán ƒë∆∞·ª£c ph√°t qua Pub/Sub, v√† d√πng ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi API Gateway, Notification Service ho·∫∑c c√°c service kh√°c.

### 6.1. `user_created`

- **Trigger:** Khi m·ªôt ng∆∞·ªùi d√πng ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng qua API ho·∫∑c h·ªá th·ªëng t√≠ch h·ª£p (CRM/SIS).
- **Topic:** `user.events.user_created`
- **Payload:**

```json
{
  "user_id": "uuid",
  "email": "abc@example.com",
  "role_codes": ["parent"],
  "created_at": "2024-06-01T12:00:00Z"
}
```

* **Consumer:** Notification Service (g·ª≠i welcome message), API Gateway (preload RBAC cache), CRM adapter (n·∫øu c·∫ßn sync l·∫°i tr·∫°ng th√°i ng∆∞·ªùi d√πng).

---

### 6.2. `user_status_changed`

* **Trigger:** Khi tr·∫°ng th√°i `is_active` c·ªßa ng∆∞·ªùi d√πng b·ªã thay ƒë·ªïi.
* **Topic:** `user.events.user_status_changed`
* **Payload:**

```json
{
  "user_id": "uuid",
  "is_active": false,
  "updated_by": "admin-uuid",
  "timestamp": "2024-06-02T10:30:00Z"
}
```

* **Consumer:** API Gateway (x√≥a RBAC cache n·∫øu ng∆∞·ªùi d√πng b·ªã inactive), Notification Service (ng·ª´ng g·ª≠i th√¥ng b√°o n·∫øu ng∆∞·ªùi d√πng b·ªã kh√≥a).

---

### 6.3. `rbac_updated`

* **Trigger:** Khi role ho·∫∑c permission c·ªßa ng∆∞·ªùi d√πng thay ƒë·ªïi.
* **Topic:** `user.events.rbac_updated`
* **Payload:**

```json
{
  "user_id": "uuid",
  "roles": ["teacher"],
  "permissions": ["VIEW_SCORE_CLASS", "EDIT_TIMETABLE"],
  "updated_by": "admin-uuid",
  "timestamp": "2024-06-02T11:00:00Z"
}
```

* **Consumer:** API Gateway (c·∫≠p nh·∫≠t l·∫°i RBAC cache), Admin Webapp (hi·ªÉn th·ªã tr·∫°ng th√°i ph√¢n quy·ªÅn m·ªõi n·∫øu ƒëang m·ªü session).

> üí° T·∫•t c·∫£ c√°c s·ª± ki·ªán ƒë·ªÅu ƒë·∫£m b·∫£o `idempotency` b·∫±ng c√°ch bao g·ªìm `user_id` v√† `timestamp`. C√°c subscriber c·∫ßn x·ª≠ l√Ω ƒë√∫ng nguy√™n t·∫Øc ƒë·∫£m b·∫£o tr·∫°ng th√°i cu·ªëi c√πng lu√¥n ch√≠nh x√°c.

---

## 7. Authorization & Security

User Service l√† trung t√¢m ph√¢n quy·ªÅn c·ªßa to√†n h·ªá th·ªëng, ƒë·∫£m nhi·ªám vi·ªác qu·∫£n l√Ω vai tr√≤ (role), quy·ªÅn (permission), v√† ƒëi·ªÅu ki·ªán truy c·∫≠p ƒë·ªông (condition-based RBAC).

---

### 7.1. C√°c permission ƒë∆∞·ª£c c·∫•p cho API Gateway

API Gateway s·∫Ω forward request ƒë·∫øn User Service sau khi ƒë√£ x√°c th·ª±c v√† ƒë√°nh gi√° RBAC. Tuy nhi√™n, m·ªôt s·ªë endpoint c√≥ th·ªÉ c·∫ßn c·∫•p quy·ªÅn truy c·∫≠p r√µ r√†ng, v√≠ d·ª•:

| Endpoint                            | M√£ permission                 | M√¥ t·∫£ quy·ªÅn                              |
|-------------------------------------|-------------------------------|-------------------------------------------|
| `GET /users/{id}`                   | `user:read`                   | Xem th√¥ng tin ng∆∞·ªùi d√πng                  |
| `PATCH /users/{id}`                | `user:update`                 | C·∫≠p nh·∫≠t tr·∫°ng th√°i ng∆∞·ªùi d√πng            |
| `GET /users/{id}/permissions`      | `user:rbac:view`              | Xem vai tr√≤ v√† quy·ªÅn c·ªßa user             |
| `PATCH /users/{id}/permissions`    | `user:rbac:update`            | C·∫≠p nh·∫≠t role/permission                  |

---

### 7.2. C√°ch User Service ƒë√°nh gi√° ph√¢n quy·ªÅn

- User Service kh√¥ng ƒë√°nh gi√° RBAC tr·ª±c ti·∫øp cho m·ªói request (ƒë√£ do Gateway l√†m).
- Tuy nhi√™n, c√°c endpoint qu·∫£n tr·ªã (`/permissions`, `/roles`) s·∫Ω c√≥ decorator n·ªôi b·ªô ki·ªÉm tra `X-Permissions` header ƒë·ªÉ gi·ªõi h·∫°n quy·ªÅn truy c·∫≠p nh·∫°y c·∫£m.

---

### 7.3. Ki·ªÉm so√°t thay ƒë·ªïi RBAC

- M·ªçi thay ƒë·ªïi role/permission ph·∫£i ƒë∆∞·ª£c ki·ªÉm tra RBAC ·ªü Gateway v√† log l·∫°i t·∫°i User Service (audit).
- M·ªôt s·ªë h√†nh ƒë·ªông c·∫ßn "RBAC c·∫•p cao", v√≠ d·ª•: ch·ªâ `rbac:admin` m·ªõi ƒë∆∞·ª£c c·∫≠p nh·∫≠t vai tr√≤ gi√°o vi√™n.

---

### 7.4. B·∫£o m·∫≠t d·ªØ li·ªáu

- Email, password hash, OTP secret ƒë·ªÅu ƒë∆∞·ª£c l∆∞u tr·ªØ m√£ h√≥a/bƒÉm (tu√¢n th·ªß ADR-004).
- Token kh√¥ng ƒë∆∞·ª£c l∆∞u t·∫°i User Service ‚Äì do Auth Service qu·∫£n l√Ω.
- RBAC cache ch·ªâ ƒë∆∞·ª£c ph√°t t√°n t·ªõi Gateway th√¥ng qua Pub/Sub `rbac_updated`.

---

### 7.5. Audit Logging

- M·ªçi h√†nh ƒë·ªông ghi thay ƒë·ªïi tr·∫°ng th√°i ng∆∞·ªùi d√πng ho·∫∑c RBAC ƒë·ªÅu ghi v√†o h·ªá th·ªëng Audit Log.
- Ghi nh·∫≠n:
  - `actor_id`
  - `target_user_id`
  - `action`
  - `metadata`
  - `timestamp`

---

## 8. Configuration & Dependencies

User Service c√≥ m·ªôt s·ªë c·∫•u h√¨nh m√¥i tr∆∞·ªùng v√† ph·ª• thu·ªôc c·∫ßn ƒë∆∞·ª£c khai b√°o r√µ ƒë·ªÉ tri·ªÉn khai ƒë√∫ng v√† b·∫£o m·∫≠t.

---

### 8.1. Bi·∫øn m√¥i tr∆∞·ªùng

| Bi·∫øn | B·∫Øt bu·ªôc | M√¥ t·∫£ |
|------|----------|-------|
| `DATABASE_URL`        | ‚úÖ | K·∫øt n·ªëi PostgreSQL (ƒë·ªãnh d·∫°ng: `postgresql+asyncpg://...`) |
| `REDIS_URL`           | ‚úÖ | K·∫øt n·ªëi Redis (s·ª≠ d·ª•ng cho cache t·∫°m v√† Pub/Sub fallback n·∫øu c·∫ßn) |
| `PUBSUB_PROJECT_ID`   | ‚úÖ | D·ª± √°n GCP ƒë·ªÉ publish s·ª± ki·ªán qua Pub/Sub |
| `RBAC_TOPIC_NAME`     | ‚úÖ | T√™n topic Pub/Sub ƒë·ªÉ ph√°t s·ª± ki·ªán `rbac_updated` |
| `JWT_ISSUER`          | ‚úÖ | Issuer c·∫ßn ki·ªÉm tra khi decode token (do Auth Service c·∫•p) |
| `JWT_PUBLIC_KEY_PATH` | ‚úÖ | ƒê∆∞·ªùng d·∫´n file ch·ª©a public key ƒë·ªÉ decode JWT n·ªôi b·ªô |
| `ENV`                 | ‚úÖ | `production`, `staging`, ho·∫∑c `local` (·∫£nh h∆∞·ªüng ƒë·∫øn logging, debug, DB pool‚Ä¶) |

---

### 8.2. Secrets (ƒë∆∞·ª£c inject t·ª´ Secret Manager ho·∫∑c mounted file)

| Secret               | M·ª•c ƒë√≠ch                            |
|----------------------|--------------------------------------|
| `jwt-public-key.pem` | ƒê∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ x√°c th·ª±c JWT header t·ª´ Gateway |
| `pgpassword`         | N·∫øu kh√¥ng c·∫•u h√¨nh trong URL ‚Äì l·∫•y t·ª´ Secret ri√™ng |

---

### 8.3. Ph·ª• thu·ªôc d·ªãch v·ª• n·ªôi b·ªô

| Service | M·ª•c ƒë√≠ch |
|---------|----------|
| Auth Service (qua Gateway) | X√°c th·ª±c token, decode metadata |
| Notification Service (qua Gateway) | G·ª≠i th√¥ng b√°o khi tr·∫°ng th√°i ng∆∞·ªùi d√πng thay ƒë·ªïi (t√πy ch·ªçn) |
| Audit Logging Service (n·∫øu t√°ch ri√™ng) | G·ª≠i log audit cho c√°c thao t√°c ph√¢n quy·ªÅn |

---

### 8.4. Quy ∆∞·ªõc c·∫•u h√¨nh n·ªôi b·ªô

- To√†n b·ªô config ƒë∆∞·ª£c load qua `config.py`, ph√¢n theo schema chu·∫©n.
- H·ªó tr·ª£ c·∫•u h√¨nh ƒë·ªông (qua JSON config file mount t·ª´ GCS ho·∫∑c th√¥ng qua Firestore, n·∫øu m·ªü r·ªông sau n√†y).

---

## Next Steps

* Create `data-model.md`
* Complete OpenAPI YAML (ensure sync with implemented handlers)
* Review `dx-service-template` for conformance
* Start implementation based on this design
