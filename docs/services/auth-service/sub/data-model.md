---
title: "Auth Service Sub - Data Model"
version: "1.0"
last_updated: "2025-06-07"
author: "DX VAS Team"
reviewed_by: "Stephen Le"
---

# üóÉÔ∏è Auth Service Sub - Data Model

Service n√†y l√† m·ªôt th√†nh ph·∫ßn **tenant-specific** trong h·ªá th·ªëng `dx-vas`, ho·∫°t ƒë·ªông theo ki·∫øn tr√∫c **request-response + token-based authentication**, ch·ªãu tr√°ch nhi·ªám x√°c th·ª±c ng∆∞·ªùi d√πng v√† duy tr√¨ phi√™n ƒëƒÉng nh·∫≠p cho t·ª´ng tenant.

---

## 1. Ph·∫°m vi D·ªØ li·ªáu Qu·∫£n l√Ω (Scope)

- Th√¥ng tin x√°c th·ª±c ng∆∞·ªùi d√πng (`auth_sessions`)
- Qu·∫£n l√Ω token ƒëƒÉng nh·∫≠p v√† refresh (`auth_sessions`)
- Ghi nh·∫≠n thi·∫øt b·ªã v√† metadata login (`auth_sessions`)
- ƒê·∫£m b·∫£o b·∫£o m·∫≠t v√† duy tr√¨ quy·ªÅn truy c·∫≠p theo session

---

## 2. Ngo√†i Ph·∫°m Vi (Out of Scope)

- ‚ùå Qu·∫£n l√Ω th√¥ng tin ng∆∞·ªùi d√πng (user profile) ‚Äì thu·ªôc `user-service/sub`
- ‚ùå C·∫•u h√¨nh vai tr√≤ v√† quy·ªÅn (RBAC) ‚Äì thu·ªôc `auth-service/master`
- ‚ùå Ghi log h√†nh vi ng∆∞·ªùi d√πng ‚Äì thu·ªôc `audit-logging-service`

---

## 3. M·ª•c ti√™u c·ªßa T√†i li·ªáu M√¥ h√¨nh D·ªØ li·ªáu

- L√†m r√µ schema b·∫£ng `auth_sessions` c·ªßa service
- Chu·∫©n h√≥a v√† h·ªó tr·ª£ tri·ªÉn khai migration, ki·ªÉm th·ª≠, ph√°t tri·ªÉn API
- Ph·∫£n √°nh ch√≠nh x√°c c√°c lu·ªìng nghi·ªáp v·ª• trong t√†i li·ªáu `design.md`
- Tu√¢n th·ªß c√°c ADR sau:
  - [ADR-003 - Secrets Management](../../../ADR/adr-003-secrets.md)
  - [ADR-004 - Security Policy](../../../ADR/adr-004-security.md)
  - [ADR-012 - Response Structure](../../../ADR/adr-012-response-structure.md)

---

D∆∞·ªõi ƒë√¢y l√† phi√™n b·∫£n **chi ti·∫øt v√† chu·∫©n h√≥a h∆°n** cho m·ª•c `## 4. S∆° ƒë·ªì ERD` trong file `auth-service/sub/data-model.md`, v·ªõi c√°c ƒëi·ªÉm n·ªïi b·∫≠t:

* S·ª≠ d·ª•ng **Mermaid ERD** th·ªÉ hi·ªán ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c c·ªôt ch√≠nh, bao g·ªìm metadata m·ªõi.
* C√≥ ch√∫ th√≠ch quan h·ªá r√µ r√†ng gi·ªØa `users` v√† `auth_sessions`.
* Gi·∫£i th√≠ch ƒë·∫ßy ƒë·ªß c√°c k√Ω hi·ªáu, vai tr√≤ gi·ªØa c√°c th·ª±c th·ªÉ.

---

## 4. S∆° ƒë·ªì ERD (Entity Relationship Diagram)

S∆° ƒë·ªì d∆∞·ªõi ƒë√¢y m√¥ t·∫£ m·ªëi quan h·ªá gi·ªØa ng∆∞·ªùi d√πng (`users`) v√† c√°c phi√™n ƒëƒÉng nh·∫≠p (`auth_sessions`). ƒê√¢y l√† quan h·ªá **1-N**: m·ªôt ng∆∞·ªùi d√πng c√≥ th·ªÉ c√≥ nhi·ªÅu phi√™n ƒëƒÉng nh·∫≠p.

```mermaid
erDiagram
  users ||--o{ auth_sessions : has

  users {
    UUID id PK
    TEXT full_name
    TEXT email
    BOOLEAN is_active
  }

  auth_sessions {
    UUID id PK
    UUID user_id FK
    TIMESTAMPTZ issued_at
    TIMESTAMPTZ expired_at
    BOOLEAN is_active
    TEXT refresh_token_hash
    TEXT auth_method
    TEXT device_type
    TEXT device_model
    TEXT user_agent
    TEXT os_version
    TEXT app_version
    TEXT ip_address
    TEXT location
    TIMESTAMPTZ last_active_at
    TIMESTAMPTZ created_at
    TIMESTAMPTZ updated_at
  }
```

---

### üîç Gi·∫£i th√≠ch quan h·ªá

* `users.id` l√† kh√≥a ch√≠nh c·ªßa b·∫£ng ng∆∞·ªùi d√πng, ƒë∆∞·ª£c qu·∫£n l√Ω b·ªüi `user-service/sub`.
* `auth_sessions.user_id` l√† kh√≥a ngo·∫°i (`FK`) tr·ªè t·ªõi ng∆∞·ªùi d√πng s·ªü h·ªØu phi√™n ƒë√≥.
* M·ªôt ng∆∞·ªùi d√πng (`users`) c√≥ th·ªÉ ƒëƒÉng nh·∫≠p tr√™n nhi·ªÅu thi·∫øt b·ªã/phi√™n kh√°c nhau ‚áí c·∫ßn ghi l·∫°i metadata chi ti·∫øt.

---

### üìå K√Ω hi·ªáu s∆° ƒë·ªì

| K√Ω hi·ªáu | √ù nghƒ©a                  |        |                           |
| ------- | ------------------------ | ------ | ------------------------- |
| `PK`    | Primary Key (kh√≥a ch√≠nh) |        |                           |
| `FK`    | Foreign Key (kh√≥a ngo·∫°i) |        |                           |
| \`      |                          | --o{\` | Quan h·ªá 1-N (m·ªôt - nhi·ªÅu) |

---

### üìé M·ªü r·ªông trong t∆∞∆°ng lai

| T√≠nh nƒÉng                  | M·ªü r·ªông t∆∞∆°ng ·ª©ng                 |
| -------------------------- | --------------------------------- |
| Ghi nh·∫≠n ho·∫°t ƒë·ªông         | Th√™m b·∫£ng `session_activity_logs` |
| Ghi nh·∫≠n l·ªói b·∫£o m·∫≠t       | T√≠ch h·ª£p `audit-logging-service`  |
| H·∫°n ch·∫ø thi·∫øt b·ªã ƒëƒÉng nh·∫≠p | C·∫ßn b·∫£ng `trusted_devices`        |

---

## 5. üìå B·∫£ng: `auth_sessions`

### üßæ M·ª•c ƒë√≠ch

L∆∞u tr·ªØ m·ªçi phi√™n ƒëƒÉng nh·∫≠p ng∆∞·ªùi d√πng, k√®m th√¥ng tin metadata ƒë·ªÉ ph·ª•c v·ª• c√°c ch·ª©c nƒÉng:

* ƒêƒÉng nh·∫≠p ƒëa thi·∫øt b·ªã
* Theo d√µi ho·∫°t ƒë·ªông v√† b·∫£o m·∫≠t
* Dashboard phi√™n ƒëƒÉng nh·∫≠p (giao di·ªán ng∆∞·ªùi d√πng v√† qu·∫£n tr·ªã)

---

### üìú C·∫•u tr√∫c SQL

```sql
CREATE TABLE auth_sessions (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  issued_at TIMESTAMPTZ NOT NULL,
  expired_at TIMESTAMPTZ NOT NULL,
  is_active BOOLEAN DEFAULT true,
  refresh_token_hash TEXT NOT NULL,
  auth_method TEXT CHECK (auth_method IN ('password', 'otp', 'magic_link')),

  -- Metadata m·ªü r·ªông
  device_type TEXT CHECK (device_type IN ('web', 'ios', 'android')),
  device_model TEXT,
  user_agent TEXT,
  os_version TEXT,
  app_version TEXT,
  ip_address TEXT,
  location TEXT,
  last_active_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);
```

---

### üìã M√¥ t·∫£ c√°c c·ªôt ch√≠nh (bao g·ªìm metadata)

| C·ªôt                  | Ki·ªÉu DL     | R√†ng bu·ªôc     | M√¥ t·∫£                                   |
| -------------------- | ----------- | ------------- | --------------------------------------- |
| `id`                 | UUID        | PK            | M√£ ƒë·ªãnh danh phi√™n                      |
| `user_id`            | UUID        | FK            | Tham chi·∫øu ƒë·∫øn ng∆∞·ªùi d√πng               |
| `issued_at`          | TIMESTAMPTZ | NOT NULL      | Th·ªùi gian ph√°t h√†nh token               |
| `expired_at`         | TIMESTAMPTZ | NOT NULL      | Th·ªùi gian h·∫øt h·∫°n token                 |
| `is_active`          | BOOLEAN     | DEFAULT TRUE  | Tr·∫°ng th√°i c√≤n hi·ªáu l·ª±c                 |
| `refresh_token_hash` | TEXT        | NOT NULL      | Hash c·ªßa refresh token                  |
| `auth_method`        | TEXT ENUM   | CHECK         | Ph∆∞∆°ng th·ª©c x√°c th·ª±c                    |
| `device_type`        | TEXT ENUM   | CHECK         | Lo·∫°i thi·∫øt b·ªã (`web`, `ios`, `android`) |
| `device_model`       | TEXT        |               | T√™n thi·∫øt b·ªã (VD: iPhone 13)            |
| `user_agent`         | TEXT        |               | Tr√¨nh duy·ªát ho·∫∑c app agent              |
| `os_version`         | TEXT        |               | Phi√™n b·∫£n h·ªá ƒëi·ªÅu h√†nh                  |
| `app_version`        | TEXT        |               | Phi√™n b·∫£n ·ª©ng d·ª•ng (mobile)             |
| `ip_address`         | TEXT        |               | ƒê·ªãa ch·ªâ IP client                       |
| `location`           | TEXT        |               | Th√¥ng tin ƒë·ªãa l√Ω (t·ª´ IP ho·∫∑c user ch·ªçn) |
| `last_active_at`     | TIMESTAMPTZ |               | Th·ªùi ƒëi·ªÉm ho·∫°t ƒë·ªông g·∫ßn nh·∫•t            |
| `created_at`         | TIMESTAMPTZ | DEFAULT now() | T·∫°o b·∫£n ghi                             |
| `updated_at`         | TIMESTAMPTZ | DEFAULT now() | C·∫≠p nh·∫≠t g·∫ßn nh·∫•t                       |

---

### üîê L∆∞u √Ω b·∫£o m·∫≠t

* Kh√¥ng bao gi·ªù l∆∞u tr·ª±c ti·∫øp `refresh_token`. Ch·ªâ l∆∞u `hash`.
* C√≥ th·ªÉ th√™m salting + peppering n·∫øu c·∫ßn tƒÉng c∆∞·ªùng b·∫£o m·∫≠t.
* Tr∆∞·ªùng `ip_address` v√† `user_agent` h·ªó tr·ª£ ph√°t hi·ªán login ƒë√°ng ng·ªù.

---

### üìå ƒê·∫∑c ƒëi·ªÉm ch√≠nh

* ‚úÖ Thi·∫øt k·∫ø **stateless** cho access token
* ‚úÖ Cho ph√©p **revoke t·ª´ng session**
* ‚úÖ D·ªÖ m·ªü r·ªông ƒë·ªÉ l∆∞u metadata thi·∫øt b·ªã, v·ªã tr√≠ ƒë·ªãa l√Ω (n·∫øu c·∫ßn)
* ‚úÖ S·∫µn s√†ng t√≠ch h·ª£p v·ªõi `audit-logging-service` cho c√°c s·ª± ki·ªán nh∆∞: login, logout, failed login, revoke

---

## 5.1 üìå B·∫£ng ph·ª•: `revoked_tokens`

### üßæ M·ª•c ƒë√≠ch

B·∫£ng `revoked_tokens` d√πng ƒë·ªÉ l∆∞u tr·ªØ c√°c **refresh token ƒë√£ b·ªã thu h·ªìi** (ho·∫∑c access token n·∫øu d√πng JWT c√≥ TTL d√†i) nh·∫±m:
- NgƒÉn token b·ªã l·∫°m d·ª•ng
- H·ªó tr·ª£ logout t·∫•t c·∫£ thi·∫øt b·ªã
- Ki·ªÉm tra nhanh trong `middleware` ho·∫∑c `auth validator`

---

### üìú C·∫•u tr√∫c SQL

```sql
CREATE TABLE revoked_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  token_hash TEXT NOT NULL,
  user_id UUID NOT NULL,
  revoked_at TIMESTAMPTZ DEFAULT now(),
  reason TEXT,
  expired_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

---

### üìã M√¥ t·∫£ c√°c c·ªôt

| C·ªôt          | Ki·ªÉu DL     | R√†ng bu·ªôc     | M√¥ t·∫£                                   |
| ------------ | ----------- | ------------- | --------------------------------------- |
| `id`         | UUID        | PK            | ID n·ªôi b·ªô                               |
| `token_hash` | TEXT        | NOT NULL      | Gi√° tr·ªã hash c·ªßa token ƒë√£ b·ªã revoke     |
| `user_id`    | UUID        | NOT NULL      | Ng∆∞·ªùi d√πng b·ªã thu h·ªìi token             |
| `revoked_at` | TIMESTAMPTZ | DEFAULT now() | Th·ªùi ƒëi·ªÉm b·ªã revoke                     |
| `reason`     | TEXT        | NULLABLE      | Ghi ch√∫ l√Ω do (e.g. logout, suspicious) |
| `expired_at` | TIMESTAMPTZ | NOT NULL      | Khi n√†o token n√†y h·∫øt h·∫°n th·∫≠t s·ª±       |
| `created_at` | TIMESTAMPTZ | DEFAULT now() | Th·ªùi ƒëi·ªÉm t·∫°o b·∫£n ghi                   |

---

### üß† L∆∞u √Ω tri·ªÉn khai

* Tr∆∞·ªõc khi ph√°t h√†nh token m·ªõi ho·∫∑c x·ª≠ l√Ω refresh:

  * Ki·ªÉm tra `token_hash` c√≥ t·ªìn t·∫°i trong `revoked_tokens` hay kh√¥ng.
* C√≥ th·ªÉ l∆∞u trong Redis ƒë·ªÉ ki·ªÉm tra nhanh, x√≥a khi `expired_at < now()`
* Tr∆∞·ªùng `reason` c√≥ th·ªÉ d√πng trong audit log ho·∫∑c dashboard Admin

---

### üìä So s√°nh nhanh

| C√°ch                  | ∆Øu ƒëi·ªÉm                  | Nh∆∞·ª£c ƒëi·ªÉm                         |
| --------------------- | ------------------------ | ---------------------------------- |
| D√πng TTL JWT          | Kh√¥ng c·∫ßn l∆∞u session    | Kh√¥ng th·ªÉ revoke theo user         |
| D√πng `revoked_tokens` | Cho ph√©p revoke ch·ªçn l·ªçc | C·∫ßn th√™m query + l∆∞u th√™m b·∫£ng ph·ª• |

---

üìé G·ª£i √Ω th√™m:

* G·∫Øn v·ªõi `audit-logging-service` khi revoke token
* C√≥ th·ªÉ xem nh∆∞ b·∫£ng log b·∫£o m·∫≠t m·ª©c cao

---

## 6. üß© Indexes & Constraints

ƒê·ªÉ ƒë·∫£m b·∫£o **t√≠nh to√†n v·∫πn d·ªØ li·ªáu**, **truy v·∫•n nhanh** v√† **hi·ªáu nƒÉng cao**, b·∫£ng `auth_sessions` ƒë∆∞·ª£c √°p d·ª•ng c√°c index v√† constraint nh∆∞ sau:

---

### üîê Constraints

| T√™n R√†ng bu·ªôc           | M√¥ t·∫£ |
|-------------------------|------|
| `PRIMARY KEY (id)`      | M·ªói session c√≥ m·ªôt ID duy nh·∫•t |
| `FOREIGN KEY (user_id)` | R√†ng bu·ªôc tham chi·∫øu t·ªõi b·∫£ng `users(id)` |
| `CHECK (auth_method)`   | Ch·ªâ cho ph√©p c√°c gi√° tr·ªã enum h·ª£p l·ªá: `password`, `otp`, `magic_link` |
| `CHECK (device_type)`   | Ch·ªâ ch·∫•p nh·∫≠n `web`, `ios`, `android` |

> üîé G·ª£i √Ω th√™m: N·∫øu tri·ªÉn khai multi-tenant, c√≥ th·ªÉ th√™m r√†ng bu·ªôc `CHECK (tenant_id IS NOT NULL)` (n·∫øu c√≥ `tenant_id` trong schema).

---

### ‚ö° Indexes

| T√™n Index                  | C·ªôt                         | M·ª•c ƒë√≠ch |
|---------------------------|------------------------------|----------|
| `idx_auth_sessions_user`  | `user_id`                    | Truy v·∫•n theo user ‚Äì th∆∞·ªùng d√πng trong b·∫£ng qu·∫£n l√Ω thi·∫øt b·ªã |
| `idx_auth_sessions_token` | `refresh_token_hash`         | Ki·ªÉm tra token nhanh trong middleware |
| `idx_auth_sessions_active`| `is_active`                  | L·ªçc c√°c session ƒëang ho·∫°t ƒë·ªông |
| `idx_auth_sessions_exp`   | `expired_at`                 | T·ª± ƒë·ªông d·ªçn session h·∫øt h·∫°n (batch job) |
| `idx_auth_sessions_last`  | `last_active_at DESC`        | Truy v·∫•n phi√™n g·∫ßn nh·∫•t |
| `idx_auth_sessions_geo`   | `location`, `ip_address`     | Ph√¢n t√≠ch truy c·∫≠p ƒë·ªãa l√Ω, hi·ªÉn th·ªã UI |
| `idx_auth_sessions_device`| `device_type`, `os_version`  | L·ªçc thi·∫øt b·ªã trong ph√¢n t√≠ch ho·∫∑c UI qu·∫£n tr·ªã |

---

### üîß G·ª£i √Ω n√¢ng cao (tu·ª≥ quy m√¥)

- **Partial Index:** `WHERE is_active = true` gi√∫p tƒÉng t·ªëc t√¨m session c√≤n hi·ªáu l·ª±c.
- **Composite Index:** `(user_id, device_type, is_active)` cho m√†n h√¨nh qu·∫£n l√Ω thi·∫øt b·ªã ng∆∞·ªùi d√πng.
- **Unique Constraint:** (ch·ªâ d√πng n·∫øu thi·∫øt k·∫ø gi·ªõi h·∫°n 1 thi·∫øt b·ªã/1 user): `UNIQUE(user_id, device_type, device_model, os_version)`.

---

D∆∞·ªõi ƒë√¢y l√† ph·∫ßn chi ti·∫øt ho√° cho m·ª•c `## 7. Retention & Data Lifecycle` trong `auth-service/sub/data-model.md`, tu√¢n th·ªß chu·∫©n 5‚òÖ v√† ph√π h·ª£p v·ªõi ADR-024 v·ªÅ d·ªØ li·ªáu nh·∫°y c·∫£m & v√≤ng ƒë·ªùi:

---

## 7. ‚ôªÔ∏è Retention & Data Lifecycle

Vi·ªác qu·∫£n l√Ω v√≤ng ƒë·ªùi c·ªßa d·ªØ li·ªáu `auth_sessions` l√† y·∫øu t·ªë quan tr·ªçng gi√∫p h·ªá th·ªëng:
- Gi·∫£m thi·ªÉu r·ªßi ro b·∫£o m·∫≠t
- T·ªëi ∆∞u dung l∆∞·ª£ng l∆∞u tr·ªØ
- ƒê·∫£m b·∫£o tu√¢n th·ªß c√°c nguy√™n t·∫Øc ph√°p l√Ω v√† ch√≠nh s√°ch n·ªôi b·ªô

---

### üïí Th·ªùi h·∫°n l∆∞u tr·ªØ

| Lo·∫°i d·ªØ li·ªáu       | Th·ªùi gian gi·ªØ | C√°ch x√≥a |
|--------------------|---------------|----------|
| Phi√™n ƒëƒÉng nh·∫≠p (`auth_sessions`) | 30 ng√†y sau khi `expired_at` | Xo√° ƒë·ªãnh k·ª≥ b·∫±ng batch job |
| Token b·ªã thu h·ªìi (`revoked_tokens`) | 7 ng√†y sau `expired_at` | Xo√° t·ª± ƒë·ªông |
| Token ƒëang ho·∫°t ƒë·ªông | Theo TTL ‚Äì ƒë∆∞·ª£c thi·∫øt l·∫≠p khi ph√°t h√†nh | H·∫øt h·∫°n t·ª± nhi√™n + th·ªß c√¥ng |

---

### üßπ C∆° ch·∫ø d·ªçn d·∫πp (Garbage Collection)

- T·∫°o 1 cronjob ch·∫°y m·ªói ng√†y l√∫c 2AM:
```sql
  DELETE FROM auth_sessions WHERE expired_at < now() - interval '30 days';
```

* Redis cache n·∫øu d√πng cho refresh-token c≈©ng ph·∫£i thi·∫øt l·∫≠p TTL t∆∞∆°ng ·ª©ng.
* `revoked_tokens` n√™n c√≥ `expired_at` v√† TTL t∆∞∆°ng ƒë∆∞∆°ng JWT g·ªëc.

---

### üîê D·ªØ li·ªáu nh·∫°y c·∫£m

| Tr∆∞·ªùng                       | Nh·∫°y c·∫£m? | H√†nh ƒë·ªông b·∫£o v·ªá                                 |
| ---------------------------- | --------- | ------------------------------------------------ |
| `refresh_token_hash`         | ‚úÖ         | Hash b·∫±ng SHA-256, kh√¥ng l∆∞u plain token         |
| `ip_address`, `location`     | ‚úÖ         | C√≥ th·ªÉ xem l√† PII, h·∫°n ch·∫ø query kh√¥ng c·∫ßn thi·∫øt |
| `user_agent`, `device_model` | ‚ö†Ô∏è        | Kh√¥ng c·∫ßn ·∫©n danh nh∆∞ng n√™n h·∫°n ch·∫ø log th√¥      |

---

### üß† G·ª£i √Ω m·ªü r·ªông

* B·∫£ng `auth_sessions_archive` c√≥ th·ªÉ d√πng ƒë·ªÉ l∆∞u session l·ªãch s·ª≠ h∆°n 30 ng√†y n·∫øu c·∫ßn auditing.
* N·∫øu d√πng multi-tenant, n√™n c√≥ batch xo√° theo `tenant_id` ƒë·ªôc l·∫≠p (xo√° tenant c≈©ng xo√° to√†n b·ªô session).
* H·ªó tr·ª£ `manual revocation` (qua admin UI) n√™n ƒë∆∞·ª£c ghi log sang `audit-logging-service`.

---

## 8. üßæ ENUMs

C√°c tr∆∞·ªùng d·∫°ng li·ªát k√™ (ENUM) gi√∫p ƒë·∫£m b·∫£o d·ªØ li·ªáu chu·∫©n h√≥a, d·ªÖ validate t·ª´ backend t·ªõi frontend, ƒë·ªìng th·ªùi h·ªó tr·ª£ mapping UI hi·ªáu qu·∫£.

---

### 8.1. `auth_method`

| Gi√° tr·ªã        | M√¥ t·∫£                             | Tr·∫°ng th√°i |
|----------------|------------------------------------|------------|
| `password`     | X√°c th·ª±c b·∫±ng m·∫≠t kh·∫©u truy·ªÅn th·ªëng | ƒêang d√πng |
| `otp`          | M√£ m·ªôt l·∫ßn g·ª≠i qua SMS/email       | D·ª± ki·∫øn h·ªó tr·ª£ |
| `magic_link`   | ƒêƒÉng nh·∫≠p b·∫±ng link (email)        | D·ª± ki·∫øn h·ªó tr·ª£ |

> üîÆ C√≥ th·ªÉ m·ªü r·ªông th√™m c√°c ph∆∞∆°ng th·ª©c: `sso`, `webauthn`, `biometric` trong t∆∞∆°ng lai.

---

### 8.2. `device_type`

| Gi√° tr·ªã    | M√¥ t·∫£             | √Åp d·ª•ng |
|------------|------------------|---------|
| `web`      | Tr√¨nh duy·ªát       | ‚úÖ |
| `ios`      | ·ª®ng d·ª•ng iOS      | ‚úÖ |
| `android`  | ·ª®ng d·ª•ng Android  | ‚úÖ |

> C√°c gi√° tr·ªã n√†y gi√∫p UI filter v√† hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng thi·∫øt b·ªã t∆∞∆°ng ·ª©ng.

---

### 8.3. `session_status` (n·ªôi b·ªô UI)

| Gi√° tr·ªã     | M√¥ t·∫£                         | M√†u s·∫Øc UI (g·ª£i √Ω) |
|-------------|-------------------------------|--------------------|
| `active`    | Phi√™n ƒëang ho·∫°t ƒë·ªông          | Xanh l√° ‚úÖ          |
| `expired`   | H·∫øt h·∫°n                        | X√°m ‚ö™               |
| `revoked`   | B·ªã thu h·ªìi                     | ƒê·ªè ‚ùå               |

> ƒê√¢y l√† d·∫°ng enum n·ªôi b·ªô d√πng cho UI mapping t·ª´ logic `expired_at`, `is_active`. Kh√¥ng c·∫ßn l∆∞u c·ª©ng trong DB.

---

### 8.4. `error.code` (theo ADR-011)

C√°c m√£ l·ªói chu·∫©n h√≥a h·ªó tr·ª£ frontend x·ª≠ l√Ω i18n, fallback logic t·ªët h∆°n:

| Code              | M√¥ t·∫£                         |
|-------------------|-------------------------------|
| `auth.invalid_credentials` | ƒêƒÉng nh·∫≠p th·∫•t b·∫°i |
| `auth.missing_token`       | Thi·∫øu token          |
| `auth.expired_token`       | Token ƒë√£ h·∫øt h·∫°n     |
| `session.not_found`        | Session kh√¥ng t·ªìn t·∫°i |
| `session.already_revoked`  | Session ƒë√£ b·ªã thu h·ªìi |

> üìå N√™n d√πng ƒë·ªãnh d·∫°ng `dot-separated` ƒë·ªÉ d·ªÖ filter theo module (`auth.*`, `session.*`).

---

## 9. üîê Data Access Control

Vi·ªác ki·ªÉm so√°t truy c·∫≠p d·ªØ li·ªáu `auth_sessions` l√† c·ª±c k·ª≥ quan tr·ªçng v√¨:
- D·ªØ li·ªáu li√™n quan ƒë·∫øn danh t√≠nh ng∆∞·ªùi d√πng v√† c√°c h√†nh vi x√°c th·ª±c
- D·ªÖ b·ªã khai th√°c n·∫øu kh√¥ng ƒë∆∞·ª£c b·∫£o v·ªá k·ªπ

---

### üßë‚Äçüíª C·∫•p ƒë·ªô truy c·∫≠p theo Role

| Role                | Truy c·∫≠p phi√™n (`auth_sessions`) | H√†nh ƒë·ªông ƒë∆∞·ª£c ph√©p             |
|---------------------|----------------------------------|---------------------------------|
| `user:read:self`    | Ch·ªâ phi√™n c·ªßa ch√≠nh h·ªç           | Xem danh s√°ch phi√™n, thi·∫øt b·ªã ƒëang ƒëƒÉng nh·∫≠p |
| `user:revoke:self`  | Ch·ªâ phi√™n c·ªßa ch√≠nh h·ªç           | Thu h·ªìi session c·ªßa ch√≠nh m√¨nh |
| `user:read:any`     | M·ªçi phi√™n c·ªßa m·ªçi user           | (Ch·ªâ d√†nh cho admin ho·∫∑c h·ªá th·ªëng) |
| `user:revoke:any`   | Thu h·ªìi m·ªçi phi√™n b·∫•t k·ª≥         | (Ch·ªâ d√†nh cho h·ªá th·ªëng ho·∫∑c b·∫£o m·∫≠t) |

---

### üîê C∆° ch·∫ø ki·ªÉm tra RBAC

M·ªçi truy c·∫≠p t·ªõi session ƒë·ªÅu ph·∫£i qua RBAC middleware, ƒë∆∞·ª£c thi·∫øt k·∫ø theo:
- [ADR-007 - RBAC Strategy](../../../ADR/adr-007-rbac.md)
- [rbac-deep-dive.md](../architecture/rbac-deep-dive.md)

---

### üõë B·∫£o v·ªá d·ªØ li·ªáu nh·∫°y c·∫£m

| Tr∆∞·ªùng                    | B·∫£o v·ªá                        |
|---------------------------|-------------------------------|
| `refresh_token_hash`      | Kh√¥ng bao gi·ªù tr·∫£ v·ªÅ qua API |
| `ip_address`, `location`  | Ch·ªâ hi·ªÉn th·ªã cho ch·ªß s·ªü h·ªØu ho·∫∑c admin c√≥ quy·ªÅn |
| `user_agent`, `device_model` | C√≥ th·ªÉ hi·ªán trong b·∫£ng qu·∫£n l√Ω thi·∫øt b·ªã |

---

### üß† G·ª£i √Ω n√¢ng cao

| T√≠nh nƒÉng | Gi·∫£i ph√°p |
|-----------|-----------|
| Session hijacking prevention | Ch·ªâ cho ph√©p 1 session / thi·∫øt b·ªã n·∫øu ƒë∆∞·ª£c b·∫≠t |
| Tenant isolation (multi-tenant) | Th√™m `tenant_id` v√†o b·∫£ng v√† filter theo `X-Tenant-ID` |

---

## 10. üìò Ph·ª• l·ª•c A ‚Äì Chi·∫øn l∆∞·ª£c ki·ªÉm th·ª≠

Chi·∫øn l∆∞·ª£c ki·ªÉm th·ª≠ d√†nh cho `auth_sessions` c·∫ßn ƒë·∫£m b·∫£o:

- M·ªói phi√™n login ƒë∆∞·ª£c ghi nh·∫≠n ch√≠nh x√°c.
- Token c√≥ v√≤ng ƒë·ªùi v√† t√≠nh h·ª£p l·ªá ƒë√∫ng nh∆∞ thi·∫øt k·∫ø.
- Kh√¥ng c√≥ r√≤ r·ªâ d·ªØ li·ªáu nh·∫°y c·∫£m trong log, API ho·∫∑c response.

---

### 10.1. ‚úÖ Unit Tests

| Module | Test Case ch√≠nh |
|--------|-----------------|
| Session Model | Kh·ªüi t·∫°o phi√™n ƒë√∫ng c·∫•u tr√∫c |
|              | Hash token ƒë√∫ng ƒë·ªãnh d·∫°ng |
|              | Enum kh√¥ng ch·∫•p nh·∫≠n gi√° tr·ªã kh√¥ng h·ª£p l·ªá |
|              | Tr∆∞·ªùng b·∫Øt bu·ªôc (NOT NULL) ho·∫°t ƒë·ªông ƒë√∫ng |
| Token Utility | Hash + so s√°nh refresh_token |
|              | TTL t√≠nh to√°n chu·∫©n |
| Time Logic   | `expired_at` sinh ch√≠nh x√°c |
|              | `last_active_at` c·∫≠p nh·∫≠t ƒë√∫ng |

> M·ª•c ti√™u: ƒë·∫°t 95‚Äì100% coverage cho module token/session

---

### 10.2. üîÅ Integration Tests

| API                       | T√¨nh hu·ªëng ki·ªÉm th·ª≠ ch√≠nh |
|---------------------------|----------------------------|
| POST `/auth/login`        | T·∫°o session m·ªõi, t·∫°o ƒë√∫ng metadata |
|                           | Tr·∫£ v·ªÅ `refresh_token` h·ª£p l·ªá |
| POST `/auth/refresh`      | Token m·ªõi ‚Üí session c≈© b·ªã v√¥ hi·ªáu h√≥a |
| POST `/auth/logout`       | G·ªçi API s·∫Ω c·∫≠p nh·∫≠t `is_active = false` |
| GET `/auth/sessions`      | Tr·∫£ ƒë√∫ng danh s√°ch session thu·ªôc user |
| GET `/auth/sessions/{id}` | Tr·∫£ ƒë√∫ng d·ªØ li·ªáu, t·ª´ ch·ªëi n·∫øu kh√¥ng ƒë√∫ng quy·ªÅn |

> S·ª≠ d·ª•ng database sandbox + stub JWT tokens ƒë·ªÉ ch·∫°y test.

---

### 10.3. üîê Security Tests

| H√¨nh th·ª©c ki·ªÉm th·ª≠ | M·ª•c ti√™u |
|--------------------|----------|
| Token replay       | M·ªôt refresh token ch·ªâ d√πng ƒë∆∞·ª£c 1 l·∫ßn |
| Session hijack     | Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c phi√™n ng∆∞·ªùi kh√°c |
| Token injection    | Token gi·∫£ kh√¥ng ƒë∆∞·ª£c ch·∫•p nh·∫≠n |
| Invalid device     | Thi·∫øt b·ªã gi·∫£ m·∫°o kh√¥ng ghi nh·∫≠n ƒë∆∞·ª£c metadata |

---

### 10.4. üõ† Auto Generated Tests (OpenAPI)

S·ª≠ d·ª•ng `schemathesis`, `dredd`, ho·∫∑c `prance` ƒë·ªÉ:

- Sinh test case t·ª´ `openapi.yaml`
- Ki·ªÉm tra ph·∫£n h·ªìi c√≥ ƒë√∫ng `status code`, `schema`, `required headers`
- X√°c nh·∫≠n `readOnly`, `writeOnly` ho·∫°t ƒë·ªông ƒë√∫ng v·ªõi field nh∆∞ `id`, `refresh_token`

---

### 10.5. üß™ Manual QA Scenarios (Frontend / Mobile)

| T√¨nh hu·ªëng th·ª±c t·∫ø | K·∫øt qu·∫£ mong ƒë·ª£i |
|--------------------|------------------|
| ƒêƒÉng nh·∫≠p t·ª´ 2 thi·∫øt b·ªã | C·∫£ 2 phi√™n ƒë∆∞·ª£c ghi nh·∫≠n |
| Refresh t·ª´ app c≈© | App m·ªõi th·∫•y token c≈© v√¥ hi·ªáu |
| Thu h·ªìi session th·ªß c√¥ng | Session ƒë√≥ logout v√† kh√¥ng d√πng l·∫°i ƒë∆∞·ª£c |

---

### 10.6. üß© Test Cho Migration

- Ch·∫°y migration `alembic` tr√™n database tr·ªëng v√† database th·ª±c t·∫ø (c√≥ d·ªØ li·ªáu)
- ƒê·∫£m b·∫£o backward compatibility n·∫øu s·ª≠a ƒë·ªïi schema `auth_sessions`

---

## 11. üìö Li√™n k·∫øt t√†i li·ªáu

* [Interface Contract](./interface-contract.md)
* [OpenAPI Spec](./openapi.yaml)
* [Design](./design.md)
* [ADR-004 - Security](../../../ADR/adr-004-security.md)
* [ADR-012 - Response Structure](../../../ADR/adr-012-response-structure.md)
* [ADR-030 - Event Schema Governance](../../../ADR/adr-030-event-schema-governance.md)
