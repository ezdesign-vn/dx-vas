# üîê Auth Service Master - Data Model

```
title: Auth Service Master - Data Model
version: 1.1
last_updated: 2025-06-01
author: DX VAS Team
reviewed_by: Stephen Le
```

## 1. Gi·ªõi thi·ªáu

T√†i li·ªáu n√†y m√¥ t·∫£ chi ti·∫øt m√¥ h√¨nh d·ªØ li·ªáu c·ªßa **Auth Service Master** ‚Äì m·ªôt service **c·ªët l√µi** trong h·ªá th·ªëng `dx-vas`, ho·∫°t ƒë·ªông theo ki·∫øn tr√∫c **multi-tenant** v√† **stateless**. Service n√†y ch·ªãu tr√°ch nhi·ªám qu·∫£n l√Ω phi√™n ƒëƒÉng nh·∫≠p (AuthSession) v√† c·∫•u h√¨nh c√°c nh√† cung c·∫•p ƒëƒÉng nh·∫≠p (AuthProviderConfig) nh∆∞ Google OAuth2.

C√°c lo·∫°i d·ªØ li·ªáu ch√≠nh ƒë∆∞·ª£c qu·∫£n l√Ω:
-   Phi√™n ƒëƒÉng nh·∫≠p c·ªßa ng∆∞·ªùi d√πng (`auth_sessions`)
-   C·∫•u h√¨nh OAuth2 provider (`auth_provider_config`)
-   Danh s√°ch s·ª± ki·ªán `processed_events` ƒë·ªÉ ƒë·∫£m b·∫£o idempotency

M√¥ h√¨nh d·ªØ li·ªáu n√†y l√† n·ªÅn t·∫£ng cho vi·ªác ph√°t tri·ªÉn backend, ƒë·ªãnh nghƒ©a API, th·ª±c hi·ªán migration schema, v√† b·∫£o ƒë·∫£m t√≠nh to√†n v·∫πn d·ªØ li·ªáu cho qu√° tr√¨nh x√°c th·ª±c v√† c·∫•p token.

## 2. Ph·∫°m vi D·ªØ li·ªáu Qu·∫£n l√Ω (Scope)

Auth Service Master bao g·ªìm:
-   Qu·∫£n l√Ω phi√™n ƒëƒÉng nh·∫≠p JWT v√† refresh-token (`auth_sessions`)
-   Qu·∫£n l√Ω c·∫•u h√¨nh c√°c nh√† cung c·∫•p x√°c th·ª±c (`auth_provider_config`)
-   X√°c th·ª±c OAuth2, l√†m m·ªõi/thu h·ªìi token
-   Ghi nh·∫≠n s·ª± ki·ªán x·ª≠ l√Ω token ƒë·ªÉ ƒë·∫£m b·∫£o idempotency (`processed_events`)

## 3. Ngo√†i Ph·∫°m Vi (Out of Scope)

Auth Service Master **kh√¥ng** ch·ªãu tr√°ch nhi·ªám qu·∫£n l√Ω:
-   ‚ùå Danh t√≠nh ng∆∞·ªùi d√πng to√†n c·ª•c (qu·∫£n l√Ω b·ªüi `user-service/master`)
-   ‚ùå G√°n ng∆∞·ªùi d√πng v√†o tenant (qu·∫£n l√Ω b·ªüi `sub-user-service`)
-   ‚ùå Ph√¢n quy·ªÅn RBAC (qu·∫£n l√Ω b·ªüi `user-service/master` v√† h·ªá th·ªëng RBAC template)

## 4. M·ª•c ti√™u c·ªßa T√†i li·ªáu M√¥ h√¨nh D·ªØ li·ªáu

-   M√¥ t·∫£ chi ti·∫øt c√°c b·∫£ng d·ªØ li·ªáu c·ªët l√µi c·ªßa Auth Service Master
-   L√†m r√µ c√°c constraint, kh√≥a ch√≠nh, kh√≥a ngo·∫°i, ch·ªâ m·ª•c
-   H·ªó tr·ª£ ph√°t tri·ªÉn backend, OpenAPI spec, migration v√† ki·ªÉm th·ª≠
-   Li√™n k·∫øt v·ªõi c√°c t√†i li·ªáu: `design.md`, `interface-contract.md`, `openapi.yaml`

---

## 5. S∆° ƒë·ªì ERD (Entity Relationship Diagram)

```mermaid
erDiagram
    AUTH_SESSIONS {
        UUID session_id PK
        UUID user_id_global
        UUID tenant_id
        TEXT refresh_token_hash
        TEXT user_agent
        TEXT ip_address
        TIMESTAMPTZ expires_at
        TEXT status
        TEXT last_login_method
        TEXT[] permissions_snapshot
        TIMESTAMPTZ created_at
        TIMESTAMPTZ updated_at
    }

    AUTH_PROVIDER_CONFIG {
        TEXT provider_name PK
        TEXT client_id
        TEXT client_secret
        TEXT redirect_uri
        TEXT[] scopes
        BOOLEAN enabled
        TIMESTAMPTZ created_at
        TIMESTAMPTZ updated_at
    }

    PROCESSED_EVENTS {
        UUID event_id PK
        TEXT consumer_group_name
        TIMESTAMPTZ processed_at
    }
```

---

## 6. Chi ti·∫øt T·ª´ng B·∫£ng

### üìå B·∫£ng: `auth_sessions`

#### üßæ M·ª•c ƒë√≠ch

L∆∞u tr·ªØ c√°c phi√™n l√†m vi·ªác ng∆∞·ªùi d√πng ƒë√£ x√°c th·ª±c, h·ªó tr·ª£ refresh-token, audit v√† ph√¢n quy·ªÅn snapshot.

#### üìú C√¢u l·ªánh `CREATE TABLE`

```sql
CREATE TABLE auth_sessions (
    session_id UUID PRIMARY KEY,
    user_id_global UUID NOT NULL,
    tenant_id UUID NOT NULL,
    refresh_token_hash TEXT NOT NULL,
    user_agent TEXT,
    ip_address TEXT,
    expires_at TIMESTAMPTZ NOT NULL,
    status TEXT NOT NULL CHECK (status IN ('active', 'revoked')),
    last_login_method TEXT,
    permissions_snapshot TEXT[],
    created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);
```

#### üß© Gi·∫£i th√≠ch c·ªôt

| C·ªôt                    | Ki·ªÉu d·ªØ li·ªáu | R√†ng bu·ªôc     | M√¥ t·∫£                                          |
| ---------------------- | ------------ | ------------- | ---------------------------------------------- |
| `session_id`           | UUID         | PK            | ID c·ªßa phi√™n ƒëƒÉng nh·∫≠p                         |
| `user_id_global`       | UUID         | NOT NULL      | ID ng∆∞·ªùi d√πng to√†n c·ª•c (user\_service/master)  |
| `tenant_id`            | UUID         | NOT NULL      | ID c·ªßa tenant m√† phi√™n n√†y ƒëang ho·∫°t ƒë·ªông trong|
| `refresh_token_hash`   | TEXT         | NOT NULL      | BƒÉm c·ªßa refresh token                          |
| `user_agent`           | TEXT         |               | Tr√¨nh duy·ªát thi·∫øt b·ªã                           |
| `ip_address`           | TEXT         |               | IP ƒëƒÉng nh·∫≠p ban ƒë·∫ßu                           |
| `expires_at`           | TIMESTAMPTZ  | NOT NULL      | Th·ªùi ƒëi·ªÉm h·∫øt h·∫°n c·ªßa phi√™n                    |
| `status`               | TEXT         | CHECK (enum)  | `active` ho·∫∑c `revoked`                        |
| `last_login_method`    | TEXT         |               | `local` ho·∫∑c `google`                          |
| `permissions_snapshot` | TEXT\[]      |               | Snapshot quy·ªÅn t·∫°i th·ªùi ƒëi·ªÉm t·∫°o token         |
| `created_at`           | TIMESTAMPTZ  | DEFAULT now() | T·∫°o l·∫ßn ƒë·∫ßu                                    |
| `updated_at`           | TIMESTAMPTZ  | DEFAULT now() | L·∫ßn c·∫≠p nh·∫≠t cu·ªëi                              |

#### üîó Li√™n k·∫øt v√† Index

* Index ƒë·ªÅ xu·∫•t:

  * `(user_id_global)`
  * `(status)`
  * `(expires_at)`

---

### üìå B·∫£ng: `auth_provider_config`

#### üßæ M·ª•c ƒë√≠ch

C·∫•u h√¨nh OAuth2 cho c√°c nh√† cung c·∫•p x√°c th·ª±c nh∆∞ Google.

#### üìú C√¢u l·ªánh `CREATE TABLE`

```sql
CREATE TABLE auth_provider_config (
    provider TEXT PRIMARY KEY,
    client_id TEXT NOT NULL,
    client_secret TEXT NOT NULL,
    auth_url TEXT NOT NULL,
    token_url TEXT NOT NULL,
    user_info_url TEXT NOT NULL,
    scopes TEXT[] NOT NULL,
    enabled BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);
```

#### üß© Gi·∫£i th√≠ch c·ªôt

| C·ªôt             | Ki·ªÉu d·ªØ li·ªáu | R√†ng bu·ªôc     | M√¥ t·∫£                               |
| --------------- | ------------ | ------------- | ----------------------------------- |
| `provider`      | TEXT         | PK            | M√£ ƒë·ªãnh danh provider (`google`, `github`, ...) |
| `client_id`     | TEXT         | NOT NULL      | Client ID do provider c·∫•p           |
| `client_secret` | TEXT         | NOT NULL      | B√≠ m·∫≠t ƒë·ªÉ x√°c th·ª±c                  |
| `auth_url`      | TEXT         | NOT NULL      | URL ƒë·ªÉ client redirect t·ªõi x√°c th·ª±c |
| `token_url`     | TEXT         | NOT NULL      | URL ƒë·ªÉ l·∫•y access_token             |
| `user_info_url` | TEXT         | NOT NULL      | URL ƒë·ªÉ l·∫•y profile user             |
| `scopes`        | TEXT\[]      | NOT NULL      | Quy·ªÅn ƒë∆∞·ª£c y√™u c·∫ßu                  |
| `enabled`       | BOOLEAN      | DEFAULT true  | C√≥ ƒëang b·∫≠t provider n√†y kh√¥ng      |
| `created_at`    | TIMESTAMPTZ  | DEFAULT now() | Th·ªùi ƒëi·ªÉm t·∫°o                       |
| `updated_at`    | TIMESTAMPTZ  | DEFAULT now() | Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t cu·ªëi             |

### üîó R√†ng bu·ªôc kh√≥a ngo·∫°i

- `user_id_global` **(logic)** tham chi·∫øu ƒë·∫øn `users_global.user_id` t·ª´ User Service Master (qua HTTP call, kh√¥ng FK th·ª±c trong DB).
- `tenant_id` **(logic)** tham chi·∫øu ƒë·∫øn `tenants.tenant_id` t·ª´ User Service Master.

---

## 7. C√°c b·∫£ng ph·ª• tr·ª£

### üîÑ B·∫£ng: `processed_events`

#### üìå M·ª•c ƒë√≠ch

Ghi nh·∫≠n s·ª± ki·ªán ƒë√£ x·ª≠ l√Ω ƒë·ªÉ ƒë·∫£m b·∫£o idempotency.

```sql
CREATE TABLE processed_events (
    event_id UUID PRIMARY KEY,
    consumer_group_name TEXT NOT NULL,
    processed_at TIMESTAMPTZ DEFAULT now() NOT NULL
);
```

---

## 8. Ph·ª• l·ª•c (T√≥m t·∫Øt Index, ENUM, Ki·ªÉm th·ª≠)

### üìò Ph·ª• l·ª•c A ‚Äì Index

| B·∫£ng                   | C·ªôt ƒë∆∞·ª£c index                           |
| ---------------------- | ---------------------------------------- |
| `auth_sessions`        | `user_id_global`, `status`, `expires_at` |
| `auth_provider_config` | `provider_name`                          |

### üìò Ph·ª• l·ª•c B ‚Äì S·ª± ki·ªán D·ªØ li·ªáu

Auth Service Master c√≥ th·ªÉ ph√°t ra m·ªôt s·ªë s·ª± ki·ªán quan tr·ªçng ƒë·ªÉ ph·ª•c v·ª• m·ª•c ƒë√≠ch audit ho·∫∑c t∆∞∆°ng t√°c h·ªá th·ªëng:

| S·ª± ki·ªán                 | Trigger                                       | Payload ch√≠nh               |
|-------------------------|-----------------------------------------------|-----------------------------|
| `session_created`       | Sau khi x√°c th·ª±c th√†nh c√¥ng (login OAuth2)    | user_id, tenant_id, method  |
| `session_revoked`       | Khi ng∆∞·ªùi d√πng ƒëƒÉng xu·∫•t                      | session_id, revoked_by      |
| `token_refreshed`       | Sau khi d√πng refresh token th√†nh c√¥ng         | user_id, old_session_id     |

### üìò Ph·ª• l·ª•c C ‚Äì ENUMs

* `status` (auth\_sessions): `active`, `revoked`
* `last_login_method`: `local`, `google`

### üìò Ph·ª• l·ª•c D ‚Äì Chi·∫øn l∆∞·ª£c Ki·ªÉm th·ª≠ cho M√¥ h√¨nh D·ªØ li·ªáu

#### 1. M·ª•c ti√™u

ƒê·∫£m b·∫£o r·∫±ng c√°c b·∫£ng d·ªØ li·ªáu trong Auth Service Master (ƒë·∫∑c bi·ªát l√† `auth_sessions` v√† `auth_provider_config`) ƒë∆∞·ª£c tri·ªÉn khai ƒë√∫ng c·∫•u tr√∫c, tu√¢n th·ªß c√°c r√†ng bu·ªôc logic v√† c√≥ th·ªÉ m·ªü r·ªông an to√†n trong qu√° tr√¨nh v·∫≠n h√†nh.

#### 2. C√°c c·∫•p ƒë·ªô ki·ªÉm th·ª≠

| C·∫•p ƒë·ªô ki·ªÉm th·ª≠ | M·ª•c ti√™u | C√¥ng c·ª• | Ghi ch√∫ |
|----------------|---------|--------|--------|
| ‚úÖ Unit Test | Ki·ªÉm th·ª≠ h√†nh vi t·∫°o/x√≥a session, l∆∞u config provider h·ª£p l·ªá | pytest + FactoryBoy | Mock CSDL |
| ‚úÖ Integration Test | Ki·ªÉm th·ª≠ thao t√°c v·ªõi b·∫£ng th·ª±c t·∫ø trong Postgres | pytest + testcontainers | S·ª≠ d·ª•ng CSDL th·∫≠t |
| ‚úÖ Migration Test | ƒê·∫£m b·∫£o schema c√≥ th·ªÉ migrate l√™n/xu·ªëng an to√†n | Alembic + pytest | D√πng tr√™n b·∫£n sao d·ªØ li·ªáu nh·ªè |
| ‚úÖ Constraint Test | ƒê·∫£m b·∫£o c√°c r√†ng bu·ªôc `NOT NULL`, `UNIQUE`, `CHECK`, FK ho·∫°t ƒë·ªông ƒë√∫ng | SQL Test Cases | G√¢y l·ªói c√≥ ch·ªß ƒë√≠ch |
| ‚úÖ Performance Test (t√πy ch·ªçn) | Ki·ªÉm tra hi·ªáu nƒÉng truy v·∫•n session khi c√≥ nhi·ªÅu b·∫£n ghi | pgbench, EXPLAIN ANALYZE | D√πng trong staging |

#### 3. K·ªãch b·∫£n ki·ªÉm th·ª≠ ti√™u bi·ªÉu

**AuthSession Table**
- ‚úÖ T·∫°o session h·ª£p l·ªá v·ªõi `user_id`, `tenant_id`, `refresh_token` ‚Üí th√†nh c√¥ng
- ‚úÖ Kh√¥ng c√≥ `user_id` ‚Üí b·ªã l·ªói `NOT NULL`
- ‚úÖ G√°n session cho user kh√¥ng t·ªìn t·∫°i ‚Üí l·ªói `FK`
- ‚úÖ T·∫°o nhi·ªÅu session cho c√πng 1 user ‚Üí ƒë∆∞·ª£c ph√©p (nhi·ªÅu device)
- ‚úÖ Truy v·∫•n nhanh theo `refresh_token` (index test)

**AuthProviderConfig Table**
- ‚úÖ Th√™m c·∫•u h√¨nh m·ªõi v·ªõi `provider = google` ‚Üí th√†nh c√¥ng
- ‚úÖ C·∫≠p nh·∫≠t `client_secret` ‚Üí d·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng
- ‚úÖ Th√™m `provider` ƒë√£ t·ªìn t·∫°i ‚Üí b·ªã l·ªói `PK`
- ‚úÖ X√≥a provider ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng ‚Üí h√†nh vi t√πy theo cascade (n√™n `RESTRICT`)

#### 4. Tu√¢n th·ªß quy tr√¨nh CI/CD

- M·ªói thay ƒë·ªïi trong schema ph·∫£i ƒëi k√®m v·ªõi:
  - ‚úÖ File migration t∆∞∆°ng ·ª©ng (Alembic)
  - ‚úÖ Unit test ho·∫∑c integration test ki·ªÉm ch·ª©ng
  - ‚úÖ ƒê∆∞·ª£c ki·ªÉm th·ª≠ t·ª± ƒë·ªông trong GitHub Actions/CI pipeline

#### 5. K·∫øt lu·∫≠n

Vi·ªác ki·ªÉm th·ª≠ m√¥ h√¨nh d·ªØ li·ªáu l√† m·ªôt ph·∫ßn quan tr·ªçng ƒë·ªÉ ƒë·∫£m b·∫£o h·ªá th·ªëng Auth Service Master v·∫≠n h√†nh ·ªïn ƒë·ªãnh, tin c·∫≠y v√† d·ªÖ m·ªü r·ªông. C√°c ki·ªÉm th·ª≠ c·∫ßn ƒë∆∞·ª£c duy tr√¨ nh∆∞ m·ªôt ph·∫ßn c·ªßa quy tr√¨nh ph√°t tri·ªÉn chu·∫©n h√≥a.


### üìò Ph·ª• l·ª•c E ‚Äì T√†i li·ªáu li√™n k·∫øt

‚úÖ ƒê√£ tham chi·∫øu t·ª´:

* [Thi·∫øt k·∫ø t·ªïng quan (`design.md`)](./design.md)
* [H·ª£p ƒë·ªìng Giao di·ªán API (`interface-contract.md`)](./interface-contract.md)
* [ƒê·∫∑c t·∫£ OpenAPI (`openapi.yaml`)](./openapi.yaml)

‚úÖ Tu√¢n th·ªß c√°c ADR li√™n quan

- [ADR-011 - API Error Format](../../ADR/adr-011-api-error-format.md)
- [ADR-012 - Response Envelope Structure](../../ADR/adr-012-response-structure.md)
- [ADR-023 - Database Migration Strategy](../../ADR/adr-023-db-migration.md)
- [ADR-024 - Data Retention Policy](../../ADR/adr-024-data-retention.md)
- [ADR-026 - Hard Delete Strategy](../../ADR/adr-026-hard-delete.md)