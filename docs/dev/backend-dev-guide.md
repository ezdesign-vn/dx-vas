# üõ†Ô∏è Backend Dev Guide ‚Äì dx-vas

T√†i li·ªáu n√†y d√†nh cho l·∫≠p tr√¨nh vi√™n backend trong h·ªá th·ªëng dx-vas. M·ª•c ti√™u l√† cung c·∫•p quy chu·∫©n v√† h∆∞·ªõng d·∫´n chi ti·∫øt v·ªÅ c√°ch ph√°t tri·ªÉn service backend: c·∫•u tr√∫c th∆∞ m·ª•c, ph√¢n t·∫ßng logic, x·ª≠ l√Ω nghi·ªáp v·ª•, vi·∫øt test, v√† th·ª±c thi c√°c ti√™u chu·∫©n ch·∫•t l∆∞·ª£ng code.

---

## M·ª•c l·ª•c

1. [Ph·∫°m vi & nguy√™n t·∫Øc](#1-ph·∫°m-vi--nguy√™n-t·∫Øc)
2. [C·∫•u tr√∫c th∆∞ m·ª•c backend chu·∫©n](#2-c·∫•u-tr√∫c-th∆∞-m·ª•c-backend-chu·∫©n)
3. [Ph√¢n t·∫ßng logic & vai tr√≤](#3-ph√¢n-t·∫ßng-logic--vai-tr√≤)
4. [ƒê·∫∑t t√™n & convention code](#4-ƒë·∫∑t-t√™n--convention-code)
5. [X·ª≠ l√Ω nghi·ªáp v·ª• & usecase m·∫´u](#5-x·ª≠-l√Ω-nghi·ªáp-v·ª•--usecase-m·∫´u)
6. [Schema & validation (Pydantic)](#6-schema--validation-pydantic)
7. [X·ª≠ l√Ω l·ªói & th√¥ng b√°o](#7-x·ª≠-l√Ω-l·ªói--th√¥ng-b√°o)
8. [Repository & truy xu·∫•t d·ªØ li·ªáu](#8-repository--truy-xu·∫•t-d·ªØ-li·ªáu)
9. [Pub/Sub subscriber & idempotency](#9-pubsub-subscriber--idempotency)
10. [Test ƒë∆°n v·ªã & t√≠ch h·ª£p](#10-test-ƒë∆°n-v·ªã--t√≠ch-h·ª£p)
11. [Checklist khi t·∫°o PR backend](#11-checklist-khi-t·∫°o-pr-backend)
12. [T√†i li·ªáu li√™n quan](#12-t√†i-li·ªáu-li√™n-quan)

---

## 1. Ph·∫°m vi & nguy√™n t·∫Øc

T√†i li·ªáu n√†y d√†nh ri√™ng cho c√°c th√†nh vi√™n ph√°t tri·ªÉn backend trong h·ªá th·ªëng dx-vas ‚Äì n∆°i m·ªçi service backend ƒë∆∞·ª£c vi·∫øt theo ki·∫øn tr√∫c microservice, m·ªói service l√† 1 repo ri√™ng bi·ªát (multi-repo), tri·ªÉn khai qua Cloud Run.

M·ª•c ti√™u ch√≠nh:

- L√†m r√µ c√°ch ph√¢n t·∫ßng, t·ªï ch·ª©c logic nghi·ªáp v·ª•
- Chu·∫©n h√≥a c√°ch vi·∫øt schema, x·ª≠ l√Ω l·ªói v√† truy c·∫≠p DB
- ƒê·∫£m b·∫£o testability, maintainability v√† kh·∫£ nƒÉng m·ªü r·ªông c·ªßa codebase

### ‚ú≥Ô∏è Nguy√™n t·∫Øc c·ªët l√µi

1. **T√°ch r√µ domain logic kh·ªèi framework** (FastAPI ch·ªâ l√† adapter)
2. **M·ªói service ph·∫£i d·ªÖ test t·ª´ng t·∫ßng ƒë·ªôc l·∫≠p**
3. **Kh√¥ng ƒë·ªÉ logic nghi·ªáp v·ª• r√≤ r·ªâ v√†o controller (route handler)**
4. **Tr√°nh hardcode ‚Äì d√πng config & DI h·ª£p l√Ω**
5. **Ph√¢n bi·ªát r√µ DTO (schema), model, entity v√† context**
6. **T√¥n tr·ªçng ƒë∆°n nhi·ªám ‚Äì m·ªói h√†m/class c√≥ 1 vai tr√≤**

üìé T√†i li·ªáu n√†y kh√¥ng l·∫∑p l·∫°i CI/CD hay c·∫•u tr√∫c repo (ƒë√£ c√≥ ·ªü Dev Guide), m√† t·∫≠p trung v√†o:
- Usecase backend (handlers, service, repo)
- Convention ph√¢n t·∫ßng
- Test v√† best practice

---

## 2. C·∫•u tr√∫c th∆∞ m·ª•c backend chu·∫©n

T·∫•t c·∫£ c√°c service backend trong dx-vas n√™n tu√¢n theo c·∫•u tr√∫c th∆∞ m·ª•c chu·∫©n d∆∞·ªõi ƒë√¢y ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n v√† d·ªÖ b·∫£o tr√¨:

```

app/
‚îú‚îÄ‚îÄ api/              # Router, route handler (FastAPI)
‚îÇ   ‚îî‚îÄ‚îÄ v1/
‚îÇ       ‚îî‚îÄ‚îÄ user.py   # Endpoint ƒë·ªãnh nghƒ©a HTTP
‚îú‚îÄ‚îÄ schemas/          # Pydantic schema (request, response)
‚îÇ   ‚îî‚îÄ‚îÄ user.py
‚îú‚îÄ‚îÄ services/         # Business logic (Usecase Layer)
‚îÇ   ‚îî‚îÄ‚îÄ user\_service.py
‚îú‚îÄ‚îÄ repositories/     # Truy c·∫≠p DB, ORM / SQL
‚îÇ   ‚îî‚îÄ‚îÄ user\_repo.py
‚îú‚îÄ‚îÄ models/           # SQLAlchemy model (DB mapping)
‚îÇ   ‚îî‚îÄ‚îÄ user.py
‚îú‚îÄ‚îÄ core/             # C·∫•u h√¨nh, DI, security
‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îî‚îÄ‚îÄ security.py
‚îú‚îÄ‚îÄ events/           # Pub/Sub subscriber, publisher
‚îú‚îÄ‚îÄ deps.py           # Dependency Injection (DB, current\_user...)
‚îî‚îÄ‚îÄ main.py           # Entry point FastAPI

```

### üìå M·ªôt s·ªë quy ∆∞·ªõc chung

- `services/` ch·ªâ ch·ª©a logic nghi·ªáp v·ª•, kh√¥ng g·ªçi tr·ª±c ti·∫øp DB hay HTTP
- `repositories/` l√† l·ªõp duy nh·∫•t t∆∞∆°ng t√°c tr·ª±c ti·∫øp v·ªõi DB
- `schemas/` ch·ªâ d√πng cho request/response ‚Äì kh√¥ng d√πng l√†m entity ho·∫∑c DB model
- `events/` c√≥ th·ªÉ chia nh·ªè th√†nh `subscriber/`, `publisher/` n·∫øu c·∫ßn

### üìé G·ª£i √Ω

- N·∫øu service c√≥ ph·∫ßn x·ª≠ l√Ω RBAC ri√™ng ‚Üí c√≥ th·ªÉ th√™m `rbac/`
- N·∫øu c·∫ßn chia nh·ªè service l·ªõn (VD: SIS Adapter) ‚Üí chia th√†nh module theo domain (`student/`, `classroom/`, `fee/`)

---

## 3. Ph√¢n t·∫ßng logic & vai tr√≤

dx-vas √°p d·ª•ng m√¥ h√¨nh **3-layer architecture** cho backend, nh·∫±m t√°ch bi·ªát r√µ r√†ng gi·ªØa:

1. **Presentation Layer (API Handler)** ‚Äì ti·∫øp nh·∫≠n request t·ª´ client
2. **Service Layer (Usecase)** ‚Äì x·ª≠ l√Ω logic nghi·ªáp v·ª•
3. **Data Layer (Repository)** ‚Äì truy xu·∫•t d·ªØ li·ªáu t·ª´ DB ho·∫∑c b√™n th·ª© ba

---

### üß± T·∫ßng 1: API Handler (`app/api/`)

- N∆°i ƒë·ªãnh nghƒ©a c√°c route, s·ª≠ d·ª•ng FastAPI router
- G·ªçi service layer, validate input, tr·∫£ response
- Kh√¥ng ch·ª©a logic nghi·ªáp v·ª• ho·∫∑c x·ª≠ l√Ω d·ªØ li·ªáu ph·ª©c t·∫°p

```python
@router.get(\"/users/{id}\", response_model=UserOut)
def get_user(id: UUID, user_svc: UserService = Depends(get_user_service)):
    return user_svc.get_user(id)
````

---

### ‚öôÔ∏è T·∫ßng 2: Service Layer (`app/services/`)

* N∆°i x·ª≠ l√Ω to√†n b·ªô logic nghi·ªáp v·ª•: validate rule, x·ª≠ l√Ω business exception, g·ªçi repository
* ƒê∆∞·ª£c test ri√™ng b·∫±ng unit test
* Kh√¥ng g·ªçi tr·ª±c ti·∫øp HTTP, DB, FastAPI context

```python
class UserService:
    def __init__(self, user_repo: UserRepo):
        self.repo = user_repo

    def get_user(self, id: UUID) -> UserOut:
        user = self.repo.get(id)
        if not user:
            raise UserNotFound()
        return user
```

---

### üóÉÔ∏è T·∫ßng 3: Repository Layer (`app/repositories/`)

* T∆∞∆°ng t√°c v·ªõi DB qua SQLAlchemy / SQLModel
* L√† n∆°i duy nh·∫•t ƒë∆∞·ª£c g·ªçi DB query tr·ª±c ti·∫øp
* C√≥ th·ªÉ chia nh·ªè theo entity

```python
class UserRepo:
    def get(self, id: UUID) -> Optional[User]:
        return self.session.query(User).filter(User.id == id).first()
```

---

### üí° L∆∞u √Ω b·ªï sung

| Th√†nh ph·∫ßn | ƒê∆∞·ª£c ph√©p g·ªçi   | Kh√¥ng ƒë∆∞·ª£c g·ªçi  |
| ---------- | --------------- | --------------- |
| Handler    | Service, Schema | Repo, Model     |
| Service    | Repo, Schema    | Handler, DB     |
| Repo       | Model           | Schema, Service |

> ‚úÖ M√¥ h√¨nh n√†y gi√∫p d·ªÖ test, d·ªÖ refactor, v√† d·ªÖ scale t·ª´ng t·∫ßng khi c·∫ßn.

---

## 4. ƒê·∫∑t t√™n & convention code

Vi·ªác ƒë·∫∑t t√™n r√µ r√†ng, nh·∫•t qu√°n gi√∫p code d·ªÖ ƒë·ªçc, d·ªÖ review v√† d·ªÖ b·∫£o tr√¨. dx-vas s·ª≠ d·ª•ng convention theo ki·ªÉu **snake_case cho file/bi·∫øn**, **CamelCase cho class**, v√† **lowercase-with-dash cho route**.

---

### üìÅ T√™n file & th∆∞ m·ª•c

| Lo·∫°i | Quy t·∫Øc | V√≠ d·ª• |
|------|---------|-------|
| Th∆∞ m·ª•c module | snake_case | `user_service/`, `classroom/` |
| File schema | snake_case | `user.py`, `role.py` |
| File repo/service | snake_case | `user_repo.py`, `user_service.py` |

---

### üî§ T√™n class

| Lo·∫°i | Quy t·∫Øc | V√≠ d·ª• |
|------|--------|-------|
| Pydantic schema | CamelCase | `UserCreate`, `RoleOut` |
| Service | CamelCase | `UserService`, `PermissionService` |
| SQLAlchemy model | CamelCase | `User`, `Classroom` |
| Exception | CamelCase + `Error` | `UserNotFoundError` |

---

### üåê ƒê·∫∑t t√™n route (API path)

- Lowercase, n·ªëi b·∫±ng `-`, d√πng danh t·ª´
- Phi√™n b·∫£n h√≥a b·∫±ng prefix `/v1`
- H√†nh ƒë·ªông th·ªÉ hi·ªán qua method: GET/POST/PATCH/DELETE

| M·ª•c ti√™u | Method | Route |
|----------|--------|--------|
| L·∫•y user | GET | `/v1/users/{id}` |
| T·∫°o m·ªõi user | POST | `/v1/users` |
| C·∫≠p nh·∫≠t user | PATCH | `/v1/users/{id}` |
| Xo√° user | DELETE | `/v1/users/{id}` |

---

### üí¨ T√™n bi·∫øn & h√†m

- snake_case cho bi·∫øn, h√†m, argument
- T√™n n√™n r√µ r√†ng, kh√¥ng vi·∫øt t·∫Øt kh√≥ hi·ªÉu

| Kh√¥ng n√™n | N√™n d√πng |
|-----------|----------|
| `u`, `res` | `user`, `response` |
| `get()` | `get_user_by_id()` |
| `svc` | `user_service` |

---

üìé Tham kh·∫£o convention PEP8 + Black formatting (auto format ƒë∆∞·ª£c trong CI/CD).

---

## 5. X·ª≠ l√Ω nghi·ªáp v·ª• & usecase m·∫´u

T·∫ßng Service (Usecase Layer) l√† n∆°i x·ª≠ l√Ω logic nghi·ªáp v·ª• ch√≠nh trong m·ªói service. C√°c class ·ªü t·∫ßng n√†y c·∫ßn ƒë·ªôc l·∫≠p v·ªõi framework (FastAPI, SQLAlchemy...) v√† c√≥ th·ªÉ ƒë∆∞·ª£c test ƒë∆°n l·∫ª.

---

### üß© M·ªôt usecase m·∫´u ‚Äì C·∫≠p nh·∫≠t th√¥ng tin h·ªçc sinh

Gi·∫£ s·ª≠ route PATCH `/students/{id}` nh·∫≠n th√¥ng tin c·∫≠p nh·∫≠t v√† g·ªçi ƒë·∫øn t·∫ßng Service nh∆∞ sau:

#### 1. Schema ƒë·∫ßu v√†o (`schemas/student.py`)
```python
class StudentUpdate(BaseModel):
    name: Optional[str]
    birthday: Optional[date]
````

#### 2. API Handler (`api/v1/student.py`)

```python
@router.patch(\"/students/{id}\", response_model=StudentOut)
def update_student(id: UUID, payload: StudentUpdate, svc: StudentService = Depends(get_service)):
    return svc.update_student(id, payload)
```

#### 3. Service (`services/student_service.py`)

```python
class StudentService:
    def __init__(self, repo: StudentRepo):
        self.repo = repo

    def update_student(self, id: UUID, payload: StudentUpdate) -> StudentOut:
        student = self.repo.get(id)
        if not student:
            raise StudentNotFoundError()
        student.name = payload.name or student.name
        student.birthday = payload.birthday or student.birthday
        updated = self.repo.save(student)
        return StudentOut.from_orm(updated)
```

#### 4. Repository (`repositories/student_repo.py`)

```python
class StudentRepo:
    def get(self, id: UUID) -> Optional[Student]:
        return self.session.query(Student).filter(Student.id == id).first()

    def save(self, student: Student) -> Student:
        self.session.add(student)
        self.session.commit()
        return student
```

---

### ‚úÖ Ghi nh·ªõ khi vi·∫øt usecase

| Y√™u c·∫ßu                                 | Gi·∫£i th√≠ch                                              |
| --------------------------------------- | ------------------------------------------------------- |
| Kh√¥ng g·ªçi tr·ª±c ti·∫øp DB trong service    | Lu√¥n qua repository                                     |
| Kh√¥ng x·ª≠ l√Ω response trong service      | Service tr·∫£ object/data, kh√¥ng `JSONResponse`           |
| Kh√¥ng raise HTTPException trong service | Ch·ªâ raise `domain error`, handler s·∫Ω map sang HTTP code |
| Logic r·∫Ω nh√°nh n√™n r√µ r√†ng              | Tr√°nh if/else l·ªìng qu√° s√¢u                              |

---

üìé Tham kh·∫£o m·∫´u to√†n di·ªán t·∫°i: [`dx-user-service`](https://github.com/vas-org/dx-user-service)

---

## 6. Schema & validation (Pydantic)

T·∫•t c·∫£ request/response ƒë·∫ßu v√†o ra c·ªßa API trong dx-vas ƒë·ªÅu s·ª≠ d·ª•ng **Pydantic schema** ƒë·ªÉ ƒë·∫£m b·∫£o type safety, validate d·ªØ li·ªáu v√† sinh t√†i li·ªáu OpenAPI.

---

### üì¶ Ph√¢n lo·∫°i schema

| M·ª•c ƒë√≠ch | ƒê·∫∑t t√™n | V√≠ d·ª• |
|----------|---------|-------|
| Input t·ª´ request | `*Create`, `*Update`, `*In` | `UserCreate`, `StudentUpdate` |
| Output tr·∫£ v·ªÅ | `*Out`, `*Response` | `UserOut`, `ScoreResponse` |
| DB schema (tu·ª≥ ch·ªçn) | `*DB` | `UserDB` |
| Schema n·ªôi b·ªô | `*Payload`, `*Data` | `NotificationPayload` |

---

### ‚úÖ V√≠ d·ª• schema ‚Äì Student

```python
class StudentCreate(BaseModel):
    name: str = Field(..., min_length=2)
    birthday: date
    class_id: UUID

class StudentOut(BaseModel):
    id: UUID
    name: str
    birthday: date
    class_name: Optional[str]
````

---

### ‚ö†Ô∏è L∆∞u √Ω khi d√πng schema

* D√πng `Field(...)` ƒë·ªÉ validate field r√µ r√†ng
* Kh√¥ng ƒë·∫∑t default = None n·∫øu field b·∫Øt bu·ªôc
* Kh√¥ng d√πng schema output l√†m model DB ho·∫∑c input
* Tr√°nh schema qu√° s√¢u/l·ªìng nhau ph·ª©c t·∫°p ‚Äì n√™n t√°ch nh·ªè
* N·∫øu `orm_mode = True` ‚Üí schema d√πng ƒë∆∞·ª£c `.from_orm(obj)`

---

### üìé Tips n√¢ng cao

* C√≥ th·ªÉ k·∫ø th·ª´a schema:

```python
class StudentBase(BaseModel):
    name: str
    birthday: date

class StudentCreate(StudentBase):
    class_id: UUID
```

* T√°ch ri√™ng `PaginationMeta`, `ErrorEnvelope`... d√πng chung to√†n h·ªá th·ªëng t·∫°i `schemas/common.py`

---

üìé Schema chu·∫©n c·ªßa to√†n h·ªá th·ªëng ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a t·∫°i:
[`dx-service-template/schemas/common.py`](https://github.com/vas-org/dx-service-template)

---

## 7. X·ª≠ l√Ω l·ªói & th√¥ng b√°o

dx-vas chu·∫©n ho√° c∆° ch·∫ø x·ª≠ l√Ω l·ªói ƒë·ªÉ API consistent, d·ªÖ debug v√† d·ªÖ theo d√µi log. M·ªói service ƒë·ªÅu tr·∫£ v·ªÅ l·ªói theo d·∫°ng `ErrorEnvelope` chu·∫©n v√† s·ª≠ d·ª•ng exception theo t·ª´ng t·∫ßng.

---

### üöß C·∫•u tr√∫c l·ªói chu·∫©n

```json
{
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "Ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i",
    "details": null
  },
  "meta": {
    "request_id": "abc-xyz-123",
    "timestamp": "2025-06-01T12:00:00Z"
  }
}
````

---

### üí¢ Ph√¢n t·∫ßng x·ª≠ l√Ω l·ªói

| T·∫ßng         | Lo·∫°i exception            | V√≠ d·ª•                                    |
| ------------ | ------------------------- | ---------------------------------------- |
| API (router) | HTTPException, 422        | FastAPI s·∫Ω auto catch                    |
| Service      | DomainError               | `UserNotFoundError`, `InvalidScoreError` |
| Repo         | Optional + catch DB error | `SQLAlchemyError`, rollback              |

---

### üß± Base error d√πng chung

```python
class DomainError(Exception):
    code = \"UNSPECIFIED_ERROR\"
    message = \"C√≥ l·ªói x·∫£y ra\"

    def __init__(self, detail=None):
        self.detail = detail

class UserNotFoundError(DomainError):
    code = \"USER_NOT_FOUND\"
    message = \"Ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i\"
```

Trong route handler:

```python
try:
    user = svc.get_user(id)
except DomainError as e:
    raise HTTPException(status_code=404, detail={
        \"code\": e.code,
        \"message\": e.message,
        \"details\": e.detail
    })
```

---

### üîÅ Mapping l·ªói ‚Üí m√£ HTTP

| Domain Error       | HTTP code |
| ------------------ | --------- |
| `NotFoundError`    | 404       |
| `ValidationError`  | 400       |
| `PermissionDenied` | 403       |
| `Conflict`         | 409       |
| `InternalError`    | 500       |

> ‚úÖ Service kh√¥ng ƒë∆∞·ª£c raise `HTTPException`, m√† ch·ªâ raise domain-level error

---

üìé M·∫´u `ErrorEnvelope`, `BaseError` c√≥ s·∫µn trong: [`dx-service-template/schemas/common.py`](https://github.com/vas-org/dx-service-template)

---

## 8. Repository & truy xu·∫•t d·ªØ li·ªáu

Repository l√† t·∫ßng duy nh·∫•t t∆∞∆°ng t√°c tr·ª±c ti·∫øp v·ªõi c∆° s·ªü d·ªØ li·ªáu. M·ª•c ti√™u l√† t√°ch bi·ªát logic nghi·ªáp v·ª• kh·ªèi chi ti·∫øt truy v·∫•n SQL ho·∫∑c ORM.

---

### üì¶ Vai tr√≤ c·ªßa repository

- Qu·∫£n l√Ω session DB (commit, rollback)
- T∆∞∆°ng t√°c SQLAlchemy model
- Tr·∫£ v·ªÅ entity/raw data, kh√¥ng map sang schema
- C√≥ th·ªÉ group theo domain (`student_repo.py`, `classroom_repo.py`)

---

### üß± M·∫´u repository ‚Äì StudentRepo

```python
class StudentRepo:
    def __init__(self, session: Session):
        self.session = session

    def get_by_id(self, id: UUID) -> Optional[Student]:
        return self.session.query(Student).filter(Student.id == id).first()

    def create(self, student: Student) -> Student:
        self.session.add(student)
        self.session.commit()
        return student

    def update(self, student: Student) -> Student:
        self.session.commit()
        return student

    def list_by_class(self, class_id: UUID) -> List[Student]:
        return self.session.query(Student).filter(Student.class_id == class_id).all()
````

---

### üßØ L∆∞u √Ω

| Quy t·∫Øc                                                         | Gi·∫£i th√≠ch                      |
| --------------------------------------------------------------- | ------------------------------- |
| Kh√¥ng tr·∫£ v·ªÅ Pydantic schema                                    | Ch·ªâ tr·∫£ v·ªÅ SQLAlchemy model     |
| Kh√¥ng g·ªçi schema trong repo                                     | Repo kh√¥ng bi·∫øt g√¨ v·ªÅ t·∫ßng tr√™n |
| Lu√¥n ki·ªÉm so√°t session commit                                   | Kh√¥ng ƒë·ªÉ service t·ª± commit DB   |
| Transaction nhi·ªÅu b∆∞·ªõc ‚Üí g√≥i l·∫°i b·∫±ng context ho·∫∑c unit of work | Tr√°nh l·ªói rollback thi·∫øu b∆∞·ªõc   |

---

### üõ† T·∫°o session DB

```python
def get_db() -> Generator:
    session = SessionLocal()
    try:
        yield session
        session.commit()
    except:
        session.rollback()
        raise
    finally:
        session.close()
```

Trong service:

```python
def get_student(self, id: UUID) -> StudentOut:
    with get_db() as session:
        repo = StudentRepo(session)
        return StudentOut.from_orm(repo.get_by_id(id))
```

---

üìé DB schema ‚Üí xem `models/student.py`

üìé C·∫•u h√¨nh DB trong `core/config.py`, session ·ªü `deps.py`

---

## 9. Pub/Sub subscriber & idempotency

M·ªôt s·ªë service backend c·ªßa dx-vas ho·∫°t ƒë·ªông theo m√¥ h√¨nh event-driven ‚Äì nghƒ©a l√† nh·∫≠n s·ª± ki·ªán t·ª´ c√°c topic Pub/Sub v√† x·ª≠ l√Ω b·∫•t ƒë·ªìng b·ªô. Vi·ªác ƒë·∫£m b·∫£o **idempotency** (x·ª≠ l√Ω l·∫∑p l·∫°i kh√¥ng g√¢y l·ªói) l√† b·∫Øt bu·ªôc.

---

### üì¶ C·∫•u tr√∫c th∆∞ m·ª•c g·ª£i √Ω

```

events/
‚îú‚îÄ‚îÄ subscriber/
‚îÇ   ‚îî‚îÄ‚îÄ user\_event\_handler.py
‚îú‚îÄ‚îÄ publisher/
‚îÇ   ‚îî‚îÄ‚îÄ notify\_event.py

````

---

### üì• Vi·∫øt m·ªôt subscriber handler

```python
def handle_user_created(message: PubSubMessage):
    data = message.data  # ƒë√£ decode JSON
    user_id = data[\"user_id\"]

    if repo.has_processed(message.message_id):
        return  # ƒê√£ x·ª≠ l√Ω ‚Üí b·ªè qua

    user = repo.get(user_id)
    if not user:
        raise UserNotFoundError()

    repo.mark_processed(message.message_id)
````

> ‚úÖ `message_id` do Pub/Sub sinh ra ‚Äì ƒë·∫£m b·∫£o duy nh·∫•t

---

### üß™ Idempotency: c√°ch ƒë·∫£m b·∫£o

| K·ªπ thu·∫≠t                              | Ghi ch√∫                                   |
| ------------------------------------- | ----------------------------------------- |
| Ghi log message ƒë√£ x·ª≠ l√Ω              | T·∫°o b·∫£ng `processed_messages(message_id)` |
| Tr√°nh logic g√¢y side effect nhi·ªÅu l·∫ßn | G·ª≠i noti 1 l·∫ßn, t·∫°o record 1 l·∫ßn          |
| Transaction to√†n b·ªô handler           | Commit/rollback to√†n ph·∫ßn                 |
| Retry-safe                            | N·∫øu l·ªói do m·∫°ng ‚Üí message s·∫Ω ƒë∆∞·ª£c retry   |

---

### üß≠ Framework h·ªó tr·ª£

* Google Pub/Sub client (`google-cloud-pubsub`)
* Wrapper: `pubsub_fastapi`, `pubsub-consumer` custom
* C√≥ th·ªÉ t√≠ch h·ª£p v√†o background task trong `main.py`

---

### üßº Cleanup

* D√πng TTL ho·∫∑c cronjob ƒë·ªÉ xo√° b·∫£n ghi `processed_messages` c≈©
* C√≥ th·ªÉ d√πng Redis thay DB n·∫øu c·∫ßn t·ªëc ƒë·ªô cao v√† l∆∞u ng·∫Øn h·∫°n

---

üìé M·∫´u event flow: [System Diagrams](../architecture/system-diagrams.md#5-data-synchronization-flow--ƒë·ªìng-b·ªô-h·ªçc-sinh-crm--sis--lms)

üìé Quy ∆∞·ªõc Pub/Sub topic: [Dev Ops Guide](./ops-guide.md#8-qu·∫£n-l√Ω-pubsub--dead-letter)

---

## 10. Test ƒë∆°n v·ªã & t√≠ch h·ª£p

Vi·∫øt test l√† b·∫Øt bu·ªôc trong m·ªói backend service. dx-vas ∆∞u ti√™n **unit test cho service layer** v√† **integration test cho route + DB + Pub/Sub**.

---

### üß™ C·∫•u tr√∫c th∆∞ m·ª•c test

```

tests/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îî‚îÄ‚îÄ test\_user\_service.py
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ test\_user\_routes.py
‚îÇ   ‚îî‚îÄ‚îÄ test\_pubsub\_event.py
‚îú‚îÄ‚îÄ conftest.py

````

---

### ‚úÖ Unit test ‚Äì Service kh√¥ng ph·ª• thu·ªôc DB

```python
def test_get_user_success():
    fake_repo = MagicMock()
    fake_repo.get.return_value = User(id=1, name=\"John\")

    svc = UserService(fake_repo)
    result = svc.get_user(1)

    assert result.name == \"John\"
````

* D√πng `MagicMock` ƒë·ªÉ m√¥ ph·ªèng repository
* Kh√¥ng c·∫ßn DB ho·∫∑c HTTP client
* Ch·∫°y nhanh, d·ªÖ debug

---

### üîÅ Integration test ‚Äì Route + DB

```python
def test_create_user(client, db_session):
    payload = {\"name\": \"John\"}
    response = client.post(\"/v1/users\", json=payload)
    assert response.status_code == 201
```

* D√πng `TestClient` c·ªßa FastAPI + session test DB
* C√≥ th·ªÉ seed d·ªØ li·ªáu b·∫±ng fixture

---

### üß© Pytest fixture g·ª£i √Ω (`conftest.py`)

```python
@pytest.fixture
def db_session():
    session = SessionLocal()
    yield session
    session.rollback()
    session.close()

@pytest.fixture
def client():
    from app.main import app
    return TestClient(app)
```

---

### üí° L∆∞u √Ω khi vi·∫øt test

| Nguy√™n t·∫Øc                | Gi·∫£i th√≠ch                              |
| ------------------------- | --------------------------------------- |
| T√™n test r√µ r√†ng          | `test_create_user_fail_invalid_email()` |
| Test kh√¥ng ph·ª• thu·ªôc nhau | Kh√¥ng d√πng shared global state          |
| Bao ph·ªß logic r·∫Ω nh√°nh    | Test success, fail, edge case           |
| Mock ƒë√∫ng ch·ªó             | Repo, API external, Pub/Sub client      |

---

üìé Coverage t·ªëi thi·ªÉu y√™u c·∫ßu: 85% cho unit, 70% cho integration
üìé L·ªánh test m·∫´u:

```bash
make test
pytest tests/unit/
pytest --cov=app
```

---

## 11. Checklist khi t·∫°o PR backend

M·ªói Pull Request (PR) backend trong dx-vas c·∫ßn tu√¢n theo checklist sau ƒë·ªÉ ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng, t√≠nh nh·∫•t qu√°n v√† tr√°nh l·ªói khi merge v√†o nh√°nh ch√≠nh.

---

### ‚úÖ Checklist k·ªπ thu·∫≠t

- [ ] T√™n PR r√µ r√†ng, theo format: `[feature] Add create student usecase`
- [ ] Code ƒë√£ format b·∫±ng Black / isort / lint pass
- [ ] ƒê√£ th√™m unit test cho logic nghi·ªáp v·ª•
- [ ] ƒê√£ th√™m integration test cho API / DB / PubSub
- [ ] ƒê·∫£m b·∫£o test pass (`make test`, CI green)
- [ ] Kh√¥ng commit `.env`, file secret ho·∫∑c credential
- [ ] Kh√¥ng hardcode config, API key trong code
- [ ] Schema ƒë·∫ßu v√†o c√≥ validate ƒë·∫ßy ƒë·ªß (Pydantic)
- [ ] Error tr·∫£ v·ªÅ ƒë√∫ng `ErrorEnvelope` chu·∫©n

---

### üìé Checklist logic nghi·ªáp v·ª•

- [ ] N·∫øu c√≥ s·ª≠a DB ‚Üí ƒë√£ vi·∫øt migration
- [ ] N·∫øu th√™m permission ‚Üí c·∫≠p nh·∫≠t file RBAC `permissions.yaml`
- [ ] N·∫øu thay ƒë·ªïi API ‚Üí c·∫≠p nh·∫≠t OpenAPI / `interface-contracts/`
- [ ] N·∫øu ·∫£nh h∆∞·ªüng cross-service ‚Üí ƒë√£ th√¥ng b√°o/ghi ch√∫ r√µ
- [ ] N·∫øu c·∫ßn sync d·ªØ li·ªáu ‚Üí vi·∫øt r√µ flow trong commit message

---

### üîç G·ª£i √Ω review

- Xem flow t·ª´ API ‚Üí Service ‚Üí Repo ‚Üí Test
- Xem logging c√≥ ƒë√∫ng c·∫•p ƒë·ªô, kh√¥ng log sensitive
- Xem logic r·∫Ω nh√°nh ƒë·∫ßy ƒë·ªß ch∆∞a (success, fail, edge case)
- Comment r√µ TODO n·∫øu c√≤n d·ªü dang (v√† ghi task follow-up)

---

üìé Format commit message ‚Üí xem Dev Guide  

üìé Qu·∫£n l√Ω permission ‚Üí xem `rbac-deep-dive.md`  

üìé Migration & version DB ‚Üí xem Dev Ops Guide m·ª•c 7

---

## 12. T√†i li·ªáu li√™n quan

D∆∞·ªõi ƒë√¢y l√† c√°c t√†i li·ªáu n·ªôi b·ªô h·ªó tr·ª£ cho qu√° tr√¨nh ph√°t tri·ªÉn backend trong h·ªá th·ªëng dx-vas. Developer n√™n tham kh·∫£o ƒë·∫ßy ƒë·ªß ƒë·ªÉ n·∫Øm ƒë∆∞·ª£c to√†n b·ªô b·ª©c tranh ki·∫øn tr√∫c, quy tr√¨nh CI/CD, RBAC, interface contracts, v√† v·∫≠n h√†nh.

---

### üìö T√†i li·ªáu ki·∫øn tr√∫c & lu·ªìng h·ªá th·ªëng

| T√†i li·ªáu | M·ª•c ti√™u |
|---------|----------|
| [System Diagrams](../architecture/system-diagrams.md) | T·ªïng quan ki·∫øn tr√∫c, s∆° ƒë·ªì c√°c lu·ªìng nghi·ªáp v·ª• |
| [`rbac-deep-dive.md`](../rbac-deep-dive.md) | Ki·∫øn tr√∫c RBAC ƒë·ªông, JSONB, ph√¢n quy·ªÅn & cache |
| [`interface-contracts/`](../interface-contracts/) | ƒê·ªãnh nghƒ©a OpenAPI + schema li√™n service |

---

### üß™ Dev Guide & CI/CD

| T√†i li·ªáu | M·ª•c ti√™u |
|---------|----------|
| [Dev Guide](./dev-guide.md) | H∆∞·ªõng d·∫´n CI/CD, test, lint, docker h√≥a, PR flow |
| [Dev Ops Guide](./ops-guide.md) | H∆∞·ªõng d·∫´n v·∫≠n h√†nh: Cloud Run, Redis, Pub/Sub |
| [`adr-index.md`](../ADR/adr-index.md) | Danh s√°ch c√°c quy·∫øt ƒë·ªãnh ki·∫øn tr√∫c quan tr·ªçng |

---

### üõ† Service template & example

| Repo | Vai tr√≤ |
|------|---------|
| [`dx-service-template`](https://github.com/vas-org/dx-service-template) | M·∫´u service chu·∫©n (FastAPI, pubsub, test, CI) |
| [`dx-user-service`](https://github.com/vas-org/dx-user-service) | Tri·ªÉn khai m·∫´u: RBAC, JWT, user CRUD |
| [`dx-notification-service`](https://github.com/vas-org/dx-notification-service) | G·ª≠i th√¥ng b√°o Web/Zalo/Email, Pub/Sub event-driven |

---

üìé Developer m·ªõi n√™n ƒë·ªçc theo th·ª© t·ª±:

1. `backend-dev-guide.md` (t√†i li·ªáu n√†y)
2. System Diagrams ‚Üí `rbac-deep-dive.md`
3. Dev Guide ‚Üí Dev Ops Guide

---