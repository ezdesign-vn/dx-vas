
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="TÃ i liá»‡u kiáº¿n trÃºc vÃ  phÃ¡t triá»ƒn cho dá»± Ã¡n Chuyá»ƒn Ä‘á»•i sá»‘ TrÆ°á»ng Viá»‡t Anh." name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://ezdesign-vn.github.io/dx-vas/architecture/rbac-deep-dive/" rel="canonical"/>
<link href="../system-diagrams/" rel="prev"/>
<link href="../../dev-guide/" rel="next"/>
<link href="../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>RBAC Chi tiáº¿t - DX VAS - Docs</title>
<link href="../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#phan-tich-chuyen-sau-kien-truc-phan-quyen-ong-rbac-trong-he-thong-dx-vas">
          Bá» qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Äáº§u trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../.." title="DX VAS - Docs">
<img alt="logo" src="../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              RBAC Chi tiáº¿t
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="TÃ¬m kiáº¿m" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="TÃ¬m kiáº¿m" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="TÃ¬m kiáº¿m" class="md-search__options">
<button aria-label="XoÃ¡" class="md-search__icon md-icon" tabindex="-1" title="XoÃ¡" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../system-diagrams/">
          
  
  
    
  
  Kiáº¿n trÃºc Há»‡ thá»‘ng

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../dev-guide/">
        
  
  
    
  
  HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../services/">
        
  
  
    
  
  Thiáº¿t káº¿ Services

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../ADR/">
          
  
  
    
  
  Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh Ä‘iá»u hÆ°á»›ng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="DX VAS - Docs">
<img alt="logo" src="../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
<span class="md-ellipsis">
    Kiáº¿n trÃºc Há»‡ thá»‘ng
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Kiáº¿n trÃºc Há»‡ thá»‘ng
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../system-diagrams/">
<span class="md-ellipsis">
    SÆ¡ Ä‘á»“ Há»‡ thá»‘ng
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    RBAC Chi tiáº¿t
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    RBAC Chi tiáº¿t
    
  </span>
</a>
<nav aria-label="Má»¥c lá»¥c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Má»¥c lá»¥c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#muc-luc-chi-tiet-phan-tich-kien-truc-phan-quyen-ong-rbac">
<span class="md-ellipsis">
      ğŸ“š Má»¥c lá»¥c Chi tiáº¿t â€“ PhÃ¢n tÃ­ch Kiáº¿n trÃºc PhÃ¢n quyá»n Äá»™ng (RBAC)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#1-tong-quan-inh-nghia-rbac">
<span class="md-ellipsis">
      1. Tá»•ng quan &amp; Äá»‹nh nghÄ©a RBAC
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-phan-tang-quan-ly-inh-danh-phan-quyen">
<span class="md-ellipsis">
      2. PhÃ¢n táº§ng Quáº£n lÃ½ Äá»‹nh danh &amp; PhÃ¢n quyá»n
    </span>
</a>
<nav aria-label="2. PhÃ¢n táº§ng Quáº£n lÃ½ Äá»‹nh danh &amp; PhÃ¢n quyá»n" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#user-service-master">
<span class="md-ellipsis">
      ğŸ§  User Service Master
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sub-user-service-per-tenant">
<span class="md-ellipsis">
      ğŸ§© Sub User Service (per Tenant)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-luong-xac-thuc-phan-quyen-multi-tenant">
<span class="md-ellipsis">
      3. Luá»“ng XÃ¡c thá»±c &amp; PhÃ¢n quyá»n (Multi-Tenant)
    </span>
</a>
<nav aria-label="3. Luá»“ng XÃ¡c thá»±c &amp; PhÃ¢n quyá»n (Multi-Tenant)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#luong-phat-hanh-jwt">
<span class="md-ellipsis">
      ğŸ” Luá»“ng phÃ¡t hÃ nh JWT
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#api-gateway-anh-gia-rbac">
<span class="md-ellipsis">
      ğŸ›¡ï¸ API Gateway Ä‘Ã¡nh giÃ¡ RBAC
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-mo-hinh-du-lieu-rbac-master-vs-sub">
<span class="md-ellipsis">
      4. MÃ´ hÃ¬nh Dá»¯ liá»‡u RBAC (Master vs Sub)
    </span>
</a>
<nav aria-label="4. MÃ´ hÃ¬nh Dá»¯ liá»‡u RBAC (Master vs Sub)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tai-user-service-master-postgresql">
<span class="md-ellipsis">
      ğŸ“¦ Táº¡i User Service Master (PostgreSQL)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tai-sub-user-service-moi-tenant-mariadb">
<span class="md-ellipsis">
      ğŸ“¦ Táº¡i Sub User Service (má»—i tenant â€” MariaDB)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tai-lieu-chi-tiet">
<span class="md-ellipsis">
      ğŸ“˜ TÃ i liá»‡u chi tiáº¿t
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-permission-co-ieu-kien-conditional-permission">
<span class="md-ellipsis">
      5. Permission CÃ³ Äiá»u Kiá»‡n (Conditional Permission)
    </span>
</a>
<nav aria-label="5. Permission CÃ³ Äiá»u Kiá»‡n (Conditional Permission)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-cu-phap-context">
<span class="md-ellipsis">
      5.1 CÃº phÃ¡p &amp; Context
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-vi-du-ieu-kien">
<span class="md-ellipsis">
      5.2 VÃ­ dá»¥ Ä‘iá»u kiá»‡n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-luong-anh-gia-evaluation-flow">
<span class="md-ellipsis">
      5.3 Luá»“ng Ä‘Ã¡nh giÃ¡ (Evaluation Flow)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#54-kich-ban-quan-trong">
<span class="md-ellipsis">
      5.4 Ká»‹ch báº£n quan trá»ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#55-quan-tri-template">
<span class="md-ellipsis">
      5.5 Quáº£n trá»‹ &amp; Template
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-chien-luoc-cache-rbac-tai-api-gateway">
<span class="md-ellipsis">
      6. Chiáº¿n lÆ°á»£c Cache RBAC táº¡i API Gateway
    </span>
</a>
<nav aria-label="6. Chiáº¿n lÆ°á»£c Cache RBAC táº¡i API Gateway" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-co-che-tong-quan">
<span class="md-ellipsis">
      6.1 CÆ¡ cháº¿ tá»•ng quan
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-cau-truc-cache">
<span class="md-ellipsis">
      6.2 Cáº¥u trÃºc cache
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-kiem-tra-token-bi-thu-hoi-revoked">
<span class="md-ellipsis">
      6.3 Kiá»ƒm tra token bá»‹ thu há»“i (revoked)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-invalidation-qua-pubsub">
<span class="md-ellipsis">
      6.4 Invalidation qua Pub/Sub
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#65-quy-tac-ac-biet-cho-bao-cao">
<span class="md-ellipsis">
      6.5 Quy táº¯c Ä‘áº·c biá»‡t cho bÃ¡o cÃ¡o
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-chien-luoc-ong-bo-rbac">
<span class="md-ellipsis">
      7. Chiáº¿n lÆ°á»£c Äá»“ng bá»™ RBAC
    </span>
</a>
<nav aria-label="7. Chiáº¿n lÆ°á»£c Äá»“ng bá»™ RBAC" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-ke-thua-tuy-chinh">
<span class="md-ellipsis">
      7.1 Káº¿ thá»«a &amp; TÃ¹y chá»‰nh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-gan-role-cho-nguoi-dung">
<span class="md-ellipsis">
      7.2 GÃ¡n Role cho NgÆ°á»i dÃ¹ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-ong-bo-invalidate-pubsub">
<span class="md-ellipsis">
      7.3 Äá»“ng bá»™ &amp; Invalidate (Pub/Sub)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-versioning-conflict">
<span class="md-ellipsis">
      7.4 Versioning &amp; Conflict
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#75-ong-bo-inh-ky-tuy-chon">
<span class="md-ellipsis">
      7.5 Äá»“ng bá»™ Ä‘á»‹nh ká»³ (tÃ¹y chá»n)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#76-kpi-monitoring">
<span class="md-ellipsis">
      7.6 KPI &amp; Monitoring
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-hieu-nang-kha-nang-mo-rong">
<span class="md-ellipsis">
      8. Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng
    </span>
</a>
<nav aria-label="8. Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-ky-thuat-toi-uu">
<span class="md-ellipsis">
      8.1 Ká»¹ thuáº­t tá»‘i Æ°u
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-quy-mo-cloud-cloud-scale">
<span class="md-ellipsis">
      8.2 Quy mÃ´ Cloud (Cloud-Scale)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-monitoring-alerting">
<span class="md-ellipsis">
      8.3 Monitoring &amp; Alerting
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#84-inh-huong-toi-uu-tiep-theo">
<span class="md-ellipsis">
      8.4 Äá»‹nh hÆ°á»›ng tá»‘i Æ°u tiáº¿p theo
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-bao-mat-chuyen-sau-trong-rbac">
<span class="md-ellipsis">
      9. Báº£o máº­t chuyÃªn sÃ¢u trong RBAC
    </span>
</a>
<nav aria-label="9. Báº£o máº­t chuyÃªn sÃ¢u trong RBAC" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#isolation-theo-tenant">
<span class="md-ellipsis">
      ğŸ” Isolation theo Tenant
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ten-inh-danh-va-khong-gian-rbac">
<span class="md-ellipsis">
      ğŸ” TÃªn Ä‘á»‹nh danh vÃ  khÃ´ng gian RBAC
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chong-gia-mao-jwt">
<span class="md-ellipsis">
      ğŸ” Chá»‘ng giáº£ máº¡o JWT
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#api-rbac-luon-bao-ve-boi-auth-role">
<span class="md-ellipsis">
      ğŸ” API RBAC luÃ´n báº£o vá»‡ bá»Ÿi Auth + Role
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-giam-sat-go-loi">
<span class="md-ellipsis">
      10. GiÃ¡m sÃ¡t &amp; Gá»¡ lá»—i
    </span>
</a>
<nav aria-label="10. GiÃ¡m sÃ¡t &amp; Gá»¡ lá»—i" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#audit-trail">
<span class="md-ellipsis">
      ğŸªµ Audit Trail
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#debug-flow-tai-gateway">
<span class="md-ellipsis">
      ğŸ§ª Debug Flow táº¡i Gateway
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#metrics">
<span class="md-ellipsis">
      ğŸ“ˆ Metrics
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-best-practices-cho-quan-tri-rbac">
<span class="md-ellipsis">
      11. Best Practices cho Quáº£n trá»‹ RBAC
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-cong-cu-tai-lieu-lien-quan">
<span class="md-ellipsis">
      12. CÃ´ng cá»¥ &amp; TÃ i liá»‡u liÃªn quan
    </span>
</a>
<nav aria-label="12. CÃ´ng cá»¥ &amp; TÃ i liá»‡u liÃªn quan" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#so-o-rbac-phan-tang-user-master-va-sub-user-services">
<span class="md-ellipsis">
      ğŸ” SÆ¡ Ä‘á»“ RBAC PhÃ¢n táº§ng â€“ User Master vÃ  Sub User Services
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#so-o-luong-kiem-tra-rbac-tai-api-gateway">
<span class="md-ellipsis">
      ğŸ” SÆ¡ Ä‘á»“ Luá»“ng Kiá»ƒm tra RBAC táº¡i API Gateway
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#so-o-luong-phat-hanh-jwt-a-tenant">
<span class="md-ellipsis">
      ğŸ”‘ SÆ¡ Ä‘á»“ Luá»“ng PhÃ¡t hÃ nh JWT Äa-Tenant
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../dev-guide/">
<span class="md-ellipsis">
    HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../services/">
<span class="md-ellipsis">
    Thiáº¿t káº¿ Services
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../ADR/">
<span class="md-ellipsis">
    Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Má»¥c lá»¥c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Má»¥c lá»¥c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#muc-luc-chi-tiet-phan-tich-kien-truc-phan-quyen-ong-rbac">
<span class="md-ellipsis">
      ğŸ“š Má»¥c lá»¥c Chi tiáº¿t â€“ PhÃ¢n tÃ­ch Kiáº¿n trÃºc PhÃ¢n quyá»n Äá»™ng (RBAC)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#1-tong-quan-inh-nghia-rbac">
<span class="md-ellipsis">
      1. Tá»•ng quan &amp; Äá»‹nh nghÄ©a RBAC
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-phan-tang-quan-ly-inh-danh-phan-quyen">
<span class="md-ellipsis">
      2. PhÃ¢n táº§ng Quáº£n lÃ½ Äá»‹nh danh &amp; PhÃ¢n quyá»n
    </span>
</a>
<nav aria-label="2. PhÃ¢n táº§ng Quáº£n lÃ½ Äá»‹nh danh &amp; PhÃ¢n quyá»n" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#user-service-master">
<span class="md-ellipsis">
      ğŸ§  User Service Master
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sub-user-service-per-tenant">
<span class="md-ellipsis">
      ğŸ§© Sub User Service (per Tenant)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-luong-xac-thuc-phan-quyen-multi-tenant">
<span class="md-ellipsis">
      3. Luá»“ng XÃ¡c thá»±c &amp; PhÃ¢n quyá»n (Multi-Tenant)
    </span>
</a>
<nav aria-label="3. Luá»“ng XÃ¡c thá»±c &amp; PhÃ¢n quyá»n (Multi-Tenant)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#luong-phat-hanh-jwt">
<span class="md-ellipsis">
      ğŸ” Luá»“ng phÃ¡t hÃ nh JWT
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#api-gateway-anh-gia-rbac">
<span class="md-ellipsis">
      ğŸ›¡ï¸ API Gateway Ä‘Ã¡nh giÃ¡ RBAC
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-mo-hinh-du-lieu-rbac-master-vs-sub">
<span class="md-ellipsis">
      4. MÃ´ hÃ¬nh Dá»¯ liá»‡u RBAC (Master vs Sub)
    </span>
</a>
<nav aria-label="4. MÃ´ hÃ¬nh Dá»¯ liá»‡u RBAC (Master vs Sub)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tai-user-service-master-postgresql">
<span class="md-ellipsis">
      ğŸ“¦ Táº¡i User Service Master (PostgreSQL)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tai-sub-user-service-moi-tenant-mariadb">
<span class="md-ellipsis">
      ğŸ“¦ Táº¡i Sub User Service (má»—i tenant â€” MariaDB)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tai-lieu-chi-tiet">
<span class="md-ellipsis">
      ğŸ“˜ TÃ i liá»‡u chi tiáº¿t
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-permission-co-ieu-kien-conditional-permission">
<span class="md-ellipsis">
      5. Permission CÃ³ Äiá»u Kiá»‡n (Conditional Permission)
    </span>
</a>
<nav aria-label="5. Permission CÃ³ Äiá»u Kiá»‡n (Conditional Permission)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-cu-phap-context">
<span class="md-ellipsis">
      5.1 CÃº phÃ¡p &amp; Context
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-vi-du-ieu-kien">
<span class="md-ellipsis">
      5.2 VÃ­ dá»¥ Ä‘iá»u kiá»‡n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-luong-anh-gia-evaluation-flow">
<span class="md-ellipsis">
      5.3 Luá»“ng Ä‘Ã¡nh giÃ¡ (Evaluation Flow)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#54-kich-ban-quan-trong">
<span class="md-ellipsis">
      5.4 Ká»‹ch báº£n quan trá»ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#55-quan-tri-template">
<span class="md-ellipsis">
      5.5 Quáº£n trá»‹ &amp; Template
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-chien-luoc-cache-rbac-tai-api-gateway">
<span class="md-ellipsis">
      6. Chiáº¿n lÆ°á»£c Cache RBAC táº¡i API Gateway
    </span>
</a>
<nav aria-label="6. Chiáº¿n lÆ°á»£c Cache RBAC táº¡i API Gateway" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-co-che-tong-quan">
<span class="md-ellipsis">
      6.1 CÆ¡ cháº¿ tá»•ng quan
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-cau-truc-cache">
<span class="md-ellipsis">
      6.2 Cáº¥u trÃºc cache
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-kiem-tra-token-bi-thu-hoi-revoked">
<span class="md-ellipsis">
      6.3 Kiá»ƒm tra token bá»‹ thu há»“i (revoked)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-invalidation-qua-pubsub">
<span class="md-ellipsis">
      6.4 Invalidation qua Pub/Sub
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#65-quy-tac-ac-biet-cho-bao-cao">
<span class="md-ellipsis">
      6.5 Quy táº¯c Ä‘áº·c biá»‡t cho bÃ¡o cÃ¡o
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-chien-luoc-ong-bo-rbac">
<span class="md-ellipsis">
      7. Chiáº¿n lÆ°á»£c Äá»“ng bá»™ RBAC
    </span>
</a>
<nav aria-label="7. Chiáº¿n lÆ°á»£c Äá»“ng bá»™ RBAC" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-ke-thua-tuy-chinh">
<span class="md-ellipsis">
      7.1 Káº¿ thá»«a &amp; TÃ¹y chá»‰nh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-gan-role-cho-nguoi-dung">
<span class="md-ellipsis">
      7.2 GÃ¡n Role cho NgÆ°á»i dÃ¹ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-ong-bo-invalidate-pubsub">
<span class="md-ellipsis">
      7.3 Äá»“ng bá»™ &amp; Invalidate (Pub/Sub)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-versioning-conflict">
<span class="md-ellipsis">
      7.4 Versioning &amp; Conflict
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#75-ong-bo-inh-ky-tuy-chon">
<span class="md-ellipsis">
      7.5 Äá»“ng bá»™ Ä‘á»‹nh ká»³ (tÃ¹y chá»n)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#76-kpi-monitoring">
<span class="md-ellipsis">
      7.6 KPI &amp; Monitoring
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-hieu-nang-kha-nang-mo-rong">
<span class="md-ellipsis">
      8. Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng
    </span>
</a>
<nav aria-label="8. Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-ky-thuat-toi-uu">
<span class="md-ellipsis">
      8.1 Ká»¹ thuáº­t tá»‘i Æ°u
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-quy-mo-cloud-cloud-scale">
<span class="md-ellipsis">
      8.2 Quy mÃ´ Cloud (Cloud-Scale)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-monitoring-alerting">
<span class="md-ellipsis">
      8.3 Monitoring &amp; Alerting
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#84-inh-huong-toi-uu-tiep-theo">
<span class="md-ellipsis">
      8.4 Äá»‹nh hÆ°á»›ng tá»‘i Æ°u tiáº¿p theo
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-bao-mat-chuyen-sau-trong-rbac">
<span class="md-ellipsis">
      9. Báº£o máº­t chuyÃªn sÃ¢u trong RBAC
    </span>
</a>
<nav aria-label="9. Báº£o máº­t chuyÃªn sÃ¢u trong RBAC" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#isolation-theo-tenant">
<span class="md-ellipsis">
      ğŸ” Isolation theo Tenant
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ten-inh-danh-va-khong-gian-rbac">
<span class="md-ellipsis">
      ğŸ” TÃªn Ä‘á»‹nh danh vÃ  khÃ´ng gian RBAC
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chong-gia-mao-jwt">
<span class="md-ellipsis">
      ğŸ” Chá»‘ng giáº£ máº¡o JWT
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#api-rbac-luon-bao-ve-boi-auth-role">
<span class="md-ellipsis">
      ğŸ” API RBAC luÃ´n báº£o vá»‡ bá»Ÿi Auth + Role
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-giam-sat-go-loi">
<span class="md-ellipsis">
      10. GiÃ¡m sÃ¡t &amp; Gá»¡ lá»—i
    </span>
</a>
<nav aria-label="10. GiÃ¡m sÃ¡t &amp; Gá»¡ lá»—i" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#audit-trail">
<span class="md-ellipsis">
      ğŸªµ Audit Trail
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#debug-flow-tai-gateway">
<span class="md-ellipsis">
      ğŸ§ª Debug Flow táº¡i Gateway
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#metrics">
<span class="md-ellipsis">
      ğŸ“ˆ Metrics
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-best-practices-cho-quan-tri-rbac">
<span class="md-ellipsis">
      11. Best Practices cho Quáº£n trá»‹ RBAC
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-cong-cu-tai-lieu-lien-quan">
<span class="md-ellipsis">
      12. CÃ´ng cá»¥ &amp; TÃ i liá»‡u liÃªn quan
    </span>
</a>
<nav aria-label="12. CÃ´ng cá»¥ &amp; TÃ i liá»‡u liÃªn quan" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#so-o-rbac-phan-tang-user-master-va-sub-user-services">
<span class="md-ellipsis">
      ğŸ” SÆ¡ Ä‘á»“ RBAC PhÃ¢n táº§ng â€“ User Master vÃ  Sub User Services
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#so-o-luong-kiem-tra-rbac-tai-api-gateway">
<span class="md-ellipsis">
      ğŸ” SÆ¡ Ä‘á»“ Luá»“ng Kiá»ƒm tra RBAC táº¡i API Gateway
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#so-o-luong-phat-hanh-jwt-a-tenant">
<span class="md-ellipsis">
      ğŸ”‘ SÆ¡ Ä‘á»“ Luá»“ng PhÃ¡t hÃ nh JWT Äa-Tenant
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="phan-tich-chuyen-sau-kien-truc-phan-quyen-ong-rbac-trong-he-thong-dx-vas">PhÃ¢n tÃ­ch ChuyÃªn sÃ¢u: Kiáº¿n trÃºc PhÃ¢n quyá»n Äá»™ng (RBAC) trong Há»‡ thá»‘ng dx-vas<a class="headerlink" href="#phan-tich-chuyen-sau-kien-truc-phan-quyen-ong-rbac-trong-he-thong-dx-vas" title="Permanent link">Â¶</a></h1>
<h2 id="muc-luc-chi-tiet-phan-tich-kien-truc-phan-quyen-ong-rbac">ğŸ“š Má»¥c lá»¥c Chi tiáº¿t â€“ PhÃ¢n tÃ­ch Kiáº¿n trÃºc PhÃ¢n quyá»n Äá»™ng (RBAC)<a class="headerlink" href="#muc-luc-chi-tiet-phan-tich-kien-truc-phan-quyen-ong-rbac" title="Permanent link">Â¶</a></h2>
<table>
<thead>
<tr>
<th>STT</th>
<th>TÃªn má»¥c</th>
<th>MÃ´ táº£</th>
<th>LiÃªn káº¿t</th>
</tr>
</thead>
<tbody>
<tr>
<td>1ï¸âƒ£</td>
<td><strong>Tá»•ng quan &amp; Äá»‹nh nghÄ©a RBAC</strong></td>
<td>KhÃ¡i niá»‡m role, permission, condition, Ã¡p dá»¥ng trong kiáº¿n trÃºc Ä‘a tenant</td>
<td><a href="#1-tá»•ng-quan--Ä‘á»‹nh-nghÄ©a-rbac">Xem má»¥c</a></td>
</tr>
<tr>
<td>2ï¸âƒ£</td>
<td><strong>PhÃ¢n táº§ng Quáº£n lÃ½ Äá»‹nh danh &amp; PhÃ¢n quyá»n</strong></td>
<td>Vai trÃ² cá»§a User Service Master vÃ  Sub User Service</td>
<td><a href="#2-phÃ¢n-táº§ng-quáº£n-lÃ½-Ä‘á»‹nh-danh--phÃ¢n-quyá»n">Xem má»¥c</a></td>
</tr>
<tr>
<td>3ï¸âƒ£</td>
<td><strong>Luá»“ng XÃ¡c thá»±c &amp; PhÃ¢n quyá»n (Multi-Tenant)</strong></td>
<td>CÃ¡ch JWT Ä‘Æ°á»£c phÃ¡t hÃ nh vÃ  RBAC Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ táº¡i Gateway</td>
<td><a href="#3-luá»“ng-xÃ¡c-thá»±c--phÃ¢n-quyá»n-multi-tenant">Xem má»¥c</a></td>
</tr>
<tr>
<td>4ï¸âƒ£</td>
<td><strong>MÃ´ hÃ¬nh Dá»¯ liá»‡u RBAC (Master vs Sub)</strong></td>
<td>Chi tiáº¿t cÃ¡c báº£ng schema táº¡i Master vÃ  Sub Service</td>
<td><a href="#4-mÃ´-hÃ¬nh-dá»¯-liá»‡u-rbac-master-vs-sub">Xem má»¥c</a></td>
</tr>
<tr>
<td>5ï¸âƒ£</td>
<td><strong>Permission cÃ³ Ä‘iá»u kiá»‡n (Condition JSONB)</strong></td>
<td>MÃ´ hÃ¬nh <code>condition</code> Ä‘á»™ng dá»±a trÃªn context ngÆ°á»i dÃ¹ng &amp; request</td>
<td><a href="#5-permission-cÃ³-Ä‘iá»u-kiá»‡n-condition-jsonb">Xem má»¥c</a></td>
</tr>
<tr>
<td>6ï¸âƒ£</td>
<td><strong>Chiáº¿n lÆ°á»£c Cache RBAC táº¡i API Gateway</strong></td>
<td>CÃ¡ch Redis cache giÃºp tÄƒng hiá»‡u nÄƒng vÃ  logic invalidation</td>
<td><a href="#6-chiáº¿n-lÆ°á»£c-cache-rbac-táº¡i-api-gateway">Xem má»¥c</a></td>
</tr>
<tr>
<td>7ï¸âƒ£</td>
<td><strong>Chiáº¿n lÆ°á»£c Äá»“ng bá»™ RBAC</strong></td>
<td>Tá»« template Master Ä‘áº¿n Sub User Service (káº¿ thá»«a hoáº·c clone)</td>
<td><a href="#7-chiáº¿n-lÆ°á»£c-Ä‘á»“ng-bá»™-rbac">Xem má»¥c</a></td>
</tr>
<tr>
<td>8ï¸âƒ£</td>
<td><strong>Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng</strong></td>
<td>Ká»¹ thuáº­t tá»‘i Æ°u cache, pub/sub, autoscale theo tenant</td>
<td><a href="#8-hiá»‡u-nÄƒng--kháº£-nÄƒng-má»Ÿ-rá»™ng">Xem má»¥c</a></td>
</tr>
<tr>
<td>9ï¸âƒ£</td>
<td><strong>Báº£o máº­t chuyÃªn sÃ¢u trong RBAC</strong></td>
<td>Isolation theo tenant, JWT trust, Ä‘á»‹nh danh vai trÃ²</td>
<td><a href="#9-báº£o-máº­t-chuyÃªn-sÃ¢u-trong-rbac">Xem má»¥c</a></td>
</tr>
<tr>
<td>ğŸ”Ÿ</td>
<td><strong>GiÃ¡m sÃ¡t &amp; Gá»¡ lá»—i</strong></td>
<td>Audit logs, debug header, metric há»‡ thá»‘ng RBAC</td>
<td><a href="#10-giÃ¡m-sÃ¡t--gá»¡-lá»—i">Xem má»¥c</a></td>
</tr>
<tr>
<td>1ï¸âƒ£1ï¸âƒ£</td>
<td><strong>Best Practices cho Quáº£n trá»‹ RBAC</strong></td>
<td>CÃ¡c khuyáº¿n nghá»‹ tÃªn role, sá»‘ lÆ°á»£ng role/user, phÃ¢n quyá»n tá»‘i Æ°u</td>
<td><a href="#11-best-practices-cho-quáº£n-trá»‹-rbac">Xem má»¥c</a></td>
</tr>
<tr>
<td>1ï¸âƒ£2ï¸âƒ£</td>
<td><strong>CÃ´ng cá»¥ &amp; TÃ i liá»‡u liÃªn quan</strong></td>
<td>LiÃªn káº¿t tá»›i ADR, data-model, sÆ¡ Ä‘á»“, spec JSONB, OpenAPI</td>
<td><a href="#12-cÃ´ng-cá»¥--tÃ i-liá»‡u-liÃªn-quan">Xem má»¥c</a></td>
</tr>
</tbody>
</table>
<h2 id="1-tong-quan-inh-nghia-rbac">1. Tá»•ng quan &amp; Äá»‹nh nghÄ©a RBAC<a class="headerlink" href="#1-tong-quan-inh-nghia-rbac" title="Permanent link">Â¶</a></h2>
<p>RBAC (Role-Based Access Control) trong há»‡ thá»‘ng dx-vas cho phÃ©p kiá»ƒm soÃ¡t quyá»n truy cáº­p má»™t cÃ¡ch linh hoáº¡t vÃ  cÃ³ thá»ƒ má»Ÿ rá»™ng, dá»±a trÃªn:</p>
<ul>
<li><strong>Vai trÃ² ngÆ°á»i dÃ¹ng</strong> (Role) trong tá»«ng trÆ°á»ng thÃ nh viÃªn (tenant)</li>
<li><strong>Táº­p há»£p quyá»n</strong> (Permission) Ä‘Æ°á»£c gÃ¡n cho má»—i role</li>
<li><strong>Äiá»u kiá»‡n thá»±c thi</strong> (Condition, náº¿u cÃ³) Ã¡p dá»¥ng á»Ÿ cáº¥p permission</li>
</ul>
<p>MÃ´ hÃ¬nh RBAC nÃ y hoáº¡t Ä‘á»™ng trong bá»‘i cáº£nh <strong>multi-tenant</strong>, nÆ¡i má»—i tenant (trÆ°á»ng thÃ nh viÃªn) cÃ³ <strong>RBAC Ä‘á»™c láº­p</strong>, nhÆ°ng váº«n káº¿ thá»«a má»™t pháº§n tá»« <strong>template toÃ n há»‡ thá»‘ng</strong> do User Service Master cung cáº¥p.</p>
<hr/>
<h2 id="2-phan-tang-quan-ly-inh-danh-phan-quyen">2. PhÃ¢n táº§ng Quáº£n lÃ½ Äá»‹nh danh &amp; PhÃ¢n quyá»n<a class="headerlink" href="#2-phan-tang-quan-ly-inh-danh-phan-quyen" title="Permanent link">Â¶</a></h2>
<h3 id="user-service-master">ğŸ§  User Service Master<a class="headerlink" href="#user-service-master" title="Permanent link">Â¶</a></h3>
<ul>
<li>LÃ  nguá»“n chÃ¢n lÃ½ duy nháº¥t cho toÃ n bá»™ ngÆ°á»i dÃ¹ng (<code>users_global</code>)</li>
<li>Quáº£n lÃ½:</li>
<li>Danh sÃ¡ch tenant (<code>tenants</code>)</li>
<li>Má»‘i quan há»‡ user â†” tenant (<code>user_tenant_assignments</code>)</li>
<li>CÃ¡c template vai trÃ² vÃ  quyá»n toÃ n há»‡ thá»‘ng:<ul>
<li><code>global_roles_templates</code></li>
<li><code>global_permissions_templates</code></li>
</ul>
</li>
<li>KhÃ´ng trá»±c tiáº¿p Ä‘Ã¡nh giÃ¡ RBAC, mÃ  cung cáº¥p Ä‘á»‹nh danh vÃ  template cho Sub Services</li>
</ul>
<h3 id="sub-user-service-per-tenant">ğŸ§© Sub User Service (per Tenant)<a class="headerlink" href="#sub-user-service-per-tenant" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»—i tenant cÃ³ 1 instance riÃªng, quáº£n lÃ½:</li>
<li>NgÆ°á»i dÃ¹ng thuá»™c tenant (<code>users_in_tenant</code>) â€“ Ã¡nh xáº¡ Ä‘áº¿n <code>user_id_global</code></li>
<li>Tráº¡ng thÃ¡i hoáº¡t Ä‘á»™ng ná»™i bá»™: <code>is_active_in_tenant</code></li>
<li>Vai trÃ² (<code>roles_in_tenant</code>), quyá»n (<code>permissions_in_tenant</code>)</li>
<li>Mapping:<ul>
<li><code>user_role_in_tenant</code></li>
<li><code>role_permission_in_tenant</code></li>
</ul>
</li>
<li>Cho phÃ©p káº¿ thá»«a tá»« template Master hoáº·c tá»± Ä‘á»‹nh nghÄ©a</li>
</ul>
<hr/>
<h2 id="3-luong-xac-thuc-phan-quyen-multi-tenant">3. Luá»“ng XÃ¡c thá»±c &amp; PhÃ¢n quyá»n (Multi-Tenant)<a class="headerlink" href="#3-luong-xac-thuc-phan-quyen-multi-tenant" title="Permanent link">Â¶</a></h2>
<h3 id="luong-phat-hanh-jwt">ğŸ” Luá»“ng phÃ¡t hÃ nh JWT<a class="headerlink" href="#luong-phat-hanh-jwt" title="Permanent link">Â¶</a></h3>
<ol>
<li>NgÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p qua:</li>
<li>Google OAuth2 â†’ Auth Master</li>
<li>OTP/Local â†’ Sub Auth Service</li>
<li>Sau khi xÃ¡c thá»±c:</li>
<li><code>tenant_id</code> Ä‘Æ°á»£c chá»n (náº¿u ngÆ°á»i dÃ¹ng thuá»™c nhiá»u tenant).</li>
<li>Auth Service gá»i <strong>User Service Master</strong> â†’ kiá»ƒm tra <code>user_id_global</code> &amp; quyá»n truy cáº­p tenant.</li>
<li>Gá»i <strong>Sub User Service</strong> â†’ láº¥y <code>roles</code>, <code>permissions</code>.</li>
<li><strong>Gá»i Token Service</strong> <code>POST /token/issue</code> â†’ nháº­n JWT kÃ½ <strong>RS256</strong>.</li>
<li>JWT Ä‘Æ°á»£c phÃ¡t hÃ nh vá»›i:</li>
<li><code>user_id</code>, <code>tenant_id</code>, <code>roles</code>, <code>permissions</code>, <code>auth_provider</code>,</li>
<li><strong><code>jti</code>, <code>sid</code>, <code>exp</code></strong> (phá»¥c vá»¥ thu há»“i token &amp; quáº£n lÃ½ phiÃªn).</li>
</ol>
<h3 id="api-gateway-anh-gia-rbac">ğŸ›¡ï¸ API Gateway Ä‘Ã¡nh giÃ¡ RBAC<a class="headerlink" href="#api-gateway-anh-gia-rbac" title="Permanent link">Â¶</a></h3>
<ul>
<li>XÃ¡c thá»±c chá»¯ kÃ½ JWT <strong>offline</strong> qua <strong>JWKS</strong> cache 10â€².</li>
<li>Kiá»ƒm tra <code>tenant_id</code>, <code>exp</code> vÃ  tráº¡ng thÃ¡i ngÆ°á»i dÃ¹ng (<code>is_active</code>, <code>is_active_in_tenant</code>).</li>
<li>Tra <strong>Redis</strong>: <code>revoked:{jti}</code> â†’ náº¿u <em>hit</em> â‡’ tráº£ <code>403</code> (<code>token.revoked</code>), huá»· cache RBAC.</li>
<li>Truy váº¥n Redis cache RBAC: <code>rbac:{user_id}:{tenant_id}</code> â†’ náº¿u <em>miss</em> gá»i Sub User Service Ä‘á»ƒ náº¡p láº¡i.</li>
<li>ÄÃ¡nh giÃ¡ <code>condition</code> náº¿u permission cÃ³ rÃ ng buá»™c Ä‘á»™ng.</li>
</ul>
<hr/>
<h2 id="4-mo-hinh-du-lieu-rbac-master-vs-sub">4. MÃ´ hÃ¬nh Dá»¯ liá»‡u RBAC (Master vs Sub)<a class="headerlink" href="#4-mo-hinh-du-lieu-rbac-master-vs-sub" title="Permanent link">Â¶</a></h2>
<blockquote>
<p><strong>NguyÃªn táº¯c chung</strong><br/>
<em> </em><em>User Service Master</em><em> (Core â€” PostgreSQL) lÆ°u danh tÃ­nh <em>toÃ n cá»¥c</em> &amp; template RBAC chuáº©n.<br/>
</em> <strong>Sub User Service</strong> (per-tenant â€” MariaDB) chá»‰ lÆ°u RBAC <em>cá»¥c bá»™</em>, Ä‘á»“ng bá»™ báº¥t Ä‘á»“ng bá»™ qua Pub/Sub.<br/>
* Má»i báº£ng pháº£i cÃ³ khoÃ¡ chÃ­nh rÃµ rÃ ng, theo chuáº©n â­2 Data Model Standard.</p>
</blockquote>
<hr/>
<h3 id="tai-user-service-master-postgresql">ğŸ“¦ Táº¡i User Service Master (PostgreSQL)<a class="headerlink" href="#tai-user-service-master-postgresql" title="Permanent link">Â¶</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">-- +flyway</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="c1">-- 4.1  NgÆ°á»i dÃ¹ng toÃ n há»‡ thá»‘ng</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users_global</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="n">user_id</span><span class="w">           </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="n">full_name</span><span class="w">         </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="n">email</span><span class="w">             </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="n">phone</span><span class="w">             </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span><span class="n">auth_provider</span><span class="w">     </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">auth_provider</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">'google'</span><span class="p">,</span><span class="w"> </span><span class="s1">'local'</span><span class="p">)),</span>
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span><span class="n">local_auth_tenant_id</span><span class="w"> </span><span class="n">UUID</span><span class="p">,</span>
</span><span id="__span-0-10"><a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">  </span><span class="n">is_active</span><span class="w">         </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">TRUE</span><span class="p">,</span>
</span><span id="__span-0-11"><a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">  </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">auth_provider</span><span class="p">)</span>
</span><span id="__span-0-12"><a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="p">);</span>
</span><span id="__span-0-13"><a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>
</span><span id="__span-0-14"><a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="c1">-- 4.2  Danh sÃ¡ch tenant</span>
</span><span id="__span-0-15"><a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tenants</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-16"><a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">  </span><span class="n">tenant_id</span><span class="w">   </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-0-17"><a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">  </span><span class="n">tenant_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-18"><a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">  </span><span class="n">status</span><span class="w">      </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">'active'</span><span class="p">,</span><span class="w"> </span><span class="s1">'inactive'</span><span class="p">))</span>
</span><span id="__span-0-19"><a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="p">);</span>
</span><span id="__span-0-20"><a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>
</span><span id="__span-0-21"><a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="c1">-- 4.3  Ãnh xáº¡ user â†” tenant</span>
</span><span id="__span-0-22"><a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">user_tenant_assignments</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-23"><a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">  </span><span class="n">user_id</span><span class="w">    </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users_global</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>
</span><span id="__span-0-24"><a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">  </span><span class="n">tenant_id</span><span class="w">  </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">tenants</span><span class="p">(</span><span class="n">tenant_id</span><span class="p">),</span>
</span><span id="__span-0-25"><a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">  </span><span class="n">assigned_by</span><span class="w"> </span><span class="n">UUID</span><span class="p">,</span>
</span><span id="__span-0-26"><a href="#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">  </span><span class="n">assigned_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
</span><span id="__span-0-27"><a href="#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">tenant_id</span><span class="p">)</span>
</span><span id="__span-0-28"><a href="#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="p">);</span>
</span><span id="__span-0-29"><a href="#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a>
</span><span id="__span-0-30"><a href="#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="c1">-- 4.4  Template vai trÃ² &amp; quyá»n toÃ n cá»¥c</span>
</span><span id="__span-0-31"><a href="#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">global_roles_templates</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-32"><a href="#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">  </span><span class="n">template_id</span><span class="w">  </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-0-33"><a href="#__codelineno-0-33" id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">  </span><span class="n">template_code</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-34"><a href="#__codelineno-0-34" id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">  </span><span class="n">description</span><span class="w">  </span><span class="nb">TEXT</span>
</span><span id="__span-0-35"><a href="#__codelineno-0-35" id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="p">);</span>
</span><span id="__span-0-36"><a href="#__codelineno-0-36" id="__codelineno-0-36" name="__codelineno-0-36"></a>
</span><span id="__span-0-37"><a href="#__codelineno-0-37" id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">global_permissions_templates</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-38"><a href="#__codelineno-0-38" id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">  </span><span class="n">template_id</span><span class="w">     </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-0-39"><a href="#__codelineno-0-39" id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">  </span><span class="n">permission_code</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-40"><a href="#__codelineno-0-40" id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">  </span><span class="n">action</span><span class="w">          </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-41"><a href="#__codelineno-0-41" id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">  </span><span class="n">resource</span><span class="w">        </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-42"><a href="#__codelineno-0-42" id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">  </span><span class="n">default_condition</span><span class="w"> </span><span class="n">JSONB</span><span class="w">   </span><span class="c1">-- PostgreSQL JSONB</span>
</span><span id="__span-0-43"><a href="#__codelineno-0-43" id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="p">);</span>
</span></code></pre></div>
<p><strong>VÃ­ dá»¥ quyá»n toÃ n cá»¥c</strong></p>
<table>
<thead>
<tr>
<th>permission_code</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>report.view_login_by_tenant</code></td>
<td>Xem bÃ¡o cÃ¡o Ä‘Äƒng nháº­p theo tenant</td>
</tr>
<tr>
<td><code>report.view_financial_summary</code></td>
<td>Xem bÃ¡o cÃ¡o tÃ i chÃ­nh tá»•ng há»£p</td>
</tr>
<tr>
<td><code>report.manage_report_templates</code></td>
<td>Táº¡o/ cáº­p nháº­t template bÃ¡o cÃ¡o</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="tai-sub-user-service-moi-tenant-mariadb">ğŸ“¦ Táº¡i Sub User Service (má»—i tenant â€” MariaDB)<a class="headerlink" href="#tai-sub-user-service-moi-tenant-mariadb" title="Permanent link">Â¶</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">-- +flyway</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="c1">-- 4.5  NgÆ°á»i dÃ¹ng cá»¥c bá»™ (tham chiáº¿u user_id toÃ n cá»¥c)</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users_in_tenant</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="n">user_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="n">is_active_in_tenant</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">TRUE</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="p">);</span>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="c1">-- 4.6  Vai trÃ² &amp; quyá»n trong tenant</span>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">roles_in_tenant</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-10"><a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">  </span><span class="n">role_id</span><span class="w">   </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-1-11"><a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="n">role_code</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-1-12"><a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">  </span><span class="n">role_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-1-13"><a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="p">);</span>
</span><span id="__span-1-14"><a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>
</span><span id="__span-1-15"><a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">permissions_in_tenant</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-16"><a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">  </span><span class="n">permission_id</span><span class="w">    </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-1-17"><a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">  </span><span class="n">permission_code</span><span class="w">  </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-1-18"><a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">  </span><span class="n">action</span><span class="w">           </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-1-19"><a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">  </span><span class="n">resource</span><span class="w">         </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-1-20"><a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">  </span><span class="n">condition</span><span class="w">        </span><span class="n">JSON</span><span class="w">        </span><span class="c1">-- MariaDB JSON</span>
</span><span id="__span-1-21"><a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="p">,</span><span class="w"> </span><span class="n">schema_version</span><span class="w">   </span><span class="nb">INT</span><span class="w">  </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">'Event-schema version'</span>
</span><span id="__span-1-22"><a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="p">);</span>
</span><span id="__span-1-23"><a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a>
</span><span id="__span-1-24"><a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="c1">-- 4.7  Mapping user â†” role</span>
</span><span id="__span-1-25"><a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">user_role_in_tenant</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-26"><a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">  </span><span class="n">user_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users_in_tenant</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>
</span><span id="__span-1-27"><a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">  </span><span class="n">role_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">roles_in_tenant</span><span class="p">(</span><span class="n">role_id</span><span class="p">),</span>
</span><span id="__span-1-28"><a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">role_id</span><span class="p">)</span>
</span><span id="__span-1-29"><a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="p">);</span>
</span><span id="__span-1-30"><a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a>
</span><span id="__span-1-31"><a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="c1">-- 4.8  Mapping role â†” permission</span>
</span><span id="__span-1-32"><a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">role_permission_in_tenant</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-33"><a href="#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">  </span><span class="n">role_id</span><span class="w">       </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">roles_in_tenant</span><span class="p">(</span><span class="n">role_id</span><span class="p">),</span>
</span><span id="__span-1-34"><a href="#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">  </span><span class="n">permission_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">permissions_in_tenant</span><span class="p">(</span><span class="n">permission_id</span><span class="p">),</span>
</span><span id="__span-1-35"><a href="#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">role_id</span><span class="p">,</span><span class="w"> </span><span class="n">permission_id</span><span class="p">)</span>
</span><span id="__span-1-36"><a href="#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="p">);</span>
</span></code></pre></div>
<p><strong>VÃ­ dá»¥ quyá»n trong tenant</strong></p>
<table>
<thead>
<tr>
<th>permission_code</th>
<th>scope</th>
<th>is_custom</th>
<th>note</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>report.view_login_by_tenant</code></td>
<td>tenant</td>
<td>false</td>
<td>Káº¿ thá»«a tá»« Master</td>
</tr>
<tr>
<td><code>report.view_financial_summary</code></td>
<td>global</td>
<td>false</td>
<td>Chá»‰ cáº¥p cho vai trÃ² quáº£n lÃ½</td>
</tr>
<tr>
<td><code>grade.edit_assignment</code></td>
<td>class</td>
<td>true</td>
<td>Quyá»n tuá»³ chá»‰nh do Admin tenant táº¡o</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="tai-lieu-chi-tiet">ğŸ“˜ TÃ i liá»‡u chi tiáº¿t<a class="headerlink" href="#tai-lieu-chi-tiet" title="Permanent link">Â¶</a></h3>
<ul>
<li><a href="../../services/user-service/master/data-model/"><code>user-service/master/data-model.md</code></a> â€“ MÃ´ hÃ¬nh &amp; migration PostgreSQL.</li>
<li><a href="../services/user-service/tenant/data-model.md"><code>user-service/tenant/data-model.md</code></a> â€“ MÃ´ hÃ¬nh MariaDB &amp; chiáº¿n lÆ°á»£c sync Pub/Sub.</li>
</ul>
<blockquote>
<p>MÃ´ hÃ¬nh nÃ y <strong>tÃ¡ch biá»‡t rÃµ rÃ ng</strong> danh tÃ­nh toÃ n cá»¥c vá»›i RBAC cá»¥c bá»™, Ä‘á»“ng thá»i há»— trá»£ <strong>version schema</strong> (cá»™t <code>schema_version</code>) cho há»‡ thá»‘ng <strong>Event Schema Governance</strong> (ADR-030).</p>
</blockquote>
<hr/>
<h2 id="5-permission-co-ieu-kien-conditional-permission">5. Permission CÃ³ Äiá»u Kiá»‡n (Conditional Permission)<a class="headerlink" href="#5-permission-co-ieu-kien-conditional-permission" title="Permanent link">Â¶</a></h2>
<blockquote>
<p><strong>Má»¥c tiÃªu</strong> â€“ Cho phÃ©p <strong>RBAC linh hoáº¡t</strong> dá»±a trÃªn <em>ngá»¯ cáº£nh</em> (context-aware).<br/>
Thay vÃ¬ gÃ¡n quyá»n â€œcá»©ngâ€, má»—i <strong>permission</strong> cÃ³ thá»ƒ Ä‘Ã­nh kÃ¨m trÆ°á»ng <code>condition</code> dÆ°á»›i dáº¡ng <strong>JSON</strong> (<code>JSONB</code> trÃªn PostgreSQL Core, <code>JSON</code> trÃªn MariaDB Tenant).</p>
</blockquote>
<h3 id="51-cu-phap-context">5.1 CÃº phÃ¡p &amp; Context<a class="headerlink" href="#51-cu-phap-context" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Placeholder</th>
<th>Nguá»“n dá»¯ liá»‡u</th>
<th>VÃ­ dá»¥</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$user.&lt;field&gt;</code></td>
<td>Báº£n ghi <code>users_in_tenant</code> (Sub DB)</td>
<td><code>$user.class_id</code></td>
</tr>
<tr>
<td><code>$request.&lt;field&gt;</code></td>
<td>Body / query-param / header HTTP</td>
<td><code>$request.class_id</code></td>
</tr>
<tr>
<td><code>$tenant.&lt;field&gt;</code></td>
<td>Metadata cá»§a tenant (báº£ng <code>tenants</code>)</td>
<td><code>$tenant.tier</code></td>
</tr>
</tbody>
</table>
<p><strong>ToÃ¡n tá»­ máº·c Ä‘á»‹nh</strong>: <em>so sÃ¡nh báº±ng</em> (<code>==</code>).<br/>
<strong>ToÃ¡n tá»­ má»Ÿ rá»™ng</strong> (v2): <code>$in</code>, <code>$contains</code>, <code>$gte</code>, <code>$lte</code>.</p>
<h3 id="52-vi-du-ieu-kien">5.2 VÃ­ dá»¥ Ä‘iá»u kiá»‡n<a class="headerlink" href="#52-vi-du-ieu-kien" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>MÃ´ táº£</th>
<th>JSON Ä‘iá»u kiá»‡n</th>
<th>Diá»…n giáº£i</th>
</tr>
</thead>
<tbody>
<tr>
<td>Chá»‰ xem lá»›p cá»§a chÃ­nh mÃ¬nh</td>
<td><code>{ "class_id": "$user.class_id" }</code></td>
<td><code>class_id (request)</code> <code>==</code> <code>class_id (user)</code></td>
</tr>
<tr>
<td>Háº¡n cháº¿ bÃ¡o cÃ¡o theo khá»‘i trÆ°á»ng</td>
<td><code>{ "grade": "$user.grade" }</code></td>
<td>So sÃ¡nh <code>grade</code></td>
</tr>
<tr>
<td>Quyá»n admin tenant cao cáº¥p</td>
<td><code>{ "$tenant.tier": "premium" }</code></td>
<td>Tenant pháº£i á»Ÿ gÃ³i â€œpremiumâ€</td>
</tr>
</tbody>
</table>
<h3 id="53-luong-anh-gia-evaluation-flow">5.3 Luá»“ng Ä‘Ã¡nh giÃ¡ (Evaluation Flow)<a class="headerlink" href="#53-luong-anh-gia-evaluation-flow" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>flowchart LR
  APIGW(API Gateway) --&gt; CondEval(Condition Engine)
  CondEval --&gt;|read| RedisRBAC[(RBAC cache)]
  CondEval --&gt;|read| RequestCtx[/HTTP Request/]
  CondEval --&gt;|read| JWTClaim[/JWT/]
  CondEval --&gt;|read| TenantMeta[(Tenant metadata)]
</code></pre>
<ol>
<li><strong>API Gateway</strong> Ä‘Ã£ xÃ¡c thá»±c JWT &amp; táº£i RBAC cache.</li>
<li>
<p><strong>Condition Engine</strong> láº·p qua list permission:</p>
</li>
<li>
<p>Náº¿u <code>condition == null</code> â‡’ pass.</p>
</li>
<li>Náº¿u cÃ³ <code>condition</code> â‡’ render placeholder â†’ so sÃ¡nh.</li>
<li>Náº¿u <strong>báº¥t ká»³</strong> permission pass â‡’ request <strong>Ä‘Æ°á»£c phÃ©p</strong>.</li>
<li>Káº¿t quáº£ cache <code>rbac:{user_id}:{tenant_id}</code> theo TTL.</li>
</ol>
<h3 id="54-kich-ban-quan-trong">5.4 Ká»‹ch báº£n quan trá»ng<a class="headerlink" href="#54-kich-ban-quan-trong" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Ká»‹ch báº£n</th>
<th>Handling</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Token bá»‹ thu há»“i</strong></td>
<td>Gateway tráº£ <code>403</code> <code>token.revoked</code> trÆ°á»›c khi evaluate.</td>
</tr>
<tr>
<td><strong>Placeholder thiáº¿u</strong></td>
<td>Tráº£ <code>400</code> <code>common.validation_failed</code>.</td>
</tr>
<tr>
<td><strong>Type mismatch</strong></td>
<td>Tráº£ <code>400</code>; log detail vÃ o Audit-Logging.</td>
</tr>
<tr>
<td><strong>Condition náº·ng</strong></td>
<td>Flag â€œslow conditionâ€ khi eval &gt; 5 ms â€“ metric <code>rbac_cond_latency_p95</code>.</td>
</tr>
</tbody>
</table>
<h3 id="55-quan-tri-template">5.5 Quáº£n trá»‹ &amp; Template<a class="headerlink" href="#55-quan-tri-template" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>Template quyá»n</strong> (level Master) lÆ°u á»Ÿ <code>global_permissions_templates.default_condition</code>.</li>
<li>Tenant <strong>override</strong> báº±ng cÃ¡ch viáº¿t <code>condition</code> má»›i trong <code>permissions_in_tenant</code>.</li>
<li>Report-related permission (<code>report.*</code>) Ä‘i kÃ¨m <code>data_scope</code> (ADR-029).</li>
</ul>
<blockquote>
<p><strong>LÆ°u Ã½ báº£o máº­t</strong></p>
<ul>
<li>KhÃ´ng cho phÃ©p placeholder <strong>tá»± do</strong>; chá»‰ whitelist <code>$user</code>, <code>$request</code>, <code>$tenant</code>.</li>
<li>Äá»‘i vá»›i dá»¯ liá»‡u nháº¡y cáº£m (PII), placeholder pháº£i <strong>áº©n danh</strong> (hash) trÆ°á»›c khi so sÃ¡nh.</li>
</ul>
</blockquote>
<hr/>
<h2 id="6-chien-luoc-cache-rbac-tai-api-gateway">6. Chiáº¿n lÆ°á»£c Cache RBAC táº¡i API Gateway<a class="headerlink" href="#6-chien-luoc-cache-rbac-tai-api-gateway" title="Permanent link">Â¶</a></h2>
<blockquote>
<p><strong>Má»¥c tiÃªu</strong> â€“ Giáº£m Ä‘á»™ trá»… uá»· quyá»n vÃ  táº£i truy váº¥n RBAC, nhÆ°ng váº«n báº£o Ä‘áº£m cáº­p nháº­t tá»©c thá»i khi quyá»n thay Ä‘á»•i hoáº·c token bá»‹ thu há»“i.</p>
</blockquote>
<h3 id="61-co-che-tong-quan">6.1 CÆ¡ cháº¿ tá»•ng quan<a class="headerlink" href="#61-co-che-tong-quan" title="Permanent link">Â¶</a></h3>
<ol>
<li><strong>Gateway</strong> xÃ¡c thá»±c chá»¯ kÃ½ JWT <strong>offline</strong> báº±ng <strong>JWKS</strong> (cache 10 â€²).  </li>
<li>TrÆ°á»›c khi Ä‘Ã¡nh giÃ¡ RBAC, Gateway:  </li>
<li>Kiá»ƒm tra khoÃ¡ <strong><code>revoked:{jti}</code></strong> trong Redis (TTL 15 â€²).  </li>
<li>Náº¿u <em>miss</em> cache RBAC (<code>rbac:{user_id}:{tenant_id}</code>) â†’ gá»i <strong>Sub User Service</strong> náº¡p láº¡i.  </li>
<li>Quyá»n má»›i / thu há»“i token Ä‘Æ°á»£c <strong>Ä‘áº©y sá»± kiá»‡n</strong> qua Pub/Sub Ä‘á»ƒ Gateway tá»± xoÃ¡ cache.</li>
</ol>
<h3 id="62-cau-truc-cache">6.2 Cáº¥u trÃºc cache<a class="headerlink" href="#62-cau-truc-cache" title="Permanent link">Â¶</a></h3>
<h4 id="key">ğŸ”‘ <strong>Key</strong><a class="headerlink" href="#key" title="Permanent link">Â¶</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>rbac:{user_id}:{tenant_id}
</span></code></pre></div>
<h4 id="value">ğŸ“¦ <strong>Value</strong><a class="headerlink" href="#value" title="Permanent link">Â¶</a></h4>
<div class="language-json highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="p">{</span>
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">  </span><span class="nt">"roles"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"teacher"</span><span class="p">],</span>
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">  </span><span class="nt">"permissions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"grade.edit_assignment"</span><span class="p">,</span><span class="w"> </span><span class="s2">"report.view_login_by_tenant"</span><span class="p">],</span>
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">  </span><span class="nt">"issued_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-07-01T12:00:00Z"</span>
</span><span id="__span-3-5"><a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="ttl-lam-moi">â± <strong>TTL &amp; LÃ m má»›i</strong><a class="headerlink" href="#ttl-lam-moi" title="Permanent link">Â¶</a></h4>
<table>
<thead>
<tr>
<th>TTL</th>
<th>Má»©c Ã¡p dá»¥ng</th>
<th>Ghi chÃº</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>10 phÃºt</strong></td>
<td>Core services (Gateway â†’ Master)</td>
<td>GiÃ¡ trá»‹ máº·c Ä‘á»‹nh</td>
</tr>
<tr>
<td><strong>5â€“15 phÃºt</strong></td>
<td>Tenant stack (Gateway â†’ Sub)</td>
<td>Äiá»u chá»‰nh theo táº£i tenant</td>
</tr>
<tr>
<td><strong>Invalidate</strong></td>
<td>Khi JWT má»›i cÃ³ RBAC má»›i <em>hoáº·c</em> event <code>rbac_updated</code></td>
<td>Tá»©c thá»i xoÃ¡ cache</td>
</tr>
</tbody>
</table>
<h3 id="63-kiem-tra-token-bi-thu-hoi-revoked">6.3 Kiá»ƒm tra token bá»‹ thu há»“i (revoked)<a class="headerlink" href="#63-kiem-tra-token-bi-thu-hoi-revoked" title="Permanent link">Â¶</a></h3>
<ul>
<li>
<p><strong>Redis key</strong> <code>revoked:{jti}</code> (TTL 15 â€²) â€“ <strong>Token Service</strong> Ä‘á»“ng bá»™ ngay sau <code>/token/revoke</code>.</p>
</li>
<li>
<p>Gateway tra key trÆ°á»›c khi Ä‘Ã¡nh giÃ¡ RBAC:</p>
</li>
</ul>
<div class="language-json highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="mi">403</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="p">{</span>
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"token.revoked"</span><span class="p">,</span><span class="w"> </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Token Ä‘Ã£ bá»‹ thu há»“i"</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-4-4"><a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">  </span><span class="nt">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">"trace_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"â€¦"</span><span class="p">,</span><span class="w"> </span><span class="nt">"service"</span><span class="p">:</span><span class="w"> </span><span class="s2">"api_gateway"</span><span class="p">,</span><span class="w"> </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"â€¦"</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-4-5"><a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>
<p>Náº¿u <strong>cache-miss</strong>, Gateway gá»i <code>POST /token/introspect</code> Ä‘á»ƒ xÃ¡c minh.</p>
</li>
<li>
<p><strong>Metric giÃ¡m sÃ¡t</strong></p>
</li>
<li>
<p><code>revoked_token_cache_hit_ratio</code> â‰¥ 98 % â€“ alert &lt; 90 % 10â€².</p>
</li>
<li><code>rbac_cache_latency_p95</code> &lt; 5 ms.</li>
</ul>
<h3 id="64-invalidation-qua-pubsub">6.4 Invalidation qua Pub/Sub<a class="headerlink" href="#64-invalidation-qua-pubsub" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Sá»± kiá»‡n</th>
<th>NÆ¡i phÃ¡t</th>
<th>HÃ nh Ä‘á»™ng Gateway</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rbac_updated</code></td>
<td>Sub User Service</td>
<td>XoÃ¡ <code>rbac:{user_id}:{tenant_id}</code></td>
</tr>
<tr>
<td><code>token.revoked</code></td>
<td>Token Service</td>
<td>XoÃ¡ <code>revoked:{jti}</code> &amp; cache RBAC liÃªn quan</td>
</tr>
<tr>
<td><code>user_status_changed</code></td>
<td>User Master / Sub</td>
<td>VÃ´ hiá»‡u hoÃ¡ JWT &amp; cache RBAC</td>
</tr>
</tbody>
</table>
<h3 id="65-quy-tac-ac-biet-cho-bao-cao">6.5 Quy táº¯c Ä‘áº·c biá»‡t cho bÃ¡o cÃ¡o<a class="headerlink" href="#65-quy-tac-ac-biet-cho-bao-cao" title="Permanent link">Â¶</a></h3>
<ul>
<li>CÃ¡c permission <code>report.*</code> thÆ°á»ng Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ táº¡i Gateway khi <strong>Superadmin Webapp</strong> gá»i <strong>Reporting Service</strong>.</li>
<li>Náº¿u permission cÃ³ <code>condition</code>, <strong>Condition Engine</strong> so khá»›p <code>input_parameters</code> vá»›i context ngÆ°á»i dÃ¹ng. (Xem má»¥c 5).</li>
</ul>
<p>ğŸ“˜ <em>Äá»‹nh nghÄ©a schema sá»± kiá»‡n</em>: <a href="./rbac-events.md"><code>rbac-events.md</code></a></p>
<hr/>
<h2 id="7-chien-luoc-ong-bo-rbac">7. Chiáº¿n lÆ°á»£c Äá»“ng bá»™ RBAC<a class="headerlink" href="#7-chien-luoc-ong-bo-rbac" title="Permanent link">Â¶</a></h2>
<blockquote>
<p><strong>Má»¥c tiÃªu</strong> â€“ Cho phÃ©p tenant <strong>káº¿ thá»«a</strong> RBAC chuáº©n, <strong>tuá»³ chá»‰nh</strong> khi cáº§n, nhÆ°ng váº«n giá»¯ <strong>tÃ­nh nháº¥t quÃ¡n &amp; dá»… quan sÃ¡t</strong>. CÆ¡ cháº¿ Ä‘á»“ng bá»™ dá»±a trÃªn <strong>Pub/Sub</strong> vÃ  <strong>schema versioning</strong> (ADR-030).</p>
</blockquote>
<h3 id="71-ke-thua-tuy-chinh">7.1 Káº¿ thá»«a &amp; TÃ¹y chá»‰nh<a class="headerlink" href="#71-ke-thua-tuy-chinh" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>HÃ nh Ä‘á»™ng</th>
<th>API / Sá»± kiá»‡n</th>
<th>Káº¿t quáº£</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Import template</strong></td>
<td><code>POST /rbac/templates/import</code></td>
<td>Tenant láº¥y báº£n <em>snapshot</em> Role/Permission tá»« Master (version hiá»‡n táº¡i).</td>
</tr>
<tr>
<td><strong>Clone template</strong></td>
<td><code>POST /rbac/templates/clone</code></td>
<td>Táº¡o báº£n sao (<code>schema_version</code> káº¿ thá»«a) â†’ sá»­a <code>role_name</code>, <code>condition</code>.</td>
</tr>
<tr>
<td><strong>Táº¡o má»›i</strong></td>
<td><code>POST /rbac/templates</code></td>
<td>Báº£n tráº¯ng hoÃ n toÃ n, version máº·c Ä‘á»‹nh <strong>1</strong>.</td>
</tr>
<tr>
<td><strong>Sync Ä‘á»‹nh ká»³</strong></td>
<td>Cron-option (<code>weekly</code>, <code>monthly</code>)</td>
<td>Chá»‰ Ã¡p dá»¥ng <strong>template chÆ°a clone</strong>; diff â†’ update tá»± Ä‘á»™ng.</td>
</tr>
</tbody>
</table>
<blockquote>
<p><em>Tenant clone = máº¥t Ä‘Æ°á»ng sync; pháº£i cáº­p nháº­t thá»§ cÃ´ng náº¿u Master Ä‘á»•i.</em></p>
</blockquote>
<h3 id="72-gan-role-cho-nguoi-dung">7.2 GÃ¡n Role cho NgÆ°á»i dÃ¹ng<a class="headerlink" href="#72-gan-role-cho-nguoi-dung" title="Permanent link">Â¶</a></h3>
<ul>
<li>API <strong>Sub User Service</strong> (Ä‘Æ°á»£c Admin Portal sá»­ dá»¥ng):  </li>
<li><code>PUT /users/{id}/roles</code> â€“ gÃ¡n hoáº·c gá»¡ <code>role_id</code>.  </li>
<li><code>PATCH /users/{id}</code> â€“ cáº­p nháº­t <code>is_active_in_tenant</code>.  </li>
<li><code>POST /roles</code> â€“ táº¡o role tuá»³ chá»‰nh (yÃªu cáº§u permission <code>rbac.manage_role</code>).  </li>
<li>Má»—i thao tÃ¡c xuáº¥t sá»± kiá»‡n <strong><code>rbac_updated</code></strong> (payload cÃ³ <code>schema_version</code>).</li>
</ul>
<h3 id="73-ong-bo-invalidate-pubsub">7.3 Äá»“ng bá»™ &amp; Invalidate (Pub/Sub)<a class="headerlink" href="#73-ong-bo-invalidate-pubsub" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>flowchart LR
  RBT(ğŸ“¥ rbac_updated) -- publish --&gt; Bus((Pub/Sub))
  Bus -- fan-out --&gt; GW(API Gateway)
  Bus -- fan-out --&gt; Audit(Audit-Logging)
  GW -- purge --&gt; RedisRBAC[("rbac:{user_id}:{tid}")]
</code></pre>
<table>
<thead>
<tr>
<th>Sá»± kiá»‡n</th>
<th>PhÃ¡t tá»«</th>
<th>HÃ nh Ä‘á»™ng Gateway</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rbac_updated.v1</code></td>
<td>Sub User Service</td>
<td>XoÃ¡ cache RBAC liÃªn quan</td>
</tr>
<tr>
<td><code>rbac_template_cloned.v1</code></td>
<td>Tenant Admin</td>
<td>Chá»‰ ghi log, khÃ´ng tá»± sync</td>
</tr>
<tr>
<td><code>rbac_template_synced.v1</code></td>
<td>Job Masterâ†’Tenant</td>
<td>Cáº­p nháº­t <code>schema_version</code> má»›i</td>
</tr>
</tbody>
</table>
<h3 id="74-versioning-conflict">7.4 Versioning &amp; Conflict<a class="headerlink" href="#74-versioning-conflict" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»—i báº£n ghi <strong>role / permission</strong> cÃ³ <code>schema_version</code>.</li>
<li>Khi Master nÃ¢ng version, pipeline <code>template_sync</code> gá»­i diff; náº¿u báº£n tenant Ä‘Ã£ clone â†’ cáº£nh bÃ¡o â€œ<em>forked template</em>â€.</li>
<li>Äiá»u kiá»‡n <strong>conflict</strong>: <code>permission_code</code> trÃ¹ng nhÆ°ng version khÃ¡c â†’ job flag <code>status=conflict</code>, yÃªu cáº§u Admin tenant rÃ  soÃ¡t.</li>
</ul>
<h3 id="75-ong-bo-inh-ky-tuy-chon">7.5 Äá»“ng bá»™ Ä‘á»‹nh ká»³ (tÃ¹y chá»n)<a class="headerlink" href="#75-ong-bo-inh-ky-tuy-chon" title="Permanent link">Â¶</a></h3>
<ul>
<li>Tenant chá»n trong <strong>Settings â†’ RBAC Sync</strong>: <code>off</code> / <code>weekly</code> / <code>monthly</code>.</li>
<li>Job <strong>Cloud Scheduler + Cloud Run</strong> gá»i <code>POST /templates/sync</code> â†’ Master tÃ­nh diff â†’ phÃ¡t <code>rbac_template_synced.v1</code>.</li>
</ul>
<h3 id="76-kpi-monitoring">7.6 KPI &amp; Monitoring<a class="headerlink" href="#76-kpi-monitoring" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Má»¥c tiÃªu</th>
<th>Alert</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rbac_sync_success_rate</code></td>
<td>= 100 %</td>
<td>báº¥t ká»³ failure</td>
</tr>
<tr>
<td><code>rbac_conflict_count</code></td>
<td>= 0</td>
<td>&gt; 0 táº¡o Jira ticket</td>
</tr>
<tr>
<td><code>rbac_template_age_days</code></td>
<td>&lt; 30 ngÃ y (sync weekly)</td>
<td>&gt; 45 ngÃ y</td>
</tr>
</tbody>
</table>
<p>ğŸ“˜ <strong>Schema sá»± kiá»‡n chi tiáº¿t</strong> xem <a href="./rbac-events.md"><code>rbac-events.md</code></a>.</p>
<hr/>
<h2 id="8-hieu-nang-kha-nang-mo-rong">8. Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng<a class="headerlink" href="#8-hieu-nang-kha-nang-mo-rong" title="Permanent link">Â¶</a></h2>
<p>Há»‡ thá»‘ng RBAC cá»§a <strong>dx-vas</strong> pháº£i phá»¥c vá»¥ <strong>200+ tenant</strong> vá»›i hÃ ng ngÃ n ngÆ°á»i dÃ¹ng/tenant, Ä‘á»“ng thá»i giá»¯ <strong>p95 latency &lt; 5 ms</strong> cho bÆ°á»›c uá»· quyá»n táº¡i API Gateway.</p>
<h3 id="81-ky-thuat-toi-uu">8.1 Ká»¹ thuáº­t tá»‘i Æ°u<a class="headerlink" href="#81-ky-thuat-toi-uu" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Ká»¹ thuáº­t</th>
<th>MÃ´ táº£</th>
<th>Lá»£i Ã­ch</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Gateway RBAC cache</strong></td>
<td>LÆ°u <code>rbac:{user_id}:{tenant_id}</code> 5â€“15 phÃºt</td>
<td>TrÃ¡nh round-trip Sub Service â†’ giáº£m ~2 ms / request</td>
</tr>
<tr>
<td><strong>Redis revoked-token cache</strong></td>
<td>Key <code>revoked:{jti}</code> TTL 15â€²</td>
<td>Kiá»ƒm tra thu há»“i token cá»¥c bá»™, khÃ´ng gá»i <code>/token/introspect</code></td>
</tr>
<tr>
<td><strong>Pub/Sub Fan-out invalidate</strong></td>
<td>Sá»± kiá»‡n <code>rbac_updated</code>, <code>token.revoked</code> â†’ Gateway xoÃ¡ cache</td>
<td>Cáº­p nháº­t gáº§n-real-time (&lt; 1 s)</td>
</tr>
<tr>
<td><strong>Condition Engine JSON(B)</strong></td>
<td>So sÃ¡nh <code>$user</code>, <code>$request</code>, <code>$tenant</code> táº¡i Gateway</td>
<td>RBAC linh hoáº¡t, khÃ´ng bÃ¹ng ná»• báº£ng Permission</td>
</tr>
<tr>
<td><strong>Batch API</strong></td>
<td><code>POST /users/roles:batchAssign</code></td>
<td>Giáº£m sá»‘ káº¿t ná»‘i DB / network</td>
</tr>
</tbody>
</table>
<h3 id="82-quy-mo-cloud-cloud-scale">8.2 Quy mÃ´ Cloud (Cloud-Scale)<a class="headerlink" href="#82-quy-mo-cloud-cloud-scale" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>Redis Cluster</strong> 3-node, <strong>namespace theo <code>tenant_id</code></strong> â†’ háº¡n cháº¿ khoÃ¡ nÃ³ng, báº£o vá»‡ tenant khÃ¡c.  </li>
<li><strong>Sub User Service</strong> autoscale HPA (CPU + RPS) â†’ tenant báº­n khÃ´ng áº£nh hÆ°á»Ÿng tenant ráº£nh.  </li>
<li><strong>Message Bus</strong> Pub/Sub topic <code>tenant.*</code> chia <em>partition</em> = tenant â†’ báº£o Ä‘áº£m thá»© tá»± trong tenant.  </li>
<li><strong>Data Model</strong> <code>roles_in_tenant</code> &amp; <code>permissions_in_tenant</code> shard theo <code>tenant_id</code> â†’ chá»‰ quÃ©t pháº¡m vi nhá».</li>
</ul>
<h3 id="83-monitoring-alerting">8.3 Monitoring &amp; Alerting<a class="headerlink" href="#83-monitoring-alerting" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Má»¥c tiÃªu</th>
<th>Alert</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rbac_cache_hit_ratio</code></td>
<td>â‰¥ 98 %</td>
<td>&lt; 95 % trong 10â€²</td>
</tr>
<tr>
<td><code>revoked_token_cache_hit_ratio</code></td>
<td>â‰¥ 95 %</td>
<td>&lt; 90 % trong 10â€²</td>
</tr>
<tr>
<td><code>rbac_cond_latency_p95</code></td>
<td>&lt; 5 ms</td>
<td>&gt; 10 ms trong 5â€²</td>
</tr>
<tr>
<td><code>rbac_conflict_count</code></td>
<td>= 0</td>
<td>báº¥t ká»³ &gt; 0</td>
</tr>
<tr>
<td><code>user_roles_count_p99</code></td>
<td>&lt; 50</td>
<td>user &gt; 100 role â†’ Jira ticket</td>
</tr>
</tbody>
</table>
<p><em>Log sample </em>:</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="p">{</span>
</span><span id="__span-5-2"><a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">  </span><span class="nt">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tenant-abc"</span><span class="p">,</span>
</span><span id="__span-5-3"><a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"u-123"</span><span class="p">,</span>
</span><span id="__span-5-4"><a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="nt">"cache_hit"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-5-5"><a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">  </span><span class="nt">"cache_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rbac"</span><span class="p">,</span>
</span><span id="__span-5-6"><a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">  </span><span class="nt">"latency_ms"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.8</span><span class="p">,</span>
</span><span id="__span-5-7"><a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">  </span><span class="nt">"trace_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"trace-xyz"</span>
</span><span id="__span-5-8"><a href="#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="84-inh-huong-toi-uu-tiep-theo">8.4 Äá»‹nh hÆ°á»›ng tá»‘i Æ°u tiáº¿p theo<a class="headerlink" href="#84-inh-huong-toi-uu-tiep-theo" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>JWT-signed RBAC claims</strong> (â€œembedded RBACâ€) â†’ TTL 2 â€² + checksum, giáº£m truy váº¥n Redis á»Ÿ má»©c cá»±c lá»›n.</li>
<li><strong>Edge-Cache (CDN) JWKS</strong> giáº£m thá»i gian táº£i key á»Ÿ vÃ¹ng xa.</li>
<li><strong>Adaptive TTL</strong> â€“ Gateway kÃ©o dÃ i TTL cho user Ã­t thay Ä‘á»•i, rÃºt ngáº¯n cho admin thao tÃ¡c nhiá»u quyá»n.</li>
</ul>
<blockquote>
<p><strong>Káº¿t quáº£ mong Ä‘á»£i:</strong> Vá»›i cÃ¡c ká»¹ thuáº­t trÃªn, dx-vas giá»¯ Ä‘Æ°á»£c hiá»‡u nÄƒng á»•n Ä‘á»‹nh khi má»Ÿ rá»™ng tenant má»›i, Ä‘á»“ng thá»i báº£o Ä‘áº£m viá»‡c thu há»“i quyá»n/token diá»…n ra trong vÃ i giÃ¢y â€“ khÃ´ng áº£nh hÆ°á»Ÿng tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng.</p>
</blockquote>
<hr/>
<h2 id="9-bao-mat-chuyen-sau-trong-rbac">9. Báº£o máº­t chuyÃªn sÃ¢u trong RBAC<a class="headerlink" href="#9-bao-mat-chuyen-sau-trong-rbac" title="Permanent link">Â¶</a></h2>
<p>RBAC lÃ  lá»›p kiá»ƒm soÃ¡t truy cáº­p trá»ng yáº¿u, nÃªn cÃ¡c nguyÃªn táº¯c báº£o máº­t sau Ä‘Æ°á»£c Ã¡p dá»¥ng nghiÃªm ngáº·t trong há»‡ thá»‘ng dx-vas:</p>
<h3 id="isolation-theo-tenant">ğŸ” Isolation theo Tenant<a class="headerlink" href="#isolation-theo-tenant" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»—i Sub User Service chá»‰ truy xuáº¥t dá»¯ liá»‡u ngÆ°á»i dÃ¹ng vÃ  role/permission cá»§a chÃ­nh tenant Ä‘Ã³</li>
<li>KhÃ´ng cÃ³ API cho phÃ©p thao tÃ¡c chÃ©o tenant</li>
</ul>
<h3 id="ten-inh-danh-va-khong-gian-rbac">ğŸ” TÃªn Ä‘á»‹nh danh vÃ  khÃ´ng gian RBAC<a class="headerlink" href="#ten-inh-danh-va-khong-gian-rbac" title="Permanent link">Â¶</a></h3>
<ul>
<li>CÃ¡c vai trÃ² (<code>role_code</code>) vÃ  quyá»n (<code>permission_code</code>) pháº£i lÃ  duy nháº¥t <strong>trong pháº¡m vi tenant</strong></li>
<li>KhÃ´ng cho phÃ©p â€œshadowâ€ vai trÃ² tá»« tenant khÃ¡c</li>
</ul>
<h3 id="chong-gia-mao-jwt">ğŸ” Chá»‘ng giáº£ máº¡o JWT<a class="headerlink" href="#chong-gia-mao-jwt" title="Permanent link">Â¶</a></h3>
<ul>
<li>JWT Ä‘Æ°á»£c kÃ½ RS256 bá»Ÿi <strong>Token Service</strong>; Gateway xÃ¡c thá»±c <em>offline</em> qua <strong>JWKS</strong> cache 10â€².  </li>
<li>Gateway thÃªm bÆ°á»›c â€œcheck revokedâ€ (Redis) trÆ°á»›c khi Ä‘Ã¡nh giÃ¡ RBAC.</li>
</ul>
<h3 id="api-rbac-luon-bao-ve-boi-auth-role">ğŸ” API RBAC luÃ´n báº£o vá»‡ bá»Ÿi Auth + Role<a class="headerlink" href="#api-rbac-luon-bao-ve-boi-auth-role" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»i thao tÃ¡c gÃ¡n quyá»n, gÃ¡n vai trÃ², cáº­p nháº­t pháº£i cÃ³ quyá»n cá»¥ thá»ƒ (<code>manage_rbac</code>, <code>assign_role</code>, v.v.)</li>
</ul>
<hr/>
<h2 id="10-giam-sat-go-loi">10. GiÃ¡m sÃ¡t &amp; Gá»¡ lá»—i<a class="headerlink" href="#10-giam-sat-go-loi" title="Permanent link">Â¶</a></h2>
<p>Äá»ƒ há»— trá»£ váº­n hÃ nh vÃ  báº£o máº­t, cÃ¡c hÃ nh Ä‘á»™ng liÃªn quan Ä‘áº¿n RBAC Ä‘Æ°á»£c log vÃ  theo dÃµi chi tiáº¿t:</p>
<h3 id="audit-trail">ğŸªµ Audit Trail<a class="headerlink" href="#audit-trail" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»—i hÃ nh Ä‘á»™ng:</li>
<li>GÃ¡n vai trÃ²</li>
<li>Táº¡o permission</li>
<li>Cáº­p nháº­t condition</li>
<li>ÄÆ°á»£c log kÃ¨m:</li>
<li><code>user_id</code>, <code>actor_id</code>, <code>tenant_id</code>, <code>timestamp</code>, <code>payload_before</code>, <code>payload_after</code></li>
<li>CÃ¡c hÃ nh vi truy cáº­p bÃ¡o cÃ¡o (truy váº¥n, export, xem cáº¥u hÃ¬nh) Ä‘Æ°á»£c log vÃ o <strong>Audit Logging Stack</strong> Ä‘á»ƒ há»— trá»£ báº£o máº­t vÃ  phÃ¢n tÃ­ch hÃ nh vi.</li>
<li>Viá»‡c log nÃ y tuÃ¢n thá»§ Ä‘á»‹nh dáº¡ng <code>ADR-008</code> vÃ  cÃ³ thá»ƒ Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ sinh cÃ¡c bÃ¡o cÃ¡o phÃ¢n quyá»n vÃ  audit sá»­ dá»¥ng há»‡ thá»‘ng bÃ¡o cÃ¡o.</li>
</ul>
<h3 id="debug-flow-tai-gateway">ğŸ§ª Debug Flow táº¡i Gateway<a class="headerlink" href="#debug-flow-tai-gateway" title="Permanent link">Â¶</a></h3>
<ul>
<li>Gáº¯n <code>X-RBAC-Trace-ID</code> vÃ o má»—i request náº¿u báº­t debug</li>
<li>Log cÃ¡c bÆ°á»›c Ä‘Ã¡nh giÃ¡: permission match, condition eval, cache hit/miss</li>
<li>CÃ³ thá»ƒ báº­t cháº¿ Ä‘á»™ â€œdry-runâ€ RBAC trÃªn staging Ä‘á»ƒ kiá»ƒm tra rule má»›i</li>
</ul>
<h3 id="metrics">ğŸ“ˆ Metrics<a class="headerlink" href="#metrics" title="Permanent link">Â¶</a></h3>
<ul>
<li>Sá»‘ lÆ°á»£ng permission theo tenant</li>
<li>Tá»· lá»‡ cache hit/miss RBAC</li>
<li>Cáº£nh bÃ¡o náº¿u user cÃ³ sá»‘ role vÆ°á»£t ngÆ°á»¡ng</li>
<li><code>revoked_token_cache_hit_ratio</code></li>
</ul>
<hr/>
<h2 id="11-best-practices-cho-quan-tri-rbac">11. Best Practices cho Quáº£n trá»‹ RBAC<a class="headerlink" href="#11-best-practices-cho-quan-tri-rbac" title="Permanent link">Â¶</a></h2>
<p>Má»™t sá»‘ khuyáº¿n nghá»‹ Ä‘Æ°á»£c Ã¡p dá»¥ng vÃ  kiá»ƒm soÃ¡t qua Superadmin Webapp hoáº·c Admin Webapp táº¡i tenant:</p>
<ul>
<li>âœ… Äáº·t tÃªn <code>role_code</code>, <code>permission_code</code> rÃµ rÃ ng, snake_case</li>
<li>âœ… TÃ¡ch vai trÃ² theo domain chá»©c nÄƒng: <code>academic_staff</code>, <code>finance_admin</code>, <code>class_teacher</code></li>
<li>âœ… Giá»›i háº¡n sá»‘ vai trÃ²/user â‰¤ 10 Ä‘á»ƒ dá»… kiá»ƒm soÃ¡t</li>
<li>âœ… Æ¯u tiÃªn dÃ¹ng permission cÃ³ <code>condition</code> hÆ¡n lÃ  táº¡o thÃªm role má»›i</li>
<li>âœ… DÃ¹ng template náº¿u tenant khÃ´ng cÃ³ nhu cáº§u tuá»³ chá»‰nh</li>
<li>âŒ KhÃ´ng cho phÃ©p sá»­a <code>role_code</code> sau khi gÃ¡n cho user</li>
<li>âŒ KhÃ´ng cáº¥p quyá»n <code>manage_rbac</code> Ä‘áº¡i trÃ  â€“ nÃªn gÃ¡n cho 1â€“2 ngÆ°á»i cÃ³ trÃ¡ch nhiá»‡m</li>
<li>ğŸ”’ <strong>PhÃ¢n quyá»n truy cáº­p bÃ¡o cÃ¡o ká»¹ lÆ°á»¡ng:</strong> CÃ¡c permission dáº¡ng <code>report.view_*</code> nÃªn Ä‘Æ°á»£c gÃ¡n rÃµ rÃ ng theo vai trÃ², giá»›i háº¡n theo scope (<code>tenant</code> hoáº·c <code>global</code>). Nhá»¯ng quyá»n nhÆ° <code>report.manage_report_templates</code> nÃªn <strong>chá»‰ cáº¥p cho Superadmin hoáº·c roles Ä‘áº·c biá»‡t</strong>, Ä‘á»ƒ trÃ¡nh nguy cÆ¡ rÃ² rá»‰ thÃ´ng tin hoáº·c truy váº¥n nháº¡y cáº£m.</li>
</ul>
<hr/>
<h2 id="12-cong-cu-tai-lieu-lien-quan">12. CÃ´ng cá»¥ &amp; TÃ i liá»‡u liÃªn quan<a class="headerlink" href="#12-cong-cu-tai-lieu-lien-quan" title="Permanent link">Â¶</a></h2>
<p>ğŸ“˜ TÃ i liá»‡u ká»¹ thuáº­t chi tiáº¿t liÃªn quan Ä‘áº¿n RBAC:</p>
<table>
<thead>
<tr>
<th>Má»¥c</th>
<th>File</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kiáº¿n trÃºc tá»•ng quan RBAC</td>
<td><a href="../../"><code>README.md</code></a></td>
</tr>
<tr>
<td>MÃ´ hÃ¬nh dá»¯ liá»‡u User Master</td>
<td><a href="../../services/user-service/master/data-model/"><code>user-service/master/data-model.md</code></a></td>
</tr>
<tr>
<td>MÃ´ hÃ¬nh dá»¯ liá»‡u Sub User Service</td>
<td><a href="../services/user-service/tenant/data-model.md"><code>user-service/tenant/data-model.md</code></a></td>
</tr>
<tr>
<td>Giao diá»‡n quáº£n trá»‹ RBAC</td>
<td><a href="../interfaces/ic-02-admin-webapp.md"><code>ic-02-admin-webapp.md</code></a></td>
</tr>
<tr>
<td>Kiá»ƒm soÃ¡t xÃ¡c thá»±c &amp; JWT</td>
<td><a href="../../ADR/adr-006-auth-strategy/"><code>adr-006-auth-strategy.md</code></a></td>
</tr>
<tr>
<td>Quy táº¯c Ä‘iá»u kiá»‡n &amp; JSONB</td>
<td><a href="./rbac-condition-schema.md"><code>rbac-condition-schema.md</code></a></td>
</tr>
<tr>
<td>Sá»± kiá»‡n RBAC &amp; Cache Invalidation</td>
<td><a href="./rbac-events.md"><code>rbac-events.md</code></a></td>
</tr>
<tr>
<td>Danh sÃ¡ch role máº«u toÃ n há»‡ thá»‘ng</td>
<td><a href="../templates/global-roles-template.yaml"><code>global-roles-template.yaml</code></a></td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="so-o-rbac-phan-tang-user-master-va-sub-user-services">ğŸ” SÆ¡ Ä‘á»“ RBAC PhÃ¢n táº§ng â€“ User Master vÃ  Sub User Services<a class="headerlink" href="#so-o-rbac-phan-tang-user-master-va-sub-user-services" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>flowchart TD

  subgraph Master["User Service Master"]
    UGM[users_global]
    TENTS[tenants]
    UTA[user_tenant_assignments]
    GRT[global_roles_templates]
    GPT[global_permissions_templates]
  end

  subgraph Tenant_A["Sub User Service â€“ Tenant A"]
    UTA1[users_in_tenant]
    RA1[roles_in_tenant]
    PA1[permissions_in_tenant]
    URA1[user_role_in_tenant]
    RPA1[role_permission_in_tenant]
  end

  subgraph Tenant_B["Sub User Service â€“ Tenant B"]
    UTA2[users_in_tenant]
    RA2[roles_in_tenant]
    PA2[permissions_in_tenant]
    URA2[user_role_in_tenant]
    RPA2[role_permission_in_tenant]
  end

  %% Mapping
  UGM --&gt; UTA
  TENTS --&gt; UTA
  UGM --&gt; UTA1
  UGM --&gt; UTA2

  GRT --&gt; RA1
  GRT --&gt; RA2
  GPT --&gt; PA1
  GPT --&gt; PA2

  UTA1 --&gt; URA1
  RA1 --&gt; URA1
  RA1 --&gt; RPA1
  PA1 --&gt; RPA1

  UTA2 --&gt; URA2
  RA2 --&gt; URA2
  RA2 --&gt; RPA2
  PA2 --&gt; RPA2
</code></pre>
<p>ğŸ“Œ <strong>Giáº£i thÃ­ch:</strong></p>
<ul>
<li><code>users_global</code> lÃ  nguá»“n Ä‘á»‹nh danh chung, dÃ¹ng cho táº¥t cáº£ cÃ¡c tenant.</li>
<li>
<p>Má»—i tenant cÃ³ Sub User Service quáº£n lÃ½ riÃªng:</p>
</li>
<li>
<p><code>users_in_tenant</code> Ã¡nh xáº¡ tá»›i <code>user_id_global</code></p>
</li>
<li>Vai trÃ² &amp; quyá»n cá»¥c bá»™, cÃ³ thá»ƒ káº¿ thá»«a tá»« Master hoáº·c tá»± Ä‘á»‹nh nghÄ©a</li>
<li>Mapping RBAC (<code>user â†” role â†” permission</code>) lÃ  Ä‘á»™c láº­p giá»¯a cÃ¡c tenant.</li>
</ul>
<p>ğŸ“˜ SÆ¡ Ä‘á»“ nÃ y giÃºp Superadmin, DevOps vÃ  Dev hiá»ƒu rÃµ luá»“ng phÃ¢n quyá»n, vá»‹ trÃ­ source of truth, vÃ  cÃ¡ch tÃ¡ch biá»‡t báº£o máº­t giá»¯a cÃ¡c tenant.</p>
<hr/>
<h3 id="so-o-luong-kiem-tra-rbac-tai-api-gateway">ğŸ” SÆ¡ Ä‘á»“ Luá»“ng Kiá»ƒm tra RBAC táº¡i API Gateway<a class="headerlink" href="#so-o-luong-kiem-tra-rbac-tai-api-gateway" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant Client as ğŸŒ Client (Frontend)
    participant Gateway as ğŸ›¡ï¸ API Gateway
    participant Auth as ğŸ” Auth Service (Master/Sub)
    participant JWT as ğŸ“¦ JWT Token
    participant Redis as âš¡ RBAC Cache
    participant SubUser as ğŸ§© Sub User Service (per tenant)

    Client-&gt;&gt;Auth: ÄÄƒng nháº­p (OAuth2 / OTP)
    Auth-&gt;&gt;JWT: PhÃ¡t hÃ nh JWT chá»©a<br/>user_id, tenant_id, roles, permissions
    Client-&gt;&gt;Gateway: Gá»­i request kÃ¨m JWT

    Gateway-&gt;&gt;JWT: Giáº£i mÃ£ JWT
    Gateway-&gt;&gt;JWT: Láº¥y user_id, tenant_id, permissions
    alt Cache Hit
        Gateway-&gt;&gt;Redis: Láº¥y RBAC tá»« cache<br/>rbac:{user_id}:{tenant_id}
    else Cache Miss
        Gateway-&gt;&gt;SubUser: Gá»i API Ä‘á»ƒ láº¥y roles &amp; permissions
        SubUser--&gt;&gt;Gateway: Tráº£ vá» roles, permissions
        Gateway-&gt;&gt;Redis: Ghi cache RBAC
    end

    alt CÃ³ permission khá»›p + Ä‘iá»u kiá»‡n Ä‘Ãºng
        Gateway--&gt;&gt;Client: âœ… 200 OK (forward tá»›i backend)
    else KhÃ´ng cÃ³ quyá»n / Sai Ä‘iá»u kiá»‡n
        Gateway--&gt;&gt;Client: âŒ 403 Forbidden
    end
</code></pre>
<p>ğŸ“Œ <strong>Giáº£i thÃ­ch nhanh:</strong></p>
<ul>
<li>Gateway lÃ  nÆ¡i trung tÃ¢m Ä‘Ã¡nh giÃ¡ quyá»n dá»±a trÃªn JWT vÃ  RBAC.</li>
<li>DÃ¹ng cache Redis Ä‘á»ƒ trÃ¡nh gá»i Sub User Service quÃ¡ thÆ°á»ng xuyÃªn.</li>
<li>Há»— trá»£ <code>condition JSONB</code> Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ táº¡i Gateway báº±ng context tá»« JWT vÃ  request.</li>
</ul>
<p>ğŸ“˜ RBAC cache invalidation Ä‘Æ°á»£c Ä‘iá»u phá»‘i bá»Ÿi Pub/Sub events tá»« Sub User Service nhÆ° <code>rbac_updated</code> hoáº·c <code>user_status_changed</code>.</p>
<hr/>
<h3 id="so-o-luong-phat-hanh-jwt-a-tenant">ğŸ”‘ SÆ¡ Ä‘á»“ Luá»“ng PhÃ¡t hÃ nh JWT Äa-Tenant<a class="headerlink" href="#so-o-luong-phat-hanh-jwt-a-tenant" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant FE as ğŸŒ Frontend
    participant AuthM as ğŸ” Auth Master
    participant AuthT as ğŸ” Auth Sub
    participant Captcha as ğŸ›¡ï¸ reCAPTCHA
    participant TokenSvc as ğŸ—ï¸ Token Service
    participant UserSub as ğŸ§© User Sub (tenant)
    participant JWT as ğŸ“¦ JWT

    rect rgba(220,220,220,0.05)
        FE-&gt;&gt;AuthM: Login Google
        AuthM-&gt;&gt;UserSub: GET roles/permissions
        AuthM-&gt;&gt;TokenSvc: POST /token/issue
        TokenSvc--&gt;&gt;AuthM: JWT (RS256)
        AuthM--&gt;&gt;FE: Return JWT
    end

    rect rgba(220,220,220,0.05)
        FE-&gt;&gt;AuthT: Login OTP
        AuthT--&gt;&gt;Captcha: verify CAPTCHA
        Captcha--&gt;&gt;AuthT: OK / Fail
        AuthT-&gt;&gt;UserSub: GET RBAC
        AuthT-&gt;&gt;TokenSvc: POST /token/issue
        TokenSvc--&gt;&gt;AuthT: JWT (RS256)
        AuthT--&gt;&gt;FE: Return JWT
    end
</code></pre>
<p>ğŸ“Œ <strong>Äiá»ƒm chÃ­nh:</strong></p>
<ul>
<li>Auth Master xá»­ lÃ½ Google OAuth2 + lá»±a chá»n tenant.</li>
<li>Sub Auth xá»­ lÃ½ xÃ¡c thá»±c Local/OTP táº¡i tenant.</li>
<li>Má»i JWT phÃ¡t ra Ä‘á»u chá»©a <code>user_id_global</code>, <code>tenant_id</code>, <code>roles</code>, <code>permissions</code>, <code>jti</code>, <code>sid</code> â€“ phá»¥c vá»¥ thu há»“i token &amp; quáº£n lÃ½ phiÃªn (See CR-03).</li>
</ul>
<p>ğŸ“˜ Tham kháº£o chi tiáº¿t cáº¥u trÃºc JWT trong <a href="../../ADR/adr-006-auth-strategy/"><code>adr-006-auth-strategy.md</code></a></p>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Trá»Ÿ láº¡i má»¥c lá»¥c
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>