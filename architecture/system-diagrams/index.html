
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="T√†i li·ªáu ki·∫øn tr√∫c v√† ph√°t tri·ªÉn cho d·ª± √°n Chuy·ªÉn ƒë·ªïi s·ªë Tr∆∞·ªùng Vi·ªát Anh." name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://ezdesign-vn.github.io/dx-vas/architecture/system-diagrams/" rel="canonical"/>
<link href="../.." rel="prev"/>
<link href="../rbac-deep-dive/" rel="next"/>
<link href="../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>S∆° ƒë·ªì H·ªá th·ªëng - DX VAS - Docs</title>
<link href="../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#so-o-kien-truc-he-thong-dx-vas">
          B·ªè qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="ƒê·∫ßu trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../.." title="DX VAS - Docs">
<img alt="logo" src="../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              S∆° ƒë·ªì H·ªá th·ªëng
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="T√¨m ki·∫øm" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="T√¨m ki·∫øm" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="T√¨m ki·∫øm" class="md-search__options">
<button aria-label="Xo√°" class="md-search__icon md-icon" tabindex="-1" title="Xo√°" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem m√£ ngu·ªìn">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="./">
          
  
  
    
  
  Ki·∫øn tr√∫c H·ªá th·ªëng

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../dev-guide/">
        
  
  
    
  
  H∆∞·ªõng d·∫´n Ph√°t tri·ªÉn

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../services/">
        
  
  
    
  
  Thi·∫øt k·∫ø Services

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../ADR/">
          
  
  
    
  
  Quy·∫øt ƒë·ªãnh Ki·∫øn tr√∫c (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh ƒëi·ªÅu h∆∞·ªõng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="DX VAS - Docs">
<img alt="logo" src="../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/ezdesign-vn/dx-vas.git" title="Xem m√£ ngu·ªìn">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    ezdesign.vn/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
<span class="md-ellipsis">
    Ki·∫øn tr√∫c H·ªá th·ªëng
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Ki·∫øn tr√∫c H·ªá th·ªëng
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    S∆° ƒë·ªì H·ªá th·ªëng
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    S∆° ƒë·ªì H·ªá th·ªëng
    
  </span>
</a>
<nav aria-label="M·ª•c l·ª•c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      M·ª•c l·ª•c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#muc-luc-so-o-kien-truc-he-thong-dx-vas">
<span class="md-ellipsis">
      üìö M·ª•c l·ª•c S∆° ƒë·ªì Ki·∫øn tr√∫c H·ªá th·ªëng dx-vas
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#1-kien-truc-tong-quan-he-thong-multi-tenant">
<span class="md-ellipsis">
      1. Ki·∫øn tr√∫c t·ªïng quan h·ªá th·ªëng Multi-Tenant
    </span>
</a>
<nav aria-label="1. Ki·∫øn tr√∫c t·ªïng quan h·ªá th·ªëng Multi-Tenant" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#chu-thich-mui-ten-uong-net">
<span class="md-ellipsis">
      üóùÔ∏è Ch√∫ th√≠ch m≈©i t√™n &amp; ƒë∆∞·ªùng n√©t
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-luong-anh-gia-rbac-tai-api-gateway">
<span class="md-ellipsis">
      2. Lu·ªìng ƒë√°nh gi√° RBAC t·∫°i API Gateway
    </span>
</a>
<nav aria-label="2. Lu·ªìng ƒë√°nh gi√° RBAC t·∫°i API Gateway" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#21-sequence-diagram">
<span class="md-ellipsis">
      2.1 Sequence Diagram
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#22-buoc-xu-ly-chi-tiet">
<span class="md-ellipsis">
      2.2 B∆∞·ªõc x·ª≠ l√Ω chi ti·∫øt
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#23-quy-tac-xu-ly">
<span class="md-ellipsis">
      2.3 Quy t·∫Øc x·ª≠ l√Ω
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#24-metrics-alert">
<span class="md-ellipsis">
      2.4 Metrics &amp; Alert
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-luong-phat-hanh-jwt-a-tenant">
<span class="md-ellipsis">
      3. Lu·ªìng ph√°t h√†nh JWT ƒëa-tenant
    </span>
</a>
<nav aria-label="3. Lu·ªìng ph√°t h√†nh JWT ƒëa-tenant" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#31-sequence-diagram">
<span class="md-ellipsis">
      3.1 Sequence Diagram
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#32-buoc-xu-ly-chi-tiet">
<span class="md-ellipsis">
      3.2 B∆∞·ªõc x·ª≠ l√Ω chi ti·∫øt
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#33-cau-truc-jwt">
<span class="md-ellipsis">
      3.3 C·∫•u tr√∫c JWT
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#34-kiem-soat-bao-mat">
<span class="md-ellipsis">
      3.4 Ki·ªÉm so√°t &amp; B·∫£o m·∫≠t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#35-metric-giam-sat">
<span class="md-ellipsis">
      3.5 Metric gi√°m s√°t
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-luong-gui-notification-toan-he-thong-pubsub-fan-out">
<span class="md-ellipsis">
      4. Lu·ªìng g·ª≠i Notification to√†n h·ªá th·ªëng (Pub/Sub fan-out)
    </span>
</a>
<nav aria-label="4. Lu·ªìng g·ª≠i Notification to√†n h·ªá th·ªëng (Pub/Sub fan-out)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#41-sequence-diagram">
<span class="md-ellipsis">
      4.1 Sequence Diagram
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#42-inh-tuyen-schema">
<span class="md-ellipsis">
      4.2 ƒê·ªãnh tuy·∫øn &amp; Schema
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#43-xu-ly-tai-notification-master">
<span class="md-ellipsis">
      4.3 X·ª≠ l√Ω t·∫°i Notification Master
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#44-xu-ly-tai-notification-sub-per-tenant">
<span class="md-ellipsis">
      4.4 X·ª≠ l√Ω t·∫°i Notification Sub (per tenant)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#45-kha-nang-mo-rong-sla">
<span class="md-ellipsis">
      4.5 Kh·∫£ nƒÉng m·ªü r·ªông &amp; SLA
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#46-monitoring-alert">
<span class="md-ellipsis">
      4.6 Monitoring &amp; Alert
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-so-o-trien-khai-ha-tang-deployment-diagram">
<span class="md-ellipsis">
      5. S∆° ƒë·ªì tri·ªÉn khai h·∫° t·∫ßng (Deployment Diagram)
    </span>
</a>
<nav aria-label="5. S∆° ƒë·ªì tri·ªÉn khai h·∫° t·∫ßng (Deployment Diagram)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ghi-chu-chinh-sach">
<span class="md-ellipsis">
      üîë Ghi ch√∫ &amp; Ch√≠nh s√°ch
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-vong-oi-tai-khoan-account-lifecycle">
<span class="md-ellipsis">
      6. V√≤ng ƒë·ªùi T√†i kho·∫£n (Account Lifecycle)
    </span>
</a>
<nav aria-label="6. V√≤ng ƒë·ªùi T√†i kho·∫£n (Account Lifecycle)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-luong-khoi-tao-create-first-login">
<span class="md-ellipsis">
      6.1 Lu·ªìng kh·ªüi t·∫°o (Create / First Login)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-kich-hoat-ngung-hoat-ong">
<span class="md-ellipsis">
      6.2 K√≠ch ho·∫°t / Ng∆∞ng ho·∫°t ƒë·ªông
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-cap-nhat-thong-tin-ho-so">
<span class="md-ellipsis">
      6.3 C·∫≠p nh·∫≠t th√¥ng tin h·ªì s∆°
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-vong-oi-phien-session-ttl">
<span class="md-ellipsis">
      6.4 V√≤ng ƒë·ªùi phi√™n (Session TTL)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#65-an-danh-xoa-vinh-vien">
<span class="md-ellipsis">
      6.5 ·∫®n danh &amp; Xo√° vƒ©nh vi·ªÖn
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#66-mapping-jwt-rbac-cache">
<span class="md-ellipsis">
      6.6 Mapping ‚Üí JWT &amp; RBAC Cache
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#67-kpi-alert">
<span class="md-ellipsis">
      6.7 KPI &amp; Alert
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-luong-ong-bo-rbac-tu-master-sub-user-services">
<span class="md-ellipsis">
      7. Lu·ªìng ƒë·ªìng b·ªô RBAC t·ª´ Master ‚Üí Sub User Services
    </span>
</a>
<nav aria-label="7. Lu·ªìng ƒë·ªìng b·ªô RBAC t·ª´ Master ‚Üí Sub User Services" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-sequence-diagram-event-driven">
<span class="md-ellipsis">
      7.1 Sequence Diagram (Event-driven)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-su-kien-schema-adr-030">
<span class="md-ellipsis">
      7.2 S·ª± ki·ªán &amp; Schema (ADR-030)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-ong-bo-inh-ky-cron-sync">
<span class="md-ellipsis">
      7.3 ƒê·ªìng b·ªô ƒë·ªãnh k·ª≥ (Cron Sync)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-xu-ly-conflict">
<span class="md-ellipsis">
      7.4 X·ª≠ l√Ω conflict
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#75-cap-nhat-cache-gateway">
<span class="md-ellipsis">
      7.5 C·∫≠p nh·∫≠t cache &amp; Gateway
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#76-kpi-alert">
<span class="md-ellipsis">
      7.6 KPI &amp; Alert
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-phan-quyen-giao-dien-nguoi-dung-ui-role-mapping">
<span class="md-ellipsis">
      8. Ph√¢n quy·ªÅn Giao di·ªán Ng∆∞·ªùi D√πng (UI Role Mapping)
    </span>
</a>
<nav aria-label="8. Ph√¢n quy·ªÅn Giao di·ªán Ng∆∞·ªùi D√πng (UI Role Mapping)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-ma-tran-portal-vai-tro-chuan">
<span class="md-ellipsis">
      8.1 Ma tr·∫≠n Portal ‚Üí Vai tr√≤ Chu·∫©n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-mapping-ui-permission">
<span class="md-ellipsis">
      8.2 Mapping UI ‚Üí Permission
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-kiem-tra-quyen-frontend">
<span class="md-ellipsis">
      8.3 Ki·ªÉm tra quy·ªÅn (Frontend)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#84-dynamic-condition">
<span class="md-ellipsis">
      8.4 Dynamic Condition
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#85-quy-trinh-them-tinh-nang-moi">
<span class="md-ellipsis">
      8.5 Quy tr√¨nh th√™m t√≠nh nƒÉng m·ªõi
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#86-kpi-ui-authorization">
<span class="md-ellipsis">
      8.6 KPI UI Authorization
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-he-thong-bao-cao-phan-tich-reporting-analytics-architecture">
<span class="md-ellipsis">
      9. H·ªá th·ªëng B√°o c√°o &amp; Ph√¢n t√≠ch (Reporting &amp; Analytics Architecture)
    </span>
</a>
<nav aria-label="9. H·ªá th·ªëng B√°o c√°o &amp; Ph√¢n t√≠ch (Reporting &amp; Analytics Architecture)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#91-luong-du-lieu-tong-quat">
<span class="md-ellipsis">
      9.1 Lu·ªìng d·ªØ li·ªáu t·ªïng qu√°t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#92-kien-truc-data-warehouse-bigquery">
<span class="md-ellipsis">
      9.2 Ki·∫øn tr√∫c Data Warehouse (BigQuery)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#93-rbac-row-level-security">
<span class="md-ellipsis">
      9.3 RBAC &amp; Row-Level Security
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#94-template-export">
<span class="md-ellipsis">
      9.4 Template &amp; Export
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#95-giam-sat-chi-phi-hieu-suat">
<span class="md-ellipsis">
      9.5 Gi√°m s√°t chi ph√≠ &amp; Hi·ªáu su·∫•t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#96-so-o-quyen-truy-cap-bao-cao">
<span class="md-ellipsis">
      9.6 S∆° ƒë·ªì quy·ªÅn truy c·∫≠p b√°o c√°o
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#97-roadmap-mo-rong">
<span class="md-ellipsis">
      9.7 Roadmap m·ªü r·ªông
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-ai-integration-strategy">
<span class="md-ellipsis">
      10. AI Integration Strategy
    </span>
</a>
<nav aria-label="10. AI Integration Strategy" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#101-use-case-uu-tien-2025-2026">
<span class="md-ellipsis">
      10.1 Use-case ∆Øu ti√™n (2025-2026)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#102-kien-truc-trien-khai">
<span class="md-ellipsis">
      10.2 Ki·∫øn tr√∫c tri·ªÉn khai
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#103-model-lifecycle">
<span class="md-ellipsis">
      10.3 Model Lifecycle
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#104-bao-mat-ao-uc">
<span class="md-ellipsis">
      10.4 B·∫£o m·∫≠t &amp; ƒê·∫°o ƒë·ª©c
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#105-kpi-giam-sat">
<span class="md-ellipsis">
      10.5 KPI &amp; Gi√°m s√°t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#106-roadmap">
<span class="md-ellipsis">
      10.6 Roadmap
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../rbac-deep-dive/">
<span class="md-ellipsis">
    RBAC Chi ti·∫øt
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../dev-guide/">
<span class="md-ellipsis">
    H∆∞·ªõng d·∫´n Ph√°t tri·ªÉn
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../services/">
<span class="md-ellipsis">
    Thi·∫øt k·∫ø Services
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../ADR/">
<span class="md-ellipsis">
    Quy·∫øt ƒë·ªãnh Ki·∫øn tr√∫c (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quy·∫øt ƒë·ªãnh Ki·∫øn tr√∫c (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="M·ª•c l·ª•c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      M·ª•c l·ª•c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#muc-luc-so-o-kien-truc-he-thong-dx-vas">
<span class="md-ellipsis">
      üìö M·ª•c l·ª•c S∆° ƒë·ªì Ki·∫øn tr√∫c H·ªá th·ªëng dx-vas
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#1-kien-truc-tong-quan-he-thong-multi-tenant">
<span class="md-ellipsis">
      1. Ki·∫øn tr√∫c t·ªïng quan h·ªá th·ªëng Multi-Tenant
    </span>
</a>
<nav aria-label="1. Ki·∫øn tr√∫c t·ªïng quan h·ªá th·ªëng Multi-Tenant" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#chu-thich-mui-ten-uong-net">
<span class="md-ellipsis">
      üóùÔ∏è Ch√∫ th√≠ch m≈©i t√™n &amp; ƒë∆∞·ªùng n√©t
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-luong-anh-gia-rbac-tai-api-gateway">
<span class="md-ellipsis">
      2. Lu·ªìng ƒë√°nh gi√° RBAC t·∫°i API Gateway
    </span>
</a>
<nav aria-label="2. Lu·ªìng ƒë√°nh gi√° RBAC t·∫°i API Gateway" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#21-sequence-diagram">
<span class="md-ellipsis">
      2.1 Sequence Diagram
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#22-buoc-xu-ly-chi-tiet">
<span class="md-ellipsis">
      2.2 B∆∞·ªõc x·ª≠ l√Ω chi ti·∫øt
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#23-quy-tac-xu-ly">
<span class="md-ellipsis">
      2.3 Quy t·∫Øc x·ª≠ l√Ω
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#24-metrics-alert">
<span class="md-ellipsis">
      2.4 Metrics &amp; Alert
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-luong-phat-hanh-jwt-a-tenant">
<span class="md-ellipsis">
      3. Lu·ªìng ph√°t h√†nh JWT ƒëa-tenant
    </span>
</a>
<nav aria-label="3. Lu·ªìng ph√°t h√†nh JWT ƒëa-tenant" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#31-sequence-diagram">
<span class="md-ellipsis">
      3.1 Sequence Diagram
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#32-buoc-xu-ly-chi-tiet">
<span class="md-ellipsis">
      3.2 B∆∞·ªõc x·ª≠ l√Ω chi ti·∫øt
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#33-cau-truc-jwt">
<span class="md-ellipsis">
      3.3 C·∫•u tr√∫c JWT
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#34-kiem-soat-bao-mat">
<span class="md-ellipsis">
      3.4 Ki·ªÉm so√°t &amp; B·∫£o m·∫≠t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#35-metric-giam-sat">
<span class="md-ellipsis">
      3.5 Metric gi√°m s√°t
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-luong-gui-notification-toan-he-thong-pubsub-fan-out">
<span class="md-ellipsis">
      4. Lu·ªìng g·ª≠i Notification to√†n h·ªá th·ªëng (Pub/Sub fan-out)
    </span>
</a>
<nav aria-label="4. Lu·ªìng g·ª≠i Notification to√†n h·ªá th·ªëng (Pub/Sub fan-out)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#41-sequence-diagram">
<span class="md-ellipsis">
      4.1 Sequence Diagram
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#42-inh-tuyen-schema">
<span class="md-ellipsis">
      4.2 ƒê·ªãnh tuy·∫øn &amp; Schema
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#43-xu-ly-tai-notification-master">
<span class="md-ellipsis">
      4.3 X·ª≠ l√Ω t·∫°i Notification Master
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#44-xu-ly-tai-notification-sub-per-tenant">
<span class="md-ellipsis">
      4.4 X·ª≠ l√Ω t·∫°i Notification Sub (per tenant)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#45-kha-nang-mo-rong-sla">
<span class="md-ellipsis">
      4.5 Kh·∫£ nƒÉng m·ªü r·ªông &amp; SLA
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#46-monitoring-alert">
<span class="md-ellipsis">
      4.6 Monitoring &amp; Alert
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-so-o-trien-khai-ha-tang-deployment-diagram">
<span class="md-ellipsis">
      5. S∆° ƒë·ªì tri·ªÉn khai h·∫° t·∫ßng (Deployment Diagram)
    </span>
</a>
<nav aria-label="5. S∆° ƒë·ªì tri·ªÉn khai h·∫° t·∫ßng (Deployment Diagram)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ghi-chu-chinh-sach">
<span class="md-ellipsis">
      üîë Ghi ch√∫ &amp; Ch√≠nh s√°ch
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-vong-oi-tai-khoan-account-lifecycle">
<span class="md-ellipsis">
      6. V√≤ng ƒë·ªùi T√†i kho·∫£n (Account Lifecycle)
    </span>
</a>
<nav aria-label="6. V√≤ng ƒë·ªùi T√†i kho·∫£n (Account Lifecycle)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-luong-khoi-tao-create-first-login">
<span class="md-ellipsis">
      6.1 Lu·ªìng kh·ªüi t·∫°o (Create / First Login)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-kich-hoat-ngung-hoat-ong">
<span class="md-ellipsis">
      6.2 K√≠ch ho·∫°t / Ng∆∞ng ho·∫°t ƒë·ªông
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-cap-nhat-thong-tin-ho-so">
<span class="md-ellipsis">
      6.3 C·∫≠p nh·∫≠t th√¥ng tin h·ªì s∆°
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-vong-oi-phien-session-ttl">
<span class="md-ellipsis">
      6.4 V√≤ng ƒë·ªùi phi√™n (Session TTL)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#65-an-danh-xoa-vinh-vien">
<span class="md-ellipsis">
      6.5 ·∫®n danh &amp; Xo√° vƒ©nh vi·ªÖn
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#66-mapping-jwt-rbac-cache">
<span class="md-ellipsis">
      6.6 Mapping ‚Üí JWT &amp; RBAC Cache
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#67-kpi-alert">
<span class="md-ellipsis">
      6.7 KPI &amp; Alert
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-luong-ong-bo-rbac-tu-master-sub-user-services">
<span class="md-ellipsis">
      7. Lu·ªìng ƒë·ªìng b·ªô RBAC t·ª´ Master ‚Üí Sub User Services
    </span>
</a>
<nav aria-label="7. Lu·ªìng ƒë·ªìng b·ªô RBAC t·ª´ Master ‚Üí Sub User Services" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-sequence-diagram-event-driven">
<span class="md-ellipsis">
      7.1 Sequence Diagram (Event-driven)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-su-kien-schema-adr-030">
<span class="md-ellipsis">
      7.2 S·ª± ki·ªán &amp; Schema (ADR-030)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-ong-bo-inh-ky-cron-sync">
<span class="md-ellipsis">
      7.3 ƒê·ªìng b·ªô ƒë·ªãnh k·ª≥ (Cron Sync)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-xu-ly-conflict">
<span class="md-ellipsis">
      7.4 X·ª≠ l√Ω conflict
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#75-cap-nhat-cache-gateway">
<span class="md-ellipsis">
      7.5 C·∫≠p nh·∫≠t cache &amp; Gateway
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#76-kpi-alert">
<span class="md-ellipsis">
      7.6 KPI &amp; Alert
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-phan-quyen-giao-dien-nguoi-dung-ui-role-mapping">
<span class="md-ellipsis">
      8. Ph√¢n quy·ªÅn Giao di·ªán Ng∆∞·ªùi D√πng (UI Role Mapping)
    </span>
</a>
<nav aria-label="8. Ph√¢n quy·ªÅn Giao di·ªán Ng∆∞·ªùi D√πng (UI Role Mapping)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-ma-tran-portal-vai-tro-chuan">
<span class="md-ellipsis">
      8.1 Ma tr·∫≠n Portal ‚Üí Vai tr√≤ Chu·∫©n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-mapping-ui-permission">
<span class="md-ellipsis">
      8.2 Mapping UI ‚Üí Permission
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-kiem-tra-quyen-frontend">
<span class="md-ellipsis">
      8.3 Ki·ªÉm tra quy·ªÅn (Frontend)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#84-dynamic-condition">
<span class="md-ellipsis">
      8.4 Dynamic Condition
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#85-quy-trinh-them-tinh-nang-moi">
<span class="md-ellipsis">
      8.5 Quy tr√¨nh th√™m t√≠nh nƒÉng m·ªõi
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#86-kpi-ui-authorization">
<span class="md-ellipsis">
      8.6 KPI UI Authorization
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-he-thong-bao-cao-phan-tich-reporting-analytics-architecture">
<span class="md-ellipsis">
      9. H·ªá th·ªëng B√°o c√°o &amp; Ph√¢n t√≠ch (Reporting &amp; Analytics Architecture)
    </span>
</a>
<nav aria-label="9. H·ªá th·ªëng B√°o c√°o &amp; Ph√¢n t√≠ch (Reporting &amp; Analytics Architecture)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#91-luong-du-lieu-tong-quat">
<span class="md-ellipsis">
      9.1 Lu·ªìng d·ªØ li·ªáu t·ªïng qu√°t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#92-kien-truc-data-warehouse-bigquery">
<span class="md-ellipsis">
      9.2 Ki·∫øn tr√∫c Data Warehouse (BigQuery)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#93-rbac-row-level-security">
<span class="md-ellipsis">
      9.3 RBAC &amp; Row-Level Security
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#94-template-export">
<span class="md-ellipsis">
      9.4 Template &amp; Export
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#95-giam-sat-chi-phi-hieu-suat">
<span class="md-ellipsis">
      9.5 Gi√°m s√°t chi ph√≠ &amp; Hi·ªáu su·∫•t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#96-so-o-quyen-truy-cap-bao-cao">
<span class="md-ellipsis">
      9.6 S∆° ƒë·ªì quy·ªÅn truy c·∫≠p b√°o c√°o
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#97-roadmap-mo-rong">
<span class="md-ellipsis">
      9.7 Roadmap m·ªü r·ªông
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-ai-integration-strategy">
<span class="md-ellipsis">
      10. AI Integration Strategy
    </span>
</a>
<nav aria-label="10. AI Integration Strategy" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#101-use-case-uu-tien-2025-2026">
<span class="md-ellipsis">
      10.1 Use-case ∆Øu ti√™n (2025-2026)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#102-kien-truc-trien-khai">
<span class="md-ellipsis">
      10.2 Ki·∫øn tr√∫c tri·ªÉn khai
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#103-model-lifecycle">
<span class="md-ellipsis">
      10.3 Model Lifecycle
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#104-bao-mat-ao-uc">
<span class="md-ellipsis">
      10.4 B·∫£o m·∫≠t &amp; ƒê·∫°o ƒë·ª©c
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#105-kpi-giam-sat">
<span class="md-ellipsis">
      10.5 KPI &amp; Gi√°m s√°t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#106-roadmap">
<span class="md-ellipsis">
      10.6 Roadmap
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="so-o-kien-truc-he-thong-dx-vas">S∆° ƒë·ªì Ki·∫øn tr√∫c H·ªá th·ªëng dx-vas<a class="headerlink" href="#so-o-kien-truc-he-thong-dx-vas" title="Permanent link">¬∂</a></h1>
<p>T√†i li·ªáu n√†y t·∫≠p h·ª£p t·∫•t c·∫£ c√°c s∆° ƒë·ªì ki·∫øn tr√∫c quan tr·ªçng c·ªßa h·ªá th·ªëng chuy·ªÉn ƒë·ªïi s·ªë dx-vas, bao g·ªìm:</p>
<ul>
<li>S∆° ƒë·ªì ki·∫øn tr√∫c t·ªïng th·ªÉ</li>
<li>Di·ªÖn gi·∫£i c√°c kh·ªëi ch·ª©c nƒÉng</li>
<li>C√°c s∆° ƒë·ªì con chi ti·∫øt theo t·ª´ng lu·ªìng nghi·ªáp v·ª• (v√≠ d·ª•: Tuy·ªÉn sinh, Th√¥ng b√°o, Ph√¢n quy·ªÅn RBAC...)</li>
</ul>
<h2 id="muc-luc-so-o-kien-truc-he-thong-dx-vas">üìö M·ª•c l·ª•c S∆° ƒë·ªì Ki·∫øn tr√∫c H·ªá th·ªëng dx-vas<a class="headerlink" href="#muc-luc-so-o-kien-truc-he-thong-dx-vas" title="Permanent link">¬∂</a></h2>
<table>
<thead>
<tr>
<th>STT</th>
<th>T√™n s∆° ƒë·ªì</th>
<th>M√¥ t·∫£ ng·∫Øn</th>
<th>Li√™n k·∫øt</th>
</tr>
</thead>
<tbody>
<tr>
<td>1Ô∏è‚É£</td>
<td><strong>Ki·∫øn tr√∫c t·ªïng quan h·ªá th·ªëng Multi-Tenant</strong></td>
<td>T·ªïng th·ªÉ h·ªá th·ªëng g·ªìm Shared Core v√† c√°c Tenant Stack</td>
<td><a href="#1-ki·∫øn-tr√∫c-t·ªïng-quan-h·ªá-th·ªëng-multi-tenant">Xem s∆° ƒë·ªì</a></td>
</tr>
<tr>
<td>2Ô∏è‚É£</td>
<td><strong>Lu·ªìng ƒë√°nh gi√° RBAC t·∫°i API Gateway</strong></td>
<td>C√°ch Gateway ƒë√°nh gi√° quy·ªÅn ƒë·ªông t·ª´ JWT + Redis + Sub Service</td>
<td><a href="#2-lu·ªìng-ƒë√°nh-gi√°-rbac-t·∫°i-api-gateway">Xem s∆° ƒë·ªì</a></td>
</tr>
<tr>
<td>3Ô∏è‚É£</td>
<td><strong>Lu·ªìng ph√°t h√†nh JWT ƒëa-tenant</strong></td>
<td>Qu√° tr√¨nh x√°c th·ª±c Google/OTP v√† ph√°t token</td>
<td><a href="#3-lu·ªìng-ph√°t-h√†nh-jwt-ƒëa-tenant">Xem s∆° ƒë·ªì</a></td>
</tr>
<tr>
<td>4Ô∏è‚É£</td>
<td><strong>Lu·ªìng g·ª≠i Notification to√†n h·ªá th·ªëng (Option B)</strong></td>
<td>Pub/Sub fan-out t·ª´ Master ƒë·∫øn Sub Notification Services</td>
<td><a href="#4-lu·ªìng-g·ª≠i-notification-to√†n-h·ªá-th·ªëng-pubsub-fan-out">Xem s∆° ƒë·ªì</a></td>
</tr>
<tr>
<td>5Ô∏è‚É£</td>
<td><strong>S∆° ƒë·ªì tri·ªÉn khai h·∫° t·∫ßng (Deployment Diagram)</strong></td>
<td>T·ªï ch·ª©c project GCP cho core/tenant/monitoring/data</td>
<td><a href="#5-s∆°-ƒë·ªì-tri·ªÉn-khai-h·∫°-t·∫ßng-deployment-diagram">Xem s∆° ƒë·ªì</a></td>
</tr>
<tr>
<td>6Ô∏è‚É£</td>
<td><strong>V√≤ng ƒë·ªùi t√†i kho·∫£n (Account Lifecycle)</strong></td>
<td>T·ª´ t·∫°o user ‚Üí g√°n tenant ‚Üí c·∫•p quy·ªÅn ‚Üí v√¥ hi·ªáu h√≥a</td>
<td><a href="#6-v√≤ng-ƒë·ªùi-t√†i-kho·∫£n-account-lifecycle">Xem s∆° ƒë·ªì</a></td>
</tr>
<tr>
<td>7Ô∏è‚É£</td>
<td><strong>Lu·ªìng ƒë·ªìng b·ªô RBAC t·ª´ Master ‚Üí Sub</strong></td>
<td>T·ª± ƒë·ªông ho·∫∑c th·ªß c√¥ng sync role/permission template</td>
<td><a href="#7-lu·ªìng-ƒë·ªìng-b·ªô-rbac-t·ª´-master--sub-user-services">Xem s∆° ƒë·ªì</a></td>
</tr>
<tr>
<td>8Ô∏è‚É£</td>
<td><strong>Ph√¢n quy·ªÅn giao di·ªán ng∆∞·ªùi d√πng (UI Role Mapping)</strong></td>
<td>Vai tr√≤ ƒë∆∞·ª£c √°nh x·∫° ƒë·∫øn c√°c frontend: Superadmin, Admin, GV, PH</td>
<td><a href="#8-ph√¢n-quy·ªÅn-giao-di·ªán-ng∆∞·ªùi-d√πng-ui-role-mapping">Xem s∆° ƒë·ªì</a></td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="1-kien-truc-tong-quan-he-thong-multi-tenant">1. Ki·∫øn tr√∫c t·ªïng quan h·ªá th·ªëng Multi-Tenant<a class="headerlink" href="#1-kien-truc-tong-quan-he-thong-multi-tenant" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>M·ª•c ti√™u</strong> ‚Äì Cho th·∫•y b·ª©c tranh cao nh·∫•t: <strong>Core Services</strong> d√πng chung, <strong>Tenant Stack</strong> c√¥ l·∫≠p; JWT do <strong>Token Service</strong> k√Ω, RBAC cache ·ªü <strong>API Gateway</strong>, d·ªØ li·ªáu nghi·ªáp v·ª• g√≥i trong <strong>SMS</strong> (per tenant).</p>
</blockquote>
<pre class="mermaid"><code>flowchart TD
  %% ======= EXTERNAL =======
  subgraph ext ["üåê External IdP &amp; Channels"]
    GoogleOAuth(Google OAuth2)
    OTPProv(OTP Provider)
    EmailSvc(Email Gateway)
    SMSSvc(SMS Gateway)
  end

  %% ======= FRONTEND =======
  subgraph fe ["üíª Frontend Apps"]
    AdminPortal(Admin Portal)
    TeacherPortal(Teacher Portal)
    StudentPortal(Student Portal)
    ParentPortal(Parent Portal)
  end

  %% ======= CORE SERVICES =======
  subgraph core ["üîß Core Services (Shared)"]
    APIGW(API Gateway)
    TokenSvc(Token Service)
    AuthM(Auth Master)
    UserM(User Master)
    NotifM(Notification Master)
    RedisRev[Redis<br/>revoked_tokens cache]
    ReportSvc(Reporting Service)
    AuditLog(Audit Logging Service)
    PubSub((Pub / Sub))
  end

  %% ======= DATA PLATFORM =======
  subgraph db ["üîß Data Platform"]
    BQ(Data Warehouse)
  end

  %% ======= MONITORING STACK =======
  subgraph mon ["üìà Monitoring Stack"]
    CloudLog(Cloud Logging)
    CloudMon(Cloud Monitoring)
    AlertSys(Alerting Rules)
  end

  %% ======= CI / CONTRACT TESTING =======
  subgraph test ["üß™ CI / Contract Testing"]
    CIPipeline(CI/CD Pipeline)
    ContractEngine(Contract Test Engine)
    MockUser(Mock: User Service)
    MockNotif(Mock: Notif Service)
    MockAuth(Mock: Auth Service)
  end

  %% ======= TENANT STACK EXAMPLE =======
  subgraph tenantA ["üè´ Tenant Stack ¬∑ ABC School"]
    subgraph smsgrp ["School Management System (SMS)"]
      SMS(SMS Backend<br/>+ MariaDB)
    end
    AuthSub(Auth Sub)
    UserSub(User Sub)
    NotifSub(Notif Sub)
  end

  %% ======= FLOWS =======
  %% Front-door
  AdminPortal -. https .-&gt; APIGW
  TeacherPortal -. https .-&gt; APIGW
  StudentPortal -. https .-&gt; APIGW
  ParentPortal  -. https .-&gt; APIGW

  %% Auth &amp; Token
  APIGW --&gt;|/login| AuthM
  AuthM --&gt;|/token/issue| TokenSvc
  AuthSub --&gt;|/token/issue| TokenSvc
  TokenSvc -- JWKS --&gt; APIGW

  %% Revoked-token check
  APIGW --&gt;|check revoked| RedisRev
  TokenSvc --&gt;|sync revoked| RedisRev

  %% Core routing
  APIGW ==&gt; UserM
  APIGW ==&gt; NotifM
  APIGW ==&gt; ReportSvc
  APIGW ==&gt; AuditLog

  %% Tenant routing
  APIGW ==&gt; AuthSub
  APIGW ==&gt; UserSub
  APIGW ==&gt; NotifSub
  APIGW ==&gt; SMS

  %% Event fan-out
  UserM -- "user.*" --&gt; PubSub
  NotifM -- "notif.*" --&gt; PubSub
  PubSub -- "user.*" --&gt; UserSub
  PubSub -- "notif.*" --&gt; NotifSub

  %% ELT (simplified)
  SMS -- "ELT" --&gt; BQ

  %% Audit Logging
  AuthM --&gt;|log login| AuditLog
  TokenSvc --&gt;|log issue/revoke| AuditLog
  UserM --&gt;|log user change| AuditLog
  NotifM --&gt;|log notif trigger| AuditLog
  ReportSvc --&gt;|log report access| AuditLog
  AuthSub --&gt;|log local login| AuditLog
  UserSub --&gt;|log role update| AuditLog
  NotifSub --&gt;|log delivery| AuditLog

  %% Monitoring Stack
  APIGW --&gt; CloudLog
  AuthM --&gt; CloudLog
  TokenSvc --&gt; CloudLog
  UserM --&gt; CloudLog
  ReportSvc --&gt; CloudLog
  AuditLog --&gt; CloudLog
  AuthSub --&gt; CloudLog
  UserSub --&gt; CloudLog
  SMS --&gt; CloudLog
  NotifSub --&gt; CloudLog
  CloudLog --&gt; CloudMon
  CloudMon --&gt; AlertSys

  %% CI/CD &amp; Contract Testing
  CIPipeline --&gt; ContractEngine
  ContractEngine --&gt; MockUser
  ContractEngine --&gt; MockNotif
  ContractEngine --&gt; MockAuth
  MockUser --&gt;|simulate calls| APIGW
  MockNotif --&gt;|simulate notif| APIGW
  MockAuth --&gt;|simulate login| APIGW
</code></pre>
<h3 id="chu-thich-mui-ten-uong-net">üóùÔ∏è Ch√∫ th√≠ch m≈©i t√™n &amp; ƒë∆∞·ªùng n√©t<a class="headerlink" href="#chu-thich-mui-ten-uong-net" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>K√Ω hi·ªáu</th>
<th>√ù nghƒ©a</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-. https .-&gt;</code></td>
<td>G·ªçi HTTPS t·ª´ frontend/browser</td>
</tr>
<tr>
<td><code>--&gt;</code></td>
<td>G·ªçi API ƒë·ªìng b·ªô n·ªôi b·ªô</td>
</tr>
<tr>
<td><code>==&gt;</code></td>
<td>G·ªçi API ƒë·ªìng b·ªô ∆∞u ti√™n cao / routing ch√≠nh</td>
</tr>
<tr>
<td><code>..&gt;</code></td>
<td>Lu·ªìng b·∫•t ƒë·ªìng b·ªô (Pub/Sub, ELT)</td>
</tr>
<tr>
<td><code>-- JWKS --&gt;</code></td>
<td>Gateway t·∫£i public key JWKS ƒë·ªÉ x√°c th·ª±c JWT</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>Token Service</strong> k√Ω JWT (RS256); <strong>API Gateway</strong> x√°c th·ª±c offline qua <strong>JWKS</strong> cache 10 ‚Ä≤ v√† ki·ªÉm tra <code>revoked:{jti}</code> trong <strong>Redis</strong> tr∆∞·ªõc khi ƒë√°nh gi√° RBAC.</li>
<li><strong>SMS</strong> thay th·∫ø ho√†n to√†n c√°c adapter CRM/SIS/LMS c≈©, tr·ªü th√†nh ngu·ªìn d·ªØ li·ªáu nghi·ªáp v·ª• duy nh·∫•t ·ªü m·ªói tenant.</li>
<li>M·ªói tenant stack tri·ªÉn khai ƒë·ªôc l·∫≠p; autoscale kh√¥ng ·∫£nh h∆∞·ªüng Core Services.</li>
</ul>
<blockquote>
<p>S∆° ƒë·ªì ph·∫£n √°nh ƒë·∫ßy ƒë·ªß hai Change Request g·∫ßn nh·∫•t: <strong>Token Service centralization</strong> v√† <strong>Tenant Stack simplification v·ªõi SMS</strong>.</p>
</blockquote>
<hr/>
<h2 id="2-luong-anh-gia-rbac-tai-api-gateway">2. Lu·ªìng ƒë√°nh gi√° RBAC t·∫°i API Gateway<a class="headerlink" href="#2-luong-anh-gia-rbac-tai-api-gateway" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>M·ª•c ti√™u</strong> ‚Äì ƒê·∫£m b·∫£o <strong>m·ªói request</strong> ƒë∆∞·ª£c x√°c th·ª±c (JWT) v√† u·ª∑ quy·ªÅn (RBAC + Condition) <strong>&lt; 5 ms</strong> p95, ƒë·ªìng th·ªùi ph·∫£n ·ª©ng t·ª©c th·ªùi khi token b·ªã thu h·ªìi ho·∫∑c quy·ªÅn thay ƒë·ªïi.</p>
</blockquote>
<h3 id="21-sequence-diagram">2.1 Sequence Diagram<a class="headerlink" href="#21-sequence-diagram" title="Permanent link">¬∂</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant FE      as üåê Frontend
    participant APIGW   as üõ°Ô∏è API Gateway
    participant RedisRev as üîÑ Redis revoked
    participant RedisRBAC as üîÑ Redis RBAC
    participant UserSub as üß© User Sub (tenant)
    participant TokenSvc as üóùÔ∏è Token Service

    FE-&gt;&gt;APIGW: HTTP request + JWT
    Note right of APIGW: ‚ë† Verify RS256 via<br/>JWKS (cache 10‚Ä≤)
    APIGW-&gt;&gt;RedisRev: GET revoked:{jti}       %% check revoked
    alt Token revoked
        APIGW--&gt;&gt;FE: 403 token.revoked
    else Not revoked
        APIGW-&gt;&gt;RedisRBAC: GET rbac:{uid}:{tid}
        alt Cache HIT
            Note right of APIGW: ‚ë° RBAC cache hit
        else Cache MISS
            APIGW-&gt;&gt;UserSub: /rbac?uid={uid}
            UserSub--&gt;&gt;APIGW: roles + perms
            APIGW-&gt;&gt;RedisRBAC: SET rbac:{uid}:{tid} (TTL)
        end
        Note right of APIGW: ‚ë¢ Evaluate<br/>Condition Engine
        alt Permission pass
            APIGW--&gt;&gt;FE: 2xx success
        else Denied
            APIGW--&gt;&gt;FE: 403 auth.permission_denied
        end
    end
</code></pre>
<h3 id="22-buoc-xu-ly-chi-tiet">2.2 B∆∞·ªõc x·ª≠ l√Ω chi ti·∫øt<a class="headerlink" href="#22-buoc-xu-ly-chi-tiet" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>#</th>
<th>B∆∞·ªõc</th>
<th>Th·ªùi gian m·ª•c ti√™u</th>
</tr>
</thead>
<tbody>
<tr>
<td>‚ë†</td>
<td>X√°c th·ª±c ch·ªØ k√Ω JWT b·∫±ng <strong>JWKS</strong> (cache 10 ph√∫t)</td>
<td>&lt; 0.5 ms</td>
</tr>
<tr>
<td>‚ë°</td>
<td>Tra <strong>Redis</strong> cache RBAC (<code>rbac:{uid}:{tid}</code>)</td>
<td>hit ‚â• 98 %</td>
</tr>
<tr>
<td>‚ë¢</td>
<td>Engine so s√°nh <code>condition</code> (<em>\$user</em>, <em>\$request</em>, <em>\$tenant</em>)</td>
<td>&lt; 4 ms</td>
</tr>
</tbody>
</table>
<h3 id="23-quy-tac-xu-ly">2.3 Quy t·∫Øc x·ª≠ l√Ω<a class="headerlink" href="#23-quy-tac-xu-ly" title="Permanent link">¬∂</a></h3>
<ol>
<li><strong>Token b·ªã thu h·ªìi</strong> ‚Üí tr·∫£ <code>403 token.revoked</code>, ghi metric <code>revoked_token_cache_hit_ratio</code>.</li>
<li><strong>RBAC cache miss</strong> ‚Üí t·∫£i t·ª´ <strong>User Sub</strong> r·ªìi set TTL 5 ‚Äì 15 ph√∫t (tu·ª≥ tenant).</li>
<li><strong>Permission c√≥ condition</strong> ‚Üí n·∫øu placeholder thi·∫øu / type mismatch ‚Üí <code>400 common.validation_failed</code>.</li>
<li><strong>M·ªçi ph·∫£n h·ªìi l·ªói</strong> d√πng <code>ErrorEnvelope</code> (ADR-011).</li>
</ol>
<h3 id="24-metrics-alert">2.4 Metrics &amp; Alert<a class="headerlink" href="#24-metrics-alert" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>M·ª•c ti√™u</th>
<th>Alert</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rbac_cache_hit_ratio</code></td>
<td>‚â• 98 %</td>
<td>&lt; 95 % 10‚Ä≤</td>
</tr>
<tr>
<td><code>revoked_token_cache_hit_ratio</code></td>
<td>‚â• 95 %</td>
<td>&lt; 90 % 10‚Ä≤</td>
</tr>
<tr>
<td><code>rbac_cond_latency_p95</code></td>
<td>&lt; 5 ms</td>
<td>&gt; 10 ms 5‚Ä≤</td>
</tr>
<tr>
<td><code>rbac_eval_error_rate</code></td>
<td>= 0</td>
<td>b·∫•t k·ª≥ &gt; 0.1 %</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>K·∫øt qu·∫£:</strong> V·ªõi cache hai t·∫ßng (RBAC &amp; Revoked) v√† Engine ƒëi·ªÅu ki·ªán ch·∫°y t·∫°i Gateway, dx-vas u·ª∑ quy·ªÅn g·∫ßn-real-time m√† kh√¥ng ƒë√°nh ƒë·ªïi hi·ªáu nƒÉng.</p>
</blockquote>
<hr/>
<h2 id="3-luong-phat-hanh-jwt-a-tenant">3. Lu·ªìng ph√°t h√†nh JWT ƒëa-tenant<a class="headerlink" href="#3-luong-phat-hanh-jwt-a-tenant" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>M·ª•c ti√™u</strong> ‚Äì T·∫°o <strong>JWT RS256</strong> ch·ª©a ƒë·∫ßy ƒë·ªß claim (<code>sub</code>, <code>tid</code>, <code>roles</code>, <code>permissions</code>, <code>jti</code>, <code>sid</code>, <code>exp</code>) cho <strong>m·ªçi ph∆∞∆°ng th·ª©c ƒëƒÉng nh·∫≠p</strong> (Google OAuth2 &amp; Local / OTP) v√† m·ªçi tenant.</p>
</blockquote>
<h3 id="31-sequence-diagram">3.1 Sequence Diagram<a class="headerlink" href="#31-sequence-diagram" title="Permanent link">¬∂</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant FE as üåê Frontend
    participant APIGW as üõ°Ô∏è API Gateway
    participant AuthM as üîê Auth Master
    participant AuthT as üîê Auth Sub
    participant Captcha as üõ°Ô∏è reCAPTCHA
    participant UserSub as üß© User Sub (tenant)
    participant TokenSvc as üóùÔ∏è Token Service

    %% JWKS cache line (dashed for offline verify)
    TokenSvc--&gt;&gt;APIGW: JWKS (cache 10‚Ä≤)

    rect rgba(220,220,220,0.05)
        FE-&gt;&gt;APIGW: /login/google
        APIGW-&gt;&gt;AuthM: forward
        AuthM-&gt;&gt;Google OAuth2: auth code flow
        Google OAuth2--&gt;&gt;AuthM: id_token
        AuthM-&gt;&gt;UserSub: GET roles/permissions
        AuthM-&gt;&gt;TokenSvc: POST /token/issue
        TokenSvc--&gt;&gt;AuthM: JWT (access + refresh)
        AuthM--&gt;&gt;APIGW: 200 JWT
        APIGW--&gt;&gt;FE: 200 JWT
    end

    rect rgba(220,220,220,0.05)
        FE-&gt;&gt;APIGW: /login/otp
        APIGW-&gt;&gt;AuthT: forward
        AuthT--&gt;&gt;Captcha: verify CAPTCHA
        Captcha--&gt;&gt;AuthT: OK / Fail
        AuthT-&gt;&gt;AuthT: verify OTP / password
        AuthT-&gt;&gt;UserSub: GET RBAC
        AuthT-&gt;&gt;TokenSvc: POST /token/issue
        TokenSvc--&gt;&gt;AuthT: JWT (access + refresh)
        AuthT--&gt;&gt;APIGW: 200 JWT
        APIGW--&gt;&gt;FE: 200 JWT
    end
</code></pre>
<h3 id="32-buoc-xu-ly-chi-tiet">3.2 B∆∞·ªõc x·ª≠ l√Ω chi ti·∫øt<a class="headerlink" href="#32-buoc-xu-ly-chi-tiet" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>B∆∞·ªõc</th>
<th>M√¥ t·∫£</th>
<th>Th√†nh ph·∫ßn</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Frontend g·ª≠i y√™u c·∫ßu ƒëƒÉng nh·∫≠p (Google ho·∫∑c OTP).</td>
<td>FE ‚Üí API Gateway</td>
</tr>
<tr>
<td>2</td>
<td><strong>Auth Master</strong> (Google) ho·∫∑c <strong>Auth Sub</strong> (OTP) x√°c th·ª±c ng∆∞·ªùi d√πng.</td>
<td>AuthM / AuthT</td>
</tr>
<tr>
<td>3</td>
<td>G·ªçi <strong>User Sub</strong> l·∫•y <code>roles</code>, <code>permissions</code> trong tenant ƒë√£ ch·ªçn.</td>
<td>AuthM / AuthT</td>
</tr>
<tr>
<td>4</td>
<td>G·ªçi <strong>Token Service</strong> <code>POST /token/issue</code> ‚Üí nh·∫≠n c·∫∑p token ƒë√£ k√Ω <strong>RS256</strong>.</td>
<td>AuthM / AuthT ‚Üí TokenSvc</td>
</tr>
<tr>
<td>5</td>
<td>Tr·∫£ JWT cho Frontend qua <strong>API Gateway</strong>.</td>
<td>AuthM / AuthT ‚Üí APIGW ‚Üí FE</td>
</tr>
</tbody>
</table>
<h3 id="33-cau-truc-jwt">3.3 C·∫•u tr√∫c JWT<a class="headerlink" href="#33-cau-truc-jwt" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Claim</th>
<th>√ù nghƒ©a</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sub</code></td>
<td><code>user_id_global</code></td>
</tr>
<tr>
<td><code>tid</code></td>
<td><code>tenant_id</code></td>
</tr>
<tr>
<td><code>roles</code>, <code>permissions</code></td>
<td>Danh s√°ch vai tr√≤ &amp; quy·ªÅn (RBAC)</td>
</tr>
<tr>
<td><code>auth_provider</code></td>
<td><code>google</code> / <code>local</code> / <code>otp</code></td>
</tr>
<tr>
<td><code>jti</code></td>
<td>UUID duy nh·∫•t ‚Äì d√πng thu h·ªìi token</td>
</tr>
<tr>
<td><code>sid</code></td>
<td>Session ID tham chi·∫øu <code>auth_sessions</code></td>
</tr>
<tr>
<td><code>exp</code></td>
<td>H·∫øt h·∫°n ‚â§ 15 ph√∫t (access token)</td>
</tr>
</tbody>
</table>
<p>Refresh token TTL 14 ng√†y; l∆∞u <code>auth_sessions</code>.</p>
<h3 id="34-kiem-soat-bao-mat">3.4 Ki·ªÉm so√°t &amp; B·∫£o m·∫≠t<a class="headerlink" href="#34-kiem-soat-bao-mat" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>CAPTCHA</strong> b·∫Øt bu·ªôc tr∆∞·ªõc b∆∞·ªõc OTP ƒë·ªÉ tr√°nh brute-force.</li>
<li><strong>JWKS</strong> c√¥ng khai cache 10 ph√∫t ‚Äì Gateway x√°c th·ª±c ch·ªØ k√Ω offline.</li>
<li><strong>Token revocation</strong>: <code>/token/revoke</code> th√™m <code>jti</code> v√†o Redis (<code>revoked:{jti}</code>) ‚Üí Gateway ch·∫∑n ngay.</li>
</ul>
<h3 id="35-metric-giam-sat">3.5 Metric gi√°m s√°t<a class="headerlink" href="#35-metric-giam-sat" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>token_issue_latency_p95</code></td>
<td>&lt; 100 ms</td>
</tr>
<tr>
<td><code>login_success_rate</code></td>
<td>&gt; 98 %</td>
</tr>
<tr>
<td><code>captcha_failure_rate</code></td>
<td>&lt; 2 %</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>K·∫øt qu·∫£:</strong> Ng∆∞·ªùi d√πng nh·∫≠n JWT trong m·ªôt v√≤ng request, c√≤n API Gateway s·ªü h·ªØu ƒë·ªß th√¥ng tin (<code>tid</code>, RBAC, jti) ƒë·ªÉ x√°c th·ª±c &amp; u·ª∑ quy·ªÅn si√™u nhanh cho t·ª´ng tenant.</p>
</blockquote>
<hr/>
<h2 id="4-luong-gui-notification-toan-he-thong-pubsub-fan-out">4. Lu·ªìng g·ª≠i Notification to√†n h·ªá th·ªëng (Pub/Sub fan-out)<a class="headerlink" href="#4-luong-gui-notification-toan-he-thong-pubsub-fan-out" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>M·ª•c ti√™u</strong> ‚Äì T√°ch r·ªùi <strong>orchestration</strong> (Notification Master) kh·ªèi <strong>delivery</strong> (Notification Sub per tenant), b·∫£o ƒë·∫£m:<br/>
‚Ä¢ Th·ªëng nh·∫•t template &amp; tracking ·ªü Core.<br/>
‚Ä¢ Fan-out s·ª± ki·ªán <strong>&lt; 1 s</strong> t·ªõi m·ªçi tenant.<br/>
‚Ä¢ Kh√¥ng r√†ng bu·ªôc tenant v√†o h·∫° t·∫ßng SMTP/SMS chung.  </p>
</blockquote>
<h3 id="41-sequence-diagram">4.1 Sequence Diagram<a class="headerlink" href="#41-sequence-diagram" title="Permanent link">¬∂</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant ServiceX as üìù Any Core / SMS
    participant NotifM   as üì£ Notification Master
    participant PubSub   as ‚òÅÔ∏è Pub/Sub<br/>topic **notification.v1**
    participant NotifSub as üì© Notification Sub (tenant)
    participant EmailSvc as ‚úâÔ∏è Email Gateway
    participant SMSSvc   as üì± SMS Gateway

    ServiceX-&gt;&gt;NotifM: POST /notifications (payload, tenant_id)
    NotifM-&gt;&gt;NotifM: Validate + resolve template
    NotifM-&gt;&gt;PubSub: üîî **notif.email_requested.v1**
    NotifM-&gt;&gt;PubSub: üîî **notif.sms_requested.v1**
    PubSub--&gt;&gt;NotifSub: Fan-out event (filter tenant_id)
    NotifSub-&gt;&gt;EmailSvc: Send email
    NotifSub-&gt;&gt;SMSSvc: Send SMS
    NotifSub-&gt;&gt;PubSub: üîî **notif.sent.v1** (status, message_id)
    PubSub--&gt;&gt;NotifM: Ack status
</code></pre>
<h3 id="42-inh-tuyen-schema">4.2 ƒê·ªãnh tuy·∫øn &amp; Schema<a class="headerlink" href="#42-inh-tuyen-schema" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Ch·ªß ƒë·ªÅ / Event</th>
<th>M√¥ t·∫£</th>
<th>Schema ID (ADR-030)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>notification.v1</code></td>
<td>Topic chung cho m·ªçi s·ª± ki·ªán notificaton</td>
<td>‚Äî</td>
</tr>
<tr>
<td><code>notif.email_requested.v1</code></td>
<td>Master y√™u c·∫ßu g·ª≠i Email</td>
<td><code>notif_email_req_v1</code></td>
</tr>
<tr>
<td><code>notif.sms_requested.v1</code></td>
<td>Master y√™u c·∫ßu g·ª≠i SMS</td>
<td><code>notif_sms_req_v1</code></td>
</tr>
<tr>
<td><code>notif.sent.v1</code></td>
<td>Sub b√°o c√°o k·∫øt qu·∫£ (OK/FAIL)</td>
<td><code>notif_sent_v1</code></td>
</tr>
</tbody>
</table>
<p><em>Tenant Sub</em> subscribe v·ªõi filter <code>attributes.tenant_id == "&lt;tenant&gt;"</code> ‚Üí t√°ch bi·ªát lu·ªìng.</p>
<h3 id="43-xu-ly-tai-notification-master">4.3 X·ª≠ l√Ω t·∫°i Notification Master<a class="headerlink" href="#43-xu-ly-tai-notification-master" title="Permanent link">¬∂</a></h3>
<ol>
<li><strong>Validate</strong> payload &amp; tenant quota.</li>
<li><strong>Merge Template</strong> ‚Üî data; log <code>audit_log.notifications</code>.</li>
<li><strong>Publish</strong> s·ª± ki·ªán <code>*.requested.v1</code> k√®m <code>schema_version</code>.</li>
<li><strong>Track</strong> status qua <code>notif.sent.v1</code>; retry n·∫øu k·∫øt qu·∫£ <code>FAIL</code>.</li>
</ol>
<h3 id="44-xu-ly-tai-notification-sub-per-tenant">4.4 X·ª≠ l√Ω t·∫°i Notification Sub (per tenant)<a class="headerlink" href="#44-xu-ly-tai-notification-sub-per-tenant" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>B∆∞·ªõc</th>
<th>H√†nh ƒë·ªông</th>
<th>Idempotency</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Nh·∫≠n event; ki·ªÉm tra <code>dedup_id</code></td>
<td>Redis SETNX 15 m</td>
</tr>
<tr>
<td>2</td>
<td>Render template (locale)</td>
<td>‚Äî</td>
</tr>
<tr>
<td>3</td>
<td>G·ª≠i Email / SMS</td>
<td>3 l·∫ßn retry back-off</td>
</tr>
<tr>
<td>4</td>
<td>Publish <code>notif.sent.v1</code> (status, message_id)</td>
<td>‚Äî</td>
</tr>
</tbody>
</table>
<h3 id="45-kha-nang-mo-rong-sla">4.5 Kh·∫£ nƒÉng m·ªü r·ªông &amp; SLA<a class="headerlink" href="#45-kha-nang-mo-rong-sla" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Th√†nh ph·∫ßn</th>
<th>Autoscale</th>
<th>SLA</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pub/Sub topic <code>notification.v1</code></td>
<td>100k msg/s</td>
<td>‚â• 99.9 %</td>
</tr>
<tr>
<td>Notification Sub</td>
<td>HPA (RPS &amp; queue lag)</td>
<td>email &lt; 30 s, sms &lt; 10 s</td>
</tr>
<tr>
<td>Email/SMS Gateway</td>
<td>Ngo√†i ph·∫°m vi (3rd-party)</td>
<td>‚Äî</td>
</tr>
</tbody>
</table>
<h3 id="46-monitoring-alert">4.6 Monitoring &amp; Alert<a class="headerlink" href="#46-monitoring-alert" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>Metric</strong> <code>notif_sent_success_rate</code> ‚â• 97 % (per channel).</li>
<li><strong>Lag</strong> Pub/Sub <code>subscription/oldest_unacked_age</code> &lt; 5 s.</li>
<li><strong>Dashboard</strong> s·ªë l∆∞·ª£ng g·ª≠i Email/SMS theo tenant, bounce rate, cost.</li>
<li><strong>Alert</strong> n·∫øu <code>notif.sent.v1</code> FAIL &gt; 2 % trong 5 ‚Ä≤.</li>
</ul>
<blockquote>
<p>Nh·ªù Pub/Sub fan-out, DX-VAS g·ª≠i th√¥ng b√°o <strong>m·ªôt l·∫ßn</strong> ·ªü Core nh∆∞ng b·∫£o ƒë·∫£m <strong>m·ªói tenant</strong> x·ª≠ l√Ω &amp; tu·ª≥ bi·∫øn ri√™ng, ƒë·ªìng th·ªùi Master v·∫´n n·∫Øm ƒë·∫ßy ƒë·ªß log &amp; KPI.</p>
</blockquote>
<hr/>
<h2 id="5-so-o-trien-khai-ha-tang-deployment-diagram">5. S∆° ƒë·ªì tri·ªÉn khai h·∫° t·∫ßng (Deployment Diagram)<a class="headerlink" href="#5-so-o-trien-khai-ha-tang-deployment-diagram" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>Ph√¢n t√°ch</strong> r√µ hai bi√™n:<br/>
<strong>Core Project</strong> ‚Äì ch·∫°y duy nh·∫•t, chia s·∫ª cho m·ªçi tenant;<br/>
<strong>Tenant Project</strong> ‚Äì nh√¢n b·∫£n cho t·ª´ng tr∆∞·ªùng, ƒë·ªôc l·∫≠p compute/giao th·ª©c m·∫°ng, ch·ªâ k·∫øt n·ªëi qua API Gateway &amp; Pub/Sub.</p>
</blockquote>
<pre class="mermaid"><code>flowchart TD
%% ========= CORE PROJECT =========
  subgraph Core[üè¢ GCP Project **dx-vas-core**]
    direction TB
    subgraph CoreVPC["üîê VPC core (GKE)"]
      APIGW[üõ°Ô∏è API Gateway<br/>Envoy]
      TokenSvc[üóùÔ∏è Token Service]
      AuthM[üîê Auth Master]
      UserM[üë• User Master]
      NotifM[üì£ Notification Master]
      ReportSvc[üìä Reporting Service]
    end
    RedisRev[(üîÑ Redis Cluster<br/>revoked_tokens)]
    CloudSQL[(üêò PostgreSQL\nusers_global + audit)]
    PubSubCore((‚òÅÔ∏è Pub/Sub))
    BQ[(üì¶ BigQuery<br/>Data Warehouse)]
    SecretMgr[[üîë Secret Manager]]
  end

%% ========= TENANT PROJECT (EXAMPLE) =========
  subgraph TenantA[üè´ GCP Project **dx-vas-tenant-abc**]
    direction TB
    subgraph TenantVPC["üîê VPC tenant (GKE)"]
      AuthSub[üîê Auth Sub]
      UserSub[üë§ User Sub]
      NotifSub[üì• Notif Sub]
      SMS[üè´ SMS<br/>Backend]
    end
    SMSDB[(üçÉ MariaDB<br/>Galera Cluster)]
    RedisTenant[(üîÑ Redis Local)]
    PubSubTenant((‚òÅÔ∏è Pub/Sub<br/>sub-only))
  end

%% ========= TRAFFIC =========
  %% Front-end
  FE[üåê Portals / Mobile]
  FE -. https .-&gt; APIGW

  %% Token flow
  APIGW --&gt; TokenSvc
  TokenSvc -- JWKS --&gt; APIGW
  TokenSvc --&gt; RedisRev

  %% Core services
  APIGW ==&gt; AuthM
  APIGW ==&gt; UserM
  APIGW ==&gt; NotifM
  APIGW ==&gt; ReportSvc

  %% Pub/Sub fan-out
  NotifM --"notif.*"--&gt; PubSubCore
  UserM --"user.*"--&gt; PubSubCore
  PubSubCore --"filtered by tenant_id"--&gt; PubSubTenant
  PubSubTenant --"events"--&gt; NotifSub
  PubSubTenant --"events"--&gt; UserSub

  %% Tenant internal
  APIGW ==&gt; AuthSub
  APIGW ==&gt; UserSub
  APIGW ==&gt; SMS
  NotifSub --&gt; EmailSvc[[‚úâÔ∏è Email\nGateway]]
  NotifSub --&gt; SMSSvc[[üì± SMS\nGateway]]

  %% Data / ELT
  SMS --&gt;|ELT| BQ

  %% Secrets &amp; KV
  TokenSvc --&gt; SecretMgr
  AuthM --&gt; SecretMgr

  %% VPC Peering
  CoreVPC --- TenantVPC

  %% Legend ‚Äì External gateway node
  ExtGW[[‚úâÔ∏è/üì± External Gateway]]

  %% Legend
  classDef edgeHttps stroke-dasharray: 5 3;
  class FE edgeHttps;
</code></pre>
<blockquote>
<p>Node ExtGW[[‚úâÔ∏è/üì± External Gateway]] hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng ‚úâÔ∏è/üì±, t∆∞·ª£ng tr∆∞ng cho c·∫£ Email Gateway v√† SMS Gateway.
ƒê·∫∑t trong ph·∫ßn ‚ÄúLegend‚Äù gi√∫p ng∆∞·ªùi ƒë·ªçc hi·ªÉu nhanh √Ω nghƒ©a c·ªßa c√°c n√∫t EmailSvc v√† SMSSvc ƒë√£ d√πng ·ªü Tenant stack.</p>
</blockquote>
<h3 id="ghi-chu-chinh-sach">üîë Ghi ch√∫ &amp; Ch√≠nh s√°ch<a class="headerlink" href="#ghi-chu-chinh-sach" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Th√†nh ph·∫ßn</th>
<th>SLA / SLO</th>
<th>Autoscale</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>API Gateway</strong></td>
<td>p95 &lt; 20 ms</td>
<td>HPA RPS + CPU</td>
</tr>
<tr>
<td><strong>Token Service</strong></td>
<td>p95 &lt; 50 ms; availability 99.95 %</td>
<td>HPA CPU</td>
</tr>
<tr>
<td><strong>Redis Cluster (core)</strong></td>
<td>hit ‚â• 95 %; failover multi-AZ</td>
<td>Manged Memorystore</td>
</tr>
<tr>
<td><strong>Pub/Sub fan-out</strong></td>
<td>latency &lt; 1 s</td>
<td>Serverless</td>
</tr>
<tr>
<td><strong>Tenant GKE</strong></td>
<td>c√¥ l·∫≠p VPC; node-pool ri√™ng</td>
<td>HPA per tenant</td>
</tr>
<tr>
<td><strong>MariaDB Galera</strong></td>
<td>RPO = 0; RTO &lt; 5 min</td>
<td>CloudSQL HA</td>
</tr>
</tbody>
</table>
<ul>
<li>CI/CD: <strong>Argo CD</strong> sync <code>core</code> &amp; <code>tenant</code> chart; <strong>Terraform Cloud</strong> d·ª±ng VPC, DB, Secret.</li>
<li>VPC peering + firewall ch·ªâ m·ªü c·ªïng 443/mTLS; traffic gi·ªØa tenant ‚Üî core ƒëi qua <strong>API Gateway</strong>.</li>
<li><strong>Secret Manager</strong> l∆∞u RSA key (<code>kid current|next</code>) &amp; SMTP creds; rotation ‚â§ 90 ng√†y.</li>
</ul>
<blockquote>
<p><strong>K·∫øt qu·∫£</strong> ‚Äì Ki·∫øn tr√∫c t√°ch b·∫°ch gi√∫p m·ªü r·ªông tenant m·ªõi b·∫±ng m·ªôt c·ª•m GKE + MariaDB, kh√¥ng t√°c ƒë·ªông Core, ƒë·ªìng th·ªùi Core duy tr√¨ single-pane quan s√°t &amp; b·∫£o m·∫≠t.</p>
</blockquote>
<hr/>
<h2 id="6-vong-oi-tai-khoan-account-lifecycle">6. V√≤ng ƒë·ªùi T√†i kho·∫£n (Account Lifecycle)<a class="headerlink" href="#6-vong-oi-tai-khoan-account-lifecycle" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>ƒê·ªãnh nghƒ©a</strong><br/>
<em>T√†i kho·∫£n</em> = b·∫£n ghi <strong>users_global</strong> (User Service Master) + (0‚Ä¶n) b·∫£n ghi <strong>users_in_tenant</strong>.<br/>
T√†i kho·∫£n c√≥ th·ªÉ <strong>s·ªëng</strong> ·ªü nhi·ªÅu tenant, <strong>ƒë√≥ng bƒÉng</strong> (inactive) c·ª•c b·ªô ho·∫∑c to√†n c·ª•c, <strong>ƒë∆∞·ª£c ·∫©n danh</strong> ho·∫∑c <strong>xo√° vƒ©nh vi·ªÖn</strong> theo ADR-024 &amp; ADR-026.</p>
</blockquote>
<h3 id="61-luong-khoi-tao-create-first-login">6.1 Lu·ªìng kh·ªüi t·∫°o (Create / First Login)<a class="headerlink" href="#61-luong-khoi-tao-create-first-login" title="Permanent link">¬∂</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant FE       as üåê Frontend
    participant AuthM    as üîê Auth Master
    participant UserM    as üë• User Master
    participant UserSub  as üß© User Sub
    participant PubSub   as ‚òÅÔ∏è Pub/Sub

    FE-&gt;&gt;AuthM: Login Google
    AuthM-&gt;&gt;UserM: GET /users?email=&lt;&gt;
    alt New user
        UserM--&gt;&gt;AuthM: 404
        AuthM-&gt;&gt;UserM: POST /users (create\, provider)
    else Exists
        UserM--&gt;&gt;AuthM: user_id_global
    end
    AuthM-&gt;&gt;UserM: PUT /assign tenant_id
    UserM--&gt;&gt;AuthM: 200 OK
    UserM--&gt;&gt;PubSub: üîî **user.created.v1** / **user.tenant_assigned.v1**
    PubSub--&gt;&gt;UserSub: fan-out
    UserSub-&gt;&gt;UserSub: UPSERT users_in_tenant
</code></pre>
<ul>
<li><strong>Provider</strong>: <code>google</code> / <code>local</code> / <code>otp</code> (l∆∞u trong <code>auth_provider</code>).</li>
<li><strong>Event</strong> <code>user.created.v1</code> ch·ª©a <code>schema_version</code>, d√πng ƒë·ªÉ seed tenant DB.</li>
</ul>
<h3 id="62-kich-hoat-ngung-hoat-ong">6.2 K√≠ch ho·∫°t / Ng∆∞ng ho·∫°t ƒë·ªông<a class="headerlink" href="#62-kich-hoat-ngung-hoat-ong" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Ph·∫°m vi</th>
<th>API</th>
<th>Tr·∫°ng th√°i</th>
<th>Event</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>To√†n c·ª•c</strong></td>
<td><code>PATCH /users/{id} is_active=false</code></td>
<td>Kh√≥a ƒëƒÉng nh·∫≠p m·ªçi tenant</td>
<td><code>user_status_changed.v1</code></td>
</tr>
<tr>
<td><strong>C·ª•c b·ªô (tenant)</strong></td>
<td><code>PATCH /users/{id}?tenant_id=... is_active_in_tenant=false</code></td>
<td>Kh√≥a trong tenant hi·ªán t·∫°i</td>
<td><code>user_status_changed.v1</code></td>
</tr>
</tbody>
</table>
<p>Gateway cache <strong>RBAC</strong> b·ªã xo√° khi nh·∫≠n event \&amp;nbsps token c≈© s·∫Ω b·ªã ch·∫∑n n·∫øu user_inactive.</p>
<h3 id="63-cap-nhat-thong-tin-ho-so">6.3 C·∫≠p nh·∫≠t th√¥ng tin h·ªì s∆°<a class="headerlink" href="#63-cap-nhat-thong-tin-ho-so" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>To√†n c·ª•c</strong>: <code>PUT /users/{id}</code> ‚Üí b·∫£ng <code>users_global</code>.</li>
<li><strong>C·ª•c b·ªô</strong> : <code>PUT /users/{id}</code> + header <code>X-Tenant-ID</code> ‚Üí b·∫£ng <code>users_in_tenant</code>.</li>
<li>Ph√°t event <code>user.profile_updated.v1</code>; ETL ƒë·ªìng b·ªô sang BigQuery.</li>
</ul>
<h3 id="64-vong-oi-phien-session-ttl">6.4 V√≤ng ƒë·ªùi phi√™n (Session TTL)<a class="headerlink" href="#64-vong-oi-phien-session-ttl" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Lo·∫°i</th>
<th>TTL</th>
<th>L∆∞u ·ªü</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Access token</strong></td>
<td>‚â§ 15 ‚Ä≤</td>
<td>JWT claim <code>exp</code></td>
</tr>
<tr>
<td><strong>Refresh token</strong></td>
<td>14 ng√†y</td>
<td>b·∫£ng <code>auth_sessions</code></td>
</tr>
<tr>
<td><strong>Force logout</strong></td>
<td><code>/token/revoke sid=*</code></td>
<td>Xo√° Redis <code>revoked:{jti}</code></td>
</tr>
</tbody>
</table>
<h3 id="65-an-danh-xoa-vinh-vien">6.5 ·∫®n danh &amp; Xo√° vƒ©nh vi·ªÖn<a class="headerlink" href="#65-an-danh-xoa-vinh-vien" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Pha</th>
<th>Thao t√°c</th>
<th>Timeout</th>
<th>ADR</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Soft Delete</strong></td>
<td>User self-delete ‚Üí <code>is_active = false</code>, flag <code>delete_after = now+30d</code></td>
<td>30 ng√†y</td>
<td>026</td>
</tr>
<tr>
<td><strong>Hard Delete</strong></td>
<td>Job <code>user_purge</code> xo√° b·∫£n ghi, ƒë·ªïi d·ªØ li·ªáu PII ‚Üí hash</td>
<td>‚Äî</td>
<td>024 &amp; 026</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>Audit log</strong> ghi ‚Äúuser purged‚Äù k√®m <code>gdpr_request_id</code>.</li>
<li><code>user.deleted.v1</code> event b·∫Øn l√™n Pub/Sub ‚Üí Tenant Sub nh·∫≠n &amp; purge b·∫£n ghi local.</li>
</ul>
<h3 id="66-mapping-jwt-rbac-cache">6.6 Mapping ‚Üí JWT &amp; RBAC Cache<a class="headerlink" href="#66-mapping-jwt-rbac-cache" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Thu·ªôc t√≠nh</th>
<th>Ngu·ªìn</th>
<th>Claim / Cache</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user_id</code></td>
<td>users_global.user_id</td>
<td><code>sub</code></td>
</tr>
<tr>
<td><code>tenant_id</code></td>
<td>header ch·ªçn tenant</td>
<td><code>tid</code></td>
</tr>
<tr>
<td><code>roles / perms</code></td>
<td>JOIN UserSub</td>
<td>Cache <code>rbac:{uid}:{tid}</code> 5-15 ‚Ä≤</td>
</tr>
<tr>
<td><code>is_active</code></td>
<td>users_global</td>
<td>Gateway ch·∫∑n n·∫øu false</td>
</tr>
<tr>
<td><code>is_active_in_tenant</code></td>
<td>users_in_tenant</td>
<td>Gateway ch·∫∑n n·∫øu false</td>
</tr>
</tbody>
</table>
<h3 id="67-kpi-alert">6.7 KPI &amp; Alert<a class="headerlink" href="#67-kpi-alert" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>M·ª•c ti√™u</th>
<th>Alert</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user_login_success_rate</code></td>
<td>&gt; 98 % tenant-avg</td>
<td>&lt; 95 % 15‚Ä≤</td>
</tr>
<tr>
<td><code>user_purge_backlog</code></td>
<td>= 0</td>
<td>&gt; 0 ghi Jira</td>
</tr>
<tr>
<td><code>profile_update_latency_p95</code></td>
<td>&lt; 100 ms</td>
<td>&gt; 200 ms</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>T√≥m t·∫Øt</strong> ‚Äì V√≤ng ƒë·ªùi t√†i kho·∫£n ƒë∆∞·ª£c qu·∫£n tr·ªã trung t√¢m nh∆∞ng cho ph√©p tenant t·ª± do tu·ª≥ ch·ªânh RBAC, ƒë·ªìng th·ªùi tu√¢n th·ªß GDPR v·ªÅ xo√° v√† ·∫©n danh d·ªØ li·ªáu.</p>
</blockquote>
<hr/>
<h2 id="7-luong-ong-bo-rbac-tu-master-sub-user-services">7. Lu·ªìng ƒë·ªìng b·ªô RBAC t·ª´ Master ‚Üí Sub User Services<a class="headerlink" href="#7-luong-ong-bo-rbac-tu-master-sub-user-services" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>M·ª•c ti√™u</strong> ‚Äì B·∫£o ƒë·∫£m <strong>Role / Permission</strong> lu√¥n ƒë·ªìng nh·∫•t gi·ªØa <strong>User Master</strong> v√† <strong>User Sub</strong> m√† v·∫´n cho ph√©p tenant <strong>t√πy ch·ªânh</strong> khi c·∫ßn.<br/>
C∆° ch·∫ø ƒë·ªìng b·ªô k·∫øt h·ª£p <strong>s·ª± ki·ªán (event-driven)</strong> &amp; <strong>ƒë·ªìng b·ªô ƒë·ªãnh k·ª≥ (cron sync)</strong>, c√≥ ki·ªÉm so√°t <em>schema_version</em> (ADR-030).</p>
</blockquote>
<h3 id="71-sequence-diagram-event-driven">7.1 Sequence Diagram (Event-driven)<a class="headerlink" href="#71-sequence-diagram-event-driven" title="Permanent link">¬∂</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant Admin as üéõÔ∏è Admin Portal (Core)
    participant UserM as üë• User Master
    participant PubSub as ‚òÅÔ∏è Pub/Sub topic **rbac.v1**
    participant UserSub as üß© User Sub (tenant)
    participant RedisRBAC as üîÑ Redis rbac cache
    participant APIGW as üõ°Ô∏è API Gateway

    Admin-&gt;&gt;UserM: POST /roles (create) üîñschema_version=2
    UserM--&gt;&gt;PubSub: üîî rbac_updated.v1 { tenant_id="*", ... }
    PubSub--&gt;&gt;UserSub: fan-out event (filter tenant_id)
    UserSub-&gt;&gt;UserSub: UPSERT role / permission
    UserSub--&gt;&gt;PubSub: üîî rbac_updated_ack.v1
    PubSub--&gt;&gt;UserM: ack

    Note over APIGW,RedisRBAC: Gateway nh·∫≠n event<br/>x√≥a cache rbac:{uid}:{tid}
</code></pre>
<h3 id="72-su-kien-schema-adr-030">7.2 S·ª± ki·ªán &amp; Schema (ADR-030)<a class="headerlink" href="#72-su-kien-schema-adr-030" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Event</th>
<th>Khi n√†o ph√°t</th>
<th>Payload ch√≠nh</th>
<th>Ghi ch√∫</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rbac_updated.v1</code></td>
<td>Master thay ƒë·ªïi / t·∫°o m·ªõi role, permission</td>
<td><code>tenant_id</code> (<code>*</code> = all), <code>schema_version</code>, <code>diff[]</code></td>
<td>Fan-out t·ªõi tenant Sub</td>
</tr>
<tr>
<td><code>rbac_updated_ack.v1</code></td>
<td>Sub x·ª≠ l√Ω xong diff</td>
<td><code>tenant_id</code>, <code>applied_version</code></td>
<td>Cho Master tracking</td>
</tr>
<tr>
<td><code>rbac_template_synced.v1</code></td>
<td>Job sync ƒë·ªãnh k·ª≥</td>
<td><code>tenant_id</code>, <code>from_version</code>, <code>to_version</code></td>
<td>Ch·ªâ khi tenant d√πng template ‚Äúinherit‚Äù</td>
</tr>
</tbody>
</table>
<p>JSON Schema ID l∆∞u trong <strong>Schema Registry</strong>, backward-compat ‚â• 6 th√°ng.</p>
<h3 id="73-ong-bo-inh-ky-cron-sync">7.3 ƒê·ªìng b·ªô ƒë·ªãnh k·ª≥ (Cron Sync)<a class="headerlink" href="#73-ong-bo-inh-ky-cron-sync" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Chu k·ª≥</th>
<th>Trigger</th>
<th>ƒêi·ªÅu ki·ªán ch·∫°y</th>
<th>H√†nh ƒë·ªông</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>weekly</code> (default)</td>
<td>Cloud Scheduler ‚Üí Cloud Run <code>sync-job</code></td>
<td>Tenant c√≥ <code>sync_mode=inherit</code></td>
<td>So s√°nh <code>schema_version</code>; publish <code>rbac_template_synced.v1</code> n·∫øu kh√°c</td>
</tr>
<tr>
<td><code>manual</code></td>
<td>Tenant Admin ‚Üí ‚ÄúSync Now‚Äù</td>
<td>‚Äî</td>
<td>G·ªçi th·∫≥ng User Master <code>POST /templates/sync</code></td>
</tr>
</tbody>
</table>
<p><em>N·∫øu tenant ƒë√£ </em><em>clone</em><em> template, job ghi log <code>status=forked</code> ‚Äì </em><em>kh√¥ng ghi ƒë√®</em><em>.</em></p>
<h3 id="74-xu-ly-conflict">7.4 X·ª≠ l√Ω conflict<a class="headerlink" href="#74-xu-ly-conflict" title="Permanent link">¬∂</a></h3>
<blockquote>
<p><strong>Conflict</strong> = <code>permission_code</code> tr√πng nh∆∞ng <code>schema_version</code> kh√°c.</p>
</blockquote>
<ol>
<li>Job <code>sync-job</code> ph√°t hi·ªán ‚Üí flag <code>conflict=true</code>, publish <code>rbac_conflict_detected.v1</code>.</li>
<li>Tenant nh·∫≠n s·ª± ki·ªán, hi·ªÉn th·ªã banner ‚Äú<strong>RBAC template out-of-date</strong>‚Äù.</li>
<li>Admin tenant c√≥ 30 ng√†y ƒë·ªÉ merge / bump version, n·∫øu kh√¥ng h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông <em>lock</em> quy·ªÅn m·ªõi (deny by default).</li>
</ol>
<h3 id="75-cap-nhat-cache-gateway">7.5 C·∫≠p nh·∫≠t cache &amp; Gateway<a class="headerlink" href="#75-cap-nhat-cache-gateway" title="Permanent link">¬∂</a></h3>
<ul>
<li>Gateway subscribe <code>rbac_updated.v1</code>, <code>rbac_template_synced.v1</code>, <code>rbac_conflict_detected.v1</code>.</li>
<li>Khi s·ª± ki·ªán t·ªõi: <strong>xo√°</strong> <code>rbac:{user_id}:{tenant_id}</code> &amp; <code>revoked:{jti}</code> (n·∫øu c·∫ßn).</li>
<li>Metric <code>rbac_cache_invalidate_count</code> tƒÉng; latency invalidate m·ª•c ti√™u &lt; 1 s.</li>
</ul>
<h3 id="76-kpi-alert">7.6 KPI &amp; Alert<a class="headerlink" href="#76-kpi-alert" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Alert</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rbac_sync_success_rate</code></td>
<td>100 %</td>
<td>b·∫•t k·ª≥ l·ªói</td>
</tr>
<tr>
<td><code>rbac_template_age_days</code></td>
<td>&lt; 30 d (inherit)</td>
<td>&gt; 45 d</td>
</tr>
<tr>
<td><code>rbac_conflict_count</code></td>
<td>0</td>
<td>&gt; 0 t·∫°o Jira</td>
</tr>
<tr>
<td><code>sync_job_duration_p95</code></td>
<td>&lt; 60 s</td>
<td>&gt; 120 s</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>K·∫øt qu·∫£</strong> ‚Äì Tenant lu√¥n c√≥ RBAC m·ªõi trong v√≤ng <strong>1 gi√¢y</strong> sau khi Master thay ƒë·ªïi, trong khi v·∫´n c√≥ <strong>quy·ªÅn t·ª± ch·ªß</strong> v·ªõi template ƒë√£ clone.</p>
</blockquote>
<hr/>
<h2 id="8-phan-quyen-giao-dien-nguoi-dung-ui-role-mapping">8. Ph√¢n quy·ªÅn Giao di·ªán Ng∆∞·ªùi D√πng (UI Role Mapping)<a class="headerlink" href="#8-phan-quyen-giao-dien-nguoi-dung-ui-role-mapping" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>M·ª•c ti√™u</strong> ‚Äì Li√™n k·∫øt <strong>Role / Permission</strong> (RBAC) v·ªõi <strong>t√≠nh nƒÉng c·ª• th·ªÉ</strong> tr√™n b·ªën c·ªïng <strong>Admin ¬∑ Teacher ¬∑ Student ¬∑ Parent</strong>, gi√∫p ƒë·ªôi frontend hi·ªÉn th·ªã/·∫©n n√∫t v√† ki·ªÉm tra quy·ªÅn th·ªëng nh·∫•t gi·ªØa UI &amp; Gateway.</p>
</blockquote>
<h3 id="81-ma-tran-portal-vai-tro-chuan">8.1 Ma tr·∫≠n Portal ‚Üí Vai tr√≤ Chu·∫©n<a class="headerlink" href="#81-ma-tran-portal-vai-tro-chuan" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Portal</th>
<th>Role m·∫∑c ƒë·ªãnh (<code>role_code</code>)</th>
<th>ƒê·ªëi t∆∞·ª£ng</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Admin Portal</strong></td>
<td><code>admin.super</code>, <code>admin.finance</code>, <code>admin.academic</code></td>
<td>Qu·∫£n tr·ªã tr∆∞·ªùng</td>
</tr>
<tr>
<td><strong>Teacher Portal</strong></td>
<td><code>teacher.homeroom</code>, <code>teacher.subject</code></td>
<td>Gi√°o vi√™n</td>
</tr>
<tr>
<td><strong>Student Portal</strong></td>
<td><code>student.default</code></td>
<td>H·ªçc sinh</td>
</tr>
<tr>
<td><strong>Parent Portal</strong></td>
<td><code>parent.default</code></td>
<td>Ph·ª• huynh</td>
</tr>
</tbody>
</table>
<p><em>Tenant c√≥ th·ªÉ </em><em>clone</em><em> v√† ƒë·ªïi t√™n role; <code>schema_version</code> tƒÉng l√™n khi s·ª≠a.</em></p>
<h3 id="82-mapping-ui-permission">8.2 Mapping UI ‚Üí Permission<a class="headerlink" href="#82-mapping-ui-permission" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Khu v·ª±c UI</th>
<th>H√†nh ƒë·ªông</th>
<th>Permission y√™u c·∫ßu (<code>permission_code</code>)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Dashboard</strong></td>
<td>Xem b√°o c√°o ƒëƒÉng nh·∫≠p</td>
<td><code>report.view_login_by_tenant</code></td>
</tr>
<tr>
<td><strong>Finance</strong></td>
<td>Xem b√°o c√°o t√†i ch√≠nh</td>
<td><code>report.view_financial_summary</code></td>
</tr>
<tr>
<td><strong>Gradebook</strong></td>
<td>S·ª≠a ƒëi·ªÉm</td>
<td><code>grade.edit_assignment</code> (teacher)</td>
</tr>
<tr>
<td><strong>Attendance</strong></td>
<td>ƒêi·ªÉm danh</td>
<td><code>attendance.mark</code></td>
</tr>
<tr>
<td><strong>User Management</strong></td>
<td>G√°n role</td>
<td><code>rbac.manage_role</code></td>
</tr>
<tr>
<td><strong>Settings</strong></td>
<td>ƒê·ªìng b·ªô RBAC template</td>
<td><code>rbac.sync_template</code></td>
</tr>
<tr>
<td><strong>SMS Broadcast</strong></td>
<td>G·ª≠i SMS h√†ng lo·∫°t</td>
<td><code>notif.broadcast_sms</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>UI component ƒë·ªçc <strong>JWT claim <code>permissions</code></strong> (ƒë√£ t·ªëi ∆∞u b·ªüi Gateway cache), ·∫©n n√∫t n·∫øu kh√¥ng ƒë·ªß quy·ªÅn.</p>
</blockquote>
<h3 id="83-kiem-tra-quyen-frontend">8.3 Ki·ªÉm tra quy·ªÅn (Frontend)<a class="headerlink" href="#83-kiem-tra-quyen-frontend" title="Permanent link">¬∂</a></h3>
<div class="language-ts highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">// React helper</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useAuth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">"@/hooks/useAuth"</span><span class="p">;</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">Can</span><span class="p">({</span><span class="w"> </span><span class="nx">perm</span><span class="p">,</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">permissions</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useAuth</span><span class="p">();</span><span class="w">          </span><span class="c1">// l·∫•y t·ª´ JWT decode</span>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">permissions</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">perm</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">children</span><span class="p">;</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">                                </span><span class="c1">// ·∫©n UI n·∫øu thi·∫øu quy·ªÅn</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="p">}</span>
</span></code></pre></div>
<p><em>√Åp d·ª•ng pattern n√†y cho button/menu t·ª´ng portal; tr√°nh ‚Äúhard-code‚Äù role.</em></p>
<h3 id="84-dynamic-condition">8.4 Dynamic Condition<a class="headerlink" href="#84-dynamic-condition" title="Permanent link">¬∂</a></h3>
<ul>
<li>V·ªõi permission c√≥ <code>condition</code>, FE g·ªüi <code>input_parameters</code> ƒë√∫ng schema:</li>
</ul>
<div class="language-json highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="p">{</span><span class="w"> </span><span class="nt">"class_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10A1"</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>Gateway s·∫Ω so s√°nh <code>$request.class_id</code> vs <code>$user.class_id</code>; FE <strong>kh√¥ng</strong> c·∫ßn logic ph·ª•.</li>
</ul>
<h3 id="85-quy-trinh-them-tinh-nang-moi">8.5 Quy tr√¨nh th√™m t√≠nh nƒÉng m·ªõi<a class="headerlink" href="#85-quy-trinh-them-tinh-nang-moi" title="Permanent link">¬∂</a></h3>
<ol>
<li><strong>FE</strong> m·ªü PR t·∫°o UI + flag <code>TODO_PERMISSION</code>.</li>
<li><strong>BE</strong> th√™m permission v√†o <code>global_permissions_templates</code> (<code>schema_version+1</code>).</li>
<li><strong>RBAC Sync Job</strong> fan-out <code>rbac_updated.v1</code>; FE l·∫•y JWT m·ªõi ‚Üí ch·ª©c nƒÉng hi·ªÉn th·ªã.</li>
<li>Th√™m entry m·ªõi v√†o <strong>b·∫£ng 8.2</strong> trong t√†i li·ªáu n√†y.</li>
</ol>
<h3 id="86-kpi-ui-authorization">8.6 KPI UI Authorization<a class="headerlink" href="#86-kpi-ui-authorization" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ui_unauthorized_click_rate</code></td>
<td>&lt; 0.1 %</td>
</tr>
<tr>
<td><code>jwt_permissions_payload_size</code></td>
<td>‚â§ 4 KB</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>K·∫øt qu·∫£</strong> ‚Äì Ph√¢n quy·ªÅn UI l·ªá thu·ªôc ƒë√∫ng v√†o <strong>Permission</strong> (kh√¥ng ph·∫£i Role c·ª©ng), cho ph√©p tenant thay ƒë·ªïi Role m√† kh√¥ng ph·∫£i s·ª≠a Frontend.</p>
</blockquote>
<hr/>
<h2 id="9-he-thong-bao-cao-phan-tich-reporting-analytics-architecture">9. H·ªá th·ªëng B√°o c√°o &amp; Ph√¢n t√≠ch (Reporting &amp; Analytics Architecture)<a class="headerlink" href="#9-he-thong-bao-cao-phan-tich-reporting-analytics-architecture" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>M·ª•c ti√™u</strong> ‚Äì Cung c·∫•p b√°o c√°o <strong>g·∫ßn real-time</strong>, t√°ch bi·ªát d·ªØ li·ªáu ƒëa-tenant, cho ph√©p <strong>ph√¢n quy·ªÅn chi ti·∫øt</strong> (row-level) d·ª±a tr√™n RBAC v√† <code>condition</code> c·ªßa permission. Ki·∫øn tr√∫c tu√¢n th·ªß <code>ADR-028 ‚Äì Reporting Architecture</code>, <code>ADR-029 ‚Äì Report Template Schema</code>, <code>ADR-030 ‚Äì Event Schema Governance</code>.</p>
</blockquote>
<h3 id="91-luong-du-lieu-tong-quat">9.1 Lu·ªìng d·ªØ li·ªáu t·ªïng qu√°t<a class="headerlink" href="#91-luong-du-lieu-tong-quat" title="Permanent link">¬∂</a></h3>
<pre class="mermaid"><code>flowchart LR
  SMS((üìö SMS<br/>MariaDB))
  Debezium([‚öôÔ∏è Debezium CDC])
  DataLake[(üíæ GCS Parquet Staging)]
  DataFlow([üõ†Ô∏è Dataflow<br/>ELT Transform])
  BQ[üì¶ BigQuery<br/>Data Warehouse]
  ReportSvc([üìä Reporting Service])
  APIGW(üõ°Ô∏è API Gateway)
  FE[üåê Superadmin Portal]

  SMS --&gt; Debezium --&gt; DataLake --&gt; DataFlow --&gt; BQ
  ReportSvc ==&gt; BQ
  FE -. https .-&gt; APIGW ==&gt; ReportSvc
</code></pre>
<ul>
<li><strong>CDC</strong> Debezium stream ‚Üí GCS (parquet) &lt; 1 min lag.</li>
<li><strong>Dataflow</strong> load &amp; transform ‚ûú BQ <strong>Raw ‚Üí Staging ‚Üí Mart</strong> (Kimball).</li>
<li><strong>Reporting Service</strong> ch·∫°y query tham s·ªë ho√°, th√™m <code>tenant_id</code> &amp; RBAC filters.</li>
<li><strong>Superadmin Portal</strong> t·∫£i b√°o c√°o qua Gateway (JWT + permission ki·ªÉm tra).</li>
</ul>
<h3 id="92-kien-truc-data-warehouse-bigquery">9.2 Ki·∫øn tr√∫c Data Warehouse (BigQuery)<a class="headerlink" href="#92-kien-truc-data-warehouse-bigquery" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Layer</th>
<th>V√≠ d·ª• b·∫£ng</th>
<th>Partition / Cluster</th>
<th>B·∫£o m·∫≠t</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Raw</strong></td>
<td><code>abc_sms_enrolment_raw</code></td>
<td><code>_PARTITIONDATE</code></td>
<td>IAM: read-only</td>
</tr>
<tr>
<td><strong>Staging</strong></td>
<td><code>abc_sms_enrolment_stg</code></td>
<td><code>_PARTITIONDATE</code></td>
<td>‚Äî</td>
</tr>
<tr>
<td><strong>Mart</strong></td>
<td><code>fct_enrolment</code> ¬∑ <code>dim_student</code></td>
<td>cluster <code>tenant_id</code></td>
<td>Row ACL by <code>tenant_id</code></td>
</tr>
<tr>
<td><strong>Reporting View</strong></td>
<td><code>vw_financial_summary</code></td>
<td>‚Äî</td>
<td>Authorized View per tenant</td>
</tr>
</tbody>
</table>
<p><em>Retention</em>: Raw 30 ng√†y, Mart 5 nƒÉm (·∫©n danh PII theo ADR-024).</p>
<h3 id="93-rbac-row-level-security">9.3 RBAC &amp; Row-Level Security<a class="headerlink" href="#93-rbac-row-level-security" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>C·∫•p truy c·∫≠p</th>
<th>ƒêi·ªÅu ki·ªán SQL</th>
<th>Permission y√™u c·∫ßu</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Tenant</strong></td>
<td><code>WHERE tenant_id = $tid</code></td>
<td><code>report.view_financial_summary</code></td>
</tr>
<tr>
<td><strong>Class</strong></td>
<td><code>WHERE class_id = $user.class_id</code></td>
<td><code>report.view_login_by_tenant</code> + condition</td>
</tr>
<tr>
<td><strong>Global</strong></td>
<td>Kh√¥ng filter</td>
<td><code>report.view_financial_summary</code> + role <code>admin.super</code></td>
</tr>
</tbody>
</table>
<p><em>Gateway</em> g·∫Øn <code>tenant_id</code>, <code>roles</code>, <code>permissions</code> v√†o header; Reporting Service d·ª±ng c√¢u l·ªánh SQL v·ªõi <strong>parameterized filters</strong> ‚Üí tr√°nh SQL-Injection.</p>
<h3 id="94-template-export">9.4 Template &amp; Export<a class="headerlink" href="#94-template-export" title="Permanent link">¬∂</a></h3>
<ul>
<li>T·∫•t c·∫£ template JSON schema l∆∞u <code>report_templates</code> (version-controlled).</li>
<li>
<p>API:</p>
</li>
<li>
<p><code>GET /reports/{id}</code> ‚Äì metadata &amp; required params.</p>
</li>
<li><code>POST /reports/{id}/export</code> ‚Äì CSV / Parquet; header <code>Content-Disposition</code>.</li>
<li>Quy·ªÅn <code>report.manage_report_templates</code> cho ph√©p admin tenant s·ª≠a template clone.</li>
</ul>
<h3 id="95-giam-sat-chi-phi-hieu-suat">9.5 Gi√°m s√°t chi ph√≠ &amp; Hi·ªáu su·∫•t<a class="headerlink" href="#95-giam-sat-chi-phi-hieu-suat" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>KPI</th>
<th>M·ª•c ti√™u</th>
<th>Alert</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>bq_query_latency_p95</code></td>
<td>&lt; 5 s</td>
<td>&gt; 10 s 5‚Ä≤</td>
</tr>
<tr>
<td><code>bq_cost_per_tenant_day</code></td>
<td>+‚â§ 15 % 30 d-avg</td>
<td>Slack FinOps</td>
</tr>
<tr>
<td><code>elt_lag_minutes_p95</code></td>
<td>&lt; 10‚Ä≤</td>
<td>&gt; 20‚Ä≤ 15‚Ä≤</td>
</tr>
</tbody>
</table>
<h3 id="96-so-o-quyen-truy-cap-bao-cao">9.6 S∆° ƒë·ªì quy·ªÅn truy c·∫≠p b√°o c√°o<a class="headerlink" href="#96-so-o-quyen-truy-cap-bao-cao" title="Permanent link">¬∂</a></h3>
<pre class="mermaid"><code>stateDiagram-v2
  [*] --&gt; RequestAPI
  RequestAPI --&gt;|JWT valid + permission| BuildQuery
  BuildQuery --&gt; ExecuteBQ
  ExecuteBQ --&gt; ExportFile
  ExportFile --&gt; [*]
  RequestAPI --&gt;|No permission| Forbidden
  Forbidden --&gt; [*]
</code></pre>
<h3 id="97-roadmap-mo-rong">9.7 Roadmap m·ªü r·ªông<a class="headerlink" href="#97-roadmap-mo-rong" title="Permanent link">¬∂</a></h3>
<ol>
<li><strong>Materialized View</strong> cho b√°o c√°o th·ªùi gian th·ª±c attendance (latency &lt; 30 s).</li>
<li><strong>Pre-computed cube</strong> (BigQuery BI Engine) cho dashboard hi·ªáu nƒÉng cao.</li>
<li><strong>Tenant self-service chart builder</strong> ‚Äì drag-and-drop, d√πng row ACL ƒë√£ s·∫µn.</li>
</ol>
<blockquote>
<p><strong>K·∫øt qu·∫£</strong> ‚Äì B√°o c√°o ph√¢n t√°ch theo tenant, c√≥ th·ªÉ tu·ª≥ bi·∫øn ƒëi·ªÅu ki·ªán truy c·∫≠p (row-level), trong khi chi ph√≠ v√† ƒë·ªô tr·ªÖ ƒë∆∞·ª£c ki·ªÉm so√°t ch·∫∑t ch·∫Ω.</p>
</blockquote>
<hr/>
<h2 id="10-ai-integration-strategy">10. AI Integration Strategy<a class="headerlink" href="#10-ai-integration-strategy" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>M·ª•c ti√™u</strong> ‚Äì ·ª®ng d·ª•ng AI ƒë·ªÉ <strong>n√¢ng cao tr·∫£i nghi·ªám</strong> (chat-support, g·ª£i √Ω h·ªçc t·∫≠p), <strong>t·ªëi ∆∞u v·∫≠n h√†nh</strong> (d·ª± b√°o l·ªói, chi ph√≠) v√† <strong>m·ªü r·ªông s·∫£n ph·∫©m</strong> (ph√¢n t√≠ch d·ªØ li·ªáu h·ªçc t·∫≠p).<br/>
Chi·∫øn l∆∞·ª£c b√°m theo 4 tr·ª•: <strong>(1) Use-case r√µ r√†ng ‚Üí (2) Data foundation s·∫°ch ‚Üí (3) Model lifecycle c√≥ ki·ªÉm so√°t ‚Üí (4) Tu√¢n th·ªß b·∫£o m·∫≠t/ƒë·∫°o ƒë·ª©c</strong>.</p>
</blockquote>
<h3 id="101-use-case-uu-tien-2025-2026">10.1 Use-case ∆Øu ti√™n (2025-2026)<a class="headerlink" href="#101-use-case-uu-tien-2025-2026" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Use-case</th>
<th>M√¥ t·∫£</th>
<th>M√¥ h√¨nh / API</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>AI Chat Support</strong></td>
<td>Chatbot h·ªó tr·ª£ gi√°o vi√™n &amp; ph·ª• huynh (FAQ, h∆∞·ªõng d·∫´n)</td>
<td>LLM (Vertex AI PaLM 2-Text, context Knowledge-Graph)</td>
</tr>
<tr>
<td><strong>Homework Feedback</strong></td>
<td>G·ª£i √Ω s·ª≠a c√¢u / gi·∫£i chi ti·∫øt cho h·ªçc sinh</td>
<td>LLM + Prompt-engineering + Guardrails</td>
</tr>
<tr>
<td><strong>Attendance Anomaly</strong></td>
<td>D·ª± b√°o v·∫Øng m·∫∑t b·∫•t th∆∞·ªùng</td>
<td>LSTM tim-series (BigQuery ML)</td>
</tr>
<tr>
<td><strong>Cost Forecast</strong></td>
<td>D·ª± ƒëo√°n chi ph√≠ GCP/tenant th√°ng t·ªõi</td>
<td>Prophet ARIMA</td>
</tr>
<tr>
<td><strong>Incident Triage</strong></td>
<td>Ph√¢n lo·∫°i log l·ªói ‚Üí g·ª£i √Ω fix</td>
<td>Embedding + kNN (Vector Search)</td>
</tr>
</tbody>
</table>
<h3 id="102-kien-truc-trien-khai">10.2 Ki·∫øn tr√∫c tri·ªÉn khai<a class="headerlink" href="#102-kien-truc-trien-khai" title="Permanent link">¬∂</a></h3>
<pre class="mermaid"><code>flowchart LR
  subgraph Core_AI ["ü§ñ AI Core Services"]
    AIAPI[(AI Inference API<br/>Cloud Run)]
    VectorDB[(Vertex AI Vector<br/>Store)]
    FeatureStore[(Feature Store)]
  end

  subgraph DataPlane
    BQ[(BigQuery DW)]
    PubSub((Pub/Sub events))
  end

  FE[üåê Frontend / Portal] -. gRPC/REST .-&gt; AIAPI
  BQ -- batch --&gt; FeatureStore
  PubSub -- stream --&gt; FeatureStore
  AIAPI -- embed --&gt; VectorDB
  AIAPI -- fetch feature --&gt; FeatureStore
  AIAPI -. call .-&gt; VertexLLM[[Vertex AI<br/>PaLM 2]]
</code></pre>
<h3 id="103-model-lifecycle">10.3 Model Lifecycle<a class="headerlink" href="#103-model-lifecycle" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Giai ƒëo·∫°n</th>
<th>C√¥ng c·ª•</th>
<th>Quy tr√¨nh</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Experiment</strong></td>
<td>Vertex AI Workbench + AutoML</td>
<td>Data Scientist ch·∫°y notebook; metadata log ML Metadata</td>
</tr>
<tr>
<td><strong>Train</strong></td>
<td>Vertex AI Training</td>
<td>Output <code>model-artifact:hash</code> k√®m <code>schema_version</code></td>
</tr>
<tr>
<td><strong>Validate</strong></td>
<td>CI job <code>ml-test</code></td>
<td>Accuracy ‚â• KPI; bias test; security scan prompt-injection</td>
</tr>
<tr>
<td><strong>Deploy</strong></td>
<td>Cloud Run (CPU) / GPU endpoint</td>
<td>Blue-Green 5‚Üí50‚Üí100 %</td>
</tr>
<tr>
<td><strong>Monitor</strong></td>
<td>Vertex AI Model Monitoring + Prometheus</td>
<td>Drift, latency, cost, PII leakage alert</td>
</tr>
</tbody>
</table>
<p><em>Governance</em>: PR ph·∫£i k√®m <strong>Model Card</strong> (YAML) ‚Üí review <strong>AI Guild</strong>.</p>
<h3 id="104-bao-mat-ao-uc">10.4 B·∫£o m·∫≠t &amp; ƒê·∫°o ƒë·ª©c<a class="headerlink" href="#104-bao-mat-ao-uc" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>PII Masking</strong> tr∆∞·ªõc khi g·ª≠i prompt t·ªõi LLM (<code>email</code>, <code>phone</code>, <code>student_name</code>).</li>
<li><strong>Prompt Firewall</strong> ‚Äì regex + model-guard kh√¥ng tr·∫£ l·ªùi n·ªôi dung c·∫•m (Cheating, PII).</li>
<li><strong>Opt-in</strong>: H·ªçc sinh &lt; 16 tu·ªïi y√™u c·∫ßu ph·ª• huynh ƒë·ªìng √Ω.</li>
<li><strong>Data Residency</strong>: Ch·ªâ l∆∞u embedding ·ªü <code>us-central1</code> (GDPR SCC).</li>
</ul>
<h3 id="105-kpi-giam-sat">10.5 KPI &amp; Gi√°m s√°t<a class="headerlink" href="#105-kpi-giam-sat" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Alert</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ai_inference_latency_p95</code></td>
<td>&lt; 800 ms</td>
<td>&gt; 1200 ms 5‚Ä≤</td>
</tr>
<tr>
<td><code>chatbot_answer_helpful_rate</code> (thumb-up)</td>
<td>&gt; 85 %</td>
<td>&lt; 70 % ng√†y</td>
</tr>
<tr>
<td><code>model_drift_score</code></td>
<td>&lt; 0.1</td>
<td>&gt; 0.2 tu·∫ßn</td>
</tr>
<tr>
<td><code>cost_ai_per_1000req</code></td>
<td>‚â§ 0.02 USD</td>
<td>&gt; 0.03 USD ng√†y</td>
</tr>
</tbody>
</table>
<h3 id="106-roadmap">10.6 Roadmap<a class="headerlink" href="#106-roadmap" title="Permanent link">¬∂</a></h3>
<ol>
<li><strong>Q3-2025</strong> ‚Äì Chat Support Alpha (English ‚Üí Vietnamese).</li>
<li><strong>Q4-2025</strong> ‚Äì Homework Feedback Pilot ·ªü 2 tenant Premium.</li>
<li><strong>Q1-2026</strong> ‚Äì Full Cost Forecast + Incident Triage.</li>
<li><strong>Q2-2026</strong> ‚Äì Fine-tune mini-LLM on-prem (5-7 B params) n·∫øu ROI ƒë·∫°t.</li>
</ol>
<blockquote>
<p><strong>Th√¥ng ƒëi·ªáp ch·ªß ƒë·∫°o:</strong> AI ch·ªâ h·ªØu √≠ch khi <em>t√≠ch h·ª£p m∆∞·ª£t</em> v√†o lu·ªìng d·ªØ li·ªáu &amp; b·∫£o m·∫≠t s·∫µn c√≥; DX-VAS l·∫•y <strong>data quality + governance</strong> l√†m tr·ªçng t√¢m tr∆∞·ªõc khi ‚Äúb∆°m‚Äù m√¥ h√¨nh v√†o s·∫£n ph·∫©m.</p>
</blockquote>
<hr/>
<p>üìå <strong>Ghi ch√∫:</strong></p>
<ul>
<li><code>DataAccessAPI</code> l√† l·ªõp tr·ª´u t∆∞·ª£ng (c√≥ th·ªÉ d√πng ƒë·ªÉ chu·∫©n b·ªã d·ªØ li·ªáu cho training ho·∫∑c inference)</li>
<li><code>MetadataRegistry</code> t∆∞∆°ng ·ª©ng v·ªõi qu·∫£n tr·ªã schema theo <code>ADR-030</code></li>
<li>M·ªói AI Agent c√≥ m·ª•c ti√™u ri√™ng (h·ªó tr·ª£, t·ªïng h·ª£p, d·ª± ƒëo√°n) v√† c√≥ th·ªÉ t√°i s·ª≠ d·ª•ng query/template t·ª´ Reporting Service</li>
</ul>
<hr/>
<p>üìò <strong>Ghi ch√∫:</strong></p>
<ul>
<li>UI kh√¥ng n√™n hard-code role, m√† n√™n ki·ªÉm tra theo permission c·ª• th·ªÉ (VD: <code>can_assign_role</code>, <code>can_view_tuition</code>)</li>
<li>C√°c permission n√†y ƒë∆∞·ª£c Gateway tr·∫£ v·ªÅ trong JWT ho·∫∑c refresh qua API <code>GET /me/permissions</code></li>
<li>Vi·ªác ki·ªÉm tra quy·ªÅn c√≥ th·ªÉ d√πng Hook/Vuex/Redux trung t√¢m t·∫°i frontend ƒë·ªÉ g·∫Øn c·ªù <code>canAccess[X]</code></li>
</ul>
<p>üìé Li√™n quan:</p>
<ul>
<li><a href="../rbac-deep-dive/#11-best-practices-cho-qu·∫£n-tr·ªã-rbac">RBAC Deep Dive</a></li>
<li><a href="../../">README</a></li>
</ul>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Tr·ªü l·∫°i m·ª•c l·ª•c
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>