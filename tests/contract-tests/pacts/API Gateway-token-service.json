{
  "consumer": {
    "name": "API Gateway"
  },
  "interactions": [
    {
      "description": "[ISSUE] should respond with a new token pair for a valid request",
      "providerState": "valid user with email exists",
      "request": {
        "body": {
          "roles": [
            "teacher"
          ],
          "sub": "1234567890"
        },
        "headers": {
          "Authorization": "Bearer some-internal-service-token",
          "Content-Type": "application/json",
          "X-Tenant-ID": "tenant-abc"
        },
        "matchingRules": {
          "$.body.roles": {
            "match": "type",
            "min": 1
          },
          "$.body.sub": {
            "match": "type"
          },
          "$.header.Authorization": {
            "match": "type"
          },
          "$.header['X-Tenant-ID']": {
            "match": "type"
          }
        },
        "method": "POST",
        "path": "/v1/token/issue"
      },
      "response": {
        "body": {
          "access_token": "jwt-token-abc",
          "expires_in": 3600,
          "meta": {
            "timestamp": "2024-06-01T00:00:00Z",
            "trace_id": "abc123"
          },
          "refresh_token": "refresh-token-xyz"
        },
        "headers": {
          "Content-Type": "application/json"
        },
        "matchingRules": {
          "$.body.access_token": {
            "match": "type"
          },
          "$.body.expires_in": {
            "match": "type"
          },
          "$.body.meta.timestamp": {
            "match": "type"
          },
          "$.body.meta.trace_id": {
            "match": "type"
          },
          "$.body.refresh_token": {
            "match": "type"
          }
        },
        "status": 200
      }
    },
    {
      "description": "[JWKS] should respond with 200 and a set of public keys",
      "providerState": "public key available",
      "request": {
        "method": "GET",
        "path": "/.well-known/jwks.json"
      },
      "response": {
        "body": {
          "keys": [
            {
              "alg": "RS256",
              "e": "AQAB",
              "kid": "abc123",
              "kty": "RSA",
              "n": "public-key-n",
              "use": "sig"
            }
          ]
        },
        "headers": {
          "Content-Type": "application/json"
        },
        "matchingRules": {
          "$.body.keys": {
            "match": "type",
            "min": 1
          },
          "$.body.keys[*].alg": {
            "match": "type"
          },
          "$.body.keys[*].e": {
            "match": "type"
          },
          "$.body.keys[*].kid": {
            "match": "type"
          },
          "$.body.keys[*].kty": {
            "match": "type"
          },
          "$.body.keys[*].n": {
            "match": "type"
          },
          "$.body.keys[*].use": {
            "match": "type"
          }
        },
        "status": 200
      }
    },
    {
      "description": "a GET request for JWKS",
      "providerState": "jwks endpoint is available",
      "request": {
        "method": "GET",
        "path": "/.well-known/jwks.json"
      },
      "response": {
        "body": {
          "keys": [
            {
              "alg": "RS256",
              "e": "AQAB",
              "kid": "abc123",
              "kty": "RSA",
              "n": "...",
              "use": "sig"
            }
          ]
        },
        "headers": {
          "Content-Type": "application/json"
        },
        "matchingRules": {
          "$.body.keys": {
            "match": "type",
            "min": 1
          },
          "$.body.keys[*].alg": {
            "match": "type"
          },
          "$.body.keys[*].e": {
            "match": "type"
          },
          "$.body.keys[*].kid": {
            "match": "type"
          },
          "$.body.keys[*].kty": {
            "match": "type"
          },
          "$.body.keys[*].n": {
            "match": "type"
          },
          "$.body.keys[*].use": {
            "match": "type"
          }
        },
        "status": 200
      }
    },
    {
      "description": "a GET request to fetch JWKS keys",
      "providerState": "JWKS keys are available",
      "request": {
        "method": "GET",
        "path": "/.well-known/jwks.json"
      },
      "response": {
        "body": {
          "keys": [
            {
              "alg": "RS256",
              "e": "AQAB",
              "kid": "abc123",
              "kty": "RSA",
              "n": "...",
              "use": "sig"
            }
          ]
        },
        "headers": {
          "Content-Type": "application/json"
        },
        "matchingRules": {
          "$.body.keys": {
            "match": "type",
            "min": 1
          },
          "$.body.keys[*].alg": {
            "match": "type"
          },
          "$.body.keys[*].e": {
            "match": "type"
          },
          "$.body.keys[*].kid": {
            "match": "type"
          },
          "$.body.keys[*].kty": {
            "match": "type"
          },
          "$.body.keys[*].n": {
            "match": "type"
          },
          "$.body.keys[*].use": {
            "match": "type"
          }
        },
        "status": 200
      }
    },
    {
      "description": "a valid token issue request",
      "providerState": "user exists and OTP is valid",
      "request": {
        "body": {
          "otp_code": "123456",
          "roles": [
            "teacher"
          ],
          "sub": "abc@example.com"
        },
        "headers": {
          "Authorization": "Bearer some-internal-service-token",
          "Content-Type": "application/json",
          "X-Tenant-ID": "tenant-abc"
        },
        "matchingRules": {
          "$.body.otp_code": {
            "match": "type"
          },
          "$.body.roles": {
            "match": "type",
            "min": 1
          },
          "$.body.sub": {
            "match": "type"
          },
          "$.header.Authorization": {
            "match": "regex",
            "regex": "^Bearer\\s[\\w-]+$"
          },
          "$.header['X-Tenant-ID']": {
            "match": "type"
          }
        },
        "method": "POST",
        "path": "/v1/token/issue"
      },
      "response": {
        "body": {
          "access_token": "eyJhbGciOi...",
          "expires_in": 3600,
          "refresh_token": "eyJhbGciOi...",
          "token_type": "bearer"
        },
        "headers": {
          "Content-Type": "application/json"
        },
        "matchingRules": {
          "$.body.access_token": {
            "match": "type"
          },
          "$.body.expires_in": {
            "match": "type"
          },
          "$.body.refresh_token": {
            "match": "type"
          },
          "$.body.token_type": {
            "match": "type"
          }
        },
        "status": 200
      }
    },
    {
      "description": "a valid token issue request",
      "providerState": "user exists and valid token request",
      "request": {
        "body": {
          "otp_code": "123456",
          "roles": [
            "teacher"
          ],
          "sub": "user-123"
        },
        "headers": {
          "Authorization": "Bearer some-internal-service-token",
          "Content-Type": "application/json",
          "X-Tenant-ID": "tenant-abc"
        },
        "matchingRules": {
          "$.body.otp_code": {
            "match": "type"
          },
          "$.body.roles": {
            "match": "type",
            "min": 1
          },
          "$.body.sub": {
            "match": "type"
          },
          "$.header.Authorization": {
            "match": "regex",
            "regex": "^Bearer\\s[\\w-]+$"
          },
          "$.header['X-Tenant-ID']": {
            "match": "type"
          }
        },
        "method": "POST",
        "path": "/v1/token/issue"
      },
      "response": {
        "body": {
          "access_token": "ey...",
          "expires_in": 3600,
          "meta": {},
          "refresh_token": "ref...",
          "token_type": "bearer"
        },
        "headers": {
          "Content-Type": "application/json"
        },
        "matchingRules": {
          "$.body.access_token": {
            "match": "type"
          },
          "$.body.expires_in": {
            "match": "type"
          },
          "$.body.meta": {
            "match": "type"
          },
          "$.body.refresh_token": {
            "match": "type"
          },
          "$.body.token_type": {
            "match": "type"
          }
        },
        "status": 200
      }
    }
  ],
  "metadata": {
    "pact-js": {
      "version": "15.0.1"
    },
    "pactRust": {
      "ffi": "0.4.22",
      "models": "1.2.3"
    },
    "pactSpecification": {
      "version": "2.0.0"
    }
  },
  "provider": {
    "name": "token-service"
  }
}